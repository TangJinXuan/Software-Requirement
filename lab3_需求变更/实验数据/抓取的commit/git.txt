author:weinand
date:2015-11-18T23:44:12Z
title:fix for #39

https://github.com/Microsoft/vscode/issues/39
filename:src/vs/editor/browser/viewParts/lines/viewLine.ts
code:
@@ -516,19 +516,12 @@ class WebKitViewLine extends ViewLine {
 		if (beforeEndVisibleRanges && beforeEndVisibleRanges.length > 0 && endVisibleRanges && endVisibleRanges.length > 0) {
 			var beforeEndVisibleRange = beforeEndVisibleRanges[0];
 			var endVisibleRange = endVisibleRanges[0];
-			var isLTR = true;
-			if (beforeEndVisibleRange.top === endVisibleRange.top) {
-				isLTR = (beforeEndVisibleRange.left <= endVisibleRange.left);
-			}
-
+			var isLTR = (beforeEndVisibleRange.left <= endVisibleRange.left);
 			var lastRange = output[output.length - 1];
 
-			if (isLTR && lastRange.top === endVisibleRange.top && lastRange.left < endVisibleRange.left) {
+			if (isLTR && lastRange.left < endVisibleRange.left) {
 				// Trim down the width of the last visible range to not go after the last column's position
 				lastRange.width = endVisibleRange.left - lastRange.left;
-			} else if (lastRange.top > endVisibleRange.top) {
-				// WebKit went over to next line with its expanded range
-				output.splice(output.length - 1, 1);
 			}
 		}
 
@@ -560,10 +553,7 @@ class RangeUtil {
 }
 
 function compareVisibleRanges(a: EditorBrowser.IVisibleRange, b: EditorBrowser.IVisibleRange): number {
-	if (a.top === b.top) {
-		return a.left - b.left;
-	}
-	return a.top - b.top;
+	return a.left - b.left;
 }
 
 function findIndexInArrayWithMax(lineParts:ILineParts, desiredIndex: number, maxResult:number): number {
@@ -759,4 +749,4 @@ export function renderLine(input:IRenderLineInput): IRenderLineOutput {
 	result.partsCount = partsCount;
 
 	return result;
-}
\ No newline at end of file
+}

author:joaomoreno
date:2015-11-19T17:18:43Z
title:use github token in travis ci builds
filename:build/gulpfile.vscode.js
code:
@@ -97,7 +97,8 @@ var config = {
 	darwinBundleDocumentTypes: product.darwinBundleDocumentTypes,
 	darwinCredits: darwinCreditsTemplate ? new Buffer(darwinCreditsTemplate({ commit: commit, date: new Date().toISOString() })) : void 0,
 	winIcon: product.icons.application.ico,
-	win32ExeBasename: product.win32ExeBasename
+	win32ExeBasename: product.win32ExeBasename,
+	token: process.env['GITHUB_TOKEN'] || void 0
 };
 
 gulp.task('electron', function () {

author:joaomoreno
date:2015-11-20T08:58:31Z
title:Merge pull request #308 from Tyriar/307_fix_git_status_bar_cursor

Use default cursor for .git-statusbar-item
filename:src/vs/workbench/parts/git/browser/media/git.contribution.css
code:
@@ -226,6 +226,7 @@
 	background-repeat: no-repeat;
 	background-position: 4px 50%;
 	background-size: 17px;
+	cursor: default;
 	padding: 0 5px 0 22px;
 }
 
@@ -248,4 +249,4 @@
 
 .monaco-shell .git-statusbar-item.headless {
 	font-style: italic;
-}
\ No newline at end of file
+}

author:Tyriar
date:2015-11-20T05:12:03Z
title:Use default cursor for .git-statusbar-item

Prevent the text selection cursor from showing on .git-statusbar-item. This is
happening because there is an &nbsp; being used currently to position the
element.

Fixes #307
filename:src/vs/workbench/parts/git/browser/media/git.contribution.css
code:
@@ -226,6 +226,7 @@
 	background-repeat: no-repeat;
 	background-position: 4px 50%;
 	background-size: 17px;
+	cursor: default;
 	padding: 0 5px 0 22px;
 }
 
@@ -248,4 +249,4 @@
 
 .monaco-shell .git-statusbar-item.headless {
 	font-style: italic;
-}
\ No newline at end of file
+}

author:jrieken
date:2015-11-20T14:54:01Z
title:Merge pull request #341 from Microsoft/csharp-o-github-releases

Use auth tokens for downloading omnisharp builds from GitHub
filename:extensions/csharp-o/gulpfile.js
code:
@@ -1,22 +1,60 @@
 var gulp = require('gulp');
 var decompress = require('gulp-decompress');
-var download = require('gulp-download');
+var es = require('event-stream');
+var GitHub = require('github-releases');
+var tmp = require('tmp');
+var vfs = require('vinyl-fs');
 var del = require('del');
 var fs = require('fs');
-var join = require('path').join;
+var path = require('path');
 
+tmp.setGracefulCleanup();
+
+function downloadOmnisharp(version) {
+	var result = es.through();
+
+	function onError(err) {
+		result.emit('error', err);
+	}
+
+	var repo = new GitHub({
+		repo: 'OmniSharp/omnisharp-roslyn',
+		token: process.env['GITHUB_TOKEN']
+	});
+
+	repo.getReleases({ tag_name: version }, function (err, releases) {
+		if (err) { return onError(err); }
+		if (!releases.length) { return onError(new Error('Release not found')); }
+		if (!releases[0].assets.length) { return onError(new Error('Assets not found')); }
+
+		repo.downloadAsset(releases[0].assets[0], function (err, istream) {
+			if (err) { return onError(err); }
+
+			tmp.file(function (err, tmpPath, fd, cleanupCallback) {
+				if (err) { return onError(err); }
+
+				var ostream = fs.createWriteStream(null, { fd: fd });
+				ostream.once('error', onError);
+				istream.once('error', onError);
+				ostream.once('finish', function () {
+					vfs.src(tmpPath).pipe(result);
+				});
+				istream.pipe(ostream);
+			});
+		});
+	});
+
+	return result;
+}
 
 gulp.task('omnisharp:clean', function () {
 	return del('bin');
 });
 
 gulp.task('omnisharp:fetch', ['omnisharp:clean'], function () {
-
-	var release = 'https://github.com/OmniSharp/omnisharp-roslyn/releases/download/v1.5.6/omnisharp.tar.gz';
-
-	return download(release)
+	return downloadOmnisharp('v1.5.6')
 		.pipe(decompress({strip: 1}))
-		.pipe(gulp.dest('bin'))
+		.pipe(gulp.dest('bin'));
 });
 
 gulp.task('omnisharp:fixscripts', ['omnisharp:fetch'], function () {
@@ -38,7 +76,7 @@ exec "$DIR/packages/dnx-mono.1.0.0-beta4/bin/dnx" "$DNX_APPBASE" run "$@"\n\
 
 	var promises = Object.keys(_fixes).map(function (key) {
 		return new Promise(function(resolve, reject) {
-			fs.writeFile(join(__dirname, key), _fixes[key], function (err) {
+			fs.writeFile(path.join(__dirname, key), _fixes[key], function (err) {
 				if (err) {
 					reject(err);
 				} else {

author:jrieken
date:2015-11-20T14:54:01Z
title:Merge pull request #341 from Microsoft/csharp-o-github-releases

Use auth tokens for downloading omnisharp builds from GitHub
filename:extensions/csharp-o/package.json
code:
@@ -1,101 +1,102 @@
 {
-	"name": "csharp-o",
-	"version": "0.1.0",
-	"publisher": "vscode",
-	"engines": {
-		"node": "^4.0.0",
-		"vscode": "*"
-	},
-	"activationEvents": [
-		"onLanguage:csharp",
-		"onCommand:o.restart",
-		"onCommand:o.pickProjectAndStart",
-		"onCommand:o.restore",
-		"onCommand:o.execute",
-		"onCommand:o.showOutput",
-		"onCommand:o.execute",
-		"onCommand:o.execute-last-command"
-	],
-	"main": "./out/omnisharpMain",
-	"scripts": {
-		"postinstall": "node ./node_modules/gulp/bin/gulp.js omnisharp",
-		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:csharp-o ./tsconfig.json"
-	},
-	"dependencies": {
-		"applicationinsights": "0.15.6",
-		"run-in-terminal": "*",
-		"semver": "*"
-	},
-	"devDependencies": {
-		"del": "^2.0.2",
-		"gulp": "^3.8.9",
-		"gulp-decompress": "^1.2.0",
-		"gulp-download": "^0.0.1",
-		"typescript": "^1.6.2"
-	},
-	"extensionDependencies": [
-		"vscode.csharp"
-	],
-	"contributes": {
-		"commands": [
-			{
-				"command": "o.restart",
-				"title": "Restart OmniSharp",
-				"category": "OmniSharp"
-			},
-			{
-				"command": "o.pickProjectAndStart",
-				"title": "Select Project",
-				"category": "OmniSharp"
-			},
-			{
-				"command": "o.restore",
-				"title": "Restore Packages",
-				"category": "dnx"
-			},
-			{
-				"command": "o.execute",
-				"title": "Run Command",
-				"category": "dnx"
-			}
-		],
-		"keybindings": [
-			{
-				"command": "o.showOutput",
-				"key": "Ctrl+L L",
-				"mac": "Cmd+L L"
-			},
-			{
-				"command": "o.execute",
-				"key": "Ctrl+L Shift+R",
-				"mac": "Cmd+L Shift+R"
-			},
-			{
-				"command": "o.execute-last-command",
-				"key": "Ctrl+L R",
-				"mac": "Cmd+L R"
-			},
-			{
-				"key": "shift+0",
-				"command": "^acceptSelectedSuggestion",
-				"when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
-			},
-			{
-				"key": "shift+9",
-				"command": "^acceptSelectedSuggestion",
-				"when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
-			},
-			{
-				"key": ".",
-				"command": "^acceptSelectedSuggestion",
-				"when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
-			}
-		],
-		"snippets": [
-			{
-				"language": "csharp",
-				"path": "./snippets/csharp.json"
-			}
-		]
-	}
+  "name": "csharp-o",
+  "version": "0.1.0",
+  "publisher": "vscode",
+  "engines": {
+    "node": "^4.0.0",
+    "vscode": "*"
+  },
+  "activationEvents": [
+    "onLanguage:csharp",
+    "onCommand:o.restart",
+    "onCommand:o.pickProjectAndStart",
+    "onCommand:o.restore",
+    "onCommand:o.execute",
+    "onCommand:o.showOutput",
+    "onCommand:o.execute",
+    "onCommand:o.execute-last-command"
+  ],
+  "main": "./out/omnisharpMain",
+  "scripts": {
+    "postinstall": "node ./node_modules/gulp/bin/gulp.js omnisharp",
+    "vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:csharp-o ./tsconfig.json"
+  },
+  "dependencies": {
+    "run-in-terminal": "*",
+    "semver": "*"
+  },
+  "devDependencies": {
+    "del": "^2.0.2",
+    "event-stream": "^3.3.2",
+    "github-releases": "^0.3.0",
+    "gulp": "^3.8.9",
+    "gulp-decompress": "^1.2.0",
+    "tmp": "0.0.28",
+    "vinyl-fs": "^2.2.1"
+  },
+  "extensionDependencies": [
+    "vscode.csharp"
+  ],
+  "contributes": {
+    "commands": [
+      {
+        "command": "o.restart",
+        "title": "Restart OmniSharp",
+        "category": "OmniSharp"
+      },
+      {
+        "command": "o.pickProjectAndStart",
+        "title": "Select Project",
+        "category": "OmniSharp"
+      },
+      {
+        "command": "o.restore",
+        "title": "Restore Packages",
+        "category": "dnx"
+      },
+      {
+        "command": "o.execute",
+        "title": "Run Command",
+        "category": "dnx"
+      }
+    ],
+    "keybindings": [
+      {
+        "command": "o.showOutput",
+        "key": "Ctrl+L L",
+        "mac": "Cmd+L L"
+      },
+      {
+        "command": "o.execute",
+        "key": "Ctrl+L Shift+R",
+        "mac": "Cmd+L Shift+R"
+      },
+      {
+        "command": "o.execute-last-command",
+        "key": "Ctrl+L R",
+        "mac": "Cmd+L R"
+      },
+      {
+        "key": "shift+0",
+        "command": "^acceptSelectedSuggestion",
+        "when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
+      },
+      {
+        "key": "shift+9",
+        "command": "^acceptSelectedSuggestion",
+        "when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
+      },
+      {
+        "key": ".",
+        "command": "^acceptSelectedSuggestion",
+        "when": "editorTextFocus && suggestWidgetVisible && editorLangId == 'csharp' && suggestionSupportsAcceptOnKey"
+      }
+    ],
+    "snippets": [
+      {
+        "language": "csharp",
+        "path": "./snippets/csharp.json"
+      }
+    ]
+  }
 }

author:dstorey
date:2015-11-23T00:06:22Z
title:Remove global inert attribute from HTML auto-complete

It is not included in the list of global attributes for either W3C
HTML5/5.1 or WhatWG Living Standard.

There was a proposal for an inert keyword but it was dropped
https://github.com/whatwg/html/commit/5ddfc78b1f82e86cc202d72ccc752a0e15
f1e4ad
filename:src/vs/languages/html/common/htmlTags.ts
code:
@@ -143,7 +143,7 @@ export function getHTML5TagProvider(): IHTMLTagProvider {
 		'aria-describedby', 'aria-disabled:b', 'aria-dropeffect:dropeffect', 'aria-errormessage', 'aria-expanded:u', 'aria-flowto', 'aria-grabbed:u', 'aria-haspopup:b', 'aria-hidden:b', 'aria-invalid:invalid', 'aria-kbdshortcuts',
 		'aria-label', 'aria-labelledby', 'aria-level', 'aria-live:live', 'aria-modal:b', 'aria-multiline:b', 'aria-multiselectable:b', 'aria-orientation:orientation', 'aria-owns', 'aria-placeholder', 'aria-posinset', 'aria-pressed:tristate',
 		'aria-readonly:b','aria-relevant:relevant', 'aria-required:b', 'aria-roledescription', 'aria-rowcount', 'aria-rowindex', 'aria-rowspan', 'aria-selected:u', 'aria-setsize', 'aria-sort:sort', 'aria-valuemax', 'aria-valuemin', 'aria-valuenow', 'aria-valuetext',
-		'accesskey', 'class', 'contenteditable:b', 'contextmenu', 'dir:d', 'draggable:a', 'dropzone', 'hidden:v', 'id', 'inert:v', 'itemid', 'itemprop', 'itemref', 'itemscope:v', 'itemtype', 'lang', 'role:roles', 'spellcheck:b', 'style', 'tabindex',
+		'accesskey', 'class', 'contenteditable:b', 'contextmenu', 'dir:d', 'draggable:a', 'dropzone', 'hidden:v', 'id', 'itemid', 'itemprop', 'itemref', 'itemscope:v', 'itemtype', 'lang', 'role:roles', 'spellcheck:b', 'style', 'tabindex',
 		'title', 'translate'];
 
 	var eventHandlers = ['onabort', 'onblur', 'oncanplay', 'oncanplaythrough', 'onchange', 'onclick', 'oncontextmenu', 'ondblclick', 'ondrag', 'ondragend', 'ondragenter', 'ondragleave', 'ondragover', 'ondragstart',

author:joaomoreno
date:2015-11-25T15:15:01Z
title:Merge branch 'master' of https://github.com/akamud/vscode into akamud-master
filename:src/vs/workbench/parts/extensions/electron-browser/extensionsActions.ts
code:
@@ -54,3 +54,26 @@ export class InstallExtensionAction extends Action {
 		return true;
 	}
 }
+
+export class ListExtensionsUpdatesAction extends Action {
+
+	static ID = 'workbench.extensions.action.listExtensionsUpdates';
+	static LABEL = nls.localize('showExtensionsUpdates', "Show Extensions Updates");
+
+	constructor(
+		id: string,
+		label: string,
+		@IExtensionsService private extensionsService: IExtensionsService,
+		@IQuickOpenService private quickOpenService: IQuickOpenService
+	) {
+		super(id, label, null, true);
+	}
+
+	public run(): Promise {
+		return this.quickOpenService.show('ext update ');
+	}
+
+	protected isEnabled(): boolean {
+		return true;
+	}
+}

author:joaomoreno
date:2015-11-25T15:15:01Z
title:Merge branch 'master' of https://github.com/akamud/vscode into akamud-master
filename:src/vs/workbench/parts/extensions/electron-browser/extensionsQuickOpen.ts
code:
@@ -469,6 +469,80 @@ export class GalleryExtensionsHandler extends QuickOpenHandler {
 		return nls.localize('noExtensionsToInstall', "No extensions found");
 	}
 
+	getAutoFocus(searchValue: string): IAutoFocus {
+		return { autoFocusFirstEntry: true };
+	}
+}
+
+class ExtensionsUpdateModel implements IModel<IExtensionEntry> {
+
+	public dataSource = new DataSource();
+	public renderer: IRenderer<IExtensionEntry>;
+	public runner: IRunner<IExtensionEntry>;
+	public entries: IExtensionEntry[];
+
+	constructor(
+		private galleryExtensions: IExtension[],
+		private localExtensions: IExtension[],
+		@IInstantiationService instantiationService: IInstantiationService
+	) {
+		this.renderer = instantiationService.createInstance(Renderer);
+		this.runner = instantiationService.createInstance(InstallRunner);
+		this.entries = [];
+	}
+
+	public set input(input: string) {
+		this.entries = this.galleryExtensions
+			.map(extension => ({ extension, highlights: getHighlights(input, extension) }))
+			.filter(({ extension, highlights }) => {
+				const local = this.localExtensions.filter(local => extensionEquals(local, extension))[0];
+				return local && local.version < extension.version && !!highlights;
+			})
+			.map(({ extension, highlights }: { extension: IExtension, highlights: IHighlights }) => {
+				return {
+					extension,
+					highlights,
+					state: ExtensionState.Outdated
+				};
+			})
+			.sort((a, b) => a.extension.name.localeCompare(b.extension.name));
+	}
+}
+
+export class ExtensionsUpdateHandler extends QuickOpenHandler {
+
+	private modelPromise: TPromise<ExtensionsUpdateModel>;
+
+	constructor(
+		@IInstantiationService private instantiationService: IInstantiationService,
+		@IExtensionsService private extensionsService: IExtensionsService,
+		@IGalleryService private galleryService: IGalleryService,
+		@ITelemetryService private telemetryService: ITelemetryService
+	) {
+		super();
+	}
+
+	getResults(input: string): TPromise<IModel<IExtensionEntry>> {
+		if (!this.modelPromise) {
+			this.telemetryService.publicLog('extensionGallery:open');
+			this.modelPromise = TPromise.join<any>([this.galleryService.query(), this.extensionsService.getInstalled()])
+				.then(result => this.instantiationService.createInstance(ExtensionsUpdateModel, result[0], result[1]));
+		}
+
+		return this.modelPromise.then(model => {
+			model.input = input;
+			return model;
+		});
+	}
+
+	onClose(canceled: boolean): void {
+		this.modelPromise = null;
+	}
+
+	getEmptyLabel(input: string): string {
+		return nls.localize('noOutdatedExtensions', "No outdated extensions found");
+	}
+
 	getAutoFocus(searchValue: string): IAutoFocus {
 		return { autoFocusFirstEntry: true };
 	}

author:joaomoreno
date:2015-11-25T15:15:01Z
title:Merge branch 'master' of https://github.com/akamud/vscode into akamud-master
filename:src/vs/workbench/parts/extensions/electron-browser/extensionsWorkbenchExtension.ts
code:
@@ -16,7 +16,7 @@ import { IWorkspaceContextService } from 'vs/workbench/services/workspace/common
 import { ReloadWindowAction } from 'vs/workbench/electron-browser/actions';
 import wbaregistry = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
-import { ListExtensionsAction, InstallExtensionAction } from './extensionsActions';
+import { ListExtensionsAction, InstallExtensionAction, ListExtensionsUpdatesAction } from './extensionsActions';
 import { IQuickOpenRegistry, Extensions, QuickOpenHandlerDescriptor } from 'vs/workbench/browser/quickopen';
 
 import ipc = require('ipc');
@@ -67,6 +67,18 @@ export class ExtensionsWorkbenchExtension implements IWorkbenchContribution {
 					true
 				)
 			);
+
+			actionRegistry.registerWorkbenchAction(new SyncActionDescriptor(ListExtensionsUpdatesAction, ListExtensionsUpdatesAction.ID, ListExtensionsUpdatesAction.LABEL), extensionsCategory);
+
+			(<IQuickOpenRegistry>platform.Registry.as(Extensions.Quickopen)).registerQuickOpenHandler(
+				new QuickOpenHandlerDescriptor(
+					'vs/workbench/parts/extensions/electron-browser/extensionsQuickOpen',
+					'ExtensionsUpdateHandler',
+					'ext update ',
+					nls.localize('extensionsUpdateCommands', "Extensions Update Commands"),
+					true
+				)
+			);
 		}
 	}
 

author:joaomoreno
date:2015-11-25T15:44:25Z
title:Merge pull request #505 from bpasero/git-sync-command

add the "Sync" command to the command palette as global command
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -31,7 +31,7 @@ import {IFileService, IFileStat} from 'vs/platform/files/common/files';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import wbar = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
-import { OpenChangeAction } from './gitActions';
+import { OpenChangeAction, SyncAction } from './gitActions';
 import Severity from 'vs/base/common/severity';
 
 function getStatus(gitService: IGitService, contextService: IWorkspaceContextService, input: WorkbenchEditorCommon.IFileEditorInput): IFileStatus {
@@ -432,5 +432,7 @@ actionBarRegistry.registerActionBarContributor(abr.Scope.EDITOR, GitWorkingTreeD
 
 let workbenchActionRegistry = (<wbar.IWorkbenchActionRegistry> platform.Registry.as(wbar.Extensions.WorkbenchActions));
 
-// Register Action to Open Viewlet
-workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(GlobalOpenChangeAction, GlobalOpenChangeAction.ID, GlobalOpenChangeAction.LABEL), nls.localize('git', "Git"));
+// Register Actions
+const category = nls.localize('git', "Git");
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(GlobalOpenChangeAction, GlobalOpenChangeAction.ID, GlobalOpenChangeAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(SyncAction, SyncAction.ID, SyncAction.LABEL), category);

author:joaomoreno
date:2015-11-25T15:44:25Z
title:Merge pull request #505 from bpasero/git-sync-command

add the "Sync" command to the command palette as global command
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -941,9 +941,10 @@ export abstract class BaseSyncAction extends GitAction {
 export class SyncAction extends BaseSyncAction {
 
 	static ID = 'workbench.action.sync';
+	static LABEL = nls.localize('sync', "Sync");
 
-	constructor(@IGitService gitService: IGitService) {
-		super(SyncAction.ID, nls.localize('sync', "Sync"), 'git-action sync', gitService);
+	constructor(id: string, label: string, @IGitService gitService: IGitService) {
+		super(id, label, 'git-action sync', gitService);
 	}
 }
 

author:joaomoreno
date:2015-11-25T15:44:25Z
title:Merge pull request #505 from bpasero/git-sync-command

add the "Sync" command to the command palette as global command
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -246,7 +246,7 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 	public getSecondaryActions(): Actions.IAction[] {
 		if (!this.secondaryActions) {
 			this.secondaryActions = [
-				this.instantiationService.createInstance(GitActions.SyncAction),
+				this.instantiationService.createInstance(GitActions.SyncAction, GitActions.SyncAction.ID, GitActions.SyncAction.LABEL),
 				this.instantiationService.createInstance(GitActions.PullAction),
 				this.instantiationService.createInstance(GitActions.PushAction),
 				new ActionBar.Separator(),

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -38,6 +38,7 @@ export interface ITag {
 }
 
 export interface IRawStatus {
+	repositoryRoot: string;
 	state?: ServiceState;
 	status: IRawFileStatus[];
 	HEAD: IBranch;

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/common/gitModel.ts
code:
@@ -349,6 +349,7 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 	public update(status: Git.IRawStatus): void {
 		if (!status) {
 			status = {
+				repositoryRoot: null,
 				status: [],
 				HEAD: null,
 				heads: [],

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -9,6 +9,7 @@ import winjs = require('vs/base/common/winjs.base');
 
 export class NoOpGitService implements git.IRawGitService {
 	private static STATUS:git.IRawStatus = {
+		repositoryRoot: null,
 		state: git.ServiceState.NotAWorkspace,
 		status: [],
 		HEAD: null,

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -4,20 +4,19 @@
  *--------------------------------------------------------------------------------------------*/
 
 import { Promise, TPromise } from 'vs/base/common/winjs.base';
-import { IRawGitService, IRawStatus, RawServiceState } from 'vs/workbench/parts/git/common/git';
+import { RawServiceState } from 'vs/workbench/parts/git/common/git';
 import { NoOpGitService } from 'vs/workbench/parts/git/common/noopGitService';
 import { GitService } from 'vs/workbench/parts/git/browser/gitServices';
 import { ILifecycleService } from 'vs/platform/lifecycle/common/lifecycle';
 import { IOutputService } from 'vs/workbench/parts/output/common/output';
 import { IWorkbenchEditorService } from 'vs/workbench/services/editor/common/editorService';
 import { IConfigurationService } from 'vs/platform/configuration/common/configuration';
 import { IEventService } from 'vs/platform/event/common/event';
-import { IFileService } from 'vs/platform/files/common/files';
 import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
 import { IMessageService } from 'vs/platform/message/common/message';
 import { IWorkspaceContextService } from 'vs/platform/workspace/common/workspace';
 import { Client } from 'vs/base/node/service.cp';
-import { RawGitService, RawGitServiceWrapper } from 'vs/workbench/parts/git/node/rawGitService';
+import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
 import URI from 'vs/base/common/uri';
 import { spawn, exec } from 'child_process';
 import { join } from 'path';
@@ -121,7 +120,7 @@ export function createNativeRawGitService(workspaceRoot: string, gitPath: string
 	}, () => new UnavailableRawGitService());
 }
 
-class ElectronRawGitService extends RawGitServiceWrapper {
+class ElectronRawGitService extends DelayedRawGitService {
 	constructor(workspaceRoot: string, @IConfigurationService configurationService: IConfigurationService) {
 		super(configurationService.loadConfiguration().then(conf => {
 			var enabled = conf.git ? conf.git.enabled : true;

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -4,21 +4,22 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import { TPromise } from 'vs/base/common/winjs.base';
 import { Server } from 'vs/base/node/service.cp';
 import objects = require('vs/base/common/objects');
 import uri from 'vs/base/common/uri';
+import { IRawGitService } from 'vs/workbench/parts/git/common/git';
 import gitlib = require('vs/workbench/parts/git/node/git.lib');
-import rawgitservice = require('vs/workbench/parts/git/node/rawGitService');
-
+import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
 import { join, dirname, normalize } from 'path';
 import { tmpdir } from 'os';
-import { writeFileSync } from 'fs';
+import { realpath } from 'vs/base/node/pfs';
 
-class IPCRawGitService extends rawgitservice.RawGitService {
+class IPCRawGitService extends DelayedRawGitService {
 
-	constructor(gitPath: string, basePath: string, defaultEncoding: string, exePath: string) {
+	constructor(gitPath: string, workspaceRoot: string, defaultEncoding: string, exePath: string) {
 		if (!gitPath) {
-			super(null);
+			super(TPromise.as(new RawGitService(null)));
 		} else {
 			const gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
 			const bootstrapPath = `${ uri.parse(require.toUrl('bootstrap')).fsPath }.js`;
@@ -37,7 +38,13 @@ class IPCRawGitService extends rawgitservice.RawGitService {
 				env: env
 			});
 
-			super(git.open(normalize(basePath)));
+			const repo = git.open(normalize(workspaceRoot));
+			const promise = repo.getRoot()
+				.then(root => realpath(root))
+				.then(root => git.open(root))
+				.then(repo => new RawGitService(repo));
+
+			super(promise);
 		}
 	}
 }

author:joaomoreno
date:2015-11-26T17:44:03Z
title:add repositoryRoot to git.IRawStatus
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -23,11 +23,14 @@ function pathsAreEqual(p1: string, p2: string): boolean {
 export class RawGitService implements IRawGitService {
 
 	private repo: Repository;
-	private repoRealRootPath: TPromise<string>;
+	private _repositoryRoot: TPromise<string>;
 
 	constructor(repo: Repository) {
 		this.repo = repo;
-		this.repoRealRootPath = null;
+	}
+
+	private getRepositoryRoot(): TPromise<string> {
+		return this._repositoryRoot || (this._repositoryRoot = pfs.realpath(this.repo.path));
 	}
 
 	public serviceState(): TPromise<RawServiceState> {
@@ -38,8 +41,7 @@ export class RawGitService implements IRawGitService {
 	}
 
 	public status(): TPromise<IRawStatus> {
-		return this.checkRoot()
-			.then(() => this.repo.getStatus())
+		return this.repo.getStatus()
 			.then(status => this.repo.getHEAD()
 				.then(HEAD => {
 					if (HEAD.name) {
@@ -48,12 +50,13 @@ export class RawGitService implements IRawGitService {
 						return HEAD;
 					}
 				}, (): IHead => null)
-				.then(HEAD => Promise.join([this.repo.getHeads(), this.repo.getTags()]).then(r => {
+				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getHeads(), this.repo.getTags()]).then(r => {
 					return {
+						repositoryRoot: r[0],
 						status: status,
 						HEAD: HEAD,
-						heads: r[0],
-						tags: r[1]
+						heads: r[1],
+						tags: r[2]
 					};
 				})))
 			.then(null, (err) => {
@@ -178,29 +181,9 @@ export class RawGitService implements IRawGitService {
 			cancel = this.repo.onOutput(p);
 		}, () => cancel());
 	}
-
-	private checkRoot(): Promise {
-		if (!this.repoRealRootPath) {
-			this.repoRealRootPath = pfs.realpath(this.repo.path);
-		}
-
-		return this.repo.getRoot().then(root => {
-			return Promise.join([
-				this.repoRealRootPath,
-				pfs.realpath(root)
-			]).then(paths => {
-				if (!pathsAreEqual(paths[0], paths[1])) {
-					return Promise.wrapError(new GitError({
-						message: 'Not at the repository root',
-						gitErrorCode: GitErrorCodes.NotAtRepositoryRoot
-					}));
-				}
-			});
-		});
-	}
 }
 
-export class RawGitServiceWrapper implements IRawGitService {
+export class DelayedRawGitService implements IRawGitService {
 
 	constructor(private raw: TPromise<IRawGitService>) { }
 

author:joaomoreno
date:2015-11-26T17:41:15Z
title:stop log piping for git service
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -112,7 +112,6 @@ export function createNativeRawGitService(workspaceRoot: string, gitPath: string
 				args: [gitPath, workspaceRoot, defaultEncoding, remote.process.execPath],
 				env: {
 					ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
-					PIPE_LOGGING: 'true',
 					AMD_ENTRYPOINT: 'vs/workbench/parts/git/electron-browser/gitApp'
 				}
 			}

author:joaomoreno
date:2015-11-26T17:40:11Z
title:git lib: isolate exec
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -6,6 +6,7 @@
 import { Promise, TPromise } from 'vs/base/common/winjs.base';
 import extfs = require('vs/base/node/extfs');
 import { guessMimeTypes, isBinaryMime } from 'vs/base/common/mime';
+import { IDisposable, toDisposable, disposeAll } from 'vs/base/common/lifecycle';
 import objects = require('vs/base/common/objects');
 import uuid = require('vs/base/common/uuid');
 import nls = require('vs/nls');
@@ -17,11 +18,50 @@ import { spawn, ChildProcess } from 'child_process';
 import iconv = require('iconv-lite');
 
 export interface IExecutionResult {
-	code: number;
+	exitCode: number;
 	stdout: string;
 	stderr: string;
 }
 
+function exec(child: ChildProcess, encoding = 'utf8'): TPromise<IExecutionResult> {
+	const disposables: IDisposable[] = [];
+
+	const once = (ee: EventEmitter, name: string, fn: Function) => {
+		ee.once(name, fn);
+		disposables.push(toDisposable(() => ee.removeListener(name, fn)));
+	};
+
+	const on = (ee: EventEmitter, name: string, fn: Function) => {
+		ee.on(name, fn);
+		disposables.push(toDisposable(() => ee.removeListener(name, fn)));
+	};
+
+	return TPromise.join<any>([
+		new TPromise<number>((c, e) => {
+			once(child, 'error', e);
+			once(child, 'exit', c);
+		}),
+		new TPromise<string>(c => {
+			let buffers: Buffer[] = [];
+			on(child.stdout, 'data', b => buffers.push(b));
+			once(child.stdout, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+		}),
+		new TPromise<string>(c => {
+			let buffers: Buffer[] = [];
+			on(child.stderr, 'data', b => buffers.push(b));
+			once(child.stderr, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+		})
+	]).then(values => {
+		disposeAll(disposables);
+
+		return {
+			exitCode: values[0],
+			stdout: values[1],
+			stderr: values[2]
+		};
+	});
+}
+
 export interface IGitErrorData {
 	error?: Error;
 	message?: string;
@@ -140,62 +180,37 @@ export class Git {
 			child.stdin.end(options.input, 'utf8');
 		}
 
-		return TPromise.join<any>([
-			new TPromise<number>((c, e) => {
-				child.once('error', e);
-				child.once('exit', c);
-			}),
-			new TPromise<string>(c => {
-				let buffer:string = '';
-				child.stdout.setEncoding('utf8');
-				child.stdout.on('data', (data: string) => buffer += data);
-				child.stdout.once('close', () => c(buffer));
-			}),
-			new TPromise<string>(c => {
-				let buffer:string = '';
-				child.stderr.setEncoding('utf8');
-				child.stderr.on('data', (data: string) => buffer += data);
-				child.stderr.once('close', () => c(buffer));
-			})
-		]).then<IExecutionResult>((values) => {
-			const exitCode = <number> values[0];
-			const stdout = <string> values[1];
-			const stderr = <string> values[2];
-
-			if (exitCode) {
+		return exec(child).then(result => {
+			if (result.exitCode) {
 				let gitErrorCode: string = null;
 
-				if (/Authentication failed/.test(stderr)) {
+				if (/Authentication failed/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.AuthenticationFailed;
-				} else if (/bad config file/.test(stderr)) {
+				} else if (/bad config file/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.BadConfigFile;
-				} else if (/cannot make pipe for command substitution|cannot create standard input pipe/.test(stderr)) {
+				} else if (/cannot make pipe for command substitution|cannot create standard input pipe/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.CantCreatePipe;
-				} else if (/Repository not found/.test(stderr)) {
+				} else if (/Repository not found/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.RepositoryNotFound;
-				} else if (/unable to access/.test(stderr)) {
+				} else if (/unable to access/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.CantAccessRemote;
 				}
 
 				if (options.log !== false) {
-					this.log(stderr);
+					this.log(result.stderr);
 				}
 
 				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Failed to execute git',
-					stdout: stdout,
-					stderr: stderr,
-					exitCode: exitCode,
-					gitErrorCode: gitErrorCode,
+					stdout: result.stdout,
+					stderr: result.stderr,
+					exitCode: result.exitCode,
+					gitErrorCode,
 					gitCommand: args[0]
 				}));
 			}
 
-			return TPromise.as<IExecutionResult>({
-				code: values[0],
-				stdout: values[1],
-				stderr: values[2]
-			});
+			return result;
 		});
 	}
 
@@ -322,32 +337,15 @@ export class Repository {
 	private doBuffer(object: string): TPromise<string> {
 		const child = this.show(object);
 
-		return TPromise.join<any>([
-			new TPromise<number>((c, e) => {
-				child.once('error', e);
-				child.once('exit', c);
-			}),
-			new TPromise<string>(c => {
-				const buffers: NodeBuffer[] = [];
-				child.stdout.on('data', (b: NodeBuffer) => buffers.push(b));
-				child.stdout.once('close', () => c(iconv.decode(Buffer.concat(buffers), this.defaultEncoding)));
-			}),
-			new Promise(c => {
-				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.once('close', () => c(null));
-			})
-		]).then((values) => {
-			const exitCode = <number> values[0];
-			const result = <string> values[1];
-
+		return exec(child, this.defaultEncoding).then(({ exitCode, stdout }) => {
 			if (exitCode) {
 				return TPromise.wrapError<string>(new GitError({
 					message: 'Could not buffer object.',
-					exitCode: exitCode
+					exitCode
 				}));
 			}
 
-			return TPromise.as<string>(result);
+			return TPromise.as<string>(stdout);
 		});
 	}
 
@@ -367,33 +365,15 @@ export class Repository {
 		const child = this.stream(['hash-object', '--stdin', '-w'], { stdio: [null, null, null] });
 		child.stdin.end(data, 'utf8');
 
-		return TPromise.join<any>([
-			new TPromise<number>((c, e) => {
-				child.once('error', e);
-				child.once('exit', c);
-			}),
-			new TPromise<string>(c => {
-				let id = '';
-				child.stdout.setEncoding('utf8');
-				child.stdout.on('data', (data:string) => id += data);
-				child.stdout.once('close', () => c(id));
-			}),
-			new Promise(c => {
-				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.once('close', () => c(null));
-			})
-		]).then<IExecutionResult>((values) => {
-			const exitCode = <number> values[0];
-			const id = <string> values[1];
-
+		return exec(child).then(({ exitCode, stdout }) => {
 			if (exitCode) {
 				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Could not hash object.',
 					exitCode: exitCode
 				}));
 			}
 
-			return this.run(['update-index', '--cacheinfo', '100644', id, path]);
+			return this.run(['update-index', '--cacheinfo', '100644', stdout, path]);
 		});
 	}
 

author:joaomoreno
date:2015-11-26T17:40:11Z
title:cleanup git lib
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -2,10 +2,8 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
-
-import winjs = require('vs/base/common/winjs.base');
+import { Promise, TPromise } from 'vs/base/common/winjs.base';
 import extfs = require('vs/base/node/extfs');
 import { guessMimeTypes, isBinaryMime } from 'vs/base/common/mime';
 import objects = require('vs/base/common/objects');
@@ -15,8 +13,7 @@ import strings = require('vs/base/common/strings');
 import { IRawFileStatus, IHead, ITag, IBranch, GitErrorCodes } from 'vs/workbench/parts/git/common/git';
 import { detectMimesFromStream } from 'vs/base/node/mime'
 import files = require('vs/platform/files/common/files');
-
-import cp = require('child_process');
+import { spawn, ChildProcess } from 'child_process';
 import iconv = require('iconv-lite');
 
 export interface IExecutionResult {
@@ -62,7 +59,7 @@ export class GitError {
 	}
 
 	public toString(): string {
-		var result = this.message + ' ' + JSON.stringify({
+		let result = this.message + ' ' + JSON.stringify({
 			exitCode: this.exitCode,
 			gitErrorCode: this.gitErrorCode,
 			gitCommand: this.gitCommand,
@@ -97,19 +94,19 @@ export class Git {
 		this.gitPath = options.gitPath;
 		this.tmpPath = options.tmpPath;
 
-		var encoding = options.defaultEncoding || 'utf8';
+		const encoding = options.defaultEncoding || 'utf8';
 		this.defaultEncoding = iconv.encodingExists(encoding) ? encoding : 'utf8';
 
 		this.env = options.env || {};
 		this.outputListeners = [];
 	}
 
-	public run(cwd: string, args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
+	public run(cwd: string, args: string[], options: any = {}): TPromise<IExecutionResult> {
 		options = objects.assign({ cwd: cwd }, options || {});
 		return this.exec(args, options);
 	}
 
-	public stream(cwd: string, args: string[], options: any = {}): cp.ChildProcess {
+	public stream(cwd: string, args: string[], options: any = {}): ChildProcess {
 		options = objects.assign({ cwd: cwd }, options || {});
 		return this.spawn(args, options);
 	}
@@ -118,9 +115,9 @@ export class Git {
 		return new Repository(this, repository, this.defaultEncoding, env);
 	}
 
-	public clone(repository: string, repoURL: string): winjs.TPromise<boolean> {
+	public clone(repository: string, repoURL: string): TPromise<boolean> {
 		return this.exec(['clone', repoURL, repository]).then(() => true, (err) => {
-			return new winjs.TPromise<boolean>((c, e) => {
+			return new TPromise<boolean>((c, e) => {
 
 				// If there's any error, git will still leave the folder in the FS,
 				// so we need to remove it.
@@ -132,41 +129,41 @@ export class Git {
 		});
 	}
 
-	public config(name: string, value: string): winjs.Promise {
+	public config(name: string, value: string): Promise {
 		return this.exec(['config', '--global', name, value]);
 	}
 
-	private exec(args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
-		var child = this.spawn(args, options);
+	private exec(args: string[], options: any = {}): TPromise<IExecutionResult> {
+		const child = this.spawn(args, options);
 
 		if (options.input) {
 			child.stdin.end(options.input, 'utf8');
 		}
 
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
+		return TPromise.join<any>([
+			new TPromise<number>((c, e) => {
+				child.once('error', e);
+				child.once('exit', c);
 			}),
-			new winjs.TPromise<string>((c) => {
-				var buffer:string = '';
+			new TPromise<string>(c => {
+				let buffer:string = '';
 				child.stdout.setEncoding('utf8');
 				child.stdout.on('data', (data: string) => buffer += data);
-				child.stdout.on('close', () => c(buffer));
+				child.stdout.once('close', () => c(buffer));
 			}),
-			new winjs.TPromise<string>((c) => {
-				var buffer:string = '';
+			new TPromise<string>(c => {
+				let buffer:string = '';
 				child.stderr.setEncoding('utf8');
 				child.stderr.on('data', (data: string) => buffer += data);
-				child.stderr.on('close', () => c(buffer));
+				child.stderr.once('close', () => c(buffer));
 			})
 		]).then<IExecutionResult>((values) => {
-			var exitCode = <number> values[0];
-			var stdout = <string> values[1];
-			var stderr = <string> values[2];
+			const exitCode = <number> values[0];
+			const stdout = <string> values[1];
+			const stderr = <string> values[2];
 
 			if (exitCode) {
-				var gitErrorCode: string = null;
+				let gitErrorCode: string = null;
 
 				if (/Authentication failed/.test(stderr)) {
 					gitErrorCode = GitErrorCodes.AuthenticationFailed;
@@ -184,7 +181,7 @@ export class Git {
 					this.log(stderr);
 				}
 
-				return winjs.TPromise.wrapError<IExecutionResult>(new GitError({
+				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Failed to execute git',
 					stdout: stdout,
 					stderr: stderr,
@@ -194,15 +191,15 @@ export class Git {
 				}));
 			}
 
-			return winjs.TPromise.as<IExecutionResult>({
+			return TPromise.as<IExecutionResult>({
 				code: values[0],
 				stdout: values[1],
 				stderr: values[2]
 			});
 		});
 	}
 
-	public spawn(args: string[], options: any = {}): cp.ChildProcess {
+	public spawn(args: string[], options: any = {}): ChildProcess {
 		if (!this.gitPath) {
 			throw new Error('git could not be found in the system.');
 		}
@@ -227,7 +224,7 @@ export class Git {
 			this.log(strings.format('git {0}\n', args.join(' ')));
 		}
 
-		return cp.spawn(this.gitPath, args, options);
+		return spawn(this.gitPath, args, options);
 	}
 
 	public onOutput(listener: (output: string) => void): () => void {
@@ -258,33 +255,33 @@ export class Repository {
 		return this.repository;
 	}
 
-	public run(args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
+	public run(args: string[], options: any = {}): TPromise<IExecutionResult> {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.run(this.repository, args, options);
 	}
 
-	public stream(args: string[], options: any = {}): cp.ChildProcess {
+	public stream(args: string[], options: any = {}): ChildProcess {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.stream(this.repository, args, options);
 	}
 
-	public spawn(args: string[], options: any = {}): cp.ChildProcess {
+	public spawn(args: string[], options: any = {}): ChildProcess {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.spawn(args, options);
 	}
 
-	public init(): winjs.Promise {
+	public init(): Promise {
 		return this.run(['init']);
 	}
 
-	public config(scope: string, key:string, value:any, options:any): winjs.TPromise<string> {
-		var args = ['config'];
+	public config(scope: string, key:string, value:any, options:any): TPromise<string> {
+		const args = ['config'];
 
 		if (scope) {
 			args.push('--' + scope);
@@ -299,14 +296,14 @@ export class Repository {
 		return this.run(args, options).then((result) => result.stdout);
 	}
 
-	public show(object: string): cp.ChildProcess {
+	public show(object: string): ChildProcess {
 		return this.stream(['show', object]);
 	}
 
-	public buffer(object: string): winjs.TPromise<string> {
-		var child = this.show(object);
+	public buffer(object: string): TPromise<string> {
+		const child = this.show(object);
 
-		return new winjs.Promise((c, e) => {
+		return new Promise((c, e) => {
 			detectMimesFromStream(child.stdout, null, (err, result) => {
 				if (err) {
 					e(err);
@@ -322,40 +319,40 @@ export class Repository {
 		});
 	}
 
-	private doBuffer(object: string): winjs.TPromise<string> {
-		var child = this.show(object);
+	private doBuffer(object: string): TPromise<string> {
+		const child = this.show(object);
 
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
+		return TPromise.join<any>([
+			new TPromise<number>((c, e) => {
+				child.once('error', e);
+				child.once('exit', c);
 			}),
-			new winjs.TPromise<string>((c) => {
-				var buffers: NodeBuffer[] = [];
+			new TPromise<string>(c => {
+				const buffers: NodeBuffer[] = [];
 				child.stdout.on('data', (b: NodeBuffer) => buffers.push(b));
-				child.stdout.on('close', () => c(iconv.decode(Buffer.concat(buffers), this.defaultEncoding)));
+				child.stdout.once('close', () => c(iconv.decode(Buffer.concat(buffers), this.defaultEncoding)));
 			}),
-			new winjs.Promise((c) => {
+			new Promise(c => {
 				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.on('close', () => c(null));
+				child.stderr.once('close', () => c(null));
 			})
 		]).then((values) => {
-			var exitCode = <number> values[0];
-			var result = <string> values[1];
+			const exitCode = <number> values[0];
+			const result = <string> values[1];
 
 			if (exitCode) {
-				return winjs.TPromise.wrapError<string>(new GitError({
+				return TPromise.wrapError<string>(new GitError({
 					message: 'Could not buffer object.',
 					exitCode: exitCode
 				}));
 			}
 
-			return winjs.TPromise.as<string>(result);
+			return TPromise.as<string>(result);
 		});
 	}
 
-	public add(paths: string[]): winjs.Promise {
-		var args = ['add', '-A', '--'];
+	public add(paths: string[]): Promise {
+		const args = ['add', '-A', '--'];
 
 		if (paths && paths.length) {
 			args.push.apply(args, paths);
@@ -366,31 +363,31 @@ export class Repository {
 		return this.run(args);
 	}
 
-	public stage(path: string, data: string): winjs.Promise {
-		var child = this.stream(['hash-object', '--stdin', '-w'], { stdio: [null, null, null] });
+	public stage(path: string, data: string): Promise {
+		const child = this.stream(['hash-object', '--stdin', '-w'], { stdio: [null, null, null] });
 		child.stdin.end(data, 'utf8');
 
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
+		return TPromise.join<any>([
+			new TPromise<number>((c, e) => {
+				child.once('error', e);
+				child.once('exit', c);
 			}),
-			new winjs.TPromise<string>((c) => {
-				var id = '';
+			new TPromise<string>(c => {
+				let id = '';
 				child.stdout.setEncoding('utf8');
 				child.stdout.on('data', (data:string) => id += data);
-				child.stdout.on('close', () => c(id));
+				child.stdout.once('close', () => c(id));
 			}),
-			new winjs.Promise((c) => {
+			new Promise(c => {
 				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.on('close', () => c(null));
+				child.stderr.once('close', () => c(null));
 			})
 		]).then<IExecutionResult>((values) => {
-			var exitCode = <number> values[0];
-			var id = <string> values[1];
+			const exitCode = <number> values[0];
+			const id = <string> values[1];
 
 			if (exitCode) {
-				return winjs.TPromise.wrapError<IExecutionResult>(new GitError({
+				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Could not hash object.',
 					exitCode: exitCode
 				}));
@@ -400,8 +397,8 @@ export class Repository {
 		});
 	}
 
-	public checkout(treeish: string, paths: string[]): winjs.Promise {
-		var args = [ 'checkout', '-q' ];
+	public checkout(treeish: string, paths: string[]): Promise {
+		const args = [ 'checkout', '-q' ];
 
 		if (treeish) {
 			args.push(treeish);
@@ -417,12 +414,12 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.DirtyWorkTree;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public commit(message: string, all: boolean, amend: boolean): winjs.Promise {
-		var args = ['commit', '--quiet', '--allow-empty-message', '--file', '-'];
+	public commit(message: string, all: boolean, amend: boolean): Promise {
+		const args = ['commit', '--quiet', '--allow-empty-message', '--file', '-'];
 
 		if (all) {
 			args.push('--all');
@@ -435,47 +432,47 @@ export class Repository {
 		return this.run(args, { input: message || '' }).then(null, (commitErr: GitError) => {
 			if (/not possible because you have unmerged files/.test(commitErr.stderr)) {
 				commitErr.gitErrorCode = GitErrorCodes.UnmergedChanges;
-				return winjs.Promise.wrapError(commitErr);
+				return Promise.wrapError(commitErr);
 			}
 
 			return this.run(['config', '--get-all', 'user.name']).then(null, (err: GitError) => {
 				err.gitErrorCode = GitErrorCodes.NoUserNameConfigured;
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			}).then(() => {
 				return this.run(['config', '--get-all', 'user.email']).then(null, (err: GitError) => {
 					err.gitErrorCode = GitErrorCodes.NoUserEmailConfigured;
-					return winjs.Promise.wrapError(err);
+					return Promise.wrapError(err);
 				}).then(() => {
-					return winjs.Promise.wrapError(commitErr);
+					return Promise.wrapError(commitErr);
 				});
 			});
 		});
 	}
 
-	public branch(name: string, checkout: boolean): winjs.Promise {
-		var args = checkout ? ['checkout', '-q', '-b', name] : [ 'branch', '-q', name ];
+	public branch(name: string, checkout: boolean): Promise {
+		const args = checkout ? ['checkout', '-q', '-b', name] : [ 'branch', '-q', name ];
 		return this.run(args);
 	}
 
-	public clean(paths: string[]): winjs.Promise {
-		var args = [ 'clean', '-f', '-q', '--' ].concat(paths);
+	public clean(paths: string[]): Promise {
+		const args = [ 'clean', '-f', '-q', '--' ].concat(paths);
 		return this.run(args);
 	}
 
-	public undo(): winjs.Promise {
+	public undo(): Promise {
 		return this.run([ 'clean', '-fd' ]).then(() => {
 			return this.run([ 'checkout', '--', '.' ]).then(null, (err: GitError) => {
 				if (/did not match any file\(s\) known to git\./.test(err.stderr)) {
-					return winjs.Promise.as(null);
+					return Promise.as(null);
 				}
 
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			});
 		});
 	}
 
-	public reset(treeish: string, hard: boolean = false): winjs.Promise {
-		var args = ['reset'];
+	public reset(treeish: string, hard: boolean = false): Promise {
+		const args = ['reset'];
 
 		if (hard) {
 			args.push('--hard');
@@ -486,9 +483,9 @@ export class Repository {
 		return this.run(args);
 	}
 
-	public revertFiles(treeish: string, paths: string[]): winjs.Promise {
+	public revertFiles(treeish: string, paths: string[]): Promise {
 		return this.run([ 'branch' ]).then((result) => {
-			var args: string[];
+			let args: string[];
 
 			// In case there are no branches, we must use rm --cached
 			if (!result.stdout) {
@@ -507,15 +504,15 @@ export class Repository {
 				// In case there are merge conflicts to be resolved, git reset will output
 				// some "needs merge" data. We try to get around that.
 				if (/([^:]+: needs merge\n)+/m.test(err.stdout)) {
-					return winjs.Promise.as(null);
+					return Promise.as(null);
 				}
 
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			});
 		});
 	}
 
-	public fetch(): winjs.Promise {
+	public fetch(): Promise {
 		return this.run(['fetch']).then(null, (err: GitError) => {
 			if (/No remote repository specified\./.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.NoRemoteRepositorySpecified;
@@ -525,11 +522,11 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.RemoteConnectionError;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public pull(): winjs.Promise {
+	public pull(): Promise {
 		return this.run(['pull']).then(null, (err: GitError) => {
 			if (/^CONFLICT \([^)]+\): \b/m.test(err.stdout)) {
 				err.gitErrorCode = GitErrorCodes.Conflict;
@@ -541,39 +538,40 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.DirtyWorkTree;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public push(): winjs.Promise {
+	public push(): Promise {
 		return this.run(['push']).then(null, (err: GitError) => {
 			if (/^error: failed to push some refs to\b/m.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.PushRejected;
 			} else if (/Could not read from remote repository/.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.RemoteConnectionError;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public sync(): winjs.Promise {
+	public sync(): Promise {
 		return this.pull().then(() => this.push());
 	}
 
-	public getRoot(): winjs.TPromise<string> {
+	public getRoot(): TPromise<string> {
 		return this.run(['rev-parse', '--show-toplevel'], { log: false }).then(result => result.stdout.trim());
 	}
 
-	public getStatus(): winjs.TPromise<IRawFileStatus[]> {
+	public getStatus(): TPromise<IRawFileStatus[]> {
 		return this.run(['status', '-z', '-u'], { log: false }).then((executionResult) => {
-			var status = executionResult.stdout;
-			var result:IRawFileStatus[] = [];
-			var current:IRawFileStatus;
-			var i = 0;
+			const status = executionResult.stdout;
+			const result:IRawFileStatus[] = [];
+			let current:IRawFileStatus;
+			let i = 0;
 
 			function readName():string {
-				var start = i, c:string;
+				const start = i;
+				let c:string;
 				while ((c = status.charAt(i)) !== '\u0000') { i++; }
 				return status.substring(start, i++);
 			}
@@ -603,29 +601,29 @@ export class Repository {
 				result.push(current);
 			}
 
-			return winjs.TPromise.as<IRawFileStatus[]>(result);
+			return TPromise.as<IRawFileStatus[]>(result);
 		});
 	}
 
-	public getHEAD(): winjs.TPromise<IHead> {
+	public getHEAD(): TPromise<IHead> {
 		return this.run(['symbolic-ref', '--short', 'HEAD'], { log: false }).then((result) => {
 			if (!result.stdout) {
-				return winjs.TPromise.wrapError<IHead>(new Error('Not in a branch'));
+				return TPromise.wrapError<IHead>(new Error('Not in a branch'));
 			}
 
-			return winjs.TPromise.as<IHead>({ name: result.stdout.trim() });
+			return TPromise.as<IHead>({ name: result.stdout.trim() });
 		}, (err) => {
 			return this.run(['rev-parse', 'HEAD'], { log: false }).then((result) => {
 				if (!result.stdout) {
-					return winjs.TPromise.wrapError<IHead>(new Error('Error parsing HEAD'));
+					return TPromise.wrapError<IHead>(new Error('Error parsing HEAD'));
 				}
 
-				return winjs.TPromise.as<IHead>({ commit: result.stdout.trim() });
+				return TPromise.as<IHead>({ commit: result.stdout.trim() });
 			});
 		});
 	}
 
-	public getHeads(): winjs.TPromise<ITag[]> {
+	public getHeads(): TPromise<ITag[]> {
 		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/heads/'], { log: false }).then((result) => {
 			return result.stdout.trim().split('\n')
 				.filter(b => !!b)
@@ -634,7 +632,7 @@ export class Repository {
 		});
 	}
 
-	public getTags(): winjs.TPromise<IHead[]> {
+	public getTags(): TPromise<IHead[]> {
 		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/tags/'], { log: false }).then((result) => {
 			return result.stdout.trim().split('\n')
 				.filter(b => !!b)
@@ -643,24 +641,24 @@ export class Repository {
 		});
 	}
 
-	public getBranch(branch: string): winjs.TPromise<IBranch> {
+	public getBranch(branch: string): TPromise<IBranch> {
 		if (branch === 'HEAD') {
 			return this.getHEAD();
 		}
 
 		return this.run(['rev-parse', branch], { log: false }).then((result) => {
 			if (!result.stdout) {
-				return winjs.TPromise.wrapError<IBranch>(new Error('No such branch'));
+				return TPromise.wrapError<IBranch>(new Error('No such branch'));
 			}
 
-			var commit = result.stdout.trim();
+			const commit = result.stdout.trim();
 
 			return this.run(['rev-parse', '--symbolic-full-name', '--abbrev-ref', branch + '@{u}'], { log: false }).then((result: IExecutionResult) => {
-				var upstream = result.stdout.trim();
+				const upstream = result.stdout.trim();
 
 				return this.run(['rev-list', '--left-right', branch + '...' + upstream], { log: false }).then((result) => {
-					var ahead = 0, behind = 0;
-					var i = 0;
+					let ahead = 0, behind = 0;
+					let i = 0;
 
 					while (i < result.stdout.length) {
 						switch (result.stdout.charAt(i)) {

author:joaomoreno
date:2015-11-26T17:40:11Z
title:cleanup gitApp
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -10,54 +10,37 @@ import uri from 'vs/base/common/uri';
 import gitlib = require('vs/workbench/parts/git/node/git.lib');
 import rawgitservice = require('vs/workbench/parts/git/node/rawGitService');
 
-import path = require('path');
-import fs = require('fs');
+import { join, dirname, normalize } from 'path';
+import { tmpdir } from 'os';
+import { writeFileSync } from 'fs';
 
-class NativeRawGitService extends rawgitservice.RawGitService {
+class IPCRawGitService extends rawgitservice.RawGitService {
 
 	constructor(gitPath: string, basePath: string, defaultEncoding: string, exePath: string) {
 		if (!gitPath) {
 			super(null);
-			return;
+		} else {
+			const gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
+			const bootstrapPath = `${ uri.parse(require.toUrl('bootstrap')).fsPath }.js`;
+
+			const env = objects.assign({}, process.env, {
+				GIT_ASKPASS: join(gitRootPath, 'askpass.sh'),
+				VSCODE_GIT_ASKPASS_BOOTSTRAP: bootstrapPath,
+				VSCODE_GIT_ASKPASS_NODE: exePath,
+				VSCODE_GIT_ASKPASS_MODULE_ID: 'vs/workbench/parts/git/electron-main/askpass'
+			});
+
+			const git = new gitlib.Git({
+				gitPath: gitPath,
+				tmpPath: tmpdir(),
+				defaultEncoding: defaultEncoding,
+				env: env
+			});
+
+			super(git.open(normalize(basePath)));
 		}
-
-		var gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
-
-		var env = objects.assign(objects.assign({}, process.env), {
-			GIT_ASKPASS: path.join(gitRootPath, 'askpass.sh'),
-			VSCODE_GIT_ASKPASS_BOOTSTRAP: path.join(path.dirname(path.dirname(path.dirname(path.dirname(path.dirname(gitRootPath))))), 'bootstrap.js'),
-			VSCODE_GIT_ASKPASS_NODE: exePath,
-			VSCODE_GIT_ASKPASS_MODULE_ID: 'vs/workbench/parts/git/electron-main/askpass'
-		});
-
-		var git = new gitlib.Git({
-			gitPath: gitPath,
-			tmpPath: tmpdirSync(), // TODO@Joao os.tmpdir()???
-			defaultEncoding: defaultEncoding,
-			env: env
-		});
-
-		super(git.open(path.normalize(basePath)));
 	}
 }
 
-function tmpdirSync(): string {
-	var path: string;
-	var paths = /^win/i.test(process.platform) ? [process.env.TMP, process.env.TEMP] : ['/tmp', '/var/tmp', '/private/tmp', '/private/var/tmp'];
-
-	for (var i = 0; i < paths.length; i++) {
-		path = paths[i];
-		try {
-			if (fs.statSync(path).isDirectory()) {
-				return path;
-			}
-		} catch (e) {
-			// Ignore
-		}
-	}
-
-	throw new Error('Temp dir not found');
-}
-
 const server = new Server();
-server.registerService('GitService', new NativeRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5]));
\ No newline at end of file
+server.registerService('GitService', new IPCRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5]));
\ No newline at end of file

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -33,17 +33,17 @@ import wbar = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
 import { OpenChangeAction, SyncAction } from './gitActions';
 import Severity from 'vs/base/common/severity';
+import paths = require('vs/base/common/paths');
+import URI from 'vs/base/common/uri';
 
 function getStatus(gitService: IGitService, contextService: IWorkspaceContextService, input: WorkbenchEditorCommon.IFileEditorInput): IFileStatus {
-	var statusModel = gitService.getModel().getStatus();
+	const model = gitService.getModel();
+	const repositoryRoot = model.getRepositoryRoot();
+	const statusModel = model.getStatus();
+	const repositoryRelativePath = paths.normalize(paths.relative(repositoryRoot, input.getResource().fsPath));
 
-	var workspaceRelativePath = contextService.toWorkspaceRelativePath(input.getResource());
-	if (!workspaceRelativePath) {
-		return null; // out of workspace not yet supported
-	}
-
-	return statusModel.getWorkingTreeStatus().find(workspaceRelativePath) ||
-			statusModel.getIndexStatus().find(workspaceRelativePath);
+	return statusModel.getWorkingTreeStatus().find(repositoryRelativePath) ||
+			statusModel.getIndexStatus().find(repositoryRelativePath);
 }
 
 class OpenInDiffAction extends baseeditor.EditorInputAction {
@@ -78,6 +78,10 @@ class OpenInDiffAction extends baseeditor.EditorInputAction {
 			return false;
 		}
 
+		if (!(typeof this.gitService.getModel().getRepositoryRoot() === 'string')) {
+			return false;
+		}
+
 		var status = this.getStatus();
 
 		return status && (
@@ -164,6 +168,10 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 			return false;
 		}
 
+		if (!(typeof this.gitService.getModel().getRepositoryRoot() === 'string')) {
+			return false;
+		}
+
 		var status:IFileStatus = (<any>this.input).getFileStatus();
 		if (OpenInEditorAction.DELETED_STATES.indexOf(status.getStatus()) > -1) {
 			return false;
@@ -173,18 +181,19 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 	}
 
 	public run(event?: any): Promise {
-		var sideBySide = !!(event && (event.ctrlKey || event.metaKey));
-		var modifiedViewState = this.saveTextViewState();
-		var path = this.getPath();
+		const model = this.gitService.getModel();
+		const resource = URI.file(paths.join(model.getRepositoryRoot(), this.getRepositoryRelativePath()));
+		const sideBySide = !!(event && (event.ctrlKey || event.metaKey));
+		const modifiedViewState = this.saveTextViewState();
 
-		return this.fileService.resolveFile(this.contextService.toResource(path)).then((stat: IFileStat) => {
+		return this.fileService.resolveFile(resource).then(stat => {
 			return this.editorService.openEditor({
 				resource: stat.resource,
 				mime: stat.mime,
 				options: {
 					forceOpen: true
 				}
-			}, sideBySide).then((editor)=> {
+			}, sideBySide).then(editor => {
 				this.restoreTextViewState(modifiedViewState);
 
 				if (this.partService.isVisible(Parts.SIDEBAR_PART)) {
@@ -222,7 +231,7 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 		return null;
 	}
 
-	private getPath():string {
+	private getRepositoryRelativePath():string {
 		var status: IFileStatus = (<any> this.input).getFileStatus();
 
 		if (status.getStatus() === Status.INDEX_RENAMED) {

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -32,6 +32,7 @@ import {IInstantiationService} from 'vs/platform/instantiation/common/instantiat
 import {IMessageService} from 'vs/platform/message/common/message';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
 import {ILifecycleService} from 'vs/platform/lifecycle/common/lifecycle';
+import URI from 'vs/base/common/uri';
 
 function toReadablePath(path: string): string {
 	if (!platform.isWindows) {
@@ -158,9 +159,9 @@ class EditorInputCache
 	}
 
 	private createRightInput(status: git.IFileStatus): winjs.Promise {
-		var path = status.getPath();
-		var resource = this.contextService.toResource(path);
-		var model = this.gitService.getModel();
+		const model = this.gitService.getModel();
+		const path = status.getPath();
+		let resource = URI.file(paths.join(model.getRepositoryRoot(), path));
 
 		switch (status.getStatus()) {
 			case git.Status.INDEX_MODIFIED:
@@ -181,13 +182,13 @@ class EditorInputCache
 				var indexStatus = model.getStatus().find(path, git.StatusType.INDEX);
 
 				if (indexStatus && indexStatus.getStatus() === git.Status.INDEX_RENAMED) {
-					return this.editorService.inputToType({ resource: this.contextService.toResource(indexStatus.getRename()) });
+					resource = URI.file(paths.join(model.getRepositoryRoot(), indexStatus.getRename()));
 				}
 
-				return this.editorService.inputToType({ resource: resource });
+				return this.editorService.inputToType({ resource });
 
 			case git.Status.BOTH_MODIFIED:
-				return this.editorService.inputToType({ resource: resource });
+				return this.editorService.inputToType({ resource });
 
 			default:
 				return winjs.Promise.as(null);
@@ -391,7 +392,16 @@ export class GitService extends ee.EventEmitter
 	private refreshDelayer: async.ThrottledDelayer;
 	private autoFetcher: AutoFetcher;
 
-	constructor(raw: git.IRawGitService, @IInstantiationService instantiationService: IInstantiationService, @IEventService eventService: IEventService, @IMessageService messageService: IMessageService, @IWorkbenchEditorService editorService: IWorkbenchEditorService, @IOutputService outputService: IOutputService, @IWorkspaceContextService contextService: IWorkspaceContextService, @ILifecycleService lifecycleService: ILifecycleService) {
+	constructor(
+		raw: git.IRawGitService,
+		@IInstantiationService instantiationService: IInstantiationService,
+		@IEventService eventService: IEventService,
+		@IMessageService messageService: IMessageService,
+		@IWorkbenchEditorService editorService: IWorkbenchEditorService,
+		@IOutputService outputService: IOutputService,
+		@IWorkspaceContextService contextService: IWorkspaceContextService,
+		@ILifecycleService lifecycleService: ILifecycleService
+	) {
 		super();
 
 		this.instantiationService = instantiationService;

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/gitWorkbenchContributions.ts
code:
@@ -9,6 +9,7 @@ import 'vs/css!./media/git.contribution';
 import nls = require('vs/nls');
 import async = require('vs/base/common/async');
 import errors = require('vs/base/common/errors');
+import paths = require('vs/base/common/paths');
 import actions = require('vs/base/common/actions');
 import lifecycle = require('vs/base/common/lifecycle');
 import Severity from 'vs/base/common/severity';
@@ -335,7 +336,19 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 		// HACK: This is the best current way of figuring out whether to draw these decorations
 		// or not. Needs context from the editor, to know whether it is a diff editor, in place editor
 		// etc.
-		var models = this.editorService.getVisibleEditors()
+
+		const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+
+		// If there is no repository root, just wait until that changes
+		if (typeof repositoryRoot !== 'string') {
+			this.gitService.addOneTimeListener(git.ServiceEvents.STATE_CHANGED, () => this.onEditorInputChange());
+
+			this.models.forEach(m => this.onModelInvisible(m));
+			this.models = [];
+			return;
+		}
+
+		const models = this.editorService.getVisibleEditors()
 
 			// map to the editor controls
 			.map(e => e.getControl())
@@ -354,12 +367,12 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 
 			// remove nulls
 			.filter(p => !!p.resource &&
-				// and ivalid resources
-				(p.resource.scheme === 'file' && !!this.contextService.isInsideWorkspace(p.resource))
+				// and invalid resources
+				(p.resource.scheme === 'file' && paths.isEqualOrParent(p.resource.fsPath, repositoryRoot))
 			)
 
 			// get paths
-			.map(p => ({ model: p.model, path: this.contextService.toWorkspaceRelativePath(p.resource) }))
+			.map(p => ({ model: p.model, path: paths.normalize(paths.relative(repositoryRoot, p.resource.fsPath)) }))
 
 			// remove nulls and inside .git files
 			.filter(p => !!p.path && p.path.indexOf('.git/') === -1);

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.css
code:
@@ -60,7 +60,7 @@
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .status-group {
 	font-size: 11px;
-	font-weight: bold;	
+	font-weight: bold;
 	text-transform: uppercase;
 	cursor: default;
 }
@@ -84,6 +84,10 @@
 	color: inherit;
 }
 
+.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.out-of-workspace {
+	opacity: 0.5;
+}
+
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .status {
 	position: absolute;
 	top: 4px;
@@ -99,7 +103,7 @@
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .name {
-	margin-left: 20px;	
+	margin-left: 20px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.modified .status	{ background-color: #007ACC; }
@@ -123,7 +127,7 @@
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.both-deleted .name,
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.deleted-by-them .name,
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.deleted-by-us .name {
-	text-decoration: line-through; 
+	text-decoration: line-through;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status:not(.renamed) > .rename {
@@ -159,8 +163,8 @@
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.untracked .status,
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.ignored .status,
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.conflict .status,
-.hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row.selected .file-status .status { 
-	background-color: #000; 
+.hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row.selected .file-status .status {
+	background-color: #000;
 	color: #fff;
 	border: 1px solid #6FC3DF;
 }
\ No newline at end of file

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -12,6 +12,7 @@ import Lifecycle = require('vs/base/common/lifecycle');
 import EventEmitter = require('vs/base/common/eventEmitter');
 import Strings = require('vs/base/common/strings');
 import Errors = require('vs/base/common/errors');
+import * as paths from 'vs/base/common/paths';
 import WinJS = require('vs/base/common/winjs.base');
 import Builder = require('vs/base/browser/builder');
 import Keyboard = require('vs/base/browser/keyboardEvent');
@@ -400,19 +401,27 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 		}
 
 		if (input instanceof Files.FileEditorInput) {
-			var fileInput = <Files.FileEditorInput> input;
+			const fileInput = <Files.FileEditorInput> input;
+			const resource = fileInput.getResource();
 
-			var workspaceRelativePath = this.contextService.toWorkspaceRelativePath(fileInput.getResource());
-			if (!workspaceRelativePath) {
+			const workspaceRoot = this.contextService.getWorkspace().resource.fsPath;
+			if (!paths.isEqualOrParent(resource.fsPath, workspaceRoot)) {
 				return null; // out of workspace not yet supported
 			}
 
-			var status = this.gitService.getModel().getStatus().getWorkingTreeStatus().find(workspaceRelativePath);
+			const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+			if (!paths.isEqualOrParent(resource.fsPath, repositoryRoot)) {
+				return null; // out of repository not supported
+			}
+
+			const repositoryRelativePath = paths.normalize(paths.relative(repositoryRoot, resource.fsPath));
+
+			var status = this.gitService.getModel().getStatus().getWorkingTreeStatus().find(repositoryRelativePath);
 			if (status && (status.getStatus() === git.Status.UNTRACKED || status.getStatus() === git.Status.IGNORED)) {
 				return status;
 			}
 
-			status = this.gitService.getModel().getStatus().getMergeStatus().find(workspaceRelativePath);
+			status = this.gitService.getModel().getStatus().getMergeStatus().find(repositoryRelativePath);
 			if (status) {
 				return status;
 			}

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/browser/views/changes/changesViewer.ts
code:
@@ -8,6 +8,7 @@ import winjs = require('vs/base/common/winjs.base');
 import nls = require('vs/nls');
 import platform = require('vs/base/common/platform');
 import errors = require('vs/base/common/errors');
+import paths = require('vs/base/common/paths');
 import severity from 'vs/base/common/severity';
 import lifecycle = require('vs/base/common/lifecycle');
 import dom = require('vs/base/browser/dom');
@@ -24,10 +25,12 @@ import actionsrenderer = require('vs/base/parts/tree/browser/actionsRenderer');
 import git = require('vs/workbench/parts/git/common/git');
 import gitmodel = require('vs/workbench/parts/git/common/gitModel');
 import gitactions = require('vs/workbench/parts/git/browser/gitActions');
-import {IContextMenuService} from 'vs/platform/contextview/browser/contextView';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IMessageService} from 'vs/platform/message/common/message';
-import {CommonKeybindings} from 'vs/base/common/keyCodes';
+import { IContextMenuService } from 'vs/platform/contextview/browser/contextView';
+import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
+import { IMessageService } from 'vs/platform/message/common/message';
+import { CommonKeybindings } from 'vs/base/common/keyCodes';
+import { IWorkspaceContextService } from 'vs/platform/workspace/common/workspace';
+import URI from 'vs/base/common/uri';
 
 import IGitService = git.IGitService
 
@@ -218,10 +221,14 @@ interface IStatusGroupTemplateData {
 
 export class Renderer implements tree.IRenderer {
 
-	private messageService: IMessageService;
-
-	constructor(private actionProvider:ActionProvider, private actionRunner: actions.IActionRunner, @IMessageService messageService: IMessageService) {
-		this.messageService = messageService;
+	constructor(
+		private actionProvider:ActionProvider,
+		private actionRunner: actions.IActionRunner,
+		@IMessageService private messageService: IMessageService,
+		@IGitService private gitService: IGitService,
+		@IWorkspaceContextService private contextService: IWorkspaceContextService
+	) {
+		// noop
 	}
 
 	public getHeight(tree:tree.ITree, element:any): number {
@@ -298,7 +305,7 @@ export class Renderer implements tree.IRenderer {
 
 	public renderElement(tree: tree.ITree, element: any, templateId: string, templateData: any): void {
 		if (/^file:/.test(templateId)) {
-			Renderer.renderFileStatus(tree, <git.IFileStatus> element, templateData);
+			this.renderFileStatus(tree, <git.IFileStatus> element, templateData);
 		} else {
 			Renderer.renderStatusGroup(<git.IStatusGroup> element, templateData);
 		}
@@ -309,30 +316,49 @@ export class Renderer implements tree.IRenderer {
 		data.count.setCount(statusGroup.all().length);
 	}
 
-	private static renderFileStatus(tree: tree.ITree, fileStatus: git.IFileStatus, data: IFileStatusTemplateData): void {
+	private renderFileStatus(tree: tree.ITree, fileStatus: git.IFileStatus, data: IFileStatusTemplateData): void {
 		data.actionBar.context = {
 			tree: tree,
 			fileStatus: fileStatus
 		};
 
-		var status = fileStatus.getStatus();
-		var renamePath = fileStatus.getRename();
-		var path = fileStatus.getPath();
-		var lastSlashIndex = path.lastIndexOf('/');
-		var name = lastSlashIndex === -1 ? path : path.substr(lastSlashIndex + 1, path.length);
-		var folder = (lastSlashIndex === -1 ? '' : path.substr(0, lastSlashIndex));
+		const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+		const workspaceRoot = this.contextService.getWorkspace().resource.fsPath;
+
+		const status = fileStatus.getStatus();
+		const renamePath = fileStatus.getRename();
+		const path = fileStatus.getPath();
+		const lastSlashIndex = path.lastIndexOf('/');
+		const name = lastSlashIndex === -1 ? path : path.substr(lastSlashIndex + 1, path.length);
+		const folder = (lastSlashIndex === -1 ? '' : path.substr(0, lastSlashIndex));
 
 		data.root.className = 'file-status ' + Renderer.statusToClass(status);
 		data.status.textContent = Renderer.statusToChar(status);
 		data.status.title = Renderer.statusToTitle(status);
 
+		const resource = URI.file(paths.normalize(paths.join(repositoryRoot, path)));
+		let isInWorkspace = paths.isEqualOrParent(resource.fsPath, workspaceRoot);
+
+		let rename = '';
+		let renameFolder = '';
+
 		if (renamePath) {
-			var renameLastSlashIndex = renamePath.lastIndexOf('/');
-			var rename = renameLastSlashIndex === -1 ? renamePath : renamePath.substr(renameLastSlashIndex + 1, renamePath.length);
-			var renameFolder = (renameLastSlashIndex === -1 ? '' : renamePath.substr(0, renameLastSlashIndex));
+			const renameLastSlashIndex = renamePath.lastIndexOf('/');
+			rename = renameLastSlashIndex === -1 ? renamePath : renamePath.substr(renameLastSlashIndex + 1, renamePath.length);
+			renameFolder = (renameLastSlashIndex === -1 ? '' : renamePath.substr(0, renameLastSlashIndex));
 
 			data.renameName.textContent = name;
 			data.renameFolder.textContent = folder;
+
+			const resource = URI.file(paths.normalize(paths.join(repositoryRoot, renamePath)));
+			isInWorkspace = paths.isEqualOrParent(resource.fsPath, workspaceRoot)
+		}
+
+		if (isInWorkspace) {
+			data.root.title = '';
+		} else {
+			data.root.title = nls.localize('outsideOfWorkspace', "This file is located outside the current workspace.");
+			data.root.className += ' out-of-workspace';
 		}
 
 		data.name.textContent = rename || name;

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -38,6 +38,7 @@ export interface ITag {
 }
 
 export interface IRawStatus {
+	repositoryRoot: string;
 	state?: ServiceState;
 	status: IRawFileStatus[];
 	HEAD: IBranch;
@@ -113,7 +114,7 @@ export interface IStatusSummary {
 
 export interface IStatusModel extends EventEmitter.IEventEmitter {
 	getSummary(): IStatusSummary;
-	update(rawStatuses: IRawFileStatus[]): void;
+	update(status: IRawFileStatus[]): void;
 	getIndexStatus(): IStatusGroup;
 	getWorkingTreeStatus(): IStatusGroup;
 	getMergeStatus(): IStatusGroup;
@@ -122,6 +123,7 @@ export interface IStatusModel extends EventEmitter.IEventEmitter {
 }
 
 export interface IModel extends EventEmitter.IEventEmitter {
+	getRepositoryRoot(): string;
 	getStatus(): IStatusModel;
 	getHEAD(): IBranch;
 	getHeads(): IBranch[];

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/common/gitModel.ts
code:
@@ -12,19 +12,17 @@ import Git = require('vs/workbench/parts/git/common/git');
 export class FileStatus implements Git.IFileStatus {
 
 	private id: string;
-	private path: string;
 	private pathComponents: string[];
-	private mimetype: string;
-	private status: Git.Status;
-	private rename: string;
 
-	constructor(path: string, mimetype: string, status: Git.Status, rename?: string, isModifiedInIndex?: boolean) {
+	constructor(
+		private path: string,
+		private mimetype: string,
+		private status: Git.Status,
+		private rename?: string,
+		isModifiedInIndex?: boolean
+	) {
 		this.id = FileStatus.typeOf(status) + ':' + path + (rename ? ':' + rename : '') + (isModifiedInIndex ? '$' : '');
-		this.path = path;
 		this.pathComponents = path.split('/');
-		this.mimetype = mimetype;
-		this.rename = rename;
-		this.status = status;
 	}
 
 	public getPath(): string {
@@ -211,27 +209,25 @@ export class StatusModel extends EventEmitter.EventEmitter implements Git.IStatu
 		};
 	}
 
-	public update(rawStatuses: Git.IRawFileStatus[]): void {
+	public update(status: Git.IRawFileStatus[]): void {
 		var index: FileStatus[] = [];
 		var workingTree: FileStatus[] = [];
 		var merge: FileStatus[] = [];
 
-		for (var i = 0; i < rawStatuses.length; i++) {
-			var raw = rawStatuses[i];
-
+		status.forEach(raw => {
 			switch(raw.x + raw.y) {
-				case '??': workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.UNTRACKED)); continue;
-				case '!!': workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.IGNORED)); continue;
-				case 'DD': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_DELETED)); continue;
-				case 'AU': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.ADDED_BY_US)); continue;
-				case 'UD': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.DELETED_BY_THEM)); continue;
-				case 'UA': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.ADDED_BY_THEM)); continue;
-				case 'DU': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.DELETED_BY_US)); continue;
-				case 'AA': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_ADDED)); continue;
-				case 'UU': merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_MODIFIED)); continue;
+				case '??': return workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.UNTRACKED));
+				case '!!': return workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.IGNORED));
+				case 'DD': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_DELETED));
+				case 'AU': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.ADDED_BY_US));
+				case 'UD': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.DELETED_BY_THEM));
+				case 'UA': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.ADDED_BY_THEM));
+				case 'DU': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.DELETED_BY_US));
+				case 'AA': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_ADDED));
+				case 'UU': return merge.push(new FileStatus(raw.path, raw.mimetype, Git.Status.BOTH_MODIFIED));
 			}
 
-			var isModifiedInIndex = false;
+			let isModifiedInIndex = false;
 
 			switch (raw.x) {
 				case 'M': index.push(new FileStatus(raw.path, raw.mimetype, Git.Status.INDEX_MODIFIED)); isModifiedInIndex = true; break;
@@ -245,7 +241,7 @@ export class StatusModel extends EventEmitter.EventEmitter implements Git.IStatu
 				case 'M': workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.MODIFIED, raw.rename, isModifiedInIndex)); break;
 				case 'D': workingTree.push(new FileStatus(raw.path, raw.mimetype, Git.Status.DELETED, raw.rename)); break;
 			}
-		}
+		});
 
 		this.indexStatus.update(index);
 		this.workingTreeStatus.update(workingTree);
@@ -311,6 +307,7 @@ export class StatusModel extends EventEmitter.EventEmitter implements Git.IStatu
 
 export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 
+	private repositoryRoot: string;
 	private status: Git.IStatusModel;
 	private HEAD: Git.IBranch;
 	private heads: Git.IBranch[];
@@ -322,6 +319,7 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 
 		this.toDispose = [];
 
+		this.repositoryRoot = null;
 		this.status = new StatusModel();
 		this.toDispose.push(this.addEmitter2(this.status));
 
@@ -330,6 +328,10 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 		this.tags = [];
 	}
 
+	public getRepositoryRoot(): string {
+		return this.repositoryRoot;
+	}
+
 	public getStatus(): Git.IStatusModel {
 		return this.status;
 	}
@@ -349,13 +351,15 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 	public update(status: Git.IRawStatus): void {
 		if (!status) {
 			status = {
+				repositoryRoot: null,
 				status: [],
 				HEAD: null,
 				heads: [],
 				tags: []
 			};
 		}
 
+		this.repositoryRoot = status.repositoryRoot;
 		this.status.update(status.status);
 
 		this.HEAD = status.HEAD;

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -9,6 +9,7 @@ import winjs = require('vs/base/common/winjs.base');
 
 export class NoOpGitService implements git.IRawGitService {
 	private static STATUS:git.IRawStatus = {
+		repositoryRoot: null,
 		state: git.ServiceState.NotAWorkspace,
 		status: [],
 		HEAD: null,

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -4,20 +4,19 @@
  *--------------------------------------------------------------------------------------------*/
 
 import { Promise, TPromise } from 'vs/base/common/winjs.base';
-import { IRawGitService, IRawStatus, RawServiceState } from 'vs/workbench/parts/git/common/git';
+import { RawServiceState } from 'vs/workbench/parts/git/common/git';
 import { NoOpGitService } from 'vs/workbench/parts/git/common/noopGitService';
 import { GitService } from 'vs/workbench/parts/git/browser/gitServices';
 import { ILifecycleService } from 'vs/platform/lifecycle/common/lifecycle';
 import { IOutputService } from 'vs/workbench/parts/output/common/output';
 import { IWorkbenchEditorService } from 'vs/workbench/services/editor/common/editorService';
 import { IConfigurationService } from 'vs/platform/configuration/common/configuration';
 import { IEventService } from 'vs/platform/event/common/event';
-import { IFileService } from 'vs/platform/files/common/files';
 import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
 import { IMessageService } from 'vs/platform/message/common/message';
 import { IWorkspaceContextService } from 'vs/platform/workspace/common/workspace';
 import { Client } from 'vs/base/node/service.cp';
-import { RawGitService } from 'vs/workbench/parts/git/node/rawGitService';
+import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
 import URI from 'vs/base/common/uri';
 import { spawn, exec } from 'child_process';
 import { join } from 'path';
@@ -102,17 +101,16 @@ class DisabledRawGitService extends RawGitService {
 	}
 }
 
-export function createNativeRawGitService(basePath: string, gitPath: string, defaultEncoding: string): Promise {
+export function createNativeRawGitService(workspaceRoot: string, gitPath: string, defaultEncoding: string): Promise {
 	return findGit(gitPath).then(gitPath => {
 		const client = new Client(
 			URI.parse(require.toUrl('bootstrap')).fsPath,
 			{
 				serverName: 'Git',
 				timeout: 1000 * 60,
-				args: [gitPath, basePath, defaultEncoding, remote.process.execPath],
+				args: [gitPath, workspaceRoot, defaultEncoding, remote.process.execPath],
 				env: {
 					ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
-					PIPE_LOGGING: 'true',
 					AMD_ENTRYPOINT: 'vs/workbench/parts/git/electron-browser/gitApp'
 				}
 			}
@@ -122,12 +120,9 @@ export function createNativeRawGitService(basePath: string, gitPath: string, def
 	}, () => new UnavailableRawGitService());
 }
 
-class ElectronRawGitService implements IRawGitService {
-
-	private raw: TPromise<IRawGitService>;
-
-	constructor(basePath: string, @IConfigurationService configurationService: IConfigurationService) {
-		this.raw = configurationService.loadConfiguration().then(conf => {
+class ElectronRawGitService extends DelayedRawGitService {
+	constructor(workspaceRoot: string, @IConfigurationService configurationService: IConfigurationService) {
+		super(configurationService.loadConfiguration().then(conf => {
 			var enabled = conf.git ? conf.git.enabled : true;
 
 			if (!enabled) {
@@ -137,89 +132,12 @@ class ElectronRawGitService implements IRawGitService {
 			var gitPath = (conf.git && conf.git.path) || null;
 			var encoding = (conf.files && conf.files.encoding) || 'utf8';
 
-			return createNativeRawGitService(basePath, gitPath, encoding);
-		});
-	}
-
-	public serviceState(): TPromise<RawServiceState> {
-		return this.raw.then(raw => raw.serviceState());
-	}
-
-	public status(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.status());
-	}
-
-	public init(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.init());
-	}
-
-	public add(filesPaths?: string[]): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.add(filesPaths));
-	}
-
-	public stage(filePath: string, content: string): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.stage(filePath, content));
-	}
-
-	public branch(name: string, checkout?: boolean): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.branch(name, checkout));
-	}
-
-	public checkout(treeish?: string, filePaths?: string[]): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.checkout(treeish, filePaths));
-	}
-
-	public clean(filePaths: string[]): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.clean(filePaths));
-	}
-
-	public undo(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.undo());
-	}
-
-	public reset(treeish: string, hard?: boolean): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.reset(treeish, hard));
-	}
-
-	public revertFiles(treeish: string, filePaths?: string[]): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.revertFiles(treeish, filePaths));
-	}
-
-	public fetch(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.fetch());
-	}
-
-	public pull(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.pull());
-	}
-
-	public push(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.push());
-	}
-
-	public sync(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.sync());
-	}
-
-	public commit(message: string, amend?: boolean, stage?: boolean): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.commit(message, amend, stage));
-	}
-
-	public detectMimetypes(path: string, treeish?: string): TPromise<string[]> {
-		return this.raw.then(raw => raw.detectMimetypes(path, treeish));
-	}
-
-	public show(path: string, treeish?: string): TPromise<string> {
-		return this.raw.then(raw => raw.show(path, treeish));
-	}
-
-	public onOutput(): Promise {
-		return this.raw.then(raw => raw.onOutput());
+			return createNativeRawGitService(workspaceRoot, gitPath, encoding);
+		}));
 	}
 }
 
 export class ElectronGitService extends GitService {
-
 	constructor(
 		@IInstantiationService instantiationService: IInstantiationService,
 		@IEventService eventService: IEventService,

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -4,60 +4,50 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import { TPromise } from 'vs/base/common/winjs.base';
 import { Server } from 'vs/base/node/service.cp';
 import objects = require('vs/base/common/objects');
 import uri from 'vs/base/common/uri';
+import { IRawGitService } from 'vs/workbench/parts/git/common/git';
 import gitlib = require('vs/workbench/parts/git/node/git.lib');
-import rawgitservice = require('vs/workbench/parts/git/node/rawGitService');
+import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
+import { join, dirname, normalize } from 'path';
+import { tmpdir } from 'os';
+import { realpath } from 'vs/base/node/pfs';
 
-import path = require('path');
-import fs = require('fs');
+class IPCRawGitService extends DelayedRawGitService {
 
-class NativeRawGitService extends rawgitservice.RawGitService {
-
-	constructor(gitPath: string, basePath: string, defaultEncoding: string, exePath: string) {
+	constructor(gitPath: string, workspaceRoot: string, defaultEncoding: string, exePath: string) {
 		if (!gitPath) {
-			super(null);
-			return;
-		}
-
-		var gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
-
-		var env = objects.assign(objects.assign({}, process.env), {
-			GIT_ASKPASS: path.join(gitRootPath, 'askpass.sh'),
-			VSCODE_GIT_ASKPASS_BOOTSTRAP: path.join(path.dirname(path.dirname(path.dirname(path.dirname(path.dirname(gitRootPath))))), 'bootstrap.js'),
-			VSCODE_GIT_ASKPASS_NODE: exePath,
-			VSCODE_GIT_ASKPASS_MODULE_ID: 'vs/workbench/parts/git/electron-main/askpass'
-		});
-
-		var git = new gitlib.Git({
-			gitPath: gitPath,
-			tmpPath: tmpdirSync(), // TODO@Joao os.tmpdir()???
-			defaultEncoding: defaultEncoding,
-			env: env
-		});
-
-		super(git.open(path.normalize(basePath)));
-	}
-}
-
-function tmpdirSync(): string {
-	var path: string;
-	var paths = /^win/i.test(process.platform) ? [process.env.TMP, process.env.TEMP] : ['/tmp', '/var/tmp', '/private/tmp', '/private/var/tmp'];
-
-	for (var i = 0; i < paths.length; i++) {
-		path = paths[i];
-		try {
-			if (fs.statSync(path).isDirectory()) {
-				return path;
-			}
-		} catch (e) {
-			// Ignore
+			super(TPromise.as(new RawGitService(null)));
+		} else {
+			const gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
+			const bootstrapPath = `${ uri.parse(require.toUrl('bootstrap')).fsPath }.js`;
+
+			const env = objects.assign({}, process.env, {
+				GIT_ASKPASS: join(gitRootPath, 'askpass.sh'),
+				VSCODE_GIT_ASKPASS_BOOTSTRAP: bootstrapPath,
+				VSCODE_GIT_ASKPASS_NODE: exePath,
+				VSCODE_GIT_ASKPASS_MODULE_ID: 'vs/workbench/parts/git/electron-main/askpass'
+			});
+
+			const git = new gitlib.Git({
+				gitPath: gitPath,
+				tmpPath: tmpdir(),
+				defaultEncoding: defaultEncoding,
+				env: env
+			});
+
+			const repo = git.open(normalize(workspaceRoot));
+			const promise = repo.getRoot()
+				.then(root => realpath(root))
+				.then(root => git.open(root))
+				.then(repo => new RawGitService(repo));
+
+			super(promise);
 		}
 	}
-
-	throw new Error('Temp dir not found');
 }
 
 const server = new Server();
-server.registerService('GitService', new NativeRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5]));
\ No newline at end of file
+server.registerService('GitService', new IPCRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5]));
\ No newline at end of file

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -2,29 +2,66 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
-
-import winjs = require('vs/base/common/winjs.base');
+import { Promise, TPromise } from 'vs/base/common/winjs.base';
 import extfs = require('vs/base/node/extfs');
 import { guessMimeTypes, isBinaryMime } from 'vs/base/common/mime';
+import { IDisposable, toDisposable, disposeAll } from 'vs/base/common/lifecycle';
 import objects = require('vs/base/common/objects');
 import uuid = require('vs/base/common/uuid');
 import nls = require('vs/nls');
 import strings = require('vs/base/common/strings');
 import { IRawFileStatus, IHead, ITag, IBranch, GitErrorCodes } from 'vs/workbench/parts/git/common/git';
 import { detectMimesFromStream } from 'vs/base/node/mime'
 import files = require('vs/platform/files/common/files');
-
-import cp = require('child_process');
+import { spawn, ChildProcess } from 'child_process';
 import iconv = require('iconv-lite');
 
 export interface IExecutionResult {
-	code: number;
+	exitCode: number;
 	stdout: string;
 	stderr: string;
 }
 
+function exec(child: ChildProcess, encoding = 'utf8'): TPromise<IExecutionResult> {
+	const disposables: IDisposable[] = [];
+
+	const once = (ee: EventEmitter, name: string, fn: Function) => {
+		ee.once(name, fn);
+		disposables.push(toDisposable(() => ee.removeListener(name, fn)));
+	};
+
+	const on = (ee: EventEmitter, name: string, fn: Function) => {
+		ee.on(name, fn);
+		disposables.push(toDisposable(() => ee.removeListener(name, fn)));
+	};
+
+	return TPromise.join<any>([
+		new TPromise<number>((c, e) => {
+			once(child, 'error', e);
+			once(child, 'exit', c);
+		}),
+		new TPromise<string>(c => {
+			let buffers: Buffer[] = [];
+			on(child.stdout, 'data', b => buffers.push(b));
+			once(child.stdout, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+		}),
+		new TPromise<string>(c => {
+			let buffers: Buffer[] = [];
+			on(child.stderr, 'data', b => buffers.push(b));
+			once(child.stderr, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+		})
+	]).then(values => {
+		disposeAll(disposables);
+
+		return {
+			exitCode: values[0],
+			stdout: values[1],
+			stderr: values[2]
+		};
+	});
+}
+
 export interface IGitErrorData {
 	error?: Error;
 	message?: string;
@@ -62,7 +99,7 @@ export class GitError {
 	}
 
 	public toString(): string {
-		var result = this.message + ' ' + JSON.stringify({
+		let result = this.message + ' ' + JSON.stringify({
 			exitCode: this.exitCode,
 			gitErrorCode: this.gitErrorCode,
 			gitCommand: this.gitCommand,
@@ -97,19 +134,19 @@ export class Git {
 		this.gitPath = options.gitPath;
 		this.tmpPath = options.tmpPath;
 
-		var encoding = options.defaultEncoding || 'utf8';
+		const encoding = options.defaultEncoding || 'utf8';
 		this.defaultEncoding = iconv.encodingExists(encoding) ? encoding : 'utf8';
 
 		this.env = options.env || {};
 		this.outputListeners = [];
 	}
 
-	public run(cwd: string, args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
+	public run(cwd: string, args: string[], options: any = {}): TPromise<IExecutionResult> {
 		options = objects.assign({ cwd: cwd }, options || {});
 		return this.exec(args, options);
 	}
 
-	public stream(cwd: string, args: string[], options: any = {}): cp.ChildProcess {
+	public stream(cwd: string, args: string[], options: any = {}): ChildProcess {
 		options = objects.assign({ cwd: cwd }, options || {});
 		return this.spawn(args, options);
 	}
@@ -118,9 +155,9 @@ export class Git {
 		return new Repository(this, repository, this.defaultEncoding, env);
 	}
 
-	public clone(repository: string, repoURL: string): winjs.TPromise<boolean> {
+	public clone(repository: string, repoURL: string): TPromise<boolean> {
 		return this.exec(['clone', repoURL, repository]).then(() => true, (err) => {
-			return new winjs.TPromise<boolean>((c, e) => {
+			return new TPromise<boolean>((c, e) => {
 
 				// If there's any error, git will still leave the folder in the FS,
 				// so we need to remove it.
@@ -132,77 +169,52 @@ export class Git {
 		});
 	}
 
-	public config(name: string, value: string): winjs.Promise {
+	public config(name: string, value: string): Promise {
 		return this.exec(['config', '--global', name, value]);
 	}
 
-	private exec(args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
-		var child = this.spawn(args, options);
+	private exec(args: string[], options: any = {}): TPromise<IExecutionResult> {
+		const child = this.spawn(args, options);
 
 		if (options.input) {
 			child.stdin.end(options.input, 'utf8');
 		}
 
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
-			}),
-			new winjs.TPromise<string>((c) => {
-				var buffer:string = '';
-				child.stdout.setEncoding('utf8');
-				child.stdout.on('data', (data: string) => buffer += data);
-				child.stdout.on('close', () => c(buffer));
-			}),
-			new winjs.TPromise<string>((c) => {
-				var buffer:string = '';
-				child.stderr.setEncoding('utf8');
-				child.stderr.on('data', (data: string) => buffer += data);
-				child.stderr.on('close', () => c(buffer));
-			})
-		]).then<IExecutionResult>((values) => {
-			var exitCode = <number> values[0];
-			var stdout = <string> values[1];
-			var stderr = <string> values[2];
+		return exec(child).then(result => {
+			if (result.exitCode) {
+				let gitErrorCode: string = null;
 
-			if (exitCode) {
-				var gitErrorCode: string = null;
-
-				if (/Authentication failed/.test(stderr)) {
+				if (/Authentication failed/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.AuthenticationFailed;
-				} else if (/bad config file/.test(stderr)) {
+				} else if (/bad config file/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.BadConfigFile;
-				} else if (/cannot make pipe for command substitution|cannot create standard input pipe/.test(stderr)) {
+				} else if (/cannot make pipe for command substitution|cannot create standard input pipe/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.CantCreatePipe;
-				} else if (/Repository not found/.test(stderr)) {
+				} else if (/Repository not found/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.RepositoryNotFound;
-				} else if (/unable to access/.test(stderr)) {
+				} else if (/unable to access/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.CantAccessRemote;
 				}
 
 				if (options.log !== false) {
-					this.log(stderr);
+					this.log(result.stderr);
 				}
 
-				return winjs.TPromise.wrapError<IExecutionResult>(new GitError({
+				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Failed to execute git',
-					stdout: stdout,
-					stderr: stderr,
-					exitCode: exitCode,
-					gitErrorCode: gitErrorCode,
+					stdout: result.stdout,
+					stderr: result.stderr,
+					exitCode: result.exitCode,
+					gitErrorCode,
 					gitCommand: args[0]
 				}));
 			}
 
-			return winjs.TPromise.as<IExecutionResult>({
-				code: values[0],
-				stdout: values[1],
-				stderr: values[2]
-			});
+			return result;
 		});
 	}
 
-	public spawn(args: string[], options: any = {}): cp.ChildProcess {
+	public spawn(args: string[], options: any = {}): ChildProcess {
 		if (!this.gitPath) {
 			throw new Error('git could not be found in the system.');
 		}
@@ -227,7 +239,7 @@ export class Git {
 			this.log(strings.format('git {0}\n', args.join(' ')));
 		}
 
-		return cp.spawn(this.gitPath, args, options);
+		return spawn(this.gitPath, args, options);
 	}
 
 	public onOutput(listener: (output: string) => void): () => void {
@@ -258,33 +270,33 @@ export class Repository {
 		return this.repository;
 	}
 
-	public run(args: string[], options: any = {}): winjs.TPromise<IExecutionResult> {
+	public run(args: string[], options: any = {}): TPromise<IExecutionResult> {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.run(this.repository, args, options);
 	}
 
-	public stream(args: string[], options: any = {}): cp.ChildProcess {
+	public stream(args: string[], options: any = {}): ChildProcess {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.stream(this.repository, args, options);
 	}
 
-	public spawn(args: string[], options: any = {}): cp.ChildProcess {
+	public spawn(args: string[], options: any = {}): ChildProcess {
 		options.env = objects.assign({}, options.env || {});
 		options.env = objects.assign(options.env, this.env);
 
 		return this.git.spawn(args, options);
 	}
 
-	public init(): winjs.Promise {
+	public init(): Promise {
 		return this.run(['init']);
 	}
 
-	public config(scope: string, key:string, value:any, options:any): winjs.TPromise<string> {
-		var args = ['config'];
+	public config(scope: string, key:string, value:any, options:any): TPromise<string> {
+		const args = ['config'];
 
 		if (scope) {
 			args.push('--' + scope);
@@ -299,14 +311,14 @@ export class Repository {
 		return this.run(args, options).then((result) => result.stdout);
 	}
 
-	public show(object: string): cp.ChildProcess {
+	public show(object: string): ChildProcess {
 		return this.stream(['show', object]);
 	}
 
-	public buffer(object: string): winjs.TPromise<string> {
-		var child = this.show(object);
+	public buffer(object: string): TPromise<string> {
+		const child = this.show(object);
 
-		return new winjs.Promise((c, e) => {
+		return new Promise((c, e) => {
 			detectMimesFromStream(child.stdout, null, (err, result) => {
 				if (err) {
 					e(err);
@@ -322,40 +334,23 @@ export class Repository {
 		});
 	}
 
-	private doBuffer(object: string): winjs.TPromise<string> {
-		var child = this.show(object);
-
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
-			}),
-			new winjs.TPromise<string>((c) => {
-				var buffers: NodeBuffer[] = [];
-				child.stdout.on('data', (b: NodeBuffer) => buffers.push(b));
-				child.stdout.on('close', () => c(iconv.decode(Buffer.concat(buffers), this.defaultEncoding)));
-			}),
-			new winjs.Promise((c) => {
-				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.on('close', () => c(null));
-			})
-		]).then((values) => {
-			var exitCode = <number> values[0];
-			var result = <string> values[1];
+	private doBuffer(object: string): TPromise<string> {
+		const child = this.show(object);
 
+		return exec(child, this.defaultEncoding).then(({ exitCode, stdout }) => {
 			if (exitCode) {
-				return winjs.TPromise.wrapError<string>(new GitError({
+				return TPromise.wrapError<string>(new GitError({
 					message: 'Could not buffer object.',
-					exitCode: exitCode
+					exitCode
 				}));
 			}
 
-			return winjs.TPromise.as<string>(result);
+			return TPromise.as<string>(stdout);
 		});
 	}
 
-	public add(paths: string[]): winjs.Promise {
-		var args = ['add', '-A', '--'];
+	public add(paths: string[]): Promise {
+		const args = ['add', '-A', '--'];
 
 		if (paths && paths.length) {
 			args.push.apply(args, paths);
@@ -366,42 +361,24 @@ export class Repository {
 		return this.run(args);
 	}
 
-	public stage(path: string, data: string): winjs.Promise {
-		var child = this.stream(['hash-object', '--stdin', '-w'], { stdio: [null, null, null] });
+	public stage(path: string, data: string): Promise {
+		const child = this.stream(['hash-object', '--stdin', '-w'], { stdio: [null, null, null] });
 		child.stdin.end(data, 'utf8');
 
-		return winjs.TPromise.join<any>([
-			new winjs.TPromise<number>((c, e) => {
-				child.on('error', e);
-				child.on('exit', c);
-			}),
-			new winjs.TPromise<string>((c) => {
-				var id = '';
-				child.stdout.setEncoding('utf8');
-				child.stdout.on('data', (data:string) => id += data);
-				child.stdout.on('close', () => c(id));
-			}),
-			new winjs.Promise((c) => {
-				child.stderr.on('data', (data:string) => { /* Read to free buffer but do not handle */ });
-				child.stderr.on('close', () => c(null));
-			})
-		]).then<IExecutionResult>((values) => {
-			var exitCode = <number> values[0];
-			var id = <string> values[1];
-
+		return exec(child).then(({ exitCode, stdout }) => {
 			if (exitCode) {
-				return winjs.TPromise.wrapError<IExecutionResult>(new GitError({
+				return TPromise.wrapError<IExecutionResult>(new GitError({
 					message: 'Could not hash object.',
 					exitCode: exitCode
 				}));
 			}
 
-			return this.run(['update-index', '--cacheinfo', '100644', id, path]);
+			return this.run(['update-index', '--cacheinfo', '100644', stdout, path]);
 		});
 	}
 
-	public checkout(treeish: string, paths: string[]): winjs.Promise {
-		var args = [ 'checkout', '-q' ];
+	public checkout(treeish: string, paths: string[]): Promise {
+		const args = [ 'checkout', '-q' ];
 
 		if (treeish) {
 			args.push(treeish);
@@ -417,12 +394,12 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.DirtyWorkTree;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public commit(message: string, all: boolean, amend: boolean): winjs.Promise {
-		var args = ['commit', '--quiet', '--allow-empty-message', '--file', '-'];
+	public commit(message: string, all: boolean, amend: boolean): Promise {
+		const args = ['commit', '--quiet', '--allow-empty-message', '--file', '-'];
 
 		if (all) {
 			args.push('--all');
@@ -435,47 +412,47 @@ export class Repository {
 		return this.run(args, { input: message || '' }).then(null, (commitErr: GitError) => {
 			if (/not possible because you have unmerged files/.test(commitErr.stderr)) {
 				commitErr.gitErrorCode = GitErrorCodes.UnmergedChanges;
-				return winjs.Promise.wrapError(commitErr);
+				return Promise.wrapError(commitErr);
 			}
 
 			return this.run(['config', '--get-all', 'user.name']).then(null, (err: GitError) => {
 				err.gitErrorCode = GitErrorCodes.NoUserNameConfigured;
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			}).then(() => {
 				return this.run(['config', '--get-all', 'user.email']).then(null, (err: GitError) => {
 					err.gitErrorCode = GitErrorCodes.NoUserEmailConfigured;
-					return winjs.Promise.wrapError(err);
+					return Promise.wrapError(err);
 				}).then(() => {
-					return winjs.Promise.wrapError(commitErr);
+					return Promise.wrapError(commitErr);
 				});
 			});
 		});
 	}
 
-	public branch(name: string, checkout: boolean): winjs.Promise {
-		var args = checkout ? ['checkout', '-q', '-b', name] : [ 'branch', '-q', name ];
+	public branch(name: string, checkout: boolean): Promise {
+		const args = checkout ? ['checkout', '-q', '-b', name] : [ 'branch', '-q', name ];
 		return this.run(args);
 	}
 
-	public clean(paths: string[]): winjs.Promise {
-		var args = [ 'clean', '-f', '-q', '--' ].concat(paths);
+	public clean(paths: string[]): Promise {
+		const args = [ 'clean', '-f', '-q', '--' ].concat(paths);
 		return this.run(args);
 	}
 
-	public undo(): winjs.Promise {
+	public undo(): Promise {
 		return this.run([ 'clean', '-fd' ]).then(() => {
 			return this.run([ 'checkout', '--', '.' ]).then(null, (err: GitError) => {
 				if (/did not match any file\(s\) known to git\./.test(err.stderr)) {
-					return winjs.Promise.as(null);
+					return Promise.as(null);
 				}
 
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			});
 		});
 	}
 
-	public reset(treeish: string, hard: boolean = false): winjs.Promise {
-		var args = ['reset'];
+	public reset(treeish: string, hard: boolean = false): Promise {
+		const args = ['reset'];
 
 		if (hard) {
 			args.push('--hard');
@@ -486,9 +463,9 @@ export class Repository {
 		return this.run(args);
 	}
 
-	public revertFiles(treeish: string, paths: string[]): winjs.Promise {
+	public revertFiles(treeish: string, paths: string[]): Promise {
 		return this.run([ 'branch' ]).then((result) => {
-			var args: string[];
+			let args: string[];
 
 			// In case there are no branches, we must use rm --cached
 			if (!result.stdout) {
@@ -507,15 +484,15 @@ export class Repository {
 				// In case there are merge conflicts to be resolved, git reset will output
 				// some "needs merge" data. We try to get around that.
 				if (/([^:]+: needs merge\n)+/m.test(err.stdout)) {
-					return winjs.Promise.as(null);
+					return Promise.as(null);
 				}
 
-				return winjs.Promise.wrapError(err);
+				return Promise.wrapError(err);
 			});
 		});
 	}
 
-	public fetch(): winjs.Promise {
+	public fetch(): Promise {
 		return this.run(['fetch']).then(null, (err: GitError) => {
 			if (/No remote repository specified\./.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.NoRemoteRepositorySpecified;
@@ -525,11 +502,11 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.RemoteConnectionError;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public pull(): winjs.Promise {
+	public pull(): Promise {
 		return this.run(['pull']).then(null, (err: GitError) => {
 			if (/^CONFLICT \([^)]+\): \b/m.test(err.stdout)) {
 				err.gitErrorCode = GitErrorCodes.Conflict;
@@ -541,39 +518,40 @@ export class Repository {
 				err.gitErrorCode = GitErrorCodes.DirtyWorkTree;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public push(): winjs.Promise {
+	public push(): Promise {
 		return this.run(['push']).then(null, (err: GitError) => {
 			if (/^error: failed to push some refs to\b/m.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.PushRejected;
 			} else if (/Could not read from remote repository/.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.RemoteConnectionError;
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		});
 	}
 
-	public sync(): winjs.Promise {
+	public sync(): Promise {
 		return this.pull().then(() => this.push());
 	}
 
-	public getRoot(): winjs.TPromise<string> {
+	public getRoot(): TPromise<string> {
 		return this.run(['rev-parse', '--show-toplevel'], { log: false }).then(result => result.stdout.trim());
 	}
 
-	public getStatus(): winjs.TPromise<IRawFileStatus[]> {
+	public getStatus(): TPromise<IRawFileStatus[]> {
 		return this.run(['status', '-z', '-u'], { log: false }).then((executionResult) => {
-			var status = executionResult.stdout;
-			var result:IRawFileStatus[] = [];
-			var current:IRawFileStatus;
-			var i = 0;
+			const status = executionResult.stdout;
+			const result:IRawFileStatus[] = [];
+			let current:IRawFileStatus;
+			let i = 0;
 
 			function readName():string {
-				var start = i, c:string;
+				const start = i;
+				let c:string;
 				while ((c = status.charAt(i)) !== '\u0000') { i++; }
 				return status.substring(start, i++);
 			}
@@ -603,29 +581,29 @@ export class Repository {
 				result.push(current);
 			}
 
-			return winjs.TPromise.as<IRawFileStatus[]>(result);
+			return TPromise.as<IRawFileStatus[]>(result);
 		});
 	}
 
-	public getHEAD(): winjs.TPromise<IHead> {
+	public getHEAD(): TPromise<IHead> {
 		return this.run(['symbolic-ref', '--short', 'HEAD'], { log: false }).then((result) => {
 			if (!result.stdout) {
-				return winjs.TPromise.wrapError<IHead>(new Error('Not in a branch'));
+				return TPromise.wrapError<IHead>(new Error('Not in a branch'));
 			}
 
-			return winjs.TPromise.as<IHead>({ name: result.stdout.trim() });
+			return TPromise.as<IHead>({ name: result.stdout.trim() });
 		}, (err) => {
 			return this.run(['rev-parse', 'HEAD'], { log: false }).then((result) => {
 				if (!result.stdout) {
-					return winjs.TPromise.wrapError<IHead>(new Error('Error parsing HEAD'));
+					return TPromise.wrapError<IHead>(new Error('Error parsing HEAD'));
 				}
 
-				return winjs.TPromise.as<IHead>({ commit: result.stdout.trim() });
+				return TPromise.as<IHead>({ commit: result.stdout.trim() });
 			});
 		});
 	}
 
-	public getHeads(): winjs.TPromise<ITag[]> {
+	public getHeads(): TPromise<ITag[]> {
 		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/heads/'], { log: false }).then((result) => {
 			return result.stdout.trim().split('\n')
 				.filter(b => !!b)
@@ -634,7 +612,7 @@ export class Repository {
 		});
 	}
 
-	public getTags(): winjs.TPromise<IHead[]> {
+	public getTags(): TPromise<IHead[]> {
 		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/tags/'], { log: false }).then((result) => {
 			return result.stdout.trim().split('\n')
 				.filter(b => !!b)
@@ -643,24 +621,24 @@ export class Repository {
 		});
 	}
 
-	public getBranch(branch: string): winjs.TPromise<IBranch> {
+	public getBranch(branch: string): TPromise<IBranch> {
 		if (branch === 'HEAD') {
 			return this.getHEAD();
 		}
 
 		return this.run(['rev-parse', branch], { log: false }).then((result) => {
 			if (!result.stdout) {
-				return winjs.TPromise.wrapError<IBranch>(new Error('No such branch'));
+				return TPromise.wrapError<IBranch>(new Error('No such branch'));
 			}
 
-			var commit = result.stdout.trim();
+			const commit = result.stdout.trim();
 
 			return this.run(['rev-parse', '--symbolic-full-name', '--abbrev-ref', branch + '@{u}'], { log: false }).then((result: IExecutionResult) => {
-				var upstream = result.stdout.trim();
+				const upstream = result.stdout.trim();
 
 				return this.run(['rev-list', '--left-right', branch + '...' + upstream], { log: false }).then((result) => {
-					var ahead = 0, behind = 0;
-					var i = 0;
+					let ahead = 0, behind = 0;
+					let i = 0;
 
 					while (i < result.stdout.length) {
 						switch (result.stdout.charAt(i)) {

author:joaomoreno
date:2015-11-27T14:38:17Z
title:Merge pull request #718 from joaomoreno/scoped-git

Scoped git services

fixes #57
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -5,7 +5,7 @@
 'use strict';
 
 import path = require('path');
-import winjs = require('vs/base/common/winjs.base');
+import { TPromise, Promise } from 'vs/base/common/winjs.base';
 import mime = require('vs/base/node/mime');
 import pfs = require('vs/base/node/pfs');
 import { Repository, GitError } from 'vs/workbench/parts/git/node/git.lib';
@@ -23,23 +23,25 @@ function pathsAreEqual(p1: string, p2: string): boolean {
 export class RawGitService implements IRawGitService {
 
 	private repo: Repository;
-	private repoRealRootPath: winjs.TPromise<string>;
+	private _repositoryRoot: TPromise<string>;
 
 	constructor(repo: Repository) {
 		this.repo = repo;
-		this.repoRealRootPath = null;
 	}
 
-	public serviceState(): winjs.TPromise<RawServiceState> {
-		return winjs.TPromise.as<RawServiceState>(this.repo
+	private getRepositoryRoot(): TPromise<string> {
+		return this._repositoryRoot || (this._repositoryRoot = pfs.realpath(this.repo.path));
+	}
+
+	public serviceState(): TPromise<RawServiceState> {
+		return TPromise.as<RawServiceState>(this.repo
 			? RawServiceState.OK
 			: RawServiceState.GitNotFound
 		);
 	}
 
-	public status(): winjs.TPromise<IRawStatus> {
-		return this.checkRoot()
-			.then(() => this.repo.getStatus())
+	public status(): TPromise<IRawStatus> {
+		return this.repo.getStatus()
 			.then(status => this.repo.getHEAD()
 				.then(HEAD => {
 					if (HEAD.name) {
@@ -48,85 +50,86 @@ export class RawGitService implements IRawGitService {
 						return HEAD;
 					}
 				}, (): IHead => null)
-				.then(HEAD => winjs.Promise.join([this.repo.getHeads(), this.repo.getTags()]).then(r => {
+				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getHeads(), this.repo.getTags()]).then(r => {
 					return {
+						repositoryRoot: r[0],
 						status: status,
 						HEAD: HEAD,
-						heads: r[0],
-						tags: r[1]
+						heads: r[1],
+						tags: r[2]
 					};
 				})))
 			.then(null, (err) => {
 				if (err.gitErrorCode === GitErrorCodes.BadConfigFile) {
-					return winjs.Promise.wrapError(err);
+					return Promise.wrapError(err);
 				} else if (err.gitErrorCode === GitErrorCodes.NotAtRepositoryRoot) {
-					return winjs.Promise.wrapError(err);
+					return Promise.wrapError(err);
 				}
 
 				return null;
 			});
 	}
 
-	public init(): winjs.TPromise<IRawStatus> {
+	public init(): TPromise<IRawStatus> {
 		return this.repo.init().then(() => this.status());
 	}
 
-	public add(filePaths?: string[]): winjs.TPromise<IRawStatus> {
+	public add(filePaths?: string[]): TPromise<IRawStatus> {
 		return this.repo.add(filePaths).then(() => this.status());
 	}
 
-	public stage(filePath: string, content: string): winjs.TPromise<IRawStatus> {
+	public stage(filePath: string, content: string): TPromise<IRawStatus> {
 		return this.repo.stage(filePath, content).then(() => this.status());
 	}
 
-	public branch(name: string, checkout?: boolean): winjs.TPromise<IRawStatus> {
+	public branch(name: string, checkout?: boolean): TPromise<IRawStatus> {
 		return this.repo.branch(name, checkout).then(() => this.status());
 	}
 
-	public checkout(treeish?: string, filePaths?: string[]): winjs.TPromise<IRawStatus> {
+	public checkout(treeish?: string, filePaths?: string[]): TPromise<IRawStatus> {
 		return this.repo.checkout(treeish, filePaths).then(() => this.status());
 	}
 
-	public clean(filePaths: string[]): winjs.TPromise<IRawStatus> {
+	public clean(filePaths: string[]): TPromise<IRawStatus> {
 		return this.repo.clean(filePaths).then(() => this.status());
 	}
 
-	public undo(): winjs.TPromise<IRawStatus> {
+	public undo(): TPromise<IRawStatus> {
 		return this.repo.undo().then(() => this.status());
 	}
 
-	public reset(treeish: string, hard?: boolean): winjs.TPromise<IRawStatus> {
+	public reset(treeish: string, hard?: boolean): TPromise<IRawStatus> {
 		return this.repo.reset(treeish, hard).then(() => this.status());
 	}
 
-	public revertFiles(treeish: string, filePaths?: string[]): winjs.TPromise<IRawStatus> {
+	public revertFiles(treeish: string, filePaths?: string[]): TPromise<IRawStatus> {
 		return this.repo.revertFiles(treeish, filePaths).then(() => this.status());
 	}
 
-	public fetch(): winjs.TPromise<IRawStatus> {
+	public fetch(): TPromise<IRawStatus> {
 		return this.repo.fetch().then(null, (err) => {
 			if (err.gitErrorCode === GitErrorCodes.NoRemoteRepositorySpecified) {
-				return winjs.Promise.as(null);
+				return Promise.as(null);
 			}
 
-			return winjs.Promise.wrapError(err);
+			return Promise.wrapError(err);
 		}).then(() => this.status());
 	}
 
-	public pull(): winjs.TPromise<IRawStatus> {
+	public pull(): TPromise<IRawStatus> {
 		return this.repo.pull().then(() => this.status());
 	}
 
-	public push(): winjs.TPromise<IRawStatus> {
+	public push(): TPromise<IRawStatus> {
 		return this.repo.push().then(() => this.status());
 	}
 
-	public sync(): winjs.TPromise<IRawStatus> {
+	public sync(): TPromise<IRawStatus> {
 		return this.repo.sync().then(() => this.status());
 	}
 
-	public commit(message:string, amend?: boolean, stage?: boolean): winjs.TPromise<IRawStatus> {
-		var promise: winjs.Promise = winjs.Promise.as(null);
+	public commit(message:string, amend?: boolean, stage?: boolean): TPromise<IRawStatus> {
+		var promise: Promise = Promise.as(null);
 
 		if (stage) {
 			promise = this.repo.add(null);
@@ -137,10 +140,10 @@ export class RawGitService implements IRawGitService {
 			.then(() => this.status());
 	}
 
-	public detectMimetypes(filePath: string, treeish?: string): winjs.TPromise<string[]> {
+	public detectMimetypes(filePath: string, treeish?: string): TPromise<string[]> {
 		return pfs.exists(path.join(this.repo.path, filePath)).then((exists) => {
 			if (exists) {
-				return new winjs.TPromise<string[]>((c, e) => {
+				return new TPromise<string[]>((c, e) => {
 					mime.detectMimesFromFile(path.join(this.repo.path, filePath), (err, result) => {
 						if (err) { e(err); }
 						else { c(result.mimes); }
@@ -150,7 +153,7 @@ export class RawGitService implements IRawGitService {
 
 			var child = this.repo.show(treeish + ':' + filePath);
 
-			return new winjs.TPromise<string[]>((c, e) => {
+			return new TPromise<string[]>((c, e) => {
 				mime.detectMimesFromStream(child.stdout, filePath, (err, result) => {
 					if (err) { e(err); }
 					else { c(result.mimes); }
@@ -160,42 +163,103 @@ export class RawGitService implements IRawGitService {
 	}
 
 	// careful, this buffers the whole object into memory
-	public show(filePath: string, treeish?: string): winjs.TPromise<string> {
+	public show(filePath: string, treeish?: string): TPromise<string> {
 		treeish = treeish === '~' ? '' : treeish;
 		return this.repo.buffer(treeish + ':' + filePath).then(null, e => {
 			if (e instanceof GitError) {
 				return ''; // mostly untracked files end up in a git error
 			}
 
-			return winjs.TPromise.wrapError<string>(e);
+			return TPromise.wrapError<string>(e);
 		});
 	}
 
-	public onOutput(): winjs.Promise {
+	public onOutput(): Promise {
 		var cancel: () => void;
 
-		return new winjs.Promise((c, e, p) => {
+		return new Promise((c, e, p) => {
 			cancel = this.repo.onOutput(p);
 		}, () => cancel());
 	}
+}
 
-	private checkRoot(): winjs.Promise {
-		if (!this.repoRealRootPath) {
-			this.repoRealRootPath = pfs.realpath(this.repo.path);
-		}
+export class DelayedRawGitService implements IRawGitService {
 
-		return this.repo.getRoot().then(root => {
-			return winjs.Promise.join([
-				this.repoRealRootPath,
-				pfs.realpath(root)
-			]).then(paths => {
-				if (!pathsAreEqual(paths[0], paths[1])) {
-					return winjs.Promise.wrapError(new GitError({
-						message: 'Not at the repository root',
-						gitErrorCode: GitErrorCodes.NotAtRepositoryRoot
-					}));
-				}
-			});
-		});
+	constructor(private raw: TPromise<IRawGitService>) { }
+
+	public serviceState(): TPromise<RawServiceState> {
+		return this.raw.then(raw => raw.serviceState());
 	}
-}
+
+	public status(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.status());
+	}
+
+	public init(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.init());
+	}
+
+	public add(filesPaths?: string[]): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.add(filesPaths));
+	}
+
+	public stage(filePath: string, content: string): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.stage(filePath, content));
+	}
+
+	public branch(name: string, checkout?: boolean): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.branch(name, checkout));
+	}
+
+	public checkout(treeish?: string, filePaths?: string[]): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.checkout(treeish, filePaths));
+	}
+
+	public clean(filePaths: string[]): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.clean(filePaths));
+	}
+
+	public undo(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.undo());
+	}
+
+	public reset(treeish: string, hard?: boolean): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.reset(treeish, hard));
+	}
+
+	public revertFiles(treeish: string, filePaths?: string[]): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.revertFiles(treeish, filePaths));
+	}
+
+	public fetch(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.fetch());
+	}
+
+	public pull(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.pull());
+	}
+
+	public push(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.push());
+	}
+
+	public sync(): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.sync());
+	}
+
+	public commit(message: string, amend?: boolean, stage?: boolean): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.commit(message, amend, stage));
+	}
+
+	public detectMimetypes(path: string, treeish?: string): TPromise<string[]> {
+		return this.raw.then(raw => raw.detectMimetypes(path, treeish));
+	}
+
+	public show(path: string, treeish?: string): TPromise<string> {
+		return this.raw.then(raw => raw.show(path, treeish));
+	}
+
+	public onOutput(): Promise {
+		return this.raw.then(raw => raw.onOutput());
+	}
+}
\ No newline at end of file

author:joaomoreno
date:2015-11-27T14:06:44Z
title:fix git services onEditorInputChanged
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -12,6 +12,7 @@ import Lifecycle = require('vs/base/common/lifecycle');
 import EventEmitter = require('vs/base/common/eventEmitter');
 import Strings = require('vs/base/common/strings');
 import Errors = require('vs/base/common/errors');
+import * as paths from 'vs/base/common/paths';
 import WinJS = require('vs/base/common/winjs.base');
 import Builder = require('vs/base/browser/builder');
 import Keyboard = require('vs/base/browser/keyboardEvent');
@@ -404,19 +405,27 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 		}
 
 		if (input instanceof Files.FileEditorInput) {
-			var fileInput = <Files.FileEditorInput> input;
+			const fileInput = <Files.FileEditorInput> input;
+			const resource = fileInput.getResource();
 
-			var workspaceRelativePath = this.contextService.toWorkspaceRelativePath(fileInput.getResource());
-			if (!workspaceRelativePath) {
+			const workspaceRoot = this.contextService.getWorkspace().resource.fsPath;
+			if (!paths.isEqualOrParent(resource.fsPath, workspaceRoot)) {
 				return null; // out of workspace not yet supported
 			}
 
-			var status = this.gitService.getModel().getStatus().getWorkingTreeStatus().find(workspaceRelativePath);
+			const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+			if (!paths.isEqualOrParent(resource.fsPath, repositoryRoot)) {
+				return null; // out of repository not supported
+			}
+
+			const repositoryRelativePath = paths.normalize(paths.relative(repositoryRoot, resource.fsPath));
+
+			var status = this.gitService.getModel().getStatus().getWorkingTreeStatus().find(repositoryRelativePath);
 			if (status && (status.getStatus() === git.Status.UNTRACKED || status.getStatus() === git.Status.IGNORED)) {
 				return status;
 			}
 
-			status = this.gitService.getModel().getStatus().getMergeStatus().find(workspaceRelativePath);
+			status = this.gitService.getModel().getStatus().getMergeStatus().find(repositoryRelativePath);
 			if (status) {
 				return status;
 			}

author:joaomoreno
date:2015-11-27T11:58:56Z
title:fade out out of scope git changes
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.css
code:
@@ -60,7 +60,7 @@
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .status-group {
 	font-size: 11px;
-	font-weight: bold;	
+	font-weight: bold;
 	text-transform: uppercase;
 	cursor: default;
 }
@@ -84,6 +84,10 @@
 	color: inherit;
 }
 
+.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.out-of-workspace {
+	opacity: 0.5;
+}
+
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .status {
 	position: absolute;
 	top: 4px;
@@ -99,7 +103,7 @@
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .name {
-	margin-left: 20px;	
+	margin-left: 20px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.modified .status	{ background-color: #007ACC; }
@@ -123,7 +127,7 @@
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.both-deleted .name,
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.deleted-by-them .name,
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.deleted-by-us .name {
-	text-decoration: line-through; 
+	text-decoration: line-through;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status:not(.renamed) > .rename {
@@ -159,8 +163,8 @@
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.untracked .status,
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.ignored .status,
 .hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.conflict .status,
-.hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row.selected .file-status .status { 
-	background-color: #000; 
+.hc-black .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row.selected .file-status .status {
+	background-color: #000;
 	color: #fff;
 	border: 1px solid #6FC3DF;
 }
\ No newline at end of file

author:joaomoreno
date:2015-11-27T11:58:56Z
title:fade out out of scope git changes
filename:src/vs/workbench/parts/git/browser/views/changes/changesViewer.ts
code:
@@ -8,6 +8,7 @@ import winjs = require('vs/base/common/winjs.base');
 import nls = require('vs/nls');
 import platform = require('vs/base/common/platform');
 import errors = require('vs/base/common/errors');
+import paths = require('vs/base/common/paths');
 import severity from 'vs/base/common/severity';
 import lifecycle = require('vs/base/common/lifecycle');
 import dom = require('vs/base/browser/dom');
@@ -24,10 +25,12 @@ import actionsrenderer = require('vs/base/parts/tree/browser/actionsRenderer');
 import git = require('vs/workbench/parts/git/common/git');
 import gitmodel = require('vs/workbench/parts/git/common/gitModel');
 import gitactions = require('vs/workbench/parts/git/browser/gitActions');
-import {IContextMenuService} from 'vs/platform/contextview/browser/contextView';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IMessageService} from 'vs/platform/message/common/message';
-import {CommonKeybindings} from 'vs/base/common/keyCodes';
+import { IContextMenuService } from 'vs/platform/contextview/browser/contextView';
+import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
+import { IMessageService } from 'vs/platform/message/common/message';
+import { CommonKeybindings } from 'vs/base/common/keyCodes';
+import { IWorkspaceContextService } from 'vs/platform/workspace/common/workspace';
+import URI from 'vs/base/common/uri';
 
 import IGitService = git.IGitService
 
@@ -218,10 +221,14 @@ interface IStatusGroupTemplateData {
 
 export class Renderer implements tree.IRenderer {
 
-	private messageService: IMessageService;
-
-	constructor(private actionProvider:ActionProvider, private actionRunner: actions.IActionRunner, @IMessageService messageService: IMessageService) {
-		this.messageService = messageService;
+	constructor(
+		private actionProvider:ActionProvider,
+		private actionRunner: actions.IActionRunner,
+		@IMessageService private messageService: IMessageService,
+		@IGitService private gitService: IGitService,
+		@IWorkspaceContextService private contextService: IWorkspaceContextService
+	) {
+		// noop
 	}
 
 	public getHeight(tree:tree.ITree, element:any): number {
@@ -298,7 +305,7 @@ export class Renderer implements tree.IRenderer {
 
 	public renderElement(tree: tree.ITree, element: any, templateId: string, templateData: any): void {
 		if (/^file:/.test(templateId)) {
-			Renderer.renderFileStatus(tree, <git.IFileStatus> element, templateData);
+			this.renderFileStatus(tree, <git.IFileStatus> element, templateData);
 		} else {
 			Renderer.renderStatusGroup(<git.IStatusGroup> element, templateData);
 		}
@@ -309,30 +316,46 @@ export class Renderer implements tree.IRenderer {
 		data.count.setCount(statusGroup.all().length);
 	}
 
-	private static renderFileStatus(tree: tree.ITree, fileStatus: git.IFileStatus, data: IFileStatusTemplateData): void {
+	private renderFileStatus(tree: tree.ITree, fileStatus: git.IFileStatus, data: IFileStatusTemplateData): void {
 		data.actionBar.context = {
 			tree: tree,
 			fileStatus: fileStatus
 		};
 
-		var status = fileStatus.getStatus();
-		var renamePath = fileStatus.getRename();
-		var path = fileStatus.getPath();
-		var lastSlashIndex = path.lastIndexOf('/');
-		var name = lastSlashIndex === -1 ? path : path.substr(lastSlashIndex + 1, path.length);
-		var folder = (lastSlashIndex === -1 ? '' : path.substr(0, lastSlashIndex));
+		const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+		const workspaceRoot = this.contextService.getWorkspace().resource.fsPath;
+
+		const status = fileStatus.getStatus();
+		const renamePath = fileStatus.getRename();
+		const path = fileStatus.getPath();
+		const lastSlashIndex = path.lastIndexOf('/');
+		const name = lastSlashIndex === -1 ? path : path.substr(lastSlashIndex + 1, path.length);
+		const folder = (lastSlashIndex === -1 ? '' : path.substr(0, lastSlashIndex));
 
 		data.root.className = 'file-status ' + Renderer.statusToClass(status);
 		data.status.textContent = Renderer.statusToChar(status);
 		data.status.title = Renderer.statusToTitle(status);
 
+		const resource = URI.file(paths.normalize(paths.join(repositoryRoot, path)));
+		let isInWorkspace = paths.isEqualOrParent(resource.fsPath, workspaceRoot)
+
+		let rename = '';
+		let renameFolder = '';
+
 		if (renamePath) {
-			var renameLastSlashIndex = renamePath.lastIndexOf('/');
-			var rename = renameLastSlashIndex === -1 ? renamePath : renamePath.substr(renameLastSlashIndex + 1, renamePath.length);
-			var renameFolder = (renameLastSlashIndex === -1 ? '' : renamePath.substr(0, renameLastSlashIndex));
+			const renameLastSlashIndex = renamePath.lastIndexOf('/');
+			rename = renameLastSlashIndex === -1 ? renamePath : renamePath.substr(renameLastSlashIndex + 1, renamePath.length);
+			renameFolder = (renameLastSlashIndex === -1 ? '' : renamePath.substr(0, renameLastSlashIndex));
 
 			data.renameName.textContent = name;
 			data.renameFolder.textContent = folder;
+
+			const resource = URI.file(paths.normalize(paths.join(repositoryRoot, renamePath)));
+			isInWorkspace = paths.isEqualOrParent(resource.fsPath, workspaceRoot)
+		}
+
+		if (!isInWorkspace) {
+			data.root.className += ' out-of-workspace';
 		}
 
 		data.name.textContent = rename || name;

author:joaomoreno
date:2015-11-27T11:44:42Z
title:scoped git in dirty diff
filename:src/vs/workbench/parts/git/browser/gitWorkbenchContributions.ts
code:
@@ -9,6 +9,7 @@ import 'vs/css!./media/git.contribution';
 import nls = require('vs/nls');
 import async = require('vs/base/common/async');
 import errors = require('vs/base/common/errors');
+import paths = require('vs/base/common/paths');
 import actions = require('vs/base/common/actions');
 import lifecycle = require('vs/base/common/lifecycle');
 import Severity from 'vs/base/common/severity';
@@ -335,7 +336,19 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 		// HACK: This is the best current way of figuring out whether to draw these decorations
 		// or not. Needs context from the editor, to know whether it is a diff editor, in place editor
 		// etc.
-		var models = this.editorService.getVisibleEditors()
+
+		const repositoryRoot = this.gitService.getModel().getRepositoryRoot();
+
+		// If there is no repository root, just wait until that changes
+		if (typeof repositoryRoot !== 'string') {
+			this.gitService.addOneTimeListener(git.ServiceEvents.STATE_CHANGED, () => this.onEditorInputChange());
+
+			this.models.forEach(m => this.onModelInvisible(m));
+			this.models = [];
+			return;
+		}
+
+		const models = this.editorService.getVisibleEditors()
 
 			// map to the editor controls
 			.map(e => e.getControl())
@@ -354,12 +367,12 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 
 			// remove nulls
 			.filter(p => !!p.resource &&
-				// and ivalid resources
-				(p.resource.scheme === 'file' && !!this.contextService.isInsideWorkspace(p.resource))
+				// and invalid resources
+				(p.resource.scheme === 'file' && paths.isEqualOrParent(p.resource.fsPath, repositoryRoot))
 			)
 
 			// get paths
-			.map(p => ({ model: p.model, path: this.contextService.toWorkspaceRelativePath(p.resource) }))
+			.map(p => ({ model: p.model, path: paths.normalize(paths.relative(repositoryRoot, p.resource.fsPath)) }))
 
 			// remove nulls and inside .git files
 			.filter(p => !!p.path && p.path.indexOf('.git/') === -1);

author:joaomoreno
date:2015-11-27T11:10:22Z
title:scoped git in git actions
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -33,17 +33,17 @@ import wbar = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
 import { OpenChangeAction, SyncAction } from './gitActions';
 import Severity from 'vs/base/common/severity';
+import paths = require('vs/base/common/paths');
+import URI from 'vs/base/common/uri';
 
 function getStatus(gitService: IGitService, contextService: IWorkspaceContextService, input: WorkbenchEditorCommon.IFileEditorInput): IFileStatus {
-	var statusModel = gitService.getModel().getStatus();
+	const model = gitService.getModel();
+	const repositoryRoot = model.getRepositoryRoot();
+	const statusModel = model.getStatus();
+	const repositoryRelativePath = paths.normalize(paths.relative(repositoryRoot, input.getResource().fsPath));
 
-	var workspaceRelativePath = contextService.toWorkspaceRelativePath(input.getResource());
-	if (!workspaceRelativePath) {
-		return null; // out of workspace not yet supported
-	}
-
-	return statusModel.getWorkingTreeStatus().find(workspaceRelativePath) ||
-			statusModel.getIndexStatus().find(workspaceRelativePath);
+	return statusModel.getWorkingTreeStatus().find(repositoryRelativePath) ||
+			statusModel.getIndexStatus().find(repositoryRelativePath);
 }
 
 class OpenInDiffAction extends baseeditor.EditorInputAction {
@@ -78,6 +78,10 @@ class OpenInDiffAction extends baseeditor.EditorInputAction {
 			return false;
 		}
 
+		if (!(typeof this.gitService.getModel().getRepositoryRoot() === 'string')) {
+			return false;
+		}
+
 		var status = this.getStatus();
 
 		return status && (
@@ -164,6 +168,10 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 			return false;
 		}
 
+		if (!(typeof this.gitService.getModel().getRepositoryRoot() === 'string')) {
+			return false;
+		}
+
 		var status:IFileStatus = (<any>this.input).getFileStatus();
 		if (OpenInEditorAction.DELETED_STATES.indexOf(status.getStatus()) > -1) {
 			return false;
@@ -173,18 +181,19 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 	}
 
 	public run(event?: any): Promise {
-		var sideBySide = !!(event && (event.ctrlKey || event.metaKey));
-		var modifiedViewState = this.saveTextViewState();
-		var path = this.getPath();
+		const model = this.gitService.getModel();
+		const resource = URI.file(paths.join(model.getRepositoryRoot(), this.getRepositoryRelativePath()));
+		const sideBySide = !!(event && (event.ctrlKey || event.metaKey));
+		const modifiedViewState = this.saveTextViewState();
 
-		return this.fileService.resolveFile(this.contextService.toResource(path)).then((stat: IFileStat) => {
+		return this.fileService.resolveFile(resource).then(stat => {
 			return this.editorService.openEditor({
 				resource: stat.resource,
 				mime: stat.mime,
 				options: {
 					forceOpen: true
 				}
-			}, sideBySide).then((editor)=> {
+			}, sideBySide).then(editor => {
 				this.restoreTextViewState(modifiedViewState);
 
 				if (this.partService.isVisible(Parts.SIDEBAR_PART)) {
@@ -222,7 +231,7 @@ class OpenInEditorAction extends baseeditor.EditorInputAction {
 		return null;
 	}
 
-	private getPath():string {
+	private getRepositoryRelativePath():string {
 		var status: IFileStatus = (<any> this.input).getFileStatus();
 
 		if (status.getStatus() === Status.INDEX_RENAMED) {

author:joaomoreno
date:2015-12-01T10:11:42Z
title:fix npe in non git workspaces
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -8,7 +8,7 @@ import { TPromise } from 'vs/base/common/winjs.base';
 import { Server } from 'vs/base/node/service.cp';
 import objects = require('vs/base/common/objects');
 import uri from 'vs/base/common/uri';
-import { IRawGitService } from 'vs/workbench/parts/git/common/git';
+import { IRawGitService, GitErrorCodes } from 'vs/workbench/parts/git/common/git';
 import gitlib = require('vs/workbench/parts/git/node/git.lib');
 import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
 import { join, dirname, normalize } from 'path';
@@ -23,6 +23,7 @@ class IPCRawGitService extends DelayedRawGitService {
 		} else {
 			const gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
 			const bootstrapPath = `${ uri.parse(require.toUrl('bootstrap')).fsPath }.js`;
+			workspaceRoot = normalize(workspaceRoot);
 
 			const env = objects.assign({}, process.env, {
 				GIT_ASKPASS: join(gitRootPath, 'askpass.sh'),
@@ -38,8 +39,15 @@ class IPCRawGitService extends DelayedRawGitService {
 				env: env
 			});
 
-			const repo = git.open(normalize(workspaceRoot));
+			const repo = git.open(workspaceRoot);
 			const promise = repo.getRoot()
+				.then<string>(null, (err: gitlib.GitError) => {
+					if (err instanceof gitlib.GitError && err.gitErrorCode === GitErrorCodes.NotAGitRepository) {
+						return workspaceRoot;
+					}
+
+					return TPromise.wrapError(err);
+				})
 				.then(root => realpath(root))
 				.then(root => git.open(root))
 				.then(repo => new RawGitService(repo));

author:joaomoreno
date:2015-12-01T10:11:42Z
title:fix npe in non git workspaces
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -186,6 +186,8 @@ export class Git {
 
 				if (/Authentication failed/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.AuthenticationFailed;
+				} else if (/Not a git repository/.test(result.stderr)) {
+					gitErrorCode = GitErrorCodes.NotAGitRepository;
 				} else if (/bad config file/.test(result.stderr)) {
 					gitErrorCode = GitErrorCodes.BadConfigFile;
 				} else if (/cannot make pipe for command substitution|cannot create standard input pipe/.test(result.stderr)) {
@@ -496,8 +498,6 @@ export class Repository {
 		return this.run(['fetch']).then(null, (err: GitError) => {
 			if (/No remote repository specified\./.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.NoRemoteRepositorySpecified;
-			} else if (/Not a git repository/.test(err.stderr)) {
-				err.gitErrorCode = GitErrorCodes.NotAGitRepository;
 			} else if (/Could not read from remote repository/.test(err.stderr)) {
 				err.gitErrorCode = GitErrorCodes.RemoteConnectionError;
 			}

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -819,9 +819,14 @@ export class SmartCommitAction extends BaseCommitAction {
 export class PullAction extends GitAction {
 
 	static ID = 'workbench.action.pull';
+	static LABEL = nls.localize('pull', "Pull");
 
-	constructor(@IGitService gitService: IGitService) {
-		super(PullAction.ID, nls.localize('pull', "Pull"), 'git-action pull', gitService);
+	constructor(
+		id = PullAction.ID,
+		label = PullAction.LABEL,
+		@IGitService gitService: IGitService
+	) {
+		super(id, label, 'git-action pull', gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -844,7 +849,11 @@ export class PullAction extends GitAction {
 	}
 
 	public run(context?: any):Promise {
-		return this.gitService.pull().then(null, (err) => {
+		return this.pull();
+	}
+
+	protected pull(rebase = false): Promise {
+		return this.gitService.pull(rebase).then(null, (err) => {
 			if (err.gitErrorCode === GitErrorCodes.DirtyWorkTree) {
 				return Promise.wrapError(errors.create(nls.localize('dirtyTreePull', "Can't pull. Please commit or stage your work first."), { severity: Severity.Warning }));
 			} else if (err.gitErrorCode === GitErrorCodes.AuthenticationFailed) {
@@ -856,6 +865,20 @@ export class PullAction extends GitAction {
 	}
 }
 
+export class PullWithRebaseAction extends PullAction {
+
+	static ID = 'workbench.action.pull.rebase';
+	static LABEL = nls.localize('pullWithRebase', "Pull (Rebase)");
+
+	constructor(@IGitService gitService: IGitService) {
+		super(PullWithRebaseAction.ID, PullWithRebaseAction.LABEL, gitService);
+	}
+
+	public run(context?: any):Promise {
+		return this.pull(true);
+	}
+}
+
 export class PushAction extends GitAction {
 
 	static ID = 'workbench.action.push';

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -553,8 +553,8 @@ export class GitService extends ee.EventEmitter
 		return this.run(git.ServiceOperations.BACKGROUND_FETCH, () => this.raw.fetch());
 	}
 
-	public pull(): winjs.Promise {
-		return this.run(git.ServiceOperations.PULL, () => this.raw.pull());
+	public pull(rebase?: boolean): winjs.Promise {
+		return this.run(git.ServiceOperations.PULL, () => this.raw.pull(rebase));
 	}
 
 	public push(): winjs.Promise {

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -248,7 +248,8 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 		if (!this.secondaryActions) {
 			this.secondaryActions = [
 				this.instantiationService.createInstance(GitActions.SyncAction, GitActions.SyncAction.ID, GitActions.SyncAction.LABEL),
-				this.instantiationService.createInstance(GitActions.PullAction),
+				this.instantiationService.createInstance(GitActions.PullAction, GitActions.PullAction.ID, GitActions.PullAction.LABEL),
+				this.instantiationService.createInstance(GitActions.PullWithRebaseAction),
 				this.instantiationService.createInstance(GitActions.PushAction),
 				new ActionBar.Separator(),
 				this.instantiationService.createInstance(GitActions.CommitAction, this),

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -259,7 +259,7 @@ export interface IRawGitService {
 	reset(treeish:string, hard?: boolean): WinJS.TPromise<IRawStatus>;
 	revertFiles(treeish:string, filePaths?: string[]): WinJS.TPromise<IRawStatus>;
 	fetch(): WinJS.TPromise<IRawStatus>;
-	pull(): WinJS.TPromise<IRawStatus>;
+	pull(rebase?: boolean): WinJS.TPromise<IRawStatus>;
 	push(): WinJS.TPromise<IRawStatus>;
 	sync(): WinJS.TPromise<IRawStatus>;
 	commit(message:string, amend?: boolean, stage?: boolean): WinJS.TPromise<IRawStatus>;
@@ -285,7 +285,7 @@ export interface IGitService extends EventEmitter.IEventEmitter {
 	reset(treeish:string, hard?: boolean): WinJS.TPromise<IModel>;
 	revertFiles(treeish:string, files?: IFileStatus[]): WinJS.TPromise<IModel>;
 	fetch(): WinJS.TPromise<IModel>;
-	pull(): WinJS.TPromise<IModel>;
+	pull(rebase?: boolean): WinJS.TPromise<IModel>;
 	push(): WinJS.TPromise<IModel>;
 	sync(): WinJS.TPromise<IModel>;
 	commit(message:string, amend?: boolean, stage?: boolean): WinJS.TPromise<IModel>;

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -65,7 +65,7 @@ export class NoOpGitService implements git.IRawGitService {
 		return winjs.Promise.as(NoOpGitService.STATUS);
 	}
 
-	public pull(): winjs.TPromise<git.IRawStatus> {
+	public pull(rebase?: boolean): winjs.TPromise<git.IRawStatus> {
 		return winjs.Promise.as(NoOpGitService.STATUS);
 	}
 

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -506,8 +506,11 @@ export class Repository {
 		});
 	}
 
-	public pull(): Promise {
-		return this.run(['pull']).then(null, (err: GitError) => {
+	public pull(rebase?: boolean): Promise {
+		const args = ['pull'];
+		rebase && args.push('-r');
+
+		return this.run(args).then(null, (err: GitError) => {
 			if (/^CONFLICT \([^)]+\): \b/m.test(err.stdout)) {
 				err.gitErrorCode = GitErrorCodes.Conflict;
 			} else if (/Please tell me who you are\./.test(err.stderr)) {

author:joaomoreno
date:2015-12-03T09:00:00Z
title:git pull with rebase

fixes #907
related to #150
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -116,8 +116,8 @@ export class RawGitService implements IRawGitService {
 		}).then(() => this.status());
 	}
 
-	public pull(): TPromise<IRawStatus> {
-		return this.repo.pull().then(() => this.status());
+	public pull(rebase?: boolean): TPromise<IRawStatus> {
+		return this.repo.pull(rebase).then(() => this.status());
 	}
 
 	public push(): TPromise<IRawStatus> {
@@ -235,8 +235,8 @@ export class DelayedRawGitService implements IRawGitService {
 		return this.raw.then(raw => raw.fetch());
 	}
 
-	public pull(): TPromise<IRawStatus> {
-		return this.raw.then(raw => raw.pull());
+	public pull(rebase?: boolean): TPromise<IRawStatus> {
+		return this.raw.then(raw => raw.pull(rebase));
 	}
 
 	public push(): TPromise<IRawStatus> {

author:joaomoreno
date:2015-12-10T15:48:46Z
title:drop react dependency from git status bar contribution
filename:src/vs/workbench/browser/parts/statusbar/media/statusbarPart.css
code:
@@ -35,17 +35,19 @@
 	margin-left: 5px;
 }
 
-.monaco-workbench > .part.statusbar > .statusbar-item a {
+.monaco-workbench > .part.statusbar > .statusbar-item a:not([disabled]) {
 	cursor: pointer;
 	display: inline-block;
+	height: 100%;
 }
 
 .monaco-workbench > .part.statusbar > .statusbar-entry > span {
 	cursor: default;
+	height: 100%;
 }
 
 .monaco-workbench > .part.statusbar > .statusbar-entry > span,
-.monaco-workbench > .part.statusbar > .statusbar-entry > a {
+.monaco-workbench > .part.statusbar > .statusbar-entry > a:not([disabled]) {
 	padding: 0 5px 0 5px;
 	white-space: pre; /* gives some degree of styling */
 }
@@ -55,13 +57,13 @@
 	font-size: 14px;
 }
 
-.monaco-workbench > .part.statusbar > .statusbar-item a:hover {
+.monaco-workbench > .part.statusbar > .statusbar-item a:hover:not([disabled]) {
 	background-color: rgba(255, 255, 255, 0.12);
 	text-decoration: none;
 	color: inherit;
 }
 
-.monaco-workbench > .part.statusbar > .statusbar-item a:active {
+.monaco-workbench > .part.statusbar > .statusbar-item a:active:not([disabled]) {
 	background-color: rgba(255, 255, 255, 0.18);
 }
 

author:joaomoreno
date:2015-12-10T15:48:46Z
title:drop react dependency from git status bar contribution
filename:src/vs/workbench/parts/git/browser/gitWidgets.ts
code:
@@ -2,137 +2,117 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
 import nls = require('vs/nls');
-import react = require('lib/react');
-import objects = require('vs/base/common/objects');
 import strings = require('vs/base/common/strings');
-import lifecycle = require('vs/base/common/lifecycle');
-import git = require('vs/workbench/parts/git/common/git');
-import statusbar = require('vs/workbench/browser/parts/statusbar/statusbar');
-import {IQuickOpenService} from 'vs/workbench/services/quickopen/browser/quickOpenService';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-
-import IGitService = git.IGitService;
-
-interface GitStatusbarWidgetProps {
-	instantiationService: IInstantiationService;
-	gitService: IGitService;
-	quickOpenService: IQuickOpenService;
-}
-
-interface GitStatusbarWidgetState {
-	serviceState: git.ServiceState;
+import { assign } from 'vs/base/common/objects';
+import { emmet as $, append } from 'vs/base/browser/dom';
+import { IDisposable, combinedDispose } from 'vs/base/common/lifecycle';
+import { IGitService, ServiceState, IBranch, ServiceOperations } from 'vs/workbench/parts/git/common/git';
+import { IStatusbarItem } from 'vs/workbench/browser/parts/statusbar/statusbar';
+import { IQuickOpenService } from 'vs/workbench/services/quickopen/browser/quickOpenService';
+import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
+
+interface IState {
+	serviceState: ServiceState;
 	isBusy: boolean;
-	HEAD: git.IBranch;
+	HEAD: IBranch;
 	ps1: string;
 }
 
-class GitStatusbarWidgetSpec extends react.BaseComponent<GitStatusbarWidgetProps, GitStatusbarWidgetState> {
+export class GitStatusbarItem implements IStatusbarItem {
 
-	private serviceListeners: lifecycle.IDisposable[];
+	private instantiationService: IInstantiationService;
+	private gitService: IGitService;
+	private quickOpenService: IQuickOpenService;
+	private state: IState;
+	private element: HTMLElement;
+	private toDispose: IDisposable[];
 
-	public componentDidMount(): void {
-		this.serviceListeners = [
-			this.props.gitService.addBulkListener2(() => this.onGitServiceChange())
-		];
-	}
+	constructor(
+		@IInstantiationService instantiationService: IInstantiationService,
+		@IGitService gitService: IGitService,
+		@IQuickOpenService quickOpenService: IQuickOpenService
+	) {
+		this.instantiationService = instantiationService;
+		this.gitService = gitService;
+		this.quickOpenService = quickOpenService;
+		this.toDispose = [];
 
-	public getInitialState(): GitStatusbarWidgetState {
-		return {
-			serviceState: git.ServiceState.NotInitialized,
+		this.state = {
+			serviceState: ServiceState.NotInitialized,
 			isBusy: false,
 			HEAD: null,
 			ps1: ''
 		};
 	}
 
-	public render(): react.ReactHTMLElement {
-		if (this.state.serviceState !== git.ServiceState.OK) {
-			return react.createElement('span', {
-				className: 'git-statusbar-item disabled',
-				title: nls.localize('gitNotEnabled', "Git is not enabled in this workspace."),
-			}, '\u00a0');
-		}
-
-		var HEAD = this.state.HEAD;
-		var className = 'git-statusbar-item';
-		var label: string;
-		var onClick: (e: react.SyntheticEvent)=>void = null;
-
-		if (this.state.isBusy) {
-			className += ' busy';
-		} else {
-			onClick = this.onClick;
-		}
-
-		if (!HEAD) {
-			label = this.state.ps1;
-		} else if (!HEAD.name) {
-			label = this.state.ps1;
-			className += ' headless';
-		} else if (!HEAD.commit || !HEAD.upstream || (!HEAD.ahead && !HEAD.behind)) {
-			label = this.state.ps1;
-		} else {
-			label = strings.format('{0} {1} {2}', this.state.ps1, HEAD.behind, HEAD.ahead);
-		}
-
-		return react.createElement('a', {
-			className: className,
-			onClick: onClick
-		}, label);
+	public render(container: HTMLElement): IDisposable {
+		this.element = append(container, $('a'));
+		this.setState(this.state);
+		this.toDispose.push(this.gitService.addBulkListener2(() => this.onGitServiceChange()));
+		return combinedDispose(...this.toDispose);
 	}
 
 	private onGitServiceChange(): void {
-		var service = this.props.gitService;
-		var model = service.getModel();
+		const model = this.gitService.getModel();
 
-		this.updateState({
-			serviceState: service.getState(),
-			isBusy: service.getRunningOperations().some(op => op.id === git.ServiceOperations.CHECKOUT || op.id === git.ServiceOperations.BRANCH),
+		this.setState({
+			serviceState: this.gitService.getState(),
+			isBusy: this.gitService.getRunningOperations().some(op => op.id === ServiceOperations.CHECKOUT || op.id === ServiceOperations.BRANCH),
 			HEAD: model.getHEAD(),
 			ps1: model.getPS1()
 		});
 	}
 
-	private updateState(update: any, callback?: ()=>void): void {
-		this.setState(objects.mixin(update, this.state, false), callback);
-	}
-
-	private onClick(e: react.SyntheticEvent): void {
-		this.props.quickOpenService.show('git checkout ');
-	}
-}
+	private setState(state: IState): void {
+		this.state = state;
 
-var GitStatusbarWidget = react.createFactoryForTS<GitStatusbarWidgetProps>(GitStatusbarWidgetSpec.prototype);
+		let disabled = false;
+		let className = 'git-statusbar-item';
+		let textContent: string;
+		let title = '';
+		let onclick: () => void = null;
 
-export class GitStatusbarItem implements statusbar.IStatusbarItem {
+		if (state.serviceState !== ServiceState.OK) {
+			disabled = true;
+			className += ' disabled';
+			title = nls.localize('gitNotEnabled', "Git is not enabled in this workspace.");
+			textContent = '\u00a0';
+		} else {
+			const HEAD = state.HEAD;
+
+			if (state.isBusy) {
+				className += ' busy';
+			} else {
+				onclick = () => this.onClick();
+			}
+
+			if (!HEAD) {
+				textContent = state.ps1;
+			} else if (!HEAD.name) {
+				textContent = state.ps1;
+				className += ' headless';
+			} else if (!HEAD.commit || !HEAD.upstream || (!HEAD.ahead && !HEAD.behind)) {
+				textContent = state.ps1;
+			} else {
+				textContent = strings.format('{0} {1} {2}', state.ps1, HEAD.behind, HEAD.ahead);
+			}
+		}
 
-	private instantiationService: IInstantiationService;
-	private gitService: IGitService;
-	private quickOpenService: IQuickOpenService;
+		this.element.className = className;
+		this.element.title = title;
+		this.element.textContent = textContent;
+		this.element.onclick = onclick;
 
-	constructor(
-		@IInstantiationService instantiationService: IInstantiationService,
-		@IGitService gitService: IGitService,
-		@IQuickOpenService quickOpenService: IQuickOpenService
-	) {
-		this.instantiationService = instantiationService;
-		this.gitService = gitService;
-		this.quickOpenService = quickOpenService;
+		if (disabled) {
+			this.element.setAttribute('disabled', 'disabled');
+		} else {
+			this.element.removeAttribute('disabled');
+		}
 	}
 
-	public render(container: HTMLElement): lifecycle.IDisposable {
-		react.render(
-			GitStatusbarWidget({
-				instantiationService: this.instantiationService,
-				gitService: this.gitService,
-				quickOpenService: this.quickOpenService
-			}),
-			container
-		);
-
-		return lifecycle.toDisposable(() => react.unmountComponentAtNode(container));
+	private onClick(): void {
+		this.quickOpenService.show('git checkout ');
 	}
 }
\ No newline at end of file

author:joaomoreno
date:2015-12-11T16:47:31Z
title:git publish action

fixes #908
filename:src/vs/workbench/parts/git/browser/gitWidgets.ts
code:
@@ -6,17 +6,20 @@
 import nls = require('vs/nls');
 import strings = require('vs/base/common/strings');
 import { assign } from 'vs/base/common/objects';
-import { emmet as $, append } from 'vs/base/browser/dom';
+import { onUnexpectedError } from 'vs/base/common/errors';
+import { emmet as $, append, show, hide, addClass } from 'vs/base/browser/dom';
 import { IDisposable, combinedDispose } from 'vs/base/common/lifecycle';
-import { IGitService, ServiceState, IBranch, ServiceOperations } from 'vs/workbench/parts/git/common/git';
+import { IGitService, ServiceState, IBranch, ServiceOperations, IRemote } from 'vs/workbench/parts/git/common/git';
 import { IStatusbarItem } from 'vs/workbench/browser/parts/statusbar/statusbar';
 import { IQuickOpenService } from 'vs/workbench/services/quickopen/browser/quickOpenService';
 import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
+import { SyncAction, PublishAction } from './gitActions';
 
 interface IState {
 	serviceState: ServiceState;
 	isBusy: boolean;
 	HEAD: IBranch;
+	remotes: IRemote[];
 	ps1: string;
 }
 
@@ -27,6 +30,14 @@ export class GitStatusbarItem implements IStatusbarItem {
 	private quickOpenService: IQuickOpenService;
 	private state: IState;
 	private element: HTMLElement;
+	private branchElement: HTMLElement;
+	private publishElement: HTMLElement;
+	private syncElement: HTMLElement;
+	private syncLabelElement: HTMLElement;
+
+	private syncAction: SyncAction;
+	private publishAction: PublishAction;
+
 	private toDispose: IDisposable[];
 
 	constructor(
@@ -37,18 +48,32 @@ export class GitStatusbarItem implements IStatusbarItem {
 		this.instantiationService = instantiationService;
 		this.gitService = gitService;
 		this.quickOpenService = quickOpenService;
-		this.toDispose = [];
+
+		this.syncAction = instantiationService.createInstance(SyncAction, SyncAction.ID, SyncAction.LABEL);
+		this.publishAction = instantiationService.createInstance(PublishAction, PublishAction.ID, PublishAction.LABEL);
+
+		this.toDispose = [
+			this.syncAction,
+			this.publishAction
+		];
 
 		this.state = {
 			serviceState: ServiceState.NotInitialized,
 			isBusy: false,
 			HEAD: null,
+			remotes: [],
 			ps1: ''
 		};
 	}
 
 	public render(container: HTMLElement): IDisposable {
-		this.element = append(container, $('a'));
+		this.element = append(container, $('.git-statusbar-group'));
+		this.branchElement = append(this.element, $('a'));
+		this.publishElement = append(this.element, $('a'));
+		this.syncElement = append(this.element, $('a'));
+		append(this.syncElement, $('span.octicon.octicon-sync'));
+		this.syncLabelElement = append(this.syncElement, $('span'));
+
 		this.setState(this.state);
 		this.toDispose.push(this.gitService.addBulkListener2(() => this.onGitServiceChange()));
 		return combinedDispose(...this.toDispose);
@@ -61,21 +86,23 @@ export class GitStatusbarItem implements IStatusbarItem {
 			serviceState: this.gitService.getState(),
 			isBusy: this.gitService.getRunningOperations().some(op => op.id === ServiceOperations.CHECKOUT || op.id === ServiceOperations.BRANCH),
 			HEAD: model.getHEAD(),
+			remotes: model.getRemotes(),
 			ps1: model.getPS1()
 		});
 	}
 
 	private setState(state: IState): void {
 		this.state = state;
 
-		let disabled = false;
-		let className = 'git-statusbar-item';
+		let isGitDisabled = false;
+		let className = 'git-statusbar-branch-item';
 		let textContent: string;
+		let aheadBehindLabel = '';
 		let title = '';
 		let onclick: () => void = null;
 
 		if (state.serviceState !== ServiceState.OK) {
-			disabled = true;
+			isGitDisabled = true;
 			className += ' disabled';
 			title = nls.localize('gitNotEnabled', "Git is not enabled in this workspace.");
 			textContent = '\u00a0';
@@ -85,7 +112,7 @@ export class GitStatusbarItem implements IStatusbarItem {
 			if (state.isBusy) {
 				className += ' busy';
 			} else {
-				onclick = () => this.onClick();
+				onclick = () => this.onBranchClick();
 			}
 
 			if (!HEAD) {
@@ -96,23 +123,62 @@ export class GitStatusbarItem implements IStatusbarItem {
 			} else if (!HEAD.commit || !HEAD.upstream || (!HEAD.ahead && !HEAD.behind)) {
 				textContent = state.ps1;
 			} else {
-				textContent = strings.format('{0} {1} {2}', state.ps1, HEAD.behind, HEAD.ahead);
+				textContent = state.ps1;
+				aheadBehindLabel = strings.format('{0} {1}', HEAD.behind, HEAD.ahead);
 			}
 		}
 
-		this.element.className = className;
-		this.element.title = title;
-		this.element.textContent = textContent;
-		this.element.onclick = onclick;
+		this.branchElement.className = className;
+		this.branchElement.title = title;
+		this.branchElement.textContent = textContent;
+		this.branchElement.onclick = onclick;
+		this.publishElement.className = 'octicon octicon-cloud-upload';
+		this.syncLabelElement.textContent = aheadBehindLabel;
+		this.syncElement.className = 'git-statusbar-sync-item' + (aheadBehindLabel ? '' : ' empty');
+
+		if (isGitDisabled) {
+			hide(this.branchElement);
+			hide(this.publishElement);
+			hide(this.syncElement);
+		} else {
+			show(this.branchElement);
+
+			if (state.HEAD && !!state.HEAD.upstream) {
+				show(this.syncElement);
+				hide(this.publishElement);
+			} else if (state.remotes.length > 0) {
+				hide(this.syncElement);
+				show(this.publishElement);
+			} else {
+				hide(this.syncElement);
+				hide(this.publishElement);
+			}
+		}
+
+		if (this.syncAction.enabled) {
+			this.syncElement.onclick = () => this.onSyncClick();
+		} else {
+			this.syncElement.onclick = null;
+			addClass(this.syncElement, 'disabled');
+		}
 
-		if (disabled) {
-			this.element.setAttribute('disabled', 'disabled');
+		if (this.publishAction.enabled) {
+			this.publishElement.onclick = () => this.onPublishClick();
 		} else {
-			this.element.removeAttribute('disabled');
+			this.publishElement.onclick = null;
+			addClass(this.publishElement, 'disabled');
 		}
 	}
 
-	private onClick(): void {
+	private onBranchClick(): void {
 		this.quickOpenService.show('git checkout ');
 	}
+
+	private onPublishClick(): void {
+		this.publishAction.run().done(null, onUnexpectedError);
+	}
+
+	private onSyncClick(): void {
+		this.syncAction.run().done(null, onUnexpectedError);
+	}
 }
\ No newline at end of file

author:joaomoreno
date:2015-12-11T16:47:31Z
title:git publish action

fixes #908
filename:src/vs/workbench/parts/git/browser/media/git.contribution.css
code:
@@ -221,7 +221,26 @@
 
 /* Status bar */
 
-.monaco-shell .git-statusbar-item {
+.monaco-shell .git-statusbar-group > a {
+	padding: 0 5px;
+}
+
+.monaco-shell .git-statusbar-group > a.disabled {
+	opacity: 0.7;
+}
+
+.monaco-shell .git-statusbar-group > a.octicon {
+	line-height: 22px;
+	font-size: 15px;
+	width: 16px;
+	text-align: center;
+}
+
+.monaco-shell .git-statusbar-group > .git-statusbar-sync-item:not(.empty) > span.octicon {
+	margin-right: 6px;
+}
+
+.monaco-shell .git-statusbar-group > .git-statusbar-branch-item {
 	background-image: url('../media/git-dark.svg');
 	background-repeat: no-repeat;
 	background-position: 4px 50%;
@@ -230,23 +249,15 @@
 	padding: 0 5px 0 22px;
 }
 
-.monaco-shell .git-statusbar-item.disabled {
-	padding: 0 5px 0 13px;
-}
-
-.monaco-shell .git-statusbar-item:not(.disabled):not(.busy) {
+.monaco-shell .git-statusbar-group > a:not(.disabled):not(.busy) {
 	cursor: pointer;
 }
 
-.monaco-shell .git-statusbar-item.disabled {
-	opacity: 0.6;
-}
-
-.monaco-shell .git-statusbar-item.busy {
+.monaco-shell .git-statusbar-group > .git-statusbar-branch-item.busy {
 	opacity: 0.6;
 	cursor: default;
 }
 
-.monaco-shell .git-statusbar-item.headless {
+.monaco-shell .git-statusbar-group > .git-statusbar-branch-item.headless {
 	font-style: italic;
 }

author:joaomoreno
date:2015-12-11T16:47:31Z
title:provide more git global actions
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -31,7 +31,7 @@ import {IFileService, IFileStat} from 'vs/platform/files/common/files';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import wbar = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
-import { OpenChangeAction, SyncAction } from './gitActions';
+import { OpenChangeAction, SyncAction, PullAction, PushAction, PublishAction } from './gitActions';
 import Severity from 'vs/base/common/severity';
 import paths = require('vs/base/common/paths');
 import URI from 'vs/base/common/uri';
@@ -444,4 +444,7 @@ let workbenchActionRegistry = (<wbar.IWorkbenchActionRegistry> platform.Registry
 // Register Actions
 const category = nls.localize('git', "Git");
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(GlobalOpenChangeAction, GlobalOpenChangeAction.ID, GlobalOpenChangeAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PullAction, PullAction.ID, PullAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PushAction, PushAction.ID, PushAction.LABEL), category);
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(SyncAction, SyncAction.ID, SyncAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PublishAction, PublishAction.ID, PublishAction.LABEL), category);

author:joaomoreno
date:2015-12-11T16:47:31Z
title:provide more git global actions
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -883,9 +883,14 @@ export class PullWithRebaseAction extends PullAction {
 export class PushAction extends GitAction {
 
 	static ID = 'workbench.action.push';
+	static LABEL = nls.localize('push', "Push");
 
-	constructor(@IGitService gitService: IGitService) {
-		super(PushAction.ID, nls.localize('push', "Push"), 'git-action push', gitService);
+	constructor(
+		id: string = PushAction.ID,
+		label: string = PushAction.LABEL,
+		@IGitService gitService: IGitService
+	) {
+		super(id, label, 'git-action push', gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -925,13 +930,16 @@ export class PushAction extends GitAction {
 export class PublishAction extends GitAction {
 
 	static ID = 'workbench.action.publish';
+	static LABEL = nls.localize('publish', "Publish");
 
 	constructor(
+		id: string = PublishAction.ID,
+		label: string = PublishAction.LABEL,
 		@IGitService gitService: IGitService,
 		@IQuickOpenService private quickOpenService: IQuickOpenService,
 		@IMessageService private messageService: IMessageService
 	) {
-		super(PublishAction.ID, nls.localize('publish', "Publish"), 'git-action publish', gitService);
+		super(id, label, 'git-action publish', gitService);
 	}
 
 	protected isEnabled():boolean {

author:joaomoreno
date:2015-12-11T16:47:31Z
title:provide more git global actions
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -250,9 +250,9 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 				this.instantiationService.createInstance(GitActions.SyncAction, GitActions.SyncAction.ID, GitActions.SyncAction.LABEL),
 				this.instantiationService.createInstance(GitActions.PullAction, GitActions.PullAction.ID, GitActions.PullAction.LABEL),
 				this.instantiationService.createInstance(GitActions.PullWithRebaseAction),
-				this.instantiationService.createInstance(GitActions.PushAction),
+				this.instantiationService.createInstance(GitActions.PushAction, GitActions.PushAction.ID, GitActions.PushAction.LABEL),
 				new ActionBar.Separator(),
-				this.instantiationService.createInstance(GitActions.PublishAction),
+				this.instantiationService.createInstance(GitActions.PublishAction, GitActions.PublishAction.ID, GitActions.PublishAction.LABEL),
 				new ActionBar.Separator(),
 				this.instantiationService.createInstance(GitActions.CommitAction, this),
 				this.instantiationService.createInstance(GitActions.StageAndCommitAction, this),

author:joaomoreno
date:2015-12-11T11:35:46Z
title:git lib get remotes
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -21,6 +21,10 @@ export interface IRawFileStatus {
 	rename?: string;
 }
 
+export interface IRemote {
+	name: string;
+}
+
 export interface IHead {
 	name?: string;
 	commit?: string;
@@ -44,6 +48,7 @@ export interface IRawStatus {
 	HEAD: IBranch;
 	heads: IBranch[];
 	tags: ITag[];
+	remotes: IRemote[];
 }
 
 // Model enums

author:joaomoreno
date:2015-12-11T11:35:46Z
title:git lib get remotes
filename:src/vs/workbench/parts/git/common/gitModel.ts
code:
@@ -355,7 +355,8 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 				status: [],
 				HEAD: null,
 				heads: [],
-				tags: []
+				tags: [],
+				remotes: []
 			};
 		}
 

author:joaomoreno
date:2015-12-11T11:35:46Z
title:git lib get remotes
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -14,7 +14,8 @@ export class NoOpGitService implements git.IRawGitService {
 		status: [],
 		HEAD: null,
 		heads: [],
-		tags: []
+		tags: [],
+		remotes: []
 	};
 
 	public serviceState(): winjs.TPromise<git.RawServiceState> {

author:joaomoreno
date:2015-12-11T11:35:46Z
title:git lib get remotes
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -11,7 +11,7 @@ import objects = require('vs/base/common/objects');
 import uuid = require('vs/base/common/uuid');
 import nls = require('vs/nls');
 import strings = require('vs/base/common/strings');
-import { IRawFileStatus, IHead, ITag, IBranch, GitErrorCodes } from 'vs/workbench/parts/git/common/git';
+import { IRawFileStatus, IHead, ITag, IBranch, IRemote, GitErrorCodes } from 'vs/workbench/parts/git/common/git';
 import { detectMimesFromStream } from 'vs/base/node/mime'
 import files = require('vs/platform/files/common/files');
 import { spawn, ChildProcess } from 'child_process';
@@ -624,6 +624,16 @@ export class Repository {
 		});
 	}
 
+	public getRemotes(): TPromise<IRemote[]> {
+		return this.run(['remote'], { log: false })
+			.then(result => result.stdout
+				.trim()
+				.split('\n')
+				.filter(b => !!b)
+				.map(name => ({ name }))
+			);
+	}
+
 	public getBranch(branch: string): TPromise<IBranch> {
 		if (branch === 'HEAD') {
 			return this.getHEAD();

author:joaomoreno
date:2015-12-11T11:35:46Z
title:git lib get remotes
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -50,13 +50,14 @@ export class RawGitService implements IRawGitService {
 						return HEAD;
 					}
 				}, (): IHead => null)
-				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getHeads(), this.repo.getTags()]).then(r => {
+				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getHeads(), this.repo.getTags(), this.repo.getRemotes()]).then(r => {
 					return {
 						repositoryRoot: r[0],
 						status: status,
 						HEAD: HEAD,
 						heads: r[1],
-						tags: r[2]
+						tags: r[2],
+						remotes: r[3]
 					};
 				})))
 			.then(null, (err) => {

author:joaomoreno
date:2015-12-16T08:19:01Z
title:delay git sync action disablement

fixes #1277
filename:src/vs/workbench/parts/git/browser/gitWidgets.ts
code:
@@ -6,6 +6,7 @@
 import nls = require('vs/nls');
 import strings = require('vs/base/common/strings');
 import { assign } from 'vs/base/common/objects';
+import { Delayer } from 'vs/base/common/async';
 import { emmet as $, append, show, hide, addClass, toggleClass } from 'vs/base/browser/dom';
 import { IDisposable, combinedDispose } from 'vs/base/common/lifecycle';
 import { IGitService, ServiceState, IBranch, ServiceOperations, IRemote } from 'vs/workbench/parts/git/common/git';
@@ -25,6 +26,8 @@ interface IState {
 	ps1: string;
 }
 
+const DisablementDelay = 500;
+
 export class GitStatusbarItem implements IStatusbarItem {
 
 	private instantiationService: IInstantiationService;
@@ -36,6 +39,7 @@ export class GitStatusbarItem implements IStatusbarItem {
 	private publishElement: HTMLElement;
 	private syncElement: HTMLElement;
 	private syncLabelElement: HTMLElement;
+	private disablementDelayer: Delayer<void>;
 
 	private syncAction: SyncAction;
 	private publishAction: PublishAction;
@@ -51,6 +55,7 @@ export class GitStatusbarItem implements IStatusbarItem {
 		this.instantiationService = instantiationService;
 		this.gitService = gitService;
 		this.quickOpenService = quickOpenService;
+		this.disablementDelayer = new Delayer<void>(DisablementDelay);
 
 		this.syncAction = instantiationService.createInstance(SyncAction, SyncAction.ID, SyncAction.LABEL);
 		this.publishAction = instantiationService.createInstance(PublishAction, PublishAction.ID, PublishAction.LABEL);
@@ -156,20 +161,25 @@ export class GitStatusbarItem implements IStatusbarItem {
 
 			if (state.HEAD && !!state.HEAD.upstream) {
 				show(this.syncElement);
+				toggleClass(this.syncElement, 'syncing', this.state.isSyncing);
+				toggleClass(this.syncElement, 'empty', !aheadBehindLabel);
+				this.disablementDelayer.trigger(
+					() => toggleClass(this.syncElement, 'disabled', !this.syncAction.enabled),
+					this.syncAction.enabled ? 0 : DisablementDelay
+				);
 				hide(this.publishElement);
 			} else if (state.remotes.length > 0) {
 				hide(this.syncElement);
 				show(this.publishElement);
+				this.disablementDelayer.trigger(
+					() => toggleClass(this.publishElement, 'disabled', !this.publishAction.enabled),
+					this.publishAction.enabled ? 0 : DisablementDelay
+				);
 			} else {
 				hide(this.syncElement);
 				hide(this.publishElement);
 			}
 		}
-
-		toggleClass(this.syncElement, 'syncing', this.state.isSyncing);
-		toggleClass(this.syncElement, 'empty', !aheadBehindLabel);
-		toggleClass(this.syncElement, 'disabled', !this.syncAction.enabled);
-		toggleClass(this.publishElement, 'disabled', !this.publishAction.enabled);
 	}
 
 	private onBranchClick(): void {

author:joaomoreno
date:2015-12-15T16:27:09Z
title:fix git widget icon sizes

fixes #1280
filename:src/vs/workbench/parts/git/browser/media/git.contribution.css
code:
@@ -231,11 +231,14 @@
 
 .monaco-shell .git-statusbar-group > a.octicon {
 	line-height: 22px;
-	font-size: 15px;
 	width: 16px;
 	text-align: center;
 }
 
+.monaco-shell .git-statusbar-group .octicon {
+	font-size: 14px;
+}
+
 .monaco-shell .git-statusbar-group > .git-statusbar-sync-item:not(.empty) > span.octicon {
 	margin-right: 6px;
 }

author:joaomoreno
date:2015-12-15T16:18:39Z
title:add tooltips to git actions

fixes #1216
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -983,7 +983,7 @@ export class PublishAction extends GitAction {
 			promise = TPromise.as(result ? remoteName : null);
 		} else {
 			promise = this.quickOpenService.pick(remotes.map(r => r.name), {
-				placeHolder: nls.localize('publishPickMessage', "Pick a remote to push the branch '{0}' to:", branchName)
+				placeHolder: nls.localize('publishPickMessage', "Pick a remote to publish the branch '{0}' to:", branchName)
 			});
 		}
 

author:joaomoreno
date:2015-12-15T16:18:39Z
title:add tooltips to git actions

fixes #1216
filename:src/vs/workbench/parts/git/browser/gitWidgets.ts
code:
@@ -68,10 +68,16 @@ export class GitStatusbarItem implements IStatusbarItem {
 
 	public render(container: HTMLElement): IDisposable {
 		this.element = append(container, $('.git-statusbar-group'));
+
 		this.branchElement = append(this.element, $('a'));
+
 		this.publishElement = append(this.element, $('a'));
+		this.publishElement.title = nls.localize('publishBranch', "Publish Branch");
+
 		this.syncElement = append(this.element, $('a'));
 		append(this.syncElement, $('span.octicon.octicon-sync'));
+		this.syncElement.title = nls.localize('syncBranch', "Synchronize Changes");
+
 		this.syncLabelElement = append(this.syncElement, $('span'));
 
 		this.setState(this.state);

author:joaomoreno
date:2015-12-15T14:12:33Z
title:git global actions

fixes #1279
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -31,7 +31,7 @@ import {IFileService, IFileStat} from 'vs/platform/files/common/files';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import wbar = require('vs/workbench/browser/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
-import { OpenChangeAction, SyncAction, PullAction, PushAction, PublishAction } from './gitActions';
+import { OpenChangeAction, SyncAction, PullAction, PushAction, PublishAction, StartGitBranchAction, StartGitCheckoutAction } from './gitActions';
 import Severity from 'vs/base/common/severity';
 import paths = require('vs/base/common/paths');
 import URI from 'vs/base/common/uri';
@@ -448,3 +448,5 @@ workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PullAct
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PushAction, PushAction.ID, PushAction.LABEL), category);
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(SyncAction, SyncAction.ID, SyncAction.LABEL), category);
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(PublishAction, PublishAction.ID, PublishAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(StartGitBranchAction, StartGitBranchAction.ID, StartGitBranchAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(StartGitCheckoutAction, StartGitCheckoutAction.ID, StartGitCheckoutAction.LABEL), category);

author:joaomoreno
date:2015-12-15T14:12:33Z
title:git global actions

fixes #1279
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -1123,4 +1123,38 @@ export class UndoLastCommitAction extends GitAction {
 	public run():Promise {
 		return this.gitService.reset('HEAD~');
 	}
-}
\ No newline at end of file
+}
+
+export class StartGitCheckoutAction extends Action {
+
+	public static ID = 'workbench.action.git.startGitCheckout';
+	public static LABEL = nls.localize('checkout', "Checkout");
+	private quickOpenService: IQuickOpenService;
+
+	constructor(id: string, label: string, @IQuickOpenService quickOpenService: IQuickOpenService) {
+		super(id, label);
+		this.quickOpenService = quickOpenService;
+	}
+
+	public run(event?:any): Promise {
+		this.quickOpenService.show('git checkout ');
+		return Promise.as(null);
+	}
+}
+
+export class StartGitBranchAction extends Action {
+
+	public static ID = 'workbench.action.git.startGitBranch';
+	public static LABEL = nls.localize('branch2', "Branch");
+	private quickOpenService: IQuickOpenService;
+
+	constructor(id: string, label: string, @IQuickOpenService quickOpenService: IQuickOpenService) {
+		super(id, label);
+		this.quickOpenService = quickOpenService;
+	}
+
+	public run(event?:any): Promise {
+		this.quickOpenService.show('git branch ');
+		return Promise.as(null);
+	}
+}

author:joaomoreno
date:2015-12-15T14:12:33Z
title:git global actions

fixes #1279
filename:src/vs/workbench/parts/git/browser/gitWorkbenchContributions.ts
code:
@@ -421,23 +421,6 @@ class OpenGitViewletAction extends viewlet.ToggleViewletAction {
 	}
 }
 
-class GitCommandsAction extends actions.Action {
-
-	public static ID = 'workbench.action.git.executeGitCommands';
-	public static LABEL = nls.localize('executeGitCommands', "Execute Git Commands");
-	private quickOpenService: IQuickOpenService;
-
-	constructor(id: string, label: string, @IQuickOpenService quickOpenService: IQuickOpenService) {
-		super(id, label);
-		this.quickOpenService = quickOpenService;
-	}
-
-	public run(event?:any): winjs.Promise {
-		this.quickOpenService.show('git ');
-		return winjs.Promise.as(null);
-	}
-}
-
 export function registerContributions(): void {
 
 	// Register Statusbar item
@@ -476,11 +459,6 @@ export function registerContributions(): void {
 		nls.localize('view', "View")
 	);
 
-	// Register Action for git quick open mode
-	(<wbar.IWorkbenchActionRegistry> platform.Registry.as(wbar.Extensions.WorkbenchActions)).registerWorkbenchAction(
-		new SyncActionDescriptor(GitCommandsAction, GitCommandsAction.ID, GitCommandsAction.LABEL)
-	);
-
 	// Register MergeDecorator
 	EditorBrowserRegistry.registerEditorContribution(editorcontrib.MergeDecorator);
 

author:joaomoreno
date:2015-12-15T13:51:50Z
title:git service dispose

fixes #1323 #1288
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -765,6 +765,8 @@ export class GitService extends ee.EventEmitter
 	}
 
 	public dispose(): void {
+		this.emit(git.ServiceEvents.DISPOSE);
+
 		if (this.model) {
 			this.model.dispose();
 			this.model = null;

author:joaomoreno
date:2015-12-15T13:51:50Z
title:git service dispose

fixes #1323 #1288
filename:src/vs/workbench/parts/git/browser/gitWorkbenchContributions.ts
code:
@@ -290,8 +290,14 @@ class DirtyDiffModelDecorator {
 		}
 		this.model = null;
 		this.decorations = null;
-		this.delayer.cancel();
-		this.diffDelayer.cancel();
+		if (this.delayer) {
+			this.delayer.cancel();
+			this.delayer = null;
+		}
+		if (this.diffDelayer) {
+			this.diffDelayer.cancel();
+			this.diffDelayer = null;
+		}
 	}
 }
 
@@ -326,6 +332,7 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 		this.decorators = Object.create(null);
 		this.toDispose = [];
 		this.toDispose.push(eventService.addListener2(workbenchEvents.EventType.EDITOR_INPUT_CHANGED, () => this.onEditorInputChange()));
+		this.toDispose.push(gitService.addListener2(git.ServiceEvents.DISPOSE, () => this.dispose()));
 	}
 
 	public getId(): string {
@@ -396,6 +403,7 @@ export class DirtyDiffDecorator implements ext.IWorkbenchContribution {
 	}
 
 	public dispose(): void {
+		this.toDispose = lifecycle.disposeAll(this.toDispose);
 		this.models.forEach(m => this.decorators[m.id].dispose());
 		this.models = null;
 		this.decorators = null;

author:joaomoreno
date:2015-12-15T13:51:50Z
title:git service dispose

fixes #1323 #1288
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -199,7 +199,8 @@ export var ServiceEvents = {
 	OPERATION_START: 'operationStart',
 	OPERATION_END: 'operationEnd',
 	OPERATION: 'operation',
-	ERROR: 'error'
+	ERROR: 'error',
+	DISPOSE: 'dispose'
 };
 
 // Service operations

author:joaomoreno
date:2016-01-04T15:13:41Z
title:git lib: use iconv to decode buffers

fixes #1539
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -44,12 +44,12 @@ function exec(child: ChildProcess, encoding = 'utf8'): TPromise<IExecutionResult
 		new TPromise<string>(c => {
 			let buffers: Buffer[] = [];
 			on(child.stdout, 'data', b => buffers.push(b));
-			once(child.stdout, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+			once(child.stdout, 'close', () => c(iconv.decode(Buffer.concat(buffers), encoding)));
 		}),
 		new TPromise<string>(c => {
 			let buffers: Buffer[] = [];
 			on(child.stderr, 'data', b => buffers.push(b));
-			once(child.stderr, 'close', () => c(Buffer.concat(buffers).toString(encoding)));
+			once(child.stderr, 'close', () => c(iconv.decode(Buffer.concat(buffers), encoding)));
 		})
 	]).then(values => {
 		disposeAll(disposables);

author:joaomoreno
date:2016-01-04T11:53:14Z
title:fix git changes view keyboard navigation

fixes #1544
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -328,7 +328,7 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 			return;
 		}
 
-		if (e.payload && e.payload.origin === 'keyboard' && (<IKeyboardEvent>e.payload.originalEvent).equals(CommonKeybindings.ENTER)) {
+		if (e.payload && e.payload.origin === 'keyboard' && !(<IKeyboardEvent>e.payload.originalEvent).equals(CommonKeybindings.ENTER)) {
 			return;
 		}
 

author:joaomoreno
date:2016-01-05T10:02:27Z
title:add git askpass window title

fixes #1558
filename:src/vs/workbench/parts/git/electron-main/askpassService.ts
code:
@@ -3,6 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
+import * as nls from 'vs/nls';
 import ipc = require('ipc');
 import platform = require('vs/base/common/platform');
 import { TPromise } from 'vs/base/common/winjs.base';
@@ -51,7 +52,8 @@ export class GitAskpassService {
 				resizable: false,
 				width: 450,
 				height: platform.isWindows ? 280 : 260,
-				show: true
+				show: true,
+				title: nls.localize('git', "Git")
 			});
 
 			win.setMenuBarVisibility(false);

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:.vscode/settings.json
code:
@@ -12,5 +12,6 @@
 		".build/**": true,
 		"out*/**": true,
 		"extensions/**/out/**": true
-	}
+	},
+	"filePicker.alternateFileNameMatching": true
 }
\ No newline at end of file

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:extensions/jade/syntaxes/Jade.tmLanguage
code:
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
 <plist version="1.0">
 <dict>
 	<key>fileTypes</key>
@@ -462,7 +462,11 @@
 				</dict>
 				<dict>
 					<key>include</key>
-					<string>#mixins</string>
+					<string>#mixin_definition</string>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>#mixin_call</string>
 				</dict>
 				<dict>
 					<key>include</key>
@@ -592,26 +596,6 @@
 			<key>name</key>
 			<string>meta.first-class.jade</string>
 		</dict>
-		<key>brackets_js</key>
-		<dict>
-			<key>begin</key>
-			<string>\[</string>
-			<key>end</key>
-			<string>\]</string>
-			<key>name</key>
-			<string>js.value.attribute.tag.jade</string>
-			<key>patterns</key>
-			<array>
-				<dict>
-					<key>include</key>
-					<string>#brackets_js</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>source.js</string>
-				</dict>
-			</array>
-		</dict>
 		<key>case_conds</key>
 		<dict>
 			<key>begin</key>
@@ -712,7 +696,7 @@
 				</dict>
 				<dict>
 					<key>include</key>
-					<string>#mixins</string>
+					<string>#mixin_call</string>
 				</dict>
 				<dict>
 					<key>include</key>
@@ -946,7 +930,7 @@
 				</dict>
 				<dict>
 					<key>include</key>
-					<string>#mixins</string>
+					<string>#mixin_call</string>
 				</dict>
 				<dict>
 					<key>begin</key>
@@ -1081,60 +1065,155 @@
 				</dict>
 			</array>
 		</dict>
-		<key>mixins</key>
+		<key>js_braces</key>
+		<dict>
+			<key>begin</key>
+			<string>\{</string>
+			<key>end</key>
+			<string>\}</string>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>include</key>
+					<string>#js_braces</string>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>source.js</string>
+				</dict>
+			</array>
+		</dict>
+		<key>js_brackets</key>
+		<dict>
+			<key>begin</key>
+			<string>\[</string>
+			<key>end</key>
+			<string>\]</string>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>include</key>
+					<string>#js_brackets</string>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>source.js</string>
+				</dict>
+			</array>
+		</dict>
+		<key>js_parens</key>
+		<dict>
+			<key>begin</key>
+			<string>\(</string>
+			<key>end</key>
+			<string>\)</string>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>include</key>
+					<string>#js_parens</string>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>source.js</string>
+				</dict>
+			</array>
+		</dict>
+		<key>mixin_call</key>
 		<dict>
 			<key>begin</key>
-			<string>(((mixin\s+)|\+)([\w-]+))\s*</string>
+			<string>((?:mixin\s+)|\+)([\w-]+)</string>
 			<key>beginCaptures</key>
 			<dict>
-				<key>2</key>
+				<key>1</key>
 				<dict>
 					<key>name</key>
 					<string>storage.type.function.jade</string>
 				</dict>
-				<key>4</key>
+				<key>2</key>
 				<dict>
 					<key>name</key>
-					<string>entity.name.function.jade</string>
+					<string>meta.tag.other entity.name.function.jade</string>
 				</dict>
 			</dict>
-			<key>comment</key>
-			<string>Mixin declaration and use, including the new '+' syntax.</string>
 			<key>end</key>
-			<string>(?=\])|$</string>
-			<key>name</key>
-			<string>source.meta.function</string>
+			<string>(?!\()|$</string>
 			<key>patterns</key>
 			<array>
 				<dict>
 					<key>begin</key>
-					<string></string>
+					<string>(?&lt;!\))\(</string>
 					<key>end</key>
-					<string>(?=\])|$</string>
+					<string>\)</string>
 					<key>name</key>
 					<string>args.mixin.jade</string>
 					<key>patterns</key>
 					<array>
 						<dict>
 							<key>include</key>
-							<string>#tag_attribute_value_paren</string>
+							<string>#js_parens</string>
 						</dict>
 						<dict>
 							<key>include</key>
-							<string>#tag_attribute_value_brackets</string>
+							<string>#string</string>
 						</dict>
 						<dict>
-							<key>include</key>
-							<string>#tag_attribute_value_braces</string>
+							<key>captures</key>
+							<dict>
+								<key>1</key>
+								<dict>
+									<key>name</key>
+									<string>meta.tag.other entity.other.attribute-name.tag.jade</string>
+								</dict>
+							</dict>
+							<key>match</key>
+							<string>([^\s(),=/]+)\s*=\s*</string>
 						</dict>
 						<dict>
 							<key>include</key>
-							<string>#complete_tag</string>
+							<string>source.js</string>
 						</dict>
 					</array>
 				</dict>
+				<dict>
+					<key>include</key>
+					<string>#tag_attributes</string>
+				</dict>
 			</array>
 		</dict>
+		<key>mixin_definition</key>
+		<dict>
+			<key>captures</key>
+			<dict>
+				<key>1</key>
+				<dict>
+					<key>name</key>
+					<string>storage.type.function.jade</string>
+				</dict>
+				<key>2</key>
+				<dict>
+					<key>name</key>
+					<string>meta.tag.other entity.name.function.jade</string>
+				</dict>
+				<key>3</key>
+				<dict>
+					<key>name</key>
+					<string>punctuation.definition.parameters.begin.js</string>
+				</dict>
+				<key>4</key>
+				<dict>
+					<key>name</key>
+					<string>variable.parameter.function.js</string>
+				</dict>
+				<key>5</key>
+				<dict>
+					<key>name</key>
+					<string>punctuation.definition.parameters.begin.js</string>
+				</dict>
+			</dict>
+			<key>match</key>
+			<string>(mixin\s+)([\w-]+)(?:(\()((?:[a-zA-Z_]\w*(?:,\s*)?)*)(\)))?$</string>
+		</dict>
 		<key>printed_expression</key>
 		<dict>
 			<key>begin</key>
@@ -1155,7 +1234,7 @@
 			<array>
 				<dict>
 					<key>include</key>
-					<string>#brackets_js</string>
+					<string>#js_brackets</string>
 				</dict>
 				<dict>
 					<key>include</key>
@@ -1189,106 +1268,43 @@
 				</dict>
 			</array>
 		</dict>
-		<key>tag_attribute_value_braces</key>
+		<key>tag_attribute_name</key>
 		<dict>
-			<key>begin</key>
-			<string>\{</string>
-			<key>end</key>
-			<string>\}</string>
-			<key>name</key>
-			<string>js.value.attribute.tag.jade</string>
-			<key>patterns</key>
-			<array>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_paren</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_brackets</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_braces</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#string</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>source.js</string>
-				</dict>
-			</array>
-		</dict>
-		<key>tag_attribute_value_brackets</key>
-		<dict>
-			<key>begin</key>
-			<string>\[</string>
-			<key>end</key>
-			<string>\]</string>
-			<key>name</key>
-			<string>js.value.attribute.tag.jade</string>
-			<key>patterns</key>
-			<array>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_paren</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_brackets</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_braces</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#string</string>
-				</dict>
+			<key>captures</key>
+			<dict>
+				<key>1</key>
 				<dict>
-					<key>include</key>
-					<string>source.js</string>
+					<key>name</key>
+					<string>entity.other.attribute-name.tag.jade</string>
 				</dict>
-			</array>
+			</dict>
+			<key>match</key>
+			<string>([^\s(),=/!]+)\s*</string>
 		</dict>
-		<key>tag_attribute_value_paren</key>
+		<key>tag_attribute_name_paren</key>
 		<dict>
 			<key>begin</key>
-			<string>\(</string>
+			<string>\(\s*</string>
 			<key>end</key>
 			<string>\)</string>
 			<key>name</key>
-			<string>js.value.attribute.tag.jade</string>
+			<string>entity.other.attribute-name.tag.jade</string>
 			<key>patterns</key>
 			<array>
 				<dict>
 					<key>include</key>
-					<string>#tag_attribute_value_paren</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_brackets</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>#tag_attribute_value_braces</string>
+					<string>#tag_attribute_name_paren</string>
 				</dict>
 				<dict>
 					<key>include</key>
-					<string>#string</string>
-				</dict>
-				<dict>
-					<key>include</key>
-					<string>source.js</string>
+					<string>#tag_attribute_name</string>
 				</dict>
 			</array>
 		</dict>
 		<key>tag_attributes</key>
 		<dict>
 			<key>begin</key>
-			<string>(\()</string>
+			<string>(\(\s*)</string>
 			<key>captures</key>
 			<dict>
 				<key>1</key>
@@ -1304,52 +1320,74 @@
 			<key>patterns</key>
 			<array>
 				<dict>
-					<key>captures</key>
-					<dict>
-						<key>1</key>
-						<dict>
-							<key>name</key>
-							<string>entity.other.attribute-name.tag.jade</string>
-						</dict>
-					</dict>
+					<key>include</key>
+					<string>#tag_attribute_name_paren</string>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>#tag_attribute_name</string>
+				</dict>
+				<dict>
 					<key>match</key>
-					<string>([^\s(),=/]+)\s*((?=\))|,|\s+|$)(?!\!?\=)</string>
+					<string>!</string>
+					<key>name</key>
+					<string>invalid.illegal.tag.jade</string>
 				</dict>
 				<dict>
 					<key>begin</key>
-					<string>([^\s(),=/]*[^\s(),=!/])\s*(!?\=)</string>
-					<key>beginCaptures</key>
-					<dict>
-						<key>1</key>
+					<string>=\s*</string>
+					<key>end</key>
+					<string>$|(?=,|(?:\s+[^!%&amp;*-+~|&lt;&gt;:?/])|\))</string>
+					<key>name</key>
+					<string>attribute_value</string>
+					<key>patterns</key>
+					<array>
 						<dict>
-							<key>name</key>
-							<string>entity.other.attribute-name.tag.jade</string>
+							<key>include</key>
+							<string>#string</string>
 						</dict>
-						<key>2</key>
 						<dict>
-							<key>name</key>
-							<string>punctuation.separator.key-value.jade</string>
+							<key>include</key>
+							<string>#js_parens</string>
 						</dict>
-					</dict>
+						<dict>
+							<key>include</key>
+							<string>#js_brackets</string>
+						</dict>
+						<dict>
+							<key>include</key>
+							<string>#js_braces</string>
+						</dict>
+						<dict>
+							<key>include</key>
+							<string>source.js</string>
+						</dict>
+					</array>
+				</dict>
+				<dict>
+					<key>begin</key>
+					<string>(?&lt;=[%&amp;*-+~|&lt;&gt;:?/])\s+</string>
 					<key>end</key>
-					<string>(,|$|(?=\)|((?&lt;![+/*|&amp;=:^~!?&lt;&gt;%-])\s+[^+/*|&amp;=:^~!?&lt;&gt;%-])))</string>
+					<string>$|(?=,|(?:\s+[^!%&amp;*-+~|&lt;&gt;:?/])|\))</string>
+					<key>name</key>
+					<string>attribute_value2</string>
 					<key>patterns</key>
 					<array>
 						<dict>
 							<key>include</key>
-							<string>#tag_attribute_value_paren</string>
+							<string>#string</string>
 						</dict>
 						<dict>
 							<key>include</key>
-							<string>#tag_attribute_value_brackets</string>
+							<string>#js_parens</string>
 						</dict>
 						<dict>
 							<key>include</key>
-							<string>#tag_attribute_value_braces</string>
+							<string>#js_brackets</string>
 						</dict>
 						<dict>
 							<key>include</key>
-							<string>#string</string>
+							<string>#js_braces</string>
 						</dict>
 						<dict>
 							<key>include</key>
@@ -1496,7 +1534,7 @@
 			<array>
 				<dict>
 					<key>include</key>
-					<string>#brackets_js</string>
+					<string>#js_brackets</string>
 				</dict>
 				<dict>
 					<key>include</key>

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:extensions/javascript/package.json
code:
@@ -64,7 +64,7 @@
 		"jsonValidation": [
 			{
 				"fileMatch": "package.json",
-				"url": "http://json.schemastore.org/project"
+				"url": "http://json.schemastore.org/package"
 			},
 			{
 				"fileMatch": "bower.json",

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:npm-shrinkwrap.json
code:
@@ -416,9 +416,9 @@
       "resolved": "https://registry.npmjs.org/semver/-/semver-4.3.6.tgz"
     },
 	"vscode-debugprotocol": {
-      "version": "1.0.1",
-      "from": "vscode-debugprotocol@>=1.0.1",
-      "resolved": "https://registry.npmjs.org/vscode-debugprotocol/-/vscode-debugprotocol-1.0.1.tgz"
+      "version": "1.1.1",
+      "from": "vscode-debugprotocol@>=1.1.1",
+      "resolved": "https://registry.npmjs.org/vscode-debugprotocol/-/vscode-debugprotocol-1.1.1.tgz"
     },
     "vscode-textmate": {
       "version": "1.0.9",

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:package.json
code:
@@ -26,7 +26,7 @@
     "iconv-lite": "^0.4.13",
     "sax": "^1.1.1",
     "semver": "^4.2.0",
-    "vscode-debugprotocol": "^1.0.0",
+    "vscode-debugprotocol": "^1.1.1",
     "vscode-textmate": "^1.0.9",
     "native-keymap": "^0.1.2",
     "winreg": "0.0.12",

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:src/vs/base/common/paths.ts
code:
@@ -277,7 +277,7 @@ export function isEqualOrParent(path: string, candidate: string): boolean {
 
 // Reference: https://en.wikipedia.org/wiki/Filename
 const INVALID_FILE_CHARS = isWindows ? /[\\/:\*\?"<>\|]/g : /[\\/]/g;
-const WINDOWS_FORBIDDEN_NAMES = /con|prn|aux|clock\$|nul|lpt[0-9]|com[0-9]/i;
+const WINDOWS_FORBIDDEN_NAMES = /^(con|prn|aux|clock\$|nul|lpt[0-9]|com[0-9])$/i;
 export function isValidBasename(name: string): boolean {
 	if (!name || name.length === 0 || /^\s+$/.test(name)) {
 		return false; // require a name that is not just whitespace

author:joaomoreno
date:2016-01-05T16:29:33Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:src/vs/languages/html/common/htmlTags.ts
code:
author:isidorn
date:2016-01-07T18:02:46Z
title:joao: tune the git icons with regards to the new tree size
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.css
code:
@@ -65,9 +65,9 @@
 	cursor: default;
 }
 
-.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .monaco-count-badge {
+.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .count-badge-wrapper {
 	float: right;
-	margin-right: 12px;
+	padding-right: 12px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row:hover .monaco-count-badge {
@@ -89,21 +89,17 @@
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .status {
-	position: absolute;
-	top: 4px;
-	height: 12px;
-	width: 6px;
-	line-height: 12px;
 	padding: 2px 4px;
 	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Inconsolata", "Courier New", monospace, "Droid Sans Fallback";
-	font-size: 9px;
+	font-size: 70%;
 	color: white;
 	text-align: center;
-	border-radius: 4px;
+	border-radius: 0.5em;
+	vertical-align: bottom;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .name {
-	margin-left: 20px;
+	margin-left: 0.4em;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.modified .status	{ background-color: #007ACC; }

author:isidorn
date:2016-01-07T18:02:46Z
title:joao: tune the git icons with regards to the new tree size
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.css
code:
@@ -65,9 +65,9 @@
 	cursor: default;
 }
 
-.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .monaco-count-badge {
+.git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .count-badge-wrapper {
 	float: right;
-	margin-right: 12px;
+	padding-right: 12px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row:hover .monaco-count-badge {
@@ -89,21 +89,17 @@
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .status {
-	position: absolute;
-	top: 4px;
-	height: 12px;
-	width: 6px;
-	line-height: 12px;
 	padding: 2px 4px;
 	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Inconsolata", "Courier New", monospace, "Droid Sans Fallback";
-	font-size: 9px;
+	font-size: 70%;
 	color: white;
 	text-align: center;
-	border-radius: 4px;
+	border-radius: 0.5em;
+	vertical-align: bottom;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status .name {
-	margin-left: 20px;
+	margin-left: 0.4em;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status.modified .status	{ background-color: #007ACC; }

author:isidorn
date:2016-01-11T09:50:49Z
title:count badge: make it rounder to improve single digit case

fixes #1882
filename:src/vs/base/browser/ui/countBadge/countBadge.css
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 
 .monaco-count-badge {
-	padding: 0.2em 0.4em;
+	padding: 0.2em 0.5em;
 	border-radius: 1em;
 	font-size: 85%;
 	font-weight: normal;

author:dstorey
date:2016-01-11T05:28:37Z
title:Add common @robertpenner timing functions to IntelliSense

based on the CSS values from https://github.com/matthewlein/Ceaser/blob/master/developer/ceaser-easings.scss
filename:src/vs/languages/css/common/buildscripts/css-schema.xml
code:
@@ -8395,6 +8395,78 @@
         <value name="cubic-bezier()" version="3.0" browsers="all">
           <desc>Specifies a cubic-bezier curve. The four values specify points P1 and P2  of the curve as (x1, y1, x2, y2). All values must be in the range [0, 1].</desc>
         </value>
+        <value name="cubic-bezier(0.6, -0.28, 0.735, 0.045)" version="3.0" browsers="all">
+          <desc>Ease-in Back. Overshoots.</desc>
+        </value>
+        <value name="cubic-bezier(0.68, -0.55, 0.265, 1.55)" version="3.0" browsers="all">
+          <desc>Ease-in-out Back. Overshoots.</desc>
+        </value>
+        <value name="cubic-bezier(0.175, 0.885, 0.32, 1.275)" version="3.0" browsers="all">
+          <desc>Ease-out Back. Overshoots.</desc>
+        </value>
+        <value name="cubic-bezier(0.6, 0.04, 0.98, 0.335)" version="3.0" browsers="all">
+          <desc>Ease-in Circular. Based on half circle.</desc>
+        </value>
+        <value name="cubic-bezier(0.785, 0.135, 0.15, 0.86)" version="3.0" browsers="all">
+          <desc>Ease-in-out Circular. Based on half circle.</desc>
+        </value>
+        <value name="cubic-bezier(0.075, 0.82, 0.165, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Circular. Based on half circle.</desc>
+        </value>
+        <value name="cubic-bezier(0.55, 0.055, 0.675, 0.19)" version="3.0" browsers="all">
+          <desc>Ease-in Cubic. Based on power of three.</desc>
+        </value>
+        <value name="cubic-bezier(0.645, 0.045, 0.355, 1)" version="3.0" browsers="all">
+          <desc>Ease-in-out Cubic. Based on power of three.</desc>
+        </value>
+        <value name="cubic-bezier(0.215, 0.610, 0.355, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Cubic. Based on power of three.</desc>
+        </value>
+        <value name="cubic-bezier(0.95, 0.05, 0.795, 0.035)" version="3.0" browsers="all">
+          <desc>Ease-in Exponential. Based on two to the power ten.</desc>
+        </value>
+        <value name="cubic-bezier(1, 0, 0, 1)" version="3.0" browsers="all">
+          <desc>Ease-in-out Exponential. Based on two to the power ten.</desc>
+        </value>
+        <value name="cubic-bezier(0.19, 1, 0.22, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Exponential. Based on two to the power ten.</desc>
+        </value>
+        <value name="cubic-bezier(0.47, 0, 0.745, 0.715)" version="3.0" browsers="all">
+          <desc>Ease-in Sine.</desc>
+        </value>
+        <value name="cubic-bezier(0.445, 0.05, 0.55, 0.95)" version="3.0" browsers="all">
+          <desc>Ease-in-out Sine.</desc>
+        </value>
+        <value name="cubic-bezier(0.39, 0.575, 0.565, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Sine.</desc>
+        </value>
+        <value name="cubic-bezier(0.55, 0.085, 0.68, 0.53)" version="3.0" browsers="all">
+          <desc>Ease-in Quadratic. Based on power of two.</desc>
+        </value>
+        <value name="cubic-bezier(0.455, 0.03, 0.515, 0.955)" version="3.0" browsers="all">
+          <desc>Ease-in-out Quadratic. Based on power of two.</desc>
+        </value>
+        <value name="cubic-bezier(0.25, 0.46, 0.45, 0.94)" version="3.0" browsers="all">
+          <desc>Ease-out Quadratic. Based on power of two.</desc>
+        </value>
+        <value name="cubic-bezier(0.895, 0.03, 0.685, 0.22)" version="3.0" browsers="all">
+          <desc>Ease-in Quartic. Based on power of four.</desc>
+        </value>
+        <value name="cubic-bezier(0.77, 0, 0.175, 1)" version="3.0" browsers="all">
+          <desc>Ease-in-out Quartic. Based on power of four.</desc>
+        </value>
+        <value name="cubic-bezier(0.165, 0.84, 0.44, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Quartic. Based on power of four.</desc>
+        </value>
+        <value name="cubic-bezier(0.755, 0.05, 0.855, 0.06)" version="3.0" browsers="all">
+          <desc>Ease-in Quintic. Based on power of five.</desc>
+        </value>
+        <value name="cubic-bezier(0.86, 0, 0.07, 1)" version="3.0" browsers="all">
+          <desc>Ease-in-out Quintic. Based on power of five.</desc>
+        </value>
+        <value name="cubic-bezier(0.23, 1, 0.320, 1)" version="3.0" browsers="all">
+          <desc>Ease-out Quintic. Based on power of five.</desc>
+        </value>
         <value name="ease" version="3.0" browsers="all">
           <desc>Equivalent to cubic-bezier(0.25, 0.1, 0.25, 1.0).</desc>
         </value>

author:dstorey
date:2016-01-11T05:28:37Z
title:Add common @robertpenner timing functions to IntelliSense

based on the CSS values from https://github.com/matthewlein/Ceaser/blob/master/developer/ceaser-easings.scss
filename:src/vs/languages/css/common/services/browsers.js
code:
@@ -8845,6 +8845,78 @@ exports.data ={
 					{
 						"name": "cubic-bezier()"
 					},
+					{
+						"name": "cubic-bezier(0.6, -0.28, 0.735, 0.045)"
+					},
+					{
+						"name": "cubic-bezier(0.68, -0.55, 0.265, 1.55)"
+					},
+					{
+						"name": "cubic-bezier(0.175, 0.885, 0.32, 1.275)"
+					},
+					{
+						"name": "cubic-bezier(0.6, 0.04, 0.98, 0.335)"
+					},
+					{
+						"name": "cubic-bezier(0.785, 0.135, 0.15, 0.86)"
+					},
+					{
+						"name": "cubic-bezier(0.075, 0.82, 0.165, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.55, 0.055, 0.675, 0.19)"
+					},
+					{
+						"name": "cubic-bezier(0.645, 0.045, 0.355, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.215, 0.610, 0.355, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.95, 0.05, 0.795, 0.035)"
+					},
+					{
+						"name": "cubic-bezier(1, 0, 0, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.19, 1, 0.22, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.47, 0, 0.745, 0.715)"
+					},
+					{
+						"name": "cubic-bezier(0.445, 0.05, 0.55, 0.95)"
+					},
+					{
+						"name": "cubic-bezier(0.39, 0.575, 0.565, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.55, 0.085, 0.68, 0.53)"
+					},
+					{
+						"name": "cubic-bezier(0.455, 0.03, 0.515, 0.955)"
+					},
+					{
+						"name": "cubic-bezier(0.25, 0.46, 0.45, 0.94)"
+					},
+					{
+						"name": "cubic-bezier(0.895, 0.03, 0.685, 0.22)"
+					},
+					{
+						"name": "cubic-bezier(0.77, 0, 0.175, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.165, 0.84, 0.44, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.755, 0.05, 0.855, 0.06)"
+					},
+					{
+						"name": "cubic-bezier(0.86, 0, 0.07, 1)"
+					},
+					{
+						"name": "cubic-bezier(0.23, 1, 0.320, 1)"
+					},
 					{
 						"name": "ease"
 					},
@@ -11308,6 +11380,30 @@ exports.descriptions = {
 	"perspective()": "Specifies a perspective projection matrix.",
 	"flat": "All children of this element are rendered flattened into the 2D plane of the element.",
 	"preserve-3d": "Flattening is not performed, so children maintain their position in 3D space.",
+	"cubic-bezier(0.6, -0.28, 0.735, 0.045)": "Ease-in Back. Overshoots.",
+	"cubic-bezier(0.68, -0.55, 0.265, 1.55)": "Ease-in-out Back. Overshoots.",
+	"cubic-bezier(0.175, 0.885, 0.32, 1.275)": "Ease-out Back. Overshoots.",
+	"cubic-bezier(0.6, 0.04, 0.98, 0.335)": "Ease-in Circular. Based on half circle.",
+	"cubic-bezier(0.785, 0.135, 0.15, 0.86)": "Ease-in-out Circular. Based on half circle.",
+	"cubic-bezier(0.075, 0.82, 0.165, 1)": "Ease-out Circular. Based on half circle.",
+	"cubic-bezier(0.55, 0.055, 0.675, 0.19)": "Ease-in Cubic. Based on power of three.",
+	"cubic-bezier(0.645, 0.045, 0.355, 1)": "Ease-in-out Cubic. Based on power of three.",
+	"cubic-bezier(0.215, 0.610, 0.355, 1)": "Ease-out Cubic. Based on power of three.",
+	"cubic-bezier(0.95, 0.05, 0.795, 0.035)": "Ease-in Exponential. Based on two to the power ten.",
+	"cubic-bezier(1, 0, 0, 1)": "Ease-in-out Exponential. Based on two to the power ten.",
+	"cubic-bezier(0.19, 1, 0.22, 1)": "Ease-out Exponential. Based on two to the power ten.",
+	"cubic-bezier(0.47, 0, 0.745, 0.715)": "Ease-in Sine.",
+	"cubic-bezier(0.445, 0.05, 0.55, 0.95)": "Ease-in-out Sine.",
+	"cubic-bezier(0.39, 0.575, 0.565, 1)": "Ease-out Sine.",
+	"cubic-bezier(0.55, 0.085, 0.68, 0.53)": "Ease-in Quadratic. Based on power of two.",
+	"cubic-bezier(0.455, 0.03, 0.515, 0.955)": "Ease-in-out Quadratic. Based on power of two.",
+	"cubic-bezier(0.25, 0.46, 0.45, 0.94)": "Ease-out Quadratic. Based on power of two.",
+	"cubic-bezier(0.895, 0.03, 0.685, 0.22)": "Ease-in Quartic. Based on power of four.",
+	"cubic-bezier(0.77, 0, 0.175, 1)": "Ease-in-out Quartic. Based on power of four.",
+	"cubic-bezier(0.165, 0.84, 0.44, 1)": "Ease-out Quartic. Based on power of four.",
+	"cubic-bezier(0.755, 0.05, 0.855, 0.06)": "Ease-in Quintic. Based on power of five.",
+	"cubic-bezier(0.86, 0, 0.07, 1)": "Ease-in-out Quintic. Based on power of five.",
+	"cubic-bezier(0.23, 1, 0.320, 1)": "Ease-out Quintic. Based on power of five.",
 	"bidi-override": "Inside the element, reordering is strictly in sequence according to the 'direction' property; the implicit part of the bidirectional algorithm is ignored.",
 	"embed": "If the element is inline-level, this value opens an additional level of embedding with respect to the bidirectional algorithm. The direction of this embedding level is given by the 'direction' property.",
 	"isolate-override": "This combines the isolation behavior of 'isolate' with the directional override behavior of 'bidi-override'",

author:joaomoreno
date:2016-01-18T09:05:46Z
title:Merge branch 'install-count' of https://github.com/wadeanderson/vscode into wadeanderson-install-count
filename:src/vs/workbench/parts/extensions/common/extensions.ts
code:
@@ -15,6 +15,7 @@ export interface IExtensionManifest {
 	version: string;
 	displayName?: string;
 	description?: string;
+	installs: number;
 }
 
 export interface IGalleryInformation {

author:joaomoreno
date:2016-01-18T09:05:46Z
title:Merge branch 'install-count' of https://github.com/wadeanderson/vscode into wadeanderson-install-count
filename:src/vs/workbench/parts/extensions/electron-browser/extensionsQuickOpen.ts
code:
@@ -56,7 +56,7 @@ interface ITemplateData {
 	root: HTMLElement;
 	displayName: HighlightedLabel;
 	version: HTMLElement;
-	since: HTMLElement;
+	installs: HTMLElement;
 	author: HTMLElement;
 	actionbar: ActionBar;
 	description: HighlightedLabel;
@@ -79,10 +79,11 @@ function extensionEquals(one: IExtension, other: IExtension): boolean {
 	return one.publisher === other.publisher && one.name === other.name;
 }
 
+/**
+ * Compare by Install count descending.
+ */
 function extensionEntryCompare(one: IExtensionEntry, other: IExtensionEntry): number {
-	const oneName = one.extension.displayName || one.extension.name;
-	const otherName = other.extension.displayName || other.extension.name;
-	return oneName.localeCompare(otherName);
+	return other.extension.installs - one.extension.installs;
 }
 
 class OpenInGalleryAction extends Action {
@@ -171,19 +172,22 @@ class Renderer implements IRenderer<IExtensionEntry> {
 	}
 
 	renderTemplate(templateId: string, container: HTMLElement): ITemplateData {
+		// Important to preserve order here.
 		const root = dom.append(container, $('.extension'));
 		const firstRow = dom.append(root, $('.row'));
 		const secondRow = dom.append(root, $('.row'));
 		const published = dom.append(firstRow, $('.published'));
-		const since = dom.append(published, $('span.since'));
+		const displayName = new HighlightedLabel(dom.append(firstRow, $('span.name')));
+		const installs = dom.append(firstRow, $('span.installs'));
+		const version = dom.append(published, $('span.version'));
 		const author = dom.append(published, $('span.author'));
 
 		return {
 			root,
 			author,
-			since,
-			displayName: new HighlightedLabel(dom.append(firstRow, $('span.name'))),
-			version: dom.append(firstRow, $('span.version')),
+			displayName,
+			version,
+			installs,
 			actionbar: new ActionBar(dom.append(secondRow, $('.actions'))),
 			description: new HighlightedLabel(dom.append(secondRow, $('span.description'))),
 			disposables: []
@@ -194,6 +198,7 @@ class Renderer implements IRenderer<IExtensionEntry> {
 		const extension = entry.extension;
 		const date = extension.galleryInformation ? extension.galleryInformation.date : null;
 		const publisher = extension.galleryInformation ? extension.galleryInformation.publisherDisplayName : extension.publisher;
+		const installs = extension.installs;
 		const actionOptions = { icon: true, label: false };
 
 		const updateActions = () => {
@@ -236,7 +241,7 @@ class Renderer implements IRenderer<IExtensionEntry> {
 		data.displayName.set(extension.displayName, entry.highlights.displayName);
 		data.displayName.element.title = extension.name;
 		data.version.textContent = extension.version;
-		data.since.textContent = date ? since(new Date(date)) : '';
+		data.installs.textContent = String(installs);
 		data.author.textContent = publisher;
 		data.description.set(extension.description, entry.highlights.description);
 		data.description.element.title = extension.description;

author:joaomoreno
date:2016-01-18T09:05:46Z
title:Merge branch 'install-count' of https://github.com/wadeanderson/vscode into wadeanderson-install-count
filename:src/vs/workbench/parts/extensions/electron-browser/media/extensions.css
code:
@@ -28,12 +28,12 @@
 	opacity: 0.6;
 }
 
-.quick-open-widget .extension .version {
+.quick-open-widget .extension .installs {
 	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
 	font-size: smaller;
 }
 
-.quick-open-widget .extension .version {
+.quick-open-widget .extension .installs {
 	padding-left: 6px;
 	opacity: 0.7;
 }
@@ -44,7 +44,7 @@
 	font-size: smaller;
 }
 
-.quick-open-widget .extension .published > .since {
+.quick-open-widget .extension .published > .version {
 	opacity: 0.6;
 	margin-right: 0.5em;
 }

author:joaomoreno
date:2016-01-18T09:05:46Z
title:Merge branch 'install-count' of https://github.com/wadeanderson/vscode into wadeanderson-install-count
filename:src/vs/workbench/parts/extensions/node/extensionsService.ts
code:
@@ -64,7 +64,8 @@ function createExtension(manifest: IExtensionManifest, galleryInformation?: IGal
 		displayName: manifest.displayName || manifest.name,
 		publisher: manifest.publisher,
 		version: manifest.version,
-		description: manifest.description || ''
+		description: manifest.description || '',
+		installs: 0
 	};
 
 	if (galleryInformation) {

author:joaomoreno
date:2016-01-18T09:05:46Z
title:Merge branch 'install-count' of https://github.com/wadeanderson/vscode into wadeanderson-install-count
filename:src/vs/workbench/parts/extensions/node/vsoGalleryService.ts
code:
@@ -33,6 +33,12 @@ export interface IGalleryExtension {
 	publisher: { displayName: string, publisherId: string, publisherName: string; };
 	versions: IGalleryExtensionVersion[];
 	galleryApiUrl: string;
+	statistics: IGalleryExtensionStatistic[];
+}
+
+export interface IGalleryExtensionStatistic {
+	statisticName: string;
+	value: number;
 }
 
 export class GalleryService implements IGalleryService {
@@ -53,10 +59,32 @@ export class GalleryService implements IGalleryService {
 		return `${ this.extensionsGalleryUrl }${ path }`;
 	}
 
+	/**
+	 * Extracts install count statistic.
+	 */
+	private extractInstalls(statistics: IGalleryExtensionStatistic[]): number {
+		// Sometimes there are no statistics.
+		if (!statistics) {
+			return 0;
+		}
+		var result = 0;
+		statistics.forEach(stat => {
+			if (stat.statisticName === 'install') {
+				result = stat.value;
+			}
+		})
+		return result;
+	}
+
 	public isEnabled(): boolean {
 		return !!this.extensionsGalleryUrl;
 	}
 
+	/**
+	 * Queries VS Code Extension marketplace for extensions.
+	 *
+	 * Sorts by install count.
+	 */
 	public query(): TPromise<IExtension[]> {
 		if (!this.extensionsGalleryUrl) {
 			return TPromise.wrapError(new Error('No extension gallery service configured.'));
@@ -69,7 +97,7 @@ export class GalleryService implements IGalleryService {
 					value: 'vscode'
 				}]
 			}],
-			flags: 0x1 | 0x4 | 0x80
+			flags: 0x1 | 0x4 | 0x80 | 0x100
 		});
 
 		const request = {
@@ -92,13 +120,14 @@ export class GalleryService implements IGalleryService {
 					publisher: extension.publisher.publisherName,
 					version: extension.versions[0].version,
 					description: extension.shortDescription || '',
+					installs: this.extractInstalls(extension.statistics),
 					galleryInformation: {
 						galleryApiUrl: this.extensionsGalleryUrl,
 						id: extension.extensionId,
 						downloadUrl: `${ extension.versions[0].assetUri }/Microsoft.VisualStudio.Services.VSIXPackage?install=true`,
 						publisherId: extension.publisher.publisherId,
 						publisherDisplayName: extension.publisher.displayName,
-						date: extension.versions[0].lastUpdated
+						date: extension.versions[0].lastUpdated,
 					}
 				}));
 			});

author:jkrems
date:2016-01-17T20:34:30Z
title:Treat surrogate pairs as one character

Fixes https://github.com/Microsoft/vscode/issues/2069
filename:src/vs/editor/common/controller/cursorMoveHelper.ts
code:
@@ -25,6 +25,16 @@ export interface IConfiguration {
 	getIndentationOptions(): EditorCommon.IInternalIndentationOptions;
 }
 
+function isHighSurrogate(model, lineNumber, column) {
+	var code = model.getLineContent(lineNumber).charCodeAt(column - 1);
+	return 0xD800 <= code && code <= 0xDBFF;
+}
+
+function isLowSurrogate(model, lineNumber, column) {
+	var code = model.getLineContent(lineNumber).charCodeAt(column - 1);
+	return 0xDC00 <= code && code <= 0xDFFF;
+}
+
 export class CursorMoveHelper {
 
 	private configuration: IConfiguration;
@@ -36,7 +46,7 @@ export class CursorMoveHelper {
 	public getLeftOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
 
 		if (column > model.getLineMinColumn(lineNumber)) {
-			column = column - 1;
+			column = column - (isLowSurrogate(model, lineNumber, column - 1) ? 2 : 1);
 		} else if (lineNumber > 1) {
 			lineNumber = lineNumber - 1;
 			column = model.getLineMaxColumn(lineNumber);
@@ -51,7 +61,7 @@ export class CursorMoveHelper {
 	public getRightOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
 
 		if (column < model.getLineMaxColumn(lineNumber)) {
-			column = column + 1;
+			column = column + (isHighSurrogate(model, lineNumber, column) ? 2 : 1);
 		} else if (lineNumber < model.getLineCount()) {
 			lineNumber = lineNumber + 1;
 			column = model.getLineMinColumn(lineNumber);

author:jkrems
date:2016-01-17T20:34:30Z
title:Treat surrogate pairs as one character

Fixes https://github.com/Microsoft/vscode/issues/2069
filename:src/vs/editor/test/common/controller/cursor.test.ts
code:
author:joaomoreno
date:2016-01-27T11:37:32Z
title:fix open file git action for out of workspace repo

fixes #2126
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -29,6 +29,8 @@ import { IGitService, IFileStatus, Status, StatusType, ServiceState,
 	IModel, IBranch, GitErrorCodes, ServiceOperations }
 	from 'vs/workbench/parts/git/common/git';
 import {IQuickOpenService, IPickOpenEntry} from 'vs/workbench/services/quickopen/common/quickOpenService';
+import paths = require('vs/base/common/paths');
+import URI from 'vs/base/common/uri';
 
 function flatten(context?: any, preferFocus = false): IFileStatus[] {
 	if (!context) {
@@ -166,17 +168,14 @@ export class OpenFileAction extends GitAction {
 			return Promise.wrapError(new Error('Can\'t open file which is has been deleted.'));
 		}
 
-		var path = this.getPath(status);
+		const resource = URI.file(paths.join(this.gitService.getModel().getRepositoryRoot(), this.getPath(status)));
 
-		return this.fileService.resolveFile(this.contextService.toResource(path)).then((stat: IFileStat) => {
-			return this.editorService.openEditor({
+		return this.fileService.resolveFile(resource)
+			.then(stat => this.editorService.openEditor({
 				resource: stat.resource,
 				mime: stat.mime,
-				options: {
-					forceOpen: true
-				}
-			});
-		});
+				options: { forceOpen: true }
+			}));
 	}
 }
 

author:joaomoreno
date:2016-01-28T09:27:36Z
title:Merge branch 'master' of github.com:Microsoft/vscode
filename:src/vs/workbench/parts/files/browser/views/explorerViewer.ts
code:
@@ -281,64 +281,52 @@ export class FileRenderer extends ActionsRenderer implements IRenderer {
 		if (!editableData) {
 			let label = $('.explorer-item-label').appendTo(item);
 			$('a.plain').text(stat.name).appendTo(label);
+			return null;
 		}
 
 		// Input field (when creating a new file or folder or renaming)
-		else {
-			let inputBox = new InputBox(item.getHTMLElement(), this.contextViewService, {
-				validationOptions: {
-					validation: editableData.validator,
-					showMessage: true
-				}
-			});
-
-			let value = stat.name || '';
-			let lastDot = value.lastIndexOf('.');
 
-			inputBox.value = value;
-			inputBox.select({ start: 0, end: lastDot > 0 && !stat.isDirectory ? lastDot : value.length });
-			inputBox.focus();
+		let inputBox = new InputBox(item.getHTMLElement(), this.contextViewService, {
+			validationOptions: {
+				validation: editableData.validator,
+				showMessage: true
+			}
+		});
 
-			let disposed = false;
+		let value = stat.name || '';
+		let lastDot = value.lastIndexOf('.');
 
-			let wrapUp = async.once<any, void>(() => {
-				if (!disposed) {
-					disposed = true;
-					tree.clearHighlight();
-					tree.DOMFocus();
-					lifecycle.disposeAll(toDispose);
-				}
-			});
+		inputBox.value = value;
+		inputBox.select({ start: 0, end: lastDot > 0 && !stat.isDirectory ? lastDot : value.length });
+		inputBox.focus();
 
-			let commit = async.once<any, void>(() => {
+		let done = async.once<boolean, void>(commit => {
+			if (commit) {
 				this.state.actionProvider.runAction(tree, stat, editableData.action, { value: inputBox.value });
-				wrapUp();
-			});
+			}
 
-			var toDispose = [
-				inputBox,
-				DOM.addStandardDisposableListener(inputBox.inputElement, DOM.EventType.KEY_DOWN, (e: DOM.IKeyboardEvent) => {
-					if (e.equals(CommonKeybindings.ENTER)) {
-						if (inputBox.validate() && !disposed) {
-							commit();
-						}
-					} else if (e.equals(CommonKeybindings.ESCAPE)) {
-						wrapUp();
-					}
-				}),
-				DOM.addDisposableListener(inputBox.inputElement, 'blur', () => {
-					if (inputBox.isInputValid() && !disposed) {
-						commit();
-					} else {
-						wrapUp();
-					}
-				})
-			];
+			tree.clearHighlight();
+			tree.DOMFocus();
+			lifecycle.disposeAll(toDispose);
+		});
 
-			return wrapUp;
-		}
+		var toDispose = [
+			inputBox,
+			DOM.addStandardDisposableListener(inputBox.inputElement, DOM.EventType.KEY_DOWN, (e: DOM.IKeyboardEvent) => {
+				if (e.equals(CommonKeybindings.ENTER)) {
+					if (inputBox.validate()) {
+						done(true);
+					}
+				} else if (e.equals(CommonKeybindings.ESCAPE)) {
+					done(false);
+				}
+			}),
+			DOM.addDisposableListener(inputBox.inputElement, 'blur', () => {
+				done(inputBox.isInputValid());
+			})
+		];
 
-		return null;
+		return () => done(true);
 	}
 
 	private iconClass(element: FileStat): string {

author:joaomoreno
date:2016-01-28T09:11:20Z
title:Merge branch 'master' of https://github.com/krizzdewizz/vscode into krizzdewizz-master
filename:src/vs/base/node/processes.ts
code:
@@ -75,6 +75,10 @@ export function terminateProcess(process: ChildProcess, cwd?: string): Terminate
 	return { success: true };
 }
 
+export function getWindowsShell(): string {
+	return process.env['comspec'] || 'cmd.exe';
+}
+
 export abstract class AbstractProcess<TProgressData> {
 	private cmd: string;
 	private module: string;
@@ -233,7 +237,7 @@ export abstract class AbstractProcess<TProgressData> {
 					} else {
 						args.push(commandLine.join(' '));
 					}
-					childProcess = spawn('cmd.exe', args, options);
+					childProcess = spawn(getWindowsShell(), args, options);
 				} else {
 					if (this.cmd) {
 						childProcess = spawn(this.cmd, this.args, this.options);
@@ -321,7 +325,7 @@ export abstract class AbstractProcess<TProgressData> {
 			if (!this.shell || !Platform.isWindows) {
 				c(false);
 			}
-			let cmdShell = spawn('cmd.exe', ['/s', '/c']);
+			let cmdShell = spawn(getWindowsShell(), ['/s', '/c']);
 			cmdShell.on('error', (error:Error) => {
 				c(true);
 			});

author:joaomoreno
date:2016-01-28T09:11:20Z
title:Merge branch 'master' of https://github.com/krizzdewizz/vscode into krizzdewizz-master
filename:src/vs/workbench/parts/execution/electron-browser/executionService.ts
code:
@@ -15,6 +15,7 @@ import exec = require('vs/workbench/parts/execution/common/execution');
 import uri from 'vs/base/common/uri';
 
 import cp = require('child_process');
+import processes = require('vs/base/node/processes');
 
 export class AbstractExecutionService implements exec.IExecutionService {
 	public serviceId = exec.IExecutionService;
@@ -66,20 +67,22 @@ export class WinExecutionService extends AbstractExecutionService {
 
 		return new TPromise<any>((c, e, p) => {
 
-			// we use `start` to get another cmd.exe where `& pause` can be handled
+			const shell = processes.getWindowsShell();
+
+			// we use `start` to get another shell where `& pause` can be handled
 			args = [
 				'/c',
 				'start',
 				'/wait',
-				'cmd.exe',
+				shell,
 				'/c',
 				strings.format('"{0} {1} & pause"', file, args.join(' '))
 			];
 
 			options = options || <any>{};
 			(<any>options).windowsVerbatimArguments = true;
 
-			childProcess = cp.spawn('cmd.exe', args, options);
+			childProcess = cp.spawn(shell, args, options);
 
 			childProcess.on('exit', c);
 			childProcess.on('error', e);

author:joaomoreno
date:2016-01-28T09:11:20Z
title:Merge branch 'master' of https://github.com/krizzdewizz/vscode into krizzdewizz-master
filename:src/vs/workbench/parts/execution/electron-browser/terminalService.ts
code:
@@ -13,6 +13,7 @@ import {IConfigurationService} from 'vs/platform/configuration/common/configurat
 import {IMessageService} from 'vs/platform/message/common/message';
 
 import cp = require('child_process');
+import processes = require('vs/base/node/processes');
 
 export class WinTerminalService implements ITerminalService {
 	public serviceId = ITerminalService;
@@ -24,7 +25,7 @@ export class WinTerminalService implements ITerminalService {
 	}
 
 	public openTerminal(path: string): void {
-		cp.spawn('cmd.exe', ['/c', 'start', '/wait'], { cwd: path });
+		cp.spawn(processes.getWindowsShell(), ['/c', 'start', '/wait'], { cwd: path });
 	}
 }
 

author:egamma
date:2016-01-28T13:42:35Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/browser/parts/panel/media/panelPart.css
code:
@@ -6,6 +6,11 @@
 .monaco-workbench > .part.panel > .title {
 	border-top: 1px solid #007ACC;
 }
+
+.monaco-workbench > .part.panel {
+	z-index: initial;
+}
+
 .monaco-workbench.no-workspace > .part.panel > .title {
 	border-color: #68217A;
 }

author:isidorn
date:2016-02-09T15:37:33Z
title:git: remove smartness around stage selected lines enablement

fixes #2839
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -272,15 +272,9 @@ export class StageRangesAction extends baseeditor.EditorInputAction {
 		if (!this.gitService || !this.editorService) {
 			return false;
 		}
-
-		var changes = this.editor.getLineChanges();
-		var selections = this.editor.getSelections();
-
-		if (!changes || !selections || selections.length === 0) {
-			return false;
-		}
-
-		return stageranges.getSelectedChanges(changes, selections).length > 0;
+		const selection = this.editor.getSelection();
+		
+		return selection && !selection.isEmpty();
 	}
 
 	public run():TPromise<any> {

author:isidorn
date:2016-02-10T10:22:28Z
title:git: bring back smart enablement for stage action
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -272,9 +272,15 @@ export class StageRangesAction extends baseeditor.EditorInputAction {
 		if (!this.gitService || !this.editorService) {
 			return false;
 		}
-		const selection = this.editor.getSelection();
-		
-		return selection && !selection.isEmpty();
+
+		var changes = this.editor.getLineChanges();
+		var selections = this.editor.getSelections();
+
+		if (!changes || !selections || selections.length === 0) {
+			return false;
+		}
+
+		return stageranges.getSelectedChanges(changes, selections).length > 0;
 	}
 
 	public run():TPromise<any> {

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:.gitignore
code:
@@ -9,6 +9,7 @@ out-editor/
 out-editor-min/
 out-editor-ossfree/
 out-editor-ossfree-min/
+out-linux/
 out-vscode/
 out-vscode-min/
 build/node_modules
\ No newline at end of file

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:build/gulpfile.hygiene.js
code:
@@ -32,6 +32,7 @@ var indentationFilter = [
 	'**',
 	'!ThirdPartyNotices.txt',
 	'!**/*.md',
+	'!**/*.template',
 	'!**/*.yml',
 	'!**/lib/**',
 	'!**/*.d.ts',
@@ -58,8 +59,10 @@ var indentationFilter = [
 
 var copyrightFilter = [
 	'**',
+	'!**/*.desktop',
 	'!**/*.json',
 	'!**/*.html',
+	'!**/*.template',
 	'!**/test/**',
 	'!**/*.md',
 	'!**/*.bat',

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:build/gulpfile.vscode.js
code:
@@ -13,10 +13,12 @@ var azure = require('gulp-azure-storage');
 var electron = require('gulp-atom-electron');
 var symdest = require('gulp-symdest');
 var rename = require('gulp-rename');
+var replace = require('gulp-replace');
 var filter = require('gulp-filter');
 var json = require('gulp-json-editor');
 var insert = require('gulp-insert');
 var remote = require('gulp-remote-src');
+var shell = require("gulp-shell");
 var File = require('vinyl');
 var rimraf = require('rimraf');
 var _ = require('underscore');
@@ -215,7 +217,7 @@ function packageTask(platform, arch, opts) {
 			.pipe(util.cleanNodeModule('native-keymap', ['binding.gyp', 'build/**', 'src/**', 'deps/**'], true))
 			.pipe(util.cleanNodeModule('weak', ['binding.gyp', 'build/**', 'src/**'], true));
 
-		var resources = gulp.src('resources/*', { base: '.' });
+		var resources = gulp.src(['resources/*','resources/common/**'], { base: '.' });
 
 		if (platform === 'win32') {
 			resources = es.merge(resources, gulp.src('resources/win32/code_file.ico', { base: '.' }));
@@ -257,11 +259,88 @@ function packageTask(platform, arch, opts) {
 	};
 }
 
+function getFolderSize(root) {
+	var size = 0;
+	var paths = [root];
+	while (paths.length > 0) {
+		var current = path.normalize(paths.pop());
+		var stat = fs.statSync(current);
+		size += stat.size;
+		if (stat.isDirectory()) {
+			var newPaths = fs.readdirSync(current);
+			newPaths.forEach(function(newPath) {
+				paths.push(path.join(current, newPath));
+			});
+		}
+	}
+	return size;
+}
+
+function getDebPackageArch(arch) {
+	if (arch === 'x64')
+		return 'amd64'
+	if (arch === 'ia32')
+		return 'i386';
+	return undefined;
+}
+
+function prepareDebPackage(arch) {
+	var binaryDir = '../VSCode-linux-' + arch;
+	var debArch = getDebPackageArch(arch);
+	var destination = './out-linux/vscode-' + debArch;
+	var packageRevision = '1';
+
+	return function () {
+		var shortcut = gulp.src('resources/common/bin/code.sh', { base: '.' })
+			.pipe(rename(function (p) {
+				p.extname = ''
+				p.dirname = 'usr/bin';
+			}));
+
+		var desktop = gulp.src('resources/linux/debian/code.desktop', { base: '.' })
+			.pipe(rename(function (p) { p.dirname = 'usr/share/applications'; }));
+
+		var icon = gulp.src('resources/linux/code.png', { base: '.' })
+			.pipe(rename(function (p) { p.dirname = 'usr/share/pixmaps'; }));
+
+		var installedSize = Math.ceil(getFolderSize(root + '/' + binaryDir) / 1024);
+
+		var control = gulp.src('resources/linux/debian/control.template', { base: '.' })
+			.pipe(replace('@@VERSION@@', packageJson.version + '-' + packageRevision))
+			.pipe(replace('@@ARCHITECTURE@@', debArch))
+			.pipe(replace('@@INSTALLEDSIZE@@', installedSize))
+			.pipe(rename(function (p) {
+				p.extname = '';
+				p.dirname = 'DEBIAN';
+			}));
+
+		var all = es.merge(
+			control,
+			desktop,
+			icon,
+			shortcut);
+
+		all.pipe(symdest(destination));
+
+		var binaryResult = gulp.src(binaryDir + '/**/*', { base: binaryDir })
+			.pipe(gulp.dest(destination + '/usr/share/code'));
+
+		return es.merge(all, binaryResult);
+	};
+}
+
+function buildDebPackage(arch) {
+	var debArch = getDebPackageArch(arch);
+	return shell.task(['fakeroot dpkg-deb -b ' + path.join(root, 'out-linux', 'vscode-' + debArch)]);
+}
+
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
 gulp.task('clean-vscode-darwin', util.rimraf(path.join(path.dirname(root), 'VSCode-darwin')));
 gulp.task('clean-vscode-linux-ia32', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-ia32')));
 gulp.task('clean-vscode-linux-x64', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-x64')));
 gulp.task('clean-vscode-linux-arm', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-arm')));
+gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('out-linux/vscode-i386*'));
+gulp.task('clean-vscode-linux-x64-deb', util.rimraf('out-linux/vscode-amd64*'));
 
 gulp.task('vscode-win32', ['optimize-vscode', 'clean-vscode-win32'], packageTask('win32'));
 gulp.task('vscode-darwin', ['optimize-vscode', 'clean-vscode-darwin'], packageTask('darwin'));
@@ -275,6 +354,12 @@ gulp.task('vscode-linux-ia32-min', ['minify-vscode', 'clean-vscode-linux-ia32'],
 gulp.task('vscode-linux-x64-min', ['minify-vscode', 'clean-vscode-linux-x64'], packageTask('linux', 'x64', { minified: true }));
 gulp.task('vscode-linux-arm-min', ['minify-vscode', 'clean-vscode-linux-arm'], packageTask('linux', 'arm', { minified: true }));
 
+gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vscode-linux-ia32'], prepareDebPackage('ia32'));
+gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb'/*, 'vscode-linux-x64'*/], prepareDebPackage('x64'));
+gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
+gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
+gulp.task('vscode-linux-packages', ['vscode-linux-ia32-build-deb', 'vscode-linux-x64-build-deb']);
+
 // Sourcemaps
 
 gulp.task('vscode-sourcemaps', ['minify-vscode'], function () {
@@ -285,4 +370,4 @@ gulp.task('vscode-sourcemaps', ['minify-vscode'], function () {
 			container: 'sourcemaps',
 			prefix: commit + '/'
 		}));
-});
\ No newline at end of file
+});

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:package.json
code:
@@ -57,6 +57,8 @@
     "gulp-mocha": "^2.1.3",
     "gulp-remote-src": "^0.4.0",
     "gulp-rename": "^1.2.0",
+    "gulp-replace": "^0.5.4",
+    "gulp-shell": "^0.5.2",
     "gulp-sourcemaps": "^1.6.0",
     "gulp-symdest": "^1.0.0",
     "gulp-tsb": "^1.10.1",

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:resources/common/bin/code.sh
code:
@@ -25,7 +25,7 @@ else
 	fi
 fi
 
-VSCODE_LAUNCHER="$VSCODE_DIR/launcher.js"
+VSCODE_LAUNCHER="$VSCODE_DIR/resources/app/resources/common/bin/launcher.js"
 
 ATOM_SHELL_INTERNAL_RUN_AS_NODE=1 VSCODE_PATH="$VSCODE_DIR/$ELECTRON_FILE" \
 	"$VSCODE_DIR/$ELECTRON_FILE" $VSCODE_LAUNCHER "$@"

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:resources/linux/debian/code.desktop
code:
@@ -0,0 +1,10 @@
+[Desktop Entry]
+Name=Visual Studio Code
+Comment=Code Editing. Redefined.
+GenericName=Text Editor
+Exec=/usr/bin/code %U
+Icon=code
+Type=Application
+StartupNotify=true
+Categories=Utility;TextEditor;Development;IDE;
+MimeType=text/plain;
\ No newline at end of file

author:joaomoreno
date:2016-02-12T09:00:32Z
title:Merge branch '2679_deb_package' of https://github.com/Tyriar/vscode into Tyriar-2679_deb_package
filename:resources/linux/debian/control.template
code:
@@ -0,0 +1,10 @@
+Package: visual-studio-code
+Version: @@VERSION@@
+Section: devel
+Priority: optional
+Architecture: @@ARCHITECTURE@@
+Maintainer: Microsoft Corporation <vscode-linux@microsoft.com>
+Homepage: https://github.com/Microsoft/vscode
+Installed-Size: @@INSTALLEDSIZE@@
+Description: Code Editing. Redefined.
+ Build and debug modern web and cloud applications.

author:Tyriar
date:2016-02-12T21:36:00Z
title:Add git as a package dependency
filename:resources/linux/debian/control.template
code:
@@ -1,5 +1,6 @@
 Package: visual-studio-@@NAME@@
 Version: @@VERSION@@
+Depends: git
 Section: devel
 Priority: optional
 Architecture: @@ARCHITECTURE@@

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:appveyor.yml
code:
@@ -1,5 +1,5 @@
 environment:
-  ELECTRON_RUN_AS_NODE: 1
+  ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1
 
 install:
   - ps: Install-Product node 4.1.1 x64

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.common.js
code:
@@ -15,6 +15,8 @@ var File = require('vinyl');
 var underscore = require('underscore');
 var bundle = require('./lib/bundle');
 var util = require('./lib/util');
+var root = path.dirname(__dirname);
+var commit = util.getVersion(root);
 
 var tsOptions = {
 	target: 'ES5',
@@ -243,6 +245,9 @@ exports.minifyTask = function (src, addSourceMapsComment) {
 			.pipe(minifyCSS())
 			.pipe(cssFilter.restore)
 			.pipe(sourcemaps.write('./', {
+				sourceMappingURL: function (file) {
+					return 'https://ticino.blob.core.windows.net/sourcemaps/' + commit + '/' + file.relative + '.map';
+				},
 				sourceRoot: null,
 				includeContent: true,
 				addComment: addSourceMapsComment

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -95,7 +95,7 @@ gulp.task('optimize-vscode', ['clean-optimized-vscode', 'compile-build', 'compil
 }));
 
 gulp.task('clean-minified-vscode', util.rimraf('out-vscode-min'));
-gulp.task('minify-vscode', ['clean-minified-vscode', 'optimize-vscode'], common.minifyTask('out-vscode', false));
+gulp.task('minify-vscode', ['clean-minified-vscode', 'optimize-vscode'], common.minifyTask('out-vscode', true));
 
 // Package
 var product = require('../product.json');
@@ -341,7 +341,7 @@ gulp.task('vscode-linux-packages', ['vscode-linux-ia32-build-deb', 'vscode-linux
 
 // Sourcemaps
 
-gulp.task('vscode-sourcemaps', ['minify-vscode'], function () {
+gulp.task('upload-vscode-sourcemaps', ['minify-vscode'], function () {
 	return gulp.src('out-vscode-min/**/*.map')
 		.pipe(azure.upload({
 			account: process.env.AZURE_STORAGE_ACCOUNT,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/json/src/jsonMain.ts
code:
@@ -30,7 +30,7 @@ export function activate(context: ExtensionContext) {
 	// The server is implemented in node
 	let serverModule = context.asAbsolutePath(path.join('server', 'out', 'server.js'));
 	// The debug options for the server
-	let debugOptions = { execArgv: ["--nolazy", "--debug=6004"] };
+	let debugOptions = { execArgv: ['--nolazy', '--debug=6004'] };
 
 	// If the extension is launch in debug mode the debug server options are use
 	// Otherwise the run options are used

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/node-debug/node-debug.azure.json
code:
@@ -1,6 +1,6 @@
 {
 	"account": "monacobuild",
 	"container": "debuggers",
-	"zip": "e740544/node-debug.zip",
+	"zip": "9105842/node-debug.zip",
 	"output": ""
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/powershell/powershell.configuration.json
code:
@@ -9,16 +9,14 @@
 		["(", ")"]
 	]
 
-	/*
-	enhancedBrackets: [
-				{ tokenType:'string', openTrigger: '"', open: /@"$/, closeComplete: '"@' },
-				{ tokenType:'string', openTrigger: '\'', open: /@'$/, closeComplete: '\'@' },
-				{ tokenType:'string', openTrigger: '"', open: /"$/, closeComplete: '"' },
-				{ tokenType: 'string', openTrigger: '\'', open: /'$/, closeComplete: '\'' }
-	],
+	// enhancedBrackets: [
+	// 			{ tokenType:'string', openTrigger: '"', open: /@"$/, closeComplete: '"@' },
+	// 			{ tokenType:'string', openTrigger: '\'', open: /@'$/, closeComplete: '\'@' },
+	// 			{ tokenType:'string', openTrigger: '"', open: /"$/, closeComplete: '"' },
+	// 			{ tokenType: 'string', openTrigger: '\'', open: /'$/, closeComplete: '\'' }
+	// ],
 
-	autoClosingPairs: [['{', '}'], ['[', ']'], ['(', ')']],	// Defined explicitly, to suppress the
-															// default auto-closing of ' and " which is
-															// override above by enhancedBrackets
-	*/
+	// autoClosingPairs: [['{', '}'], ['[', ']'], ['(', ')']],	// Defined explicitly, to suppress the
+	// 														// default auto-closing of ' and " which is
+	// 														// override above by enhancedBrackets
 }
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/shellscript/package.json
code:
@@ -7,9 +7,10 @@
 		"languages": [{
 			"id": "shellscript",
 			"aliases": ["Shell Script (Bash)", "shellscript"],
-			"extensions": [".sh", ".bash", ".zsh", ".bashrc", ".bash_profile", ".bash_login", ".profile", ".bash_logout"],
+			"extensions": [".sh", ".bash", ".bashrc", ".bash_profile", ".bash_login", ".profile", ".bash_logout", ".zsh", ".zshrc"],
 			"firstLine": "^#!.*\\b(bash|zsh|sh|tcsh)|^#\\s*-\\*-[^*]*mode:\\s*shell-script[^*]*-\\*-",
-			"configuration": "./shellscript.configuration.json"
+			"configuration": "./shellscript.configuration.json",
+			"mimetypes": ["text/x-shellscript"]
 		}],
 		"grammars": [{
 			"language": "shellscript",

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/sql/sql.configuration.json
code:
@@ -8,12 +8,11 @@
 		["[", "]"],
 		["(", ")"]
 	]
-	/*
-	enhancedBrackets:[
-		{ openTrigger: 'n', open: /begin$/i, closeComplete: 'end', matchCase: true },
-		{ openTrigger: 'e', open: /case$/i, closeComplete: 'end', matchCase: true },
-		{ openTrigger: 'n', open: /when$/i, closeComplete: 'then', matchCase: true }
-	],
-	noindentBrackets: '()',
-	*/
+
+	// enhancedBrackets:[
+	// 	{ openTrigger: 'n', open: /begin$/i, closeComplete: 'end', matchCase: true },
+	// 	{ openTrigger: 'e', open: /case$/i, closeComplete: 'end', matchCase: true },
+	// 	{ openTrigger: 'n', open: /when$/i, closeComplete: 'then', matchCase: true }
+	// ],
+	// noindentBrackets: '()',
 }
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/package.json
code:
@@ -56,17 +56,17 @@
 		],
 		"configuration": {
 			"type": "object",
-			"title": "TypeScript configuration",
+			"title": "%configuration.typescript%",
 			"properties": {
 				"typescript.useCodeSnippetsOnMethodSuggest": {
 					"type": "boolean",
 					"default": false,
-					"description": "Complete functions with their parameter signature."
+					"description": "%typescript.useCodeSnippetsOnMethodSuggest.dec%"
 				},
 				"typescript.tsdk": {
 					"type": ["string", "null"],
 					"default": null,
-					"description": "Specifies the folder path containing the tsserver and lib*.d.ts files to use."
+					"description": "%typescript.tsdk.desc%"
 				}
 			}
 		},
@@ -78,7 +78,7 @@
 		"commands": [
 			{
 				"command": "typescript.reloadProjects",
-				"title": "Reload Projects",
+				"title": "%typescript.reloadProjects.title%",
 				"category": "TypeScript"
 			}
 		],

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/package.nls.json
code:
@@ -0,0 +1,6 @@
+{
+	"typescript.reloadProjects.title": "Reload Project",
+	"configuration.typescript": "TypeScript configuration",
+	"typescript.useCodeSnippetsOnMethodSuggest.dec": "Complete functions with their parameter signature.",
+	"typescript.tsdk.desc": "Specifies the folder path containing the tsserver and lib*.d.ts files to use."
+}
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/utils/electron.ts
code:
@@ -47,7 +47,7 @@ function generatePatchedEnv(env:any, stdInPipeName:string, stdOutPipeName:string
 
 	newEnv['STDIN_PIPE_NAME'] = stdInPipeName;
 	newEnv['STDOUT_PIPE_NAME'] = stdOutPipeName;
-	newEnv['ELECTRON_RUN_AS_NODE'] = '1';
+	newEnv['ATOM_SHELL_INTERNAL_RUN_AS_NODE'] = '1';
 
 	return newEnv;
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/utils/electronForkStart.ts
code:
@@ -29,7 +29,7 @@ var stdOutPipeName = process.env['STDOUT_PIPE_NAME'];
 
 log('STDIN_PIPE_NAME: ' + stdInPipeName);
 log('STDOUT_PIPE_NAME: ' + stdOutPipeName);
-log('ELECTRON_RUN_AS_NODE: ' + process.env['ELECTRON_RUN_AS_NODE']);
+log('ATOM_SHELL_INTERNAL_RUN_AS_NODE: ' + process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE']);
 
 // stdout redirection to named pipe
 (function() {
@@ -134,7 +134,7 @@ log('ELECTRON_RUN_AS_NODE: ' + process.env['ELECTRON_RUN_AS_NODE']);
 		// Unset the custom environmental variables that should not get inherited
 		delete process.env['STDIN_PIPE_NAME'];
 		delete process.env['STDOUT_PIPE_NAME'];
-		delete process.env['ELECTRON_RUN_AS_NODE'];
+		delete process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE'];
 
 		require(program);
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/xml/xml.configuration.json
code:
@@ -6,16 +6,16 @@
 	"brackets": [
 		["<", ">"]
 	]
-	/*
-	enhancedBrackets: [{
-		tokenType: 'tag.tag-$1.xml',
-		openTrigger: '>',
-		open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
-		closeComplete: '</$1>',
-		closeTrigger: '>',
-		close: /<\/(\w[\w\d]*)\s*>$/i
-	}],
 
-	autoClosingPairs:  [['\'', '\''], ['"', '"'] ]
-	*/
+	// enhancedBrackets: [{
+	// 	tokenType: 'tag.tag-$1.xml',
+	// 	openTrigger: '>',
+	// 	open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
+	// 	closeComplete: '</$1>',
+	// 	closeTrigger: '>',
+	// 	close: /<\/(\w[\w\d]*)\s*>$/i
+	// }],
+
+	// autoClosingPairs:  [['\'', '\''], ['"', '"'] ]
+
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:extensions/xml/xsl.configuration.json
code:
@@ -6,16 +6,15 @@
 	"brackets": [
 		["<", ">"]
 	]
-	/*
-	enhancedBrackets: [{
-		tokenType: 'tag.tag-$1.xml',
-		openTrigger: '>',
-		open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
-		closeComplete: '</$1>',
-		closeTrigger: '>',
-		close: /<\/(\w[\w\d]*)\s*>$/i
-	}],
 
-	autoClosingPairs:  [['\'', '\''], ['"', '"'] ]
-	*/
+	// enhancedBrackets: [{
+	// 	tokenType: 'tag.tag-$1.xml',
+	// 	openTrigger: '>',
+	// 	open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
+	// 	closeComplete: '</$1>',
+	// 	closeTrigger: '>',
+	// 	close: /<\/(\w[\w\d]*)\s*>$/i
+	// }],
+
+	// autoClosingPairs:  [['\'', '\''], ['"', '"'] ]
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:package.json
code:
@@ -46,7 +46,7 @@
     "glob": "^5.0.13",
     "gulp": "^3.8.9",
     "gulp-atom-electron": "^1.4.0",
-    "gulp-azure-storage": "^0.3.0",
+    "gulp-azure-storage": "^0.6.0",
     "gulp-bom": "^1.0.0",
     "gulp-buffer": "0.0.2",
     "gulp-concat": "^2.6.0",

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:resources/darwin/bin/code.sh
code:
@@ -7,5 +7,5 @@ function realpath() { python -c "import os,sys; print os.path.realpath(sys.argv[
 CONTENTS="$(dirname "$(dirname "$(dirname "$(dirname "$(realpath "$0")")")")")"
 ELECTRON="$CONTENTS/MacOS/Electron"
 CLI="$CONTENTS/Resources/app/out/cli.js"
-ELECTRON_RUN_AS_NODE=1 "$ELECTRON" "$CLI" "$@"
+ATOM_SHELL_INTERNAL_RUN_AS_NODE=1 "$ELECTRON" "$CLI" "$@"
 exit $?
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:resources/linux/bin/code.sh
code:
@@ -7,5 +7,5 @@ NAME="@@NAME@@"
 VSCODE_PATH="/usr/share/$NAME"
 ELECTRON="$VSCODE_PATH/$NAME"
 CLI="$VSCODE_PATH/resources/app/out/cli.js"
-ELECTRON_RUN_AS_NODE=1 "$ELECTRON" "$CLI" "$@"
+ATOM_SHELL_INTERNAL_RUN_AS_NODE=1 "$ELECTRON" "$CLI" "$@"
 exit $?

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:resources/win32/bin/code.cmd
code:
@@ -1,6 +1,6 @@
 @echo off
 setlocal
 set VSCODE_DEV=
-set ELECTRON_RUN_AS_NODE=1
+set ATOM_SHELL_INTERNAL_RUN_AS_NODE=1
 "%~dp0..\\Code.exe" "%~dp0code.js" %*
 endlocal
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:resources/win32/bin/code.js
code:
@@ -1,3 +1,3 @@
-delete process.env['ELECTRON_RUN_AS_NODE'];
+delete process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE'];
 require('child_process').spawn(require('path').resolve(__dirname, '..', 'Code.exe'), process.argv.slice(2), { detached: true, stdio: 'ignore' });
 process.exit(0);
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:scripts/test.bat
code:
@@ -1,6 +1,6 @@
 @echo off
 
-set ELECTRON_RUN_AS_NODE=1
+set ATOM_SHELL_INTERNAL_RUN_AS_NODE=1
 
 pushd %~dp0\..
 .\.build\electron\electron.exe .\node_modules\mocha\bin\_mocha %*

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:scripts/test.sh
code:
@@ -10,11 +10,11 @@ fi
 
 # Unit Tests
 if [[ "$OSTYPE" == "darwin"* ]]; then
-	cd $ROOT ; ulimit -n 4096 ; ELECTRON_RUN_AS_NODE=1 \
+	cd $ROOT ; ulimit -n 4096 ; ATOM_SHELL_INTERNAL_RUN_AS_NODE=1 \
 		./.build/electron/Electron.app/Contents/MacOS/Electron \
 		node_modules/mocha/bin/_mocha $*
 else
-	cd $ROOT ; ELECTRON_RUN_AS_NODE=1 \
+	cd $ROOT ; ATOM_SHELL_INTERNAL_RUN_AS_NODE=1 \
 		./.build/electron/electron \
 		node_modules/mocha/bin/_mocha $*
 fi

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/main.js
code:
@@ -24,18 +24,19 @@ function getNLSConfiguration() {
 	}
 
 	if (locale === 'pseudo') {
-		return { availableLanguages: {}, pseudo: true }
+		return { locale: locale, availableLanguages: {}, pseudo: true }
 	}
+	locale = locale || app.getLocale();
+	var initialLocale = locale;
 	if (process.env.VSCODE_DEV) {
-		return { availableLanguages: {} };
+		return { locale: locale, availableLanguages: {} };
 	}
 	// We have a built version so we have extracted nls file. Try to find
 	// the right file to use.
-	locale = locale || app.getLocale();
 	while (locale) {
 		var candidate = path.join(__dirname, 'main.nls.') + locale + '.js';
 		if (fs.existsSync(candidate)) {
-			return { availableLanguages: { '*': locale } };
+			return { locale: initialLocale, availableLanguages: { '*': locale } };
 		} else {
 			var index = locale.lastIndexOf('-');
 			if (index > 0) {
@@ -46,7 +47,7 @@ function getNLSConfiguration() {
 		}
 	}
 
-	return { availableLanguages: {} };
+	return { locale: initialLocale, availableLanguages: {} };
 }
 
 // Change cwd if given via env variable

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/typings/node.d.ts
code:
@@ -496,6 +496,7 @@ declare module "os" {
     export function freemem(): number;
     export function cpus(): { model: string; speed: number; times: { user: number; nice: number; sys: number; idle: number; irq: number; }; }[];
     export function networkInterfaces(): any;
+		export function homedir(): string;
     export var EOL: string;
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/keyboardEvent.ts
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-"use strict";
+'use strict';
 
 import * as Platform from 'vs/base/common/platform';
 import * as Browser from 'vs/base/browser/browser';

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/keyCodes.ts
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-"use strict";
+'use strict';
 
 import * as nls from 'vs/nls';
 import * as defaultPlatform from 'vs/base/common/platform';
@@ -561,10 +561,10 @@ export class Keybinding {
 	private static _cachedKeybindingRegex: string = null;
 	public static getUserSettingsKeybindingRegex(): string {
 		if (!this._cachedKeybindingRegex) {
-			let numpadKey = "numpad(0|1|2|3|4|5|6|7|8|9|_multiply|_add|_subtract|_decimal|_divide|_separator)";
-			let oemKey = "`|\\-|=|\\[|\\]|\\\\\\\\|;|'|,|\\.|\\/|oem_8|oem_102";
-			let specialKey = "left|up|right|down|pageup|pagedown|end|home|tab|enter|escape|space|backspace|delete|pausebreak|capslock|insert|contextmenu|numlock|scrolllock";
-			let casualKey = "[a-z]|[0-9]|f(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19)";
+			let numpadKey = 'numpad(0|1|2|3|4|5|6|7|8|9|_multiply|_add|_subtract|_decimal|_divide|_separator)';
+			let oemKey = '`|\\-|=|\\[|\\]|\\\\\\\\|;|\'|,|\\.|\\/|oem_8|oem_102';
+			let specialKey = 'left|up|right|down|pageup|pagedown|end|home|tab|enter|escape|space|backspace|delete|pausebreak|capslock|insert|contextmenu|numlock|scrolllock';
+			let casualKey = '[a-z]|[0-9]|f(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19)';
 			let key = '((' + [numpadKey, oemKey, specialKey, casualKey].join(')|(') + '))';
 			let mod = '((ctrl|shift|alt|cmd|win|meta)\\+)*';
 			let keybinding = '(' + mod + key + ')';

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/remote.ts
code:
@@ -15,23 +15,5 @@ export interface IProxyHelper {
 }
 
 export interface IRemoteCom extends IProxyHelper {
-	registerBigHandler(handler:IManyHandler): void;
-}
-
-export function createProxyFromCtor(remote:IProxyHelper, id:string, ctor:Function): any {
-	var result: any = {
-		$__IS_REMOTE_OBJ: true
-	};
-	for (var prop in ctor.prototype) {
-		if (typeof ctor.prototype[prop] === 'function') {
-			result[prop] = createMethodProxy(remote, id, prop);
-		}
-	}
-	return result;
-}
-
-function createMethodProxy(remote:IProxyHelper, proxyId: string, path: string): (...myArgs: any[]) => TPromise<any> {
-	return (...myArgs: any[]) => {
-		return remote.callOnRemote(proxyId, path, myArgs);
-	};
+	setManyHandler(handler:IManyHandler): void;
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/strings.ts
code:
@@ -179,7 +179,7 @@ export function endsWith(haystack: string, needle: string): boolean {
 	}
 }
 
-export function createRegExp(searchString: string, isRegex: boolean, matchCase: boolean, wholeWord: boolean): RegExp {
+export function createRegExp(searchString: string, isRegex: boolean, matchCase: boolean, wholeWord: boolean, global:boolean): RegExp {
 	if (searchString === '') {
 		throw new Error('Cannot create regex from empty string');
 	}
@@ -194,7 +194,10 @@ export function createRegExp(searchString: string, isRegex: boolean, matchCase:
 			searchString = searchString + '\\b';
 		}
 	}
-	let modifiers = 'g';
+	let modifiers = '';
+	if (global) {
+		modifiers += 'g';
+	}
 	if (!matchCase) {
 		modifiers += 'i';
 	}
@@ -213,7 +216,7 @@ export function createSafeRegExp(searchString:string, isRegex:boolean, matchCase
 		// Try to create a RegExp out of the params
 		var regex:RegExp = null;
 		try {
-			regex = createRegExp(searchString, isRegex, matchCase, wholeWord);
+			regex = createRegExp(searchString, isRegex, matchCase, wholeWord, true);
 		} catch (err) {
 			return null;
 		}
@@ -233,7 +236,7 @@ export function createSafeRegExp(searchString:string, isRegex:boolean, matchCase
 export function regExpLeadsToEndlessLoop(regexp: RegExp): boolean {
 	// Exit early if it's one of these special cases which are meant to match
 	// against an empty string
-	if (regexp.source === "^" || regexp.source === "^$" || regexp.source === "$") {
+	if (regexp.source === '^' || regexp.source === '^$' || regexp.source === '$') {
 		return false;
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/winjs.base.d.ts
code:
@@ -76,9 +76,15 @@ export declare class TPromise<V> {
 	constructor(init:(complete: TValueCallback<V>, error:(err:any)=>void, progress:ProgressCallback)=>void, oncancel?: any);
 
 	public then<U>(success?: (value:V)=>TPromise<U>, error?: (err:any)=>TPromise<U>, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>TPromise<U>, error?: (err:any)=>TPromise<U>|U, progress?:ProgressCallback): TPromise<U>;
 	public then<U>(success?: (value:V)=>TPromise<U>, error?: (err:any)=>U, progress?:ProgressCallback): TPromise<U>;
 	public then<U>(success?: (value:V)=>TPromise<U>, error?: (err:any)=>void, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>TPromise<U>|U, error?: (err:any)=>TPromise<U>, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>TPromise<U>|U, error?: (err:any)=>TPromise<U>|U, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>TPromise<U>|U, error?: (err:any)=>U, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>TPromise<U>|U, error?: (err:any)=>void, progress?:ProgressCallback): TPromise<U>;
 	public then<U>(success?: (value:V)=>U, error?: (err:any)=>TPromise<U>, progress?:ProgressCallback): TPromise<U>;
+	public then<U>(success?: (value:V)=>U, error?: (err:any)=>TPromise<U>|U, progress?:ProgressCallback): TPromise<U>;
 	public then<U>(success?: (value:V)=>U, error?: (err:any)=>U, progress?:ProgressCallback): TPromise<U>;
 	public then<U>(success?: (value:V)=>U, error?: (err:any)=>void, progress?:ProgressCallback): TPromise<U>;
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerProtocol.ts
code:
@@ -93,7 +93,7 @@ export class RemoteCom implements remote.IRemoteCom {
 		});
 	}
 
-	public registerBigHandler(handler:remote.IManyHandler): void {
+	public setManyHandler(handler:remote.IManyHandler): void {
 		this._bigHandler = handler;
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/aiAdapter.ts
code:
@@ -0,0 +1,154 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import types = require('vs/base/common/types');
+import {safeStringify} from 'vs/base/common/objects';
+
+import appInsights = require('applicationinsights');
+
+export interface IAIAdapter {
+	log(eventName: string, data?: any): void;
+	logException(exception: any): void;
+	dispose(): void;
+}
+
+export class AIAdapter implements IAIAdapter {
+
+	private appInsights: typeof appInsights.client;
+
+	constructor(
+		private aiKey: string,
+		private eventPrefix: string,
+		/* for test only */
+		client?: any
+	) {
+		// for test
+		if (client) {
+			this.appInsights = client;
+			return;
+		}
+
+		if (aiKey) {
+			// if another client is already initialized
+			if (appInsights.client) {
+					this.appInsights = appInsights.getClient(aiKey);
+					// no other way to enable offline mode
+					this.appInsights.channel.setOfflineMode(true);
+
+			} else {
+				this.appInsights = appInsights.setup(aiKey)
+						.setAutoCollectRequests(false)
+						.setAutoCollectPerformance(false)
+						.setAutoCollectExceptions(false)
+						.setOfflineMode(true)
+						.start()
+						.client;
+			}
+
+
+			if(aiKey.indexOf('AIF-') === 0) {
+				this.appInsights.config.endpointUrl = 'https://vortex.data.microsoft.com/collect/v1';
+			}
+
+			this.setupAIClient(this.appInsights);
+		}
+	}
+
+	private setupAIClient(client: typeof appInsights.client): void {
+		//prevent App Insights from reporting machine name
+		if (client && client.context &&
+			client.context.keys && client.context.tags) {
+			var machineNameKey = client.context.keys.deviceMachineName;
+			client.context.tags[machineNameKey] = '';
+		}
+	}
+
+	private getData(data?: any): any {
+		var properties: {[key: string]: string;} = {};
+		var measurements: {[key: string]: number;} = {};
+
+		var event_data = this.flaten(data);
+		for(var prop in event_data) {
+			// enforce property names less than 150 char, take the last 150 char
+			var propName = prop && prop.length > 150 ? prop.substr( prop.length - 149) : prop;
+			var property = event_data[prop];
+			if (types.isNumber(property)) {
+				measurements[propName] = property;
+
+			} else if (types.isBoolean(property)) {
+				measurements[propName] = property ? 1:0;
+			} else if (types.isString(property)) {
+				//enforce proeprty value to be less than 1024 char, take the first 1024 char
+				var propValue = property && property.length > 1024 ? property.substring(0, 1023): property;
+				properties[propName] = propValue;
+			} else if (!types.isUndefined(property) && property !== null) {
+				properties[propName] = property;
+			}
+		}
+
+		return {
+			properties: properties,
+			measurements: measurements
+		};
+	}
+
+	private flaten(obj:any, order:number = 0, prefix? : string): any {
+		var result:{[key:string]: any} = {};
+		var properties = obj ? Object.getOwnPropertyNames(obj) : [];
+		for (var i =0; i < properties.length; i++) {
+			var item = properties[i];
+			var index = prefix ? prefix + item : item;
+
+			if (types.isArray(obj[item])) {
+				try {
+					result[index] = safeStringify(obj[item]);
+				} catch (e) {
+					// workaround for catching the edge case for #18383
+					// safe stringfy should never throw circular object exception
+					result[index] = '[Circular-Array]';
+				}
+			} else if (obj[item] instanceof Date) {
+				result[index] = (<Date> obj[item]).toISOString();
+			} else if (types.isObject(obj[item])) {
+				if (order < 2) {
+					var item_result = this.flaten(obj[item], order + 1, index + '.');
+					for (var prop in item_result) {
+						result[prop] = item_result[prop];
+					}
+				} else {
+					try {
+						result[index] = safeStringify(obj[item]);
+					} catch (e) {
+						// workaround for catching the edge case for #18383
+						// safe stringfy should never throw circular object exception
+						result[index] = '[Circular]';
+					}
+				}
+			} else {
+				result[index] = obj[item];
+			}
+		}
+		return result;
+	}
+
+	public log(eventName: string, data?: any): void {
+		var result = this.getData(data);
+
+		if (this.appInsights) {
+			this.appInsights.trackEvent(this.eventPrefix+'/'+eventName, result.properties, result.measurements);
+		}
+	}
+
+	public logException(exception: any): void {
+		if (this.appInsights) {
+			this.appInsights.trackException(exception);
+		}
+	}
+
+	public dispose(): void {
+		this.appInsights = null;
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/pfs.ts
code:
@@ -80,6 +80,10 @@ export function stat(path: string): TPromise<fs.Stats> {
 	return nfcall(fs.stat, path);
 }
 
+export function lstat(path: string): TPromise<fs.Stats> {
+	return nfcall(fs.lstat, path);
+}
+
 export function mstat(paths: string[]): TPromise<{ path: string; stats: fs.Stats; }> {
 	return doStatMultiple(paths.slice(0));
 }
@@ -96,6 +100,14 @@ export function unlink(path: string): Promise {
 	return nfcall(fs.unlink, path);
 }
 
+export function symlink(target: string, path: string, type?: string): TPromise<void> {
+	return nfcall<void>(fs.symlink, target, path, type);
+}
+
+export function readlink(path: string): TPromise<string> {
+	return nfcall<string>(fs.readlink, path);
+}
+
 function doStatMultiple(paths: string[]): TPromise<{ path: string; stats: fs.Stats; }> {
 	let path = paths.shift();
 	return stat(path).then((value) => {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/stdFork.ts
code:
@@ -48,7 +48,7 @@ function generatePatchedEnv(env:any, stdInPipeName:string, stdOutPipeName:string
 
 	newEnv['STDIN_PIPE_NAME'] = stdInPipeName;
 	newEnv['STDOUT_PIPE_NAME'] = stdOutPipeName;
-	newEnv['ELECTRON_RUN_AS_NODE'] = '1';
+	newEnv['ATOM_SHELL_INTERNAL_RUN_AS_NODE'] = '1';
 
 	return newEnv;
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/stdForkStart.js
code:
@@ -31,7 +31,7 @@ var stdOutPipeName = process.env['STDOUT_PIPE_NAME'];
 
 log('STDIN_PIPE_NAME: ' + stdInPipeName);
 log('STDOUT_PIPE_NAME: ' + stdOutPipeName);
-log('ELECTRON_RUN_AS_NODE: ' + process.env['ELECTRON_RUN_AS_NODE']);
+log('ATOM_SHELL_INTERNAL_RUN_AS_NODE: ' + process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE']);
 
 // stdout redirection to named pipe
 (function() {
@@ -136,7 +136,7 @@ log('ELECTRON_RUN_AS_NODE: ' + process.env['ELECTRON_RUN_AS_NODE']);
 		// Unset the custom environmental variables that should not get inherited
 		delete process.env['STDIN_PIPE_NAME'];
 		delete process.env['STDOUT_PIPE_NAME'];
-		delete process.env['ELECTRON_RUN_AS_NODE'];
+		delete process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE'];
 
 		require(program);
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/node/aiAdapter/aiAdapter.test.ts
code:
@@ -0,0 +1,135 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as assert from 'assert';
+import { AIAdapter } from 'vs/base/node/aiAdapter';
+
+interface IAppInsightsEvent {
+	eventName: string;
+	properties?: {string?: string;};
+	measurements?: {string?: number;}
+}
+
+class AppInsightsMock {
+
+	public events: IAppInsightsEvent[]=[];
+	public IsTrackingPageView: boolean = false;
+	public exceptions: any[] =[];
+
+	public trackEvent(eventName: string, properties?: {string?: string;}, measurements?: {string?: number;}): void {
+		this.events.push({
+			eventName: eventName,
+			properties: properties,
+			measurements: measurements
+		});
+	}
+	public trackPageView(): void {
+		this.IsTrackingPageView = true;
+	}
+
+	public trackException(exception: any): void {
+		this.exceptions.push(exception);
+	}
+}
+
+suite('AIAdapter', () => {
+	var appInsightsMock: AppInsightsMock;
+	var adapter: AIAdapter;
+	var prefix = 'prefix';
+
+	setup(() => {
+		appInsightsMock = new AppInsightsMock();
+		adapter = new AIAdapter(null, prefix, appInsightsMock);
+	});
+
+	teardown(() => {
+		adapter.dispose();
+	});
+
+	test('Simple event', () => {
+		adapter.log('testEvent');
+
+		assert.equal(appInsightsMock.events.length, 1);
+		assert.equal(appInsightsMock.events[0].eventName, `${prefix}/testEvent`);
+	});
+
+	test('Track UnhandledError as exception and events', () => {
+		var sampleError = new Error('test');
+
+		adapter.logException(sampleError);
+		assert.equal(appInsightsMock.exceptions.length, 1);
+	});
+
+	test('property limits', () => {
+		var reallyLongPropertyName = 'abcdefghijklmnopqrstuvwxyz';
+		for (var i =0; i <6; i++) {
+			reallyLongPropertyName +='abcdefghijklmnopqrstuvwxyz';
+		}
+		assert(reallyLongPropertyName.length > 150);
+
+		var reallyLongPropertyValue = 'abcdefghijklmnopqrstuvwxyz012345678901234567890123';
+		for (var i =0; i <21; i++) {
+			reallyLongPropertyValue +='abcdefghijklmnopqrstuvwxyz012345678901234567890123';
+		}
+		assert(reallyLongPropertyValue.length > 1024);
+
+		var data = {};
+		data[reallyLongPropertyName] = '1234';
+		data['reallyLongPropertyValue'] = reallyLongPropertyValue;
+		adapter.log('testEvent', data);
+
+		assert.equal(appInsightsMock.events.length, 1);
+
+		for (var prop in appInsightsMock.events[0].properties){
+			assert(prop.length < 150);
+			assert(appInsightsMock.events[0].properties[prop].length <1024);
+		}
+	});
+
+	test('Different data types', () => {
+		var date = new Date();
+		adapter.log('testEvent', { favoriteDate: date, likeRed: false, likeBlue: true, favoriteNumber:1,  favoriteColor: 'blue', favoriteCars: ['bmw', 'audi', 'ford']});
+
+		assert.equal(appInsightsMock.events.length, 1);
+		assert.equal(appInsightsMock.events[0].eventName, `${prefix}/testEvent`);
+		assert.equal(appInsightsMock.events[0].properties['favoriteColor'], 'blue');
+		assert.equal(appInsightsMock.events[0].measurements['likeRed'], 0);
+		assert.equal(appInsightsMock.events[0].measurements['likeBlue'], 1);
+		assert.equal(appInsightsMock.events[0].properties['favoriteDate'], date.toISOString());
+		assert.equal(appInsightsMock.events[0].properties['favoriteCars'], JSON.stringify(['bmw', 'audi', 'ford']));
+		assert.equal(appInsightsMock.events[0].measurements['favoriteNumber'], 1);
+	});
+
+	test('Nested data', () => {
+		adapter.log('testEvent', {
+			window : {
+				title: 'some title',
+				measurements: {
+					width: 100,
+					height: 200
+				}
+			},
+			nestedObj: {
+				nestedObj2: {
+					nestedObj3: {
+						testProperty: 'test',
+					}
+				},
+				testMeasurement:1
+			}
+		});
+
+		assert.equal(appInsightsMock.events.length, 1);
+		assert.equal(appInsightsMock.events[0].eventName, `${prefix}/testEvent`);
+
+		assert.equal(appInsightsMock.events[0].properties['window.title'], 'some title');
+		assert.equal(appInsightsMock.events[0].measurements['window.measurements.width'], 100);
+		assert.equal(appInsightsMock.events[0].measurements['window.measurements.height'], 200);
+
+		assert.equal(appInsightsMock.events[0].properties['nestedObj.nestedObj2.nestedObj3'], JSON.stringify({"testProperty":"test"}));
+		assert.equal(appInsightsMock.events[0].measurements['nestedObj.testMeasurement'],1);
+	});
+});
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/standaloneSchemas.ts
code:
@@ -748,7 +748,7 @@ MonacoEditorSchemas['http://json.schemastore.org/tsconfig'] = {
 				},
 				'watch': {
 					'description': nls.localize('tsconfig.json.compilerOptions.watch', "Watch input files."),
-					"type": 'boolean'
+					'type': 'boolean'
 				},
 				'jsx': {
 					'description': nls.localize('tsconfig.json.compilerOptions.jsx', "Enable the JSX option (requires TypeScript 1.6):  'preserve', 'react'."),

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/viewCursors/viewCursors.ts
code:
@@ -177,11 +177,11 @@ export class ViewCursors extends ViewPart {
 		if (this._editorHasFocus) {
 			if (this._primaryCursor.getIsInEditableRange() && !this._context.configuration.editor.readOnly) {
 				switch (this._context.configuration.editor.cursorBlinking) {
-					case ("blink"):
+					case 'blink':
 						return RenderType.Blink;
-					case ("visible"):
+					case 'visible':
 						return RenderType.Visible;
-					case ("hidden"):
+					case 'hidden':
 						return RenderType.Hidden;
 					default:
 						return RenderType.Blink;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/widget/media/editor.css
code:
@@ -55,10 +55,12 @@
 
 /*.monaco-editor .inputarea {
 	position: fixed !important;
-	width: 200px !important;
+	width: 800px !important;
 	height: 200px !important;
 	top: initial !important;
+	left: initial !important;
 	bottom: 0 !important;
+	right: 0 !important;
 }*/
 
 .monaco-editor.ff .inputarea,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/cursorCollection.ts
code:
@@ -307,19 +307,21 @@ export class CursorCollection {
 	}
 
 	private getModeConfiguration(): IModeConfiguration {
-		var i: number;
+		let i: number;
 
-		var result: IModeConfiguration = {
+		let result: IModeConfiguration = {
 			electricChars: {},
 			autoClosingPairsOpen: {},
 			autoClosingPairsClose: {},
 			surroundingPairs: {}
 		};
 
-		var electricChars: string[];
-		if (this.model.getMode().electricCharacterSupport) {
+		let richEditSupport = this.model.getMode().richEditSupport;
+
+		let electricChars: string[];
+		if (richEditSupport && richEditSupport.electricCharacter) {
 			try {
-				electricChars = this.model.getMode().electricCharacterSupport.getElectricCharacters();
+				electricChars = richEditSupport.electricCharacter.getElectricCharacters();
 			} catch(e) {
 				Errors.onUnexpectedError(e);
 				electricChars = null;
@@ -331,10 +333,10 @@ export class CursorCollection {
 			}
 		}
 
-		var autoClosingPairs: IAutoClosingPair[];
-		if (this.model.getMode().characterPairSupport) {
+		let autoClosingPairs: IAutoClosingPair[];
+		if (richEditSupport && richEditSupport.characterPair) {
 			try {
-				autoClosingPairs = this.model.getMode().characterPairSupport.getAutoClosingPairs();
+				autoClosingPairs = richEditSupport.characterPair.getAutoClosingPairs();
 			} catch(e) {
 				Errors.onUnexpectedError(e);
 				autoClosingPairs = null;
@@ -347,10 +349,10 @@ export class CursorCollection {
 			}
 		}
 
-		var surroundingPairs: IAutoClosingPair[];
-		if (this.model.getMode().characterPairSupport) {
+		let surroundingPairs: IAutoClosingPair[];
+		if (richEditSupport && richEditSupport.characterPair) {
 			try {
-				surroundingPairs = this.model.getMode().characterPairSupport.getSurroundingPairs();
+				surroundingPairs = richEditSupport.characterPair.getSurroundingPairs();
 			} catch(e) {
 				Errors.onUnexpectedError(e);
 				surroundingPairs = null;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/oneCursor.ts
code:
@@ -1035,7 +1035,9 @@ export class OneCursorOp {
 			return false;
 		}
 
-		if(!cursor.model.getMode().characterPairSupport) {
+		let richEditSupport = cursor.model.getMode().richEditSupport;
+
+		if(!richEditSupport || !richEditSupport.characterPair) {
 			return false;
 		}
 
@@ -1061,7 +1063,7 @@ export class OneCursorOp {
 
 		var shouldAutoClosePair = false;
 		try {
-			shouldAutoClosePair = cursor.model.getMode().characterPairSupport.shouldAutoClosePair(ch, lineContext, position.column - 1);
+			shouldAutoClosePair = richEditSupport.characterPair.shouldAutoClosePair(ch, lineContext, position.column - 1);
 		} catch(e) {
 			Errors.onUnexpectedError(e);
 		}
@@ -1144,22 +1146,23 @@ export class OneCursorOp {
 		var lineContext = cursor.model.getLineContext(position.lineNumber);
 
 		var electricAction:IElectricAction;
-		if(cursor.model.getMode().electricCharacterSupport) {
+		let richEditSupport = cursor.model.getMode().richEditSupport;
+		if(richEditSupport && richEditSupport.electricCharacter) {
 			try {
-				electricAction = cursor.model.getMode().electricCharacterSupport.onElectricCharacter(lineContext, position.column - 2);
+				electricAction = richEditSupport.electricCharacter.onElectricCharacter(lineContext, position.column - 2);
 			} catch(e) {
 				Errors.onUnexpectedError(e);
 			}
 		}
 
 		if (electricAction) {
-			var matchBracketType = electricAction.matchBracketType;
+			let matchOpenBracket = electricAction.matchOpenBracket;
 			var appendText = electricAction.appendText;
-			if (matchBracketType) {
-				var match:EditorCommon.IEditorRange = null;
-				if (matchBracketType) {
-					match = cursor.model.findMatchingBracketUp(matchBracketType, position);
-				}
+			if (matchOpenBracket) {
+				var match = cursor.model.findMatchingBracketUp(matchOpenBracket, {
+					lineNumber: position.lineNumber,
+					column: position.column - matchOpenBracket.length
+				});
 				if (match) {
 					var matchLineNumber = match.startLineNumber;
 					var matchLine = cursor.model.getLineContent(matchLineNumber);

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/editorCommon.ts
code:
@@ -757,13 +757,9 @@ export interface IModeSupportChangedEvent {
 	emitOutputSupport:boolean;
 	linkSupport:boolean;
 	configSupport:boolean;
-	electricCharacterSupport:boolean;
-	commentsSupport:boolean;
-	characterPairSupport:boolean;
-	tokenTypeClassificationSupport:boolean;
 	quickFixSupport: boolean;
 	codeLensSupport: boolean;
-	onEnterSupport: boolean;
+	richEditSupport: boolean;
 }
 
 /**
@@ -1178,16 +1174,13 @@ export interface ITokensInflatorMap {
 export interface ILineTokensBinaryEncoding {
 	START_INDEX_MASK: number;
 	TYPE_MASK: number;
-	BRACKET_MASK: number;
 	START_INDEX_OFFSET: number;
 	TYPE_OFFSET: number;
-	BRACKET_OFFSET: number;
 
 	deflateArr(map:ITokensInflatorMap, tokens:Modes.IToken[]): number[];
 	inflate(map:ITokensInflatorMap, binaryEncodedToken:number): Modes.IToken;
 	getStartIndex(binaryEncodedToken:number): number;
 	getType(map:ITokensInflatorMap, binaryEncodedToken:number): string;
-	getBracket(binaryEncodedToken:number): Modes.Bracket;
 	inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): Modes.IToken[];
 	findIndexOfOffset(binaryEncodedTokens:number[], offset:number): number;
 	sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): Modes.IToken[];
@@ -1211,7 +1204,6 @@ export interface ILineTokens {
 	getTokenCount(): number;
 	getTokenStartIndex(tokenIndex:number): number;
 	getTokenType(tokenIndex:number): string;
-	getTokenBracket(tokenIndex:number): Modes.Bracket;
 	getTokenEndIndex(tokenIndex:number, textLength:number): number;
 
 	/**
@@ -1391,6 +1383,21 @@ export interface ITextModel {
 	isDisposed(): boolean;
 }
 
+export interface IRichEditBracket {
+	modeId: string;
+	open: string;
+	close: string;
+	forwardRegex: RegExp;
+	reversedRegex: RegExp;
+}
+
+export interface IFoundBracket {
+	range: IEditorRange;
+	open: string;
+	close: string;
+	isOpen: boolean;
+}
+
 /**
  * A model that is tokenized.
  */
@@ -1483,12 +1490,26 @@ export interface ITokenizedModel extends ITextModel {
 	tokenIterator(position: IPosition, callback: (it: ITokenIterator) =>any): any;
 
 	/**
-	 * Find the matching bracket of `tokenType` up, counting brackets.
-	 * @param tokenType The token type of the bracket we're searching for
+	 * Find the matching bracket of `request` up, counting brackets.
+	 * @param request The bracket we're searching for
 	 * @param position The position at which to start the search.
 	 * @return The range of the matching bracket, or null if the bracket match was not found.
 	 */
-	findMatchingBracketUp(tokenType:string, position:IPosition): IEditorRange;
+	findMatchingBracketUp(bracket:string, position:IPosition): IEditorRange;
+
+	/**
+	 * Find the first bracket in the model before `position`.
+	 * @param position The position at which to start the search.
+	 * @return The info for the first bracket before `position`, or null if there are no more brackets before `positions`.
+	 */
+	findPrevBracket(position:IPosition): IFoundBracket;
+
+	/**
+	 * Find the first bracket in the model after `position`.
+	 * @param position The position at which to start the search.
+	 * @return The info for the first bracket after `position`, or null if there are no more brackets after `positions`.
+	 */
+	findNextBracket(position:IPosition): IFoundBracket;
 
 	/**
 	 * Given a `position`, if the position is on top or near a bracket,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/modelLine.ts
code:
@@ -171,9 +171,8 @@ export class ModelLine {
 				if (currentTokenStartIndex > 0 && delta !== 0) {
 					// adjust token's `startIndex` by `delta`
 					let deflatedType = (tokens[tokensIndex] / BIN.TYPE_OFFSET) & BIN.TYPE_MASK;
-					let deflatedBracket = (tokens[tokensIndex] / BIN.BRACKET_OFFSET) & BIN.BRACKET_MASK;
 					let newStartIndex = Math.max(minimumAllowedIndex, currentTokenStartIndex + delta);
-					let newToken = deflatedBracket * BIN.BRACKET_OFFSET + deflatedType * BIN.TYPE_OFFSET + newStartIndex * BIN.START_INDEX_OFFSET;
+					let newToken = deflatedType * BIN.TYPE_OFFSET + newStartIndex * BIN.START_INDEX_OFFSET;
 
 					if (delta < 0) {
 						// pop all previous tokens that have become `collapsed`
@@ -439,9 +438,8 @@ export class ModelLine {
 
 					let deflatedStartIndex = (token / BIN.START_INDEX_OFFSET) & BIN.START_INDEX_MASK;
 					let deflatedType = (token / BIN.TYPE_OFFSET) & BIN.TYPE_MASK;
-					let deflatedBracket = (token / BIN.BRACKET_OFFSET) & BIN.BRACKET_MASK;
 					let newStartIndex = deflatedStartIndex + thisTextLength;
-					let newToken = deflatedBracket * BIN.BRACKET_OFFSET + deflatedType * BIN.TYPE_OFFSET + newStartIndex * BIN.START_INDEX_OFFSET;
+					let newToken = deflatedType * BIN.TYPE_OFFSET + newStartIndex * BIN.START_INDEX_OFFSET;
 
 					otherTokens[i] = newToken;
 				}
@@ -618,7 +616,7 @@ function toLineTokens(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]
 				return null;
 			}
 		} else {
-			if (tokens[0].startIndex === 0 && tokens[0].type === '' && !tokens[0].bracket) {
+			if (tokens[0].startIndex === 0 && tokens[0].type === '') {
 				return null;
 			}
 		}
@@ -628,7 +626,6 @@ function toLineTokens(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]
 
 var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;
 var getType = EditorCommon.LineTokensBinaryEncoding.getType;
-var getBracket = EditorCommon.LineTokensBinaryEncoding.getBracket;
 var findIndexOfOffset = EditorCommon.LineTokensBinaryEncoding.findIndexOfOffset;
 
 export class LineTokens implements EditorCommon.ILineTokens {
@@ -669,10 +666,6 @@ export class LineTokens implements EditorCommon.ILineTokens {
 		return getType(this.map, this._tokens[tokenIndex]);
 	}
 
-	public getTokenBracket(tokenIndex:number): Modes.Bracket {
-		return getBracket(this._tokens[tokenIndex]);
-	}
-
 	public getTokenEndIndex(tokenIndex:number, textLength:number): number {
 		if (tokenIndex + 1 < this._tokens.length) {
 			return getStartIndex(this._tokens[tokenIndex + 1]);
@@ -714,10 +707,6 @@ class EmptyLineTokens implements EditorCommon.ILineTokens {
 		return Strings.empty;
 	}
 
-	public getTokenBracket(tokenIndex:number): Modes.Bracket {
-		return 0;
-	}
-
 	public getTokenEndIndex(tokenIndex:number, textLength:number): number {
 		return 0;
 	}
@@ -756,10 +745,6 @@ export class DefaultLineTokens implements EditorCommon.ILineTokens {
 		return Strings.empty;
 	}
 
-	public getTokenBracket(tokenIndex:number): Modes.Bracket {
-		return 0;
-	}
-
 	public getTokenEndIndex(tokenIndex:number, textLength:number): number {
 		return textLength;
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithTokens.ts
code:
@@ -8,7 +8,7 @@ import nls = require('vs/nls');
 
 import Timer = require('vs/base/common/timer');
 import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
-import {WordHelper, BracketsHelper} from 'vs/editor/common/model/textModelWithTokensHelpers';
+import {WordHelper} from 'vs/editor/common/model/textModelWithTokensHelpers';
 import {TokenIterator} from 'vs/editor/common/model/tokenIterator';
 import {ModelLine} from 'vs/editor/common/model/modelLine';
 import {TextModel} from 'vs/editor/common/model/textModel';
@@ -21,6 +21,9 @@ import Errors = require('vs/base/common/errors');
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
 import {StopWatch} from 'vs/base/common/stopwatch';
 import {TPromise} from 'vs/base/common/winjs.base';
+import {Range} from 'vs/editor/common/core/range';
+import {ignoreBracketsInToken} from 'vs/editor/common/modes/supports';
+import {BracketsUtils} from 'vs/editor/common/modes/supports/electricCharacter';
 
 export class TokensInflatorMap implements EditorCommon.ITokensInflatorMap {
 
@@ -166,10 +169,6 @@ class LineContext implements Modes.ILineContext {
 		return this._lineTokens.getTokenType(tokenIndex);
 	}
 
-	public getTokenBracket(tokenIndex:number): Modes.Bracket {
-		return this._lineTokens.getTokenBracket(tokenIndex);
-	}
-
 	public getTokenText(tokenIndex:number): string {
 		var startIndex = this._lineTokens.getTokenStartIndex(tokenIndex);
 		var endIndex = this._lineTokens.getTokenEndIndex(tokenIndex, this._text.length);
@@ -848,19 +847,391 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return result;
 	}
 
-	public findMatchingBracketUp(tokenType:string, position:EditorCommon.IPosition): EditorCommon.IEditorRange {
+	public findMatchingBracketUp(bracket:string, _position:EditorCommon.IPosition): EditorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.findMatchingBracketUp: Model is disposed');
 		}
 
-		return BracketsHelper.findMatchingBracketUp(this, tokenType, this.validatePosition(position));
+		let position = this.validatePosition(_position);
+		let modeTransitions = this._lines[position.lineNumber - 1].getModeTransitions().toArray(this._mode);
+		let currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+		let currentMode = modeTransitions[currentModeIndex];
+		let currentModeBrackets = currentMode.mode.richEditSupport ? currentMode.mode.richEditSupport.brackets : null;
+
+		if (!currentModeBrackets) {
+			return null;
+		}
+
+		let data = currentModeBrackets.textIsBracket[bracket];
+
+		if (!data) {
+			return null;
+		}
+
+		return this._findMatchingBracketUp(data, position);
 	}
 
 	public matchBracket(position:EditorCommon.IPosition, inaccurateResultAcceptable:boolean = false): EditorCommon.IMatchBracketResult {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.matchBracket: Model is disposed');
 		}
 
-		return BracketsHelper.matchBracket(this, this.validatePosition(position), inaccurateResultAcceptable);
+		return this._matchBracket(this.validatePosition(position));
+	}
+
+	private _matchBracket(position:EditorCommon.IEditorPosition): EditorCommon.IMatchBracketResult {
+		let tokensMap = this._tokensInflatorMap;
+		let lineNumber = position.lineNumber;
+		let lineText = this._lines[lineNumber - 1].text;
+
+		let lineTokens = this._lines[lineNumber - 1].getTokens();
+		let tokens = lineTokens.getBinaryEncodedTokens();
+		let currentTokenIndex = lineTokens.findIndexOfOffset(position.column - 1);
+		let currentTokenStart = getStartIndex(tokens[currentTokenIndex]);
+
+		let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+		let currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+		let currentMode = modeTransitions[currentModeIndex];
+		let currentModeBrackets = currentMode.mode.richEditSupport ? currentMode.mode.richEditSupport.brackets : null;
+
+		// If position is in between two tokens, try first looking in the previous token
+		if (currentTokenIndex > 0 && currentTokenStart === position.column - 1) {
+			let prevTokenIndex = currentTokenIndex - 1;
+			let prevTokenType = getType(tokensMap, tokens[prevTokenIndex]);
+
+			// check that previous token is not to be ignored
+			if (!ignoreBracketsInToken(prevTokenType)) {
+				let prevTokenStart = getStartIndex(tokens[prevTokenIndex]);
+
+				let prevMode = currentMode;
+				let prevModeBrackets = currentModeBrackets;
+				// check if previous token is in a different mode
+				if (currentModeIndex > 0 && currentMode.startIndex === position.column - 1) {
+					prevMode = modeTransitions[currentModeIndex - 1];
+					prevModeBrackets = prevMode.mode.richEditSupport ? prevMode.mode.richEditSupport.brackets : null;
+				}
+
+				if (prevModeBrackets) {
+					// limit search in case previous token is very large, there's no need to go beyond `maxBracketLength`
+					prevTokenStart = Math.max(prevTokenStart, position.column - 1 - prevModeBrackets.maxBracketLength);
+
+					let foundBracket = BracketsUtils.findPrevBracketInToken(prevModeBrackets.reversedRegex, lineNumber, lineText, prevTokenStart, currentTokenStart);
+
+					// check that we didn't hit a bracket too far away from position
+					if (foundBracket && foundBracket.startColumn <= position.column && position.column <= foundBracket.endColumn) {
+						let foundBracketText = lineText.substring(foundBracket.startColumn - 1, foundBracket.endColumn - 1);
+						let r = this._matchFoundBracket(foundBracket, prevModeBrackets.textIsBracket[foundBracketText], prevModeBrackets.textIsOpenBracket[foundBracketText]);
+
+						// check that we can actually match this bracket
+						if (r) {
+							return r;
+						}
+					}
+				}
+			}
+		}
+
+		// check that the token is not to be ignored
+		if (!ignoreBracketsInToken(getType(tokensMap, tokens[currentTokenIndex]))) {
+
+			if (currentModeBrackets) {
+				// limit search to not go before `maxBracketLength`
+				currentTokenStart = Math.max(currentTokenStart, position.column - 1 - currentModeBrackets.maxBracketLength);
+
+				// limit search to not go after `maxBracketLength`
+				let currentTokenEnd = (currentTokenIndex + 1 < tokens.length ? getStartIndex(tokens[currentTokenIndex + 1]) : lineText.length);
+				currentTokenEnd = Math.min(currentTokenEnd, position.column - 1 + currentModeBrackets.maxBracketLength);
+
+				// it might still be the case that [currentTokenStart -> currentTokenEnd] contains multiple brackets
+				while(true) {
+					let foundBracket = BracketsUtils.findNextBracketInText(currentModeBrackets.forwardRegex, lineNumber, lineText.substring(currentTokenStart, currentTokenEnd), currentTokenStart);
+					if (!foundBracket) {
+						// there are no brackets in this text
+						break;
+					}
+
+					// check that we didn't hit a bracket too far away from position
+					if (foundBracket.startColumn <= position.column && position.column <= foundBracket.endColumn) {
+						let foundBracketText = lineText.substring(foundBracket.startColumn - 1, foundBracket.endColumn - 1);
+						let r = this._matchFoundBracket(foundBracket, currentModeBrackets.textIsBracket[foundBracketText], currentModeBrackets.textIsOpenBracket[foundBracketText]);
+
+						// check that we can actually match this bracket
+						if (r) {
+							return r;
+						}
+					}
+
+					currentTokenStart = foundBracket.endColumn - 1;
+				}
+			}
+		}
+
+		return {
+			brackets: null,
+			isAccurate: true
+		};
+	}
+
+	private _matchFoundBracket(foundBracket:Range, data:EditorCommon.IRichEditBracket, isOpen:boolean): EditorCommon.IMatchBracketResult {
+		if (isOpen) {
+			let matched = this._findMatchingBracketDown(data, foundBracket.getEndPosition());
+			if (matched) {
+				return {
+					brackets: [foundBracket, matched],
+					isAccurate: true
+				};
+			}
+		} else {
+			let matched = this._findMatchingBracketUp(data, foundBracket.getStartPosition());
+			if (matched) {
+				return {
+					brackets: [foundBracket, matched],
+					isAccurate: true
+				};
+			}
+		}
+
+		return null;
+	}
+
+	private _findMatchingBracketUp(bracket:EditorCommon.IRichEditBracket, position:EditorCommon.IEditorPosition): Range {
+		// console.log('_findMatchingBracketUp: ', 'bracket: ', JSON.stringify(bracket), 'startPosition: ', String(position));
+
+		let modeId = bracket.modeId;
+		let tokensMap = this._tokensInflatorMap;
+		let reversedBracketRegex = bracket.reversedRegex;
+		let count = -1;
+
+		for (let lineNumber = position.lineNumber; lineNumber >= 1; lineNumber--) {
+			let lineTokens = this._lines[lineNumber - 1].getTokens();
+			let lineText = this._lines[lineNumber - 1].text;
+			let tokens = lineTokens.getBinaryEncodedTokens();
+			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+			let currentModeIndex = modeTransitions.length - 1;
+			let currentModeStart = modeTransitions[currentModeIndex].startIndex;
+			let currentModeId = modeTransitions[currentModeIndex].mode.getId();
+
+			let tokensLength = tokens.length - 1;
+			let currentTokenEnd = lineText.length;
+			if (lineNumber === position.lineNumber) {
+				tokensLength = lineTokens.findIndexOfOffset(position.column - 1);
+				currentTokenEnd = position.column - 1;
+
+				currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+				currentModeStart = modeTransitions[currentModeIndex].startIndex;
+				currentModeId = modeTransitions[currentModeIndex].mode.getId();
+			}
+
+			for (let tokenIndex = tokensLength; tokenIndex >= 0; tokenIndex--) {
+				let currentToken = tokens[tokenIndex];
+				let currentTokenType = getType(tokensMap, currentToken);
+				let currentTokenStart = getStartIndex(currentToken);
+
+				if (currentTokenStart < currentModeStart) {
+					currentModeIndex--;
+					currentModeStart = modeTransitions[currentModeIndex].startIndex;
+					currentModeId = modeTransitions[currentModeIndex].mode.getId();
+				}
+
+				if (currentModeId === modeId && !ignoreBracketsInToken(currentTokenType)) {
+
+					while (true) {
+						let r = BracketsUtils.findPrevBracketInToken(reversedBracketRegex, lineNumber, lineText, currentTokenStart, currentTokenEnd);
+						if (!r) {
+							break;
+						}
+
+						let hitText = lineText.substring(r.startColumn - 1, r.endColumn - 1);
+
+						if (hitText === bracket.open) {
+							count++;
+						} else if (hitText === bracket.close) {
+							count--;
+						}
+
+						if (count === 0) {
+							return r;
+						}
+
+						currentTokenEnd = r.startColumn - 1;
+					}
+				}
+
+				currentTokenEnd = currentTokenStart;
+			}
+		}
+
+		return null;
+	}
+
+	private _findMatchingBracketDown(bracket:EditorCommon.IRichEditBracket, position:EditorCommon.IEditorPosition): Range {
+		// console.log('_findMatchingBracketDown: ', 'bracket: ', JSON.stringify(bracket), 'startPosition: ', String(position));
+
+		let modeId = bracket.modeId;
+		let tokensMap = this._tokensInflatorMap;
+		let bracketRegex = bracket.forwardRegex;
+		let count = 1;
+
+		for (let lineNumber = position.lineNumber, lineCount = this.getLineCount(); lineNumber <= lineCount; lineNumber++) {
+			let lineTokens = this._lines[lineNumber - 1].getTokens();
+			let lineText = this._lines[lineNumber - 1].text;
+			let tokens = lineTokens.getBinaryEncodedTokens();
+			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+			let currentModeIndex = 0;
+			let nextModeStart = (currentModeIndex + 1 < modeTransitions.length ? modeTransitions[currentModeIndex + 1].startIndex : lineText.length + 1);
+			let currentModeId = modeTransitions[currentModeIndex].mode.getId();
+
+			let startTokenIndex = 0;
+			let currentTokenStart = getStartIndex(startTokenIndex);
+			if (lineNumber === position.lineNumber) {
+				startTokenIndex = lineTokens.findIndexOfOffset(position.column - 1);
+				currentTokenStart = Math.max(currentTokenStart, position.column - 1);
+
+				currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+				nextModeStart = (currentModeIndex + 1 < modeTransitions.length ? modeTransitions[currentModeIndex + 1].startIndex : lineText.length + 1);
+				currentModeId = modeTransitions[currentModeIndex].mode.getId();
+			}
+
+			for (let tokenIndex = startTokenIndex, tokensLength = tokens.length; tokenIndex < tokensLength; tokenIndex++) {
+				let currentToken = tokens[tokenIndex];
+				let currentTokenType = getType(tokensMap, currentToken);
+				let currentTokenEnd = tokenIndex + 1 < tokensLength ? getStartIndex(tokens[tokenIndex + 1]) : lineText.length;
+
+				if (currentTokenStart >= nextModeStart) {
+					currentModeIndex++;
+					nextModeStart = (currentModeIndex + 1 < modeTransitions.length ? modeTransitions[currentModeIndex + 1].startIndex : lineText.length + 1);
+					currentModeId = modeTransitions[currentModeIndex].mode.getId();
+				}
+
+				if (currentModeId === modeId && !ignoreBracketsInToken(currentTokenType)) {
+					while (true) {
+						let r = BracketsUtils.findNextBracketInToken(bracketRegex, lineNumber, lineText, currentTokenStart, currentTokenEnd);
+						if (!r) {
+							break;
+						}
+
+						let hitText = lineText.substring(r.startColumn - 1, r.endColumn - 1);
+
+						if (hitText === bracket.open) {
+							count++;
+						} else if (hitText === bracket.close) {
+							count--;
+						}
+
+						if (count === 0) {
+							return r;
+						}
+
+						currentTokenStart = r.endColumn - 1;
+					}
+				}
+
+				currentTokenStart = currentTokenEnd;
+			}
+		}
+
+		return null;
+	}
+
+	public findPrevBracket(_position:EditorCommon.IPosition): EditorCommon.IFoundBracket {
+		if (this._isDisposed) {
+			throw new Error('TextModelWithTokens.findPrevBracket: Model is disposed');
+		}
+		let position = this.validatePosition(_position);
+
+		let tokensMap = this._tokensInflatorMap;
+		let reversedBracketRegex = /[\(\)\[\]\{\}]/; // TODO@Alex: use mode's brackets
+
+		for (let lineNumber = position.lineNumber; lineNumber >= 1; lineNumber--) {
+			let lineTokens = this._lines[lineNumber - 1].getTokens();
+			let lineText = this._lines[lineNumber - 1].text;
+			let tokens = lineTokens.getBinaryEncodedTokens();
+
+			let tokensLength = tokens.length - 1;
+			let currentTokenEnd = lineText.length;
+			if (lineNumber === position.lineNumber) {
+				tokensLength = lineTokens.findIndexOfOffset(position.column - 1);
+				currentTokenEnd = position.column - 1;
+			}
+
+			for (let tokenIndex = tokensLength; tokenIndex >= 0; tokenIndex--) {
+				let currentToken = tokens[tokenIndex];
+				let currentTokenType = getType(tokensMap, currentToken);
+				let currentTokenStart = getStartIndex(currentToken);
+
+				if (!ignoreBracketsInToken(currentTokenType)) {
+					let r = BracketsUtils.findPrevBracketInToken(reversedBracketRegex, lineNumber, lineText, currentTokenStart, currentTokenEnd);
+					if (r) {
+						return this._toFoundBracket(r);
+					}
+				}
+
+				currentTokenEnd = currentTokenStart;
+			}
+		}
+
+		return null;
+	}
+
+	public findNextBracket(_position:EditorCommon.IPosition): EditorCommon.IFoundBracket {
+		if (this._isDisposed) {
+			throw new Error('TextModelWithTokens.findNextBracket: Model is disposed');
+		}
+		let position = this.validatePosition(_position);
+
+		let tokensMap = this._tokensInflatorMap;
+		let bracketRegex = /[\(\)\[\]\{\}]/; // TODO@Alex: use mode's brackets
+
+		for (let lineNumber = position.lineNumber, lineCount = this.getLineCount(); lineNumber <= lineCount; lineNumber++) {
+			let lineTokens = this._lines[lineNumber - 1].getTokens();
+			let lineText = this._lines[lineNumber - 1].text;
+			let tokens = lineTokens.getBinaryEncodedTokens();
+
+			let startTokenIndex = 0;
+			let currentTokenStart = getStartIndex(startTokenIndex);
+			if (lineNumber === position.lineNumber) {
+				startTokenIndex = lineTokens.findIndexOfOffset(position.column - 1);
+				currentTokenStart = Math.max(currentTokenStart, position.column - 1);
+			}
+
+			for (let tokenIndex = startTokenIndex, tokensLength = tokens.length; tokenIndex < tokensLength; tokenIndex++) {
+				let currentToken = tokens[tokenIndex];
+				let currentTokenType = getType(tokensMap, currentToken);
+				let currentTokenEnd = tokenIndex + 1 < tokensLength ? getStartIndex(tokens[tokenIndex + 1]) : lineText.length;
+
+				if (!ignoreBracketsInToken(currentTokenType)) {
+					let r = BracketsUtils.findNextBracketInToken(bracketRegex, lineNumber, lineText, currentTokenStart, currentTokenEnd);
+					if (r) {
+						return this._toFoundBracket(r);
+					}
+				}
+
+				currentTokenStart = currentTokenEnd;
+			}
+		}
+
+		return null;
+	}
+
+	private _toFoundBracket(r:Range): EditorCommon.IFoundBracket {
+		if (!r) {
+			return null;
+		}
+
+		let text = this.getValueInRange(r);
+
+		// TODO@Alex: use mode's brackets
+		switch (text) {
+			case '(': return { range: r, open: '(', close: ')', isOpen: true };
+			case ')': return { range: r, open: '(', close: ')', isOpen: false };
+			case '[': return { range: r, open: '[', close: ']', isOpen: true };
+			case ']': return { range: r, open: '[', close: ']', isOpen: false };
+			case '{': return { range: r, open: '{', close: '}', isOpen: true };
+			case '}': return { range: r, open: '{', close: '}', isOpen: false };
+		}
+		return null;
 	}
 }
+
+var getType = EditorCommon.LineTokensBinaryEncoding.getType;
+var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithTokensHelpers.ts
code:
@@ -5,11 +5,9 @@
 'use strict';
 
 import {NullMode} from 'vs/editor/common/modes/nullMode';
-import {Range} from 'vs/editor/common/core/range';
 import Modes = require('vs/editor/common/modes');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import {Arrays} from 'vs/editor/common/core/arrays';
-import Errors = require('vs/base/common/errors');
 
 export interface ITextSource {
 
@@ -28,28 +26,14 @@ export interface ITextSource {
 	getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean): EditorCommon.ILineTokens;
 }
 
-var getType = EditorCommon.LineTokensBinaryEncoding.getType;
-var getBracket = EditorCommon.LineTokensBinaryEncoding.getBracket;
-var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;
-
 export interface INonWordTokenMap {
 	[key:string]:boolean;
 }
 
 export class WordHelper {
 
 	private static _safeGetWordDefinition(mode:Modes.IMode): RegExp {
-		var result: RegExp = null;
-
-		if (mode.tokenTypeClassificationSupport) {
-			try {
-				result = mode.tokenTypeClassificationSupport.getWordDefinition();
-			} catch(e) {
-				Errors.onUnexpectedError(e);
-			}
-		}
-
-		return result;
+		return (mode.richEditSupport ? mode.richEditSupport.wordDefinition : null);
 	}
 
 	public static ensureValidWordDefinition(wordDefinition?:RegExp): RegExp {
@@ -232,159 +216,3 @@ export class WordHelper {
 		return null;
 	}
 }
-
-export class BracketsHelper {
-
-	private static _sign(n:number): number {
-		return n < 0 ? -1 : n > 0 ? 1 : 0;
-	}
-
-	private static _findMatchingBracketUp(textSource:ITextSource, type:string, lineNumber:number, tokenIndex:number, initialCount:number): Range {
-
-		var i:number,
-			end:number,
-			j:number,
-			count = initialCount;
-
-		for (i = lineNumber; i >= 1; i--) {
-
-			var lineTokens = textSource.getLineTokens(i, false),
-				tokens = lineTokens.getBinaryEncodedTokens(),
-				tokensMap = lineTokens.getBinaryEncodedTokensMap(),
-				lineText = textSource.getLineContent(i);
-
-			for (j = (i === lineNumber ? tokenIndex : tokens.length) - 1; j >= 0; j--) {
-				if (getType(tokensMap, tokens[j]) === type) {
-					count += BracketsHelper._sign(getBracket(tokens[j]));
-					if (count === 0) {
-						end = (j === tokens.length - 1 ? lineText.length : getStartIndex(tokens[j + 1]));
-						return new Range(i, getStartIndex(tokens[j]) + 1, i, end + 1);
-					}
-				}
-			}
-		}
-		return null;
-	}
-
-	private static _findMatchingBracketDown(textSource:ITextSource, type:string, lineNumber:number, tokenIndex:number, inaccurateResultAcceptable:boolean): { range:Range; isAccurate:boolean; } {
-
-		var i:number,
-			len:number,
-			end:number,
-			j:number,
-			lenJ:number,
-			count = 1;
-
-		for (i = lineNumber, len = textSource.getLineCount(); i <= len; i++) {
-			if (inaccurateResultAcceptable && !textSource._lineIsTokenized(i)) {
-				return {
-					range: null,
-					isAccurate: false
-				};
-			}
-
-			var lineTokens = textSource.getLineTokens(i, false),
-				tokens = lineTokens.getBinaryEncodedTokens(),
-				tokensMap = lineTokens.getBinaryEncodedTokensMap(),
-				lineText = textSource.getLineContent(i);
-
-			for (j = (i === lineNumber ? tokenIndex + 1 : 0), lenJ = tokens.length; j < lenJ; j++) {
-				if (getType(tokensMap, tokens[j]) === type) {
-					count += BracketsHelper._sign(getBracket(tokens[j]));
-					if (count === 0) {
-						end = (j === tokens.length - 1 ? lineText.length : getStartIndex(tokens[j + 1]));
-						return {
-							range: new Range(i, getStartIndex(tokens[j]) + 1, i, end + 1),
-							isAccurate: true
-						};
-					}
-				}
-			}
-		}
-
-		return {
-			range: null,
-			isAccurate: true
-		};
-	}
-
-	public static findMatchingBracketUp(textSource:ITextSource, tokenType:string, position:EditorCommon.IPosition): EditorCommon.IEditorRange {
-
-		var i:number,
-			len:number,
-			end:number,
-			columnIndex = position.column - 1,
-			tokenIndex = -1,
-			lineTokens = textSource.getLineTokens(position.lineNumber, false),
-			tokens = lineTokens.getBinaryEncodedTokens(),
-			lineText = textSource.getLineContent(position.lineNumber);
-
-		for (i = 0, len = tokens.length; tokenIndex === -1 && i < len; i++) {
-			end = i === len - 1 ? lineText.length : getStartIndex(tokens[i + 1]);
-
-			if (getStartIndex(tokens[i]) <= columnIndex && columnIndex <= end) {
-				tokenIndex = i;
-			}
-		}
-
-		// Start looking one token after the bracket
-		return BracketsHelper._findMatchingBracketUp(textSource, tokenType, position.lineNumber, tokenIndex + 1, 0);
-	}
-
-	public static matchBracket(textSource:ITextSource, position:EditorCommon.IPosition, inaccurateResultAcceptable:boolean): EditorCommon.IMatchBracketResult {
-		if (inaccurateResultAcceptable && !textSource._lineIsTokenized(position.lineNumber)) {
-			return {
-				brackets: null,
-				isAccurate: false
-			};
-		}
-
-		var lineText = textSource.getLineContent(position.lineNumber),
-			i:number,
-			len:number;
-
-		var result:EditorCommon.IMatchBracketResult = {
-			brackets: null,
-			isAccurate: true
-		};
-
-		if (lineText.length > 0) {
-			var columnIndex = position.column - 1;
-			var token:number;
-			var end:number;
-
-			var lineTokens = textSource.getLineTokens(position.lineNumber, false),
-				tokens = lineTokens.getBinaryEncodedTokens(),
-				tokensMap = lineTokens.getBinaryEncodedTokensMap(),
-				tokenStartIndex:number,
-				tokenBracket:number,
-				tokenType:string;
-
-			for (i = 0, len = tokens.length; result.brackets === null && i < len; i++) {
-				token = tokens[i];
-				tokenStartIndex = getStartIndex(token);
-				tokenType = getType(tokensMap, token);
-				tokenBracket = getBracket(token);
-
-				end = i === len - 1 ? lineText.length : getStartIndex(tokens[i + 1]);
-
-				if (tokenStartIndex <= columnIndex && columnIndex <= end) {
-					if (tokenBracket < 0) {
-						var upMatch = BracketsHelper._findMatchingBracketUp(textSource, tokenType, position.lineNumber, i, -1);
-						if (upMatch) {
-							result.brackets = [new Range(position.lineNumber, tokenStartIndex + 1, position.lineNumber, end + 1), upMatch];
-						}
-					}
-					if (result.brackets === null && tokenBracket > 0) {
-						var downMatch = BracketsHelper._findMatchingBracketDown(textSource, tokenType, position.lineNumber, i, inaccurateResultAcceptable);
-						result.isAccurate = downMatch.isAccurate;
-						if (downMatch.range) {
-							result.brackets = [new Range(position.lineNumber, tokenStartIndex + 1, position.lineNumber, end + 1), downMatch.range];
-						}
-					}
-				}
-			}
-		}
-		return result;
-	}
-}
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/tokensBinaryEncoding.ts
code:
@@ -12,30 +12,25 @@ import Errors = require('vs/base/common/errors');
 class InflatedToken implements Modes.IToken {
 	startIndex:number;
 	type:string;
-	bracket:Modes.Bracket;
 
-	constructor(startIndex:number, type:string, bracket:Modes.Bracket) {
+	constructor(startIndex:number, type:string) {
 		this.startIndex = startIndex;
 		this.type = type;
-		this.bracket = bracket;
 	}
 
 	public toString(): string {
-		return '{ ' + this.startIndex + ', \'' + this.type + '\', ' + this.bracket + '}';
+		return '{ ' + this.startIndex + ', \'' + this.type + '\'}';
 	}
 }
 
 export var START_INDEX_MASK = 0xffffffff;
 export var TYPE_MASK = 0xffff;
-export var BRACKET_MASK = 0xff;
 export var START_INDEX_OFFSET = 1;
 export var TYPE_OFFSET = Math.pow(2, 32);
-export var BRACKET_OFFSET = Math.pow(2, 48);
 
 var DEFAULT_TOKEN = {
 	startIndex: 0,
-	type: '',
-	bracket: 0
+	type: ''
 };
 var INFLATED_TOKENS_EMPTY_TEXT = <Modes.IToken[]>[];
 var DEFLATED_TOKENS_EMPTY_TEXT = <number[]>[];
@@ -46,14 +41,13 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 	if (tokens.length === 0) {
 		return DEFLATED_TOKENS_EMPTY_TEXT;
 	}
-	if (tokens.length === 1 && tokens[0].startIndex === 0 && !tokens[0].type && !tokens[0].bracket) {
+	if (tokens.length === 1 && tokens[0].startIndex === 0 && !tokens[0].type) {
 		return DEFLATED_TOKENS_NON_EMPTY_TEXT;
 	}
 
 	var i:number,
 		len:number,
 		deflatedToken:number,
-		deflatedBracket:number,
 		deflated:number,
 		token:Modes.IToken,
 		inflateMap = map._inflate,
@@ -80,11 +74,6 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 			inflateMap.push(token.type);
 		}
 
-		deflatedBracket = token.bracket;
-		if (deflatedBracket < 0) {
-			deflatedBracket = 2;
-		}
-
 		// http://stackoverflow.com/a/2803010
 		// All numbers in JavaScript are actually IEEE-754 compliant floating-point doubles.
 		// These have a 53-bit mantissa which should mean that any integer value with a magnitude
@@ -96,10 +85,9 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 
 		// 32 bits for startIndex => up to 2^32 = 4,294,967,296
 		// 16 bits for token => up to 2^16 = 65,536
-		// 2 bits for bracket => up to 2^2 = 4
 
-		// [bracket][token][startIndex]
-		deflated = deflatedBracket * BRACKET_OFFSET + deflatedToken * TYPE_OFFSET + token.startIndex * START_INDEX_OFFSET;
+		// [token][startIndex]
+		deflated = deflatedToken * TYPE_OFFSET + token.startIndex * START_INDEX_OFFSET;
 
 		result[i] = deflated;
 
@@ -116,13 +104,8 @@ export function inflate(map:EditorCommon.ITokensInflatorMap, binaryEncodedToken:
 
 	var startIndex = (binaryEncodedToken / START_INDEX_OFFSET) & START_INDEX_MASK;
 	var deflatedType = (binaryEncodedToken / TYPE_OFFSET) & TYPE_MASK;
-	var deflatedBracket = (binaryEncodedToken / BRACKET_OFFSET) & BRACKET_MASK;
-
-	if (deflatedBracket === 2) {
-		deflatedBracket = -1;
-	}
 
-	return new InflatedToken(startIndex, map._inflate[deflatedType], deflatedBracket);
+	return new InflatedToken(startIndex, map._inflate[deflatedType]);
 }
 
 export function getStartIndex(binaryEncodedToken:number): number {
@@ -137,16 +120,6 @@ export function getType(map:EditorCommon.ITokensInflatorMap, binaryEncodedToken:
 	return map._inflate[deflatedType];
 }
 
-export function getBracket(binaryEncodedToken:number): Modes.Bracket {
-	var deflatedBracket = (binaryEncodedToken / BRACKET_OFFSET) & BRACKET_MASK;
-
-	if (deflatedBracket === 2) {
-		deflatedBracket = -1;
-	}
-
-	return deflatedBracket;
-}
-
 export function inflateArr(map:EditorCommon.ITokensInflatorMap, binaryEncodedTokens:number[]): Modes.IToken[] {
 	if (binaryEncodedTokens.length === 0) {
 		return INFLATED_TOKENS_EMPTY_TEXT;
@@ -160,7 +133,6 @@ export function inflateArr(map:EditorCommon.ITokensInflatorMap, binaryEncodedTok
 		len:number,
 		deflated:number,
 		startIndex:number,
-		deflatedBracket:number,
 		deflatedType:number,
 		inflateMap = map._inflate;
 
@@ -169,13 +141,8 @@ export function inflateArr(map:EditorCommon.ITokensInflatorMap, binaryEncodedTok
 
 		startIndex = (deflated / START_INDEX_OFFSET) & START_INDEX_MASK;
 		deflatedType = (deflated / TYPE_OFFSET) & TYPE_MASK;
-		deflatedBracket = (deflated / BRACKET_OFFSET) & BRACKET_MASK;
-
-		if (deflatedBracket === 2) {
-			deflatedBracket = -1;
-		}
 
-		result[i] = new InflatedToken(startIndex, inflateMap[deflatedType], deflatedBracket);
+		result[i] = new InflatedToken(startIndex, inflateMap[deflatedType]);
 	}
 
 	return result;
@@ -200,15 +167,13 @@ export function sliceAndInflate(map:EditorCommon.ITokensInflatorMap, binaryEncod
 		originalStartIndex:number,
 		newStartIndex:number,
 		deflatedType:number,
-		deflatedBracket:number,
 		result: Modes.IToken[] = [],
 		inflateMap = map._inflate;
 
 	originalToken = binaryEncodedTokens[startIndex];
 	deflatedType = (originalToken / TYPE_OFFSET) & TYPE_MASK;
-	deflatedBracket = (originalToken / BRACKET_OFFSET) & BRACKET_MASK;
 	newStartIndex = 0;
-	result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType], deflatedBracket));
+	result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType]));
 
 	for (i = startIndex + 1, len = binaryEncodedTokens.length; i < len; i++) {
 		originalToken = binaryEncodedTokens[i];
@@ -219,9 +184,8 @@ export function sliceAndInflate(map:EditorCommon.ITokensInflatorMap, binaryEncod
 		}
 
 		deflatedType = (originalToken / TYPE_OFFSET) & TYPE_MASK;
-		deflatedBracket = (originalToken / BRACKET_OFFSET) & BRACKET_MASK;
 		newStartIndex = originalStartIndex - startOffset + deltaStartIndex;
-		result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType], deflatedBracket));
+		result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType]));
 	}
 
 	return result;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes.ts
code:
@@ -176,7 +176,6 @@ export interface ILineContext {
 	getTokenCount(): number;
 	getTokenStartIndex(tokenIndex:number): number;
 	getTokenType(tokenIndex:number): string;
-	getTokenBracket(tokenIndex:number): Bracket;
 	getTokenText(tokenIndex:number): string;
 	getTokenEndIndex(tokenIndex:number): number;
 	findIndexOfOffset(offset:number): number;
@@ -283,26 +282,6 @@ export interface IMode {
 	 */
 	configSupport?:IConfigurationSupport;
 
-	/**
-	 * Optional adapter to support electric characters.
-	 */
-	electricCharacterSupport?:IElectricCharacterSupport;
-
-	/**
-	 * Optional adapter to support comment insertion.
-	 */
-	commentsSupport?:ICommentsSupport;
-
-	/**
-	 * Optional adapter to support insertion of character pair.
-	 */
-	characterPairSupport?:ICharacterPairSupport;
-
-	/**
-	 * Optional adapter to support classification of tokens.
-	 */
-	tokenTypeClassificationSupport?:ITokenTypeClassificationSupport;
-
 	/**
 	 * Optional adapter to support quick fix of typing errors.
 	 */
@@ -323,7 +302,10 @@ export interface IMode {
 	 */
 	taskSupport?: ITaskSupport;
 
-	onEnterSupport?: IOnEnterSupport;
+	/**
+	 * Optional adapter to support rich editing.
+	 */
+	richEditSupport?: IRichEditSupport;
 }
 
 /**
@@ -332,7 +314,7 @@ export interface IMode {
 export interface IToken {
 	startIndex:number;
 	type:string;
-	bracket:Bracket;
+	bracket?:Bracket;
 }
 
 export interface IModeTransition {
@@ -456,12 +438,6 @@ export interface IParameterHints {
 	signatures:ISignature[];
 }
 
-export interface IParameterHintsContribution {
-	triggerCharacters: string[];
-	excludeTokens: string[];
-	getParameterHints: (resource: URI, position: EditorCommon.IPosition) => TPromise<IParameterHints>;
-}
-
 /**
  * Interface used to get parameter hints.
  */
@@ -645,87 +621,6 @@ export interface IConfigurationSupport {
 	configure(options:any):TPromise<boolean>;
 }
 
-
-
-
-/**
- * Interface used to support electric characters
- */
-export interface IElectricAction {
-	// Only one of the following properties should be defined:
-
-	// The line will be indented at the same level of the line
-	// which contains the matching given bracket type.
-	matchBracketType?:string;
-
-	// The text will be appended after the electric character.
-	appendText?:string;
-
-	// The number of characters to advance the cursor, useful with appendText
-	advanceCount?:number;
-}
-
-export enum IndentAction {
-	None,
-	Indent,
-	IndentOutdent,
-	Outdent
-}
-
-/**
- * An action the editor executes when 'enter' is being pressed
- */
-export interface IEnterAction {
-	indentAction:IndentAction;
-	appendText?:string;
-	removeText?:number;
-}
-
-export interface IElectricCharacterSupport {
-	getElectricCharacters():string[];
-	// Should return opening bracket type to match indentation with
-	onElectricCharacter(context:ILineContext, offset:number):IElectricAction;
-	onEnter(context:ILineContext, offset:number):IEnterAction;
-}
-
-export interface IOnEnterSupport {
-	onEnter(model:EditorCommon.ITokenizedModel, position: EditorCommon.IPosition): IEnterAction;
-}
-
-/**
- * Interface used to support insertion of mode specific comments.
- */
-export interface ICommentsConfiguration {
-	lineCommentTokens?:string[];
-	blockCommentStartToken?:string;
-	blockCommentEndToken?:string;
-}
-export interface ICommentsSupport {
-	getCommentsConfiguration():ICommentsConfiguration;
-}
-
-
-
-/**
- * Interface used to support insertion of matching characters like brackets and qoutes.
- */
-export interface IAutoClosingPair {
-	open:string;
-	close:string;
-}
-export interface ICharacterPairSupport {
-	getAutoClosingPairs():IAutoClosingPairConditional[];
-	shouldAutoClosePair(character:string, context:ILineContext, offset:number):boolean;
-	getSurroundingPairs():IAutoClosingPair[];
-}
-
-/**
- * Interface used to support the classification of tokens.
- */
-export interface ITokenTypeClassificationSupport {
-	getWordDefinition():RegExp;
-}
-
 export interface IResourceEdit {
 	resource: URI;
 	range?: EditorCommon.IRange;
@@ -790,41 +685,112 @@ export interface IBracketPair {
 	isElectric:boolean;
 }
 
+export interface IAutoClosingPairConditional extends IAutoClosingPair {
+	notIn?: string[];
+}
+
 /**
- * Regular expression based brackets. These are always electric.
+ * Interface used to support electric characters
  */
-export interface IRegexBracketPair {
-	openTrigger?: string; // The character that will trigger the evaluation of 'open'.
-	open: RegExp; // The definition of when an opening brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
-	closeComplete?: string; // How to complete a matching open brace. Matches from 'open' will be expanded, e.g. '</$1>'
-	matchCase?: boolean; // If set to true, the case of the string captured in 'open' will be detected an applied also to 'closeComplete'.
-						// This is useful for cases like BEGIN/END or begin/end where the opening and closing phrases are unrelated.
-						// For identical phrases, use the $1 replacement syntax above directly in closeComplete, as it will
-						// include the proper casing from the captured string in 'open'.
-						// Upper/Lower/Camel cases are detected. Camel case dection uses only the first two characters and assumes
-						// that 'closeComplete' contains wors separated by spaces (e.g. 'End Loop')
-
-	closeTrigger?: string; // The character that will trigger the evaluation of 'close'.
-	close?: RegExp; // The definition of when a closing brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
-	tokenType?: string; // The type of the token. Matches from 'open' or 'close' will be expanded, e.g. 'keyword.$1'.
-					// Only used to auto-(un)indent a closing bracket.
+export interface IElectricAction {
+	// Only one of the following properties should be defined:
+
+	// The line will be indented at the same level of the line
+	// which contains the matching given bracket type.
+	matchOpenBracket?:string;
+
+	// The text will be appended after the electric character.
+	appendText?:string;
+
+	// The number of characters to advance the cursor, useful with appendText
+	advanceCount?:number;
+}
+
+export enum IndentAction {
+	None,
+	Indent,
+	IndentOutdent,
+	Outdent
 }
 
 /**
- * Definition of documentation comments (e.g. Javadoc/JSdoc)
+ * An action the editor executes when 'enter' is being pressed
  */
-export interface IDocComment {
-	scope: string; // What tokens should be used to detect a doc comment (e.g. 'comment.documentation').
-	open: string; // The string that starts a doc comment (e.g. '/**')
-	lineStart: string; // The string that appears at the start of each line, except the first and last (e.g. ' * ').
-	close?: string; // The string that appears on the last line and closes the doc comment (e.g. ' */').
+export interface IEnterAction {
+	indentAction:IndentAction;
+	appendText?:string;
+	removeText?:number;
 }
 
-export interface IAutoClosingPairConditional extends IAutoClosingPair {
-	notIn?: string[];
+export interface IRichEditElectricCharacter {
+	getElectricCharacters():string[];
+	// Should return opening bracket type to match indentation with
+	onElectricCharacter(context:ILineContext, offset:number):IElectricAction;
+}
+
+export interface IRichEditOnEnter {
+	onEnter(model:EditorCommon.ITokenizedModel, position: EditorCommon.IPosition): IEnterAction;
 }
 
-export interface ICharacterPairContribution {
-	autoClosingPairs: IAutoClosingPairConditional[];
-	surroundingPairs?: IAutoClosingPair[];
-}
\ No newline at end of file
+/**
+ * Interface used to support insertion of mode specific comments.
+ */
+export interface ICommentsConfiguration {
+	lineCommentToken?:string;
+	blockCommentStartToken?:string;
+	blockCommentEndToken?:string;
+}
+
+/**
+ * Interface used to support insertion of matching characters like brackets and qoutes.
+ */
+export interface IAutoClosingPair {
+	open:string;
+	close:string;
+}
+export interface IRichEditCharacterPair {
+	getAutoClosingPairs():IAutoClosingPairConditional[];
+	shouldAutoClosePair(character:string, context:ILineContext, offset:number):boolean;
+	getSurroundingPairs():IAutoClosingPair[];
+}
+
+export interface IRichEditBrackets {
+	maxBracketLength: number;
+	forwardRegex: RegExp;
+	reversedRegex: RegExp;
+	brackets: EditorCommon.IRichEditBracket[];
+	textIsBracket: {[text:string]:EditorCommon.IRichEditBracket;};
+	textIsOpenBracket: {[text:string]:boolean;};
+}
+
+export interface IRichEditSupport {
+	/**
+	 * Optional adapter for electric characters.
+	 */
+	electricCharacter?:IRichEditElectricCharacter;
+
+	/**
+	 * Optional adapter for comment insertion.
+	 */
+	comments?:ICommentsConfiguration;
+
+	/**
+	 * Optional adapter for insertion of character pair.
+	 */
+	characterPair?:IRichEditCharacterPair;
+
+	/**
+	 * Optional adapter for classification of tokens.
+	 */
+	wordDefinition?: RegExp;
+
+	/**
+	 * Optional adapter for custom Enter handling.
+	 */
+	onEnter?: IRichEditOnEnter;
+
+	/**
+	 * Optional adapter for brackets.
+	 */
+	brackets?: IRichEditBrackets;
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/abstractMode.ts
code:
@@ -41,8 +41,6 @@ export class AbstractMode<W extends AbstractModeWorker> implements Modes.IMode {
 	public dirtyDiffSupport:Modes.IDirtyDiffSupport;
 	public linkSupport:Modes.ILinkSupport;
 	public configSupport:Modes.IConfigurationSupport;
-	public commentsSupport:Modes.ICommentsSupport;
-	public tokenTypeClassificationSupport:Modes.ITokenTypeClassificationSupport;
 	public codeLensSupport:Modes.ICodeLensSupport;
 
 	// adapters end
@@ -68,8 +66,6 @@ export class AbstractMode<W extends AbstractModeWorker> implements Modes.IMode {
 		this.dirtyDiffSupport = this;
 		this.linkSupport = this;
 		this.configSupport = this;
-		this.commentsSupport = this;
-		this.tokenTypeClassificationSupport = this;
 
 		this._workerPiecePromise = null;
 		this._simplifiedMode = null;
@@ -228,24 +224,12 @@ export class AbstractMode<W extends AbstractModeWorker> implements Modes.IMode {
 	}
 
 	// END
-
-	public getWordDefinition():RegExp {
-		return NullMode.DEFAULT_WORD_REGEXP;
-	}
-
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return null;
-	}
 }
 
 class SimplifiedMode implements Modes.IMode {
 
 	tokenizationSupport: Modes.ITokenizationSupport;
-	electricCharacterSupport: Modes.IElectricCharacterSupport;
-	commentsSupport: Modes.ICommentsSupport;
-	characterPairSupport: Modes.ICharacterPairSupport;
-	tokenTypeClassificationSupport: Modes.ITokenTypeClassificationSupport;
-	onEnterSupport: Modes.IOnEnterSupport;
+	richEditSupport: Modes.IRichEditSupport;
 
 	private _sourceMode: Modes.IMode;
 	private _eventEmitter: EventEmitter;
@@ -259,7 +243,7 @@ class SimplifiedMode implements Modes.IMode {
 
 		if (this._sourceMode.addSupportChangedListener) {
 			this._sourceMode.addSupportChangedListener((e) => {
-				if (e.tokenizationSupport || e.electricCharacterSupport || e.commentsSupport || e.characterPairSupport || e.tokenTypeClassificationSupport || e.onEnterSupport) {
+				if (e.tokenizationSupport || e.richEditSupport) {
 					this._assignSupports();
 					let newEvent = SimplifiedMode._createModeSupportChangedEvent(e);
 					this._eventEmitter.emit('modeSupportChanged', newEvent);
@@ -278,11 +262,7 @@ class SimplifiedMode implements Modes.IMode {
 
 	private _assignSupports(): void {
 		this.tokenizationSupport = this._sourceMode.tokenizationSupport;
-		this.electricCharacterSupport = this._sourceMode.electricCharacterSupport;
-		this.commentsSupport = this._sourceMode.commentsSupport;
-		this.characterPairSupport = this._sourceMode.characterPairSupport;
-		this.tokenTypeClassificationSupport = this._sourceMode.tokenTypeClassificationSupport;
-		this.onEnterSupport = this._sourceMode.onEnterSupport;
+		this.richEditSupport = this._sourceMode.richEditSupport;
 	}
 
 	private static _createModeSupportChangedEvent(originalModeEvent:EditorCommon.IModeSupportChangedEvent): EditorCommon.IModeSupportChangedEvent {
@@ -306,12 +286,8 @@ class SimplifiedMode implements Modes.IMode {
 			emitOutputSupport:false,
 			linkSupport:false,
 			configSupport:false,
-			electricCharacterSupport: originalModeEvent.electricCharacterSupport,
-			commentsSupport: originalModeEvent.commentsSupport,
-			characterPairSupport: originalModeEvent.characterPairSupport,
-			tokenTypeClassificationSupport: originalModeEvent.tokenTypeClassificationSupport,
 			quickFixSupport:false,
-			onEnterSupport: originalModeEvent.onEnterSupport
+			richEditSupport: originalModeEvent.richEditSupport,
 		};
 		return event;
 	}
@@ -392,7 +368,7 @@ export class FrankensteinMode extends AbstractMode<AbstractModeWorker> {
 }
 
 function _createModeSupportChangedEvent(...changedSupports: string[]): EditorCommon.IModeSupportChangedEvent {
-	var event = {
+	var event:EditorCommon.IModeSupportChangedEvent = {
 		codeLensSupport: false,
 		tokenizationSupport:false,
 		occurrencesSupport:false,
@@ -412,12 +388,8 @@ function _createModeSupportChangedEvent(...changedSupports: string[]): EditorCom
 		emitOutputSupport:false,
 		linkSupport:false,
 		configSupport:false,
-		electricCharacterSupport:false,
-		commentsSupport:false,
-		characterPairSupport:false,
-		tokenTypeClassificationSupport:false,
 		quickFixSupport:false,
-		onEnterSupport: false
+		richEditSupport: false
 	};
 	changedSupports.forEach(support => event[support] = true);
 	return event;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/abstractModeWorker.ts
code:
@@ -11,11 +11,11 @@ import {computeLinks} from 'vs/editor/common/modes/linkComputer';
 import {DiffComputer} from 'vs/editor/common/diff/diffComputer';
 import {DefaultFilter} from 'vs/editor/common/modes/modesFilters';
 import {TextModel} from 'vs/editor/common/model/textModel';
-import {WorkerInplaceReplaceSupport} from 'vs/editor/common/modes/supports';
 import {ValidationHelper} from 'vs/editor/common/worker/validationHelper';
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import {TPromise} from 'vs/base/common/winjs.base';
+import {WorkerInplaceReplaceSupport} from 'vs/editor/common/modes/supports/inplaceReplaceSupport';
 
 export class AbstractModeWorker {
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/autoIndentation.ts
code:
@@ -1,291 +0,0 @@
-/*---------------------------------------------------------------------------------------------
- *  Copyright (c) Microsoft Corporation. All rights reserved.
- *  Licensed under the MIT License. See License.txt in the project root for license information.
- *--------------------------------------------------------------------------------------------*/
-'use strict';
-
-import Strings = require('vs/base/common/strings');
-import Modes = require('vs/editor/common/modes');
-
-enum Lettercase { Unknown, Lowercase, Uppercase, Camelcase}
-
-export class Brackets {
-
-	private brackets: Modes.IBracketPair[];
-	private regexBrackets: Modes.IRegexBracketPair[];
-	private docComment: Modes.IDocComment;
-	private caseInsensitive: boolean;
-
-	/**
-	 * In case of case insensitive brackets, these assumptions must be met:
-	 * - all standard brackets are passed as lowercase
-	 * - the passed regular expressions already contain the /i flag
-	 *
-	 * Brackets defined in 'regexBrackets' are not used in the following methods:
-	 * - stringIsBracket
-	 *
-	 */
-	constructor(brackets: Modes.IBracketPair[], regexBrackets: Modes.IRegexBracketPair[] = [], docComment: Modes.IDocComment = null,
-		caseInsensitive: boolean = false) {
-		this.brackets = brackets;
-		this.regexBrackets = regexBrackets ? regexBrackets : [];
-		this.docComment = docComment ? docComment : null;
-		this.caseInsensitive = caseInsensitive ? caseInsensitive : false;
-	}
-
-	public getElectricCharacters():string[] {
-		var result: string[] = [];
-
-		// Plain brackets
-		var bracketPair: Modes.IBracketPair;
-		var length = this.brackets.length;
-		for (var i = 0; i < length; i++) {
-			bracketPair = this.brackets[i];
-			if (bracketPair.isElectric) {
-				var lastChar = bracketPair.close.charAt(bracketPair.close.length - 1);
-				result.push(this.caseInsensitive ? lastChar.toLowerCase() : lastChar);
-			}
-		}
-
-		// Regexp brackets (always electric)
-		var regexBracketPair: Modes.IRegexBracketPair;
-		length = this.regexBrackets.length;
-		for (var i = 0; i < length; i++) {
-			regexBracketPair = this.regexBrackets[i];
-			if (regexBracketPair.openTrigger) {
-				result.push( this.caseInsensitive ? regexBracketPair.openTrigger.toLowerCase() : regexBracketPair.openTrigger);
-			}
-			if (regexBracketPair.closeTrigger) {
-				result.push( this.caseInsensitive ? regexBracketPair.closeTrigger.toLowerCase() : regexBracketPair.closeTrigger);
-			}
-		}
-
-		// Doc comments
-		if (this.docComment){
-			result.push(this.docComment.open.charAt(this.docComment.open.length - 1));
-		}
-
-		// Add uppercase if needed
-		if (this.caseInsensitive)
-		{
-			var oldLength = result.length;
-			for (var i = 0; i < oldLength; ++i) {
-				result.push(result[i].toUpperCase());
-			}
-		}
-
-		// Filter duplicate entries
-		result = result.filter((item, pos, array) => {
-			return array.indexOf(item) === pos;
-		});
-
-		return result;
-	}
-
-	public onEnter(context: Modes.ILineContext, offset: number): Modes.IEnterAction {
-		if (context.getTokenCount() === 0) {
-			return null;
-		}
-
-		return this._onEnterRegexBrackets(context, offset);
-	}
-
-	public onElectricCharacter(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
-		if (context.getTokenCount() === 0) {
-			return null;
-		}
-
-		return (this._onElectricCharacterDocComment(context, offset) ||
-			this._onElectricCharacterRegexBrackets(context, offset) ||
-			this._onElectricCharacterStandardBrackets(context, offset));
-	}
-
-	public stringIsBracket(text: string): boolean {
-		var caseCorrectString = text;
-		if (this.caseInsensitive) {
-			caseCorrectString = text.toLowerCase();
-		}
-
-		var bracketPair: Modes.IBracketPair;
-		for (var i = 0; i < this.brackets.length; i++) {
-			bracketPair = this.brackets[i];
-			if (caseCorrectString === bracketPair.open || caseCorrectString === bracketPair.close) {
-				return true;
-			}
-		}
-		return false;
-	}
-
-	private containsTokenTypes(fullTokenSpec: string, tokensToLookFor: string): boolean {
-		var array = tokensToLookFor.split('.');
-		for (var i = 0; i < array.length; ++i) {
-			if (fullTokenSpec.indexOf(array[i]) < 0) {
-				return false;
-			}
-		}
-		return true;
-	}
-
-	private _onEnterRegexBrackets(context: Modes.ILineContext, offset: number): Modes.IEnterAction {
-		// Handle regular expression brackets
-		for (var i = 0; i < this.regexBrackets.length; ++i) {
-			var regexBracket = this.regexBrackets[i];
-			var line = context.getLineContent();
-
-			if (this.caseInsensitive) {
-				line = line.toLowerCase(); // Even with the /../i regexes we need this for the indexof below
-			}
-
-			// Check if an open bracket matches the line up to offset.
-			var matchLine = line.substr(0, offset);
-			var matches = matchLine.match(regexBracket.open);
-
-			if (matches) {
-
-				// The opening bracket matches. Check the closing one.
-				if (regexBracket.closeComplete) {
-					matchLine = line.substring(offset);
-					var matchAfter = matches[0].replace(regexBracket.open, regexBracket.closeComplete);
-					if (matchLine.indexOf(matchAfter) === 0) {
-						return { indentAction: Modes.IndentAction.IndentOutdent };
-					}
-				}
-
-				return { indentAction: Modes.IndentAction.Indent };
-			}
-		}
-
-		return null;
-	}
-
-	private _onElectricCharacterStandardBrackets(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
-		var tokenIndex = context.findIndexOfOffset(offset);
-		var tokenText = context.getTokenText(tokenIndex);
-		var tokenType = context.getTokenType(tokenIndex);
-		if (!this.stringIsBracket(tokenText)) {
-			// This is not a brace type that we are aware of.
-			// Keep in mind that tokenType above might be different than what this.tokenTypeFromString(tokenText)
-			// returns, which could happen when using TextMate bundles.
-			return null;
-		}
-
-		if (tokenIndex >= 0 && context.getTokenEndIndex(tokenIndex)-1 > offset) {
-			// We're in the middle of a token, do not do anything
-			return null;
-		}
-
-		var firstNonWhitespaceIndex = Strings.firstNonWhitespaceIndex(context.getLineContent());
-
-		if (firstNonWhitespaceIndex !== -1 && firstNonWhitespaceIndex <= offset-tokenText.length) {
-			return null;
-		}
-
-		return { matchBracketType: tokenType };
-	}
-
-	private _onElectricCharacterRegexBrackets(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
-		// Handle regular expression brackets
-		var line = context.getLineContent();
-		for (var i = 0; i < this.regexBrackets.length; ++i) {
-			var regexBracket = this.regexBrackets[i];
-
-			// Check if an open bracket matches the line up to offset.
-			if (regexBracket.openTrigger && regexBracket.closeComplete &&
-				(line.charAt(offset) === regexBracket.openTrigger ||
-					(this.caseInsensitive && line.charAt(offset).toLowerCase() === regexBracket.openTrigger.toLowerCase()))) {
-
-				var matchLine = line.substr(0, offset+1);
-				var matches = matchLine.match(regexBracket.open);
-				if (matches) {
-					// Auto-complete with closing bracket.
-					var finalText = matches[0].replace(regexBracket.open, regexBracket.closeComplete);
-					if (regexBracket.matchCase) {
-						finalText = this._changeLettercase(finalText, this._detectLetercase(matches[0]));
-					}
-					return { appendText: finalText };
-				}
-			}
-
-			// Check if a close bracket matches the line up to offset.
-			if (regexBracket.closeTrigger &&
-					(line.charAt(offset) === regexBracket.closeTrigger ||
-						(this.caseInsensitive && line.charAt(offset).toLowerCase() === regexBracket.closeTrigger.toLowerCase()))) {
-				var matches = matchLine.match(regexBracket.close);
-				if (matches) {
-					// Auto-indent to the level of the opening bracket.
-					var properCaseMatch = matches[0];
-					if (this.caseInsensitive) {
-						properCaseMatch = properCaseMatch.toLowerCase();
-					}
-					return { matchBracketType: properCaseMatch.replace(regexBracket.close, regexBracket.tokenType)};
-				}
-			}
-		}
-		return null;
-	}
-
-	private _onElectricCharacterDocComment(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
-		// We only auto-close, so do nothing if there is no closing part.
-		if (!this.docComment || !this.docComment.close) {
-			return null;
-		}
-
-		var line = context.getLineContent();
-		var char: string = line[offset];
-
-		// See if the right electric character was pressed
-		if (char !== this.docComment.open.charAt(this.docComment.open.length - 1)) {
-			return null;
-		}
-
-		// If this line already contains the closing tag, do nothing.
-		if (line.indexOf(this.docComment.close, offset) >= 0) {
-			return null;
-		}
-
-		// If we're not in a documentation comment, do nothing.
-		var lastTokenIndex = context.findIndexOfOffset(offset);
-		if (! this.containsTokenTypes(context.getTokenType(lastTokenIndex), this.docComment.scope)) {
-			return null;
-		}
-
-		if (line.substring(context.getTokenStartIndex(lastTokenIndex), offset+1/* include electric char*/) !== this.docComment.open) {
-			return null;
-		}
-
-		return { appendText: this.docComment.close};
-	}
-
-	private _detectLetercase(s: string): Lettercase {
-		if (s.toLowerCase() === s) {
-			return Lettercase.Lowercase;
-		}
-		if (s.toUpperCase() === s) {
-			return Lettercase.Uppercase;
-		}
-		if (s.length > 1) {
-			if (s.charAt(0).toUpperCase() === s.charAt(0) && s.charAt(1).toLowerCase() === s.charAt(1)) {
-				return Lettercase.Camelcase;
-			}
-		}
-
-		return Lettercase.Unknown;
-	}
-
-	private _changeLettercase(s: string, newCase: Lettercase): string {
-		switch (newCase) {
-			case Lettercase.Lowercase:
-				return s.toLowerCase();
-			case Lettercase.Uppercase:
-				return s.toUpperCase();
-			case Lettercase.Camelcase:
-				var words = s.toLowerCase().split(' ');
-				for (var i = 0; i < words.length; ++i) {
-					words[i] = words[i].charAt(0).toUpperCase() + words[i].substr(1);
-				}
-				return words.join(' ');
-			default:
-				return s;
-		}
-	}
-}
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/languageExtensionPoint.ts
code:
@@ -164,7 +164,6 @@ export interface ILanguageExtensionPointHandler {
 
 	isRegisteredMode(mimetypeOrModeId: string): boolean;
 	getRegisteredModes(): string[];
-	getRegisteredMimetypes(): string[];
 	getRegisteredLanguageNames(): string[];
 	getLanguageName(modeId: string): string;
 	getExtensions(languageName: string): string[];
@@ -398,10 +397,6 @@ class LanguageExtensionPointHandler implements IThreadSynchronizableObject<ILang
 		return Object.keys(this.knownModeIds);
 	}
 
-	public getRegisteredMimetypes(): string[] {
-		return Object.keys(this.mime2LanguageId);
-	}
-
 	public getRegisteredLanguageNames(): string[]{
 		return Object.keys(this.name2LanguageId);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/modesRegistry.ts
code:
@@ -26,17 +26,6 @@ export interface IEditorModesRegistry {
 
 	// --- modes registration
 	registerMode(def:ILegacyLanguageDefinition): void;
-
-	// --- reading
-	isRegisteredMode(modeName: string): boolean;
-	getRegisteredModes(): string[];
-	getRegisteredMimetypes(): string[];
-	getRegisteredLanguageNames(): string[];
-	getExtensions(alias: string): string[];
-	getMimeForMode(modeId: string): string;
-	getLanguageName(modeId:string): string;
-	getModeIdForLanguageName(alias:string): string;
-	getModeId(commaSeparatedMimetypesOrCommaSeparatedIds: string): string;
 }
 
 class EditorModesRegistry implements IEditorModesRegistry {
@@ -69,53 +58,9 @@ class EditorModesRegistry implements IEditorModesRegistry {
 		return this.workerParticipants.filter(p => p.modeId === modeId);
 	}
 
-	// --- modes registration
-
-	public isRegisteredMode(mimetypeOrModeId: string): boolean {
-		return LanguageExtensions.isRegisteredMode(mimetypeOrModeId);
-	}
-
-	public getRegisteredModes(): string[] {
-		return LanguageExtensions.getRegisteredModes();
-	}
-
-	public getRegisteredMimetypes(): string[] {
-		return LanguageExtensions.getRegisteredMimetypes();
-	}
-
-	public getRegisteredLanguageNames(): string[] {
-		return LanguageExtensions.getRegisteredLanguageNames();
-	}
-
-	public getExtensions(alias: string): string[] {
-		return LanguageExtensions.getExtensions(alias);
-	}
-
-	public getMimeForMode(modeId: string): string {
-		return LanguageExtensions.getMimeForMode(modeId);
-	}
-
-	public getLanguageName(modeId: string): string {
-		return LanguageExtensions.getLanguageName(modeId);
-	}
-
-	public getModeIdForLanguageName(alias:string): string {
-		return LanguageExtensions.getModeIdForLanguageNameLowercase(alias);
-	}
-
 	public registerMode(def:ILegacyLanguageDefinition): void {
 		LanguageExtensions.registerCompatMode(def);
 	}
-
-	public getModeId(commaSeparatedMimetypesOrCommaSeparatedIds: string): string {
-		var modeIds = LanguageExtensions.extractModeIds(commaSeparatedMimetypesOrCommaSeparatedIds);
-
-		if (modeIds.length > 0) {
-			return modeIds[0];
-		}
-
-		return null;
-	}
 }
 
 var mR = new EditorModesRegistry();

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarch.ts
code:
@@ -11,25 +11,24 @@
 
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
-import Supports = require('vs/editor/common/modes/supports');
 import {ILexer} from 'vs/editor/common/modes/monarch/monarchCommon';
 import Modes = require('vs/editor/common/modes');
 import MonarchDefinition = require('vs/editor/common/modes/monarch/monarchDefinition');
 import {createTokenizationSupport} from 'vs/editor/common/modes/monarch/monarchLexer';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {IModelService} from 'vs/editor/common/services/modelService';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {ComposableSuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 /**
  * The MonarchMode creates a Monaco language mode given a certain language description
  */
 export class MonarchMode<W extends AbstractModeWorker> extends AbstractMode<W> {
+
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
-	public onEnterSupport: Modes.IOnEnterSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	constructor(
 		descriptor:Modes.IModeDescriptor,
@@ -42,11 +41,9 @@ export class MonarchMode<W extends AbstractModeWorker> extends AbstractMode<W> {
 		super(descriptor, instantiationService, threadService);
 
 		this.tokenizationSupport = createTokenizationSupport(modeService, this, lexer);
-		this.electricCharacterSupport = new Supports.BracketElectricCharacterSupport(this, MonarchDefinition.createBracketElectricCharacterContribution(lexer));
-		this.commentsSupport = new Supports.CommentsSupport(MonarchDefinition.createCommentsSupport(lexer));
-		this.tokenTypeClassificationSupport = new Supports.TokenTypeClassificationSupport(MonarchDefinition.createTokenTypeClassificationSupportContribution(lexer));
-		this.characterPairSupport = new Supports.CharacterPairSupport(this, MonarchDefinition.createCharacterPairContribution(lexer));
-		this.suggestSupport = new Supports.ComposableSuggestSupport(this, MonarchDefinition.createSuggestSupport(modelService, this, lexer));
-		this.onEnterSupport = new OnEnterSupport(this.getId(), MonarchDefinition.createOnEnterSupportOptions(lexer));
+
+		this.richEditSupport = new RichEditSupport(this.getId(), MonarchDefinition.createRichEditSupport(lexer));
+
+		this.suggestSupport = new ComposableSuggestSupport(this.getId(), MonarchDefinition.createSuggestSupport(modelService, this, lexer));
 	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchCommon.ts
code:
@@ -48,7 +48,7 @@ export interface ILexer extends ILexerMin {
 	autoClosingPairs: Modes.IAutoClosingPairConditional[];
 
 	standardBrackets: Modes.IBracketPair[];
-	enhancedBrackets: Modes.IRegexBracketPair[];
+	// enhancedBrackets: Modes.IRegexBracketPair[];
 	outdentTriggers: string;
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchCompile.ts
code:
@@ -646,46 +646,46 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	}
 
 	// Set enhanced brackets
-	var enhancedBrackets : Modes.IRegexBracketPair[] = [];
-	if (json.enhancedBrackets) {
-		if (!(Array.isArray(<any>json.enhancedBrackets))) {
-			MonarchCommonTypes.throwError(lexer, 'the \'enhancedBrackets\' attribute must be defined as an array');
-		}
-
-		for (var bracketIdx in json.enhancedBrackets) {
-			if (json.enhancedBrackets.hasOwnProperty(bracketIdx)) {
-				var desc = <any> json.enhancedBrackets[bracketIdx];
-				if (desc.hasOwnProperty('openTrigger') && typeof (desc.openTrigger) !== 'string') {
-					MonarchCommonTypes.throwError(lexer, 'openTrigger in the \'enhancedBrackets\' array must be a string');
-				}
-				if (desc.hasOwnProperty('open') && !(desc.open instanceof RegExp)) {
-					MonarchCommonTypes.throwError(lexer, 'open in the \'enhancedBrackets\' array must be a regex');
-				}
-				if (desc.hasOwnProperty('closeComplete') && typeof (desc.closeComplete) !== 'string') {
-					MonarchCommonTypes.throwError(lexer, 'closeComplete in the \'enhancedBrackets\' array must be a string');
-				}
-				if (desc.hasOwnProperty('matchCase') && typeof (desc.matchCase) !== 'boolean') {
-					MonarchCommonTypes.throwError(lexer, 'matchCase in the \'enhancedBrackets\' array must be a boolean');
-				}
-				if (desc.hasOwnProperty('closeTrigger') && typeof (desc.closeTrigger) !== 'string') {
-					MonarchCommonTypes.throwError(lexer, 'closeTrigger in the \'enhancedBrackets\' array must be a string');
-				}
-				if (desc.hasOwnProperty('close') && !(desc.close instanceof RegExp)) {
-					MonarchCommonTypes.throwError(lexer, 'close in the \'enhancedBrackets\' array must be a regex');
-				}
-				if (desc.hasOwnProperty('tokenType')) {
-					if (typeof (desc.tokenType) !== 'string') {
-						MonarchCommonTypes.throwError(lexer, 'tokenType in the \'enhancedBrackets\' array must be a string');
-					}
-					else {
-						desc.tokenType += lexer.tokenPostfix;
-					}
-				}
-				enhancedBrackets.push(desc);
-			}
-		}
-	}
-	lexer.enhancedBrackets = enhancedBrackets;
+	// var enhancedBrackets : Modes.IRegexBracketPair[] = [];
+	// if (json.enhancedBrackets) {
+	// 	if (!(Array.isArray(<any>json.enhancedBrackets))) {
+	// 		MonarchCommonTypes.throwError(lexer, 'the \'enhancedBrackets\' attribute must be defined as an array');
+	// 	}
+
+	// 	for (var bracketIdx in json.enhancedBrackets) {
+	// 		if (json.enhancedBrackets.hasOwnProperty(bracketIdx)) {
+	// 			var desc = <any> json.enhancedBrackets[bracketIdx];
+	// 			if (desc.hasOwnProperty('openTrigger') && typeof (desc.openTrigger) !== 'string') {
+	// 				MonarchCommonTypes.throwError(lexer, 'openTrigger in the \'enhancedBrackets\' array must be a string');
+	// 			}
+	// 			if (desc.hasOwnProperty('open') && !(desc.open instanceof RegExp)) {
+	// 				MonarchCommonTypes.throwError(lexer, 'open in the \'enhancedBrackets\' array must be a regex');
+	// 			}
+	// 			if (desc.hasOwnProperty('closeComplete') && typeof (desc.closeComplete) !== 'string') {
+	// 				MonarchCommonTypes.throwError(lexer, 'closeComplete in the \'enhancedBrackets\' array must be a string');
+	// 			}
+	// 			if (desc.hasOwnProperty('matchCase') && typeof (desc.matchCase) !== 'boolean') {
+	// 				MonarchCommonTypes.throwError(lexer, 'matchCase in the \'enhancedBrackets\' array must be a boolean');
+	// 			}
+	// 			if (desc.hasOwnProperty('closeTrigger') && typeof (desc.closeTrigger) !== 'string') {
+	// 				MonarchCommonTypes.throwError(lexer, 'closeTrigger in the \'enhancedBrackets\' array must be a string');
+	// 			}
+	// 			if (desc.hasOwnProperty('close') && !(desc.close instanceof RegExp)) {
+	// 				MonarchCommonTypes.throwError(lexer, 'close in the \'enhancedBrackets\' array must be a regex');
+	// 			}
+	// 			if (desc.hasOwnProperty('tokenType')) {
+	// 				if (typeof (desc.tokenType) !== 'string') {
+	// 					MonarchCommonTypes.throwError(lexer, 'tokenType in the \'enhancedBrackets\' array must be a string');
+	// 				}
+	// 				else {
+	// 					desc.tokenType += lexer.tokenPostfix;
+	// 				}
+	// 			}
+	// 			enhancedBrackets.push(desc);
+	// 		}
+	// 	}
+	// }
+	// lexer.enhancedBrackets = enhancedBrackets;
 
 	var standardBrackets: Modes.IBracketPair[] = [];
 	for (var i = 0; i < brackets.length; ++i) {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchDefinition.ts
code:
@@ -11,41 +11,44 @@
 
 import {TPromise} from 'vs/base/common/winjs.base';
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
-import Supports = require('vs/editor/common/modes/supports');
 import MonarchCommonTypes = require('vs/editor/common/modes/monarch/monarchCommon');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import {IModelService} from 'vs/editor/common/services/modelService';
 import Modes = require('vs/editor/common/modes');
-import {IOnEnterSupportOptions} from 'vs/editor/common/modes/supports/onEnter';
+import {CharacterPair, IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
+import {IComposableSuggestContribution} from 'vs/editor/common/modes/supports/suggestSupport';
 
-export function createCommentsSupport(lexer: MonarchCommonTypes.ILexer): Supports.ICommentsSupportContribution {
-	return {
-		commentsConfiguration: {
-			lineCommentTokens: [lexer.lineComment],
-			blockCommentStartToken: lexer.blockCommentStart,
-			blockCommentEndToken: lexer.blockCommentEnd
-		}
-	};
-}
+export function createRichEditSupport(lexer: MonarchCommonTypes.ILexer): IRichEditConfiguration {
 
-export function createBracketElectricCharacterContribution(lexer: MonarchCommonTypes.ILexer): Supports.IBracketElectricCharacterContribution {
-	return {
-		brackets: lexer.standardBrackets,
-		regexBrackets: lexer.enhancedBrackets,
-		caseInsensitive: lexer.ignoreCase,
-		embeddedElectricCharacters: lexer.outdentTriggers.split('')
-	};
-}
+	function toBracket(input:Modes.IBracketPair): CharacterPair {
+		return [input.open, input.close];
+	}
 
-export function createTokenTypeClassificationSupportContribution(lexer: MonarchCommonTypes.ILexer): Supports.ITokenTypeClassificationSupportContribution {
-	return {
-		wordDefinition: lexer.wordDefinition
-	};
-}
+	function toBrackets(input:Modes.IBracketPair[]): CharacterPair[] {
+		return input.map(toBracket);
+	}
 
-export function createCharacterPairContribution(lexer: MonarchCommonTypes.ILexer): Modes.ICharacterPairContribution {
 	return {
-		autoClosingPairs: lexer.autoClosingPairs
+
+		wordPattern: lexer.wordDefinition,
+
+		comments: {
+			lineComment: lexer.lineComment,
+			blockComment: [lexer.blockCommentStart, lexer.blockCommentEnd]
+		},
+
+		brackets: toBrackets(lexer.standardBrackets),
+
+		__electricCharacterSupport: {
+			brackets: lexer.standardBrackets,
+			// regexBrackets: lexer.enhancedBrackets,
+			caseInsensitive: lexer.ignoreCase,
+			embeddedElectricCharacters: lexer.outdentTriggers.split('')
+		},
+
+		__characterPairSupport: {
+			autoClosingPairs: lexer.autoClosingPairs
+		}
 	};
 }
 
@@ -67,13 +70,7 @@ function _addSuggestionsAtPosition(model: EditorCommon.IModel, position:EditorCo
 	return superSuggestions;
 }
 
-export function createOnEnterSupportOptions(lexer:MonarchCommonTypes.ILexer): IOnEnterSupportOptions {
-	return {
-		brackets: lexer.standardBrackets
-	};
-}
-
-export function createSuggestSupport(modelService: IModelService, mode:Modes.IMode, lexer:MonarchCommonTypes.ILexer): Supports.IComposableSuggestContribution {
+export function createSuggestSupport(modelService: IModelService, mode:Modes.IMode, lexer:MonarchCommonTypes.ILexer): IComposableSuggestContribution {
 	if (lexer.suggestSupport.textualCompletions && mode instanceof AbstractMode) {
 		return {
 			triggerCharacters:lexer.suggestSupport.triggerCharacters,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchLexer.ts
code:
@@ -11,14 +11,10 @@
 
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import {LineStream} from 'vs/editor/common/modes/lineStream';
-import ModesRegistry = require('vs/editor/common/modes/modesRegistry');
-import Supports = require('vs/editor/common/modes/supports');
 import MonarchCommonTypes = require('vs/editor/common/modes/monarch/monarchCommon');
 import Modes = require('vs/editor/common/modes');
-import {Registry} from 'vs/platform/platform';
 import {IModeService} from 'vs/editor/common/services/modeService';
-
-var modesRegistry = <ModesRegistry.IEditorModesRegistry>Registry.as(ModesRegistry.Extensions.EditorModes);
+import {TokenizationSupport, IEnteringNestedModeData} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 /**
  * The MonarchLexer class implements a monaco lexer that highlights source code.
@@ -29,6 +25,8 @@ export class MonarchLexer extends AbstractState {
 
 	static ID = 0;
 
+	private modeService:IModeService;
+
 	private id: number;
 	private lexer: MonarchCommonTypes.ILexer;
 	private stack: string[];
@@ -41,9 +39,10 @@ export class MonarchLexer extends AbstractState {
 	private groupMatched: string[];
 	private groupRule: MonarchCommonTypes.IRule;
 
-	constructor(mode: Modes.IMode, lexer: MonarchCommonTypes.ILexer, stack?: string[], embeddedMode?: string) {
+	constructor(mode: Modes.IMode, modeService:IModeService, lexer: MonarchCommonTypes.ILexer, stack?: string[], embeddedMode?: string) {
 		super(mode);
 		this.id = MonarchLexer.ID++; // for debugging, assigns unique id to each instance
+		this.modeService = modeService;
 
 		this.lexer = lexer; // (compiled) lexer description
 		this.stack = (stack ? stack : [lexer.start]); // stack of states
@@ -62,7 +61,7 @@ export class MonarchLexer extends AbstractState {
 	}
 
 	public makeClone(): MonarchLexer {
-		return new MonarchLexer(this.getMode(), this.lexer, this.stack.slice(0), this.embeddedMode);
+		return new MonarchLexer(this.getMode(), this.modeService, this.lexer, this.stack.slice(0), this.embeddedMode);
 	}
 
 	public equals(other: Modes.IState): boolean {
@@ -219,7 +218,7 @@ export class MonarchLexer extends AbstractState {
 					this.embeddedMode = MonarchCommonTypes.substituteMatches(this.lexer, action.nextEmbedded, matched, matches, state);
 
 					// substitute language alias to known modes to support syntax highlighting
-					var embeddedMode = modesRegistry.getModeIdForLanguageName(this.embeddedMode);
+					var embeddedMode = this.modeService.getModeIdForLanguageName(this.embeddedMode);
 					if (this.embeddedMode && embeddedMode) {
 						this.embeddedMode = embeddedMode;
 					}
@@ -388,9 +387,9 @@ function findBracket(lexer: MonarchCommonTypes.ILexer, matched: string) {
 }
 
 export function createTokenizationSupport(modeService:IModeService, mode:Modes.IMode, lexer: MonarchCommonTypes.ILexer): Modes.ITokenizationSupport {
-	return new Supports.TokenizationSupport(mode, {
+	return new TokenizationSupport(mode, {
 		getInitialState: (): Modes.IState => {
-			return new MonarchLexer(mode, lexer);
+			return new MonarchLexer(mode, modeService, lexer);
 		},
 
 		enterNestedMode: (state: Modes.IState): boolean => {
@@ -400,10 +399,10 @@ export function createTokenizationSupport(modeService:IModeService, mode:Modes.I
 			return false;
 		},
 
-		getNestedMode: (rawState: Modes.IState): Supports.IEnteringNestedModeData => {
+		getNestedMode: (rawState: Modes.IState): IEnteringNestedModeData => {
 			var mime = (<MonarchLexer>rawState).embeddedMode;
 
-			if (!modesRegistry.isRegisteredMode(mime)) {
+			if (!modeService.isRegisteredMode(mime)) {
 				// unknown mode
 				return {
 					mode: modeService.getMode('text/plain'),

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchTypes.ts
code:
@@ -75,10 +75,10 @@ export interface ILanguage {
 	 * characters that could potentially cause outdentation
 	 */
 	outdentTriggers?: string;
-	/**
-	 * Advanced auto completion, auto indenting, and bracket matching
-	 */
-	enhancedBrackets?: Modes.IRegexBracketPair[];
+	// /**
+	//  * Advanced auto completion, auto indenting, and bracket matching
+	//  */
+	// enhancedBrackets?: Modes.IRegexBracketPair[];
 
 	suggestSupport?: {
 		textualCompletions?: boolean;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/nullMode.ts
code:
@@ -80,10 +80,12 @@ export class NullMode implements Modes.IMode {
 
 	public static ID = 'vs.editor.modes.nullMode';
 
-	public tokenTypeClassificationSupport: Modes.ITokenTypeClassificationSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	constructor() {
-		this.tokenTypeClassificationSupport = this;
+		this.richEditSupport = {
+			wordDefinition: NullMode.DEFAULT_WORD_REGEXP
+		};
 	}
 
 	public getId():string {
@@ -93,18 +95,13 @@ export class NullMode implements Modes.IMode {
 	public toSimplifiedMode(): Modes.IMode {
 		return this;
 	}
-
-	public getWordDefinition():RegExp {
-		return NullMode.DEFAULT_WORD_REGEXP;
-	}
 }
 
 export function nullTokenize(mode: Modes.IMode, buffer:string, state: Modes.IState, deltaOffset:number = 0, stopAtOffset?:number): Modes.ILineTokens {
 	var tokens:Modes.IToken[] = [
 		{
 			startIndex: deltaOffset,
-			type: '',
-			bracket: Modes.Bracket.None
+			type: ''
 		}
 	];
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports.ts
code:
@@ -4,33 +4,21 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {TPromise} from 'vs/base/common/winjs.base';
 import Strings = require('vs/base/common/strings');
-import {IModelService} from 'vs/editor/common/services/modelService';
-import {LineStream} from 'vs/editor/common/modes/lineStream';
-import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
-import {Brackets} from 'vs/editor/common/modes/autoIndentation';
-import {DefaultFilter} from 'vs/editor/common/modes/modesFilters';
 import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {IResourceService} from 'vs/editor/common/services/resourceService';
 import {Arrays} from 'vs/editor/common/core/arrays';
-import URI from 'vs/base/common/uri';
-import {IDisposable} from 'vs/base/common/lifecycle';
 
 export class Token implements Modes.IToken {
 	public startIndex:number;
 	public type:string;
-	public bracket:Modes.Bracket;
 
-	constructor(startIndex:number, type:string, bracket:Modes.Bracket) {
+	constructor(startIndex:number, type:string) {
 		this.startIndex = startIndex;
 		this.type = type;
-		this.bracket = bracket;
 	}
 
 	public toString(): string {
-		return '(' + this.startIndex + ', ' + this.type + ', ' + this.bracket + ')';
+		return '(' + this.startIndex + ', ' + this.type + ')';
 	}
 }
 
@@ -146,905 +134,11 @@ export class FilteredLineContext implements Modes.ILineContext {
 		return this._actual.getTokenType(tokenIndex + this._firstTokenInModeIndex);
 	}
 
-	public getTokenBracket(tokenIndex:number): Modes.Bracket {
-		return this._actual.getTokenBracket(tokenIndex + this._firstTokenInModeIndex);
-	}
-
 	public getTokenText(tokenIndex:number): string {
 		return this._actual.getTokenText(tokenIndex + this._firstTokenInModeIndex);
 	}
 }
 
-
-export class AbstractSupport {
-
-	private _mode:Modes.IMode;
-
-	constructor(mode:Modes.IMode) {
-		this._mode = mode;
-	}
-
-	public get mode() {
-		return this._mode;
-	}
+export function ignoreBracketsInToken(tokenType:string): boolean {
+	return /\b(comment|string|regex)\b/.test(tokenType);
 }
-
-//---  Tokenazation support implementation
-
-export interface ILeavingNestedModeData {
-	/**
-	 * The part of the line that will be tokenized by the nested mode
-	 */
-	nestedModeBuffer: string;
-
-	/**
-	 * The part of the line that will be tokenized by the parent mode when it continues after the nested mode
-	 */
-	bufferAfterNestedMode: string;
-
-	/**
-	 * The state that will be used for continuing tokenization by the parent mode after the nested mode
-	 */
-	stateAfterNestedMode: Modes.IState;
-}
-
-export interface IEnteringNestedModeData {
-	mode:Modes.IMode;
-	missingModePromise:TPromise<void>;
-}
-
-export interface ITokenizationCustomization {
-
-	getInitialState():Modes.IState;
-
-	enterNestedMode?: (state:Modes.IState) => boolean;
-
-	getNestedMode?: (state:Modes.IState) => IEnteringNestedModeData;
-
-	getNestedModeInitialState?: (myState:Modes.IState) => { state:Modes.IState; missingModePromise:TPromise<void>; };
-
-	/**
-	 * Return null if the line does not leave the nested mode
-	 */
-	getLeavingNestedModeData?: (line:string, state:Modes.IState) => ILeavingNestedModeData;
-
-	/**
-	 * Callback for when leaving a nested mode and returning to the outer mode.
-	 * @param myStateAfterNestedMode The outer mode's state that will begin to tokenize
-	 * @param lastNestedModeState The nested mode's last state
-	 */
-	onReturningFromNestedMode?: (myStateAfterNestedMode:Modes.IState, lastNestedModeState:Modes.IState)=> void;
-}
-
-function isFunction(something) {
-	return typeof something === 'function';
-}
-
-export class TokenizationSupport extends AbstractSupport implements Modes.ITokenizationSupport, IDisposable {
-
-	static MAX_EMBEDDED_LEVELS = 5;
-
-	private customization:ITokenizationCustomization;
-	private defaults: {
-		enterNestedMode: boolean;
-		getNestedMode: boolean;
-		getNestedModeInitialState: boolean;
-		getLeavingNestedModeData: boolean;
-		onReturningFromNestedMode: boolean;
-	};
-
-	public shouldGenerateEmbeddedModels:boolean;
-	public supportsNestedModes:boolean;
-
-	private _embeddedModesListeners: { [modeId:string]: IDisposable; };
-
-	constructor(mode:Modes.IMode, customization:ITokenizationCustomization, supportsNestedModes:boolean, shouldGenerateEmbeddedModels:boolean) {
-		super(mode);
-		this.customization = customization;
-		this.supportsNestedModes = supportsNestedModes;
-		this._embeddedModesListeners = {};
-		if (this.supportsNestedModes) {
-			if (!this.mode.registerSupport) {
-				throw new Error('Cannot be a mode with nested modes unless I can emit a tokenizationSupport changed event!');
-			}
-		}
-		this.shouldGenerateEmbeddedModels = shouldGenerateEmbeddedModels;
-		this.defaults = {
-			enterNestedMode: !isFunction(customization.enterNestedMode),
-			getNestedMode: !isFunction(customization.getNestedMode),
-			getNestedModeInitialState: !isFunction(customization.getNestedModeInitialState),
-			getLeavingNestedModeData: !isFunction(customization.getLeavingNestedModeData),
-			onReturningFromNestedMode: !isFunction(customization.onReturningFromNestedMode)
-		};
-	}
-
-	public dispose() : void {
-		for (var listener in this._embeddedModesListeners) {
-			this._embeddedModesListeners[listener].dispose();
-			delete this._embeddedModesListeners[listener];
-		}
-	}
-
-	public getInitialState(): Modes.IState {
-		return this.customization.getInitialState();
-	}
-
-	public tokenize(line:string, state:Modes.IState, deltaOffset:number = 0, stopAtOffset:number = deltaOffset + line.length):Modes.ILineTokens {
-		if (state.getMode() !== this.mode) {
-			return this._nestedTokenize(line, state, deltaOffset, stopAtOffset, [], []);
-		} else {
-			return this._myTokenize(line, state, deltaOffset, stopAtOffset, [], []);
-		}
-	}
-
-	/**
-	 * Precondition is: nestedModeState.getMode() !== this
-	 * This means we are in a nested mode when parsing starts on this line.
-	 */
-	private _nestedTokenize(buffer:string, nestedModeState:Modes.IState, deltaOffset:number, stopAtOffset:number, prependTokens:Modes.IToken[], prependModeTransitions:Modes.IModeTransition[]):Modes.ILineTokens {
-		var myStateBeforeNestedMode = nestedModeState.getStateData();
-		var leavingNestedModeData = this.getLeavingNestedModeData(buffer, myStateBeforeNestedMode);
-
-		// Be sure to give every embedded mode the
-		// opportunity to leave nested mode.
-		// i.e. Don't go straight to the most nested mode
-		var stepOnceNestedState = nestedModeState;
-		while (stepOnceNestedState.getStateData() && stepOnceNestedState.getStateData().getMode() !== this.mode) {
-			stepOnceNestedState = stepOnceNestedState.getStateData();
-		}
-		var nestedMode = stepOnceNestedState.getMode();
-
-		if (!leavingNestedModeData) {
-			// tokenization will not leave nested mode
-			var result:Modes.ILineTokens;
-			if (nestedMode.tokenizationSupport) {
-				result = nestedMode.tokenizationSupport.tokenize(buffer, nestedModeState, deltaOffset, stopAtOffset);
-			} else {
-				// The nested mode doesn't have tokenization support,
-				// unfortunatelly this means we have to fake it
-				result = nullTokenize(nestedMode, buffer, nestedModeState, deltaOffset);
-			}
-			result.tokens = prependTokens.concat(result.tokens);
-			result.modeTransitions = prependModeTransitions.concat(result.modeTransitions);
-			return result;
-		}
-
-		var nestedModeBuffer = leavingNestedModeData.nestedModeBuffer;
-		if (nestedModeBuffer.length > 0) {
-			// Tokenize with the nested mode
-			var nestedModeLineTokens:Modes.ILineTokens;
-			if (nestedMode.tokenizationSupport) {
-				nestedModeLineTokens = nestedMode.tokenizationSupport.tokenize(nestedModeBuffer, nestedModeState, deltaOffset, stopAtOffset);
-			} else {
-				// The nested mode doesn't have tokenization support,
-				// unfortunatelly this means we have to fake it
-				nestedModeLineTokens = nullTokenize(nestedMode, nestedModeBuffer, nestedModeState, deltaOffset);
-			}
-
-			// Save last state of nested mode
-			nestedModeState = nestedModeLineTokens.endState;
-
-			// Prepend nested mode's result to our result
-			prependTokens = prependTokens.concat(nestedModeLineTokens.tokens);
-			prependModeTransitions = prependModeTransitions.concat(nestedModeLineTokens.modeTransitions);
-		}
-
-		var bufferAfterNestedMode = leavingNestedModeData.bufferAfterNestedMode;
-		var myStateAfterNestedMode = leavingNestedModeData.stateAfterNestedMode;
-		myStateAfterNestedMode.setStateData(myStateBeforeNestedMode.getStateData());
-		this.onReturningFromNestedMode(myStateAfterNestedMode, nestedModeState);
-
-		return this._myTokenize(bufferAfterNestedMode, myStateAfterNestedMode, deltaOffset + nestedModeBuffer.length, stopAtOffset, prependTokens, prependModeTransitions);
-	}
-
-	/**
-	 * Precondition is: state.getMode() === this
-	 * This means we are in the current mode when parsing starts on this line.
-	 */
-	private _myTokenize(buffer:string, myState:Modes.IState, deltaOffset:number, stopAtOffset:number, prependTokens:Modes.IToken[], prependModeTransitions:Modes.IModeTransition[]):Modes.ILineTokens {
-		var lineStream = new LineStream(buffer);
-		var tokenResult:Modes.ITokenizationResult, beforeTokenizeStreamPos:number;
-		var previousType:string = null;
-		var retokenize:TPromise<void> = null;
-
-		myState = myState.clone();
-		if (prependModeTransitions.length <= 0 || prependModeTransitions[prependModeTransitions.length-1].mode !== this.mode) {
-			// Avoid transitioning to the same mode (this can happen in case of empty embedded modes)
-			prependModeTransitions.push({
-				startIndex: deltaOffset,
-				mode: this.mode
-			});
-		}
-
-		var maxPos = Math.min(stopAtOffset - deltaOffset, buffer.length);
-		var noneBracket = Modes.Bracket.None;
-		while (lineStream.pos() < maxPos) {
-			beforeTokenizeStreamPos = lineStream.pos();
-
-			do {
-				tokenResult = myState.tokenize(lineStream);
-				if (tokenResult === null || tokenResult === undefined ||
-					((tokenResult.type === undefined || tokenResult.type === null) &&
-					(tokenResult.nextState === undefined || tokenResult.nextState === null))) {
-					throw new Error('Tokenizer must return a valid state');
-				}
-
-				if (tokenResult.nextState) {
-					tokenResult.nextState.setStateData(myState.getStateData());
-					myState = tokenResult.nextState;
-				}
-				if (lineStream.pos() <= beforeTokenizeStreamPos) {
-					throw new Error('Stream did not advance while tokenizing. Mode id is ' + this.mode.getId() + ' (stuck at token type: "' + tokenResult.type + '", prepend tokens: "' + (prependTokens.map(t => t.type).join(',')) + '").');
-				}
-			} while (!tokenResult.type && tokenResult.type !== '');
-
-			if (previousType !== tokenResult.type || tokenResult.bracket || previousType === null) {
-				prependTokens.push(new Token(beforeTokenizeStreamPos + deltaOffset, tokenResult.type, tokenResult.bracket || noneBracket));
-			}
-
-			previousType = tokenResult.type;
-
-			if (this.supportsNestedModes && this.enterNestedMode(myState)) {
-				var currentEmbeddedLevels = this._getEmbeddedLevel(myState);
-				if (currentEmbeddedLevels < TokenizationSupport.MAX_EMBEDDED_LEVELS) {
-					var nestedModeState = this.getNestedModeInitialState(myState);
-
-					// Re-emit tokenizationSupport change events from all modes that I ever embedded
-					var embeddedMode = nestedModeState.state.getMode();
-					if (typeof embeddedMode.addSupportChangedListener === 'function' && !this._embeddedModesListeners.hasOwnProperty(embeddedMode.getId())) {
-						var emitting = false;
-						this._embeddedModesListeners[embeddedMode.getId()] = embeddedMode.addSupportChangedListener((e) => {
-							if (emitting) {
-								return;
-							}
-							if (e.tokenizationSupport) {
-								emitting = true;
-								this.mode.registerSupport('tokenizationSupport', (mode) => {
-									return mode.tokenizationSupport;
-								});
-								emitting = false;
-							}
-						});
-					}
-
-
-					if (!lineStream.eos()) {
-						// There is content from the embedded mode
-						var restOfBuffer = buffer.substr(lineStream.pos());
-						var result = this._nestedTokenize(restOfBuffer, nestedModeState.state, deltaOffset + lineStream.pos(), stopAtOffset, prependTokens, prependModeTransitions);
-						result.retokenize = result.retokenize || nestedModeState.missingModePromise;
-						return result;
-					} else {
-						// Transition to the nested mode state
-						myState = nestedModeState.state;
-						retokenize = nestedModeState.missingModePromise;
-					}
-				}
-			}
-		}
-
-		return {
-			tokens: prependTokens,
-			actualStopOffset: lineStream.pos() + deltaOffset,
-			modeTransitions: prependModeTransitions,
-			endState: myState,
-			retokenize: retokenize
-		};
-	}
-
-	private _getEmbeddedLevel(state:Modes.IState): number {
-		var result = -1;
-		while(state) {
-			result++;
-			state = state.getStateData();
-		}
-		return result;
-	}
-
-	private enterNestedMode(state:Modes.IState): boolean {
-		if (this.defaults.enterNestedMode) {
-			return false;
-		}
-		return this.customization.enterNestedMode(state);
-
-	}
-
-	private getNestedMode(state:Modes.IState): IEnteringNestedModeData {
-		if (this.defaults.getNestedMode) {
-			return null;
-		}
-		return this.customization.getNestedMode(state);
-	}
-
-	private static _validatedNestedMode(input:IEnteringNestedModeData): IEnteringNestedModeData {
-		var mode: Modes.IMode = new NullMode(),
-			missingModePromise: TPromise<void> = null;
-
-		if (input && input.mode) {
-			mode = input.mode;
-		}
-		if (input && input.missingModePromise) {
-			missingModePromise = input.missingModePromise;
-		}
-
-		return {
-			mode: mode,
-			missingModePromise: missingModePromise
-		};
-	}
-
-	private getNestedModeInitialState(state:Modes.IState): { state:Modes.IState; missingModePromise:TPromise<void>; } {
-		if (this.defaults.getNestedModeInitialState) {
-			var nestedMode = TokenizationSupport._validatedNestedMode(this.getNestedMode(state));
-			var missingModePromise = nestedMode.missingModePromise;
-			var nestedModeState: Modes.IState;
-
-			if (nestedMode.mode.tokenizationSupport) {
-				nestedModeState = nestedMode.mode.tokenizationSupport.getInitialState();
-			} else {
-				nestedModeState = new NullState(nestedMode.mode, null);
-			}
-
-			nestedModeState.setStateData(state);
-
-			return {
-				state: nestedModeState,
-				missingModePromise: missingModePromise
-			};
-		}
-		return this.customization.getNestedModeInitialState(state);
-	}
-
-	private getLeavingNestedModeData(line:string, state:Modes.IState): ILeavingNestedModeData {
-		if (this.defaults.getLeavingNestedModeData) {
-			return null;
-		}
-		return this.customization.getLeavingNestedModeData(line, state);
-	}
-
-	private onReturningFromNestedMode(myStateAfterNestedMode:Modes.IState, lastNestedModeState:Modes.IState): void {
-		if (this.defaults.onReturningFromNestedMode) {
-			return null;
-		}
-		return this.customization.onReturningFromNestedMode(myStateAfterNestedMode, lastNestedModeState);
-	}
-}
-
-export interface IBracketElectricCharacterContribution {
-	brackets: Modes.IBracketPair[];
-	regexBrackets?: Modes.IRegexBracketPair[];
-	docComment?: Modes.IDocComment;
-	caseInsensitive?: boolean;
-	embeddedElectricCharacters?: string[];
-}
-export class BracketElectricCharacterSupport extends AbstractSupport implements Modes.IElectricCharacterSupport {
-
-	private contribution: IBracketElectricCharacterContribution;
-	private brackets: Brackets;
-
-	constructor(mode:Modes.IMode, contribution: IBracketElectricCharacterContribution) {
-		super(mode);
-		this.contribution = contribution;
-		this.brackets = new Brackets(contribution.brackets, contribution.regexBrackets,
-			contribution.docComment, contribution.caseInsensitive);
-	}
-
-	public getElectricCharacters(): string[]{
-		if (Array.isArray(this.contribution.embeddedElectricCharacters)) {
-			return this.contribution.embeddedElectricCharacters.concat(this.brackets.getElectricCharacters());
-		}
-		return this.brackets.getElectricCharacters();
-	}
-
-	public onElectricCharacter(context:Modes.ILineContext, offset:number): Modes.IElectricAction {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				return this.brackets.onElectricCharacter(context, offset);
-			} else if (nestedMode.electricCharacterSupport) {
-				return nestedMode.electricCharacterSupport.onElectricCharacter(context, offset);
-			} else {
-				return null;
-			}
-		});
-	}
-
-	public onEnter(context: Modes.ILineContext, offset: number): Modes.IEnterAction {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				return this.brackets.onEnter(context, offset);
-			} else if (nestedMode.electricCharacterSupport) {
-				return nestedMode.electricCharacterSupport.onEnter(context, offset);
-			} else {
-				return null;
-			}
-		});
-	}
-}
-
-
-
-export interface IDeclarationContribution {
-	tokens?: string[];
-	findDeclaration: (resource: URI, position: EditorCommon.IPosition) => TPromise<Modes.IReference>;
-}
-export class DeclarationSupport extends AbstractSupport implements Modes.IDeclarationSupport {
-
-	private contribution: IDeclarationContribution;
-
-	/**
-	 * Provide the token type postfixes for the tokens where a declaration can be found in the 'tokens' argument.
-	 */
-	constructor(mode: Modes.IMode, contribution: IDeclarationContribution) {
-		super(mode);
-		this.contribution = contribution;
-	}
-
-	public canFindDeclaration(context: Modes.ILineContext, offset:number):boolean {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				return (!Array.isArray(this.contribution.tokens) ||
-					this.contribution.tokens.length < 1 ||
-					isLineToken(context, offset, this.contribution.tokens));
-			} else if (nestedMode.declarationSupport) {
-				return nestedMode.declarationSupport.canFindDeclaration(context, offset);
-			} else {
-				return false;
-			}
-		});
-	}
-
-	public findDeclaration(resource: URI, position: EditorCommon.IPosition): TPromise<Modes.IReference>{
-		return this.contribution.findDeclaration(resource, position);
-	}
-}
-
-export interface ITypeDeclarationContribution {
-	tokens: string[];
-	findTypeDeclaration: (resource: URI, position: EditorCommon.IPosition) => TPromise<Modes.IReference>;
-}
-export class TypeDeclarationSupport extends AbstractSupport implements Modes.ITypeDeclarationSupport {
-
-	private contribution: ITypeDeclarationContribution;
-
-	/**
-	 * Provide the token type postfixes for the tokens where a declaration can be found in the 'tokens' argument.
-	 */
-	constructor(mode: Modes.IMode, contribution: ITypeDeclarationContribution) {
-		super(mode);
-		this.contribution = contribution;
-	}
-
-	public canFindTypeDeclaration(context: Modes.ILineContext, offset:number):boolean {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				return (!Array.isArray(this.contribution.tokens) ||
-					this.contribution.tokens.length < 1 ||
-					isLineToken(context, offset, this.contribution.tokens));
-			} else if (nestedMode.typeDeclarationSupport) {
-				return nestedMode.typeDeclarationSupport.canFindTypeDeclaration(context, offset);
-			} else {
-				return false;
-			}
-		});
-	}
-
-	public findTypeDeclaration(resource: URI, position: EditorCommon.IPosition): TPromise<Modes.IReference> {
-		return this.contribution.findTypeDeclaration(resource, position);
-	}
-}
-
-export interface IReferenceContribution {
-	tokens: string[];
-	findReferences: (resource: URI, position: EditorCommon.IPosition, includeDeclaration: boolean) => TPromise<Modes.IReference[]>;
-}
-
-export class ReferenceSupport extends AbstractSupport implements Modes.IReferenceSupport {
-
-	private contribution: IReferenceContribution;
-
-	/**
-	 * Provide the token type postfixes for the tokens where a reference can be found in the 'tokens' argument.
-	 */
-	constructor(mode: Modes.IMode, contribution: IReferenceContribution) {
-		super(mode);
-		this.contribution = contribution;
-	}
-
-	public canFindReferences(context: Modes.ILineContext, offset:number):boolean {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				return (!Array.isArray(this.contribution.tokens) ||
-					this.contribution.tokens.length < 1 ||
-					isLineToken(context, offset, this.contribution.tokens));
-			} else if (nestedMode.referenceSupport) {
-				return nestedMode.referenceSupport.canFindReferences(context, offset);
-			} else {
-				return false;
-			}
-		});
-	}
-
-	public findReferences(resource: URI, position: EditorCommon.IPosition, includeDeclaration: boolean): TPromise<Modes.IReference[]> {
-		return this.contribution.findReferences(resource, position, includeDeclaration);
-	}
-}
-
-export class ParameterHintsSupport extends AbstractSupport implements Modes.IParameterHintsSupport {
-
-	private contribution: Modes.IParameterHintsContribution;
-
-	constructor(mode: Modes.IMode, contribution: Modes.IParameterHintsContribution) {
-		super(mode);
-		this.contribution = contribution;
-	}
-
-	public getParameterHintsTriggerCharacters(): string[]
-	{
-		return this.contribution.triggerCharacters;
-	}
-
-	public shouldTriggerParameterHints(context: Modes.ILineContext, offset: number): boolean
-	{
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				if (!Array.isArray(this.contribution.excludeTokens)) {
-					return true;
-				}
-				if (this.contribution.excludeTokens.length === 1 && this.contribution.excludeTokens[0] === '*') {
-					return false;
-				}
-				return !isLineToken(context, offset-1, this.contribution.excludeTokens);
-			} else if (nestedMode.parameterHintsSupport) {
-				return nestedMode.parameterHintsSupport.shouldTriggerParameterHints(context, offset);
-			} else {
-				return false;
-			}
-		});
-	}
-	public getParameterHints(resource: URI, position: EditorCommon.IPosition): TPromise<Modes.IParameterHints> {
-		return this.contribution.getParameterHints(resource, position);
-	}
-}
-
-export interface ISuggestContribution {
-	triggerCharacters: string[];
-	disableAutoTrigger?: boolean;
-	excludeTokens: string[];
-	suggest: (resource: URI, position: EditorCommon.IPosition) => TPromise<Modes.ISuggestResult[]>;
-	getSuggestionDetails? : (resource:URI, position:EditorCommon.IPosition, suggestion:Modes.ISuggestion) => TPromise<Modes.ISuggestion>;
-}
-
-export class SuggestSupport extends AbstractSupport implements Modes.ISuggestSupport {
-
-	private contribution: ISuggestContribution;
-
-	public suggest : (resource:URI, position:EditorCommon.IPosition) => TPromise<Modes.ISuggestResult[]>;
-	public getSuggestionDetails : (resource:URI, position:EditorCommon.IPosition, suggestion:Modes.ISuggestion) => TPromise<Modes.ISuggestion>;
-
-	constructor(mode: Modes.IMode, contribution : ISuggestContribution){
-		super(mode);
-		this.contribution = contribution;
-		this.suggest = (resource, position) => contribution.suggest(resource, position);
-
-		if (typeof contribution.getSuggestionDetails === 'function') {
-			this.getSuggestionDetails = (resource, position, suggestion) => contribution.getSuggestionDetails(resource, position, suggestion);
-		}
-	}
-
-	shouldAutotriggerSuggest(context: Modes.ILineContext, offset: number, triggeredByCharacter: string): boolean {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-				if (this.contribution.disableAutoTrigger) {
-					return false;
-				}
-				if (!Array.isArray(this.contribution.excludeTokens)) {
-					return true;
-				}
-				if (this.contribution.excludeTokens.length === 1 && this.contribution.excludeTokens[0] === '*') {
-					return false;
-				}
-				return  !isLineToken(context, offset-1, this.contribution.excludeTokens, true);
-			} else if (nestedMode.suggestSupport) {
-				return nestedMode.suggestSupport.shouldAutotriggerSuggest(context, offset, triggeredByCharacter);
-			} else {
-				return false;
-			}
-		});
-	}
-
-	public getFilter(): Modes.ISuggestionFilter {
-		return DefaultFilter;
-	}
-
-	public getTriggerCharacters(): string[] {
-		return this.contribution.triggerCharacters;
-	}
-
-	public shouldShowEmptySuggestionList(): boolean	{
-		return true;
-	}
-}
-
-export interface IComposableSuggestContribution extends ISuggestContribution {
-	composeSuggest(resource:URI, position:EditorCommon.IPosition, superSuggestions:Modes.ISuggestResult[]): TPromise<Modes.ISuggestResult[]>;
-}
-
-export class ComposableSuggestSupport extends SuggestSupport {
-
-	constructor(mode: Modes.IMode, contribution: IComposableSuggestContribution) {
-		super(mode, contribution);
-
-		this.suggest = (resource, position) => {
-			return (
-				contribution.suggest(resource, position)
-					.then(superSuggestions => contribution.composeSuggest(resource, position, superSuggestions))
-			);
-		};
-	}
-
-}
-
-export class CharacterPairSupport extends AbstractSupport implements Modes.ICharacterPairSupport {
-
-	private _autoClosingPairs: Modes.IAutoClosingPairConditional[];
-	private _surroundingPairs: Modes.IAutoClosingPair[];
-
-	constructor(mode: Modes.IMode, contribution: Modes.ICharacterPairContribution) {
-
-		super(mode);
-		this._autoClosingPairs = contribution.autoClosingPairs;
-		this._surroundingPairs = Array.isArray(contribution.surroundingPairs) ? contribution.surroundingPairs : contribution.autoClosingPairs;
-	}
-
-	public getAutoClosingPairs(): Modes.IAutoClosingPair[] {
-		return this._autoClosingPairs;
-	}
-
-	public shouldAutoClosePair(character:string, context:Modes.ILineContext, offset:number): boolean {
-		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
-			if (this.mode === nestedMode) {
-
-				// Always complete on empty line
-				if (context.getTokenCount() === 0) {
-					return true;
-				}
-
-				var tokenIndex = context.findIndexOfOffset(offset - 1);
-				var tokenType = context.getTokenType(tokenIndex);
-
-				for (var i = 0; i < this._autoClosingPairs.length; ++i) {
-					if (this._autoClosingPairs[i].open === character) {
-						if (this._autoClosingPairs[i].notIn) {
-							for (var notInIndex = 0; notInIndex < this._autoClosingPairs[i].notIn.length; ++notInIndex) {
-								if (tokenType.indexOf(this._autoClosingPairs[i].notIn[notInIndex]) > -1) {
-									return false;
-								}
-							}
-						}
-						break;
-					}
-				}
-
-				return true;
-			} else if (nestedMode.characterPairSupport) {
-				return nestedMode.characterPairSupport.shouldAutoClosePair(character, context, offset);
-			} else {
-				return null;
-			}
-		});
-	}
-
-	public getSurroundingPairs(): Modes.IAutoClosingPair[]{
-		return this._surroundingPairs;
-	}
-}
-
-export interface IReplaceSupportHelper {
-	valueSetReplace(valueSet: string[], value: string, up: boolean): string;
-	valueSetsReplace(valueSets: string[][], value: string, up: boolean): string;
-}
-class ReplaceSupportHelperImpl implements IReplaceSupportHelper {
-
-	public valueSetsReplace(valueSets:string[][], value:string, up:boolean):string {
-		var result:string = null;
-		for (let i = 0, len = valueSets.length; result === null && i < len; i++) {
-			result = this.valueSetReplace(valueSets[i], value, up);
-		}
-		return result;
-	}
-
-	public valueSetReplace(valueSet:string[], value:string, up:boolean):string {
-		var idx = valueSet.indexOf(value);
-		if(idx >= 0) {
-			idx += up ? +1 : -1;
-			if(idx < 0) {
-				idx = valueSet.length - 1;
-			} else {
-				idx %= valueSet.length;
-			}
-			return valueSet[idx];
-		}
-		return null;
-	}
-
-}
-
-export var ReplaceSupport: IReplaceSupportHelper = new ReplaceSupportHelperImpl();
-
-export interface IInplaceReplaceSupportCustomization {
-	textReplace?: (value: string, up: boolean) => string;
-	navigateValueSetFallback?: (resource: URI, range: EditorCommon.IRange, up: boolean) => TPromise<Modes.IInplaceReplaceSupportResult>;
-}
-
-export class AbstractInplaceReplaceSupport implements Modes.IInplaceReplaceSupport {
-
-	private defaults: {
-		textReplace: boolean;
-		navigateValueSetFallback: boolean;
-	};
-	private customization:IInplaceReplaceSupportCustomization;
-
-	constructor(customization: IInplaceReplaceSupportCustomization = null) {
-		this.defaults = {
-			textReplace: !customization || !isFunction(customization.textReplace),
-			navigateValueSetFallback: !customization || !isFunction(customization.navigateValueSetFallback)
-		};
-		this.customization = customization;
-	}
-
-	public navigateValueSet(resource:URI, range:EditorCommon.IRange, up:boolean):TPromise<Modes.IInplaceReplaceSupportResult> {
-		var result = this.doNavigateValueSet(resource, range, up, true);
-		if (result && result.value && result.range) {
-			return TPromise.as(result);
-		}
-		if (this.defaults.navigateValueSetFallback) {
-			return TPromise.as(null);
-		}
-		return this.customization.navigateValueSetFallback(resource, range, up);
-	}
-
-	private doNavigateValueSet(resource:URI, range:EditorCommon.IRange, up:boolean, selection:boolean):Modes.IInplaceReplaceSupportResult {
-
-		var model = this.getModel(resource),
-			result:Modes.IInplaceReplaceSupportResult = { range:null, value: null },
-			text:string;
-
-		if(selection) {
-			// Replace selection
-			if(range.startColumn === range.endColumn) {
-				range.endColumn += 1;
-			}
-			text = model.getValueInRange(range);
-			result.range = range;
-		} else {
-			// Replace word
-			var position = { lineNumber: range.startLineNumber, column: range.startColumn };
-			var	wordPos = model.getWordAtPosition(position);
-
-			if(!wordPos || wordPos.startColumn === -1) {
-				return null;
-			}
-			text = wordPos.word;
-			result.range = { startLineNumber : range.startLineNumber, endLineNumber: range.endLineNumber, startColumn: wordPos.startColumn, endColumn: wordPos.endColumn };
-		}
-
-		// Try to replace numbers or text
-		var numberResult = this.numberReplace(text, up);
-		if(numberResult !== null) {
-			result.value = numberResult;
-		} else {
-			var textResult = this.textReplace(text, up);
-			if(textResult !== null) {
-				result.value = textResult;
-			} else if(selection) {
-				return this.doNavigateValueSet(resource, range, up, false);
-			}
-		}
-		return result;
-	}
-
-	private numberReplace(value:string, up:boolean):string {
-		var precision = Math.pow(10, value.length - (value.lastIndexOf('.') + 1)),
-			n1 = Number(value),
-			n2 = parseFloat(value);
-
-		if(!isNaN(n1) && !isNaN(n2) && n1 === n2) {
-
-			if(n1 === 0 && !up) {
-				return null; // don't do negative
-//			} else if(n1 === 9 && up) {
-//				return null; // don't insert 10 into a number
-			} else {
-				n1 = Math.floor(n1 * precision);
-				n1 += up ? precision : -precision;
-				return String(n1 / precision);
-			}
-		}
-
-		return null;
-	}
-
-	private _defaultValueSet: string[][] = [
-		['true', 'false'],
-		['True', 'False'],
-		['Private', 'Public', 'Friend', 'ReadOnly', 'Partial', 'Protected', 'WriteOnly'],
-		['public', 'protected', 'private'],
-	];
-
-	private textReplace(value:string, up:boolean):string {
-		if (this.defaults.textReplace) {
-			return ReplaceSupport.valueSetsReplace(this._defaultValueSet, value, up);
-		}
-		return this.customization.textReplace(value, up)
-			|| ReplaceSupport.valueSetsReplace(this._defaultValueSet, value, up);
-	}
-
-	protected getModel(resource:URI): EditorCommon.ITokenizedModel {
-		throw new Error('Not implemented');
-	}
-}
-
-export class WorkerInplaceReplaceSupport extends AbstractInplaceReplaceSupport {
-
-	private resourceService: IResourceService;
-
-	constructor(resourceService: IResourceService, customization: IInplaceReplaceSupportCustomization = null) {
-		super(customization);
-		this.resourceService = resourceService;
-	}
-
-	protected getModel(resource:URI): EditorCommon.ITokenizedModel {
-		return this.resourceService.get(resource);
-	}
-}
-
-export class MainInplaceReplaceSupport extends AbstractInplaceReplaceSupport {
-	private modelService: IModelService;
-
-	constructor(modelService: IModelService, customization: IInplaceReplaceSupportCustomization = null) {
-		super(customization);
-		this.modelService = modelService;
-	}
-
-	protected getModel(resource:URI): EditorCommon.ITokenizedModel {
-		return this.modelService.getModel(resource);
-	}
-}
-
-export interface ICommentsSupportContribution {
-	commentsConfiguration: Modes.ICommentsConfiguration;
-}
-
-export class CommentsSupport implements Modes.ICommentsSupport {
-
-	private _contribution: ICommentsSupportContribution;
-
-	constructor(contribution:ICommentsSupportContribution) {
-		this._contribution = contribution;
-	}
-
-	public getCommentsConfiguration(): Modes.ICommentsConfiguration {
-		return this._contribution.commentsConfiguration;
-	}
-
-}
-
-export interface ITokenTypeClassificationSupportContribution {
-	wordDefinition?: RegExp;
-}
-
-export class TokenTypeClassificationSupport implements Modes.ITokenTypeClassificationSupport {
-
-	private _contribution: ITokenTypeClassificationSupportContribution;
-
-	constructor(contribution: ITokenTypeClassificationSupportContribution) {
-		this._contribution = contribution;
-	}
-
-	public getWordDefinition(): RegExp {
-		if (typeof this._contribution.wordDefinition === 'undefined') {
-			return NullMode.DEFAULT_WORD_REGEXP;
-		}
-		return this._contribution.wordDefinition;
-	}
-}
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/characterPair.ts
code:
@@ -0,0 +1,68 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {handleEvent} from 'vs/editor/common/modes/supports';
+import * as Modes from 'vs/editor/common/modes';
+
+export interface ICharacterPairContribution {
+	autoClosingPairs: Modes.IAutoClosingPairConditional[];
+	surroundingPairs?: Modes.IAutoClosingPair[];
+}
+
+export class CharacterPairSupport implements Modes.IRichEditCharacterPair {
+
+	private _modeId: string;
+	private _autoClosingPairs: Modes.IAutoClosingPairConditional[];
+	private _surroundingPairs: Modes.IAutoClosingPair[];
+
+	constructor(modeId: string, contribution: ICharacterPairContribution) {
+		this._modeId = modeId;
+		this._autoClosingPairs = contribution.autoClosingPairs;
+		this._surroundingPairs = Array.isArray(contribution.surroundingPairs) ? contribution.surroundingPairs : contribution.autoClosingPairs;
+	}
+
+	public getAutoClosingPairs(): Modes.IAutoClosingPair[] {
+		return this._autoClosingPairs;
+	}
+
+	public shouldAutoClosePair(character:string, context:Modes.ILineContext, offset:number): boolean {
+		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+
+				// Always complete on empty line
+				if (context.getTokenCount() === 0) {
+					return true;
+				}
+
+				var tokenIndex = context.findIndexOfOffset(offset - 1);
+				var tokenType = context.getTokenType(tokenIndex);
+
+				for (var i = 0; i < this._autoClosingPairs.length; ++i) {
+					if (this._autoClosingPairs[i].open === character) {
+						if (this._autoClosingPairs[i].notIn) {
+							for (var notInIndex = 0; notInIndex < this._autoClosingPairs[i].notIn.length; ++notInIndex) {
+								if (tokenType.indexOf(this._autoClosingPairs[i].notIn[notInIndex]) > -1) {
+									return false;
+								}
+							}
+						}
+						break;
+					}
+				}
+
+				return true;
+			} else if (nestedMode.richEditSupport && nestedMode.richEditSupport.characterPair) {
+				return nestedMode.richEditSupport.characterPair.shouldAutoClosePair(character, context, offset);
+			} else {
+				return null;
+			}
+		});
+	}
+
+	public getSurroundingPairs(): Modes.IAutoClosingPair[]{
+		return this._surroundingPairs;
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/declarationSupport.ts
code:
@@ -0,0 +1,47 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IReference, IDeclarationSupport, ILineContext, IMode} from 'vs/editor/common/modes';
+import {IPosition} from 'vs/editor/common/editorCommon';
+import URI from 'vs/base/common/uri';
+import {handleEvent, isLineToken} from 'vs/editor/common/modes/supports';
+
+export interface IDeclarationContribution {
+	tokens?: string[];
+	findDeclaration: (resource: URI, position: IPosition) => TPromise<IReference>;
+}
+export class DeclarationSupport implements IDeclarationSupport {
+
+	private _modeId: string;
+	private contribution: IDeclarationContribution;
+
+	/**
+	 * Provide the token type postfixes for the tokens where a declaration can be found in the 'tokens' argument.
+	 */
+	constructor(modeId: string, contribution: IDeclarationContribution) {
+		this._modeId = modeId;
+		this.contribution = contribution;
+	}
+
+	public canFindDeclaration(context: ILineContext, offset:number):boolean {
+		return handleEvent(context, offset, (nestedMode:IMode, context:ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+				return (!Array.isArray(this.contribution.tokens) ||
+					this.contribution.tokens.length < 1 ||
+					isLineToken(context, offset, this.contribution.tokens));
+			} else if (nestedMode.declarationSupport) {
+				return nestedMode.declarationSupport.canFindDeclaration(context, offset);
+			} else {
+				return false;
+			}
+		});
+	}
+
+	public findDeclaration(resource: URI, position: IPosition): TPromise<IReference>{
+		return this.contribution.findDeclaration(resource, position);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/electricCharacter.ts
code:
@@ -0,0 +1,340 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as Modes from 'vs/editor/common/modes';
+import {handleEvent, ignoreBracketsInToken} from 'vs/editor/common/modes/supports';
+import Strings = require('vs/base/common/strings');
+import {Range} from 'vs/editor/common/core/range';
+import {IRichEditBracket} from 'vs/editor/common/editorCommon';
+
+/**
+ * Definition of documentation comments (e.g. Javadoc/JSdoc)
+ */
+export interface IDocComment {
+	scope: string; // What tokens should be used to detect a doc comment (e.g. 'comment.documentation').
+	open: string; // The string that starts a doc comment (e.g. '/**')
+	lineStart: string; // The string that appears at the start of each line, except the first and last (e.g. ' * ').
+	close?: string; // The string that appears on the last line and closes the doc comment (e.g. ' */').
+}
+
+export interface IBracketElectricCharacterContribution {
+	brackets: Modes.IBracketPair[];
+	docComment?: IDocComment;
+	caseInsensitive?: boolean;
+	embeddedElectricCharacters?: string[];
+}
+
+export class BracketElectricCharacterSupport implements Modes.IRichEditElectricCharacter {
+
+	private _modeId: string;
+	private contribution: IBracketElectricCharacterContribution;
+	private brackets: Brackets;
+
+	constructor(modeId: string, contribution: IBracketElectricCharacterContribution) {
+		this._modeId = modeId;
+		this.contribution = contribution;
+		this.brackets = new Brackets(modeId, contribution.brackets, contribution.docComment, contribution.caseInsensitive);
+	}
+
+	public getElectricCharacters(): string[]{
+		if (Array.isArray(this.contribution.embeddedElectricCharacters)) {
+			return this.contribution.embeddedElectricCharacters.concat(this.brackets.getElectricCharacters());
+		}
+		return this.brackets.getElectricCharacters();
+	}
+
+	public onElectricCharacter(context:Modes.ILineContext, offset:number): Modes.IElectricAction {
+		return handleEvent(context, offset, (nestedMode:Modes.IMode, context:Modes.ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+				return this.brackets.onElectricCharacter(context, offset);
+			} else if (nestedMode.richEditSupport && nestedMode.richEditSupport.electricCharacter) {
+				return nestedMode.richEditSupport.electricCharacter.onElectricCharacter(context, offset);
+			} else {
+				return null;
+			}
+		});
+	}
+
+	public getRichEditBrackets(): Modes.IRichEditBrackets {
+		return this.brackets.getRichEditBrackets();
+	}
+}
+
+interface ISimpleInternalBracket {
+	open: string;
+	close: string;
+}
+
+export class Brackets {
+
+	private _modeId: string;
+	private _brackets: IRichEditBracket[];
+	private _bracketsForwardRegex: RegExp;
+	private _bracketsReversedRegex: RegExp;
+	private _maxBracketLength: number;
+	private _textIsBracket: {[text:string]:IRichEditBracket;};
+	private _textIsOpenBracket: {[text:string]:boolean;};
+	private _docComment: IDocComment;
+
+	constructor(modeId: string, brackets: Modes.IBracketPair[], docComment: IDocComment = null, caseInsensitive: boolean = false) {
+		this._modeId = modeId;
+		this._brackets = brackets.map((b) => {
+			return {
+				modeId: modeId,
+				open: b.open,
+				close: b.close,
+				forwardRegex: getRegexForBracketPair({ open: b.open, close: b.close }),
+				reversedRegex: getReversedRegexForBracketPair({ open: b.open, close: b.close })
+			};
+		});
+		this._bracketsForwardRegex = getRegexForBrackets(this._brackets);
+		this._bracketsReversedRegex = getReversedRegexForBrackets(this._brackets);
+
+		this._textIsBracket = {};
+		this._textIsOpenBracket = {};
+		this._maxBracketLength = 0;
+		this._brackets.forEach((b) => {
+			this._textIsBracket[b.open] = b;
+			this._textIsBracket[b.close] = b;
+			this._textIsOpenBracket[b.open] = true;
+			this._textIsOpenBracket[b.close] = false;
+			this._maxBracketLength = Math.max(this._maxBracketLength, b.open.length);
+			this._maxBracketLength = Math.max(this._maxBracketLength, b.close.length);
+		});
+		this._docComment = docComment ? docComment : null;
+	}
+
+	public getRichEditBrackets(): Modes.IRichEditBrackets {
+		if (this._brackets.length === 0) {
+			return null;
+		}
+		return {
+			maxBracketLength: this._maxBracketLength,
+			forwardRegex: this._bracketsForwardRegex,
+			reversedRegex: this._bracketsReversedRegex,
+			brackets: this._brackets,
+			textIsBracket: this._textIsBracket,
+			textIsOpenBracket: this._textIsOpenBracket
+		};
+	}
+
+	public getElectricCharacters():string[] {
+		var result: string[] = [];
+
+		for (let i = 0, len = this._brackets.length; i < len; i++) {
+			let bracketPair = this._brackets[i];
+			let lastChar = bracketPair.close.charAt(bracketPair.close.length - 1);
+			result.push(lastChar);
+		}
+
+		// Doc comments
+		if (this._docComment){
+			result.push(this._docComment.open.charAt(this._docComment.open.length - 1));
+		}
+
+		// Filter duplicate entries
+		result = result.filter((item, pos, array) => {
+			return array.indexOf(item) === pos;
+		});
+
+		return result;
+	}
+
+	public onElectricCharacter(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
+		if (context.getTokenCount() === 0) {
+			return null;
+		}
+
+		return (this._onElectricCharacterDocComment(context, offset) ||
+			this._onElectricCharacterStandardBrackets(context, offset));
+	}
+
+	private containsTokenTypes(fullTokenSpec: string, tokensToLookFor: string): boolean {
+		var array = tokensToLookFor.split('.');
+		for (var i = 0; i < array.length; ++i) {
+			if (fullTokenSpec.indexOf(array[i]) < 0) {
+				return false;
+			}
+		}
+		return true;
+	}
+
+	private _onElectricCharacterStandardBrackets(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
+
+		if (this._brackets.length === 0) {
+			return null;
+		}
+
+		let reversedBracketRegex = this._bracketsReversedRegex;
+
+		let lineText = context.getLineContent();
+		let tokenIndex = context.findIndexOfOffset(offset);
+		let tokenStart = context.getTokenStartIndex(tokenIndex);
+		let tokenEnd = offset + 1;
+
+		var firstNonWhitespaceIndex = Strings.firstNonWhitespaceIndex(context.getLineContent());
+		if (firstNonWhitespaceIndex !== -1 && firstNonWhitespaceIndex < tokenStart) {
+			return null;
+		}
+
+		if (!ignoreBracketsInToken(context.getTokenType(tokenIndex))) {
+			let r = BracketsUtils.findPrevBracketInToken(reversedBracketRegex, 1, lineText, tokenStart, tokenEnd);
+			if (r) {
+				let text = lineText.substring(r.startColumn - 1, r.endColumn - 1);
+				let isOpen = this._textIsOpenBracket[text];
+				if (!isOpen) {
+					return {
+						matchOpenBracket: text
+					};
+				}
+			}
+		}
+
+		return null;
+	}
+
+	private _onElectricCharacterDocComment(context: Modes.ILineContext, offset: number): Modes.IElectricAction {
+		// We only auto-close, so do nothing if there is no closing part.
+		if (!this._docComment || !this._docComment.close) {
+			return null;
+		}
+
+		var line = context.getLineContent();
+		var char: string = line[offset];
+
+		// See if the right electric character was pressed
+		if (char !== this._docComment.open.charAt(this._docComment.open.length - 1)) {
+			return null;
+		}
+
+		// If this line already contains the closing tag, do nothing.
+		if (line.indexOf(this._docComment.close, offset) >= 0) {
+			return null;
+		}
+
+		// If we're not in a documentation comment, do nothing.
+		var lastTokenIndex = context.findIndexOfOffset(offset);
+		if (! this.containsTokenTypes(context.getTokenType(lastTokenIndex), this._docComment.scope)) {
+			return null;
+		}
+
+		if (line.substring(context.getTokenStartIndex(lastTokenIndex), offset+1/* include electric char*/) !== this._docComment.open) {
+			return null;
+		}
+
+		return { appendText: this._docComment.close};
+	}
+}
+
+function once<T, R>(keyFn:(input:T)=>string, computeFn:(input:T)=>R):(input:T)=>R {
+	let cache: {[key:string]:R;} = {};
+	return (input:T):R => {
+		let key = keyFn(input);
+		if (!cache.hasOwnProperty(key)) {
+			cache[key] = computeFn(input);
+		}
+		return cache[key];
+	};
+}
+
+var getRegexForBracketPair = once<ISimpleInternalBracket,RegExp>(
+	(input) => `${input.open};${input.close}`,
+	(input) => {
+		return createOrRegex([input.open, input.close]);
+	}
+);
+
+var getReversedRegexForBracketPair = once<ISimpleInternalBracket,RegExp>(
+	(input) => `${input.open};${input.close}`,
+	(input) => {
+		return createOrRegex([toReversedString(input.open), toReversedString(input.close)]);
+	}
+);
+
+var getRegexForBrackets = once<ISimpleInternalBracket[],RegExp>(
+	(input) => input.map(b => `${b.open};${b.close}`).join(';'),
+	(input) => {
+		let pieces: string[] = [];
+		input.forEach((b) => {
+			pieces.push(b.open);
+			pieces.push(b.close);
+		});
+		return createOrRegex(pieces);
+	}
+);
+
+var getReversedRegexForBrackets = once<ISimpleInternalBracket[],RegExp>(
+	(input) => input.map(b => `${b.open};${b.close}`).join(';'),
+	(input) => {
+		let pieces: string[] = [];
+		input.forEach((b) => {
+			pieces.push(toReversedString(b.open));
+			pieces.push(toReversedString(b.close));
+		});
+		return createOrRegex(pieces);
+	}
+);
+
+function createOrRegex(pieces:string[]): RegExp {
+	let regexStr = `(${pieces.map(Strings.escapeRegExpCharacters).join(')|(')})`;
+	return Strings.createRegExp(regexStr, true, false, false, false);
+}
+
+function toReversedString(str:string): string {
+	let reversedStr = '';
+	for (let i = str.length - 1; i >= 0; i--) {
+		reversedStr += str.charAt(i);
+	}
+	return reversedStr;
+}
+
+export class BracketsUtils {
+
+	private static _findPrevBracketInText(reversedBracketRegex:RegExp, lineNumber:number, reversedText:string, offset:number): Range {
+		let m = reversedText.match(reversedBracketRegex);
+
+		if (!m) {
+			return null;
+		}
+
+		let matchOffset = reversedText.length - 1 - m.index;
+		let matchLength = m[0].length;
+		let absoluteMatchOffset = offset + matchOffset;
+
+		return new Range(lineNumber, absoluteMatchOffset + 1, lineNumber, absoluteMatchOffset + 1 + matchLength);
+	}
+
+	public static findPrevBracketInToken(reversedBracketRegex:RegExp, lineNumber:number, lineText:string, currentTokenStart:number, currentTokenEnd:number): Range {
+		// Because JS does not support backwards regex search, we search forwards in a reversed string with a reversed regex ;)
+		let currentTokenReversedText = '';
+		for (let index = currentTokenEnd - 1; index >= currentTokenStart; index--) {
+			currentTokenReversedText += lineText.charAt(index);
+		}
+
+		return this._findPrevBracketInText(reversedBracketRegex, lineNumber, currentTokenReversedText, currentTokenStart);
+	}
+
+	public static findNextBracketInText(bracketRegex:RegExp, lineNumber:number, text:string, offset:number): Range {
+		let m = text.match(bracketRegex);
+
+		if (!m) {
+			return null;
+		}
+
+		let matchOffset = m.index;
+		let matchLength = m[0].length;
+		let absoluteMatchOffset = offset + matchOffset;
+
+		return new Range(lineNumber, absoluteMatchOffset + 1, lineNumber, absoluteMatchOffset + 1 + matchLength);
+	}
+
+	public static findNextBracketInToken(bracketRegex:RegExp, lineNumber:number, lineText:string, currentTokenStart:number, currentTokenEnd:number): Range {
+		let currentTokenText = lineText.substring(currentTokenStart, currentTokenEnd);
+
+		return this.findNextBracketInText(bracketRegex, lineNumber, currentTokenText, currentTokenStart);
+	}
+
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/inplaceReplaceSupport.ts
code:
@@ -0,0 +1,174 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IInplaceReplaceSupport, IInplaceReplaceSupportResult} from 'vs/editor/common/modes';
+import {ITokenizedModel, IRange} from 'vs/editor/common/editorCommon';
+import {IResourceService} from 'vs/editor/common/services/resourceService';
+import URI from 'vs/base/common/uri';
+
+export interface IReplaceSupportHelper {
+	valueSetReplace(valueSet: string[], value: string, up: boolean): string;
+	valueSetsReplace(valueSets: string[][], value: string, up: boolean): string;
+}
+class ReplaceSupportHelperImpl implements IReplaceSupportHelper {
+
+	public valueSetsReplace(valueSets:string[][], value:string, up:boolean):string {
+		var result:string = null;
+		for (let i = 0, len = valueSets.length; result === null && i < len; i++) {
+			result = this.valueSetReplace(valueSets[i], value, up);
+		}
+		return result;
+	}
+
+	public valueSetReplace(valueSet:string[], value:string, up:boolean):string {
+		var idx = valueSet.indexOf(value);
+		if(idx >= 0) {
+			idx += up ? +1 : -1;
+			if(idx < 0) {
+				idx = valueSet.length - 1;
+			} else {
+				idx %= valueSet.length;
+			}
+			return valueSet[idx];
+		}
+		return null;
+	}
+
+}
+
+export var ReplaceSupport: IReplaceSupportHelper = new ReplaceSupportHelperImpl();
+
+function isFunction(something) {
+	return typeof something === 'function';
+}
+
+export interface IInplaceReplaceSupportCustomization {
+	textReplace?: (value: string, up: boolean) => string;
+	navigateValueSetFallback?: (resource: URI, range: IRange, up: boolean) => TPromise<IInplaceReplaceSupportResult>;
+}
+
+export class AbstractInplaceReplaceSupport implements IInplaceReplaceSupport {
+
+	private defaults: {
+		textReplace: boolean;
+		navigateValueSetFallback: boolean;
+	};
+	private customization:IInplaceReplaceSupportCustomization;
+
+	constructor(customization: IInplaceReplaceSupportCustomization = null) {
+		this.defaults = {
+			textReplace: !customization || !isFunction(customization.textReplace),
+			navigateValueSetFallback: !customization || !isFunction(customization.navigateValueSetFallback)
+		};
+		this.customization = customization;
+	}
+
+	public navigateValueSet(resource:URI, range:IRange, up:boolean):TPromise<IInplaceReplaceSupportResult> {
+		var result = this.doNavigateValueSet(resource, range, up, true);
+		if (result && result.value && result.range) {
+			return TPromise.as(result);
+		}
+		if (this.defaults.navigateValueSetFallback) {
+			return TPromise.as(null);
+		}
+		return this.customization.navigateValueSetFallback(resource, range, up);
+	}
+
+	private doNavigateValueSet(resource:URI, range:IRange, up:boolean, selection:boolean):IInplaceReplaceSupportResult {
+
+		var model = this.getModel(resource),
+			result:IInplaceReplaceSupportResult = { range:null, value: null },
+			text:string;
+
+		if(selection) {
+			// Replace selection
+			if(range.startColumn === range.endColumn) {
+				range.endColumn += 1;
+			}
+			text = model.getValueInRange(range);
+			result.range = range;
+		} else {
+			// Replace word
+			var position = { lineNumber: range.startLineNumber, column: range.startColumn };
+			var	wordPos = model.getWordAtPosition(position);
+
+			if(!wordPos || wordPos.startColumn === -1) {
+				return null;
+			}
+			text = wordPos.word;
+			result.range = { startLineNumber : range.startLineNumber, endLineNumber: range.endLineNumber, startColumn: wordPos.startColumn, endColumn: wordPos.endColumn };
+		}
+
+		// Try to replace numbers or text
+		var numberResult = this.numberReplace(text, up);
+		if(numberResult !== null) {
+			result.value = numberResult;
+		} else {
+			var textResult = this.textReplace(text, up);
+			if(textResult !== null) {
+				result.value = textResult;
+			} else if(selection) {
+				return this.doNavigateValueSet(resource, range, up, false);
+			}
+		}
+		return result;
+	}
+
+	private numberReplace(value:string, up:boolean):string {
+		var precision = Math.pow(10, value.length - (value.lastIndexOf('.') + 1)),
+			n1 = Number(value),
+			n2 = parseFloat(value);
+
+		if(!isNaN(n1) && !isNaN(n2) && n1 === n2) {
+
+			if(n1 === 0 && !up) {
+				return null; // don't do negative
+//			} else if(n1 === 9 && up) {
+//				return null; // don't insert 10 into a number
+			} else {
+				n1 = Math.floor(n1 * precision);
+				n1 += up ? precision : -precision;
+				return String(n1 / precision);
+			}
+		}
+
+		return null;
+	}
+
+	private _defaultValueSet: string[][] = [
+		['true', 'false'],
+		['True', 'False'],
+		['Private', 'Public', 'Friend', 'ReadOnly', 'Partial', 'Protected', 'WriteOnly'],
+		['public', 'protected', 'private'],
+	];
+
+	private textReplace(value:string, up:boolean):string {
+		if (this.defaults.textReplace) {
+			return ReplaceSupport.valueSetsReplace(this._defaultValueSet, value, up);
+		}
+		return this.customization.textReplace(value, up)
+			|| ReplaceSupport.valueSetsReplace(this._defaultValueSet, value, up);
+	}
+
+	protected getModel(resource:URI): ITokenizedModel {
+		throw new Error('Not implemented');
+	}
+}
+
+export class WorkerInplaceReplaceSupport extends AbstractInplaceReplaceSupport {
+
+	private resourceService: IResourceService;
+
+	constructor(resourceService: IResourceService, customization: IInplaceReplaceSupportCustomization = null) {
+		super(customization);
+		this.resourceService = resourceService;
+	}
+
+	protected getModel(resource:URI): ITokenizedModel {
+		return this.resourceService.get(resource);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/onEnter.ts
code:
@@ -5,9 +5,9 @@
 'use strict';
 
 import {handleEvent} from 'vs/editor/common/modes/supports';
-import {IEnterAction, IndentAction, IOnEnterSupport, ILineContext, IMode} from 'vs/editor/common/modes';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
+import {IEnterAction, IndentAction, IRichEditOnEnter, ILineContext, IMode} from 'vs/editor/common/modes';
+import {ITokenizedModel, ITextModel, IPosition} from 'vs/editor/common/editorCommon';
+import {onUnexpectedError} from 'vs/base/common/errors';
 import Strings = require('vs/base/common/strings');
 import {Position} from 'vs/editor/common/core/position';
 
@@ -40,7 +40,7 @@ interface IProcessedBracketPair extends IBracketPair {
 	closeRegExp: RegExp;
 }
 
-export class OnEnterSupport implements IOnEnterSupport {
+export class OnEnterSupport implements IRichEditOnEnter {
 
 	private static _INDENT: IEnterAction = { indentAction: IndentAction.Indent };
 	private static _INDENT_OUTDENT: IEnterAction = { indentAction: IndentAction.IndentOutdent };
@@ -72,21 +72,21 @@ export class OnEnterSupport implements IOnEnterSupport {
 		this._indentationRules = opts.indentationRules;
 	}
 
-	public onEnter(model:EditorCommon.ITokenizedModel, position: EditorCommon.IPosition): IEnterAction {
+	public onEnter(model:ITokenizedModel, position: IPosition): IEnterAction {
 		var context = model.getLineContext(position.lineNumber);
 
 		return handleEvent(context, position.column - 1, (nestedMode:IMode, context:ILineContext, offset:number) => {
 			if (this._modeId === nestedMode.getId()) {
 				return this._onEnter(model, position);
-			} else if (nestedMode.onEnterSupport) {
-				return nestedMode.onEnterSupport.onEnter(model, position);
+			} else if (nestedMode.richEditSupport && nestedMode.richEditSupport.onEnter) {
+				return nestedMode.richEditSupport.onEnter.onEnter(model, position);
 			} else {
 				return null;
 			}
 		});
 	}
 
-	private _onEnter(model:EditorCommon.ITextModel, position: EditorCommon.IPosition): IEnterAction {
+	private _onEnter(model:ITextModel, position: IPosition): IEnterAction {
 		let lineText = model.getLineContent(position.lineNumber);
 		let beforeEnterText = lineText.substr(0, position.column - 1);
 		let afterEnterText = lineText.substr(position.column - 1);
@@ -175,40 +175,28 @@ export class OnEnterSupport implements IOnEnterSupport {
 		try {
 			return new RegExp(def);
 		} catch(err) {
-			Errors.onUnexpectedError(err);
+			onUnexpectedError(err);
 			return null;
 		}
 	}
 }
 
-export function getRawEnterActionAtPosition(model:EditorCommon.ITokenizedModel, lineNumber:number, column:number): IEnterAction {
-	let enterAction:IEnterAction;
+export function getRawEnterActionAtPosition(model:ITokenizedModel, lineNumber:number, column:number): IEnterAction {
+	let result:IEnterAction;
+	let richEditSupport = model.getMode().richEditSupport;
 
-	if (model.getMode().onEnterSupport) {
+	if (richEditSupport && richEditSupport.onEnter) {
 		try {
-			enterAction = model.getMode().onEnterSupport.onEnter(model, new Position(lineNumber, column));
+			result = richEditSupport.onEnter.onEnter(model, new Position(lineNumber, column));
 		} catch (e) {
-			Errors.onUnexpectedError(e);
+			onUnexpectedError(e);
 		}
 	}
 
-	if (!enterAction) {
-		if (model.getMode().electricCharacterSupport) {
-			let lineContext = model.getLineContext(lineNumber);
-			try {
-				enterAction = model.getMode().electricCharacterSupport.onEnter(lineContext, column - 1);
-			} catch(e) {
-				Errors.onUnexpectedError(e);
-			}
-		}
-	} else {
-		// console.log('USING NEW INDENTATION LOGIC!');
-	}
-
-	return enterAction;
+	return result;
 }
 
-export function getEnterActionAtPosition(model:EditorCommon.ITokenizedModel, lineNumber:number, column:number): { enterAction: IEnterAction; indentation: string; } {
+export function getEnterActionAtPosition(model:ITokenizedModel, lineNumber:number, column:number): { enterAction: IEnterAction; indentation: string; } {
 	let lineText = model.getLineContent(lineNumber);
 	let indentation = Strings.getLeadingWhitespace(lineText);
 	if (indentation.length > column - 1) {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/parameterHintsSupport.ts
code:
@@ -0,0 +1,55 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IParameterHints, IParameterHintsSupport, ILineContext, IMode} from 'vs/editor/common/modes';
+import {IPosition} from 'vs/editor/common/editorCommon';
+import URI from 'vs/base/common/uri';
+import {handleEvent, isLineToken} from 'vs/editor/common/modes/supports';
+
+export interface IParameterHintsContribution {
+	triggerCharacters: string[];
+	excludeTokens: string[];
+	getParameterHints: (resource: URI, position: IPosition) => TPromise<IParameterHints>;
+}
+
+export class ParameterHintsSupport implements IParameterHintsSupport {
+
+	private _modeId: string;
+	private contribution: IParameterHintsContribution;
+
+	constructor(modeId: string, contribution: IParameterHintsContribution) {
+		this._modeId = modeId;
+		this.contribution = contribution;
+	}
+
+	public getParameterHintsTriggerCharacters(): string[]
+	{
+		return this.contribution.triggerCharacters;
+	}
+
+	public shouldTriggerParameterHints(context: ILineContext, offset: number): boolean
+	{
+		return handleEvent(context, offset, (nestedMode:IMode, context:ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+				if (!Array.isArray(this.contribution.excludeTokens)) {
+					return true;
+				}
+				if (this.contribution.excludeTokens.length === 1 && this.contribution.excludeTokens[0] === '*') {
+					return false;
+				}
+				return !isLineToken(context, offset-1, this.contribution.excludeTokens);
+			} else if (nestedMode.parameterHintsSupport) {
+				return nestedMode.parameterHintsSupport.shouldTriggerParameterHints(context, offset);
+			} else {
+				return false;
+			}
+		});
+	}
+	public getParameterHints(resource: URI, position: IPosition): TPromise<IParameterHints> {
+		return this.contribution.getParameterHints(resource, position);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/referenceSupport.ts
code:
@@ -0,0 +1,48 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IReference, IReferenceSupport, ILineContext, IMode} from 'vs/editor/common/modes';
+import {IPosition} from 'vs/editor/common/editorCommon';
+import URI from 'vs/base/common/uri';
+import {handleEvent, isLineToken} from 'vs/editor/common/modes/supports';
+
+export interface IReferenceContribution {
+	tokens: string[];
+	findReferences: (resource: URI, position: IPosition, includeDeclaration: boolean) => TPromise<IReference[]>;
+}
+
+export class ReferenceSupport implements IReferenceSupport {
+
+	private _modeId: string;
+	private contribution: IReferenceContribution;
+
+	/**
+	 * Provide the token type postfixes for the tokens where a reference can be found in the 'tokens' argument.
+	 */
+	constructor(modeId: string, contribution: IReferenceContribution) {
+		this._modeId = modeId;
+		this.contribution = contribution;
+	}
+
+	public canFindReferences(context: ILineContext, offset:number):boolean {
+		return handleEvent(context, offset, (nestedMode:IMode, context:ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+				return (!Array.isArray(this.contribution.tokens) ||
+					this.contribution.tokens.length < 1 ||
+					isLineToken(context, offset, this.contribution.tokens));
+			} else if (nestedMode.referenceSupport) {
+				return nestedMode.referenceSupport.canFindReferences(context, offset);
+			} else {
+				return false;
+			}
+		});
+	}
+
+	public findReferences(resource: URI, position: IPosition, includeDeclaration: boolean): TPromise<IReference[]> {
+		return this.contribution.findReferences(resource, position, includeDeclaration);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/richEditSupport.ts
code:
@@ -0,0 +1,103 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as Modes from 'vs/editor/common/modes';
+import {OnEnterSupport, IOnEnterSupportOptions, IIndentationRules, IOnEnterRegExpRules} from 'vs/editor/common/modes/supports/onEnter';
+import {CharacterPairSupport} from 'vs/editor/common/modes/supports/characterPair';
+import {BracketElectricCharacterSupport, IBracketElectricCharacterContribution} from 'vs/editor/common/modes/supports/electricCharacter';
+import {ICharacterPairContribution} from 'vs/editor/common/modes/supports/characterPair';
+import {NullMode} from 'vs/editor/common/modes/nullMode';
+
+export type CharacterPair = [string, string];
+
+export interface CommentRule {
+	lineComment?: string;
+	blockComment?: CharacterPair;
+}
+
+export interface IRichEditConfiguration {
+	comments?: CommentRule;
+	brackets?: CharacterPair[];
+	wordPattern?: RegExp;
+	indentationRules?: IIndentationRules;
+	onEnterRules?: IOnEnterRegExpRules[];
+	__electricCharacterSupport?: IBracketElectricCharacterContribution;
+	__characterPairSupport?: ICharacterPairContribution;
+}
+
+export class RichEditSupport implements Modes.IRichEditSupport {
+
+	public electricCharacter: BracketElectricCharacterSupport;
+	public comments: Modes.ICommentsConfiguration;
+	public characterPair: Modes.IRichEditCharacterPair;
+	public wordDefinition: RegExp;
+	public onEnter: Modes.IRichEditOnEnter;
+	public brackets: Modes.IRichEditBrackets;
+
+	constructor(modeId:string, conf:IRichEditConfiguration) {
+
+		this._handleOnEnter(modeId, conf);
+
+		this._handleComments(modeId, conf);
+
+		if (conf.__characterPairSupport) {
+			this.characterPair = new CharacterPairSupport(modeId, conf.__characterPairSupport);
+		}
+
+		if (conf.__electricCharacterSupport) {
+			this.electricCharacter = new BracketElectricCharacterSupport(modeId, conf.__electricCharacterSupport);
+			this.brackets = this.electricCharacter.getRichEditBrackets();
+		}
+
+		this.wordDefinition = conf.wordPattern || NullMode.DEFAULT_WORD_REGEXP;
+	}
+
+	private _handleOnEnter(modeId:string, conf:IRichEditConfiguration): void {
+		// on enter
+		let onEnter: IOnEnterSupportOptions = {};
+		let empty = true;
+		let {brackets, indentationRules, onEnterRules} = conf;
+
+		if (brackets) {
+			empty = false;
+			onEnter.brackets = brackets.map(pair => {
+				let [open, close] = pair;
+				return { open, close };
+			});
+		}
+		if (indentationRules) {
+			empty = false;
+			onEnter.indentationRules = indentationRules;
+		}
+		if (onEnterRules) {
+			empty = false;
+			onEnter.regExpRules = <any>onEnterRules;
+		}
+
+		if (!empty) {
+			this.onEnter = new OnEnterSupport(modeId, onEnter);
+		}
+	}
+
+	private _handleComments(modeId:string, conf:IRichEditConfiguration): void {
+		let commentRule = conf.comments;
+
+		// comment configuration
+		if (commentRule) {
+			this.comments = {};
+
+			if (commentRule.lineComment) {
+				this.comments.lineCommentToken = commentRule.lineComment;
+			}
+			if (commentRule.blockComment) {
+				let [blockStart, blockEnd] = commentRule.blockComment;
+				this.comments.blockCommentStartToken = blockStart;
+				this.comments.blockCommentEndToken = blockEnd;
+			}
+		}
+	}
+
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/suggestSupport.ts
code:
@@ -0,0 +1,91 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import {DefaultFilter} from 'vs/editor/common/modes/modesFilters';
+import {ISuggestResult, ISuggestSupport, ISuggestion, ILineContext, IMode, ISuggestionFilter} from 'vs/editor/common/modes';
+import {IPosition} from 'vs/editor/common/editorCommon';
+import URI from 'vs/base/common/uri';
+import {handleEvent, isLineToken} from 'vs/editor/common/modes/supports';
+
+export interface ISuggestContribution {
+	triggerCharacters: string[];
+	disableAutoTrigger?: boolean;
+	excludeTokens: string[];
+	suggest: (resource: URI, position: IPosition) => TPromise<ISuggestResult[]>;
+	getSuggestionDetails? : (resource:URI, position:IPosition, suggestion:ISuggestion) => TPromise<ISuggestion>;
+}
+
+export class SuggestSupport implements ISuggestSupport {
+
+	private _modeId: string;
+	private contribution: ISuggestContribution;
+
+	public suggest : (resource:URI, position:IPosition) => TPromise<ISuggestResult[]>;
+	public getSuggestionDetails : (resource:URI, position:IPosition, suggestion:ISuggestion) => TPromise<ISuggestion>;
+
+	constructor(modeId: string, contribution : ISuggestContribution){
+		this._modeId = modeId;
+		this.contribution = contribution;
+		this.suggest = (resource, position) => contribution.suggest(resource, position);
+
+		if (typeof contribution.getSuggestionDetails === 'function') {
+			this.getSuggestionDetails = (resource, position, suggestion) => contribution.getSuggestionDetails(resource, position, suggestion);
+		}
+	}
+
+	shouldAutotriggerSuggest(context: ILineContext, offset: number, triggeredByCharacter: string): boolean {
+		return handleEvent(context, offset, (nestedMode:IMode, context:ILineContext, offset:number) => {
+			if (this._modeId === nestedMode.getId()) {
+				if (this.contribution.disableAutoTrigger) {
+					return false;
+				}
+				if (!Array.isArray(this.contribution.excludeTokens)) {
+					return true;
+				}
+				if (this.contribution.excludeTokens.length === 1 && this.contribution.excludeTokens[0] === '*') {
+					return false;
+				}
+				return  !isLineToken(context, offset-1, this.contribution.excludeTokens, true);
+			} else if (nestedMode.suggestSupport) {
+				return nestedMode.suggestSupport.shouldAutotriggerSuggest(context, offset, triggeredByCharacter);
+			} else {
+				return false;
+			}
+		});
+	}
+
+	public getFilter(): ISuggestionFilter {
+		return DefaultFilter;
+	}
+
+	public getTriggerCharacters(): string[] {
+		return this.contribution.triggerCharacters;
+	}
+
+	public shouldShowEmptySuggestionList(): boolean	{
+		return true;
+	}
+}
+
+export interface IComposableSuggestContribution extends ISuggestContribution {
+	composeSuggest(resource:URI, position:IPosition, superSuggestions:ISuggestResult[]): TPromise<ISuggestResult[]>;
+}
+
+export class ComposableSuggestSupport extends SuggestSupport {
+
+	constructor(modeId: string, contribution: IComposableSuggestContribution) {
+		super(modeId, contribution);
+
+		this.suggest = (resource, position) => {
+			return (
+				contribution.suggest(resource, position)
+					.then(superSuggestions => contribution.composeSuggest(resource, position, superSuggestions))
+			);
+		};
+	}
+
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/supports/tokenizationSupport.ts
code:
@@ -0,0 +1,351 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {TPromise} from 'vs/base/common/winjs.base';
+import * as Modes from 'vs/editor/common/modes';
+import {IDisposable} from 'vs/base/common/lifecycle';
+import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
+import {LineStream} from 'vs/editor/common/modes/lineStream';
+import {Token} from 'vs/editor/common/modes/supports';
+
+export interface ILeavingNestedModeData {
+	/**
+	 * The part of the line that will be tokenized by the nested mode
+	 */
+	nestedModeBuffer: string;
+
+	/**
+	 * The part of the line that will be tokenized by the parent mode when it continues after the nested mode
+	 */
+	bufferAfterNestedMode: string;
+
+	/**
+	 * The state that will be used for continuing tokenization by the parent mode after the nested mode
+	 */
+	stateAfterNestedMode: Modes.IState;
+}
+
+export interface IEnteringNestedModeData {
+	mode:Modes.IMode;
+	missingModePromise:TPromise<void>;
+}
+
+export interface ITokenizationCustomization {
+
+	getInitialState():Modes.IState;
+
+	enterNestedMode?: (state:Modes.IState) => boolean;
+
+	getNestedMode?: (state:Modes.IState) => IEnteringNestedModeData;
+
+	getNestedModeInitialState?: (myState:Modes.IState) => { state:Modes.IState; missingModePromise:TPromise<void>; };
+
+	/**
+	 * Return null if the line does not leave the nested mode
+	 */
+	getLeavingNestedModeData?: (line:string, state:Modes.IState) => ILeavingNestedModeData;
+
+	/**
+	 * Callback for when leaving a nested mode and returning to the outer mode.
+	 * @param myStateAfterNestedMode The outer mode's state that will begin to tokenize
+	 * @param lastNestedModeState The nested mode's last state
+	 */
+	onReturningFromNestedMode?: (myStateAfterNestedMode:Modes.IState, lastNestedModeState:Modes.IState)=> void;
+}
+
+function isFunction(something) {
+	return typeof something === 'function';
+}
+
+export class TokenizationSupport implements Modes.ITokenizationSupport, IDisposable {
+
+	static MAX_EMBEDDED_LEVELS = 5;
+
+	private customization:ITokenizationCustomization;
+	private defaults: {
+		enterNestedMode: boolean;
+		getNestedMode: boolean;
+		getNestedModeInitialState: boolean;
+		getLeavingNestedModeData: boolean;
+		onReturningFromNestedMode: boolean;
+	};
+
+	public shouldGenerateEmbeddedModels:boolean;
+	public supportsNestedModes:boolean;
+
+	private _mode:Modes.IMode;
+	private _embeddedModesListeners: { [modeId:string]: IDisposable; };
+
+	constructor(mode:Modes.IMode, customization:ITokenizationCustomization, supportsNestedModes:boolean, shouldGenerateEmbeddedModels:boolean) {
+		this._mode = mode;
+		this.customization = customization;
+		this.supportsNestedModes = supportsNestedModes;
+		this._embeddedModesListeners = {};
+		if (this.supportsNestedModes) {
+			if (!this._mode.registerSupport) {
+				throw new Error('Cannot be a mode with nested modes unless I can emit a tokenizationSupport changed event!');
+			}
+		}
+		this.shouldGenerateEmbeddedModels = shouldGenerateEmbeddedModels;
+		this.defaults = {
+			enterNestedMode: !isFunction(customization.enterNestedMode),
+			getNestedMode: !isFunction(customization.getNestedMode),
+			getNestedModeInitialState: !isFunction(customization.getNestedModeInitialState),
+			getLeavingNestedModeData: !isFunction(customization.getLeavingNestedModeData),
+			onReturningFromNestedMode: !isFunction(customization.onReturningFromNestedMode)
+		};
+	}
+
+	public dispose() : void {
+		for (var listener in this._embeddedModesListeners) {
+			this._embeddedModesListeners[listener].dispose();
+			delete this._embeddedModesListeners[listener];
+		}
+	}
+
+	public getInitialState(): Modes.IState {
+		return this.customization.getInitialState();
+	}
+
+	public tokenize(line:string, state:Modes.IState, deltaOffset:number = 0, stopAtOffset:number = deltaOffset + line.length):Modes.ILineTokens {
+		if (state.getMode() !== this._mode) {
+			return this._nestedTokenize(line, state, deltaOffset, stopAtOffset, [], []);
+		} else {
+			return this._myTokenize(line, state, deltaOffset, stopAtOffset, [], []);
+		}
+	}
+
+	/**
+	 * Precondition is: nestedModeState.getMode() !== this
+	 * This means we are in a nested mode when parsing starts on this line.
+	 */
+	private _nestedTokenize(buffer:string, nestedModeState:Modes.IState, deltaOffset:number, stopAtOffset:number, prependTokens:Modes.IToken[], prependModeTransitions:Modes.IModeTransition[]):Modes.ILineTokens {
+		var myStateBeforeNestedMode = nestedModeState.getStateData();
+		var leavingNestedModeData = this.getLeavingNestedModeData(buffer, myStateBeforeNestedMode);
+
+		// Be sure to give every embedded mode the
+		// opportunity to leave nested mode.
+		// i.e. Don't go straight to the most nested mode
+		var stepOnceNestedState = nestedModeState;
+		while (stepOnceNestedState.getStateData() && stepOnceNestedState.getStateData().getMode() !== this._mode) {
+			stepOnceNestedState = stepOnceNestedState.getStateData();
+		}
+		var nestedMode = stepOnceNestedState.getMode();
+
+		if (!leavingNestedModeData) {
+			// tokenization will not leave nested mode
+			var result:Modes.ILineTokens;
+			if (nestedMode.tokenizationSupport) {
+				result = nestedMode.tokenizationSupport.tokenize(buffer, nestedModeState, deltaOffset, stopAtOffset);
+			} else {
+				// The nested mode doesn't have tokenization support,
+				// unfortunatelly this means we have to fake it
+				result = nullTokenize(nestedMode, buffer, nestedModeState, deltaOffset);
+			}
+			result.tokens = prependTokens.concat(result.tokens);
+			result.modeTransitions = prependModeTransitions.concat(result.modeTransitions);
+			return result;
+		}
+
+		var nestedModeBuffer = leavingNestedModeData.nestedModeBuffer;
+		if (nestedModeBuffer.length > 0) {
+			// Tokenize with the nested mode
+			var nestedModeLineTokens:Modes.ILineTokens;
+			if (nestedMode.tokenizationSupport) {
+				nestedModeLineTokens = nestedMode.tokenizationSupport.tokenize(nestedModeBuffer, nestedModeState, deltaOffset, stopAtOffset);
+			} else {
+				// The nested mode doesn't have tokenization support,
+				// unfortunatelly this means we have to fake it
+				nestedModeLineTokens = nullTokenize(nestedMode, nestedModeBuffer, nestedModeState, deltaOffset);
+			}
+
+			// Save last state of nested mode
+			nestedModeState = nestedModeLineTokens.endState;
+
+			// Prepend nested mode's result to our result
+			prependTokens = prependTokens.concat(nestedModeLineTokens.tokens);
+			prependModeTransitions = prependModeTransitions.concat(nestedModeLineTokens.modeTransitions);
+		}
+
+		var bufferAfterNestedMode = leavingNestedModeData.bufferAfterNestedMode;
+		var myStateAfterNestedMode = leavingNestedModeData.stateAfterNestedMode;
+		myStateAfterNestedMode.setStateData(myStateBeforeNestedMode.getStateData());
+		this.onReturningFromNestedMode(myStateAfterNestedMode, nestedModeState);
+
+		return this._myTokenize(bufferAfterNestedMode, myStateAfterNestedMode, deltaOffset + nestedModeBuffer.length, stopAtOffset, prependTokens, prependModeTransitions);
+	}
+
+	/**
+	 * Precondition is: state.getMode() === this
+	 * This means we are in the current mode when parsing starts on this line.
+	 */
+	private _myTokenize(buffer:string, myState:Modes.IState, deltaOffset:number, stopAtOffset:number, prependTokens:Modes.IToken[], prependModeTransitions:Modes.IModeTransition[]):Modes.ILineTokens {
+		var lineStream = new LineStream(buffer);
+		var tokenResult:Modes.ITokenizationResult, beforeTokenizeStreamPos:number;
+		var previousType:string = null;
+		var retokenize:TPromise<void> = null;
+
+		myState = myState.clone();
+		if (prependModeTransitions.length <= 0 || prependModeTransitions[prependModeTransitions.length-1].mode !== this._mode) {
+			// Avoid transitioning to the same mode (this can happen in case of empty embedded modes)
+			prependModeTransitions.push({
+				startIndex: deltaOffset,
+				mode: this._mode
+			});
+		}
+
+		var maxPos = Math.min(stopAtOffset - deltaOffset, buffer.length);
+		while (lineStream.pos() < maxPos) {
+			beforeTokenizeStreamPos = lineStream.pos();
+
+			do {
+				tokenResult = myState.tokenize(lineStream);
+				if (tokenResult === null || tokenResult === undefined ||
+					((tokenResult.type === undefined || tokenResult.type === null) &&
+					(tokenResult.nextState === undefined || tokenResult.nextState === null))) {
+					throw new Error('Tokenizer must return a valid state');
+				}
+
+				if (tokenResult.nextState) {
+					tokenResult.nextState.setStateData(myState.getStateData());
+					myState = tokenResult.nextState;
+				}
+				if (lineStream.pos() <= beforeTokenizeStreamPos) {
+					throw new Error('Stream did not advance while tokenizing. Mode id is ' + this._mode.getId() + ' (stuck at token type: "' + tokenResult.type + '", prepend tokens: "' + (prependTokens.map(t => t.type).join(',')) + '").');
+				}
+			} while (!tokenResult.type && tokenResult.type !== '');
+
+			if (previousType !== tokenResult.type || tokenResult.bracket || previousType === null) {
+				prependTokens.push(new Token(beforeTokenizeStreamPos + deltaOffset, tokenResult.type));
+			}
+
+			previousType = tokenResult.type;
+
+			if (this.supportsNestedModes && this.enterNestedMode(myState)) {
+				var currentEmbeddedLevels = this._getEmbeddedLevel(myState);
+				if (currentEmbeddedLevels < TokenizationSupport.MAX_EMBEDDED_LEVELS) {
+					var nestedModeState = this.getNestedModeInitialState(myState);
+
+					// Re-emit tokenizationSupport change events from all modes that I ever embedded
+					var embeddedMode = nestedModeState.state.getMode();
+					if (typeof embeddedMode.addSupportChangedListener === 'function' && !this._embeddedModesListeners.hasOwnProperty(embeddedMode.getId())) {
+						var emitting = false;
+						this._embeddedModesListeners[embeddedMode.getId()] = embeddedMode.addSupportChangedListener((e) => {
+							if (emitting) {
+								return;
+							}
+							if (e.tokenizationSupport) {
+								emitting = true;
+								this._mode.registerSupport('tokenizationSupport', (mode) => {
+									return mode.tokenizationSupport;
+								});
+								emitting = false;
+							}
+						});
+					}
+
+
+					if (!lineStream.eos()) {
+						// There is content from the embedded mode
+						var restOfBuffer = buffer.substr(lineStream.pos());
+						var result = this._nestedTokenize(restOfBuffer, nestedModeState.state, deltaOffset + lineStream.pos(), stopAtOffset, prependTokens, prependModeTransitions);
+						result.retokenize = result.retokenize || nestedModeState.missingModePromise;
+						return result;
+					} else {
+						// Transition to the nested mode state
+						myState = nestedModeState.state;
+						retokenize = nestedModeState.missingModePromise;
+					}
+				}
+			}
+		}
+
+		return {
+			tokens: prependTokens,
+			actualStopOffset: lineStream.pos() + deltaOffset,
+			modeTransitions: prependModeTransitions,
+			endState: myState,
+			retokenize: retokenize
+		};
+	}
+
+	private _getEmbeddedLevel(state:Modes.IState): number {
+		var result = -1;
+		while(state) {
+			result++;
+			state = state.getStateData();
+		}
+		return result;
+	}
+
+	private enterNestedMode(state:Modes.IState): boolean {
+		if (this.defaults.enterNestedMode) {
+			return false;
+		}
+		return this.customization.enterNestedMode(state);
+
+	}
+
+	private getNestedMode(state:Modes.IState): IEnteringNestedModeData {
+		if (this.defaults.getNestedMode) {
+			return null;
+		}
+		return this.customization.getNestedMode(state);
+	}
+
+	private static _validatedNestedMode(input:IEnteringNestedModeData): IEnteringNestedModeData {
+		var mode: Modes.IMode = new NullMode(),
+			missingModePromise: TPromise<void> = null;
+
+		if (input && input.mode) {
+			mode = input.mode;
+		}
+		if (input && input.missingModePromise) {
+			missingModePromise = input.missingModePromise;
+		}
+
+		return {
+			mode: mode,
+			missingModePromise: missingModePromise
+		};
+	}
+
+	private getNestedModeInitialState(state:Modes.IState): { state:Modes.IState; missingModePromise:TPromise<void>; } {
+		if (this.defaults.getNestedModeInitialState) {
+			var nestedMode = TokenizationSupport._validatedNestedMode(this.getNestedMode(state));
+			var missingModePromise = nestedMode.missingModePromise;
+			var nestedModeState: Modes.IState;
+
+			if (nestedMode.mode.tokenizationSupport) {
+				nestedModeState = nestedMode.mode.tokenizationSupport.getInitialState();
+			} else {
+				nestedModeState = new NullState(nestedMode.mode, null);
+			}
+
+			nestedModeState.setStateData(state);
+
+			return {
+				state: nestedModeState,
+				missingModePromise: missingModePromise
+			};
+		}
+		return this.customization.getNestedModeInitialState(state);
+	}
+
+	private getLeavingNestedModeData(line:string, state:Modes.IState): ILeavingNestedModeData {
+		if (this.defaults.getLeavingNestedModeData) {
+			return null;
+		}
+		return this.customization.getLeavingNestedModeData(line, state);
+	}
+
+	private onReturningFromNestedMode(myStateAfterNestedMode:Modes.IState, lastNestedModeState:Modes.IState): void {
+		if (this.defaults.onReturningFromNestedMode) {
+			return null;
+		}
+		return this.customization.onReturningFromNestedMode(myStateAfterNestedMode, lastNestedModeState);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/services/modeService.ts
code:
@@ -7,10 +7,13 @@
 import {createDecorator, ServiceIdentifier} from 'vs/platform/instantiation/common/instantiation';
 import {TPromise} from 'vs/base/common/winjs.base';
 import Modes = require('vs/editor/common/modes');
-import Supports = require ('vs/editor/common/modes/supports');
 import MonarchTypes = require('vs/editor/common/modes/monarch/monarchTypes');
-import {IOnEnterSupportOptions} from 'vs/editor/common/modes/supports/onEnter';
 import {IDisposable} from 'vs/base/common/lifecycle';
+import {IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
+import {IDeclarationContribution} from 'vs/editor/common/modes/supports/declarationSupport';
+import {IReferenceContribution} from 'vs/editor/common/modes/supports/referenceSupport';
+import {IParameterHintsContribution} from 'vs/editor/common/modes/supports/parameterHintsSupport';
+import {ISuggestContribution} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export var IModeService = createDecorator<IModeService>('modeService');
 
@@ -27,31 +30,37 @@ export interface IModeService {
 	configureAllModes(config:any): void;
 	getConfigurationForMode(modeId:string): any;
 
+	// --- reading
+	isRegisteredMode(mimetypeOrModeId: string): boolean;
+	getRegisteredModes(): string[];
+	getRegisteredLanguageNames(): string[];
+	getExtensions(alias: string): string[];
+	getMimeForMode(modeId: string): string;
+	getLanguageName(modeId:string): string;
+	getModeIdForLanguageName(alias:string): string;
+	getModeId(commaSeparatedMimetypesOrCommaSeparatedIds: string): string;
+
 	// --- instantiation
 	lookup(commaSeparatedMimetypesOrCommaSeparatedIds: string): IModeLookupResult[];
 	getMode(commaSeparatedMimetypesOrCommaSeparatedIds: string): Modes.IMode;
 	getOrCreateMode(commaSeparatedMimetypesOrCommaSeparatedIds: string): TPromise<Modes.IMode>;
 	getOrCreateModeByLanguageName(languageName: string): TPromise<Modes.IMode>;
 	getOrCreateModeByFilenameOrFirstLine(filename: string, firstLine?:string): TPromise<Modes.IMode>;
 
-	registerDeclarativeCharacterPairSupport(modeId: string, support: Modes.ICharacterPairContribution): IDisposable;
 	registerCodeLensSupport(modeId: string, support: Modes.ICodeLensSupport): IDisposable;
-	registerDeclarativeCommentsSupport(modeId: string, support: Supports.ICommentsSupportContribution): IDisposable;
-	registerDeclarativeDeclarationSupport(modeId: string, contribution: Supports.IDeclarationContribution): IDisposable;
-	registerDeclarativeElectricCharacterSupport(modeId: string, support: Supports.IBracketElectricCharacterContribution): IDisposable;
+	registerDeclarativeDeclarationSupport(modeId: string, contribution: IDeclarationContribution): IDisposable;
 	registerExtraInfoSupport(modeId: string, support: Modes.IExtraInfoSupport): IDisposable;
 	registerFormattingSupport(modeId: string, support: Modes.IFormattingSupport): IDisposable;
 	registerInplaceReplaceSupport(modeId: string, support: Modes.IInplaceReplaceSupport): IDisposable;
 	registerOccurrencesSupport(modeId: string, support: Modes.IOccurrencesSupport): IDisposable;
 	registerOutlineSupport(modeId: string, support: Modes.IOutlineSupport): IDisposable;
-	registerDeclarativeParameterHintsSupport(modeId: string, support: Modes.IParameterHintsContribution): IDisposable;
+	registerDeclarativeParameterHintsSupport(modeId: string, support: IParameterHintsContribution): IDisposable;
 	registerQuickFixSupport(modeId: string, support: Modes.IQuickFixSupport): IDisposable;
-	registerDeclarativeReferenceSupport(modeId: string, contribution: Supports.IReferenceContribution): IDisposable;
+	registerDeclarativeReferenceSupport(modeId: string, contribution: IReferenceContribution): IDisposable;
 	registerRenameSupport(modeId: string, support: Modes.IRenameSupport): IDisposable;
-	registerDeclarativeSuggestSupport(modeId: string, declaration: Supports.ISuggestContribution): IDisposable;
+	registerDeclarativeSuggestSupport(modeId: string, declaration: ISuggestContribution): IDisposable;
 	registerTokenizationSupport(modeId: string, callback: (mode: Modes.IMode) => Modes.ITokenizationSupport): IDisposable;
-	registerDeclarativeTokenTypeClassificationSupport(modeId: string, support: Supports.ITokenTypeClassificationSupportContribution): IDisposable;
-	registerDeclarativeOnEnterSupport(modeId: string, support: IOnEnterSupportOptions): IDisposable;
+	registerRichEditSupport(modeId: string, support: IRichEditConfiguration): IDisposable;
 
 	registerMonarchDefinition(modeId:string, language:MonarchTypes.ILanguage): IDisposable;
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/services/modeServiceImpl.ts
code:
@@ -8,7 +8,6 @@ import {TPromise} from 'vs/base/common/winjs.base';
 import {IModeService, IModeLookupResult} from 'vs/editor/common/services/modeService';
 import {IModelService} from 'vs/editor/common/services/modelService';
 import Modes = require('vs/editor/common/modes');
-import Supports = require ('vs/editor/common/modes/supports');
 import {IPluginService} from 'vs/platform/plugins/common/plugins';
 import {FrankensteinMode} from 'vs/editor/common/modes/abstractMode';
 import {LanguageExtensions} from 'vs/editor/common/modes/languageExtensionPoint';
@@ -22,9 +21,13 @@ import {compile} from 'vs/editor/common/modes/monarch/monarchCompile';
 import {Registry} from 'vs/platform/platform';
 import {IEditorModesRegistry, Extensions} from 'vs/editor/common/modes/modesRegistry';
 import MonarchCommonTypes = require('vs/editor/common/modes/monarch/monarchCommon');
-import {OnEnterSupport, IOnEnterSupportOptions} from 'vs/editor/common/modes/supports/onEnter';
 import {IDisposable, combinedDispose, empty as EmptyDisposable} from 'vs/base/common/lifecycle';
 import {createAsyncDescriptor0, createAsyncDescriptor1} from 'vs/platform/instantiation/common/descriptors';
+import {RichEditSupport, IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
+import {DeclarationSupport, IDeclarationContribution} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport, IReferenceContribution} from 'vs/editor/common/modes/supports/referenceSupport';
+import {ParameterHintsSupport, IParameterHintsContribution} from 'vs/editor/common/modes/supports/parameterHintsSupport';
+import {SuggestSupport, ComposableSuggestSupport, ISuggestContribution} from 'vs/editor/common/modes/supports/suggestSupport';
 
 interface IModeConfigurationMap { [modeId: string]: any; }
 
@@ -79,14 +82,51 @@ export class ModeServiceImpl implements IModeService {
 		if (!config) {
 			return;
 		}
-		var modeRegistry = <IEditorModesRegistry> Registry.as(Extensions.EditorModes);
-		var modes = modeRegistry.getRegisteredModes();
+		var modes = LanguageExtensions.getRegisteredModes();
 		modes.forEach((modeIdentifier) => {
 			var configuration = config[modeIdentifier];
 			this.configureModeById(modeIdentifier, configuration);
 		});
 	}
 
+	public isRegisteredMode(mimetypeOrModeId: string): boolean {
+		return LanguageExtensions.isRegisteredMode(mimetypeOrModeId);
+	}
+
+	public getRegisteredModes(): string[] {
+		return LanguageExtensions.getRegisteredModes();
+	}
+
+	public getRegisteredLanguageNames(): string[] {
+		return LanguageExtensions.getRegisteredLanguageNames();
+	}
+
+	public getExtensions(alias: string): string[] {
+		return LanguageExtensions.getExtensions(alias);
+	}
+
+	public getMimeForMode(modeId: string): string {
+		return LanguageExtensions.getMimeForMode(modeId);
+	}
+
+	public getLanguageName(modeId: string): string {
+		return LanguageExtensions.getLanguageName(modeId);
+	}
+
+	public getModeIdForLanguageName(alias:string): string {
+		return LanguageExtensions.getModeIdForLanguageNameLowercase(alias);
+	}
+
+	public getModeId(commaSeparatedMimetypesOrCommaSeparatedIds: string): string {
+		var modeIds = LanguageExtensions.extractModeIds(commaSeparatedMimetypesOrCommaSeparatedIds);
+
+		if (modeIds.length > 0) {
+			return modeIds[0];
+		}
+
+		return null;
+	}
+
 	// --- instantiation
 
 	public lookup(commaSeparatedMimetypesOrCommaSeparatedIds: string): IModeLookupResult[]{
@@ -126,16 +166,6 @@ export class ModeServiceImpl implements IModeService {
 		}
 	}
 
-	public getModeId(commaSeparatedMimetypesOrCommaSeparatedIds: string): string {
-		var modeIds = LanguageExtensions.extractModeIds(commaSeparatedMimetypesOrCommaSeparatedIds);
-
-		if (modeIds.length > 0) {
-			return modeIds[0];
-		}
-
-		return null;
-	}
-
 	public getModeIdByLanguageName(languageName: string): string {
 		var modeIds = LanguageExtensions.getModeIdsFromLanguageName(languageName);
 
@@ -263,15 +293,7 @@ export class ModeServiceImpl implements IModeService {
 				return createTokenizationSupport(this, mode, lexer);
 			}),
 
-			this.registerDeclarativeCommentsSupport(modeId, MonarchDefinition.createCommentsSupport(lexer)),
-
-			this.registerDeclarativeElectricCharacterSupport(modeId, MonarchDefinition.createBracketElectricCharacterContribution(lexer)),
-
-			this.registerDeclarativeTokenTypeClassificationSupport(modeId, MonarchDefinition.createTokenTypeClassificationSupportContribution(lexer)),
-
-			this.registerDeclarativeCharacterPairSupport(modeId, MonarchDefinition.createCharacterPairContribution(lexer)),
-
-			this.registerDeclarativeOnEnterSupport(modeId, MonarchDefinition.createOnEnterSupportOptions(lexer))
+			this.registerRichEditSupport(modeId, MonarchDefinition.createRichEditSupport(lexer))
 		);
 	}
 
@@ -280,24 +302,16 @@ export class ModeServiceImpl implements IModeService {
 		return this.doRegisterMonarchDefinition(modeId, lexer);
 	}
 
-	public registerDeclarativeCharacterPairSupport(modeId: string, support: Modes.ICharacterPairContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'characterPairSupport', (mode) => new Supports.CharacterPairSupport(mode, support));
-	}
-
 	public registerCodeLensSupport(modeId: string, support: Modes.ICodeLensSupport): IDisposable {
 		return this.registerModeSupport(modeId, 'codeLensSupport', (mode) => support);
 	}
 
-	public registerDeclarativeCommentsSupport(modeId: string, support: Supports.ICommentsSupportContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'commentsSupport', (mode) => new Supports.CommentsSupport(support));
+	public registerRichEditSupport(modeId: string, support: IRichEditConfiguration): IDisposable {
+		return this.registerModeSupport(modeId, 'richEditSupport', (mode) => new RichEditSupport(modeId, support));
 	}
 
-	public registerDeclarativeDeclarationSupport(modeId: string, contribution: Supports.IDeclarationContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'declarationSupport', (mode) => new Supports.DeclarationSupport(mode, contribution));
-	}
-
-	public registerDeclarativeElectricCharacterSupport(modeId: string, support: Supports.IBracketElectricCharacterContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'electricCharacterSupport', (mode) => new Supports.BracketElectricCharacterSupport(mode, support));
+	public registerDeclarativeDeclarationSupport(modeId: string, contribution: IDeclarationContribution): IDisposable {
+		return this.registerModeSupport(modeId, 'declarationSupport', (mode) => new DeclarationSupport(modeId, contribution));
 	}
 
 	public registerExtraInfoSupport(modeId: string, support: Modes.IExtraInfoSupport): IDisposable {
@@ -320,37 +334,29 @@ export class ModeServiceImpl implements IModeService {
 		return this.registerModeSupport(modeId, 'outlineSupport', (mode) => support);
 	}
 
-	public registerDeclarativeParameterHintsSupport(modeId: string, support: Modes.IParameterHintsContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'parameterHintsSupport', (mode) => new Supports.ParameterHintsSupport(mode, support));
+	public registerDeclarativeParameterHintsSupport(modeId: string, support: IParameterHintsContribution): IDisposable {
+		return this.registerModeSupport(modeId, 'parameterHintsSupport', (mode) => new ParameterHintsSupport(modeId, support));
 	}
 
 	public registerQuickFixSupport(modeId: string, support: Modes.IQuickFixSupport): IDisposable {
 		return this.registerModeSupport(modeId, 'quickFixSupport', (mode) => support);
 	}
 
-	public registerDeclarativeReferenceSupport(modeId: string, contribution: Supports.IReferenceContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'referenceSupport', (mode) => new Supports.ReferenceSupport(mode, contribution));
+	public registerDeclarativeReferenceSupport(modeId: string, contribution: IReferenceContribution): IDisposable {
+		return this.registerModeSupport(modeId, 'referenceSupport', (mode) => new ReferenceSupport(modeId, contribution));
 	}
 
 	public registerRenameSupport(modeId: string, support: Modes.IRenameSupport): IDisposable {
 		return this.registerModeSupport(modeId, 'renameSupport', (mode) => support);
 	}
 
-	public registerDeclarativeSuggestSupport(modeId: string, declaration: Supports.ISuggestContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'suggestSupport', (mode) => new Supports.SuggestSupport(mode, declaration));
+	public registerDeclarativeSuggestSupport(modeId: string, declaration: ISuggestContribution): IDisposable {
+		return this.registerModeSupport(modeId, 'suggestSupport', (mode) => new SuggestSupport(modeId, declaration));
 	}
 
 	public registerTokenizationSupport(modeId: string, callback: (mode: Modes.IMode) => Modes.ITokenizationSupport): IDisposable {
 		return this.registerModeSupport(modeId, 'tokenizationSupport', callback);
 	}
-
-	public registerDeclarativeTokenTypeClassificationSupport(modeId: string, support: Supports.ITokenTypeClassificationSupportContribution): IDisposable {
-		return this.registerModeSupport(modeId, 'tokenTypeClassificationSupport', (mode) => new Supports.TokenTypeClassificationSupport(support));
-	}
-
-	public registerDeclarativeOnEnterSupport(modeId: string, opts: IOnEnterSupportOptions): IDisposable {
-		return this.registerModeSupport(modeId, 'onEnterSupport', (mode) => new OnEnterSupport(modeId, opts));
-	}
 }
 
 export class MainThreadModeServiceImpl extends ModeServiceImpl {
@@ -397,7 +403,7 @@ export class MainThreadModeServiceImpl extends ModeServiceImpl {
 			super.doRegisterMonarchDefinition(modeId, lexer),
 
 			this.registerModeSupport(modeId, 'suggestSupport', (mode) => {
-				return new Supports.ComposableSuggestSupport(mode, MonarchDefinition.createSuggestSupport(this._modelService, mode, lexer));
+				return new ComposableSuggestSupport(modeId, MonarchDefinition.createSuggestSupport(this._modelService, mode, lexer));
 			})
 		);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/comment/common/blockCommentCommand.ts
code:
@@ -121,13 +121,8 @@ export class BlockCommentCommand implements EditorCommon.ICommand {
 		var endLineNumber = this._selection.endLineNumber;
 		var endColumn = this._selection.endColumn;
 
-		var commentsSupport = model.getModeAtPosition(startLineNumber, startColumn).commentsSupport;
-		if (!commentsSupport) {
-			// Mode does not support comments
-			return;
-		}
-
-		var config = commentsSupport.getCommentsConfiguration();
+		let richEditSupport = model.getModeAtPosition(startLineNumber, startColumn).richEditSupport;
+		let config = richEditSupport ? richEditSupport.comments : null;
 		if (!config || !config.blockCommentStartToken || !config.blockCommentEndToken) {
 			// Mode does not support block comments
 			return;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/comment/common/lineCommentCommand.ts
code:
@@ -81,9 +81,9 @@ export class LineCommentCommand implements EditorCommon.ICommand {
 			if (seenModes[modeId]) {
 				commentStr = seenModes[modeId];
 			} else {
-				config = (mode.commentsSupport ? mode.commentsSupport.getCommentsConfiguration() : null);
-				commentStr = (config && config.lineCommentTokens && config.lineCommentTokens.length > 0 ? config.lineCommentTokens[0] : null);
-				if (commentStr === null || commentStr.length === 0) {
+				config = (mode.richEditSupport ? mode.richEditSupport.comments : null);
+				commentStr = (config ? config.lineCommentToken : null);
+				if (!commentStr) {
 					// Mode does not support line comments
 					return null;
 				}
@@ -273,13 +273,8 @@ export class LineCommentCommand implements EditorCommon.ICommand {
 	 * Given an unsuccessful analysis, delegate to the block comment command
 	 */
 	private _executeBlockComment(model:EditorCommon.ITokenizedModel, builder:EditorCommon.IEditOperationBuilder, s:EditorCommon.IEditorSelection): void {
-		var commentsSupport = model.getModeAtPosition(s.startLineNumber, s.startColumn).commentsSupport;
-		if (!commentsSupport) {
-			// Mode does not support comments
-			return;
-		}
-
-		var config = commentsSupport.getCommentsConfiguration();
+		let richEditSupport = model.getModeAtPosition(s.startLineNumber, s.startColumn).richEditSupport;
+		let config = richEditSupport ? richEditSupport.comments : null;
 		if (!config || !config.blockCommentStartToken || !config.blockCommentEndToken) {
 			// Mode does not support block comments
 			return;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/comment/test/common/blockCommentCommand.test.ts
code:
@@ -11,7 +11,7 @@ import {BlockCommentCommand} from 'vs/editor/contrib/comment/common/blockComment
 import {Selection} from 'vs/editor/common/core/selection';
 
 function testBlockCommentCommand(lines: string[], selection: Selection, expectedLines: string[], expectedSelection: Selection): void {
-	var mode = new CommentMode({ lineCommentTokens: ['!@#'], blockCommentStartToken: '<0', blockCommentEndToken: '0>' });
+	var mode = new CommentMode({ lineCommentToken: '!@#', blockCommentStartToken: '<0', blockCommentEndToken: '0>' });
 	testCommand(lines, mode, selection, (sel) => new BlockCommentCommand(sel), expectedLines, expectedSelection);
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/comment/test/common/lineCommentCommand.test.ts
code:
@@ -15,7 +15,7 @@ import {Selection} from 'vs/editor/common/core/selection';
 suite('Editor Contrib - Line Comment Command', () => {
 
 	function testLineCommentCommand(lines: string[], selection: Selection, expectedLines: string[], expectedSelection: Selection): void {
-		var mode = new ModelModes.CommentMode({ lineCommentTokens: ['!@#'], blockCommentStartToken: '<!@#', blockCommentEndToken: '#@!>' });
+		var mode = new ModelModes.CommentMode({ lineCommentToken: '!@#', blockCommentStartToken: '<!@#', blockCommentEndToken: '#@!>' });
 		TU.testCommand(lines, mode, selection, (sel) => new LineCommentCommand.LineCommentCommand(sel, 4, LineCommentCommand.Type.Toggle), expectedLines, expectedSelection);
 	}
 
@@ -490,7 +490,7 @@ suite('Editor Contrib - Line Comment Command', () => {
 suite('Editor Contrib - Line Comment As Block Comment', () => {
 
 	function testLineCommentCommand(lines: string[], selection: Selection, expectedLines: string[], expectedSelection: Selection): void {
-		var mode = new ModelModes.CommentMode({ lineCommentTokens: [''], blockCommentStartToken: '(', blockCommentEndToken: ')' });
+		var mode = new ModelModes.CommentMode({ lineCommentToken: '', blockCommentStartToken: '(', blockCommentEndToken: ')' });
 		TU.testCommand(lines, mode, selection, (sel) => new LineCommentCommand.LineCommentCommand(sel, 4, LineCommentCommand.Type.Toggle), expectedLines, expectedSelection);
 	}
 
@@ -600,7 +600,7 @@ suite('Editor Contrib - Line Comment As Block Comment', () => {
 
 suite('Editor Contrib - Line Comment As Block Comment 2', () => {
 	function testLineCommentCommand(lines: string[], selection: Selection, expectedLines: string[], expectedSelection: Selection): void {
-		var mode = new ModelModes.CommentMode({ lineCommentTokens: [], blockCommentStartToken: '<!@#', blockCommentEndToken: '#@!>' });
+		var mode = new ModelModes.CommentMode({ lineCommentToken: null, blockCommentStartToken: '<!@#', blockCommentEndToken: '#@!>' });
 		TU.testCommand(lines, mode, selection, (sel) => new LineCommentCommand.LineCommentCommand(sel, 4, LineCommentCommand.Type.Toggle), expectedLines, expectedSelection);
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/find/common/findController.ts
code:
@@ -324,7 +324,7 @@ export class StartFindReplaceAction extends EditorAction {
 		let controller = CommonFindController.getFindController(this.editor);
 		controller.start({
 			forceRevealReplace: true,
-			seedSearchStringFromSelection: (controller.getState().searchString.length === 0),
+			seedSearchStringFromSelection: true,
 			seedSearchScopeFromSelection: true,
 			shouldFocus: FindStartFocusAction.FocusReplaceInput,
 			shouldAnimate: true

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/find/common/findModel.ts
code:
@@ -286,7 +286,7 @@ export class FindModelBoundToEditorModel {
 		if (!this._state.isRegex) {
 			return this._state.replaceString;
 		}
-		let regexp = Strings.createRegExp(this._state.searchString, this._state.isRegex, this._state.matchCase, this._state.wholeWord);
+		let regexp = Strings.createRegExp(this._state.searchString, this._state.isRegex, this._state.matchCase, this._state.wholeWord, true);
 		// Parse the replace string to support that \t or \n mean the right thing
 		let parsedReplaceString = parseReplaceString(this._state.replaceString);
 		return matchedString.replace(regexp, parsedReplaceString);

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/smartSelect/common/tokenSelectionSupport.ts
code:
@@ -21,6 +21,10 @@ class TokenSelectionSupport implements Modes.ILogicalSelectionSupport {
 	}
 
 	public getRangesToPosition(resource: URI, position: EditorCommon.IPosition): TPromise<Modes.ILogicalSelectionEntry[]> {
+		return TPromise.as(this.getRangesToPositionSync(resource, position));
+	}
+
+	public getRangesToPositionSync(resource: URI, position: EditorCommon.IPosition): Modes.ILogicalSelectionEntry[] {
 		var model = this._modelService.getModel(resource),
 			entries: Modes.ILogicalSelectionEntry[] = [];
 
@@ -33,7 +37,7 @@ class TokenSelectionSupport implements Modes.ILogicalSelectionSupport {
 			});
 		}
 
-		return TPromise.as(entries);
+		return entries;
 	}
 
 	private _doGetRangesToPosition(model: EditorCommon.IModel, position: EditorCommon.IPosition): EditorCommon.IRange[] {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/smartSelect/common/tokenTree.ts
code:
@@ -8,6 +8,8 @@ import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import {Range} from 'vs/editor/common/core/range';
 import {Position} from 'vs/editor/common/core/position';
+import {ignoreBracketsInToken} from 'vs/editor/common/modes/supports';
+import {BracketsUtils} from 'vs/editor/common/modes/supports/electricCharacter';
 
 export class Node {
 
@@ -107,7 +109,13 @@ class TokenScanner {
 	private _versionId: number;
 	private _currentLineNumber: number;
 	private _currentTokenIndex: number;
+	private _currentTokenStart: number;
 	private _currentLineTokens: EditorCommon.ILineTokens;
+	private _currentLineModeTransitions: Modes.IModeTransition[];
+	private _currentModeIndex: number;
+	private _nextModeStart: number;
+	private _currentModeBrackets: Modes.IRichEditBrackets;
+	private _currentLineText: string;
 
 	constructor(model: EditorCommon.IModel) {
 		this._model = model;
@@ -127,26 +135,87 @@ class TokenScanner {
 		if (!this._currentLineTokens) {
 			// no tokens for this line
 			this._currentLineTokens = this._model.getLineTokens(this._currentLineNumber);
+			this._currentLineText = this._model.getLineContent(this._currentLineNumber);
+			this._currentLineModeTransitions = this._model._getLineModeTransitions(this._currentLineNumber);
 			this._currentTokenIndex = 0;
+			this._currentTokenStart = 0;
+			this._currentModeIndex = -1;
+			this._nextModeStart = 0;
 		}
 		if (this._currentTokenIndex >= this._currentLineTokens.getTokenCount()) {
 			// last token of line visited
 			this._currentLineNumber += 1;
 			this._currentLineTokens = null;
 			return this.next();
 		}
-		var token: Token = {
-			type: this._currentLineTokens.getTokenType(this._currentTokenIndex),
-			bracket: this._currentLineTokens.getTokenBracket(this._currentTokenIndex),
+
+		if (this._currentTokenStart >= this._nextModeStart) {
+			this._currentModeIndex++;
+			this._nextModeStart = (this._currentModeIndex + 1 < this._currentLineModeTransitions.length ? this._currentLineModeTransitions[this._currentModeIndex + 1].startIndex : this._currentLineText.length + 1);
+			let mode = (this._currentModeIndex < this._currentLineModeTransitions.length ? this._currentLineModeTransitions[this._currentModeIndex] : null);
+			this._currentModeBrackets = (mode && mode.mode.richEditSupport ? mode.mode.richEditSupport.brackets : null);
+		}
+
+		let tokenType = this._currentLineTokens.getTokenType(this._currentTokenIndex);
+		let tokenEndIndex = this._currentLineTokens.getTokenEndIndex(this._currentTokenIndex, this._currentLineText.length);
+
+		let nextBracket: Range = null;
+		if (this._currentModeBrackets && !ignoreBracketsInToken(tokenType)) {
+			nextBracket = BracketsUtils.findNextBracketInToken(this._currentModeBrackets.forwardRegex, this._currentLineNumber, this._currentLineText, this._currentTokenStart, tokenEndIndex);
+		}
+
+		if (nextBracket && this._currentTokenStart < nextBracket.startColumn - 1) {
+			// found a bracket, but it is not at the beginning of the token
+			tokenEndIndex = nextBracket.startColumn - 1;
+			nextBracket = null;
+		}
+
+		let bracketData: EditorCommon.IRichEditBracket = null;
+		let bracketIsOpen: boolean = false;
+		if (nextBracket) {
+			let bracketText = this._currentLineText.substring(nextBracket.startColumn - 1, nextBracket.endColumn - 1);
+			bracketData = this._currentModeBrackets.textIsBracket[bracketText];
+			bracketIsOpen = this._currentModeBrackets.textIsOpenBracket[bracketText];
+		}
+
+		if (!bracketData) {
+			let token: Token = {
+				type: tokenType,
+				bracket: Modes.Bracket.None,
+				range: {
+					startLineNumber: this._currentLineNumber,
+					startColumn: 1 + this._currentTokenStart,
+					endLineNumber: this._currentLineNumber,
+					endColumn: 1 + tokenEndIndex
+				}
+			};
+			// console.log('TOKEN: <<' + this._currentLineText.substring(this._currentTokenStart, tokenEndIndex) + '>>');
+
+			this._currentTokenIndex += 1;
+			this._currentTokenStart = (this._currentTokenIndex < this._currentLineTokens.getTokenCount() ? this._currentLineTokens.getTokenStartIndex(this._currentTokenIndex) : 0);
+			return token;
+		}
+
+		let type = `${bracketData.modeId};${bracketData.open};${bracketData.close}`;
+		let token: Token = {
+			type: type,
+			bracket: bracketIsOpen ? Modes.Bracket.Open : Modes.Bracket.Close,
 			range: {
 				startLineNumber: this._currentLineNumber,
-				startColumn: 1 + this._currentLineTokens.getTokenStartIndex(this._currentTokenIndex),
+				startColumn: 1 + this._currentTokenStart,
 				endLineNumber: this._currentLineNumber,
-				endColumn: 1 + this._currentLineTokens.getTokenEndIndex(this._currentTokenIndex, this._model.getLineMaxColumn(this._currentLineNumber))
+				endColumn: nextBracket.endColumn
 			}
 		};
-		//		token.__debugContent = this._model.getValueInRange(token.range);
-		this._currentTokenIndex += 1;
+		// console.log('BRACKET: <<' + this._currentLineText.substring(this._currentTokenStart, nextBracket.endColumn - 1) + '>>');
+
+		if (nextBracket.endColumn - 1 < tokenEndIndex) {
+			// found a bracket, but it is not at the end of the token
+			this._currentTokenStart = nextBracket.endColumn - 1;
+		} else {
+			this._currentTokenIndex += 1;
+			this._currentTokenStart = (this._currentTokenIndex < this._currentLineTokens.getTokenCount() ? this._currentLineTokens.getTokenStartIndex(this._currentTokenIndex) : 0);
+		}
 		return token;
 	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/smartSelect/test/common/tokenSelectionSupport.test.ts
code:
@@ -0,0 +1,68 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import 'vs/languages/javascript/common/javascript.contribution';
+import assert = require('assert');
+import Modes = require('vs/editor/common/modes');
+import modesUtil = require('vs/editor/test/common/modesUtil');
+import {createMockModelService} from 'vs/editor/test/common/servicesTestUtils';
+import URI from 'vs/base/common/uri';
+import TokenSelectionSupport = require('vs/editor/contrib/smartSelect/common/tokenSelectionSupport');
+import {Range} from 'vs/editor/common/core/range';
+
+suite('TokenSelectionSupport', () => {
+
+	let modelService = createMockModelService();
+	let tokenSelectionSupport = new TokenSelectionSupport(modelService);
+	let _mode: Modes.IMode;
+
+	suiteSetup((done) => {
+		modesUtil.load('javascript').then(mode => {
+			_mode = mode;
+			done();
+		});
+	});
+
+	function assertGetRangesToPosition(text:string[], lineNumber:number, column:number, ranges:Range[]): void {
+		let uri = URI.file('test.js');
+		let model = modelService.createModel(text.join('\n'), _mode, uri);
+
+		let actual = tokenSelectionSupport.getRangesToPositionSync(uri, {
+			lineNumber: lineNumber,
+			column: column
+		});
+
+		let actualStr = actual.map(r => new Range(r.range.startLineNumber, r.range.startColumn, r.range.endLineNumber, r.range.endColumn).toString());
+		let desiredStr = ranges.map(r => String(r));
+
+		assert.deepEqual(actualStr, desiredStr);
+
+		modelService.destroyModel(uri);
+	}
+
+	test('getRangesToPosition #1', () => {
+
+		assertGetRangesToPosition([
+			'function a(bar, foo){',
+			'\tif (bar) {',
+			'\t\treturn (bar + (2 * foo))',
+			'\t}',
+			'}'
+		], 3, 20, [
+			new Range(1, 1, 5, 2),
+			new Range(1, 21, 5, 2),
+			new Range(2, 1, 4, 3),
+			new Range(2, 11, 4, 3),
+			new Range(3, 1, 4, 2),
+			new Range(3, 1, 3, 27),
+			new Range(3, 10, 3, 27),
+			new Range(3, 11, 3, 26),
+			new Range(3, 17, 3, 26),
+			new Range(3, 18, 3, 25),
+			new Range(3, 19, 3, 20)
+		]);
+	});
+});
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/node/languageConfiguration.ts
code:
@@ -4,14 +4,13 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import * as nls from 'vs/nls';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {LanguageExtensions} from 'vs/editor/common/modes/languageExtensionPoint';
 import {PluginsRegistry} from 'vs/platform/plugins/common/pluginsRegistry';
 import pfs = require('vs/base/node/pfs');
-import Supports = require ('vs/editor/common/modes/supports');
-import {IOnEnterSupportOptions} from 'vs/editor/common/modes/supports/onEnter';
 import json = require('vs/base/common/json');
-import {ICharacterPairContribution} from 'vs/editor/common/modes';
+import {IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
 
 type CharacterPair = [string, string];
 
@@ -53,7 +52,7 @@ export class LanguageConfigurationFileHandler {
 			var errors = [];
 			var configuration = <ILanguageConfiguration>json.parse(fileContents.toString(), errors);
 			if (errors.length) {
-				console.error("Errors parsing " + configFilePath + ": " + errors.join('\n'));
+				console.error(nls.localize('parseErrors', "Errors parsing {0}: {1}", configFilePath, errors.join('\n')));
 			}
 			this._handleConfig(modeId, configuration);
 		}, (err) => {
@@ -62,47 +61,33 @@ export class LanguageConfigurationFileHandler {
 	}
 
 	private _handleConfig(modeId:string, configuration:ILanguageConfiguration): void {
-		if (configuration.comments) {
-			let comments = configuration.comments;
-			let contrib: Supports.ICommentsSupportContribution = { commentsConfiguration: {} };
 
-			if (comments.lineComment) {
-				contrib.commentsConfiguration.lineCommentTokens = [comments.lineComment];
-			}
-			if (comments.blockComment) {
-				contrib.commentsConfiguration.blockCommentStartToken = comments.blockComment[0];
-				contrib.commentsConfiguration.blockCommentEndToken = comments.blockComment[1];
-			}
+		let richEditConfig:IRichEditConfiguration = {};
 
-			this._modeService.registerDeclarativeCommentsSupport(modeId, contrib);
+		if (configuration.comments) {
+			richEditConfig.comments = configuration.comments;
 		}
 
 		if (configuration.brackets) {
-			let brackets = configuration.brackets;
+			richEditConfig.brackets = configuration.brackets;
 
-			let onEnterContrib: IOnEnterSupportOptions = {};
-			onEnterContrib.brackets = brackets.map(pair => {
-				let [open, close] = pair;
-				return { open: open, close: close };
-			});
-			this._modeService.registerDeclarativeOnEnterSupport(modeId, onEnterContrib);
-
-			let characterPairContrib: ICharacterPairContribution = {
-				autoClosingPairs: brackets.map(pair => {
+			richEditConfig.__characterPairSupport = {
+				autoClosingPairs: configuration.brackets.map(pair => {
 					let [open, close] = pair;
 					return { open: open, close: close };
 				})
 			};
-			this._modeService.registerDeclarativeCharacterPairSupport(modeId, characterPairContrib);
 		}
 
 		// TMSyntax hard-codes these and tokenizes them as brackets
-		this._modeService.registerDeclarativeElectricCharacterSupport(modeId, {
+		richEditConfig.__electricCharacterSupport = {
 			brackets: [
 				{ tokenType:'delimiter.curly.' + modeId, open: '{', close: '}', isElectric: true },
 				{ tokenType:'delimiter.square.' + modeId, open: '[', close: ']', isElectric: true },
 				{ tokenType:'delimiter.paren.' + modeId, open: '(', close: ')', isElectric: true }
 			]
-		});
+		};
+
+		this._modeService.registerRichEditSupport(modeId, richEditConfig);
 	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/node/textMate/TMSnippets.ts
code:
@@ -12,8 +12,8 @@ import json = require('vs/base/common/json');
 import modesExt = require('vs/editor/common/modes/modesRegistry');
 import paths = require('vs/base/common/paths');
 import {IModelService} from 'vs/editor/common/services/modelService';
+import {IModeService} from 'vs/editor/common/services/modeService';
 import {PluginsRegistry, IMessageCollector} from 'vs/platform/plugins/common/pluginsRegistry';
-import {LanguageExtensions} from 'vs/editor/common/modes/languageExtensionPoint';
 
 import pfs = require('vs/base/node/pfs');
 
@@ -53,11 +53,14 @@ let snippetsExtensionPoint = PluginsRegistry.registerExtensionPoint<ITMSnippetsE
 
 export class MainProcessTextMateSnippet {
 	private _modelService: IModelService;
+	private _modeService: IModeService;
 
 	constructor(
-		@IModelService modelService: IModelService
+		@IModelService modelService: IModelService,
+		@IModeService modeService: IModeService
 	) {
 		this._modelService = modelService;
+		this._modeService = modeService;
 
 		snippetsExtensionPoint.setHandler((extensions) => {
 			for (let i = 0; i < extensions.length; i++) {
@@ -70,7 +73,7 @@ export class MainProcessTextMateSnippet {
 	}
 
 	private _withTMSnippetContribution(extensionFolderPath:string, snippet:ITMSnippetsExtensionPoint, collector:IMessageCollector): void {
-		if (!snippet.language || (typeof snippet.language !== 'string') || !LanguageExtensions.isRegisteredMode(snippet.language)) {
+		if (!snippet.language || (typeof snippet.language !== 'string') || !this._modeService.isRegisteredMode(snippet.language)) {
 			collector.error(nls.localize('invalid.language', "Unknown language in `contributes.{0}.language`. Provided value: {1}", snippetsExtensionPoint.name, String(snippet.language)));
 			return;
 		}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/node/textMate/TMSyntax.ts
code:
@@ -16,7 +16,6 @@ import textMate = require('vscode-textmate');
 import TMState = require('vs/editor/common/modes/TMState');
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {PluginsRegistry, IMessageCollector} from 'vs/platform/plugins/common/pluginsRegistry';
-import {LanguageExtensions} from 'vs/editor/common/modes/languageExtensionPoint';
 
 export interface ITMSyntaxExtensionPoint {
 	language: string;
@@ -75,7 +74,7 @@ export class MainProcessTextMateSyntax {
 	}
 
 	private _handleGrammarExtensionPointUser(extensionFolderPath:string, syntax:ITMSyntaxExtensionPoint, collector: IMessageCollector): void {
-		if (syntax.language && ((typeof syntax.language !== 'string') || !LanguageExtensions.isRegisteredMode(syntax.language))) {
+		if (syntax.language && ((typeof syntax.language !== 'string') || !this._modeService.isRegisteredMode(syntax.language))) {
 			collector.error(nls.localize('invalid.language', "Unknown language in `contributes.{0}.language`. Provided value: {1}", grammarsExtPoint.name, String(syntax.language)));
 			return;
 		}
@@ -162,10 +161,6 @@ class Tokenizer {
 			modeTransitions: [{ startIndex: offsetDelta, mode: freshState.getMode() }],
 		};
 
-		let noBracket = Modes.Bracket.None,
-			openBracket = Modes.Bracket.Open,
-			closeBracket = Modes.Bracket.Close;
-
 		for (let tokenIndex = 0, len = textMateResult.tokens.length; tokenIndex < len; tokenIndex++) {
 			let token = textMateResult.tokens[tokenIndex];
 			let tokenStartIndex = token.startIndex;
@@ -175,63 +170,55 @@ class Tokenizer {
 
 			if (t.isOpaqueToken) {
 				// Should not do any smartness to detect brackets on this token
-				ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType, noBracket));
+				ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType));
 				continue;
 			}
 
 			let i: number,
 				charCode: number,
-				isBracket: string,
-				bracketType: Modes.Bracket;
+				isBracket: string;
 
 			for (i = tokenStartIndex; i < tokenEndIndex; i++) {
 				charCode = line.charCodeAt(i);
 				isBracket = null;
-				bracketType = noBracket;
 
 				switch (charCode) {
 					case _openParen: // (
 						isBracket = 'delimiter.paren';
-						bracketType = openBracket;
 						break;
 					case _closeParen: // )
 						isBracket = 'delimiter.paren';
-						bracketType = closeBracket;
 						break;
 					case _openCurly: // {
 						isBracket = 'delimiter.curly';
-						bracketType = openBracket;
 						break;
 					case _closeCurly: // }
 						isBracket = 'delimiter.curly';
-						bracketType = closeBracket;
 						break;
 					case _openSquare: // [
 						isBracket = 'delimiter.square';
-						bracketType = openBracket;
 						break;
 					case _closeSquare: // ]
 						isBracket = 'delimiter.square';
-						bracketType = closeBracket;
 						break;
 				}
 
 				if (isBracket) {
 					if (tokenStartIndex < i) {
 						// push a token before character `i`
-						ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType, noBracket));
+						ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType));
 						tokenStartIndex = i;
 					}
 
 					// push character `i` as a token
-					ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, isBracket + '.' + t.modeToken, bracketType));
+					ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, isBracket + '.' + t.modeToken));
 					tokenStartIndex = i + 1;
 				}
 			}
 
 			if (tokenStartIndex < tokenEndIndex) {
 				// push the remaining text as a token
-				ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType, noBracket));
+				ret.tokens.push(new supports.Token(tokenStartIndex + offsetDelta, t.tokenType));
 			}
 		}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/bat.ts
code:
@@ -23,17 +23,17 @@ export var language = <ILanguage> {
 		{ token: 'punctuation.square', open: '[', close: ']' }
 	],
 
-	enhancedBrackets: [
-			{
-				openTrigger: 'l',
-				open: /setlocal$/i,
-				closeComplete: 'endlocal',
-				matchCase: true,
-				closeTrigger: 'l',
-				close: /endlocal$/i,
-				tokenType: 'keyword.tag-setlocal'
-			}
-		],
+	// enhancedBrackets: [
+	// 		{
+	// 			openTrigger: 'l',
+	// 			open: /setlocal$/i,
+	// 			closeComplete: 'endlocal',
+	// 			matchCase: true,
+	// 			closeTrigger: 'l',
+	// 			close: /endlocal$/i,
+	// 			tokenType: 'keyword.tag-setlocal'
+	// 		}
+	// 	],
 
 	keywords: /call|defined|echo|errorlevel|exist|for|goto|if|pause|set|shift|start|title|not|pushd|popd/,
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/coffee.ts
code:
@@ -23,11 +23,11 @@ export var language = <ILanguage> {
 		{ open:'(', close:')', token:'delimiter.parenthesis'}
 	],
 
-	enhancedBrackets: [
-			{ open: /for$/ }, { open: /while$/ },	{ open: /loop$/ }, { open: /if$/ }, { open: /unless$/ },
-			{ open: /else$/ }, { open: /switch$/ }, { open: /try$/ }, { open: /catch$/ }, { open: /finally$/ },
-			{ open: /class$/ }, { open: /->$/ }
-		],
+	// enhancedBrackets: [
+	// 		{ open: /for$/ }, { open: /while$/ },	{ open: /loop$/ }, { open: /if$/ }, { open: /unless$/ },
+	// 		{ open: /else$/ }, { open: /switch$/ }, { open: /try$/ }, { open: /catch$/ }, { open: /finally$/ },
+	// 		{ open: /class$/ }, { open: /->$/ }
+	// 	],
 
 	// the default separators
 	wordDefinition: /(-?\d*\.\d\w*)|([^\`\~\!\@\#%\^\&\*\(\)\=\$\-\+\[\{\]\}\\\|\;\:\'\"\,\.\<\>\/\?\s]+)/g,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/powershell.ts
code:
@@ -25,12 +25,12 @@ export var language = <ILanguage> {
 				{ token: 'delimiter.square', open: '[', close: ']' },
 				{ token: 'delimiter.parenthesis', open: '(', close: ')' }],
 
-	enhancedBrackets: [
-				{ tokenType:'string', openTrigger: '"', open: /@"$/, closeComplete: '"@' },
-				{ tokenType:'string', openTrigger: '\'', open: /@'$/, closeComplete: '\'@' },
-				{ tokenType:'string', openTrigger: '"', open: /"$/, closeComplete: '"' },
-				{ tokenType: 'string', openTrigger: '\'', open: /'$/, closeComplete: '\'' }
-	],
+	// enhancedBrackets: [
+	// 			{ tokenType:'string', openTrigger: '"', open: /@"$/, closeComplete: '"@' },
+	// 			{ tokenType:'string', openTrigger: '\'', open: /@'$/, closeComplete: '\'@' },
+	// 			{ tokenType:'string', openTrigger: '"', open: /"$/, closeComplete: '"' },
+	// 			{ tokenType: 'string', openTrigger: '\'', open: /'$/, closeComplete: '\'' }
+	// ],
 
 	autoClosingPairs: [['{', '}'], ['[', ']'], ['(', ')']],	// Defined explicitly, to suppress the
 															// default auto-closing of ' and " which is

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/python.ts
code:
@@ -156,7 +156,7 @@ export var language = <ILanguage> {
 	],
 
 	// Cause an automatic indent to occur after lines ending in :.
-	enhancedBrackets: [ { open: /.*:\s*$/,  closeComplete: 'else:' } ],
+	// enhancedBrackets: [ { open: /.*:\s*$/,  closeComplete: 'else:' } ],
 
 	tokenizer: {
 	root: [

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/r.ts
code:
@@ -117,7 +117,7 @@ export var language = <ILanguage> {
 		'\\a',
 		'\\f',
 		'\\v',
-		"\\'",
+		'\\\'',
 		'\\"',
 		'\\\\'
 	],

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/sql.ts
code:
@@ -16,11 +16,11 @@ export var language = <ILanguage> {
 		{ open: '[', close: ']', token: 'delimiter.square' },
 		{ open: '(', close: ')', token: 'delimiter.parenthesis' }
 	],
-	enhancedBrackets:[
-		{ openTrigger: 'n', open: /begin$/i, closeComplete: 'end', matchCase: true },
-		{ openTrigger: 'e', open: /case$/i, closeComplete: 'end', matchCase: true },
-		{ openTrigger: 'n', open: /when$/i, closeComplete: 'then', matchCase: true }
-	],
+	// enhancedBrackets:[
+	// 	{ openTrigger: 'n', open: /begin$/i, closeComplete: 'end', matchCase: true },
+	// 	{ openTrigger: 'e', open: /case$/i, closeComplete: 'end', matchCase: true },
+	// 	{ openTrigger: 'n', open: /when$/i, closeComplete: 'then', matchCase: true }
+	// ],
 	noindentBrackets: '()',
 	editorOptions: { tabSize: 4, insertSpaces: true },
 	lineComment: '--',

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/test/testUtil.ts
code:
@@ -11,6 +11,7 @@ import modesUtil = require('vs/editor/test/common/modesUtil');
 import monarchCompile = require('vs/editor/common/modes/monarch/monarchCompile');
 import MonarchDefinition = require('vs/editor/common/modes/monarch/monarchDefinition');
 import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 
 export enum Bracket {
 	None = 0,
@@ -47,8 +48,8 @@ export function testOnEnter(name:string, language: types.ILanguage, callback:(as
 	suite(language.displayName || name, () => {
 		test('onEnter', () => {
 			var lexer = monarchCompile.compile(language);
-			var onEnterSupport = new OnEnterSupport('test', MonarchDefinition.createOnEnterSupportOptions(lexer));
-			callback(modesUtil.createOnEnterAsserter('test', onEnterSupport));
+			var richEditSupport = new RichEditSupport('test', MonarchDefinition.createRichEditSupport(lexer));
+			callback(modesUtil.createOnEnterAsserter('test', richEditSupport));
 		});
 	});
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/types.ts
code:
@@ -35,7 +35,7 @@ export interface ILanguage {
 	autoClosingPairs?: string[][];				// for example [['"','"']]
 	wordDefinition?: RegExp;					// word definition regular expression
 	outdentTriggers?: string;					// characters that could potentially cause outdentation
-	enhancedBrackets?: IRegexBracketPair[];     // Advanced auto completion, auto indenting, and bracket matching
+	// enhancedBrackets?: IRegexBracketPair[];     // Advanced auto completion, auto indenting, and bracket matching
 }
 
 /**
@@ -47,33 +47,33 @@ export interface ILanguageBracket {
 	token: string;	// token class
 }
 
-export interface ILanguageAutoComplete {
-	triggers: string;				// characters that trigger auto completion rules
-	match: string|RegExp;			// autocomplete if this matches
-	complete: string;				// complete with this string
-}
+// export interface ILanguageAutoComplete {
+// 	triggers: string;				// characters that trigger auto completion rules
+// 	match: string|RegExp;			// autocomplete if this matches
+// 	complete: string;				// complete with this string
+// }
 
-export interface ILanguageAutoIndent {
-	match: string|RegExp; 			// auto indent if this matches on enter
-	matchAfter: string|RegExp;		// and auto-outdent if this matches on the next line
-}
+// export interface ILanguageAutoIndent {
+// 	match: string|RegExp; 			// auto indent if this matches on enter
+// 	matchAfter: string|RegExp;		// and auto-outdent if this matches on the next line
+// }
 
-/**
-	* Regular expression based brackets. These are always electric.
-	*/
-export interface IRegexBracketPair {
-	openTrigger?: string; // The character that will trigger the evaluation of 'open'.
-	open: RegExp; // The definition of when an opening brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
-	closeComplete?: string; // How to complete a matching open brace. Matches from 'open' will be expanded, e.g. '</$1>'
-	matchCase?: boolean; // If set to true, the case of the string captured in 'open' will be detected an applied also to 'closeComplete'.
-						// This is useful for cases like BEGIN/END or begin/end where the opening and closing phrases are unrelated.
-						// For identical phrases, use the $1 replacement syntax above directly in closeComplete, as it will
-						// include the proper casing from the captured string in 'open'.
-						// Upper/Lower/Camel cases are detected. Camel case dection uses only the first two characters and assumes
-						// that 'closeComplete' contains wors separated by spaces (e.g. 'End Loop')
+// /**
+// 	* Regular expression based brackets. These are always electric.
+// 	*/
+// export interface IRegexBracketPair {
+// 	// openTrigger?: string; // The character that will trigger the evaluation of 'open'.
+// 	open: RegExp; // The definition of when an opening brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
+// 	closeComplete?: string; // How to complete a matching open brace. Matches from 'open' will be expanded, e.g. '</$1>'
+// 	matchCase?: boolean; // If set to true, the case of the string captured in 'open' will be detected an applied also to 'closeComplete'.
+// 						// This is useful for cases like BEGIN/END or begin/end where the opening and closing phrases are unrelated.
+// 						// For identical phrases, use the $1 replacement syntax above directly in closeComplete, as it will
+// 						// include the proper casing from the captured string in 'open'.
+// 						// Upper/Lower/Camel cases are detected. Camel case dection uses only the first two characters and assumes
+// 						// that 'closeComplete' contains wors separated by spaces (e.g. 'End Loop')
 
-	closeTrigger?: string; // The character that will trigger the evaluation of 'close'.
-	close?: RegExp; // The definition of when a closing brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
-	tokenType?: string; // The type of the token. Matches from 'open' or 'close' will be expanded, e.g. 'keyword.$1'.
-						// Only used to auto-(un)indent a closing bracket.
-}
+// 	// closeTrigger?: string; // The character that will trigger the evaluation of 'close'.
+// 	close?: RegExp; // The definition of when a closing brace is detected. This regex is matched against the entire line upto, and including the last typed character (the trigger character).
+// 	tokenType?: string; // The type of the token. Matches from 'open' or 'close' will be expanded, e.g. 'keyword.$1'.
+// 						// Only used to auto-(un)indent a closing bracket.
+// }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/standalone-languages/xml.ts
code:
@@ -22,14 +22,14 @@ export var language = <ILanguage> {
 	// Useful regular expressions
 	qualifiedName: /(?:[\w\.\-]+:)?[\w\.\-]+/,
 
-	enhancedBrackets: [{
-		tokenType: 'tag.tag-$1.xml',
-		openTrigger: '>',
-		open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
-		closeComplete: '</$1>',
-		closeTrigger: '>',
-		close: /<\/(\w[\w\d]*)\s*>$/i
-	}],
+	// enhancedBrackets: [{
+	// 	tokenType: 'tag.tag-$1.xml',
+	// 	openTrigger: '>',
+	// 	open: /<(\w[\w\d]*)([^\/>]*(?!\/)>)[^<>]*$/i,
+	// 	closeComplete: '</$1>',
+	// 	closeTrigger: '>',
+	// 	close: /<\/(\w[\w\d]*)\s*>$/i
+	// }],
 
 	autoClosingPairs:  [['\'', '\''], ['"', '"'] ],
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/commands/shiftCommand.test.ts
code:
@@ -13,6 +13,7 @@ import {Selection} from 'vs/editor/common/core/selection';
 import {Cursor} from 'vs/editor/common/controller/cursor';
 import * as Modes from 'vs/editor/common/modes';
 import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 
 function testShiftCommand(lines: string[], selection: Selection, expectedLines: string[], expectedSelection: Selection): void {
 	TU.testCommand(lines, null, selection, (sel) => new ShiftCommand(sel, {
@@ -32,16 +33,17 @@ function testUnshiftCommand(lines: string[], selection: Selection, expectedLines
 
 class DocBlockCommentMode implements Modes.IMode {
 
-	public onEnterSupport: Modes.IOnEnterSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	constructor() {
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
+		this.richEditSupport = new RichEditSupport(this.getId(), {
 			brackets: [
-				{ open: '(', close: ')' },
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' }
+				['(', ')'],
+				['{', '}'],
+				['[', ']']
 			],
-			regExpRules: [
+
+			onEnterRules: [
 				{
 					// e.g. /** | */
 					beforeText: /^\s*\/\*\*(?!\/)([^\*]|\*(?!\/))*$/,

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/controller/cursor.test.ts
code:
@@ -15,7 +15,7 @@ import {Handler, EventType, IPosition, ISelection, EndOfLinePreference} from 'vs
 import {MockConfiguration} from 'vs/editor/test/common/mocks/mockConfiguration';
 import {EditOperation} from 'vs/editor/common/core/editOperation';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
-import {CharacterPairSupport} from 'vs/editor/common/modes/supports';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 
 let H = Handler;
 
@@ -768,28 +768,30 @@ class TestMode {
 }
 
 class SurroundingMode extends TestMode {
-	public characterPairSupport: Modes.ICharacterPairSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	constructor() {
 		super();
-		this.characterPairSupport = new CharacterPairSupport(this, {
-			autoClosingPairs: [{ open: '(', close: ')' }]
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			__characterPairSupport: {
+				autoClosingPairs: [{ open: '(', close: ')' }]
+			}
 		});
 	}
 }
 
 class OnEnterMode extends TestMode {
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	constructor(indentAction: Modes.IndentAction) {
 		super();
-		this.electricCharacterSupport = {
-			getElectricCharacters: ():string[] => null,
-			onElectricCharacter: (context:Modes.ILineContext, offset:number): Modes.IElectricAction => null,
-			onEnter: (context:Modes.ILineContext, offset:number): Modes.IEnterAction => {
-				return {
-					indentAction: indentAction
-				};
+		this.richEditSupport = {
+			onEnter: {
+				onEnter: (model, position) => {
+					return {
+						indentAction: indentAction
+					};
+				}
 			}
 		};
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/model/model.brackets.test.ts
code:
@@ -0,0 +1,131 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import assert = require('assert');
+import {TextModel} from 'vs/editor/common/model/textModel';
+import {TextModelWithTokens} from 'vs/editor/common/model/textModelWithTokens';
+import {IFoundBracket} from 'vs/editor/common/editorCommon';
+import {Position} from 'vs/editor/common/core/position';
+import {Range} from 'vs/editor/common/core/range';
+
+suite('TextModelWithTokens', () => {
+
+	function toRelaxedFoundBracket(a:IFoundBracket) {
+		if (!a) {
+			return null;
+		}
+		return {
+			range: a.range.toString(),
+			open: a.open,
+			close: a.close,
+			isOpen: a.isOpen
+		};
+	}
+
+	function testBrackets(contents: string[], brackets:string[][]): void {
+		let charIsBracket: {[char:string]:boolean} = {};
+		let charIsOpenBracket: {[char:string]:boolean} = {};
+		let openForChar: {[char:string]:string} = {};
+		let closeForChar: {[char:string]:string} = {};
+		brackets.forEach((b) => {
+			charIsBracket[b[0]] = true;
+			charIsBracket[b[1]] = true;
+
+			charIsOpenBracket[b[0]] = true;
+			charIsOpenBracket[b[1]] = false;
+
+			openForChar[b[0]] = b[0];
+			closeForChar[b[0]] = b[1];
+
+			openForChar[b[1]] = b[0];
+			closeForChar[b[1]] = b[1];
+		});
+
+		let expectedBrackets:IFoundBracket[] = [];
+		for (let lineIndex = 0; lineIndex < contents.length; lineIndex++) {
+			let lineText = contents[lineIndex];
+
+			for (let charIndex = 0; charIndex < lineText.length; charIndex++) {
+				let ch = lineText.charAt(charIndex);
+				if (charIsBracket[ch]) {
+					expectedBrackets.push({
+						open: openForChar[ch],
+						close: closeForChar[ch],
+						isOpen: charIsOpenBracket[ch],
+						range: new Range(lineIndex + 1, charIndex + 1, lineIndex + 1, charIndex + 2)
+					});
+				}
+			}
+		}
+
+		let model = new TextModelWithTokens([], TextModel.toRawText(contents.join('\n')), false, null);
+
+		// findPrevBracket
+		{
+			let expectedBracketIndex = expectedBrackets.length - 1;
+			let currentExpectedBracket = expectedBracketIndex >= 0 ? expectedBrackets[expectedBracketIndex] : null;
+			for (let lineNumber = contents.length; lineNumber >= 1; lineNumber--) {
+				let lineText = contents[lineNumber - 1];
+
+				for (let column = lineText.length + 1; column >= 1; column--) {
+
+					if (currentExpectedBracket) {
+						if (lineNumber === currentExpectedBracket.range.startLineNumber && column < currentExpectedBracket.range.endColumn) {
+							expectedBracketIndex--;
+							currentExpectedBracket = expectedBracketIndex >= 0 ? expectedBrackets[expectedBracketIndex] : null;
+						}
+					}
+
+					let actual = model.findPrevBracket({
+						lineNumber: lineNumber,
+						column: column
+					});
+
+					assert.deepEqual(toRelaxedFoundBracket(actual), toRelaxedFoundBracket(currentExpectedBracket), 'findPrevBracket of ' + lineNumber + ', ' + column);
+				}
+			}
+		}
+
+		// findNextBracket
+		{
+			let expectedBracketIndex = 0;
+			let currentExpectedBracket = expectedBracketIndex < expectedBrackets.length ? expectedBrackets[expectedBracketIndex] : null;
+			for (let lineNumber = 1; lineNumber <= contents.length; lineNumber++) {
+				let lineText = contents[lineNumber - 1];
+
+				for (let column = 1; column <= lineText.length + 1; column++) {
+
+					if (currentExpectedBracket) {
+						if (lineNumber === currentExpectedBracket.range.startLineNumber && column > currentExpectedBracket.range.startColumn) {
+							expectedBracketIndex++;
+							currentExpectedBracket = expectedBracketIndex < expectedBrackets.length ? expectedBrackets[expectedBracketIndex] : null;
+						}
+					}
+
+					let actual = model.findNextBracket({
+						lineNumber: lineNumber,
+						column: column
+					});
+
+					assert.deepEqual(toRelaxedFoundBracket(actual), toRelaxedFoundBracket(currentExpectedBracket), 'findNextBracket of ' + lineNumber + ', ' + column);
+				}
+			}
+		}
+
+		model.dispose();
+	}
+
+	test('brackets', () => {
+		testBrackets([
+			'if (a == 3) { return (7 * (a + 5)); }'
+		], [
+			['{', '}'],
+			['[', ']'],
+			['(', ')']
+		])
+	});
+
+});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/model/model.line.test.ts
code:
@@ -248,26 +248,25 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 	test('insertion on empty line', () => {
 		var line = new ModelLine.ModelLine(1, 'some text');
 		var map = new TextModelWithTokens.TokensInflatorMap();
-		line.setTokens(map, [{startIndex: 0, type:'bar', bracket:0}], null, []);
+		line.setTokens(map, [{startIndex: 0, type:'bar'}], null, []);
 
 		line.applyEdits({}, [{startColumn:1, endColumn:10, text:'', forceMoveMarkers: false}]);
 		line.setTokens(map, [], null, []);
 
 		line.applyEdits({}, [{startColumn:1, endColumn:1, text:'a', forceMoveMarkers: false}]);
 		assertLineTokens(line.getTokens(), [{
 			startIndex: 0,
-			type:'',
-			bracket:0
+			type:''
 		}]);
 	})
 
 	test('updates tokens on insertion 1', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -277,9 +276,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'aabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 5, type: '2', bracket: 1 },
-				{ startIndex: 6, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 5, type: '2' },
+				{ startIndex: 6, type: '3' }
 			]
 		);
 	});
@@ -288,9 +287,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'aabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 5, type: '2', bracket: 1 },
-				{ startIndex: 6, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 5, type: '2' },
+				{ startIndex: 6, type: '3' }
 			],
 			[{
 				startColumn: 2,
@@ -300,9 +299,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'axabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 6, type: '2', bracket: 1 },
-				{ startIndex: 7, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 6, type: '2' },
+				{ startIndex: 7, type: '3' }
 			]
 		);
 	});
@@ -311,9 +310,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'axabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 6, type: '2', bracket: 1 },
-				{ startIndex: 7, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 6, type: '2' },
+				{ startIndex: 7, type: '3' }
 			],
 			[{
 				startColumn: 3,
@@ -323,9 +322,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'axstuabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 9, type: '2', bracket: 1 },
-				{ startIndex: 10, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 9, type: '2' },
+				{ startIndex: 10, type: '3' }
 			]
 		);
 	});
@@ -334,9 +333,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'axstuabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 9, type: '2', bracket: 1 },
-				{ startIndex: 10, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 9, type: '2' },
+				{ startIndex: 10, type: '3' }
 			],
 			[{
 				startColumn: 10,
@@ -346,9 +345,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'axstuabcd\t efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 11, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 11, type: '3' }
 			]
 		);
 	});
@@ -357,9 +356,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'axstuabcd\t efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 11, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 11, type: '3' }
 			],
 			[{
 				startColumn: 12,
@@ -369,9 +368,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'axstuabcd\t ddefgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 13, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 13, type: '3' }
 			]
 		);
 	});
@@ -380,9 +379,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'axstuabcd\t ddefgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 13, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 13, type: '3' }
 			],
 			[{
 				startColumn: 18,
@@ -392,9 +391,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'axstuabcd\t ddefghxyz',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 13, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 13, type: '3' }
 			]
 		);
 	});
@@ -403,9 +402,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'axstuabcd\t ddefghxyz',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 10, type: '2', bracket: 1 },
-				{ startIndex: 13, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 10, type: '2' },
+				{ startIndex: 13, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -415,9 +414,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'xaxstuabcd\t ddefghxyz',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 11, type: '2', bracket: 1 },
-				{ startIndex: 14, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 11, type: '2' },
+				{ startIndex: 14, type: '3' }
 			]
 		);
 	});
@@ -426,9 +425,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'xaxstuabcd\t ddefghxyz',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 11, type: '2', bracket: 1 },
-				{ startIndex: 14, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 11, type: '2' },
+				{ startIndex: 14, type: '3' }
 			],
 			[{
 				startColumn: 22,
@@ -438,9 +437,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'xaxstuabcd\t ddefghxyzx',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 11, type: '2', bracket: 1 },
-				{ startIndex: 14, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 11, type: '2' },
+				{ startIndex: 14, type: '3' }
 			]
 		);
 	});
@@ -449,9 +448,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'xaxstuabcd\t ddefghxyzx',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 11, type: '2', bracket: 1 },
-				{ startIndex: 14, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 11, type: '2' },
+				{ startIndex: 14, type: '3' }
 			],
 			[{
 				startColumn: 2,
@@ -461,9 +460,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'xaxstuabcd\t ddefghxyzx',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 11, type: '2', bracket: 1 },
-				{ startIndex: 14, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 11, type: '2' },
+				{ startIndex: 14, type: '3' }
 			]
 		);
 	});
@@ -480,7 +479,7 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'a',
 			[
-				{ startIndex: 0, type: '', bracket: 0 }
+				{ startIndex: 0, type: '' }
 			]
 		);
 	});
@@ -489,9 +488,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcdefghij',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 3, type: '2', bracket: 1 },
-				{ startIndex: 6, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 3, type: '2' },
+				{ startIndex: 6, type: '3' }
 			],
 			[{
 				startColumn: 4,
@@ -501,8 +500,8 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcghij',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 3, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 3, type: '3' }
 			]
 		);
 	});
@@ -511,9 +510,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcdefghij',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 3, type: '2', bracket: 1 },
-				{ startIndex: 6, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 3, type: '2' },
+				{ startIndex: 6, type: '3' }
 			],
 			[{
 				startColumn: 4,
@@ -523,9 +522,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abchellodefghij',
 			[
-				{ startIndex:  0, type: '1', bracket: 0 },
-				{ startIndex:  8, type: '2', bracket: 1 },
-				{ startIndex: 11, type: '3', bracket: -1 }
+				{ startIndex:  0, type: '1' },
+				{ startIndex:  8, type: '2' },
+				{ startIndex: 11, type: '3' }
 			]
 		);
 	});
@@ -534,9 +533,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -546,9 +545,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'bcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 3, type: '2', bracket: 1 },
-				{ startIndex: 4, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 3, type: '2' },
+				{ startIndex: 4, type: '3' }
 			]
 		);
 	});
@@ -557,9 +556,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 2,
@@ -569,9 +568,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'ad efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 2, type: '2', bracket: 1 },
-				{ startIndex: 3, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 2, type: '2' },
+				{ startIndex: 3, type: '3' }
 			]
 		);
 	});
@@ -580,9 +579,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -592,8 +591,8 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			' efgh',
 			[
-				{ startIndex: 0, type: '2', bracket: 1 },
-				{ startIndex: 1, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '2' },
+				{ startIndex: 1, type: '3' }
 			]
 		);
 	});
@@ -602,9 +601,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 5,
@@ -614,8 +613,8 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcdefgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '3' }
 			]
 		);
 	});
@@ -624,9 +623,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 5,
@@ -636,8 +635,8 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcdfgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '3' }
 			]
 		);
 	});
@@ -646,9 +645,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 5,
@@ -658,7 +657,7 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcd',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 }
+				{ startIndex: 0, type: '1' }
 			]
 		);
 	});
@@ -667,9 +666,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -686,9 +685,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -698,9 +697,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});
@@ -709,9 +708,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 1,
@@ -721,9 +720,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'cd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 2, type: '2', bracket: 1 },
-				{ startIndex: 3, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 2, type: '2' },
+				{ startIndex: 3, type: '3' }
 			]
 		);
 	});
@@ -732,9 +731,9 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			[{
 				startColumn: 5,
@@ -744,7 +743,7 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'abcd',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 }
+				{ startIndex: 0, type: '1' }
 			]
 		);
 	});
@@ -753,11 +752,11 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'Hello world, ciao',
 			[
-				{ startIndex: 0, type: 'hello', bracket: 0 },
-				{ startIndex: 5, type: '', bracket: 0 },
-				{ startIndex: 6, type: 'world', bracket: 0 },
-				{ startIndex: 11, type: '', bracket: 0 },
-				{ startIndex: 13, type: '', bracket: 0 },
+				{ startIndex: 0, type: 'hello' },
+				{ startIndex: 5, type: '' },
+				{ startIndex: 6, type: 'world' },
+				{ startIndex: 11, type: '' },
+				{ startIndex: 13, type: '' },
 			],
 			[{
 				startColumn: 1,
@@ -767,11 +766,11 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'Hi world, ciao',
 			[
-				{ startIndex: 0, type: 'hello', bracket: 0 },
-				{ startIndex: 2, type: '', bracket: 0 },
-				{ startIndex: 3, type: 'world', bracket: 0 },
-				{ startIndex: 8, type: '', bracket: 0 },
-				{ startIndex: 10, type: '', bracket: 0 },
+				{ startIndex: 0, type: 'hello' },
+				{ startIndex: 2, type: '' },
+				{ startIndex: 3, type: 'world' },
+				{ startIndex: 8, type: '' },
+				{ startIndex: 10, type: '' },
 			]
 		);
 	});
@@ -780,11 +779,11 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 		testLineEditTokens(
 			'Hello world, ciao',
 			[
-				{ startIndex: 0, type: 'hello', bracket: 0 },
-				{ startIndex: 5, type: '', bracket: 0 },
-				{ startIndex: 6, type: 'world', bracket: 0 },
-				{ startIndex: 11, type: '', bracket: 0 },
-				{ startIndex: 13, type: '', bracket: 0 },
+				{ startIndex: 0, type: 'hello' },
+				{ startIndex: 5, type: '' },
+				{ startIndex: 6, type: 'world' },
+				{ startIndex: 11, type: '' },
+				{ startIndex: 13, type: '' },
 			],
 			[{
 				startColumn: 1,
@@ -799,11 +798,11 @@ suite('Editor Model - ModelLine.applyEdits text & tokens', () => {
 			}],
 			'Hi wmy friends, ciao',
 			[
-				{ startIndex: 0, type: 'hello', bracket: 0 },
-				{ startIndex: 2, type: '', bracket: 0 },
-				{ startIndex: 3, type: 'world', bracket: 0 },
-				{ startIndex: 14, type: '', bracket: 0 },
-				{ startIndex: 16, type: '', bracket: 0 },
+				{ startIndex: 0, type: 'hello' },
+				{ startIndex: 2, type: '' },
+				{ startIndex: 3, type: 'world' },
+				{ startIndex: 14, type: '' },
+				{ startIndex: 16, type: '' },
 			]
 		);
 	});
@@ -825,9 +824,9 @@ suite('Editor Model - ModelLine.split text & tokens', () => {
 		testLineSplitTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			1,
 			'',
@@ -840,17 +839,17 @@ suite('Editor Model - ModelLine.split text & tokens', () => {
 		testLineSplitTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			10,
 			'abcd efgh',
 			'',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});
@@ -859,15 +858,15 @@ suite('Editor Model - ModelLine.split text & tokens', () => {
 		testLineSplitTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			5,
 			'abcd',
 			' efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 }
+				{ startIndex: 0, type: '1' }
 			]
 		);
 	});
@@ -876,16 +875,16 @@ suite('Editor Model - ModelLine.split text & tokens', () => {
 		testLineSplitTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			6,
 			'abcd ',
 			'efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' }
 			]
 		);
 	});
@@ -911,17 +910,17 @@ suite('Editor Model - ModelLine.append text & tokens', () => {
 		testLineAppendTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			'',
 			[],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});
@@ -932,15 +931,15 @@ suite('Editor Model - ModelLine.append text & tokens', () => {
 			[],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});
@@ -949,24 +948,24 @@ suite('Editor Model - ModelLine.append text & tokens', () => {
 		testLineAppendTokens(
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '4', bracket: 0 },
-				{ startIndex: 4, type: '5', bracket: 1 },
-				{ startIndex: 5, type: '6', bracket: -1 }
+				{ startIndex: 0, type: '4' },
+				{ startIndex: 4, type: '5' },
+				{ startIndex: 5, type: '6' }
 			],
 			'abcd efghabcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 },
-				{ startIndex: 9, type: '4', bracket: 0 },
-				{ startIndex: 13, type: '5', bracket: 1 },
-				{ startIndex: 14, type: '6', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' },
+				{ startIndex: 9, type: '4' },
+				{ startIndex: 13, type: '5' },
+				{ startIndex: 14, type: '6' }
 			]
 		);
 	});
@@ -975,18 +974,18 @@ suite('Editor Model - ModelLine.append text & tokens', () => {
 		testLineAppendTokens(
 			'abcd ',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' }
 			],
 			'efgh',
 			[
-				{ startIndex: 0, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '3' }
 			],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});
@@ -995,18 +994,18 @@ suite('Editor Model - ModelLine.append text & tokens', () => {
 		testLineAppendTokens(
 			'abcd',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
+				{ startIndex: 0, type: '1' },
 			],
 			' efgh',
 			[
-				{ startIndex: 0, type: '2', bracket: 1 },
-				{ startIndex: 1, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '2' },
+				{ startIndex: 1, type: '3' }
 			],
 			'abcd efgh',
 			[
-				{ startIndex: 0, type: '1', bracket: 0 },
-				{ startIndex: 4, type: '2', bracket: 1 },
-				{ startIndex: 5, type: '3', bracket: -1 }
+				{ startIndex: 0, type: '1' },
+				{ startIndex: 4, type: '2' },
+				{ startIndex: 5, type: '3' }
 			]
 		);
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/model/model.test.ts
code:
@@ -16,8 +16,8 @@ import {EditOperation} from 'vs/editor/common/core/editOperation';
 
 function isNotABracket(model, lineNumber, column) {
 	var match = model.matchBracket(new Position(lineNumber, column));
-	assert.equal(match.isAccurate, true);
-	assert.equal(match.brackets, null);
+	assert.equal(match.isAccurate, true, 'is not matching brackets at ' + lineNumber + ', ' + column);
+	assert.equal(match.brackets, null, 'is not matching brackets at ' + lineNumber + ', ' + column);
 }
 
 function isBracket(model, lineNumber1, column11, column12, lineNumber2, column21, column22) {
@@ -28,7 +28,7 @@ function isBracket(model, lineNumber1, column11, column12, lineNumber2, column21
 			new Range(lineNumber2, column21, lineNumber2, column22)
 		],
 		isAccurate: true
-	});
+	}, 'is matching brackets at ' + lineNumber1 + ', ' + column11);
 }
 
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modes/autoIndentation.test.ts
code:
@@ -5,98 +5,13 @@
 'use strict';
 
 import assert = require('assert');
-import autoIndentation = require('vs/editor/common/modes/autoIndentation');
+import autoIndentation = require('vs/editor/common/modes/supports/electricCharacter');
 import modes = require('vs/editor/common/modes');
 import modesUtil = require('vs/editor/test/common/modesTestUtils');
 
 suite('Editor Modes - Auto Indentation', () => {
-
-	test('Bracket Pairs', () => {
-		var brackets = new autoIndentation.Brackets([
-			{ tokenType:'b', open: '{', close: '}', isElectric: false },
-			{ tokenType:'a', open: '[', close: ']', isElectric: true },
-			{ tokenType:'p', open: '(', close: ')', isElectric: false }
-		]);
-
-		assert.equal(brackets.stringIsBracket(''), false);
-		assert.equal(brackets.stringIsBracket('<'), false);
-		assert.equal(brackets.stringIsBracket('{'), true);
-		assert.equal(brackets.stringIsBracket('}'), true);
-		assert.equal(brackets.stringIsBracket('['), true);
-		assert.equal(brackets.stringIsBracket(']'), true);
-		assert.equal(brackets.stringIsBracket('('), true);
-		assert.equal(brackets.stringIsBracket(')'), true);
-	});
-
-	test('Case insensitive regular expressions', () => {
-		var brackets = new autoIndentation.Brackets([],
-		[
-			{	tokenType: 'tag-$1',
-				openTrigger: '>',
-				open: /<(\w[\w\d]*)(\s+.*[^\/]>|\s*>)[^<]*$/i,
-				closeComplete: '</$1>',
-				closeTrigger: '>',
-				close: /<\/(\w[\w\d]*)\s*>$/i }
-		], null, true);
-
-		assert.equal(brackets.onEnter(modesUtil.createLineContextFromTokenText([
-			{ text: '', type: '' }
-		]), 0), null);
-		assert.equal(brackets.onEnter(modesUtil.createLineContextFromTokenText([
-			{ text: '<', type: 'delim' },
-			{ text: 'tag', type: 'tag', bracket: modes.Bracket.Open },
-			{ text: '>', type: 'delim' },
-		]), 5).indentAction, modes.IndentAction.Indent);
-		assert.equal(brackets.onEnter(modesUtil.createLineContextFromTokenText([
-			{ text: '<', type: 'delim' },
-			{ text: 'tag', type: 'tag', bracket: modes.Bracket.Open },
-			{ text: '>', type: 'delim' },
-			{ text: '</', type: 'delim' },
-			{ text: 'TAg', type: 'tag', bracket: modes.Bracket.Close},
-			{ text: '>', type: 'delim' },
-		]), 5).indentAction, modes.IndentAction.IndentOutdent);
-
-		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([
-			{ text: '<', type: 'delim' },
-			{ text: 'tag', type: 'tag', bracket: modes.Bracket.Open },
-			{ text: '>', type: 'delim' }
-		]), 4).appendText, '</tag>');
-
-		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([
-			{ text: '</', type: 'delim' },
-			{ text: 'TAg', type: 'tag', bracket: modes.Bracket.Close},
-			{ text: '>', type: 'delim' },
-		]), 5).matchBracketType, 'tag-tag');
-	});
-
-
-	test('Case insensitive regular expressions and case matching auto completion', () => {
-		var brackets = new autoIndentation.Brackets([],
-		[
-			{	tokenType: 'sub',
-				openTrigger: 'b',
-				open: /^(|.*\s)sub/i,
-				closeComplete: ' end sub',
-				matchCase: true
-			}
-		], null, true);
-
-		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([
-			{ text: 'sub', type: '' }
-		]), 2).appendText, ' end sub');
-
-		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([
-			{ text: 'Sub', type: '' }
-		]), 2).appendText, ' End Sub');
-
-		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([
-			{ text: 'SUB', type: '' }
-		]), 2).appendText, ' END SUB');
-	});
-
-
 	test('Doc comments', () => {
-		var brackets = new autoIndentation.Brackets([], [],
+		var brackets = new autoIndentation.Brackets('test', [],
 			{ scope: 'doc', open: '/**', lineStart: ' * ', close: ' */' });
 
 		assert.equal(brackets.onElectricCharacter(modesUtil.createLineContextFromTokenText([

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modes/modesRegistry.test.ts
code:
@@ -12,11 +12,12 @@ import Platform = require('vs/platform/platform');
 import ModesExtensions = require('vs/editor/common/modes/modesRegistry');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
+import {createMockModeService} from 'vs/editor/test/common/servicesTestUtils';
 
 suite('Editor Modes - Modes Registry', () => {
 	test('Bug 12104: [f12] createModel not successfully handling mime type list?', () => {
-		var modesRegistry = <ModesExtensions.IEditorModesRegistry>Platform.Registry.as(ModesExtensions.Extensions.EditorModes);
-		assert.equal(modesRegistry.getModeId('text/html,text/plain'), 'html');
+		let modeService = createMockModeService();
+		assert.equal(modeService.getModeId('text/html,text/plain'), 'html');
 	});
 });
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modes/textToHtmlTokenizer.test.ts
code:
@@ -9,6 +9,7 @@ import {tokenizeToHtmlContent} from 'vs/editor/common/modes/textToHtmlTokenizer'
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import modes = require('vs/editor/common/modes');
 import supports = require('vs/editor/common/modes/supports');
+import {TokenizationSupport} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 suite('Editor Modes - textToHtmlTokenizer', () => {
 	test('TextToHtmlTokenizer', () => {
@@ -76,7 +77,7 @@ class Mode implements modes.IMode {
 	public tokenizationSupport: modes.ITokenizationSupport;
 
 	constructor() {
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new State(this)
 		}, false, false);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modes/tokenization.test.ts
code:
@@ -15,6 +15,7 @@ import {tokenizeToHtmlContent} from 'vs/editor/common/modes/textToHtmlTokenizer'
 import {createLineContext} from 'vs/editor/test/common/modesTestUtils';
 import EditorCommon = require('vs/editor/common/editorCommon');
 import {IDisposable, empty as EmptyDisposable} from 'vs/base/common/lifecycle';
+import {TokenizationSupport, IEnteringNestedModeData, ILeavingNestedModeData} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 export class State extends AbstractState {
 
@@ -36,7 +37,7 @@ export class Mode implements modes.IMode {
 	public tokenizationSupport: modes.ITokenizationSupport;
 
 	constructor() {
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new State(this)
 		}, false, false);
 	}
@@ -111,7 +112,7 @@ export class SwitchingMode implements modes.IMode {
 	constructor(id:string, descriptor:IModeSwitchingDescriptor) {
 		this._id = id;
 		this._switchingModeDescriptor = descriptor;
-		this.tokenizationSupport = new supports.TokenizationSupport(this, this, true, false);
+		this.tokenizationSupport = new TokenizationSupport(this, this, true, false);
 	}
 
 	public getId():string {
@@ -144,15 +145,15 @@ export class SwitchingMode implements modes.IMode {
 		}
 	}
 
-	public getNestedMode(state:modes.IState): supports.IEnteringNestedModeData {
+	public getNestedMode(state:modes.IState): IEnteringNestedModeData {
 		var s = <StateMemorizingLastWord>state;
 		return {
 			mode: this._switchingModeDescriptor[s.lastWord].mode,
 			missingModePromise: null
 		};
 	}
 
-	public getLeavingNestedModeData(line:string, state:modes.IState):supports.ILeavingNestedModeData {
+	public getLeavingNestedModeData(line:string, state:modes.IState): ILeavingNestedModeData {
 		var s = <StateMemorizingLastWord>state;
 		var endChar = this._switchingModeDescriptor[s.lastWord].endCharacter;
 		var endCharPosition = line.indexOf(endChar);
@@ -177,7 +178,6 @@ function assertTokens(actual:modes.IToken[], expected:ITestToken[], message?:str
 	for (var i = 0; i < expected.length; i++) {
 		assert.equal(actual[i].startIndex, expected[i].startIndex, 'startIndex mismatch');
 		assert.equal(actual[i].type, expected[i].type, 'type mismatch');
-		assert.equal(actual[i].bracket, expected[i].bracket ? expected[i].bracket : modes.Bracket.None, 'bracket mismatch');
 	}
 };
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modesTestUtils.ts
code:
@@ -4,69 +4,67 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import modes = require('vs/editor/common/modes');
+import Modes = require('vs/editor/common/modes');
 import {Arrays} from 'vs/editor/common/core/arrays';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 
-class SimpleTokenTypeClassificationMode implements modes.IMode {
+class SimpleTokenTypeClassificationMode implements Modes.IMode {
 
 	private _id:string;
-	public tokenTypeClassificationSupport: modes.ITokenTypeClassificationSupport;
 
-	constructor(id:string, tokenTypeClassificationSupport: modes.ITokenTypeClassificationSupport) {
+	public richEditSupport: Modes.IRichEditSupport;
+
+	constructor(id:string, wordRegExp:RegExp) {
 		this._id = id;
-		this.tokenTypeClassificationSupport = tokenTypeClassificationSupport;
+		this.richEditSupport = new RichEditSupport(this._id, {
+			wordPattern: wordRegExp
+		});
 	}
 
 	public getId(): string {
 		return this._id;
 	}
 
-	public toSimplifiedMode(): modes.IMode {
+	public toSimplifiedMode(): Modes.IMode {
 		return this;
 	}
 }
 
-export function createMockMode(id:string, wordRegExp:RegExp = null):modes.IMode {
-	var tokenTypeClassificationSupport: modes.ITokenTypeClassificationSupport;
-	if (wordRegExp) {
-		tokenTypeClassificationSupport = {
-			getWordDefinition: () => wordRegExp
-		};
-	}
-	return new SimpleTokenTypeClassificationMode(id, tokenTypeClassificationSupport);
+export function createMockMode(id:string, wordRegExp:RegExp = null):Modes.IMode {
+	return new SimpleTokenTypeClassificationMode(id, wordRegExp);
 }
 
 export interface TokenText {
 	text: string;
 	type: string;
-	bracket?: modes.Bracket;
+	bracket?: Modes.Bracket;
 }
 
-export function createLineContextFromTokenText(tokens: TokenText[]): modes.ILineContext {
+export function createLineContextFromTokenText(tokens: TokenText[]): Modes.ILineContext {
 	var line = '';
-	var processedTokens: modes.IToken[] = [];
+	var processedTokens: Modes.IToken[] = [];
 
 	var indexSoFar = 0;
 	for (var i = 0; i < tokens.length; ++i){
-		processedTokens.push({ startIndex: indexSoFar, type: tokens[i].type, bracket: (tokens[i].bracket ? tokens[i].bracket : modes.Bracket.None) });
+		processedTokens.push({ startIndex: indexSoFar, type: tokens[i].type });
 		line += tokens[i].text;
 		indexSoFar += tokens[i].text.length;
 	}
 
 	return new TestLineContext(line, processedTokens, null);
 }
 
-export function createLineContext(line:string, tokens:modes.ILineTokens): modes.ILineContext {
+export function createLineContext(line:string, tokens:Modes.ILineTokens): Modes.ILineContext {
 	return new TestLineContext(line, tokens.tokens, tokens.modeTransitions);
 }
 
-class TestLineContext implements modes.ILineContext {
+class TestLineContext implements Modes.ILineContext {
 
-	public modeTransitions: modes.IModeTransition[];
+	public modeTransitions: Modes.IModeTransition[];
 	private _line:string;
-	private _tokens: modes.IToken[];
+	private _tokens: Modes.IToken[];
 
-	constructor(line:string, tokens: modes.IToken[], modeTransitions:modes.IModeTransition[]) {
+	constructor(line:string, tokens: Modes.IToken[], modeTransitions:Modes.IModeTransition[]) {
 		this.modeTransitions = modeTransitions;
 		this._line = line;
 		this._tokens = tokens;
@@ -95,10 +93,6 @@ class TestLineContext implements modes.ILineContext {
 		return this._tokens[tokenIndex].type;
 	}
 
-	public getTokenBracket(tokenIndex:number): modes.Bracket {
-		return this._tokens[tokenIndex].bracket;
-	}
-
 	public findIndexOfOffset(offset:number): number {
 		return Arrays.findIndexInSegmentsArray(this._tokens, offset);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/modesUtil.ts
code:
@@ -11,7 +11,6 @@ import modes = require('vs/editor/common/modes');
 import monarchTypes = require('vs/editor/common/modes/monarch/monarchTypes');
 import monarchCompile = require('vs/editor/common/modes/monarch/monarchCompile');
 import monarchLexer = require('vs/editor/common/modes/monarch/monarchLexer');
-import {createLineContext} from 'vs/editor/test/common/modesTestUtils';
 import {Model} from 'vs/editor/common/model/model';
 
 export interface IRelaxedToken {
@@ -25,35 +24,10 @@ export interface ITestItem {
 	tokens: IRelaxedToken[];
 }
 
-
-export interface IOnEnterFunc {
-	(line:string, offset:number, state?:modes.IState): modes.IEnterAction;
-}
-
-export interface IOnElectricCharacterFunc {
-	(line:string, offset:number, state?:modes.IState): modes.IElectricAction;
-}
-
-export function createOnElectricCharacter(mode:modes.IMode): IOnElectricCharacterFunc {
-	return function onElectricCharacter(line:string, offset:number, state?:modes.IState): modes.IElectricAction {
-		state = state || mode.tokenizationSupport.getInitialState();
-		var lineTokens = mode.tokenizationSupport.tokenize(line, state);
-		return mode.electricCharacterSupport.onElectricCharacter(createLineContext(line, lineTokens), offset);
-	};
-}
-
 export function assertWords(actual:string[], expected:string[], message?:string): void {
 	assert.deepEqual(actual, expected, message);
 }
 
-export function createOnEnter(mode:modes.IMode): IOnEnterFunc {
-	return function onEnter(line:string, offset:number, state?:modes.IState): modes.IEnterAction {
-		state = state || mode.tokenizationSupport.getInitialState();
-		var lineTokens = mode.tokenizationSupport.tokenize(line, state);
-		return mode.electricCharacterSupport.onEnter(createLineContext(line, lineTokens), offset);
-	};
-}
-
 export function load(modeId: string, preloadModes: string[] = [] ): TPromise<modes.IMode> {
 	var toLoad:string[] = [].concat(preloadModes).concat([modeId]);
 
@@ -72,7 +46,7 @@ export function assertTokenization(tokenizationSupport: modes.ITokenizationSuppo
 		assert.ok(true, tests[i].line);
 		var result = tokenizationSupport.tokenize(tests[i].line, state);
 		if (tests[i].tokens) {
-			assert.deepEqual(generateRelaxedTokens(result.tokens, tests[i].tokens), tests[i].tokens, JSON.stringify(result.tokens, null, '\t'));
+			assert.deepEqual(toRelaxedTokens(result.tokens), toRelaxedTokens(tests[i].tokens), JSON.stringify(result.tokens, null, '\t'));
 		}
 
 		state = result.endState;
@@ -103,13 +77,13 @@ class SimpleMode implements modes.IMode {
 	}
 }
 
-export function createOnEnterAsserter(modeId:string, onEnterSupport: modes.IOnEnterSupport): IOnEnterAsserter {
+export function createOnEnterAsserter(modeId:string, richEditSupport: modes.IRichEditSupport): IOnEnterAsserter {
 	var assertOne = (oneLineAboveText:string, beforeText:string, afterText:string, expected: modes.IndentAction) => {
 		var model = new Model(
 			[ oneLineAboveText, beforeText + afterText ].join('\n'),
 			new SimpleMode(modeId)
 		);
-		var actual = onEnterSupport.onEnter(model, { lineNumber: 2, column: beforeText.length + 1 });
+		var actual = richEditSupport.onEnter.onEnter(model, { lineNumber: 2, column: beforeText.length + 1 });
 		if (expected === modes.IndentAction.None) {
 			assert.equal(actual, null, oneLineAboveText + '\\n' + beforeText + '|' + afterText);
 		} else {
@@ -151,24 +125,13 @@ export function executeMonarchTokenizationTests(name:string, language:monarchTyp
 	executeTests(tokenizationSupport, tests);
 }
 
-function generateRelaxedTokens(actualTokens: modes.IToken[], expectedTokens: IRelaxedToken[]): IRelaxedToken[] {
-	var r = actualTokens.map((token, index) => {
-		// Remove bracket if it's missing in expectedTokens too
-		if (expectedTokens[index] && typeof expectedTokens[index].bracket !== 'undefined') {
-			return {
-				startIndex: token.startIndex,
-				type: token.type,
-				bracket: token.bracket
-			};
-		} else {
-			return {
-				startIndex: token.startIndex,
-				type: token.type
-			};
-		}
+function toRelaxedTokens(tokens: modes.IToken[]): IRelaxedToken[] {
+	return tokens.map((t) => {
+		return {
+			startIndex: t.startIndex,
+			type: t.type
+		};
 	});
-
-	return r;
 }
 
 function executeTest(tokenizationSupport: modes.ITokenizationSupport, tests:ITestItem[]): void {
@@ -187,5 +150,5 @@ function executeTest(tokenizationSupport: modes.ITokenizationSupport, tests:ITes
 }
 
 function assertTokens(actual:modes.IToken[], expected:IRelaxedToken[], message?:string): void {
-	assert.deepEqual(generateRelaxedTokens(actual, expected), expected, message + ': ' + JSON.stringify(actual, null, '\t'));
+	assert.deepEqual(toRelaxedTokens(actual), toRelaxedTokens(expected), message + ': ' + JSON.stringify(actual, null, '\t'));
 }
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/test/common/testModes.ts
code:
@@ -5,10 +5,11 @@
 'use strict';
 
 import modes = require('vs/editor/common/modes');
-import supports = require('vs/editor/common/modes/supports');
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {TokenizationSupport} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 export class CommentState extends AbstractState {
 
@@ -32,21 +33,19 @@ export class CommentState extends AbstractState {
 
 export class CommentMode extends AbstractMode<AbstractModeWorker> {
 
-	private commentsConfig:modes.ICommentsConfiguration;
-
 	public tokenizationSupport: modes.ITokenizationSupport;
+	public richEditSupport: modes.IRichEditSupport;
 
 	constructor(commentsConfig:modes.ICommentsConfiguration) {
 		super({ id: 'tests.commentMode', workerParticipants: [] }, null, null);
-		this.commentsConfig = commentsConfig;
 
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new CommentState(this, 0)
 		}, false, false);
-	}
 
-	public getCommentsConfiguration():modes.ICommentsConfiguration {
-		return this.commentsConfig;
+		this.richEditSupport = {
+			comments:commentsConfig
+		};
 	}
 }
 
@@ -105,7 +104,7 @@ export class ModelMode1 extends TestingMode {
 	constructor() {
 		super();
 		this.calledFor = [];
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new ModelState1(this)
 		}, false, false);
 	}
@@ -146,7 +145,7 @@ export class ModelMode2 extends TestingMode {
 	constructor() {
 		super();
 		this.calledFor = null;
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new ModelState2(this, '')
 		}, false, false);
 	}
@@ -220,12 +219,22 @@ export class BracketState extends AbstractState {
 export class BracketMode extends TestingMode {
 
 	public tokenizationSupport: modes.ITokenizationSupport;
+	public richEditSupport: modes.IRichEditSupport;
 
 	constructor() {
 		super();
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new BracketState(this)
 		}, false, false);
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType: 'asd', open: '{', close: '}', isElectric: true },
+					{ tokenType: 'qwe', open: '[', close: ']', isElectric: true },
+					{ tokenType: 'zxc', open: '(', close: ')', isElectric: true }
+				]
+			}
+		});
 	}
 }
 
@@ -268,7 +277,7 @@ export class NMode extends TestingMode {
 	constructor(n:number) {
 		this.n = n;
 		super();
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new NState(this, this.n)
 		}, false, false);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/css/common/css.ts
code:
@@ -5,7 +5,6 @@
 'use strict';
 
 import WinJS = require('vs/base/common/winjs.base');
-import supports = require('vs/editor/common/modes/supports');
 import objects = require('vs/base/common/objects');
 import URI from 'vs/base/common/uri';
 import EditorCommon = require('vs/editor/common/editorCommon');
@@ -17,9 +16,13 @@ import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import {AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
 import {IMarker} from 'vs/platform/markers/common/markers';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {TokenizationSupport} from 'vs/editor/common/modes/supports/tokenizationSupport';
+import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export enum States {
 	Selector,
@@ -279,8 +282,7 @@ export class State extends AbstractState {
 export class CSSMode extends AbstractMode<cssWorker.CSSWorker> {
 
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	public referenceSupport: Modes.IReferenceSupport;
 	public logicalSelectionSupport: Modes.ILogicalSelectionSupport;
@@ -290,7 +292,6 @@ export class CSSMode extends AbstractMode<cssWorker.CSSWorker> {
 	public declarationSupport: Modes.IDeclarationSupport;
 	public suggestSupport: Modes.ISuggestSupport;
 	public quickFixSupport: Modes.IQuickFixSupport;
-	public onEnterSupport: Modes.IOnEnterSupport;
 
 	constructor(
 		descriptor:Modes.IModeDescriptor,
@@ -299,45 +300,57 @@ export class CSSMode extends AbstractMode<cssWorker.CSSWorker> {
 	) {
 		super(descriptor, instantiationService, threadService);
 
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new State(this, States.Selector, false, null, false, 0)
 		}, false, false);
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this, { brackets: [
-			{ tokenType: 'punctuation.bracket.css', open: '{', close: '}', isElectric: true }
-		] });
+
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			// TODO@Martin: This definition does not work with umlauts for example
+			wordPattern: /(#?-?\d*\.\d\w*%?)|((::|[@#.!:])?[\w-?]+%?)|::|[@#.!:]/g,
+
+			comments: {
+				blockComment: ['/*', '*/']
+			},
+
+			brackets: [
+				['{', '}'],
+				['[', ']'],
+				['(', ')']
+			],
+
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType: 'punctuation.bracket.css', open: '{', close: '}', isElectric: true }
+				]
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: [
+					{ open: '{', close: '}' },
+					{ open: '[', close: ']' },
+					{ open: '(', close: ')' },
+					{ open: '"', close: '"', notIn: ['string'] },
+					{ open: '\'', close: '\'', notIn: ['string'] }
+				]
+			}
+		});
 
 		this.occurrencesSupport = this;
 		this.extraInfoSupport = this;
-		this.referenceSupport = new supports.ReferenceSupport(this, {
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
 			tokens: [cssTokenTypes.TOKEN_PROPERTY + '.css', cssTokenTypes.TOKEN_VALUE + '.css', cssTokenTypes.TOKEN_SELECTOR_TAG + '.css'],
 			findReferences: (resource, position, /*unused*/includeDeclaration) => this.findReferences(resource, position)});
 		this.logicalSelectionSupport = this;
 		this.outlineSupport = this;
-		this.declarationSupport = new supports.DeclarationSupport(this, {
+		this.declarationSupport = new DeclarationSupport(this.getId(), {
 			tokens: [cssTokenTypes.TOKEN_VALUE + '.css'],
 			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
 
-		this.characterPairSupport = new supports.CharacterPairSupport(this, {
-			autoClosingPairs:
-				[	{ open: '{', close: '}' },
-					{ open: '[', close: ']' },
-					{ open: '(', close: ')' },
-					{ open: '"', close: '"', notIn: ['string'] },
-					{ open: '\'', close: '\'', notIn: ['string'] }
-				]});
-
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: [' ', ':'],
 			excludeTokens: ['comment.css', 'string.css'],
 			suggest: (resource, position) => this.suggest(resource, position)});
 
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
-			brackets: [
-				{ open: '(', close: ')' },
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' }
-			]
-		});
 
 		this.quickFixSupport = this;
 	}
@@ -376,15 +389,6 @@ export class CSSMode extends AbstractMode<cssWorker.CSSWorker> {
 		return this._worker((w) => w.getOutline(resource));
 	}
 
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return { blockCommentStartToken: '/*', blockCommentEndToken: '*/' };
-	}
-
-	// TODO@Martin: This definition does not work with umlauts for example
-	public getWordDefinition():RegExp {
-		return /(#?-?\d*\.\d\w*%?)|((::|[@#.!:])?[\w-?]+%?)|::|[@#.!:]/g;
-	}
-
 	static $findColorDeclarations = OneWorkerAttr(CSSMode, CSSMode.prototype.findColorDeclarations);
 	public findColorDeclarations(resource:URI):WinJS.TPromise<{range:EditorCommon.IRange; value:string; }[]> {
 		return this._worker((w) => w.findColorDeclarations(resource));

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/css/common/cssWorker.ts
code:
@@ -22,10 +22,10 @@ import parser = require('vs/languages/css/common/parser/cssParser');
 import selectorPrinting = require('vs/languages/css/common/services/selectorPrinting');
 import lint = require('vs/languages/css/common/services/lint');
 import lintRules = require('vs/languages/css/common/services/lintRules');
-import supports = require('vs/editor/common/modes/supports');
 import {IMarker, IMarkerData} from 'vs/platform/markers/common/markers';
 import {IMarkerService} from 'vs/platform/markers/common/markers';
 import {IResourceService} from 'vs/editor/common/services/resourceService';
+import {WorkerInplaceReplaceSupport} from 'vs/editor/common/modes/supports/inplaceReplaceSupport';
 
 export class CSSWorker extends AbstractModeWorker {
 
@@ -44,7 +44,7 @@ export class CSSWorker extends AbstractModeWorker {
 	}
 
 	protected _createInPlaceReplaceSupport(): Modes.IInplaceReplaceSupport {
-		return new supports.WorkerInplaceReplaceSupport(this.resourceService, this);
+		return new WorkerInplaceReplaceSupport(this.resourceService, this);
 	}
 
 	public createLanguageService(resourceService:IResourceService, modeId:string): languageService.CSSLanguageService {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/css/test/common/css.test.ts
code:
@@ -21,8 +21,8 @@ suite('CSS Colorizing', () => {
 	suiteSetup((done) => {
 		modesUtil.load('css').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
-			wordDefinition = mode.tokenTypeClassificationSupport.getWordDefinition();
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
+			wordDefinition = mode.richEditSupport.wordDefinition;
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/handlebars/common/handlebars.ts
code:
@@ -5,15 +5,15 @@
 'use strict';
 
 import Modes = require('vs/editor/common/modes');
-import supports = require('vs/editor/common/modes/supports');
 import htmlMode = require('vs/languages/html/common/html');
-import winjs = require('vs/base/common/winjs.base');
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import handlebarsTokenTypes = require('vs/languages/handlebars/common/handlebarsTokenTypes');
 import htmlWorker = require('vs/languages/html/common/htmlWorker');
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IModeService} from 'vs/editor/common/services/modeService';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {createWordRegExp} from 'vs/editor/common/modes/abstractMode';
+import {ILeavingNestedModeData} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 export enum States {
 	HTML,
@@ -114,36 +114,59 @@ export class HandlebarsMode extends htmlMode.HTMLMode<htmlWorker.HTMLWorker> {
 	) {
 		super(descriptor, instantiationService, threadService, modeService);
 
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
-			brackets: [
-				{ open: '<!--', close: '-->' },
-				{ open: '{{', close: '}}' },
-			]
-		});
+		this.formattingSupport = null;
 	}
 
-	public asyncCtor(): winjs.Promise {
-		return super.asyncCtor().then(() => {
-			var pairs = this.characterPairSupport.getAutoClosingPairs().slice(0).concat([
-				{ open: '{', close: '}'}
-			]);
+	protected _createRichEditSupport(embeddedAutoClosingPairs: Modes.IAutoClosingPair[]): Modes.IRichEditSupport {
+		return new RichEditSupport(this.getId(), {
+
+			wordPattern: createWordRegExp('#-?%'),
 
-			this.characterPairSupport = new supports.CharacterPairSupport(this, {
-				autoClosingPairs:  pairs.slice(0),
+			comments: {
+				blockComment: ['<!--', '-->']
+			},
+
+			brackets: [
+				['<!--', '-->'],
+				['{{', '}}']
+			],
+
+			__electricCharacterSupport: {
+				brackets: [],
+				caseInsensitive: true,
+				embeddedElectricCharacters: ['*', '}', ']', ')']
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: embeddedAutoClosingPairs.slice(0).concat([
+					{ open: '{', close: '}'}
+				]),
 				surroundingPairs: [
 					{ open: '<', close: '>' },
 					{ open: '"', close: '"' },
 					{ open: '\'', close: '\'' }
 				]
-			});
+			},
+
+			onEnterRules: [
+				{
+					beforeText: new RegExp(`<(?!(?:${htmlMode.EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					afterText: /^<\/(\w[\w\d]*)\s*>$/i,
+					action: { indentAction: Modes.IndentAction.IndentOutdent }
+				},
+				{
+					beforeText: new RegExp(`<(?!(?:${htmlMode.EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					action: { indentAction: Modes.IndentAction.Indent }
+				}
+			],
 		});
 	}
 
 	public getInitialState() : Modes.IState {
 		return new HandlebarsState(this, htmlMode.States.Content, States.HTML, '', '', '', '', '');
 	}
 
-	public getLeavingNestedModeData(line:string, state:Modes.IState):supports.ILeavingNestedModeData {
+	public getLeavingNestedModeData(line:string, state:Modes.IState):ILeavingNestedModeData {
 		var leavingNestedModeData = super.getLeavingNestedModeData(line, state);
 		if (leavingNestedModeData) {
 			leavingNestedModeData.stateAfterNestedMode = new HandlebarsState(this, htmlMode.States.Content, States.HTML, '', '', '', '', '');

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/html/common/html.ts
code:
@@ -5,9 +5,6 @@
 'use strict';
 
 import URI from 'vs/base/common/uri';
-import modesExtensions = require('vs/editor/common/modes/modesRegistry');
-import supports = require('vs/editor/common/modes/supports');
-import Platform = require('vs/platform/platform');
 import { AsyncDescriptor2, createAsyncDescriptor2 } from 'vs/platform/instantiation/common/descriptors';
 import winjs = require('vs/base/common/winjs.base');
 import EditorCommon = require('vs/editor/common/editorCommon');
@@ -17,13 +14,19 @@ import { AbstractMode, createWordRegExp } from 'vs/editor/common/modes/abstractM
 import { AbstractState } from 'vs/editor/common/modes/abstractState';
 import {OneWorkerAttr} from 'vs/platform/thread/common/threadService';
 import {IModeService} from 'vs/editor/common/services/modeService';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService } from 'vs/platform/thread/common/thread';
 import * as htmlTokenTypes from 'vs/languages/html/common/htmlTokenTypes';
 import {EMPTY_ELEMENTS} from 'vs/languages/html/common/htmlEmptyTagsShared';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {TokenizationSupport, IEnteringNestedModeData, ILeavingNestedModeData, ITokenizationCustomization} from 'vs/editor/common/modes/supports/tokenizationSupport';
+// import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {ParameterHintsSupport} from 'vs/editor/common/modes/supports/parameterHintsSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export { htmlTokenTypes }; // export to be used by Razor. We are the main module, so Razor should get ot from use.
+export { EMPTY_ELEMENTS }; // export to be used by Razor. We are the main module, so Razor should get ot from use.
 
 export enum States {
 	Content,
@@ -267,11 +270,10 @@ export class State extends AbstractState {
 	}
 }
 
-export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> implements supports.ITokenizationCustomization {
+export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> implements ITokenizationCustomization {
 
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	public extraInfoSupport:Modes.IExtraInfoSupport;
 	public occurrencesSupport:Modes.IOccurrencesSupport;
@@ -280,7 +282,6 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 	public formattingSupport: Modes.IFormattingSupport;
 	public parameterHintsSupport: Modes.IParameterHintsSupport;
 	public suggestSupport: Modes.ISuggestSupport;
-	public onEnterSupport: Modes.IOnEnterSupport;
 
 	private modeService:IModeService;
 
@@ -294,46 +295,29 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 
 		this.modeService = modeService;
 
-		this.tokenizationSupport = new supports.TokenizationSupport(this, this, true, true);
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this,
-			{
-				brackets: [],
-				regexBrackets:[
-					{	tokenType: htmlTokenTypes.getTag('$1'),
-						open: new RegExp(`<(?!(?:${EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
-						closeComplete: '</$1>',
-						close: /<\/(\w[\w\d]*)\s*>$/i }],
-				caseInsensitive:true,
-				embeddedElectricCharacters: ['*', '}', ']', ')']
-			});
+		this.tokenizationSupport = new TokenizationSupport(this, this, true, true);
 
 		this.formattingSupport = this;
 		this.extraInfoSupport = this;
 		this.occurrencesSupport = this;
-		this.referenceSupport = new supports.ReferenceSupport(this, {
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
 			tokens: ['invalid'],
 			findReferences: (resource, position, includeDeclaration) => this.findReferences(resource, position, includeDeclaration)});
 		this.logicalSelectionSupport = this;
 
-		this.parameterHintsSupport = new supports.ParameterHintsSupport(this, {
+		this.parameterHintsSupport = new ParameterHintsSupport(this.getId(), {
 			triggerCharacters: ['(', ','],
 			excludeTokens: ['*'],
 			getParameterHints: (resource, position) => this.getParameterHints(resource, position)});
 		// TODO@Alex TODO@Joh: there is something off about declaration support of embedded JS in HTML
-		// this.declarationSupport = new supports.DeclarationSupport(this, {
+		// this.declarationSupport = new DeclarationSupport(this, {
 		// 		tokens: ['invalid'],
 		// 		findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: ['.', ':', '<', '"', '=', '/'],
 			excludeTokens: ['comment'],
 			suggest: (resource, position) => this.suggest(resource, position)});
-
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
-			brackets: [
-				{ open: '<!--', close: '-->' }
-			]
-		});
 	}
 
 	public asyncCtor(): winjs.Promise {
@@ -342,13 +326,52 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 			this.modeService.getOrCreateMode('text/css')
 		]).then((embeddableModes) => {
 			var autoClosingPairs = this._getAutoClosingPairs(embeddableModes);
+			this.richEditSupport = this._createRichEditSupport(autoClosingPairs);
+		});
+	}
+
+	protected _createRichEditSupport(embeddedAutoClosingPairs: Modes.IAutoClosingPair[]): Modes.IRichEditSupport {
+		return new RichEditSupport(this.getId(), {
+
+			wordPattern: createWordRegExp('#-?%'),
 
-			this.characterPairSupport = new supports.CharacterPairSupport(this, {
-				autoClosingPairs: autoClosingPairs.slice(0),
+			comments: {
+				blockComment: ['<!--', '-->']
+			},
+
+			brackets: [
+				['<!--', '-->'],
+				['<', '>'],
+			],
+
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType: 'bla', open: '<!--', close: '-->', isElectric: true },
+					{ tokenType: 'bla', open: '<', close: '>', isElectric: true }
+				],
+				caseInsensitive: true,
+				embeddedElectricCharacters: ['*', '}', ']', ')']
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: embeddedAutoClosingPairs.slice(0),
 				surroundingPairs: [
-						{ open: '"', close: '"' },
-						{ open: '\'', close: '\'' }
-					]});
+					{ open: '"', close: '"' },
+					{ open: '\'', close: '\'' }
+				]
+			},
+
+			onEnterRules: [
+				{
+					beforeText: new RegExp(`<(?!(?:${EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					afterText: /^<\/(\w[\w\d]*)\s*>$/i,
+					action: { indentAction: Modes.IndentAction.IndentOutdent }
+				},
+				{
+					beforeText: new RegExp(`<(?!(?:${EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					action: { indentAction: Modes.IndentAction.Indent }
+				}
+			],
 		});
 	}
 
@@ -374,12 +397,13 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 	}
 
 	private _collectAutoClosingPairs(result:{[key:string]:string;}, mode:Modes.IMode): void {
-		if (mode && mode.characterPairSupport) {
-			var acp = mode.characterPairSupport.getAutoClosingPairs();
-			if (acp !== null) {
-				for(var i = 0; i < acp.length; i++) {
-					result[acp[i].open] = acp[i].close;
-				}
+		if (!mode || !mode.richEditSupport || !mode.richEditSupport.characterPair) {
+			return;
+		}
+		var acp = mode.richEditSupport.characterPair.getAutoClosingPairs();
+		if (acp !== null) {
+			for(var i = 0; i < acp.length; i++) {
+				result[acp[i].open] = acp[i].close;
 			}
 		}
 	}
@@ -394,13 +418,13 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 		return state instanceof State && (<State>state).kind === States.WithinEmbeddedContent;
 	}
 
-	public getNestedMode(state:Modes.IState): supports.IEnteringNestedModeData {
+	public getNestedMode(state:Modes.IState): IEnteringNestedModeData {
 		var result:Modes.IMode = null;
 		var htmlState:State = <State>state;
 		var missingModePromise: winjs.Promise = null;
 
 		if (htmlState.embeddedContentType !== null) {
-			if (modesRegistry.isRegisteredMode(htmlState.embeddedContentType)) {
+			if (this.modeService.isRegisteredMode(htmlState.embeddedContentType)) {
 				result = this.modeService.getMode(htmlState.embeddedContentType);
 				if (!result) {
 					missingModePromise = this.modeService.getOrCreateMode(htmlState.embeddedContentType);
@@ -426,7 +450,7 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 		};
 	}
 
-	public getLeavingNestedModeData(line:string, state:Modes.IState):supports.ILeavingNestedModeData {
+	public getLeavingNestedModeData(line:string, state:Modes.IState):ILeavingNestedModeData {
 		var tagName = (<State>state).lastTagName;
 		var regexp = new RegExp('<\\/' + tagName + '\\s*>', 'i');
 		var match:any = regexp.exec(line);
@@ -440,15 +464,6 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 		return null;
 	}
 
-	public static WORD_DEFINITION = createWordRegExp('#-?%');
-	public getWordDefinition():RegExp {
-		return HTMLMode.WORD_DEFINITION;
-	}
-
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return { blockCommentStartToken: '<!--', blockCommentEndToken: '-->' };
-	}
-
 	protected _getWorkerDescriptor(): AsyncDescriptor2<Modes.IMode, Modes.IWorkerParticipant[], htmlWorker.HTMLWorker> {
 		return createAsyncDescriptor2('vs/languages/html/common/htmlWorker', 'HTMLWorker');
 	}
@@ -498,5 +513,3 @@ export class HTMLMode<W extends htmlWorker.HTMLWorker> extends AbstractMode<W> i
 		return this._worker((w) => w.getParameterHints(resource, position));
 	}
 }
-
-var modesRegistry = <modesExtensions.IEditorModesRegistry>Platform.Registry.as(modesExtensions.Extensions.EditorModes);

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/html/test/common/html.test.ts
code:
@@ -14,18 +14,19 @@ import modesUtil = require('vs/editor/test/common/modesUtil');
 import {Model} from 'vs/editor/common/model/model';
 import Supports = require('vs/editor/common/modes/supports');
 import {getTag, DELIM_END, DELIM_START, DELIM_ASSIGN, ATTRIB_NAME, ATTRIB_VALUE, COMMENT, DELIM_COMMENT, DELIM_DOCTYPE, DOCTYPE} from 'vs/languages/html/common/htmlTokenTypes';
-
+import {getRawEnterActionAtPosition} from 'vs/editor/common/modes/supports/onEnter';
+import {TextModelWithTokens} from 'vs/editor/common/model/textModelWithTokens';
+import {TextModel} from 'vs/editor/common/model/textModel';
+import {Range} from 'vs/editor/common/core/range';
 
 suite('Colorizing - HTML', () => {
 
-	var onEnter: modesUtil.IOnEnterFunc;
 	var tokenizationSupport: Modes.ITokenizationSupport;
 	var _mode: Modes.IMode;
 
 	suiteSetup((done) => {
 		modesUtil.load('html').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			onEnter = modesUtil.createOnEnter(mode);
 			_mode = mode;
 			done();
 		});
@@ -609,7 +610,7 @@ suite('Colorizing - HTML', () => {
 	test('onEnter', function() {
 		var model = new Model('<script type=\"text/javascript\">function f() { foo(); }', _mode);
 
-		var actual = _mode.onEnterSupport.onEnter(model, {
+		var actual = _mode.richEditSupport.onEnter.onEnter(model, {
 			lineNumber: 1,
 			column: 46
 		});
@@ -620,21 +621,84 @@ suite('Colorizing - HTML', () => {
 	});
 
 	test('onEnter', function() {
-		assert.equal(onEnter('', 0), null);
-		assert.equal(onEnter('>', 1), null);
-		assert.equal(onEnter('span>', 5), null);
-		assert.equal(onEnter('</span>', 7), null);
-		assert.equal(onEnter('<img />', 7), null);
-		assert.equal(onEnter('<span>', 6).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<p>', 3).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<span><span>', 6).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<p><span>', 3).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<span></span>', 6).indentAction, Modes.IndentAction.IndentOutdent);
-		assert.equal(onEnter('<p></p>', 3).indentAction, Modes.IndentAction.IndentOutdent);
-		assert.equal(onEnter('<span>a</span>', 6).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<span>a</span>', 7).indentAction, Modes.IndentAction.IndentOutdent);
-		assert.equal(onEnter('<span> </span>', 6).indentAction, Modes.IndentAction.Indent);
-		assert.equal(onEnter('<span> </span>', 7).indentAction, Modes.IndentAction.IndentOutdent);
+
+		function onEnter(line:string, offset:number): Modes.IEnterAction {
+			let model = new TextModelWithTokens([], TextModel.toRawText(line), false, _mode);
+			let result = getRawEnterActionAtPosition(model, 1, offset + 1);
+			model.dispose();
+			return result;
+		}
+
+		function assertOnEnter(text:string, offset:number, expected: Modes.IndentAction): void {
+			let _actual = onEnter(text, offset);
+			let actual = _actual ? _actual.indentAction : null;
+			let actualStr = actual ? Modes.IndentAction[actual] : null;
+			let expectedStr = expected ? Modes.IndentAction[expected] : null;
+			assert.equal(actualStr, expectedStr, 'TEXT: <<' + text + '>>, OFFSET: <<' + offset + '>>');
+		}
+
+		assertOnEnter('', 0, null);
+		assertOnEnter('>', 1, null);
+		assertOnEnter('span>', 5, null);
+		assertOnEnter('</span>', 7, null);
+		assertOnEnter('<img />', 7, null);
+		assertOnEnter('<span>', 6, Modes.IndentAction.Indent);
+		assertOnEnter('<p>', 3, Modes.IndentAction.Indent);
+		assertOnEnter('<span><span>', 6, Modes.IndentAction.Indent);
+		assertOnEnter('<p><span>', 3, Modes.IndentAction.Indent);
+		assertOnEnter('<span></SPan>', 6, Modes.IndentAction.IndentOutdent);
+		assertOnEnter('<span></span>', 6, Modes.IndentAction.IndentOutdent);
+		assertOnEnter('<p></p>', 3, Modes.IndentAction.IndentOutdent);
+		assertOnEnter('<span>a</span>', 6, Modes.IndentAction.Indent);
+		assertOnEnter('<span>a</span>', 7, Modes.IndentAction.IndentOutdent);
+		assertOnEnter('<span> </span>', 6, Modes.IndentAction.Indent);
+		assertOnEnter('<span> </span>', 7, Modes.IndentAction.IndentOutdent);
+	});
+
+	test('matchBracket', () => {
+
+		function toString(brackets:EditorCommon.IEditorRange[]): string[] {
+			if (!brackets) {
+				return null;
+			}
+			brackets.sort(Range.compareRangesUsingStarts);
+			return brackets.map(b => b.toString());
+		}
+
+		function assertBracket(lines:string[], lineNumber:number, column:number, expected:EditorCommon.IEditorRange[]): void {
+			let model = new TextModelWithTokens([], TextModel.toRawText(lines.join('\n')), false, _mode);
+			// force tokenization
+			model.getLineContext(model.getLineCount());
+			let actual = model.matchBracket({
+				lineNumber: lineNumber,
+				column: column
+			});
+			let actualStr = actual ? toString(actual.brackets) : null;
+			let expectedStr = toString(expected);
+			assert.deepEqual(actualStr, expectedStr, 'TEXT <<' + lines.join('\n') + '>>, POS: ' + lineNumber + ', ' + column);
+		}
+
+		assertBracket(['<p></p>'], 1, 1, [new Range(1, 1, 1, 2), new Range(1, 3, 1, 4)]);
+		assertBracket(['<p></p>'], 1, 2, [new Range(1, 1, 1, 2), new Range(1, 3, 1, 4)]);
+		assertBracket(['<p></p>'], 1, 3, [new Range(1, 1, 1, 2), new Range(1, 3, 1, 4)]);
+		assertBracket(['<p></p>'], 1, 4, [new Range(1, 1, 1, 2), new Range(1, 3, 1, 4)]);
+		assertBracket(['<p></p>'], 1, 5, [new Range(1, 4, 1, 5), new Range(1, 7, 1, 8)]);
+		assertBracket(['<p></p>'], 1, 6, null);
+		assertBracket(['<p></p>'], 1, 7, [new Range(1, 4, 1, 5), new Range(1, 7, 1, 8)]);
+		assertBracket(['<p></p>'], 1, 8, [new Range(1, 4, 1, 5), new Range(1, 7, 1, 8)]);
+
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 10, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 11, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 22, null);
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 23, null);
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 33, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a[a<script>a]a'], 1, 34, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 10, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 11, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 22, null);
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 23, null);
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 33, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
+		assertBracket(['<script>a[a</script>a]a<script>a]a'], 1, 34, [new Range(1, 10, 1, 11), new Range(1, 33, 1, 34)]);
 	});
 });
-

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/javascript/common/javascript.ts
code:
@@ -11,14 +11,17 @@ import typescriptMode = require('vs/languages/typescript/common/typescriptMode')
 import typescript = require('vs/languages/typescript/common/typescript');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
-import supports = require('vs/editor/common/modes/supports');
 import extensions = require('vs/languages/javascript/common/javascript.extensions');
 import {createWordRegExp} from 'vs/editor/common/modes/abstractMode';
 import {AsyncDescriptor, AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {ParameterHintsSupport} from 'vs/editor/common/modes/supports/parameterHintsSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export class JSMode extends typescriptMode.TypeScriptMode<javascriptWorker.JavaScriptWorker> {
 
@@ -29,7 +32,6 @@ export class JSMode extends typescriptMode.TypeScriptMode<javascriptWorker.JavaS
 	public logicalSelectionSupport: Modes.ILogicalSelectionSupport;
 	public typeDeclarationSupport: Modes.ITypeDeclarationSupport;
 	public suggestSupport: Modes.ISuggestSupport;
-	public onEnterSupport: Modes.IOnEnterSupport;
 
 	constructor(
 		descriptor:Modes.IModeDescriptor,
@@ -40,44 +42,34 @@ export class JSMode extends typescriptMode.TypeScriptMode<javascriptWorker.JavaS
 		super(descriptor, instantiationService, threadService, telemetryService);
 
 		this.tokenizationSupport = tokenization.createTokenizationSupport(this, tokenization.Language.EcmaScript5);
-		this.referenceSupport = new supports.ReferenceSupport(this, {
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
 			tokens: [],
 			findReferences: (resource, position, includeDeclaration) => this.findReferences(resource, position, includeDeclaration)});
 
-		this.declarationSupport = new supports.DeclarationSupport(this, {
+		this.declarationSupport = new DeclarationSupport(this.getId(), {
 			tokens: [],
 			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
 
-		this.parameterHintsSupport = new supports.ParameterHintsSupport(this, {
+		this.parameterHintsSupport = new ParameterHintsSupport(this.getId(), {
 			triggerCharacters: ['(', ','],
 			excludeTokens: ['string.js', 'string.escape.js'],
 			getParameterHints: (resource, position) => this.getParameterHints(resource, position)});
 
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this,
-			{
-				brackets: [
-					{ tokenType: 'delimiter.bracket.js', open: '{', close: '}', isElectric: true },
-					{ tokenType: 'delimiter.array.js', open: '[', close: ']', isElectric: true },
-					{ tokenType: 'delimiter.parenthesis.js', open: '(', close: ')', isElectric: true } ],
-				docComment: { scope: 'comment.doc', open: '/**', lineStart: ' * ', close: ' */' }
-			});
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			wordPattern: createWordRegExp('$'),
 
-		this.characterPairSupport = new supports.CharacterPairSupport(this, {
-			autoClosingPairs:
-				[	{ open: '{', close: '}' },
-					{ open: '[', close: ']' },
-					{ open: '(', close: ')' },
-					{ open: '"', close: '"', notIn: ['string'] },
-					{ open: '\'', close: '\'', notIn: ['string', 'comment'] }
-				]});
+			comments: {
+				lineComment: '//',
+				blockComment: ['/*', '*/']
+			},
 
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
 			brackets: [
-				{ open: '(', close: ')' },
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' }
+				['{', '}'],
+				['[', ']'],
+				['(', ')']
 			],
-			regExpRules: [
+
+			onEnterRules: [
 				{
 					// e.g. /** | */
 					beforeText: /^\s*\/\*\*(?!\/)([^\*]|\*(?!\/))*$/,
@@ -99,10 +91,29 @@ export class JSMode extends typescriptMode.TypeScriptMode<javascriptWorker.JavaS
 					beforeText: /^(\t|(\ \ ))*\ \*\/\s*$/,
 					action: { indentAction: Modes.IndentAction.None, removeText: 1 }
 				}
-			]
+			],
+
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType: 'delimiter.bracket.js', open: '{', close: '}', isElectric: true },
+					{ tokenType: 'delimiter.array.js', open: '[', close: ']', isElectric: true },
+					{ tokenType: 'delimiter.parenthesis.js', open: '(', close: ')', isElectric: true }
+				],
+				docComment: { scope: 'comment.doc', open: '/**', lineStart: ' * ', close: ' */' }
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: [
+					{ open: '{', close: '}' },
+					{ open: '[', close: ']' },
+					{ open: '(', close: ')' },
+					{ open: '"', close: '"', notIn: ['string'] },
+					{ open: '\'', close: '\'', notIn: ['string', 'comment'] }
+				]
+			}
 		});
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: ['.'],
 			excludeTokens: ['string', 'comment', 'number', 'numeric'],
 			suggest: (resource, position) => this.suggest(resource, position),
@@ -136,15 +147,6 @@ export class JSMode extends typescriptMode.TypeScriptMode<javascriptWorker.JavaS
 		return createAsyncDescriptor2('vs/languages/javascript/common/javascriptWorker', 'JavaScriptWorker');
 	}
 
-	public getCommentsConfiguration(): Modes.ICommentsConfiguration {
-		return { lineCommentTokens: ['//'], blockCommentStartToken: '/*', blockCommentEndToken: '*/' };
-	}
-
-	private static JS_WORD_DEFINITION = createWordRegExp('$');
-	public getWordDefinition(): RegExp {
-		return JSMode.JS_WORD_DEFINITION;
-	}
-
 	public get filter() {
 		return void 0;
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/javascript/test/common/javascript.test.ts
code:
@@ -4,26 +4,26 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import 'vs/languages/javascript/common/javascript.contribution';
 import assert = require('assert');
 import javascriptMode = require('vs/languages/javascript/common/javascript');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import modesUtil = require('vs/editor/test/common/modesUtil');
+import {createLineContext} from 'vs/editor/test/common/modesTestUtils';
 
 suite('JS - Auto Indent', () => {
 
 	var wordDefinition:RegExp;
-	var onEnter: modesUtil.IOnEnterFunc;
 	var assertOnEnter: modesUtil.IOnEnterAsserter;
-	var onElectricCharacter: modesUtil.IOnElectricCharacterFunc;
+	var _mode: Modes.IMode;
 	var assertWords = modesUtil.assertWords;
 
 	suiteSetup((done) => {
 		modesUtil.load('javascript').then(mode => {
-			onEnter = modesUtil.createOnEnter(mode);
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
-			onElectricCharacter = modesUtil.createOnElectricCharacter(mode);
-			wordDefinition = mode.tokenTypeClassificationSupport.getWordDefinition();
+			_mode = mode;
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
+			wordDefinition = mode.richEditSupport.wordDefinition;
 			done();
 		});
 	});
@@ -59,24 +59,37 @@ suite('JS - Auto Indent', () => {
 	});
 
 	test('onElectricCharacter', function() {
-		assert.equal(onElectricCharacter('var f = function() {}', 20), null);
-		assert.deepEqual(onElectricCharacter('}', 0), { matchBracketType: 'delimiter.bracket.js' });
-		assert.deepEqual(onElectricCharacter('   }', 3), { matchBracketType: 'delimiter.bracket.js' });
-		assert.deepEqual(onElectricCharacter('		}', 2), { matchBracketType: 'delimiter.bracket.js' });
-		assert.deepEqual(onElectricCharacter('	   }; // stuff', 4), { matchBracketType: 'delimiter.bracket.js' });
-
-		assert.equal(onElectricCharacter('[1,2]', 4), null);
-		assert.deepEqual(onElectricCharacter(']', 0), { matchBracketType: 'delimiter.array.js' });
-		assert.deepEqual(onElectricCharacter('   ]', 3), { matchBracketType: 'delimiter.array.js' });
-		assert.deepEqual(onElectricCharacter('		]', 2), { matchBracketType: 'delimiter.array.js' });
-		assert.deepEqual(onElectricCharacter('	   ]; // stuff', 4), { matchBracketType: 'delimiter.array.js' });
-
-		assert.equal(onElectricCharacter('f()', 2), null);
-		assert.deepEqual(onElectricCharacter(')', 0), { matchBracketType: 'delimiter.parenthesis.js' });
-		assert.deepEqual(onElectricCharacter('   )', 3), { matchBracketType: 'delimiter.parenthesis.js' });
-		assert.deepEqual(onElectricCharacter('		)', 2), { matchBracketType: 'delimiter.parenthesis.js' });
-		assert.deepEqual(onElectricCharacter('	   )', 4), { matchBracketType: 'delimiter.parenthesis.js' });
-		assert.deepEqual(onElectricCharacter('	   ); // stuff', 4), { matchBracketType: 'delimiter.parenthesis.js' });
+
+		function testElectricCharacter(line:string, offset:number, expected:Modes.IElectricAction): void {
+			let state = _mode.tokenizationSupport.getInitialState();
+			var lineTokens = _mode.tokenizationSupport.tokenize(line, state);
+			let actual = _mode.richEditSupport.electricCharacter.onElectricCharacter(createLineContext(line, lineTokens), offset);
+
+			assert.deepEqual(actual, expected, 'LINE <<<' + line + '>>>, OFFSET: <<<' + offset + '>>>');
+		}
+
+		const CURLY = { matchOpenBracket: '}' };
+		const ROUND = { matchOpenBracket: ')' };
+		const SQUARE = { matchOpenBracket: ']' };
+
+		testElectricCharacter('var f = function() {}', 20, null);
+		testElectricCharacter('}', 0, CURLY);
+		testElectricCharacter('   }', 3, CURLY);
+		testElectricCharacter('		}', 2, CURLY);
+		testElectricCharacter('	   }; // stuff', 4, CURLY);
+
+		testElectricCharacter('[1,2]', 4, null);
+		testElectricCharacter(']', 0, SQUARE);
+		testElectricCharacter('   ]', 3, SQUARE);
+		testElectricCharacter('		]', 2, SQUARE);
+		testElectricCharacter('	   ]; // stuff', 4, SQUARE);
+
+		testElectricCharacter('f()', 2, null);
+		testElectricCharacter(')', 0, ROUND);
+		testElectricCharacter('   )', 3, ROUND);
+		testElectricCharacter('		)', 2, ROUND);
+		testElectricCharacter('	   )', 4, ROUND);
+		testElectricCharacter('	   ); // stuff', 4, ROUND);
 	});
 
 	test('Word definition', function() {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/json/common/features/tokenization.ts
code:
@@ -180,8 +180,7 @@ function tokenize(mode:Modes.IMode, comments:boolean, line:string, state:JSONSta
 		ret.endState = new JSONState(state.getMode(), state.getStateData(), scanner.getTokenError(), lastWasColon);
 		ret.tokens.push({
 			startIndex: offset,
-			type: type,
-			bracket: bracket
+			type: type
 		});
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/json/common/json.ts
code:
@@ -8,7 +8,6 @@ import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import URI from 'vs/base/common/uri';
 import WinJS = require('vs/base/common/winjs.base');
-import supports = require('vs/editor/common/modes/supports');
 import Platform = require('vs/platform/platform');
 import nls = require('vs/nls');
 import jsonWorker = require('vs/languages/json/common/jsonWorker');
@@ -17,15 +16,15 @@ import {AbstractMode, createWordRegExp} from 'vs/editor/common/modes/abstractMod
 import {OneWorkerAttr, AllWorkersAttr} from 'vs/platform/thread/common/threadService';
 import {IThreadService, IThreadSynchronizableObject} from 'vs/platform/thread/common/thread';
 import {AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IJSONContributionRegistry, Extensions, ISchemaContributions} from 'vs/platform/jsonschemas/common/jsonContributionRegistry';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export class JSONMode extends AbstractMode<jsonWorker.JSONWorker> implements Modes.IExtraInfoSupport, Modes.IOutlineSupport, IThreadSynchronizableObject<ISchemaContributions> {
 
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	public extraInfoSupport: Modes.IExtraInfoSupport;
 	public outlineSupport: Modes.IOutlineSupport;
@@ -35,8 +34,6 @@ export class JSONMode extends AbstractMode<jsonWorker.JSONWorker> implements Mod
 
 	public outlineGroupLabel : { [name: string]: string; };
 
-	public onEnterSupport: Modes.IOnEnterSupport;
-
 	constructor(
 		descriptor:Modes.IModeDescriptor,
 		@IInstantiationService instantiationService: IInstantiationService,
@@ -45,10 +42,36 @@ export class JSONMode extends AbstractMode<jsonWorker.JSONWorker> implements Mod
 		super(descriptor, instantiationService, threadService);
 
 		this.tokenizationSupport = tokenization.createTokenizationSupport(this, true);
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this, { brackets: [
-			{ tokenType:'delimiter.bracket.json', open: '{', close: '}', isElectric: true },
-			{ tokenType:'delimiter.array.json', open: '[', close: ']', isElectric: true }
-		] });
+
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+
+			wordPattern: createWordRegExp('.-'),
+
+			comments: {
+				lineComment: '//',
+				blockComment: ['/*', '*/']
+			},
+
+			brackets: [
+				['{', '}'],
+				['[', ']']
+			],
+
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType:'delimiter.bracket.json', open: '{', close: '}', isElectric: true },
+					{ tokenType:'delimiter.array.json', open: '[', close: ']', isElectric: true }
+				]
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: [
+					{ open: '{', close: '}', notIn: ['string'] },
+					{ open: '[', close: ']', notIn: ['string'] },
+					{ open: '"', close: '"', notIn: ['string'] }
+				]
+			}
+		});
 
 		this.extraInfoSupport = this;
 
@@ -64,24 +87,10 @@ export class JSONMode extends AbstractMode<jsonWorker.JSONWorker> implements Mod
 
 		this.formattingSupport = this;
 
-		this.characterPairSupport = new supports.CharacterPairSupport(this, {
-			autoClosingPairs:
-				[	{ open: '{', close: '}', notIn: ['string'] },
-					{ open: '[', close: ']', notIn: ['string'] },
-					{ open: '"', close: '"', notIn: ['string'] }
-				]});
-
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: [],
 			excludeTokens: ['comment.line.json', 'comment.block.json'],
 			suggest: (resource, position) => this.suggest(resource, position)});
-
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
-			brackets: [
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' }
-			]
-		});
 	}
 
 	public creationDone(): void {
@@ -140,17 +149,4 @@ export class JSONMode extends AbstractMode<jsonWorker.JSONWorker> implements Mod
 	public formatRange(resource:URI, range:EditorCommon.IRange, options:Modes.IFormattingOptions):WinJS.TPromise<EditorCommon.ISingleEditOperation[]> {
 		return this._worker((w) => w.format(resource, range, options));
 	}
-
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return {
-			lineCommentTokens: ['//'],
-			blockCommentStartToken: '/*',
-			blockCommentEndToken: '*/'
-		};
-	}
-
-	private static WORD_DEFINITION = createWordRegExp('.-');
-	public getWordDefinition():RegExp {
-		return JSONMode.WORD_DEFINITION;
-	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/json/common/jsonWorker.ts
code:
@@ -19,7 +19,6 @@ import WinJS = require('vs/base/common/winjs.base');
 import Strings = require('vs/base/common/strings');
 import {JSONMode} from './json';
 import ProjectJSONContribution = require('./contributions/projectJSONContribution');
-import supports = require('vs/editor/common/modes/supports');
 import PackageJSONContribution = require('./contributions/packageJSONContribution');
 import BowerJSONContribution = require('./contributions/bowerJSONContribution');
 import GlobPatternContribution = require('./contributions/globPatternContribution');
@@ -31,6 +30,7 @@ import {ISchemaContributions} from 'vs/platform/jsonschemas/common/jsonContribut
 import {IResourceService} from 'vs/editor/common/services/resourceService';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {JSONLocation} from './parser/jsonLocation';
+import {WorkerInplaceReplaceSupport, ReplaceSupport} from 'vs/editor/common/modes/supports/inplaceReplaceSupport';
 
 export interface IOptionsSchema {
 	/**
@@ -101,7 +101,7 @@ export class JSONWorker extends AbstractModeWorker implements Modes.IExtraInfoSu
 	}
 
 	protected _createInPlaceReplaceSupport(): Modes.IInplaceReplaceSupport {
-		return new supports.WorkerInplaceReplaceSupport(this.resourceService, this);
+		return new WorkerInplaceReplaceSupport(this.resourceService, this);
 	}
 
 	/**
@@ -318,7 +318,7 @@ export class JSONWorker extends AbstractModeWorker implements Modes.IExtraInfoSu
 	}
 
 	public textReplace(value:string, up:boolean):string {
-		return supports.ReplaceSupport.valueSetReplace(['true', 'false'], value, up);
+		return ReplaceSupport.valueSetReplace(['true', 'false'], value, up);
 	}
 
 	public format(resource: URI, range: EditorCommon.IRange, options: Modes.IFormattingOptions): WinJS.TPromise<EditorCommon.ISingleEditOperation[]> {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/json/test/common/json.test.ts
code:
@@ -20,7 +20,7 @@ suite('JSON - tokenization', () => {
 	setup((done) => {
 		modesUtil.load('json').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/less/common/less.ts
code:
@@ -13,14 +13,16 @@ import Types = require('vs/editor/common/modes/monarch/monarchTypes');
 import Compile = require('vs/editor/common/modes/monarch/monarchCompile');
 import lessWorker = require('vs/languages/less/common/lessWorker');
 import * as lessTokenTypes from 'vs/languages/less/common/lessTokenTypes';
-import supports = require('vs/editor/common/modes/supports');
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {OneWorkerAttr} from 'vs/platform/thread/common/threadService';
 import {AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IModelService} from 'vs/editor/common/services/modelService';
+import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export var language: Types.ILanguage = <Types.ILanguage> {
 	displayName: 'LESS',
@@ -197,16 +199,16 @@ export class LESSMode extends Monarch.MonarchMode<lessWorker.LessWorker> impleme
 		this.modeService = modeService;
 
 		this.extraInfoSupport = this;
-		this.referenceSupport = new supports.ReferenceSupport(this, {
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
 			tokens: [lessTokenTypes.TOKEN_PROPERTY + '.less', lessTokenTypes.TOKEN_VALUE + '.less', 'variable.less', lessTokenTypes.TOKEN_SELECTOR + '.class.less', lessTokenTypes.TOKEN_SELECTOR + '.id.less', 'selector.less'],
 			findReferences: (resource, position, /*unused*/includeDeclaration) => this.findReferences(resource, position)});
 		this.logicalSelectionSupport = this;
-		this.declarationSupport = new supports.DeclarationSupport(this, {
+		this.declarationSupport = new DeclarationSupport(this.getId(), {
 			tokens: ['variable.less', lessTokenTypes.TOKEN_SELECTOR + '.class.less', lessTokenTypes.TOKEN_SELECTOR + '.id.less', 'selector.less'],
 			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
 		this.outlineSupport = this;
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: [],
 			excludeTokens: ['comment.less', 'string.less'],
 			suggest: (resource, position) => this.suggest(resource, position)});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/less/test/common/colorizer.test.ts
code:
@@ -21,7 +21,7 @@ suite('LESS-tokenization', () => {
 	setup((done) => {
 		modesUtil.load('less', ['javascript']).then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/markdown/common/markdown.ts
code:
@@ -33,6 +33,9 @@ export const language =
 
 		autoClosingPairs: [],
 
+		blockCommentStart: '<!--',
+		blockCommentEnd: '-->',
+
 		// escape codes
 		control: /[\\`*_\[\]{}()#+\-\.!]/,
 		noncontrol: /[^\\`*_\[\]{}()#+\-\.!]/,
@@ -219,10 +222,6 @@ export class MarkdownMode extends Monarch.MonarchMode<MarkdownWorker.MarkdownWor
 		this.emitOutputSupport = this;
 	}
 
-	public getCommentsConfiguration(): Modes.ICommentsConfiguration {
-		return { blockCommentStartToken: '<!--', blockCommentEndToken: '-->' };
-	}
-
 	static $getEmitOutput = OneWorkerAttr(MarkdownMode, MarkdownMode.prototype.getEmitOutput);
 	public getEmitOutput(resource: URI, absoluteWorkerResourcesPath?: string): WinJS.TPromise<Modes.IEmitOutput> { // TODO@Ben technical debt: worker cannot resolve paths absolute
 		return this._worker((w) => w.getEmitOutput(resource, absoluteWorkerResourcesPath));
@@ -231,4 +230,4 @@ export class MarkdownMode extends Monarch.MonarchMode<MarkdownWorker.MarkdownWor
 	protected _getWorkerDescriptor(): AsyncDescriptor2<Modes.IMode, Modes.IWorkerParticipant[], MarkdownWorker.MarkdownWorker> {
 		return createAsyncDescriptor2('vs/languages/markdown/common/markdownWorker', 'MarkdownWorker');
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/markdown/common/markdownWorker.ts
code:
@@ -11,9 +11,7 @@ import Types = require('vs/base/common/types');
 import Modes = require('vs/editor/common/modes');
 import Paths = require('vs/base/common/paths');
 import Marked = require('vs/base/common/marked/marked');
-import ModesExtensions = require('vs/editor/common/modes/modesRegistry');
 import {tokenizeToString} from 'vs/editor/common/modes/textToHtmlTokenizer';
-import Platform = require('vs/platform/platform');
 import {isMacintosh} from 'vs/base/common/platform';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {IResourceService} from 'vs/editor/common/services/resourceService';
@@ -98,8 +96,12 @@ export class MarkdownWorker extends AbstractModeWorker {
 
 	private modeService: IModeService;
 
-	constructor(mode: Modes.IMode, participants: Modes.IWorkerParticipant[], @IResourceService resourceService: IResourceService,
-		@IMarkerService markerService: IMarkerService, @IModeService modeService: IModeService) {
+	constructor(
+		mode: Modes.IMode, participants: Modes.IWorkerParticipant[],
+		@IResourceService resourceService: IResourceService,
+		@IMarkerService markerService: IMarkerService,
+		@IModeService modeService: IModeService
+	) {
 		super(mode, participants, resourceService, markerService);
 
 		this.modeService = modeService;
@@ -156,8 +158,7 @@ export class MarkdownWorker extends AbstractModeWorker {
 		let highlighter = function(code: string, lang: string, callback?: (error: Error, result: string) => void) {
 
 			// Lookup the mode and use the tokenizer to get the HTML
-			let modesRegistry = <ModesExtensions.IEditorModesRegistry>Platform.Registry.as(ModesExtensions.Extensions.EditorModes);
-			let mimeForLang = modesRegistry.getModeIdForLanguageName(lang) || lang || MarkdownWorker.DEFAULT_MODE;
+			let mimeForLang = this.modeService.getModeIdForLanguageName(lang) || lang || MarkdownWorker.DEFAULT_MODE;
 			modeService.getOrCreateMode(mimeForLang).then((mode) => {
 				callback(null, tokenizeToString(code, mode));
 			});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/php/common/php.ts
code:
@@ -6,15 +6,16 @@
 
 import WinJS = require('vs/base/common/winjs.base');
 import objects = require('vs/base/common/objects');
-import supports = require('vs/editor/common/modes/supports');
 import Modes = require('vs/editor/common/modes');
 import {AbstractMode, isDigit, createWordRegExp} from 'vs/editor/common/modes/abstractMode';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import {IModeService} from 'vs/editor/common/services/modeService';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {TokenizationSupport, ILeavingNestedModeData, ITokenizationCustomization} from 'vs/editor/common/modes/supports/tokenizationSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 var bracketsSource : Modes.IBracketPair[]= [
 	{ tokenType:'delimiter.bracket.php', open: '{', close: '}', isElectric: true },
@@ -457,13 +458,10 @@ export class PHPEnterHTMLState extends PHPState {
 
 }
 
-export class PHPMode extends AbstractMode<AbstractModeWorker> implements supports.ITokenizationCustomization {
+export class PHPMode extends AbstractMode<AbstractModeWorker> implements ITokenizationCustomization {
 
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
-
-	public onEnterSupport: Modes.IOnEnterSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 
 	private modeService:IModeService;
 
@@ -476,30 +474,41 @@ export class PHPMode extends AbstractMode<AbstractModeWorker> implements support
 		super(descriptor, instantiationService, threadService);
 		this.modeService = modeService;
 
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this, { brackets: bracketsSource });
-		this.tokenizationSupport = new supports.TokenizationSupport(this, this, true, false);
+		this.tokenizationSupport = new TokenizationSupport(this, this, true, false);
+
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			wordPattern: createWordRegExp('$_'),
 
-		this.characterPairSupport = new supports.CharacterPairSupport(this, {
-			autoClosingPairs:
-				[	{ open: '{', close: '}', notIn: ['string.php'] },
+			comments: {
+				lineComment: '//',
+				blockComment: ['/*', '*/']
+			},
+
+			brackets: [
+				['{', '}'],
+				['[', ']'],
+				['(', ')']
+			],
+
+			__electricCharacterSupport: {
+				brackets: bracketsSource
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: [
+					{ open: '{', close: '}', notIn: ['string.php'] },
 					{ open: '[', close: ']', notIn: ['string.php'] },
 					{ open: '(', close: ')', notIn: ['string.php'] },
 					{ open: '"', close: '"', notIn: ['string.php'] },
 					{ open: '\'', close: '\'', notIn: ['string.php'] }
-				]});
+				]
+			}
+		});
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: ['.', ':', '$'],
 			excludeTokens: ['comment'],
 			suggest: (resource, position) => this.suggest(resource, position)});
-
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
-			brackets: [
-				{ open: '(', close: ')' },
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' }
-			]
-		});
 	}
 
 	public asyncCtor(): WinJS.Promise {
@@ -531,7 +540,7 @@ export class PHPMode extends AbstractMode<AbstractModeWorker> implements support
 		};
 	}
 
-	public getLeavingNestedModeData(line:string, state:Modes.IState):supports.ILeavingNestedModeData {
+	public getLeavingNestedModeData(line:string, state:Modes.IState):ILeavingNestedModeData {
 		// Leave HTML if <? is found on a line
 		var match:any = /<\?/i.exec(line);
 		if (match !== null) {
@@ -550,13 +559,4 @@ export class PHPMode extends AbstractMode<AbstractModeWorker> implements support
 		// such that when we enter HTML again, we can recover the HTML state from .parent
 		(<PHPPlain>myStateAfterNestedMode).parent = lastNestedModeState;
 	}
-
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return { lineCommentTokens: ['//','#'], blockCommentStartToken: '/*', blockCommentEndToken: '*/' };
-	}
-
-	private static WORD_DEFINITION = createWordRegExp('$_');
-	public getWordDefinition():RegExp {
-		return PHPMode.WORD_DEFINITION;
-	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/php/test/common/php.test.ts
code:
@@ -26,8 +26,8 @@ suite('Syntax Highlighting - PHP', () => {
 	setup((done) => {
 		modesUtil.load('php').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
-			wordDefinition = mode.tokenTypeClassificationSupport.getWordDefinition();
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
+			wordDefinition = mode.richEditSupport.wordDefinition;
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/plaintext/common/plaintext.ts
code:
@@ -5,12 +5,12 @@
 'use strict';
 
 import Modes = require('vs/editor/common/modes');
-import supports = require('vs/editor/common/modes/supports');
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
+import {TokenizationSupport} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 class State extends AbstractState {
 
@@ -47,7 +47,7 @@ export class Mode extends AbstractMode<AbstractModeWorker> {
 		@IThreadService threadService: IThreadService
 	) {
 		super(descriptor, instantiationService, threadService);
-		this.tokenizationSupport = new supports.TokenizationSupport(this, {
+		this.tokenizationSupport = new TokenizationSupport(this, {
 			getInitialState: () => new State(this)
 		}, false, false);
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/razor/common/csharpTokenization.ts
code:
@@ -23,8 +23,7 @@ var brackets = (function() {
 	let bracketsSource = [
 		{ tokenType:'punctuation.bracket.cs', open: '{', close: '}', isElectric: true },
 		{ tokenType:'punctuation.array.cs', open: '[', close: ']', isElectric: true },
-		{ tokenType:'punctuation.parenthesis.cs', open: '(', close: ')', isElectric: true },
-		{ tokenType:'punctuation.angle.cs', open: '<', close: '>', isElectric: false }
+		{ tokenType:'punctuation.parenthesis.cs', open: '(', close: ')', isElectric: true }
 	];
 
 	let MAP: {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/razor/common/razor.ts
code:
@@ -5,17 +5,17 @@
 'use strict';
 
 import Modes = require('vs/editor/common/modes');
-import supports = require('vs/editor/common/modes/supports');
 import htmlMode = require('vs/languages/html/common/html');
 import csharpTokenization = require('vs/languages/razor/common/csharpTokenization');
 import {createWordRegExp} from 'vs/editor/common/modes/abstractMode';
 import {AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import razorTokenTypes = require('vs/languages/razor/common/razorTokenTypes');
 import {RAZORWorker} from 'vs/languages/razor/common/razorWorker';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IModeService} from 'vs/editor/common/services/modeService';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {ILeavingNestedModeData} from 'vs/editor/common/modes/supports/tokenizationSupport';
 
 // for a brief description of the razor syntax see http://www.mikesdotnetting.com/Article/153/Inline-Razor-Syntax-Overview
 
@@ -65,13 +65,48 @@ export class RAZORMode extends htmlMode.HTMLMode<RAZORWorker> {
 		super(descriptor, instantiationService, threadService, modeService);
 
 		this.formattingSupport = null;
+	}
+
+	protected _createRichEditSupport(embeddedAutoClosingPairs: Modes.IAutoClosingPair[]): Modes.IRichEditSupport {
+		return new RichEditSupport(this.getId(), {
+
+			wordPattern: createWordRegExp('#?%'),
+
+			comments: {
+				blockComment: ['<!--', '-->']
+			},
 
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
 			brackets: [
-				{ open: '<!--', close: '-->' },
-				{ open: '{', close: '}' },
-				{ open: '(', close: ')' },
-			]
+				['<!--', '-->'],
+				['{', '}'],
+				['(', ')']
+			],
+
+			__electricCharacterSupport: {
+				brackets: [],
+				caseInsensitive: true,
+				embeddedElectricCharacters: ['*', '}', ']', ')']
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: embeddedAutoClosingPairs.slice(0),
+				surroundingPairs: [
+					{ open: '"', close: '"' },
+					{ open: '\'', close: '\'' }
+				]
+			},
+
+			onEnterRules: [
+				{
+					beforeText: new RegExp(`<(?!(?:${htmlMode.EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					afterText: /^<\/(\w[\w\d]*)\s*>$/i,
+					action: { indentAction: Modes.IndentAction.IndentOutdent }
+				},
+				{
+					beforeText: new RegExp(`<(?!(?:${htmlMode.EMPTY_ELEMENTS.join("|")}))(\\w[\\w\\d]*)([^/>]*(?!/)>)[^<]*$`, 'i'),
+					action: { indentAction: Modes.IndentAction.Indent }
+				}
+			],
 		});
 	}
 
@@ -83,17 +118,11 @@ export class RAZORMode extends htmlMode.HTMLMode<RAZORWorker> {
 		return new RAZORState(this, htmlMode.States.Content, '', '', '', '', '');
 	}
 
-	public static WORD_DEFINITION = createWordRegExp('#?%');
-	public getWordDefinition():RegExp {
-		return RAZORMode.WORD_DEFINITION;
-	}
-
-	public getLeavingNestedModeData(line:string, state:Modes.IState): supports.ILeavingNestedModeData {
+	public getLeavingNestedModeData(line:string, state:Modes.IState): ILeavingNestedModeData {
 		var leavingNestedModeData = super.getLeavingNestedModeData(line, state);
 		if (leavingNestedModeData) {
 			leavingNestedModeData.stateAfterNestedMode = new RAZORState(this, htmlMode.States.Content, '', '', '', '', '');
 		}
 		return leavingNestedModeData;
 	}
 }
-

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/sass/common/sass.ts
code:
@@ -12,7 +12,6 @@ import URI from 'vs/base/common/uri';
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import sassWorker = require('vs/languages/sass/common/sassWorker');
-import supports = require('vs/editor/common/modes/supports');
 import * as sassTokenTypes from 'vs/languages/sass/common/sassTokenTypes';
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
 import {OneWorkerAttr} from 'vs/platform/thread/common/threadService';
@@ -21,6 +20,9 @@ import {IModeService} from 'vs/editor/common/services/modeService';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {IThreadService} from 'vs/platform/thread/common/thread';
 import {IModelService} from 'vs/editor/common/services/modelService';
+import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 export var language = <Types.ILanguage>{
 	displayName: 'Sass',
@@ -299,16 +301,16 @@ export class SASSMode extends Monarch.MonarchMode<sassWorker.SassWorker> impleme
 		this.modeService = modeService;
 
 		this.extraInfoSupport = this;
-		this.referenceSupport = new supports.ReferenceSupport(this, {
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
 			tokens: [sassTokenTypes.TOKEN_PROPERTY + '.sass', sassTokenTypes.TOKEN_VALUE + '.sass', 'variable.decl.sass', 'variable.ref.sass', 'support.function.name.sass', sassTokenTypes.TOKEN_PROPERTY + '.sass', sassTokenTypes.TOKEN_SELECTOR + '.sass'],
 			findReferences: (resource, position, /*unused*/includeDeclaration) => this.findReferences(resource, position)});
 		this.logicalSelectionSupport = this;
-		this.declarationSupport = new supports.DeclarationSupport(this, {
+		this.declarationSupport = new DeclarationSupport(this.getId(), {
 			tokens: ['variable.decl.sass', 'variable.ref.sass', 'support.function.name.sass', sassTokenTypes.TOKEN_PROPERTY + '.sass', sassTokenTypes.TOKEN_SELECTOR + '.sass'],
 			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
 		this.outlineSupport = this;
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
+		this.suggestSupport = new SuggestSupport(this.getId(), {
 			triggerCharacters: [],
 			excludeTokens: ['comment.sass', 'string.sass'],
 			suggest: (resource, position) => this.suggest(resource, position)});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/sass/test/common/sass.test.ts
code:
@@ -18,7 +18,7 @@ suite('Sass Colorizer', () => {
 	setup((done) => {
 		modesUtil.load('sass').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/common/features/quickFixMainActions.ts
code:
@@ -6,11 +6,9 @@
 
 import nls = require('vs/nls');
 import URI from 'vs/base/common/uri';
-import strings = require('vs/base/common/strings');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import winjs = require('vs/base/common/winjs.base');
-import paths = require('vs/base/common/paths');
 import http = require('vs/base/common/http');
 import {IFileService} from 'vs/platform/files/common/files';
 import {IRequestService} from 'vs/platform/request/common/request';

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/common/features/tokenization.ts
code:
@@ -97,7 +97,7 @@ function tokenize(bracketTypeTable: { [i: number]: string }, tokenTypeTable: { [
 
 	function appendFn(startIndex:number, type:string, bracket:Modes.Bracket):void {
 		if(ret.tokens.length === 0 || bracket !== void 0 || arrays.tail(ret.tokens).type !== type) {
-			ret.tokens.push(new supports.Token(startIndex, type, bracket || Modes.Bracket.None));
+			ret.tokens.push(new supports.Token(startIndex, type));
 		}
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/common/lint/rules/layout.ts
code:
@@ -72,16 +72,16 @@ export class EmptyBlocksWithoutComment implements rules.IStyleRule<ts.Block> {
 		context.reportError(node, this.name, this.code);
 	}
 
-	private _hasComment(block: ts.Node): boolean {
-		var insideBlock = block.getChildAt(1);
-		if (insideBlock) {
-			var text = ts.getTextOfNode(insideBlock);
-			if (text && text.trim().length > 0) {
-				return true;
-			}
-		}
-
-		return false;
-	}
+	// private _hasComment(block: ts.Node): boolean {
+	// 	var insideBlock = block.getChildAt(1);
+	// 	if (insideBlock) {
+	// 		var text = ts.getTextOfNode(insideBlock);
+	// 		if (text && text.trim().length > 0) {
+	// 			return true;
+	// 		}
+	// 	}
+
+	// 	return false;
+	// }
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/common/typescriptMode.ts
code:
@@ -11,7 +11,6 @@ import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import lifecycle = require('vs/base/common/lifecycle');
 import async = require('vs/base/common/async');
-import supports = require('vs/editor/common/modes/supports');
 import tokenization = require('vs/languages/typescript/common/features/tokenization');
 import quickFixMainActions = require('vs/languages/typescript/common/features/quickFixMainActions');
 import typescriptWorker = require('vs/languages/typescript/common/typescriptWorker2');
@@ -24,8 +23,12 @@ import {AsyncDescriptor, AsyncDescriptor2, createAsyncDescriptor2} from 'vs/plat
 import {IMarker} from 'vs/platform/markers/common/markers';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {IThreadService, ThreadAffinity} from 'vs/platform/thread/common/thread';
-import {OnEnterSupport} from 'vs/editor/common/modes/supports/onEnter';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
+import {DeclarationSupport} from 'vs/editor/common/modes/supports/declarationSupport';
+import {ReferenceSupport} from 'vs/editor/common/modes/supports/referenceSupport';
+import {ParameterHintsSupport} from 'vs/editor/common/modes/supports/parameterHintsSupport';
+import {SuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 
 class SemanticValidator {
 
@@ -128,8 +131,7 @@ class SemanticValidator {
 export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extends AbstractMode<W> implements lifecycle.IDisposable {
 
 	public tokenizationSupport: Modes.ITokenizationSupport;
-	public electricCharacterSupport: Modes.IElectricCharacterSupport;
-	public characterPairSupport: Modes.ICharacterPairSupport;
+	public richEditSupport: Modes.IRichEditSupport;
 	public referenceSupport: Modes.IReferenceSupport;
 	public extraInfoSupport:Modes.IExtraInfoSupport;
 	public occurrencesSupport:Modes.IOccurrencesSupport;
@@ -143,8 +145,6 @@ export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extend
 	public renameSupport: Modes.IRenameSupport;
 	public suggestSupport: Modes.ISuggestSupport;
 
-	public onEnterSupport: Modes.IOnEnterSupport;
-
 	private _telemetryService: ITelemetryService;
 	private _disposables: lifecycle.IDisposable[] = [];
 	private _projectResolver: WinJS.TPromise<typescript.IProjectResolver2>;
@@ -195,50 +195,21 @@ export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extend
 		this.renameSupport = this;
 		this.tokenizationSupport = tokenization.createTokenizationSupport(this, tokenization.Language.TypeScript);
 
-		this.electricCharacterSupport = new supports.BracketElectricCharacterSupport(this, {
-			brackets: [
-				{ tokenType:'delimiter.bracket.ts', open: '{', close: '}', isElectric: true },
-				{ tokenType:'delimiter.array.ts', open: '[', close: ']', isElectric: true },
-				{ tokenType:'delimiter.parenthesis.ts', open: '(', close: ')', isElectric: true }
-			],
-			docComment: {scope:'comment.doc', open:'/**', lineStart:' * ', close:' */'} });
-
-		this.referenceSupport = new supports.ReferenceSupport(this, {
-			tokens: ['identifier.ts'],
-			findReferences: (resource, position, includeDeclaration) => this.findReferences(resource, position, includeDeclaration)});
-
-		this.declarationSupport = new supports.DeclarationSupport(this, {
-			tokens: ['identifier.ts', 'string.ts', 'attribute.value.vs'],
-			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
-
-		this.parameterHintsSupport = new supports.ParameterHintsSupport(this, {
-			triggerCharacters: ['(', ','],
-			excludeTokens: ['string.ts'],
-			getParameterHints: (resource, position) => this.getParameterHints(resource, position)});
-
-		this.characterPairSupport = new supports.CharacterPairSupport(this, {
-			autoClosingPairs:
-				[	{ open: '{', close: '}' },
-					{ open: '[', close: ']' },
-					{ open: '(', close: ')' },
-					{ open: '"', close: '"', notIn: ['string'] },
-					{ open: '\'', close: '\'', notIn: ['string', 'comment'] },
-					{ open: '`', close: '`' }
-				]});
+		this.richEditSupport = new RichEditSupport(this.getId(), {
+			wordPattern: createWordRegExp('$'),
 
-		this.suggestSupport = new supports.SuggestSupport(this, {
-			triggerCharacters: ['.'],
-			excludeTokens: ['string', 'comment', 'number'],
-			suggest: (resource, position) => this.suggest(resource, position),
-			getSuggestionDetails: (resource, position, suggestion) => this.getSuggestionDetails(resource, position, suggestion)});
+			comments: {
+				lineComment: '//',
+				blockComment: ['/*', '*/']
+			},
 
-		this.onEnterSupport = new OnEnterSupport(this.getId(), {
 			brackets: [
-				{ open: '{', close: '}' },
-				{ open: '[', close: ']' },
-				{ open: '(', close: ')' },
+				['{', '}'],
+				['[', ']'],
+				['(', ')']
 			],
-			regExpRules: [
+
+			onEnterRules: [
 				{
 					// e.g. /** | */
 					beforeText: /^\s*\/\*\*(?!\/)([^\*]|\*(?!\/))*$/,
@@ -260,8 +231,47 @@ export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extend
 					beforeText: /^(\t|(\ \ ))*\ \*\/\s*$/,
 					action: { indentAction: Modes.IndentAction.None, removeText: 1 }
 				}
-			]
+			],
+
+			__electricCharacterSupport: {
+				brackets: [
+					{ tokenType:'delimiter.bracket.ts', open: '{', close: '}', isElectric: true },
+					{ tokenType:'delimiter.array.ts', open: '[', close: ']', isElectric: true },
+					{ tokenType:'delimiter.parenthesis.ts', open: '(', close: ')', isElectric: true }
+				],
+				docComment: {scope:'comment.doc', open:'/**', lineStart:' * ', close:' */'}
+			},
+
+			__characterPairSupport: {
+				autoClosingPairs: [
+					{ open: '{', close: '}' },
+					{ open: '[', close: ']' },
+					{ open: '(', close: ')' },
+					{ open: '"', close: '"', notIn: ['string'] },
+					{ open: '\'', close: '\'', notIn: ['string', 'comment'] },
+					{ open: '`', close: '`' }
+				]
+			}
 		});
+
+		this.referenceSupport = new ReferenceSupport(this.getId(), {
+			tokens: ['identifier.ts'],
+			findReferences: (resource, position, includeDeclaration) => this.findReferences(resource, position, includeDeclaration)});
+
+		this.declarationSupport = new DeclarationSupport(this.getId(), {
+			tokens: ['identifier.ts', 'string.ts', 'attribute.value.vs'],
+			findDeclaration: (resource, position) => this.findDeclaration(resource, position)});
+
+		this.parameterHintsSupport = new ParameterHintsSupport(this.getId(), {
+			triggerCharacters: ['(', ','],
+			excludeTokens: ['string.ts'],
+			getParameterHints: (resource, position) => this.getParameterHints(resource, position)});
+
+		this.suggestSupport = new SuggestSupport(this.getId(), {
+			triggerCharacters: ['.'],
+			excludeTokens: ['string', 'comment', 'number'],
+			suggest: (resource, position) => this.suggest(resource, position),
+			getSuggestionDetails: (resource, position, suggestion) => this.getSuggestionDetails(resource, position, suggestion)});
 	}
 
 	public dispose(): void {
@@ -367,10 +377,6 @@ export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extend
 		return createAsyncDescriptor2('vs/languages/typescript/common/typescriptWorker2', 'TypeScriptWorker2');
 	}
 
-	public getCommentsConfiguration():Modes.ICommentsConfiguration {
-		return { lineCommentTokens: ['//'], blockCommentStartToken: '/*', blockCommentEndToken: '*/' };
-	}
-
 	static $_pickAWorkerToValidate = OneWorkerAttr(TypeScriptMode, TypeScriptMode.prototype._pickAWorkerToValidate, TypeScriptMode.prototype._syncProjects, ThreadAffinity.Group3);
 	public _pickAWorkerToValidate(): WinJS.Promise {
 		return this._worker((w) => w.enableValidator());
@@ -432,11 +438,6 @@ export class TypeScriptMode<W extends typescriptWorker.TypeScriptWorker2> extend
 		return this._worker((w) => w.getEmitOutput(resource, type));
 	}
 
-	private static WORD_DEFINITION = createWordRegExp('$');
-	public getWordDefinition():RegExp {
-		return TypeScriptMode.WORD_DEFINITION;
-	}
-
 	static $findReferences = OneWorkerAttr(TypeScriptMode, TypeScriptMode.prototype.findReferences, TypeScriptMode.prototype._syncProjects, ThreadAffinity.Group3);
 	public findReferences(resource:URI, position:EditorCommon.IPosition, includeDeclaration:boolean):WinJS.TPromise<Modes.IReference[]> {
 		return this._worker((w) => w.findReferences(resource, position, includeDeclaration));

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/common/typescriptWorker2.ts
code:
@@ -15,7 +15,6 @@ import objects = require('vs/base/common/objects');
 import ts = require('vs/languages/typescript/common/lib/typescriptServices');
 import Options = require('vs/languages/typescript/common/options');
 import typescript = require('vs/languages/typescript/common/typescript');
-import supports = require('vs/editor/common/modes/supports');
 import projectService = require('vs/languages/typescript/common/project/projectService');
 import format = require('vs/languages/typescript/common/features/format');
 import logicalSelection = require('vs/languages/typescript/common/features/logicalSelection');
@@ -32,6 +31,7 @@ import emitting = require('vs/languages/typescript/common/features/emitting');
 import rename = require('vs/languages/typescript/common/features/rename');
 import {IResourceService, ResourceEvents, IResourceAddedEvent, IResourceRemovedEvent} from 'vs/editor/common/services/resourceService';
 import {IMarker, IMarkerService} from 'vs/platform/markers/common/markers';
+import {WorkerInplaceReplaceSupport, ReplaceSupport} from 'vs/editor/common/modes/supports/inplaceReplaceSupport';
 
 export class TypeScriptWorker2 extends AbstractModeWorker {
 
@@ -150,7 +150,7 @@ export class TypeScriptWorker2 extends AbstractModeWorker {
 	// ---- Implementation of various IXYZSupports
 
 	protected _createInPlaceReplaceSupport(): Modes.IInplaceReplaceSupport {
-		return new supports.WorkerInplaceReplaceSupport(this.resourceService, this);
+		return new WorkerInplaceReplaceSupport(this.resourceService, this);
 	}
 
 	public doValidate(resource: URI): void {
@@ -257,7 +257,7 @@ export class TypeScriptWorker2 extends AbstractModeWorker {
 			['string', 'number', 'boolean', 'void', 'any'],
 			['private', 'public']
 		];
-		return supports.ReplaceSupport.valueSetsReplace(valueSets, value, up);
+		return ReplaceSupport.valueSetsReplace(valueSets, value, up);
 	}
 
 	public findReferences(resource: URI, position: EditorCommon.IPosition, includeDeclaration: boolean): winjs.TPromise<Modes.IReference[]> {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/languages/typescript/test/common/tokenization.test.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import 'vs/languages/javascript/common/javascript.contribution';
 
-import javascriptMode = require('vs/languages/javascript/common/javascript');
 import EditorCommon = require('vs/editor/common/editorCommon');
 import Modes = require('vs/editor/common/modes');
 import modesUtil = require('vs/editor/test/common/modesUtil');
@@ -19,7 +19,7 @@ suite('TS/JS - syntax highlighting', () => {
 	setup((done) => {
 		modesUtil.load('javascript').then(mode => {
 			tokenizationSupport = mode.tokenizationSupport;
-			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.onEnterSupport);
+			assertOnEnter = modesUtil.createOnEnterAsserter(mode.getId(), mode.richEditSupport);
 			done();
 		});
 	});

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/plugins/common/ipcRemoteCom.ts
code:
@@ -136,7 +136,7 @@ export function create(send: (obj: string[]) => void): IPluginsIPC {
 
 	let r: IPluginsIPC = {
 		callOnRemote: rpc,
-		registerBigHandler: (_bigHandler: remote.IManyHandler): void => {
+		setManyHandler: (_bigHandler: remote.IManyHandler): void => {
 			bigHandler = _bigHandler;
 		},
 		handle: (rawmsg) => {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/thread/common/abstractThreadService.ts
code:
@@ -139,7 +139,7 @@ export abstract class AbstractThreadService implements remote.IManyHandler {
 		if (this._proxyObjMap[id]) {
 			return this._proxyObjMap[id];
 		}
-		let result = remote.createProxyFromCtor(remoteCom, id, descriptor.ctor);
+		let result = createProxyFromCtor(remoteCom, id, descriptor.ctor);
 		this._proxyObjMap[id] = result;
 		return result;
 	}
@@ -207,4 +207,22 @@ export abstract class AbstractThreadService implements remote.IManyHandler {
 	protected abstract _registerPluginHostActor<T>(id: string, actor: T): void;
 	protected abstract _registerAndInstantiateWorkerActor<T>(id: string, descriptor: SyncDescriptor0<T>, whichWorker: ThreadAffinity): T;
 	protected abstract _registerWorkerActor<T>(id: string, actor: T): void;
-}
\ No newline at end of file
+}
+
+function createProxyFromCtor(remote:remote.IProxyHelper, id:string, ctor:Function): any {
+	var result: any = {
+		$__IS_REMOTE_OBJ: true
+	};
+	for (var prop in ctor.prototype) {
+		if (typeof ctor.prototype[prop] === 'function') {
+			result[prop] = createMethodProxy(remote, id, prop);
+		}
+	}
+	return result;
+}
+
+function createMethodProxy(remote:remote.IProxyHelper, proxyId: string, path: string): (...myArgs: any[]) => TPromise<any> {
+	return (...myArgs: any[]) => {
+		return remote.callOnRemote(proxyId, path, myArgs);
+	};
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/thread/common/mainThreadService.ts
code:
@@ -164,7 +164,7 @@ export class MainThreadService extends abstractThreadService.AbstractThreadServi
 			},
 			workerId
 		);
-		worker.getRemoteCom().registerBigHandler(this);
+		worker.getRemoteCom().setManyHandler(this);
 		worker.onModuleLoaded = worker.request('initialize', {
 			threadService: this._getRegisteredObjectsData(),
 			contextService: {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/thread/common/pluginHostThreadService.ts
code:
@@ -19,7 +19,7 @@ export class PluginHostThreadService extends abstractThreadService.AbstractThrea
 	constructor(remoteCom: remote.IRemoteCom) {
 		super(false);
 		this._remoteCom = remoteCom;
-		this._remoteCom.registerBigHandler(this);
+		this._remoteCom.setManyHandler(this);
 
 		// Register all statically instantiated synchronizable objects
 		readThreadSynchronizableObjects().forEach((obj) => this.registerInstance(obj));

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/thread/common/workerThreadService.ts
code:
@@ -25,7 +25,7 @@ export class WorkerThreadService extends abstractThreadService.AbstractThreadSer
 		super(false);
 		this._mainThreadData = mainThreadData;
 		this._remoteCom = remoteCom;
-		this._remoteCom.registerBigHandler(this);
+		this._remoteCom.setManyHandler(this);
 
 		this._publisher = workerPublisher;
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/platform/workspace/common/workspace.ts
code:
@@ -92,6 +92,9 @@ export interface IEnvironment {
 	isBuilt: boolean;
 	execPath: string;
 
+	applicationName: string;
+	darwinBundleIdentifier: string;
+
 	version: string;
 	commitHash: string;
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/api/node/extHost.api.impl.ts
code:
@@ -5,7 +5,6 @@
 'use strict';
 
 import {Emitter} from 'vs/base/common/event';
-import {IBracketElectricCharacterContribution} from 'vs/editor/common/modes/supports';
 import {score} from 'vs/editor/common/modes/languageSelector';
 import {Remotable, IThreadService} from 'vs/platform/thread/common/thread';
 import * as errors from 'vs/base/common/errors';
@@ -26,8 +25,6 @@ import {registerApiCommands} from 'vs/workbench/api/node/extHostApiCommands';
 import * as extHostTypes from 'vs/workbench/api/node/extHostTypes';
 import Modes = require('vs/editor/common/modes');
 import {IModeService} from 'vs/editor/common/services/modeService';
-import {ICommentsSupportContribution, ITokenTypeClassificationSupportContribution} from 'vs/editor/common/modes/supports';
-import {IOnEnterSupportOptions} from 'vs/editor/common/modes/supports/onEnter';
 import URI from 'vs/base/common/uri';
 import Severity from 'vs/base/common/severity';
 import {IDisposable} from 'vs/base/common/lifecycle';
@@ -395,104 +392,21 @@ export class ExtHostAPIImplementation {
 
 	private _setLanguageConfiguration(modeId: string, configuration: vscode.LanguageConfiguration): vscode.Disposable {
 
-		let disposables: IDisposable[] = [];
-		let {comments, wordPattern} = configuration;
-
-		// comment configuration
-		if (comments) {
-			let contrib: ICommentsSupportContribution = { commentsConfiguration: {} };
-			if (comments.lineComment) {
-				contrib.commentsConfiguration.lineCommentTokens = [comments.lineComment];
-			}
-			if (comments.blockComment) {
-				let [blockStart, blockEnd] = comments.blockComment;
-				contrib.commentsConfiguration.blockCommentStartToken = blockStart;
-				contrib.commentsConfiguration.blockCommentEndToken = blockEnd;
-			}
-			let d = this.Modes_CommentsSupport_register(modeId, contrib);
-			disposables.push(d);
-		}
+		let {wordPattern} = configuration;
 
 		// word definition
 		if (wordPattern) {
 			setWordDefinitionFor(modeId, wordPattern);
-			let d = this.Modes_TokenTypeClassificationSupport_register(modeId, {
-				wordDefinition: wordPattern
-			});
-			disposables.push(d);
-
 		} else {
 			setWordDefinitionFor(modeId, null);
 		}
 
-		// on enter
-		let onEnter: IOnEnterSupportOptions = {};
-		let empty = true;
-		let {brackets, indentationRules, onEnterRules} = configuration;
-
-		if (brackets) {
-			empty = false;
-			onEnter.brackets = brackets.map(pair => {
-				let [open, close] = pair;
-				return { open, close };
-			});
-		}
-		if (indentationRules) {
-			empty = false;
-			onEnter.indentationRules = indentationRules;
-		}
-		if (onEnterRules) {
-			empty = false;
-			onEnter.regExpRules = <any>onEnterRules;
-		}
-
-		if (!empty) {
-			let d = this.Modes_OnEnterSupport_register(modeId, onEnter);
-			disposables.push(d);
-		}
-
-		if (configuration.__electricCharacterSupport) {
-			disposables.push(
-				this.Modes_ElectricCharacterSupport_register(modeId, configuration.__electricCharacterSupport)
-			);
-		}
-
-		if (configuration.__characterPairSupport) {
-			disposables.push(
-				this.Modes_CharacterPairSupport_register(modeId, configuration.__characterPairSupport)
-			);
-		}
-
-		return extHostTypes.Disposable.from(...disposables);
+		return this.Modes_RichEditSupport_register(modeId, configuration);
 	}
 
-	private Modes_CommentsSupport_register(modeId: string, commentsSupport: ICommentsSupportContribution): IDisposable {
+	private Modes_RichEditSupport_register(modeId: string, configuration:vscode.LanguageConfiguration): IDisposable {
 		let disposeToken = ExtHostAPIImplementation.generateDisposeToken();
-		this._proxy.Modes_CommentsSupport_register(disposeToken, modeId, commentsSupport);
-		return this._disposableFromToken(disposeToken);
-	}
-
-	private Modes_TokenTypeClassificationSupport_register(modeId: string, tokenTypeClassificationSupport:ITokenTypeClassificationSupportContribution): IDisposable {
-		let disposeToken = ExtHostAPIImplementation.generateDisposeToken();
-		this._proxy.Modes_TokenTypeClassificationSupport_register(disposeToken, modeId, tokenTypeClassificationSupport);
-		return this._disposableFromToken(disposeToken);
-	}
-
-	private Modes_ElectricCharacterSupport_register(modeId: string, electricCharacterSupport:IBracketElectricCharacterContribution): IDisposable {
-		let disposeToken = ExtHostAPIImplementation.generateDisposeToken();
-		this._proxy.Modes_ElectricCharacterSupport_register(disposeToken, modeId, electricCharacterSupport);
-		return this._disposableFromToken(disposeToken);
-	}
-
-	private Modes_CharacterPairSupport_register(modeId: string, characterPairSupport:Modes.ICharacterPairContribution): IDisposable {
-		let disposeToken = ExtHostAPIImplementation.generateDisposeToken();
-		this._proxy.Modes_CharacterPairSupport_register(disposeToken, modeId, characterPairSupport);
-		return this._disposableFromToken(disposeToken);
-	}
-
-	private Modes_OnEnterSupport_register(modeId: string, opts: IOnEnterSupportOptions): IDisposable {
-		let disposeToken = ExtHostAPIImplementation.generateDisposeToken();
-		this._proxy.Modes_OnEnterSupport_register(disposeToken, modeId, opts);
+		this._proxy.Modes_RichEditSupport_register(disposeToken, modeId, configuration);
 		return this._disposableFromToken(disposeToken);
 	}
 }
@@ -562,23 +476,7 @@ export class MainProcessVSCodeAPIHelper {
 		}
 	}
 
-	public Modes_CommentsSupport_register(disposeToken:string, modeId: string, commentsSupport: ICommentsSupportContribution): void {
-		this._token2Dispose[disposeToken] = this._modeService.registerDeclarativeCommentsSupport(modeId, commentsSupport);
-	}
-
-	public Modes_TokenTypeClassificationSupport_register(disposeToken:string, modeId: string, tokenTypeClassificationSupport:ITokenTypeClassificationSupportContribution): void {
-		this._token2Dispose[disposeToken] = this._modeService.registerDeclarativeTokenTypeClassificationSupport(modeId, tokenTypeClassificationSupport);
-	}
-
-	public Modes_ElectricCharacterSupport_register(disposeToken:string, modeId: string, electricCharacterSupport:IBracketElectricCharacterContribution): void {
-		this._token2Dispose[disposeToken] = this._modeService.registerDeclarativeElectricCharacterSupport(modeId, electricCharacterSupport);
-	}
-
-	public Modes_CharacterPairSupport_register(disposeToken:string, modeId: string, characterPairSupport:Modes.ICharacterPairContribution): void {
-		this._token2Dispose[disposeToken] = this._modeService.registerDeclarativeCharacterPairSupport(modeId, characterPairSupport);
-	}
-
-	public Modes_OnEnterSupport_register(disposeToken:string, modeId: string, opts:IOnEnterSupportOptions): void {
-		this._token2Dispose[disposeToken] = this._modeService.registerDeclarativeOnEnterSupport(modeId, <any>opts);
+	public Modes_RichEditSupport_register(disposeToken:string, modeId: string, configuration:vscode.LanguageConfiguration): void {
+		this._token2Dispose[disposeToken] = this._modeService.registerRichEditSupport(modeId, <any>configuration);
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/api/node/extHostLanguages.ts
code:
@@ -6,15 +6,15 @@
 
 import {TPromise} from 'vs/base/common/winjs.base';
 import {Remotable, IThreadService} from 'vs/platform/thread/common/thread';
-import {IEditorModesRegistry, Extensions} from 'vs/editor/common/modes/modesRegistry';
-import {Registry} from 'vs/platform/platform';
-import {INullService} from 'vs/platform/instantiation/common/instantiation';
+import {IModeService} from 'vs/editor/common/services/modeService';
 
 export class ExtHostLanguages {
 
 	private _proxy: MainThreadLanguages;
 
-	constructor( @IThreadService threadService: IThreadService) {
+	constructor(
+		@IThreadService threadService: IThreadService
+	) {
 		this._proxy = threadService.getRemotable(MainThreadLanguages);
 	}
 
@@ -26,13 +26,15 @@ export class ExtHostLanguages {
 @Remotable.MainContext('MainThreadLanguages')
 export class MainThreadLanguages {
 
-	private _registry: IEditorModesRegistry;
+	private _modeService: IModeService;
 
-	constructor(@INullService ns) {
-		this._registry = Registry.as(Extensions.EditorModes);
+	constructor(
+		@IModeService modeService: IModeService
+	) {
+		this._modeService = modeService;
 	}
 
 	_getLanguages(): TPromise<string[]> {
-		return TPromise.as(this._registry.getRegisteredModes());
+		return TPromise.as(this._modeService.getRegisteredModes());
 	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/browser/parts/editor/editorStatus.ts
code:
@@ -16,8 +16,6 @@ import uri from 'vs/base/common/uri';
 import errors = require('vs/base/common/errors');
 import {IStatusbarItem} from 'vs/workbench/browser/parts/statusbar/statusbar';
 import {Action} from 'vs/base/common/actions';
-import {IEditorModesRegistry, Extensions} from 'vs/editor/common/modes/modesRegistry';
-import {Registry} from 'vs/platform/platform';
 import {UntitledEditorInput} from 'vs/workbench/common/editor/untitledEditorInput';
 import {IFileEditorInput, EncodingMode, IEncodingSupport, asFileEditorInput, getUntitledOrFileResource} from 'vs/workbench/common/editor';
 import {IDisposable, combinedDispose} from 'vs/base/common/lifecycle';
@@ -203,7 +201,8 @@ export class EditorStatus implements IStatusbarItem {
 		@IWorkbenchEditorService private editorService: IWorkbenchEditorService,
 		@IQuickOpenService private quickOpenService: IQuickOpenService,
 		@IInstantiationService private instantiationService: IInstantiationService,
-		@IEventService private eventService: IEventService
+		@IEventService private eventService: IEventService,
+		@IModeService private modeService: IModeService
 	) {
 		this.toDispose = [];
 		this.state = new State();
@@ -374,13 +373,11 @@ export class EditorStatus implements IStatusbarItem {
 			let editorWidget = e.getControl();
 			let textModel = getTextModel(editorWidget);
 			if (textModel) {
-				let modesRegistry = <IEditorModesRegistry>Registry.as(Extensions.EditorModes);
-
 				// Compute mode
 				if (!!(<ITokenizedModel>textModel).getMode) {
 					let mode = (<ITokenizedModel>textModel).getMode();
 					if (mode) {
-						info = { mode: modesRegistry.getLanguageName(mode.getId()) };
+						info = { mode: this.modeService.getLanguageName(mode.getId()) };
 					}
 				}
 			}
@@ -540,8 +537,7 @@ export class ChangeModeAction extends Action {
 	}
 
 	public run(): TPromise<any> {
-		let modesRegistry = <IEditorModesRegistry>Registry.as(Extensions.EditorModes);
-		let languages = modesRegistry.getRegisteredLanguageNames();
+		let languages = this.modeService.getRegisteredLanguageNames();
 		let activeEditor = this.editorService.getActiveEditor();
 		if (!(activeEditor instanceof BaseTextEditor)) {
 			return this.quickOpenService.pick([{ label: nls.localize('noEditor', "No text editor active at this time") }]);
@@ -555,7 +551,7 @@ export class ChangeModeAction extends Action {
 		if (!!(<ITokenizedModel>textModel).getMode) {
 			let mode = (<ITokenizedModel>textModel).getMode();
 			if (mode) {
-				currentModeId = modesRegistry.getLanguageName(mode.getId());
+				currentModeId = this.modeService.getLanguageName(mode.getId());
 			}
 		}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/buildfile.js
code:
@@ -37,6 +37,8 @@ exports.collectModules= function(excludes) {
 		createModuleDescription('vs/workbench/parts/debug/browser/debugViewlet', excludes),
 		createModuleDescription('vs/workbench/parts/debug/browser/repl', excludes),
 
+		createModuleDescription('vs/workbench/parts/errorList/browser/errorList', excludes),
+
 		createModuleDescription('vs/workbench/services/search/node/searchApp', []),
 		createModuleDescription('vs/workbench/services/files/node/watcher/unix/watcherApp', []),
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/common/editor/textEditorModel.ts
code:
@@ -9,8 +9,6 @@ import types = require('vs/base/common/types');
 import {EndOfLinePreference, IModel, EventType} from 'vs/editor/common/editorCommon';
 import {IMode} from 'vs/editor/common/modes';
 import {EditorModel} from 'vs/workbench/common/editor';
-import {Registry} from 'vs/platform/platform';
-import {IEditorModesRegistry, Extensions} from 'vs/editor/common/modes/modesRegistry';
 import URI from 'vs/base/common/uri';
 import {NullMode} from 'vs/editor/common/modes/nullMode';
 import {ITextEditorModel} from 'vs/platform/editor/common/editor';
@@ -105,16 +103,14 @@ export abstract class BaseTextEditorModel extends EditorModel implements ITextEd
 	 * This is a no-op if neither the value did not change nor the mime.
 	 */
 	protected updateTextEditorModel(newValue?: string, newMime?: string): void {
-		let modesRegistry = <IEditorModesRegistry>Registry.as(Extensions.EditorModes);
-
 		// Detect content changes
 		let currentModelValue = this.getValue();
 		let valueChanged = (!types.isUndefinedOrNull(newValue) && currentModelValue !== newValue);
 
 		// Detect mode changes
 		let modeChanged = false;
 		if (!types.isUndefinedOrNull(newMime)) {
-			let modeId = modesRegistry.getModeId(newMime);
+			let modeId = this.modeService.getModeId(newMime);
 			let currentMode = this.textEditorModel.getMode();
 			if (currentMode && currentMode.getId() !== NullMode.ID && modeId) {
 				let currentModeId = currentMode.getId();

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/common/editor/untitledEditorInput.ts
code:
@@ -6,16 +6,15 @@
 
 import {TPromise} from 'vs/base/common/winjs.base';
 import URI from 'vs/base/common/uri';
-import {IEditorModesRegistry, Extensions} from 'vs/editor/common/modes/modesRegistry';
 import {isUnspecific, guessMimeTypes, MIME_TEXT, suggestFilename} from 'vs/base/common/mime';
 import labels = require('vs/base/common/labels');
 import paths = require('vs/base/common/paths');
 import {UntitledEditorInput as AbstractUntitledEditorInput, EditorModel, EncodingMode, IInputStatus} from 'vs/workbench/common/editor';
-import {Registry} from 'vs/platform/platform';
 import {UntitledEditorModel} from 'vs/workbench/common/editor/untitledEditorModel';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {ILifecycleService} from 'vs/platform/lifecycle/common/lifecycle';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
+import {IModeService} from 'vs/editor/common/services/modeService';
 
 /**
  * An editor input to be used for untitled text buffers.
@@ -36,7 +35,8 @@ export class UntitledEditorInput extends AbstractUntitledEditorInput {
 		modeId: string,
 		@IInstantiationService private instantiationService: IInstantiationService,
 		@ILifecycleService private lifecycleService: ILifecycleService,
-		@IWorkspaceContextService private contextService: IWorkspaceContextService
+		@IWorkspaceContextService private contextService: IWorkspaceContextService,
+		@IModeService private modeService: IModeService
 	) {
 		super();
 
@@ -87,9 +87,7 @@ export class UntitledEditorInput extends AbstractUntitledEditorInput {
 
 	public getMime(): string {
 		if (this.cachedModel) {
-			let modesRegistry = <IEditorModesRegistry>Registry.as(Extensions.EditorModes);
-
-			return modesRegistry.getMimeForMode(this.cachedModel.getModeId());
+			return this.modeService.getMimeForMode(this.cachedModel.getModeId());
 		}
 
 		return null;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-browser/darwin/cli.contribution.ts
code:
@@ -0,0 +1,210 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+import * as nls from 'vs/nls';
+import * as path from 'path';
+import * as fs from 'fs';
+import * as os from 'os';
+import * as cp from 'child_process';
+import * as pfs from 'vs/base/node/pfs';
+import { nfcall } from 'vs/base/common/async';
+import { TPromise } from 'vs/base/common/winjs.base';
+import URI from 'vs/base/common/uri';
+import { Action } from 'vs/base/common/actions';
+import { IWorkbenchActionRegistry, Extensions as ActionExtensions } from 'vs/workbench/common/actionRegistry';
+import { IWorkbenchContributionsRegistry, IWorkbenchContribution, Extensions as WorkbenchExtensions } from 'vs/workbench/common/contributions';
+import { Registry } from 'vs/platform/platform';
+import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
+import { IWorkspaceContextService } from 'vs/workbench/services/workspace/common/contextService';
+import { IMessageService, Severity } from 'vs/platform/message/common/message';
+import { IEditorService } from 'vs/platform/editor/common/editor';
+import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
+
+function ignore<T>(code: string, value: T = null): (err: any) => TPromise<T> {
+	return err => err.code === code ? TPromise.as<T>(value) : TPromise.wrapError<T>(err);
+}
+
+const root = URI.parse(require.toUrl('')).fsPath;
+const source = path.resolve(root, '..', 'bin', 'code');
+const isAvailable = fs.existsSync(source);
+
+class InstallAction extends Action {
+
+	static ID = 'workbench.action.installCommandLine';
+	static LABEL = nls.localize('install', 'Install in PATH');
+
+	constructor(
+		id: string,
+		label: string,
+		@IWorkspaceContextService private contextService: IWorkspaceContextService,
+		@IMessageService private messageService: IMessageService,
+		@IEditorService private editorService: IEditorService
+	) {
+		super(id, label);
+	}
+
+	private get applicationName(): string {
+		return this.contextService.getConfiguration().env.applicationName;
+	}
+
+	private get target(): string {
+		return `/usr/local/bin/${ this.applicationName }`;
+	}
+
+	run(): TPromise<void> {
+		return this.checkLegacy()
+			.then(files => {
+				if (files.length > 0) {
+					const file = files[0];
+					const resource = URI.create('file', null, file);
+					const message = nls.localize('exists', "Please remove the 'code' alias in '{0}' and retry this action.", file);
+					const input = { resource, mime: 'text/x-shellscript' };
+					const actions = [
+						new Action('inlineEdit', nls.localize('editFile', "Edit '{0}'", file), '', true, () => {
+							return this.editorService.openEditor(input).then(() => {
+								const message = nls.localize('again', "Once you remove the 'code' alias, you can retry the PATH installation.");
+								const actions = [
+									new Action('cancel', nls.localize('cancel', "Cancel")),
+									new Action('yes', nls.localize('retry', "Retry"), '', true, () => this.run())
+								];
+
+								this.messageService.show(Severity.Info, { message, actions });
+							});
+						})
+					];
+
+					this.messageService.show(Severity.Warning, { message, actions });
+					return TPromise.as(null);
+				}
+
+				return this.isInstalled()
+					.then(isInstalled => {
+						if (!isAvailable || isInstalled) {
+							return TPromise.as(null);
+						} else {
+							const createSymlink = () => {
+								return pfs.unlink(this.target)
+									.then(null, ignore('ENOENT'))
+									.then(() => pfs.symlink(source, this.target));
+							};
+
+							return createSymlink().then(null, err => {
+								if (err.code === 'EACCES' || err.code === 'ENOENT') {
+									return this.createBinFolder()
+										.then(() => createSymlink());
+								}
+
+								return TPromise.wrapError(err);
+							});
+						}
+					})
+					.then(() => this.messageService.show(Severity.Info, nls.localize('success', 'Shortcut \'{0}\' successfully installed in PATH.', this.applicationName)));
+			});
+	}
+
+	private isInstalled(): TPromise<boolean> {
+		return pfs.lstat(this.target)
+			.then(stat => stat.isSymbolicLink())
+			.then(() => pfs.readlink(this.target))
+			.then(link => link === source)
+			.then(null, ignore('ENOENT', false));
+	}
+
+	private createBinFolder(): TPromise<void> {
+		const command = 'osascript -e "do shell script \\"mkdir -p /usr/local/bin && chown \\" & (do shell script (\\"whoami\\")) & \\" /usr/local/bin\\" with administrator privileges"';
+
+		return nfcall(cp.exec, command, {})
+			.then(null, _ => TPromise.wrapError(new Error(nls.localize('cantCreateBinFolder', "Unable to create '/usr/local/bin'."))));
+	}
+
+	public checkLegacy(): TPromise<string[]> {
+		const readOrEmpty = name => pfs.readFile(name, 'utf8')
+			.then(null, ignore('ENOENT', ''));
+
+		const files = [
+			path.join(os.homedir(), '.bash_profile'),
+			path.join(os.homedir(), '.bashrc'),
+			path.join(os.homedir(), '.zshrc')
+		];
+
+		return TPromise.join(files.map(f => readOrEmpty(f))).then(result => {
+			return result.reduce((result, contents, index) => {
+				const env = this.contextService.getConfiguration().env;
+
+				if (contents.indexOf(env.darwinBundleIdentifier) > -1) {
+					result.push(files[index]);
+				}
+
+				return result;
+			}, []);
+		});
+	}
+}
+
+class UninstallAction extends Action {
+
+	static ID = 'workbench.action.uninstallCommandLine';
+	static LABEL = nls.localize('uninstall', 'Uninstall from PATH');
+
+	constructor(
+		id: string,
+		label: string,
+		@IWorkspaceContextService private contextService: IWorkspaceContextService,
+		@IMessageService private messageService: IMessageService
+	) {
+		super(id, label);
+	}
+
+	private get applicationName(): string {
+		return this.contextService.getConfiguration().env.applicationName;
+	}
+
+	private get target(): string {
+		return `/usr/local/bin/${ this.applicationName }`;
+	}
+
+	run(): TPromise<void> {
+		return pfs.unlink(this.target)
+			.then(null, ignore('ENOENT'))
+			.then(() => this.messageService.show(Severity.Info, nls.localize('success', 'Shortcut \'{0}\' successfully uninstalled from PATH.', this.applicationName)));
+	}
+}
+
+class DarwinCLIHelper implements IWorkbenchContribution {
+
+	constructor(
+		@IInstantiationService instantiationService: IInstantiationService,
+		@IMessageService messageService: IMessageService
+	) {
+		const installAction = instantiationService.createInstance(InstallAction, InstallAction.ID, InstallAction.LABEL);
+
+		installAction.checkLegacy().done(files => {
+			if (files.length > 0) {
+				const message = nls.localize('update', "Code needs to update the command line launcher. Would you like to do this now?");
+				const actions = [
+					new Action('later', nls.localize('now', "Later")),
+					new Action('now', nls.localize('now', "Update Now"), '', true, () => installAction.run())
+				];
+
+				messageService.show(Severity.Info, { message, actions });
+			}
+		});
+	}
+
+	getId(): string {
+		return 'darwin.cli';
+	}
+}
+
+if (isAvailable && process.platform === 'darwin') {
+	const category = nls.localize('commandLine', "Command Line");
+
+	const workbenchActionsRegistry = <IWorkbenchActionRegistry>Registry.as(ActionExtensions.WorkbenchActions);
+	workbenchActionsRegistry.registerWorkbenchAction(new SyncActionDescriptor(InstallAction, InstallAction.ID, InstallAction.LABEL), category);
+	workbenchActionsRegistry.registerWorkbenchAction(new SyncActionDescriptor(UninstallAction, UninstallAction.ID, UninstallAction.LABEL), category);
+
+	const workbenchRegistry = <IWorkbenchContributionsRegistry>Registry.as(WorkbenchExtensions.Workbench);
+	workbenchRegistry.registerWorkbenchContribution(DarwinCLIHelper);
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-browser/index.html
code:
@@ -162,7 +162,7 @@
 			// Load the loader and start loading the workbench
 			var rootUrl = uriFromPath(configuration.appRoot) + '/out';
 			// In the bundled version the nls plugin is packaged with the loader so the NLS Plugins
-			// loads as soon as the loader loads. To be able to have pseudo trnastation
+			// loads as soon as the loader loads. To be able to have pseudo translation
 			createScript(rootUrl + '/vs/loader.js', function() {
 				var nlsConfig = getNlsPluginConfiguration(configuration);
 				require.config({

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/cli.ts
code:
@@ -45,7 +45,7 @@ export function main(argv: string[]) {
 	} else if (argParser.hasFlag('version', 'v')) {
 		console.log(packageJson.version);
 	} else {
-		delete process.env['ELECTRON_RUN_AS_NODE'];
+		delete process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE'];
 		spawn(process.execPath, process.argv.slice(2), { detached: true, stdio: 'ignore' });
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/env.ts
code:
@@ -25,8 +25,10 @@ export interface IUpdateInfo {
 export interface IProductConfiguration {
 	nameShort: string;
 	nameLong: string;
+	applicationName: string;
 	win32AppUserModelId: string;
 	win32MutexName: string;
+	darwinBundleIdentifier: string;
 	dataFolderName: string;
 	downloadUrl: string;
 	updateUrl?: string;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/window.ts
code:
@@ -91,6 +91,8 @@ export interface IWindowConfiguration extends env.ICommandLineArguments {
 	execPath: string;
 	version: string;
 	appName: string;
+	applicationName: string;
+	darwinBundleIdentifier: string;
 	appSettingsHome: string;
 	appSettingsPath: string;
 	appKeybindingsPath: string;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/windows.ts
code:
@@ -585,6 +585,8 @@ export class WindowsManager {
 		configuration.filesToCreate = filesToCreate;
 		configuration.extensionsToInstall = extensionsToInstall;
 		configuration.appName = env.product.nameLong;
+		configuration.applicationName = env.product.applicationName;
+		configuration.darwinBundleIdentifier = env.product.darwinBundleIdentifier;
 		configuration.appRoot = env.appRoot;
 		configuration.version = env.version;
 		configuration.commitHash = env.product.commit;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/node/extensionPoints.ts
code:
@@ -11,14 +11,98 @@ import {TPromise} from 'vs/base/common/winjs.base';
 import {groupBy, values} from 'vs/base/common/collections';
 import paths = require('vs/base/common/paths');
 import json = require('vs/base/common/json');
-import {IPluginsMessageCollector} from 'vs/platform/plugins/common/pluginsRegistry';
+import Types = require('vs/base/common/types');
+import {IPluginsMessageCollector, IMessageCollector} from 'vs/platform/plugins/common/pluginsRegistry';
 import {isValidPluginDescription} from 'vs/platform/plugins/node/pluginVersionValidator';
 import * as semver from 'semver';
 
 const MANIFEST_FILE = 'package.json';
 
+const devMode = !!process.env['VSCODE_DEV'];
+interface NlsConfiguration {
+	locale: string;
+	pseudo: boolean;
+}
+const nlsConfig = function(): NlsConfiguration {
+	if (process.env['VSCODE_NLS_CONFIG']) {
+		try {
+			return JSON.parse(process.env['VSCODE_NLS_CONFIG']);
+		} catch (err) {
+			return {
+				locale: undefined,
+				pseudo: false
+			};
+		}
+	}
+}();
+
 export class PluginScanner {
 
+	private static findMessageBundle(basename: string): TPromise<string> {
+		return new TPromise<string>((c ,e, p) => {
+			function loop(basename: string, locale: string): void {
+				let toCheck = `${basename}.nls.${locale}.json`;
+				pfs.fileExists(toCheck).then(exists => {
+					if (exists) {
+						c(toCheck);
+					}
+					let index = locale.lastIndexOf('-');
+					if (index === -1) {
+						c(`${basename}.nls.json`);
+					} else {
+						locale = locale.substring(0, index);
+						loop(basename, locale);
+					}
+				});
+			}
+
+			if (devMode || nlsConfig.pseudo || !nlsConfig.locale) {
+				return c(basename + '.nls.json');
+			}
+			loop(basename, nlsConfig.locale);
+		});
+	}
+
+	/**
+	 * This routine make the following assumptions:
+	 * The root element is a object literal
+	 * Strings to replace are one values of a key. So for example string[] are ignored.
+	 * This is done to speed things up.
+	 */
+	private static replaceStrings<T>(literal: T, messages: { [key: string]: string; }, builder: IMessageCollector): void {
+		Object.keys(literal).forEach(key => {
+			if (literal.hasOwnProperty(key)) {
+				let value = literal[key];
+				if (Types.isString(value)) {
+					let str = <string>value;
+					let length = str.length;
+					if (length > 1 && str[0] === '%' && str[length - 1] === '%') {
+						let messageKey = str.substr(1, length - 2);
+						let message = messages[messageKey];
+						if (message) {
+							if (nlsConfig.pseudo) {
+								// FF3B and FF3D is the Unicode zenkaku representation for [ and ]
+								message = '\uFF3B' + message.replace(/[aouei]/g, '$&$&') + '\uFF3D';
+							}
+							literal[key] = message;
+						} else {
+							builder.warn(`Couldn't find message for key ${messageKey}.`);
+						}
+					}
+				} else if (Types.isObject(value)) {
+					PluginScanner.replaceStrings(value, messages, builder);
+				} else if (Types.isArray(value)) {
+					(<any[]>value).forEach(element => {
+						if (Types.isObject(element)) {
+							PluginScanner.replaceStrings(element, messages, builder);
+						}
+					});
+				}
+			}
+		});
+		return;
+	}
+
 	/**
 	 * Scan the plugin defined in `absoluteFolderPath`
 	 */
@@ -53,7 +137,31 @@ export class PluginScanner {
 					pluginDescFromFile.activationEvents.push('onLanguage:javascriptreact');
 				}
 			}
-			return pluginDescFromFile;
+
+			let extension = paths.extname(absoluteManifestPath);
+			let basename = absoluteManifestPath.substr(0, absoluteManifestPath.length - extension.length);
+			return pfs.fileExists(basename + '.nls' + extension).then(exists => {
+				if (!exists) {
+					return pluginDescFromFile;
+				}
+				return PluginScanner.findMessageBundle(basename).then(messageBundle => {
+					if (!messageBundle) {
+						return pluginDescFromFile;
+					}
+					return pfs.readFile(messageBundle).then(messageBundleContent => {
+						let errors: string[] = [];
+						let messages: { [key: string]: string; } = json.parse(messageBundleContent.toString(), errors);
+						if (errors.length > 0) {
+							errors.forEach((error) => {
+								builder.error('Failed to parse ' + messageBundle + ': ' + error);
+							});
+							return pluginDescFromFile;
+						}
+						PluginScanner.replaceStrings(pluginDescFromFile, messages, builder);
+						return pluginDescFromFile;
+					});
+				});
+			});
 		}).then((pluginDescFromFile) => {
 			if (pluginDescFromFile === null) {
 				return null;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/debugEditorContribution.ts
code:
@@ -75,7 +75,7 @@ export class DebugEditorContribution implements editorcommon.IEditorContribution
 			if (e.target.type !== editorcommon.MouseTargetType.GUTTER_GLYPH_MARGIN || /* after last line */ e.target.detail) {
 				return;
 			}
-			if (!this.debugService.canSetBreakpointsIn(this.editor.getModel(), e.target.position.lineNumber)) {
+			if (!this.debugService.canSetBreakpointsIn(this.editor.getModel())) {
 				return;
 			}
 
@@ -98,7 +98,7 @@ export class DebugEditorContribution implements editorcommon.IEditorContribution
 
 		this.toDispose.push(this.editor.addListener2(editorcommon.EventType.MouseMove, (e: editorbrowser.IMouseEvent) => {
 			var showBreakpointHintAtLineNumber = -1;
-			if (e.target.type === editorcommon.MouseTargetType.GUTTER_GLYPH_MARGIN && this.debugService.canSetBreakpointsIn(this.editor.getModel(), e.target.position.lineNumber)) {
+			if (e.target.type === editorcommon.MouseTargetType.GUTTER_GLYPH_MARGIN && this.debugService.canSetBreakpointsIn(this.editor.getModel())) {
 				if (!e.target.detail) {
 					// is not after last line
 					showBreakpointHintAtLineNumber = e.target.position.lineNumber;
@@ -203,7 +203,7 @@ export class DebugEditorContribution implements editorcommon.IEditorContribution
 	// end hover business
 
 	private static BREAKPOINT_HELPER_DECORATION: editorcommon.IModelDecorationOptions = {
-		glyphMarginClassName: 'debug-breakpoint-glyph-hint',
+		glyphMarginClassName: 'debug-breakpoint-hint-glyph',
 		stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
 	};
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/debugEditorModelManager.ts
code:
@@ -7,7 +7,7 @@ import nls = require('vs/nls');
 import lifecycle = require('vs/base/common/lifecycle');
 import editorcommon = require('vs/editor/common/editorCommon');
 import { IWorkbenchContribution } from 'vs/workbench/common/contributions';
-import { IDebugService, ModelEvents, ViewModelEvents, IBreakpoint, IRawBreakpoint, State } from 'vs/workbench/parts/debug/common/debug';
+import { IDebugService, ModelEvents, ViewModelEvents, IBreakpoint, IRawBreakpoint, State, ServiceEvents } from 'vs/workbench/parts/debug/common/debug';
 import { IModelService } from 'vs/editor/common/services/modelService';
 
 function toMap(arr: string[]): { [key: string]: boolean; } {
@@ -36,6 +36,7 @@ interface IDebugEditorModelData {
 	breakpointDecorationsAsMap: { [decorationId: string]: boolean; };
 	currentStackDecorations: string[];
 	topStackFrameRange: editorcommon.IRange;
+	dirty: boolean;
 }
 
 export class DebugEditorModelManager implements IWorkbenchContribution {
@@ -80,6 +81,11 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 
 		this.toDispose.push(this.debugService.getModel().addListener2(ModelEvents.BREAKPOINTS_UPDATED, () => this.onBreakpointsChanged()));
 		this.toDispose.push(this.debugService.getViewModel().addListener2(ViewModelEvents.FOCUSED_STACK_FRAME_UPDATED, () => this.onFocusedStackFrameUpdated()));
+		this.toDispose.push(this.debugService.addListener2(ServiceEvents.STATE_CHANGED, () => {
+			if (this.debugService.getState() === State.Inactive) {
+				Object.keys(this.modelData).forEach(key => this.modelData[key].dirty = false);
+			}
+		}));
 	}
 
 	private onModelAdded(model: editorcommon.IModel): void {
@@ -99,7 +105,8 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 			breakpointLines: breakpoints.map(bp => bp.lineNumber),
 			breakpointDecorationsAsMap: toMap(breakPointDecorations),
 			currentStackDecorations: currentStackDecorations,
-			topStackFrameRange: null
+			topStackFrameRange: null,
+			dirty: false
 		};
 	}
 
@@ -182,7 +189,6 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 	}
 
 	// breakpoints management. Represent data coming from the debug service and also send data back.
-
 	private onModelDecorationsChanged(modelUrlStr: string, e: editorcommon.IModelDecorationsChangedEvent): void {
 		const modelData = this.modelData[modelUrlStr];
 		if (!e.addedOrChangedDecorations.some(d => modelData.breakpointDecorationsAsMap.hasOwnProperty(d.id))) {
@@ -214,6 +220,7 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 				});
 			}
 		}
+		modelData.dirty = !!this.debugService.getActiveSession();
 
 		this.debugService.setBreakpointsForModel(modelUrl, data);
 	}
@@ -260,15 +267,20 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 		const activated = this.debugService.getModel().areBreakpointsActivated();
 		const state = this.debugService.getState();
 		const debugActive = state === State.Running || state === State.Stopped || state === State.Initializing;
+		const modelData = this.modelData[breakpoint.source.uri.toString()];
+		const session = this.debugService.getActiveSession();
+
 		const result = (!breakpoint.enabled || !activated) ? DebugEditorModelManager.BREAKPOINT_DISABLED_DECORATION :
+			debugActive && modelData && modelData.dirty ? DebugEditorModelManager.BREAKPOINT_DIRTY_DECORATION :
 			debugActive && !breakpoint.verified ? DebugEditorModelManager.BREAKPOINT_UNVERIFIED_DECORATION :
 			!breakpoint.condition ? DebugEditorModelManager.BREAKPOINT_DECORATION : null;
 
-		return result ? result : {
-			glyphMarginClassName: 'debug-breakpoint-conditional-glyph',
-			hoverMessage: breakpoint.condition,
-			stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
-		};
+		return result ? result :
+			!session || session.capablities.supportsConditionalBreakpoints ? {
+				glyphMarginClassName: 'debug-breakpoint-conditional-glyph',
+				hoverMessage: breakpoint.condition,
+				stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
+			} : DebugEditorModelManager.BREAKPOINT_UNSUPPORTED_DECORATION;
 	}
 
 	// editor decorations
@@ -280,17 +292,29 @@ export class DebugEditorModelManager implements IWorkbenchContribution {
 	};
 
 	private static BREAKPOINT_DISABLED_DECORATION: editorcommon.IModelDecorationOptions = {
-		glyphMarginClassName: 'debug-breakpoint-glyph-disabled',
+		glyphMarginClassName: 'debug-breakpoint-disabled-glyph',
 		hoverMessage: nls.localize('breakpointDisabledHover', "Disabled Breakpoint"),
 		stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
 	};
 
 	private static BREAKPOINT_UNVERIFIED_DECORATION: editorcommon.IModelDecorationOptions = {
-		glyphMarginClassName: 'debug-breakpoint-glyph-unverified',
+		glyphMarginClassName: 'debug-breakpoint-unverified-glyph',
 		hoverMessage: nls.localize('breakpointDisabledHover', "Unverified Breakpoint"),
 		stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
 	};
 
+	private static BREAKPOINT_DIRTY_DECORATION: editorcommon.IModelDecorationOptions = {
+		glyphMarginClassName: 'debug-breakpoint-unverified-glyph',
+		hoverMessage: nls.localize('breakpointDisabledHover', "Unverified breakpoint. File is modified, please restart debug session."),
+		stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
+	};
+
+	private static BREAKPOINT_UNSUPPORTED_DECORATION: editorcommon.IModelDecorationOptions = {
+		glyphMarginClassName: 'debug-breakpoint-unsupported-glyph',
+		hoverMessage: nls.localize('breakpointUnsupported', "Conditional breakpoints not supported by this debug type"),
+		stickiness: editorcommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
+	};
+
 	// we need a separate decoration for glyph margin, since we do not want it on each line of a multi line statement.
 	private static TOP_STACK_FRAME_MARGIN: editorcommon.IModelDecorationOptions = {
 		glyphMarginClassName: 'debug-top-stack-frame-glyph',

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/debugHover.ts
code:
@@ -162,7 +162,7 @@ export class DebugHoverWidget implements editorbrowser.IContentWidget {
 		} else {
 			this.treeContainer.hidden = true;
 			this.valueContainer.hidden = false;
-			viewer.renderExpressionValue(expression, false, this.valueContainer, false);
+			viewer.renderExpressionValue(expression, this.valueContainer, false);
 			this.valueContainer.title = '';
 			this.editor.layoutContentWidget(this);
 		}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/debugViewer.ts
code:
@@ -36,15 +36,17 @@ const $ = dom.emmet;
 const booleanRegex = /^true|false$/i;
 const stringRegex = /^(['"]).*\1$/;
 
-export function renderExpressionValue(expressionOrValue: debug.IExpression|string, debugInactive: boolean, container: HTMLElement, showChanged: boolean): void {
+export function renderExpressionValue(expressionOrValue: debug.IExpression|string, container: HTMLElement, showChanged: boolean): void {
 	let value = typeof expressionOrValue === 'string' ? expressionOrValue : expressionOrValue.value;
 
 	// remove stale classes
 	container.className = 'value';
 	// when resolving expressions we represent errors from the server as a variable with name === null.
 	if (value === null || ((expressionOrValue instanceof model.Expression || expressionOrValue instanceof model.Variable) && !expressionOrValue.available)) {
 		dom.addClass(container, 'unavailable');
-		debugInactive ? dom.removeClass(container, 'error') : dom.addClass(container, 'error');
+		if (value !== model.Expression.DEFAULT_VALUE) {
+			dom.addClass(container, 'error');
+		}
 	} else if (!isNaN(+value)) {
 		dom.addClass(container, 'number');
 	} else if (booleanRegex.test(value)) {
@@ -61,13 +63,13 @@ export function renderExpressionValue(expressionOrValue: debug.IExpression|strin
 	container.title = value;
 }
 
-export function renderVariable(tree: tree.ITree, variable: model.Variable, data: IVariableTemplateData, debugInactive: boolean, showChanged: boolean): void {
+export function renderVariable(tree: tree.ITree, variable: model.Variable, data: IVariableTemplateData, showChanged: boolean): void {
 	if (variable.available) {
 		data.name.textContent = variable.name + ':';
 	}
 
 	if (variable.value) {
-		renderExpressionValue(variable, debugInactive, data.value, showChanged);
+		renderExpressionValue(variable, data.value, showChanged);
 	} else {
 		data.value.textContent = '';
 		data.value.title = '';
@@ -107,7 +109,7 @@ function renderRenameBox(debugService: debug.IDebugService, contextViewService:
 			tree.clearHighlight();
 			tree.DOMFocus();
 			tree.setFocus(element);
-			
+
 			// need to remove the input box since this template will be reused.
 			container.removeChild(inputBoxContainer);
 			lifecycle.disposeAll(toDispose);
@@ -402,10 +404,6 @@ export class VariablesRenderer implements tree.IRenderer {
 	private static SCOPE_TEMPLATE_ID = 'scope';
 	private static VARIABLE_TEMPLATE_ID = 'variable';
 
-	constructor(@debug.IDebugService private debugService: debug.IDebugService) {
-		// noop
-	}
-
 	public getHeight(tree: tree.ITree, element: any): number {
 		return 22;
 	}
@@ -441,7 +439,7 @@ export class VariablesRenderer implements tree.IRenderer {
 		if (templateId === VariablesRenderer.SCOPE_TEMPLATE_ID) {
 			this.renderScope(element, templateData);
 		} else {
-			renderVariable(tree, element, templateData, this.debugService.getState() === debug.State.Inactive, true);
+			renderVariable(tree, element, templateData, true);
 		}
 	}
 
@@ -610,7 +608,7 @@ export class WatchExpressionsRenderer implements tree.IRenderer {
 		if (templateId === WatchExpressionsRenderer.WATCH_EXPRESSION_TEMPLATE_ID) {
 			this.renderWatchExpression(tree, element, templateData);
 		} else {
-			renderVariable(tree, element, templateData, this.debugService.getState() === debug.State.Inactive, true);
+			renderVariable(tree, element, templateData, true);
 		}
 	}
 
@@ -623,7 +621,7 @@ export class WatchExpressionsRenderer implements tree.IRenderer {
 
 		data.name.textContent = `${watchExpression.name}:`;
 		if (watchExpression.value) {
-			renderExpressionValue(watchExpression, this.debugService.getState() === debug.State.Inactive, data.value, true);
+			renderExpressionValue(watchExpression, data.value, true);
 		}
 	}
 
@@ -662,7 +660,7 @@ export class WatchExpressionsController extends BaseDebugController {
 		}
 	}
 
-	/* protected */ public onLeftClick(tree: tree.ITree, element: any, event: mouse.StandardMouseEvent): boolean {
+	protected onLeftClick(tree: tree.ITree, element: any, event: mouse.StandardMouseEvent): boolean {
 		// double click on primitive value: open input box to be able to select and copy value.
 		if (element instanceof model.Expression && event.detail === 2) {
 			const expression = <debug.IExpression> element;
@@ -733,7 +731,9 @@ export class BreakpointsActionProvider implements renderer.IActionProvider {
 		const actions: actions.Action[] = [this.instantiationService.createInstance(debugactions.ToggleEnablementAction, debugactions.ToggleEnablementAction.ID, debugactions.ToggleEnablementAction.LABEL)];
 		actions.push(new actionbar.Separator());
 
-		actions.push(this.instantiationService.createInstance(debugactions.RemoveBreakpointAction, debugactions.RemoveBreakpointAction.ID, debugactions.RemoveBreakpointAction.LABEL));
+		if (element instanceof model.Breakpoint || element instanceof model.FunctionBreakpoint) {
+			actions.push(this.instantiationService.createInstance(debugactions.RemoveBreakpointAction, debugactions.RemoveBreakpointAction.ID, debugactions.RemoveBreakpointAction.LABEL));
+		}
 		actions.push(this.instantiationService.createInstance(debugactions.RemoveAllBreakpointsAction, debugactions.RemoveAllBreakpointsAction.ID, debugactions.RemoveAllBreakpointsAction.LABEL));
 		actions.push(new actionbar.Separator());
 
@@ -745,6 +745,9 @@ export class BreakpointsActionProvider implements renderer.IActionProvider {
 		actions.push(new actionbar.Separator());
 
 		actions.push(this.instantiationService.createInstance(debugactions.AddFunctionBreakpointAction, debugactions.AddFunctionBreakpointAction.ID, debugactions.AddFunctionBreakpointAction.LABEL));
+		if (element instanceof model.FunctionBreakpoint) {
+			actions.push(this.instantiationService.createInstance(debugactions.RenameFunctionBreakpointAction, debugactions.RenameFunctionBreakpointAction.ID, debugactions.RenameFunctionBreakpointAction.LABEL));
+		}
 		actions.push(new actionbar.Separator());
 
 		actions.push(this.instantiationService.createInstance(debugactions.ReapplyBreakpointsAction, debugactions.ReapplyBreakpointsAction.ID, debugactions.ReapplyBreakpointsAction.LABEL));
@@ -881,7 +884,8 @@ export class BreakpointsRenderer implements tree.IRenderer {
 	}
 
 	private renderFunctionBreakpoint(tree: tree.ITree, functionBreakpoint: debug.IFunctionBreakpoint, data: IFunctionBreakpointTemplateData): void {
-		if (!functionBreakpoint.name) {
+		const selected = this.debugService.getViewModel().getSelectedFunctionBreakpoint();
+		if (!functionBreakpoint.name || (selected && selected.getId() === functionBreakpoint.getId())) {
 			renderRenameBox(this.debugService, this.contextViewService, tree, functionBreakpoint, data.breakpoint, nls.localize('functionBreakpointPlaceholder', "Function to break on"), nls.localize('functionBreakPointInputAriaLabel', "Type function breakpoint"));
 		} else {
 			this.debugService.getModel().areBreakpointsActivated() ? tree.removeTraits('disabled', [functionBreakpoint]) : tree.addTraits('disabled', [functionBreakpoint]);
@@ -934,19 +938,24 @@ export class BreakpointsAccessibilityProvider implements tree.IAccessibilityProv
 
 export class BreakpointsController extends BaseDebugController {
 
-	/* protected */ public onLeftClick(tree:tree.ITree, element: any, eventish:treedefaults.ICancelableEvent, origin: string = 'mouse'):boolean {
+	protected onLeftClick(tree:tree.ITree, element: any, event: mouse.StandardMouseEvent): boolean {
 		if (element instanceof model.ExceptionBreakpoint) {
 			return false;
 		}
 
-		return super.onLeftClick(tree, element, eventish, origin);
+		if (element instanceof model.FunctionBreakpoint && event.detail === 2) {
+			this.debugService.getViewModel().setSelectedFunctionBreakpoint(element);
+			return true;
+		}
+
+		return super.onLeftClick(tree, element, event);
 	}
 
-	/* protected */ public onUp(tree:tree.ITree, event:keyboard.StandardKeyboardEvent): boolean {
+	protected onUp(tree:tree.ITree, event:keyboard.StandardKeyboardEvent): boolean {
 		return this.doNotFocusExceptionBreakpoint(tree, super.onUp(tree, event));
 	}
 
-	/* protected */ public onPageUp(tree:tree.ITree, event:keyboard.StandardKeyboardEvent): boolean {
+	protected onPageUp(tree:tree.ITree, event:keyboard.StandardKeyboardEvent): boolean {
 		return this.doNotFocusExceptionBreakpoint(tree, super.onPageUp(tree, event));
 	}
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/debugViewlet.ts
code:
@@ -165,12 +165,9 @@ class WatchExpressionsView extends viewlet.CollapsibleViewletView {
 
 			this.tree.refresh(expression, false).then(() => {
 				this.tree.setHighlight(expression);
-
-				const unbind = this.tree.addListener(events.EventType.HIGHLIGHT, (e: tree.IHighlightEvent) => {
+				this.tree.addOneTimeListener(events.EventType.HIGHLIGHT, (e: tree.IHighlightEvent) => {
 					if (!e.highlight) {
 						this.debugService.getViewModel().setSelectedExpression(null);
-						this.tree.refresh(expression).done(null, errors.onUnexpectedError);
-						unbind();
 					}
 				});
 			}).done(null, errors.onUnexpectedError);
@@ -192,8 +189,8 @@ class WatchExpressionsView extends viewlet.CollapsibleViewletView {
 class CallStackView extends viewlet.CollapsibleViewletView {
 
 	private static MEMENTO = 'callstackview.memento';
-	private messageBox: HTMLDivElement;
-	private fullSize: number;
+	private pauseMessage: builder.Builder;
+	private pauseMessageLabel: builder.Builder;
 
 	constructor(actionRunner: actions.IActionRunner, private settings: any,
 		@IMessageService messageService: IMessageService,
@@ -206,13 +203,15 @@ class CallStackView extends viewlet.CollapsibleViewletView {
 
 	public renderHeader(container: HTMLElement): void {
 		super.renderHeader(container);
-		const titleDiv = $('div.title').appendTo(container);
-		$('span').text(nls.localize('callStack', "Call Stack")).appendTo(titleDiv);
+		const title = $('div.debug-call-stack-title').appendTo(container);
+		$('span.title').text(nls.localize('callStack', "Call Stack")).appendTo(title);
+		this.pauseMessage = $('span.pause-message').appendTo(title);
+		this.pauseMessage.hide();
+		this.pauseMessageLabel = $('span.label').appendTo(this.pauseMessage);
 	}
 
 	public renderBody(container: HTMLElement): void {
 		dom.addClass(container, 'debug-call-stack');
-		this.renderMessageBox(container);
 		this.treeContainer = renderViewTree(container);
 
 		this.tree = new treeimpl.Tree(this.treeContainer, {
@@ -255,18 +254,12 @@ class CallStackView extends viewlet.CollapsibleViewletView {
 		}));
 		this.toDispose.push(this.debugService.getViewModel().addListener2(debug.ViewModelEvents.FOCUSED_STACK_FRAME_UPDATED, () => {
 			const focussedThread = this.debugService.getModel().getThreads()[this.debugService.getViewModel().getFocusedThreadId()];
-			const previouslyHidden = this.messageBox.hidden;
 			if (focussedThread && focussedThread.stoppedReason && focussedThread.stoppedReason !== 'step') {
-				this.messageBox.textContent = nls.localize('debugStopped', "Paused on {0}.", focussedThread.stoppedReason);
-				focussedThread.stoppedReason === 'exception' ? this.messageBox.classList.add('exception') : this.messageBox.classList.remove('exception');
-
-				this.messageBox.hidden = false;
+				this.pauseMessageLabel.text(nls.localize('debugStopped', "Paused on {0}", focussedThread.stoppedReason));
+				focussedThread.stoppedReason === 'exception' ? this.pauseMessageLabel.addClass('exception') : this.pauseMessageLabel.removeClass('exception');
+				this.pauseMessage.show();
 			} else {
-				this.messageBox.hidden = true;
-			}
-
-			if (previouslyHidden !== this.messageBox.hidden) {
-				this.layoutBody(this.fullSize);
+				this.pauseMessage.hide();
 			}
 		}));
 
@@ -284,19 +277,6 @@ class CallStackView extends viewlet.CollapsibleViewletView {
 		}));
 	}
 
-	public layoutBody(size: number): void {
-		this.fullSize = size;
-		const sizeWithRespectToMessageBox = this.messageBox && !this.messageBox.hidden ? size - 27 : size;
-		super.layoutBody(sizeWithRespectToMessageBox);
-	}
-
-	private renderMessageBox(container: HTMLElement): void {
-		this.messageBox = document.createElement('div');
-		dom.addClass(this.messageBox, 'debug-message-box');
-		this.messageBox.hidden = true;
-		container.appendChild(this.messageBox);
-	}
-
 	public shutdown(): void {
 		this.settings[CallStackView.MEMENTO] = (this.state === splitview.CollapsibleState.COLLAPSED);
 		super.shutdown();
@@ -391,6 +371,21 @@ class BreakpointsView extends viewlet.AdaptiveCollapsibleViewletView {
 				this.debugService.openOrRevealEditor(breakpoint.source, breakpoint.lineNumber, preserveFocus, sideBySide).done(null, errors.onUnexpectedError);
 			}
 		}));
+
+		this.toDispose.push(this.debugService.getViewModel().addListener2(debug.ViewModelEvents.SELECTED_FUNCTION_BREAKPOINT_UPDATED, (fbp: debug.IFunctionBreakpoint) => {
+			if (!fbp || !(fbp instanceof model.FunctionBreakpoint)) {
+				return;
+			}
+
+			this.tree.refresh(fbp, false).then(() => {
+				this.tree.setHighlight(fbp);
+				this.tree.addOneTimeListener(events.EventType.HIGHLIGHT, (e: tree.IHighlightEvent) => {
+					if (!e.highlight) {
+						this.debugService.getViewModel().setSelectedFunctionBreakpoint(null);
+					}
+				});
+			}).done(null, errors.onUnexpectedError);
+		}));
 	}
 
 	public getActions(): actions.IAction[] {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/media/breakpoint-unsupported-dark.svg
code:
@@ -1,5 +1,4 @@
 <?xml version="1.0" encoding="utf-8"?>
-<!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
 	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
 <style type="text/css">

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/media/breakpoint-unsupported.svg
code:
@@ -1,5 +1,4 @@
 <?xml version="1.0" encoding="utf-8"?>
-<!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
 	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
 <style type="text/css">

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/media/debug.contribution.css
code:
@@ -25,15 +25,15 @@
 	background: rgba(206, 231, 206, 0.45);
 }
 
-.monaco-editor .debug-breakpoint-glyph-hint {
+.monaco-editor .debug-breakpoint-hint-glyph {
 	background: url('breakpoint-hint.svg') center center no-repeat;
 }
 
-.monaco-editor .debug-breakpoint-glyph-disabled {
+.monaco-editor .debug-breakpoint-disabled-glyph {
 	background: url('breakpoint-disabled.svg') center center no-repeat;
 }
 
-.monaco-editor .debug-breakpoint-glyph-unverified {
+.monaco-editor .debug-breakpoint-unverified-glyph {
 	background: url('breakpoint-unverified.svg') center center no-repeat;
 }
 
@@ -53,6 +53,10 @@
 	background: url('breakpoint-conditional.svg') center center no-repeat;
 }
 
+.monaco-editor .debug-breakpoint-unsupported-glyph {
+	background: url('breakpoint-unsupported.svg') center center no-repeat;
+}
+
 .monaco-editor .debug-top-stack-frame-glyph.debug-breakpoint-glyph,
 .monaco-editor .debug-top-stack-frame-glyph.debug-breakpoint-conditional-glyph {
 	background: url('current-and-breakpoint.svg') center center no-repeat;
@@ -240,11 +244,15 @@
 	background: url('breakpoint-conditional-dark.svg') center center no-repeat;
 }
 
-.monaco-editor.vs-dark .debug-breakpoint-glyph-disabled {
+.monaco-editor.vs-dark .debug-breakpoint-unsupported-glyph {
+	background: url('breakpoint-unsupported-dark.svg') center center no-repeat;
+}
+
+.monaco-editor.vs-dark .debug-breakpoint-disabled-glyph {
 	background: url('breakpoint-disabled-dark.svg') center center no-repeat;
 }
 
-.monaco-editor.vs-dark .debug-breakpoint-glyph-unverified {
+.monaco-editor.vs-dark .debug-breakpoint-unverified-glyph {
 	background: url('breakpoint-unverified-dark.svg') center center no-repeat;
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/media/debugViewlet.css
code:
@@ -103,30 +103,38 @@
 
 /* Call stack */
 
-.debug-viewlet .debug-message-box {
-	border: 1px solid #F2CB1D;
-	border-style: solid none;
-	background: #F6F5D2;
-	padding: 0.4em 1em .3em 1.9em;
-	font-size: 8pt;
-	line-height: 18px;
+.debug-viewlet .debug-call-stack-title {
+	display: flex;
+}
+
+.debug-viewlet .debug-call-stack-title > .pause-message {
+	flex: 1;
+	text-align: right;
+	text-overflow: ellipsis;
+	overflow: hidden;
+	white-space: nowrap;
+	padding-left: 5px;
+}
 
-	-webkit-user-select: text;
+.debug-viewlet .debug-call-stack-title > .pause-message > .label {
+	border-radius: 3px;
+	padding: 1px 2px;
+	font-size: 9px;
 }
 
-.debug-viewlet .debug-message-box.exception {
-	border-color: #E51400;
-	background: #f2dede;
+.debug-viewlet .debug-call-stack-title > .pause-message > .label.exception {
+	background-color: #A31515;
+	color: rgb(255, 255, 255);
 }
 
-.vs-dark .debug-viewlet .debug-message-box {
-	border-color: #B89500;
-	background: #352A05;
+.vs-dark .debug-viewlet .debug-call-stack-title > .pause-message > .label.exception {
+	background-color: #6C2022;
+	color: inherit;
 }
 
-.vs-dark .debug-viewlet .debug-message-box.exception {
-	background-color: #5A1D1D;
-	border-color: #BE1100;
+.hc-black .debug-viewlet .debug-call-stack-title > .pause-message > .label.exception {
+	background-color: #6C2022;
+	color: inherit;
 }
 
 .debug-viewlet .debug-call-stack .stack-frame {
@@ -285,17 +293,6 @@
 	color: rgb(204, 204, 204);
 }
 
-.hc-black.monaco-workbench .debug-message-box {
-	border: 1px solid #B89500;
-	border-style: solid none;
-	background: #352A05;
-}
-
-.hc-black .debug-viewlet .debug-message-box.exception {
-	background-color: #5A1D1D;
-	border-color: #BE1100;
-}
-
 .hc-black .debug-viewlet .debug-action.remove {
 	content: url('remove-inverse.svg');
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/browser/replViewer.ts
code:
@@ -108,7 +108,6 @@ export class ReplExpressionsRenderer implements tree.IRenderer {
 	private characterWidth: number;
 
 	constructor(
-		@debug.IDebugService private debugService: debug.IDebugService,
 		@IWorkbenchEditorService private editorService: IWorkbenchEditorService,
 		@IWorkspaceContextService private contextService: IWorkspaceContextService
 	) {
@@ -202,7 +201,7 @@ export class ReplExpressionsRenderer implements tree.IRenderer {
 
 	public renderElement(tree: tree.ITree, element: any, templateId: string, templateData: any): void {
 		if (templateId === ReplExpressionsRenderer.VARIABLE_TEMPLATE_ID) {
-			debugviewer.renderVariable(tree, element, templateData, this.debugService.getState() === debug.State.Inactive, false);
+			debugviewer.renderVariable(tree, element, templateData, false);
 		} else if (templateId === ReplExpressionsRenderer.INPUT_OUTPUT_PAIR_TEMPLATE_ID) {
 			this.renderInputOutputPair(tree, element, templateData);
 		} else if (templateId === ReplExpressionsRenderer.VALUE_OUTPUT_TEMPLATE_ID) {
@@ -214,7 +213,7 @@ export class ReplExpressionsRenderer implements tree.IRenderer {
 
 	private renderInputOutputPair(tree: tree.ITree, expression: debug.IExpression, templateData: IInputOutputPairTemplateData): void {
 		templateData.input.textContent = expression.name;
-		debugviewer.renderExpressionValue(expression, this.debugService.getState() === debug.State.Inactive, templateData.value, false);
+		debugviewer.renderExpressionValue(expression, templateData.value, false);
 		if (expression.reference > 0) {
 			templateData.annotation.className = 'annotation octicon octicon-info';
 			templateData.annotation.title = nls.localize('stateCapture', "Object state is captured from first evaluation");
@@ -400,7 +399,7 @@ export class ReplExpressionsRenderer implements tree.IRenderer {
 		}
 
 		// value
-		debugviewer.renderExpressionValue(output.value, false, templateData.value, false);
+		debugviewer.renderExpressionValue(output.value, templateData.value, false);
 
 		// annotation if any
 		if (output.annotation) {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/common/debug.ts
code:
@@ -106,7 +106,8 @@ export var ModelEvents = {
 
 export var ViewModelEvents = {
 	FOCUSED_STACK_FRAME_UPDATED: 'FocusedStackFrameUpdated',
-	SELECTED_EXPRESSION_UPDATED: 'SelectedExpressionUpdated'
+	SELECTED_EXPRESSION_UPDATED: 'SelectedExpressionUpdated',
+	SELECTED_FUNCTION_BREAKPOINT_UPDATED: 'SelectedFunctionBreakpointUpdated'
 };
 
 export var ServiceEvents = {
@@ -132,6 +133,8 @@ export interface IViewModel extends ee.EventEmitter {
 	getSelectedExpression(): IExpression;
 	getFocusedThreadId(): number;
 	setSelectedExpression(expression: IExpression);
+	getSelectedFunctionBreakpoint(): IFunctionBreakpoint;
+	setSelectedFunctionBreakpoint(functionBreakpoint: IFunctionBreakpoint): void;
 }
 
 export interface IModel extends ee.IEventEmitter, ITreeElement {
@@ -195,6 +198,7 @@ export interface IRawAdapter extends IRawEnvAdapter {
 	enableBreakpointsFor?: { languageIds: string[] };
 	configurationAttributes?: any;
 	initialConfigurations?: any[];
+	aiKey?: string;
 	win?: IRawEnvAdapter;
 	winx86?: IRawEnvAdapter;
 	windows?: IRawEnvAdapter;
@@ -224,7 +228,7 @@ export var IDebugService = createDecorator<IDebugService>(DEBUG_SERVICE_ID);
 export interface IDebugService extends ee.IEventEmitter {
 	serviceId: ServiceIdentifier<any>;
 	getState(): State;
-	canSetBreakpointsIn(model: editor.IModel, lineNumber: number): boolean;
+	canSetBreakpointsIn(model: editor.IModel): boolean;
 
 	getConfigurationName(): string;
 	setConfiguration(name: string): TPromise<void>;
@@ -233,7 +237,10 @@ export interface IDebugService extends ee.IEventEmitter {
 
 	setFocusedStackFrameAndEvaluate(focusedStackFrame: IStackFrame): void;
 
-	setBreakpointsForModel(modelUri: uri, data: IRawBreakpoint[]): TPromise<void>;
+	/**
+	 * Sets breakpoints for a model. Does not send them to the adapter.
+	 */
+	setBreakpointsForModel(modelUri: uri, rawData: IRawBreakpoint[]): void;
 	toggleBreakpoint(IRawBreakpoint): TPromise<void>;
 	enableOrDisableAllBreakpoints(enabled: boolean): TPromise<void>;
 	toggleEnablement(element: IEnablement): TPromise<void>;
@@ -258,15 +265,39 @@ export interface IDebugService extends ee.IEventEmitter {
 	renameWatchExpression(id: string, newName: string): TPromise<void>;
 	clearWatchExpressions(id?: string): void;
 
+	/**
+	 * Creates a new debug session. Depending on the configuration will either 'launch' or 'attach'.
+	 */
 	createSession(): TPromise<any>;
+
+	/**
+	 * Restarts an active debug session or creates a new one if there is no active session.
+	 */
 	restartSession(): TPromise<any>;
-	rawAttach(port: number): TPromise<any>;
+
+	/**
+	 * Returns the active debug session or null if debug is inactive.
+	 */
 	getActiveSession(): IRawDebugSession;
 
+	/**
+	 * Gets the current debug model.
+	 */
 	getModel(): IModel;
+
+	/**
+	 * Gets the current view model.
+	 */
 	getViewModel(): IViewModel;
 
+	/**
+	 * Opens a new or reveals an already visible editor showing the source.
+	 */
 	openOrRevealEditor(source: Source, lineNumber: number, preserveFocus: boolean, sideBySide: boolean): TPromise<any>;
+
+	/**
+	 * Reveals the repl.
+	 */
 	revealRepl(focus?: boolean): TPromise<void>;
 }
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/common/debugProtocol.d.ts
code:
@@ -487,8 +487,18 @@ declare module DebugProtocol {
 		supportsConfigurationDoneRequest?: boolean;
 		/** The debug adapter supports functionBreakpoints. */
 		supportsFunctionBreakpoints?: boolean;
+		/** The debug adapter supports conditionalBreakpoints. */
+		supportsConditionalBreakpoints?: boolean;
 		/** The debug adapter supports a (side effect free) evaluate request for data hovers. */
 		supportsEvaluateForHovers?: boolean;
+
+		/** Available filters for the setExceptionBreakpoints request. */
+		exceptionBreakpointFilters?: [
+			{
+				filter: string,
+				label: string
+			}
+		]
 	}
 
 	/** A structured message object. Used to return errors from requests. */

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/common/debugViewModel.ts
code:
@@ -9,6 +9,7 @@ export class ViewModel extends ee.EventEmitter implements debug.IViewModel, debu
 
 	private focusedStackFrame: debug.IStackFrame;
 	private selectedExpression: debug.IExpression;
+	private selectedFunctionBreakpoint: debug.IFunctionBreakpoint;
 
 	public getId(): string {
 		return 'root';
@@ -35,4 +36,13 @@ export class ViewModel extends ee.EventEmitter implements debug.IViewModel, debu
 		this.selectedExpression = expression;
 		this.emit(debug.ViewModelEvents.SELECTED_EXPRESSION_UPDATED, expression);
 	}
+
+	public getSelectedFunctionBreakpoint(): debug.IFunctionBreakpoint {
+		return this.selectedFunctionBreakpoint;
+	}
+
+	public setSelectedFunctionBreakpoint(functionBreakpoint: debug.IFunctionBreakpoint): void {
+		this.selectedFunctionBreakpoint = functionBreakpoint;
+		this.emit(debug.ViewModelEvents.SELECTED_FUNCTION_BREAKPOINT_UPDATED, functionBreakpoint);
+	}
 }

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debugActions.ts
code:
@@ -392,6 +392,20 @@ export class AddFunctionBreakpointAction extends AbstractDebugAction {
 	}
 }
 
+export class RenameFunctionBreakpointAction extends AbstractDebugAction {
+	static ID = 'workbench.debug.viewlet.action.renameFunctionBreakpointAction';
+	static LABEL = nls.localize('renameFunctionBreakpoint', "Rename Function Breakpoint");
+
+	constructor(id: string, label: string, @IDebugService debugService: IDebugService, @IKeybindingService keybindingService: IKeybindingService) {
+		super(id, label, null, debugService, keybindingService);
+	}
+
+	public run(fbp: debug.IFunctionBreakpoint): TPromise<any> {
+		this.debugService.getViewModel().setSelectedFunctionBreakpoint(fbp);
+		return TPromise.as(null);
+	}
+}
+
 export class AddConditionalBreakpointAction extends AbstractDebugAction {
 	static ID = 'workbench.debug.viewlet.action.addConditionalBreakpointAction';
 	static LABEL = nls.localize('addConditionalBreakpoint', "Add Conditional Breakpoint");
@@ -429,7 +443,7 @@ export class ToggleBreakpointAction extends EditorAction {
 		if (this.debugService.getState() !== debug.State.Disabled) {
 			const lineNumber = this.editor.getPosition().lineNumber;
 			const modelUrl = this.editor.getModel().getAssociatedResource();
-			if (this.debugService.canSetBreakpointsIn(this.editor.getModel(), lineNumber)) {
+			if (this.debugService.canSetBreakpointsIn(this.editor.getModel())) {
 				return this.debugService.toggleBreakpoint({ uri: modelUrl, lineNumber: lineNumber });
 			}
 		}
@@ -448,7 +462,7 @@ export class EditorConditionalBreakpointAction extends EditorAction {
 	public run(): TPromise<any> {
 		if (this.debugService.getState() !== debug.State.Disabled) {
 			const lineNumber = this.editor.getPosition().lineNumber;
-			if (this.debugService.canSetBreakpointsIn(this.editor.getModel(), lineNumber)) {
+			if (this.debugService.canSetBreakpointsIn(this.editor.getModel())) {
 				return this.debugService.editBreakpoint(<editorbrowser.ICodeEditor>this.editor, lineNumber);
 			}
 		}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debugService.ts
code:
@@ -5,6 +5,7 @@
 
 import nls = require('vs/nls');
 import lifecycle = require('vs/base/common/lifecycle');
+import Objects = require('vs/base/common/objects');
 import mime = require('vs/base/common/mime');
 import ee = require('vs/base/common/eventEmitter');
 import uri from 'vs/base/common/uri';
@@ -16,6 +17,7 @@ import severity from 'vs/base/common/severity';
 import { TPromise } from 'vs/base/common/winjs.base';
 import editor = require('vs/editor/common/editorCommon');
 import aria = require('vs/base/browser/ui/aria/aria');
+import { AIAdapter } from 'vs/base/node/aiAdapter';
 import editorbrowser = require('vs/editor/browser/editorBrowser');
 import { IKeybindingService, IKeybindingContextKey } from 'vs/platform/keybinding/common/keybindingService';
 import {IMarkerService} from 'vs/platform/markers/common/markers';
@@ -65,9 +67,11 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 	private viewModel: viewmodel.ViewModel;
 	private configurationManager: ConfigurationManager;
 	private debugStringEditorInputs: DebugStringEditorInput[];
+	private telemetryAdapter: AIAdapter;
 	private lastTaskEvent: TaskEvent;
 	private toDispose: lifecycle.IDisposable[];
 	private inDebugMode: IKeybindingContextKey<boolean>;
+	private telemetryInfo: any;
 
 	constructor(
 		@IStorageService private storageService: IStorageService,
@@ -108,6 +112,12 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		this.viewModel = new viewmodel.ViewModel();
 
 		this.registerListeners(eventService, lifecycleService);
+
+		this.telemetryInfo = Object.create(null);
+		this.telemetryService.getTelemetryInfo().then(info => {
+			this.telemetryInfo['common.vscodemachineid'] = info.machineId;
+			this.telemetryInfo['common.vscodesessionid'] = info.sessionId;
+		});
 	}
 
 	private registerListeners(eventService: IEventService, lifecycleService: ILifecycleService): void {
@@ -282,7 +292,15 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 
 		this.toDispose.push(this.session.addListener2(debug.SessionEvents.OUTPUT, (event: DebugProtocol.OutputEvent) => {
 			if (event.body && event.body.category === 'telemetry') {
-				this.telemetryService.publicLog(event.body.output, event.body.data);
+				const key = this.configurationManager.getAdapter().aiKey;
+				// only log telemetry events from debug adapter if the adapter provided the telemetry key
+				if (key) {
+					if (!this.telemetryAdapter) {
+						this.telemetryAdapter = new AIAdapter(key, this.session.getType());
+					}
+					let data = Objects.mixin(event.body.data, this.telemetryInfo);
+					this.telemetryAdapter.log(event.body.output, data);
+				}
 			} else if (event.body && typeof event.body.output === 'string' && event.body.output.length > 0) {
 				this.onOutput(event);
 			}
@@ -394,12 +412,10 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		}
 	}
 
-	public setBreakpointsForModel(modelUri: uri, rawData: debug.IRawBreakpoint[]): TPromise<void> {
+	public setBreakpointsForModel(modelUri: uri, rawData: debug.IRawBreakpoint[]): void {
 		this.model.removeBreakpoints(
 			this.model.getBreakpoints().filter(bp => bp.source.uri.toString() === modelUri.toString()));
 		this.model.addBreakpoints(rawData);
-
-		return this.sendBreakpoints(modelUri);
 	}
 
 	public toggleBreakpoint(rawBreakpoint: debug.IRawBreakpoint): TPromise<void> {
@@ -613,7 +629,7 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		});
 	}
 
-	public rawAttach(port: number): TPromise<any> {
+	private rawAttach(port: number): TPromise<any> {
 		if (this.session) {
 			if (!this.session.isAttach) {
 				return this.session.attach({ port });
@@ -675,6 +691,10 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		});
 		this.model.updateBreakpoints(data);
 
+		if (this.telemetryAdapter) {
+			this.telemetryAdapter.dispose();
+			this.telemetryAdapter = null;
+		}
 		this.inDebugMode.reset();
 	}
 
@@ -756,8 +776,8 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		});
 	}
 
-	public canSetBreakpointsIn(model: editor.IModel, lineNumber: number): boolean {
-		return this.configurationManager.canSetBreakpointsIn(model, lineNumber);
+	public canSetBreakpointsIn(model: editor.IModel): boolean {
+		return this.configurationManager.canSetBreakpointsIn(model);
 	}
 
 	public getConfigurationName(): string {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/node/debugAdapter.ts
code:
@@ -20,6 +20,7 @@ export class Adapter {
 	private configurationAttributes: any;
 	public initialConfigurations: any[];
 	public enableBreakpointsFor: { languageIds: string[] };
+	public aiKey: string;
 
 	constructor(rawAdapter: debug.IRawAdapter, systemVariables: SystemVariables, extensionFolderPath: string) {
 		if (rawAdapter.windows) {
@@ -67,6 +68,7 @@ export class Adapter {
 		this.initialConfigurations = rawAdapter.initialConfigurations;
 		this._label = rawAdapter.label;
 		this.enableBreakpointsFor = rawAdapter.enableBreakpointsFor;
+		this.aiKey = rawAdapter.aiKey;
 	}
 
 	public get label() {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/node/debugConfigurationManager.ts
code:
@@ -322,7 +322,7 @@ export class ConfigurationManager {
 		});
 	}
 
-	public canSetBreakpointsIn(model: editor.IModel, lineNumber: number): boolean {
+	public canSetBreakpointsIn(model: editor.IModel): boolean {
 		if (model.getAssociatedResource().scheme === schemas.inMemory) {
 			return false;
 		}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/node/rawDebugSession.ts
code:
@@ -34,6 +34,7 @@ export class RawDebugSession extends v8.V8Protocol implements debug.IRawDebugSes
 		private adapter: Adapter
 	) {
 		super();
+		this.capablities = {};
 	}
 
 	private initServer(): TPromise<void> {
@@ -67,7 +68,7 @@ export class RawDebugSession extends v8.V8Protocol implements debug.IRawDebugSes
 
 	public initialize(args: DebugProtocol.InitializeRequestArguments): TPromise<DebugProtocol.InitializeResponse> {
 		return this.send('initialize', args).then(response => {
-			this.capablities = response.body || { };
+			this.capablities = response.body || this.capablities;
 			return response;
 		});
 	}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/errorList.contribution.ts
code:
@@ -0,0 +1,59 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+import nls = require('vs/nls');
+import { Action } from 'vs/base/common/actions';
+import { TPromise } from 'vs/base/common/winjs.base';
+import { KeyMod, KeyCode } from 'vs/base/common/keyCodes';
+import platform = require('vs/platform/platform');
+import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
+import { IWorkbenchActionRegistry, Extensions as ActionExtensions } from 'vs/workbench/common/actionRegistry';
+import panel = require('vs/workbench/browser/panel');
+import { ERROR_LIST_PANEL_ID } from 'vs/workbench/parts/errorList/browser/errorListConstants';
+import { IPartService } from 'vs/workbench/services/part/common/partService';
+import { IPanelService } from 'vs/workbench/services/panel/common/panelService';
+
+class ToggleErrorListAction extends Action {
+
+	public static ID = 'workbench.action.errorList.toggle';
+	public static LABEL = nls.localize('toggleErrorList', "Toggle Error List");
+
+	constructor(id: string, label: string,
+		@IPartService private partService: IPartService,
+		@IPanelService private panelService: IPanelService
+	) {
+		super(id, label);
+	}
+
+	public run(event?: any): TPromise<any> {
+		const panel = this.panelService.getActivePanel();
+		if (panel && panel.getId() === ERROR_LIST_PANEL_ID) {
+			this.partService.setPanelHidden(true);
+
+			return TPromise.as(null);
+		}
+
+		return this.panelService.openPanel(ERROR_LIST_PANEL_ID, true);
+	}
+}
+
+// register panel
+(<panel.PanelRegistry>platform.Registry.as(panel.Extensions.Panels)).registerPanel(new panel.PanelDescriptor(
+	'vs/workbench/parts/errorList/browser/errorList',
+	'ErrorList',
+	ERROR_LIST_PANEL_ID,
+	nls.localize('errorListPanel', "Error List"),
+	'errorList'
+));
+
+
+// register toggle output action globally
+let actionRegistry = <IWorkbenchActionRegistry>platform.Registry.as(ActionExtensions.WorkbenchActions);
+actionRegistry.registerWorkbenchAction(new SyncActionDescriptor(ToggleErrorListAction, ToggleErrorListAction.ID, ToggleErrorListAction.LABEL, {
+	primary: KeyMod.CtrlCmd | KeyMod.Shift | KeyCode.KEY_A,
+	linux: {
+		primary: KeyMod.CtrlCmd | KeyMod.Shift | KeyCode.KEY_A
+	}
+}), nls.localize('viewCategory', "View"));

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/errorList.ts
code:
@@ -0,0 +1,168 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+import 'vs/css!./media/errorList';
+import { TPromise } from 'vs/base/common/winjs.base';
+import * as errors from 'vs/base/common/errors';
+import * as paths from 'vs/base/common/paths';
+import lifecycle = require('vs/base/common/lifecycle');
+import Severity from 'vs/base/common/severity';
+import builder = require('vs/base/browser/builder');
+import { append, addClass, emmet as $ } from 'vs/base/browser/dom';
+import { List } from 'vs/base/browser/ui/list/listWidget';
+import { IRenderer, IDelegate } from 'vs/base/browser/ui/list/list';
+import { IMarkerService, IMarker } from 'vs/platform/markers/common/markers';
+import { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';
+import { Panel } from 'vs/workbench/browser/panel';
+import { ERROR_LIST_PANEL_ID } from 'vs/workbench/parts/errorList/browser/errorListConstants';
+import { IWorkbenchEditorService } from 'vs/workbench/services/editor/common/editorService';
+
+interface IMarkerTemplateData {
+	icon: HTMLElement;
+	label: HTMLElement;
+	location: HTMLElement;
+}
+
+class Renderer implements IRenderer<IMarker, IMarkerTemplateData> {
+
+	get templateId(): string {
+		return 'errorListItem';
+	}
+
+	renderTemplate(container: HTMLElement): IMarkerTemplateData {
+		const data = <IMarkerTemplateData>Object.create(null);
+
+		data.icon = append(container, $('.icon'));
+		data.label = append(container, $('span.label'));
+		data.location = append(container, $('.location'));
+
+		return data;
+	}
+
+	disposeTemplate(templateData: IMarkerTemplateData): void {
+		// Nothing to do here
+	}
+
+	renderElement(element: IMarker, index: number, templateData: IMarkerTemplateData): void {
+		templateData.icon.className = 'icon ' + Renderer.iconClassNameFor(element);
+		templateData.label.textContent = element.message;
+		templateData.location.textContent = `${ paths.basename(element.resource.fsPath) }:${ element.startLineNumber }:${ element.startColumn }`;
+	}
+
+	private static iconClassNameFor(element: IMarker): string {
+		switch (element.severity) {
+			case Severity.Ignore:
+				return 'info';
+			case Severity.Info:
+				return 'info';
+			case Severity.Warning:
+				return 'warning';
+			case Severity.Error:
+				return 'error';
+		}
+		return '';
+	}
+}
+
+class Delegate implements IDelegate<IMarker> {
+
+	constructor(private listProvider: () => List<IMarker>) { }
+
+	getHeight(element: IMarker): number {
+		return 22;
+	}
+
+	getTemplateId(element: IMarker): string {
+		return 'errorListItem';
+	}
+}
+
+export class ErrorList extends Panel {
+
+	private toDispose: lifecycle.IDisposable[];
+	private list: List<IMarker>;
+	private delegate: IDelegate<IMarker>;
+
+	constructor(
+		@IMarkerService private markerService: IMarkerService,
+		@IWorkbenchEditorService private editorService: IWorkbenchEditorService,
+		@ITelemetryService telemetryService: ITelemetryService
+	) {
+		super(ERROR_LIST_PANEL_ID, telemetryService);
+
+		this.toDispose = [];
+	}
+
+	public create(parent: builder.Builder): TPromise<void> {
+		super.create(parent);
+
+		addClass(parent.getHTMLElement(), 'new-error-list');
+
+		let renderer: IRenderer<IMarker, IMarkerTemplateData> = new Renderer();
+
+		this.delegate = new Delegate(() => this.list);
+		this.list = new List(parent.getHTMLElement(), this.delegate, [renderer]);
+
+		this.toDispose.push(this.markerService.onMarkerChanged((changedResources) => {
+			this.onMarkersChanged();
+		}));
+		this.toDispose.push(this.list.onSelectionChange((e) => {
+			if (!e.elements.length) {
+				return;
+			}
+			let el = e.elements[0];
+			this.editorService.openEditor({
+				resource: el.resource,
+				options: {
+					selection: {
+						startLineNumber: el.startLineNumber,
+						startColumn: el.startColumn,
+						endLineNumber: el.endLineNumber,
+						endColumn: el.endColumn
+					}
+				}
+			}).done(null, errors.onUnexpectedError);
+		}));
+		this.onMarkersChanged();
+
+		return TPromise.as(null);
+	}
+
+	private onMarkersChanged(): void {
+		let allMarkers = this.markerService.read().slice(0);
+
+		allMarkers.sort((a, b) => {
+			if (a.severity === b.severity) {
+				let aRes = a.resource.toString();
+				let bRes = b.resource.toString();
+				if (aRes === bRes) {
+					if (a.startLineNumber === b.startLineNumber) {
+						return a.startColumn - b.startColumn;
+					}
+					return a.startLineNumber - b.startLineNumber;
+				}
+				if (aRes < bRes) {
+					return -1;
+				}
+				if (aRes > bRes) {
+					return 1;
+				}
+			}
+			return b.severity - a.severity;
+		});
+
+		this.list.splice(0, this.list.length, ...allMarkers);
+	}
+
+	public dispose(): void {
+		this.toDispose = lifecycle.disposeAll(this.toDispose);
+		this.list.dispose();
+		super.dispose();
+	}
+
+	public layout(dimension: builder.Dimension): void {
+		this.list.layout(dimension.height);
+	}
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/errorListConstants.ts
code:
@@ -0,0 +1,6 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+export const ERROR_LIST_PANEL_ID = 'workbench.panel.errorList';

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/errorList.css
code:
@@ -0,0 +1,60 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+.new-error-list .monaco-list-row {
+	line-height: 22px;
+}
+
+.new-error-list .icon {
+	float: left;
+	display: block;
+	width: 16px;
+	height: 22px;
+	margin-right: 4px;
+	margin-left: 4px;
+}
+
+
+.new-error-list .icon.warning {
+	background: url('status-warning.svg') center center no-repeat;
+}
+
+.new-error-list .icon.error {
+	background: url('status-error.svg') center center no-repeat;
+}
+
+.new-error-list .icon.info:before {
+	background: url('status-info.svg') center center no-repeat;
+}
+
+.vs-dark .new-error-list .icon.warning {
+	background: url('status-warning-inverse.svg') center center no-repeat;
+}
+
+.vs-dark .new-error-list .icon.error {
+	background: url('status-error-inverse.svg') center center no-repeat;
+}
+
+.vs-dark .new-error-list .icon.info:before {
+	background: url('status-info-inverse.svg') center center no-repeat;
+}
+
+.new-error-list .label {
+	display: block;
+	float: left;
+	text-overflow: ellipsis;
+	overflow: hidden;
+	/* icon: 16 + 4 + 4 */
+	/* line: 20 + 4 + 4 */
+	/* col: 20 + 4 + 4 */
+	/* file: 100 + 4 + 4 */
+	max-width: calc(100% - 24px - 200px - 20px)
+}
+
+.new-error-list .location {
+	float: right;
+	margin: 0 4px;
+	width: 200px;
+}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-error-inverse.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" height="16" width="16"><circle cx="8" cy="8" r="6" fill="#1E1E1E"/><path d="M8 3C5.238 3 3 5.238 3 8s2.238 5 5 5 5-2.238 5-5-2.238-5-5-5zm3 7l-1 1-2-2-2 2-1-1 2-2.027L5 6l1-1 2 2 2-2 1 1-2 1.973L11 10z" fill="#F48771"/><path fill="#252526" d="M11 6l-1-1-2 2-2-2-1 1 2 1.973L5 10l1 1 2-2 2 2 1-1-2-2.027z"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-error.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" enable-background="new 0 0 16 16" height="16" width="16"><circle cx="8" cy="8" r="6" fill="#F6F6F6"/><path d="M8 3C5.238 3 3 5.238 3 8s2.238 5 5 5 5-2.238 5-5-2.238-5-5-5zm3 7l-1 1-2-2-2 2-1-1 2-2.027L5 6l1-1 2 2 2-2 1 1-2 1.973L11 10z" fill="#E51400"/><path fill="#fff" d="M11 6l-1-1-2 2-2-2-1 1 2 1.973L5 10l1 1 2-2 2 2 1-1-2-2.027z"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-info-inverse.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" enable-background="new 0 0 16 16" height="16" width="16"><circle cx="8.5" cy="7.5" r="5.5" fill="#1E1E1E"/><path d="M8.5 3C6.015 3 4 5.015 4 7.5S6.015 12 8.5 12 13 9.985 13 7.5 10.985 3 8.5 3zm.5 8H8V6h1v5zm0-6H8V4h1v1z" fill="#1BA1E2"/><path d="M8 6h1v5H8V6zm0-2v1h1V4H8z" fill="#252526"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-info.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" height="16" width="16"><path fill="#F6F6F6" d="M7.5 2L2 12l2 2h9l2-2L9.5 2z"/><path d="M9 3H8l-4.5 9 1 1h8l1-1L9 3zm0 9H8v-1h1v1zm0-2H8V6h1v4z" fill="#fc0"/><path d="M9 10H8V6h1v4zm0 1H8v1h1v-1z"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-warning-inverse.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" height="16" width="16"><path fill="#1E1E1E" d="M7.5 2L2 12l2 2h9l2-2L9.5 2z"/><path d="M9 3H8l-4.5 9 1 1h8l1-1L9 3zm0 9H8v-1h1v1zm0-2H8V6h1v4z" fill="#fc0"/><path d="M9 10H8V6h1v4zm0 1H8v1h1v-1z"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/errorList/browser/media/status-warning.svg
code:
@@ -0,0 +1 @@
+<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" enable-background="new 0 0 16 16" height="16" width="16"><path fill="#F6F6F6" d="M7.5 2L2 12l2 2h9l2-2L9.5 2z"/><path d="M9 3H8l-4.5 9 1 1h8l1-1L9 3zm0 9H8v-1h1v1zm0-2H8V6h1v4z" fill="#fc0"/><path d="M9 10H8V6h1v4zm0 1H8v1h1v-1z"/></svg>
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/files/electron-browser/textFileServices.ts
code:
@@ -7,8 +7,6 @@
 
 import nls = require('vs/nls');
 import {TPromise} from 'vs/base/common/winjs.base';
-import {Registry} from 'vs/platform/platform';
-import {IEditorModesRegistry, Extensions as ModesExtensions} from 'vs/editor/common/modes/modesRegistry';
 import paths = require('vs/base/common/paths');
 import strings = require('vs/base/common/strings');
 import {isWindows} from 'vs/base/common/platform';
@@ -25,11 +23,14 @@ import {IWorkspaceContextService} from 'vs/workbench/services/workspace/common/c
 import {ILifecycleService} from 'vs/platform/lifecycle/common/lifecycle';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {IConfigurationService} from 'vs/platform/configuration/common/configuration';
+import {IModeService} from 'vs/editor/common/services/modeService';
 
 import {remote} from 'electron';
 
 export class TextFileService extends AbstractTextFileService {
 
+	private modeService: IModeService;
+
 	constructor(
 		@IWorkspaceContextService contextService: IWorkspaceContextService,
 		@IInstantiationService instantiationService: IInstantiationService,
@@ -38,9 +39,11 @@ export class TextFileService extends AbstractTextFileService {
 		@ILifecycleService lifecycleService: ILifecycleService,
 		@ITelemetryService telemetryService: ITelemetryService,
 		@IConfigurationService configurationService: IConfigurationService,
-		@IEventService eventService: IEventService
+		@IEventService eventService: IEventService,
+		@IModeService modeService: IModeService
 	) {
 		super(contextService, instantiationService, configurationService, telemetryService, lifecycleService, eventService);
+		this.modeService = modeService;
 
 		this.init();
 	}
@@ -386,9 +389,8 @@ export class TextFileService extends AbstractTextFileService {
 		// Build the file filter by using our known languages
 		let ext: string = paths.extname(defaultPath);
 		let matchingFilter: IFilter;
-		let modesRegistry = <IEditorModesRegistry>Registry.as(ModesExtensions.EditorModes);
-		let filters: IFilter[] = modesRegistry.getRegisteredLanguageNames().map(languageName => {
-			let extensions = modesRegistry.getExtensions(languageName);
+		let filters: IFilter[] = this.modeService.getRegisteredLanguageNames().map(languageName => {
+			let extensions = this.modeService.getExtensions(languageName);
 			if (!extensions || !extensions.length) {
 				return null;
 			}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/git/browser/gitWorkbenchContributions.ts
code:
@@ -492,17 +492,17 @@ export function registerContributions(): void {
 		title: nls.localize('gitConfigurationTitle', "Git configuration"),
 		type: 'object',
 		properties: {
-			"git.enabled": {
+			'git.enabled': {
 				type: 'boolean',
 				description: nls.localize('gitEnabled', "Is git enabled"),
 				default: true
 			},
-			"git.path": {
+			'git.path': {
 				type: ['string', 'null'],
 				description: nls.localize('gitPath', "Path to the git executable"),
 				default: null
 			},
-			"git.autofetch": {
+			'git.autofetch': {
 				type: 'boolean',
 				description: nls.localize('gitAutoFetch', "Whether auto fetching is enabled."),
 				default: true

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -117,7 +117,7 @@ export function createNativeRawGitService(workspaceRoot: string, gitPath: string
 				timeout: 1000 * 60,
 				args: [gitPath, workspaceRoot, defaultEncoding, remote.process.execPath],
 				env: {
-					ELECTRON_RUN_AS_NODE: 1,
+					ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
 					AMD_ENTRYPOINT: 'vs/workbench/parts/git/electron-browser/gitApp'
 				}
 			}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/snippets/electron-browser/snippets.contribution.ts
code:
@@ -13,12 +13,12 @@ import platform = require('vs/platform/platform');
 import workbenchActionRegistry = require('vs/workbench/common/actionRegistry');
 import workbenchContributions = require('vs/workbench/common/contributions');
 import snippetsTracker = require('./snippetsTracker');
-import modesExtensions = require('vs/editor/common/modes/modesRegistry');
 import errors = require('vs/base/common/errors');
 import {IQuickOpenService, IPickOpenEntry} from 'vs/workbench/services/quickopen/common/quickOpenService';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
 import * as JSONContributionRegistry from 'vs/platform/jsonschemas/common/jsonContributionRegistry';
 import {IJSONSchema} from 'vs/base/common/jsonSchema';
+import {IModeService} from 'vs/editor/common/services/modeService';
 
 import {ipcRenderer as ipc} from 'electron';
 import fs = require('fs');
@@ -32,7 +32,8 @@ class OpenSnippetsAction extends actions.Action {
 		id: string,
 		label:string,
 		@IWorkspaceContextService private contextService: IWorkspaceContextService,
-		@IQuickOpenService private quickOpenService:IQuickOpenService
+		@IQuickOpenService private quickOpenService:IQuickOpenService,
+		@IModeService private modeService:IModeService
 	) {
 		super(id, label);
 	}
@@ -42,11 +43,10 @@ class OpenSnippetsAction extends actions.Action {
 	}
 
 	public run(): winjs.Promise {
-		var modesRegistry = <modesExtensions.IEditorModesRegistry>platform.Registry.as(modesExtensions.Extensions.EditorModes);
-		var modeIds = modesRegistry.getRegisteredModes();
+		var modeIds = this.modeService.getRegisteredModes();
 		var picks: IPickOpenEntry[] = [];
 		modeIds.forEach((modeId) => {
-			var name = modesRegistry.getLanguageName(modeId);
+			var name = this.modeService.getLanguageName(modeId);
 			if (name) {
 				picks.push({ label: name, id: modeId });
 			}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/tasks/common/tasks.ts
code:
@@ -13,7 +13,7 @@ import * as UUID from 'vs/base/common/uuid';
 import { ValidationStatus, ValidationState, ILogger, Parser } from 'vs/base/common/parsers';
 import { Executable, ExecutableParser, Config  as ProcessConfig} from 'vs/base/common/processes';
 
-import { ProblemMatcher, Config as ProblemMatcherConfig, ProblemMatcherParser, registry as ProblemMatcherRegistry } from 'vs/platform/markers/common/problemMatcher';
+import { ProblemMatcher, Config as ProblemMatcherConfig, ProblemMatcherParser } from 'vs/platform/markers/common/problemMatcher';
 
 export namespace Config {
 

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/tasks/node/processRunnerConfiguration.ts
code:
@@ -29,9 +29,9 @@ export class ProblemHandling {
 }
 
 export namespace ShowOutput {
-	let always: string = 'always';
-	let silent: string = 'silent';
-	let never: string = 'never';
+	// let always: string = 'always';
+	// let silent: string = 'silent';
+	// let never: string = 'never';
 }
 
 /**

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/tasks/node/processRunnerDetector.ts
code:
@@ -84,12 +84,12 @@ class GruntTaskMatcher implements TaskDetectorMatcher {
 			//
 			// Tasks run in the order specified
 			if (!this.tasksStart && !this.tasksEnd) {
-				if (line.indexOf('Available tasks') == 0) {
+				if (line.indexOf('Available tasks') === 0) {
 					this.tasksStart = true;
 				}
 			}
 			else if (this.tasksStart && !this.tasksEnd) {
-				if (line.indexOf('Tasks run in the order specified') == 0) {
+				if (line.indexOf('Tasks run in the order specified') === 0) {
 					this.tasksEnd = true;
 				} else {
 					if (this.descriptionOffset === null) {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/telemetry/node/nodeAppInsightsTelemetryAppender.ts
code:
@@ -7,15 +7,13 @@
 /* tslint:disable:semicolon */
 
 import errors = require('vs/base/common/errors');
-import types = require('vs/base/common/types');
-import {safeStringify} from 'vs/base/common/objects';
 import {IStorageService} from 'vs/platform/storage/common/storage';
 import {ITelemetryAppender} from 'vs/platform/telemetry/common/telemetry';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
+import {AIAdapter, IAIAdapter} from 'vs/base/node/aiAdapter';
 
 import winreg = require('winreg');
 import os = require('os');
-import appInsights = require('applicationinsights');
 
 class StorageKeys {
 	public static sqmUserId: string = 'telemetry.sqm.userId';
@@ -26,15 +24,15 @@ class StorageKeys {
 
 export class NodeAppInsightsTelemetryAppender implements ITelemetryAppender {
 
-	public static EVENT_NAME_PREFIX: string = 'monacoworkbench/';
+	public static EVENT_NAME_PREFIX: string = 'monacoworkbench';
 
 	private static SQM_KEY: string = '\\Software\\Microsoft\\SQMClient';
 
 	private storageService:IStorageService;
 	private contextService: IWorkspaceContextService;
 
-	private appInsights: typeof appInsights.client;
-	private appInsightsVortex: typeof appInsights.client;
+	private appInsights: IAIAdapter;
+	private appInsightsVortex: IAIAdapter;
 
 	protected commonProperties: {[key:string] : string};
 	protected commonMetrics: {[key: string]: number};
@@ -66,35 +64,16 @@ export class NodeAppInsightsTelemetryAppender implements ITelemetryAppender {
 		}
 
 		if (key) {
-			this.appInsights = appInsights.setup(key)
-			.setAutoCollectRequests(false)
-			.setAutoCollectPerformance(false)
-			.setAutoCollectExceptions(false)
-			.setOfflineMode(true)
-			.start()
-			.client;
-
-			this.setupAIClient(this.appInsights);
+			this.appInsights = new AIAdapter(key, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX);
 		}
 
 		if(asimovKey) {
-			this.appInsightsVortex = appInsights.getClient(asimovKey);
-			this.appInsightsVortex.config.endpointUrl = 'https://vortex.data.microsoft.com/collect/v1';
-			this.setupAIClient(this.appInsightsVortex);
+			this.appInsightsVortex = new AIAdapter(asimovKey, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX);
 		}
 
 		this.loadAddtionaProperties();
 	}
 
-	private setupAIClient(client: typeof appInsights.client): void {
-		//prevent App Insights from reporting machine name
-		if (client && client.context &&
-			client.context.keys && client.context.tags) {
-			var machineNameKey = client.context.keys.deviceMachineName;
-			client.context.tags[machineNameKey] = '';
-		}
-	}
-
 	private loadAddtionaProperties(): void {
 		// add shell & render version
 		if (process.versions) {
@@ -177,109 +156,48 @@ export class NodeAppInsightsTelemetryAppender implements ITelemetryAppender {
 		}
 	}
 
-	private getData(data?: any): any {
-		var properties: {[key: string]: string;} = {};
-		var measurements: {[key: string]: number;} = {};
-
-		var event_data = this.flaten(data);
-		for(var prop in event_data) {
-			// enforce property names less than 150 char, take the last 150 char
-			var propName = prop && prop.length > 150 ? prop.substr( prop.length - 149) : prop;
-			var property = event_data[prop];
-			if (types.isNumber(property)) {
-				measurements[propName] = property;
-
-			} else if (types.isBoolean(property)) {
-				measurements[propName] = property ? 1:0;
-			} else if (types.isString(property)) {
-				//enforce proeprty value to be less than 1024 char, take the first 1024 char
-				var propValue = property && property.length > 1024 ? property.substring(0, 1023): property;
-				properties[propName] = propValue;
-			} else if (!types.isUndefined(property) && property !== null) {
-				properties[propName] = property;
-			}
-		}
-
-		properties = this.addCommonProperties(properties);
-		measurements = this.addCommonMetrics(measurements);
-
-		return {
-			properties: properties,
-			measurements: measurements
-		};
-	}
-
-	private flaten(obj:any, order:number = 0, prefix? : string): any {
-		var result:{[key:string]: any} = {};
-		var properties = obj ? Object.getOwnPropertyNames(obj) : [];
-		for (var i =0; i < properties.length; i++) {
-			var item = properties[i];
-			var index = prefix ? prefix + item : item;
-
-			if (types.isArray(obj[item])) {
-				try {
-					result[index] = safeStringify(obj[item]);
-				} catch (e) {
-					// workaround for catching the edge case for #18383
-					// safe stringfy should never throw circular object exception
-					result[index] = '[Circular-Array]';
-				}
-			} else if (obj[item] instanceof Date) {
-				result[index] = (<Date> obj[item]).toISOString();
-			} else if (types.isObject(obj[item])) {
-				if (order < 2) {
-					var item_result = this.flaten(obj[item], order + 1, index + '.');
-					for (var prop in item_result) {
-						result[prop] = item_result[prop];
-					}
-				} else {
-					try {
-						result[index] = safeStringify(obj[item]);
-					} catch (e) {
-						// workaround for catching the edge case for #18383
-						// safe stringfy should never throw circular object exception
-						result[index] = '[Circular]';
-					}
-				}
-			} else {
-				result[index] = obj[item];
-			}
-		}
-		return result;
-	}
-
 	public log(eventName: string, data?: any): void {
-		var result = this.getData(data);
+
+		data = data || Object.create(null);
+		data = this.addCommonMetrics(data);
+		data = this.addCommonProperties(data);
 
 		if (this.appInsights) {
 			if (eventName === 'UnhandledError' && data) {
-				this.appInsights.trackException(data);
+				this.appInsights.logException(data);
 			}
-
-			this.appInsights.trackEvent(NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+eventName, result.properties, result.measurements);
+			this.appInsights.log(eventName, data);
 		}
 
 		if (this.appInsightsVortex) {
 			if (eventName === 'UnhandledError' && data) {
-				this.appInsightsVortex.trackException(data);
+				this.appInsightsVortex.logException(data);
 			}
-			this.appInsightsVortex.trackEvent(NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+eventName, result.properties, result.measurements);
+			this.appInsightsVortex.log(eventName, data);
 		}
 	}
 
 	public dispose(): void {
+		if (this.appInsights) {
+			this.appInsights.dispose();
+		}
+
+		if (this.appInsightsVortex) {
+			this.appInsightsVortex.dispose();
+		}
+
 		this.appInsights = null;
 		this.appInsightsVortex = null;
 	}
 
-	protected addCommonProperties(properties: { [key: string]: string }): any {
+	protected addCommonProperties(properties: any): any {
 		for (var prop in this.commonProperties) {
 			properties['common.' + prop] = this.commonProperties[prop];
 		}
 		return properties;
 	}
 
-	protected addCommonMetrics = function (metrics: { [key: string]: number }): any {
+	protected addCommonMetrics(metrics: any): any {
 		for (var prop in this.commonMetrics) {
 			metrics['common.' + prop] = this.commonMetrics[prop];
 		}

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/telemetry/test/node/appInsightsTelemetryAppender.test.ts
code:
@@ -5,34 +5,36 @@
 'use strict';
 
 import * as assert from 'assert';
+import {IAIAdapter} from 'vs/base/node/aiAdapter';
 import { NodeAppInsightsTelemetryAppender } from 'vs/workbench/parts/telemetry/node/nodeAppInsightsTelemetryAppender';
 
 interface IAppInsightsEvent {
 	eventName: string;
-	properties?: {string?: string;};
-	measurements?: {string?: number;}
+	data: any;
 }
 
-class AppInsightsMock {
+class AIAdapterMock implements IAIAdapter {
 
 	public events: IAppInsightsEvent[]=[];
 	public IsTrackingPageView: boolean = false;
 	public exceptions: any[] =[];
 
-	public trackEvent(eventName: string, properties?: {string?: string;}, measurements?: {string?: number;}): void {
+	constructor(private prefix: string, private eventPrefix: string, client?: any) {
+	}
+
+	public log(eventName: string, data?: any): void {
 		this.events.push({
-			eventName: eventName,
-			properties: properties,
-			measurements: measurements
+			eventName: this.prefix+'/'+eventName,
+			data: data
 		});
 	}
-	public trackPageView(): void {
-		this.IsTrackingPageView = true;
-	}
 
-	public trackException(exception: any): void {
+	public logException(exception: any): void {
 		this.exceptions.push(exception);
 	}
+
+	public dispose(): void {
+	}
 }
 
 class ContextServiceMock {
@@ -52,11 +54,11 @@ class ContextServiceMock {
 }
 
 suite('Telemetry - AppInsightsTelemetryAppender', () => {
-	var appInsightsMock: AppInsightsMock;
+	var appInsightsMock: AIAdapterMock;
 	var appender: NodeAppInsightsTelemetryAppender;
 
 	setup(() => {
-		appInsightsMock = new AppInsightsMock();
+		appInsightsMock = new AIAdapterMock(NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX);
 		appender = new NodeAppInsightsTelemetryAppender(null,<any> new ContextServiceMock('123'), appInsightsMock);
 	});
 
@@ -68,7 +70,7 @@ suite('Telemetry - AppInsightsTelemetryAppender', () => {
 		appender.log('testEvent');
 
 		assert.equal(appInsightsMock.events.length, 1);
-		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'testEvent');
+		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'/testEvent');
 	});
 
 	test('Track UnhandledError as exception and events', () => {
@@ -77,79 +79,25 @@ suite('Telemetry - AppInsightsTelemetryAppender', () => {
 		appender.log('UnhandledError', sampleError);
 
 		assert.equal(appInsightsMock.events.length, 1);
-		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'UnhandledError');
+		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'/UnhandledError');
 
 		assert.equal(appInsightsMock.exceptions.length, 1);
 	});
 
-	test('property limits', () => {
-		var reallyLongPropertyName = 'abcdefghijklmnopqrstuvwxyz';
-		for (var i =0; i <6; i++) {
-			reallyLongPropertyName +='abcdefghijklmnopqrstuvwxyz';
-		}
-		assert(reallyLongPropertyName.length > 150);
-
-		var reallyLongPropertyValue = 'abcdefghijklmnopqrstuvwxyz012345678901234567890123';
-		for (var i =0; i <21; i++) {
-			reallyLongPropertyValue +='abcdefghijklmnopqrstuvwxyz012345678901234567890123';
-		}
-		assert(reallyLongPropertyValue.length > 1024);
-
-		var data = {};
-		data[reallyLongPropertyName] = '1234';
-		data['reallyLongPropertyValue'] = reallyLongPropertyValue;
-		appender.log('testEvent', data);
-
-		assert.equal(appInsightsMock.events.length, 1);
-
-		for (var prop in appInsightsMock.events[0].properties){
-			assert(prop.length < 150);
-			assert(appInsightsMock.events[0].properties[prop].length <1024);
-		}
-	});
-
-	test('Different data types', () => {
-		var date = new Date();
-		appender.log('testEvent', { favoriteDate: date, likeRed: false, likeBlue: true, favoriteNumber:1,  favoriteColor: 'blue', favoriteCars: ['bmw', 'audi', 'ford']});
-
-		assert.equal(appInsightsMock.events.length, 1);
-		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'testEvent');
-		assert.equal(appInsightsMock.events[0].properties['favoriteColor'], 'blue');
-		assert.equal(appInsightsMock.events[0].measurements['likeRed'], 0);
-		assert.equal(appInsightsMock.events[0].measurements['likeBlue'], 1);
-		assert.equal(appInsightsMock.events[0].properties['favoriteDate'], date.toISOString());
-		assert.equal(appInsightsMock.events[0].properties['favoriteCars'], JSON.stringify(['bmw', 'audi', 'ford']));
-		assert.equal(appInsightsMock.events[0].measurements['favoriteNumber'], 1);
-	});
-
-	test('Nested data', () => {
+	test('Event with data', () => {
 		appender.log('testEvent', {
-			window : {
-				title: 'some title',
-				measurements: {
-					width: 100,
-					height: 200
-				}
-			},
-			nestedObj: {
-				nestedObj2: {
-					nestedObj3: {
-						testProperty: 'test',
-					}
-				},
-				testMeasurement:1
-			}
+			title: 'some title',
+			width: 100,
+			height: 200
 		});
 
 		assert.equal(appInsightsMock.events.length, 1);
-		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'testEvent');
+		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'/testEvent');
 
-		assert.equal(appInsightsMock.events[0].properties['window.title'], 'some title');
-		assert.equal(appInsightsMock.events[0].measurements['window.measurements.width'], 100);
-		assert.equal(appInsightsMock.events[0].measurements['window.measurements.height'], 200);
+		assert.equal(appInsightsMock.events[0].data['title'], 'some title');
+		assert.equal(appInsightsMock.events[0].data['width'], 100);
+		assert.equal(appInsightsMock.events[0].data['height'], 200);
 
-		assert.equal(appInsightsMock.events[0].properties['nestedObj.nestedObj2.nestedObj3'], JSON.stringify({"testProperty":"test"}));
-		assert.equal(appInsightsMock.events[0].measurements['nestedObj.testMeasurement'],1);
 	});
 
 	test('Test asimov', () => {
@@ -158,9 +106,9 @@ suite('Telemetry - AppInsightsTelemetryAppender', () => {
 		appender.log('testEvent');
 
 		assert.equal(appInsightsMock.events.length, 2);
-		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'testEvent');
+		assert.equal(appInsightsMock.events[0].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'/testEvent');
 
 		// test vortex
-		assert.equal(appInsightsMock.events[1].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'testEvent');
+		assert.equal(appInsightsMock.events[1].eventName, NodeAppInsightsTelemetryAppender.EVENT_NAME_PREFIX+'/testEvent');
 	});
 });
\ No newline at end of file

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/services/search/node/textSearch.ts
code:
@@ -41,7 +41,7 @@ export class Engine implements ISearchEngine {
 		this.rootFolders = config.rootFolders;
 		this.extraFiles = config.extraFiles;
 		this.walker = walker;
-		this.contentPattern = strings.createRegExp(config.contentPattern.pattern, config.contentPattern.isRegExp, config.contentPattern.isCaseSensitive, config.contentPattern.isWordMatch);
+		this.contentPattern = strings.createRegExp(config.contentPattern.pattern, config.contentPattern.isRegExp, config.contentPattern.isCaseSensitive, config.contentPattern.isWordMatch, true);
 		this.isCanceled = false;
 		this.limitReached = false;
 		this.maxResults = config.maxResults;

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/services/thread/electron-browser/threadService.ts
code:
@@ -65,7 +65,7 @@ export class MainThreadService extends CommonMainThreadService {
 			this.remoteCom.handle(msg);
 		});
 
-		this.remoteCom.registerBigHandler(this);
+		this.remoteCom.setManyHandler(this);
 	}
 
 	public dispose(): void {

author:bgashler1
date:2016-02-16T23:17:05Z
title:Merge branches 'master' and 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/workbench.main.js
code:
@@ -48,6 +48,8 @@ define([
 
 	'vs/workbench/parts/debug/electron-browser/debug.contribution',
 
+	'vs/workbench/parts/errorList/browser/errorList.contribution',
+
 	'vs/workbench/parts/html/browser/html.contribution',
 
 	'vs/workbench/parts/extensions/electron-browser/extensions.contribution',
@@ -79,6 +81,8 @@ define([
 
 	'vs/workbench/parts/gettingStarted/electron-browser/electronGettingStarted.contribution',
 
+	'vs/workbench/electron-browser/darwin/cli.contribution',
+
 	'vs/workbench/electron-browser/main.contribution',
 	'vs/workbench/electron-browser/main'
 

author:joaomoreno
date:2016-02-18T16:32:13Z
title:fix vertical alignment in git changes view
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.css
code:
@@ -32,16 +32,16 @@
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .content {
 	line-height: 22px;
+	display: flex;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .content .monaco-action-bar {
-	float: right;
 	display: none;
 	margin-right: 12px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .content .monaco-action-bar .action-item {
-	vertical-align: middle;
+	margin-top: 2px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .content .monaco-action-bar .action-label {
@@ -72,14 +72,14 @@
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .count-badge-wrapper {
-	float: right;
 	padding-right: 12px;
 }
 
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .status-group,
 .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .file-status {
 	overflow: hidden;
 	text-overflow: ellipsis;
+	flex: 1;
 }
 
 .vs-dark .git-viewlet > .changes-view > .status-view > .monaco-tree .monaco-tree-row .status-group {

author:joaomoreno
date:2016-02-18T16:32:13Z
title:fix vertical alignment in git changes view
filename:src/vs/workbench/parts/git/browser/views/changes/changesViewer.ts
code:
@@ -265,13 +265,6 @@ export class Renderer implements tree.IRenderer {
 	private renderStatusGroupTemplate(statusType: git.StatusType, container: HTMLElement): IStatusGroupTemplateData {
 		var data: IStatusGroupTemplateData = Object.create(null);
 
-		data.actionBar = new actionbar.ActionBar(container, { actionRunner: this.actionRunner });
-		data.actionBar.push(this.actionProvider.getActionsForGroupStatusType(statusType), { icon: true, label: false });
-		data.actionBar.addListener2('run', e => e.error && this.onError(e.error));
-
-		const wrapper = dom.append(container, $('.count-badge-wrapper'));
-		data.count = new countbadge.CountBadge(wrapper);
-
 		data.root = dom.append(container, $('.status-group'));
 
 		switch (statusType) {
@@ -280,16 +273,19 @@ export class Renderer implements tree.IRenderer {
 			case git.StatusType.MERGE:			data.root.textContent = nls.localize('mergeChanges', "Merge Changes"); break;
 		}
 
+		const wrapper = dom.append(container, $('.count-badge-wrapper'));
+		data.count = new countbadge.CountBadge(wrapper);
+
+		data.actionBar = new actionbar.ActionBar(container, { actionRunner: this.actionRunner });
+		data.actionBar.push(this.actionProvider.getActionsForGroupStatusType(statusType), { icon: true, label: false });
+		data.actionBar.addListener2('run', e => e.error && this.onError(e.error));
+
 		return data;
 	}
 
 	private renderFileStatusTemplate(statusType: git.StatusType, container: HTMLElement): IFileStatusTemplateData {
 		var data: IFileStatusTemplateData = Object.create(null);
 
-		data.actionBar = new actionbar.ActionBar(container, { actionRunner: this.actionRunner });
-		data.actionBar.push(this.actionProvider.getActionsForFileStatusType(statusType), { icon: true, label: false });
-		data.actionBar.addListener2('run', e => e.error && this.onError(e.error));
-
 		data.root = dom.append(container, $('.file-status'));
 		data.status = dom.append(data.root, $('span.status'));
 		data.name = dom.append(data.root, $('a.name.plain'));
@@ -302,6 +298,10 @@ export class Renderer implements tree.IRenderer {
 		data.renameName = dom.append(rename, $('span.rename-name'));
 		data.renameFolder = dom.append(rename, $('span.rename-folder'));
 
+		data.actionBar = new actionbar.ActionBar(container, { actionRunner: this.actionRunner });
+		data.actionBar.push(this.actionProvider.getActionsForFileStatusType(statusType), { icon: true, label: false });
+		data.actionBar.addListener2('run', e => e.error && this.onError(e.error));
+
 		return data;
 	}
 

author:bgashler1
date:2016-02-19T03:34:05Z
title:Removed gitter on tree hover high-contrast
filename:src/vs/base/parts/tree/browser/tree.css
code:
@@ -202,7 +202,7 @@
 .hc-black .monaco-tree.focused .monaco-tree-rows > .monaco-tree-row.focused:not(.highlighted) 						{ border: 1px dotted #DF740C; }
 .hc-black .monaco-tree.focused .monaco-tree-rows > .monaco-tree-row.selected:not(.highlighted) 					{ border: 1px solid #DF740C; }
 .hc-black .monaco-tree .monaco-tree-rows > .monaco-tree-row.selected:not(.highlighted)  							{ border: 1px solid #DF740C; }
-.hc-black .monaco-tree .monaco-tree-rows > .monaco-tree-row:hover:not(.highlighted):not(.selected):not(.focused)  	{ border: 1px dashed #DF740C; }
+.hc-black .monaco-tree .monaco-tree-rows > .monaco-tree-row:hover:not(.highlighted):not(.selected):not(.focused)  	{ border: 1px dashed #DF740C; margin-top:-1px; margin-bottom:1px; margin-left:-1px; }
 .hc-black .monaco-tree .monaco-tree-wrapper.drop-target,
 .hc-black .monaco-tree .monaco-tree-rows > .monaco-tree-row.drop-target											{ background: none !important; border: 1px dashed #DF740C; }
 

author:joaomoreno
date:2016-02-23T08:56:21Z
title:compile: gitActions
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -66,9 +66,9 @@ export abstract class GitAction extends Action {
 	protected toDispose: IDisposable[];
 
 	constructor(id: string, label: string, cssClass: string, gitService: IGitService) {
-		this.gitService = gitService;
 		super(id, label, cssClass, false);
 
+		this.gitService = gitService;
 		this.toDispose = [this.gitService.addBulkListener2(() => this.onGitServiceChange())];
 		this.onGitServiceChange();
 	}
@@ -101,8 +101,8 @@ export class OpenChangeAction extends GitAction {
 	protected editorService: IWorkbenchEditorService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IGitService gitService: IGitService) {
-		this.editorService = editorService;
 		super(OpenChangeAction.ID, nls.localize('openChange', "Open Change"), 'git-action open-change', gitService);
+		this.editorService = editorService;
 	}
 
 	protected isEnabled():boolean {
@@ -132,10 +132,10 @@ export class OpenFileAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IFileService fileService: IFileService, @IGitService gitService: IGitService, @IWorkspaceContextService contextService: IWorkspaceContextService) {
+		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 		this.fileService = fileService;
 		this.editorService = editorService;
 		this.contextService = contextService;
-		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -312,12 +312,12 @@ export abstract class BaseUndoAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(id: string, label: string, className: string, gitService: IGitService, eventService: IEventService, messageService: IMessageService, fileService:IFileService, editorService: IWorkbenchEditorService, contextService: IWorkspaceContextService) {
+		super(id, label, className, gitService);
 		this.eventService = eventService;
 		this.editorService = editorService;
 		this.messageService = messageService;
 		this.fileService = fileService;
 		this.contextService = contextService;
-		super(id, label, className, gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -595,13 +595,13 @@ export class CheckoutAction extends GitAction {
 	private runPromises: Promise[];
 
 	constructor(branch: IBranch, @IGitService gitService: IGitService, @IWorkbenchEditorService editorService: IWorkbenchEditorService) {
+		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
+
 		this.editorService = editorService;
 		this.branch = branch;
 		this.HEAD = null;
 		this.state = LifecycleState.Alive;
 		this.runPromises = [];
-
-		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
 	}
 
 	protected onGitServiceChange(): void {
@@ -766,8 +766,8 @@ export class SmartCommitAction extends BaseCommitAction {
 	private messageService: IMessageService;
 
 	constructor(commitState: ICommitState, @IGitService gitService: IGitService, @IMessageService messageService: IMessageService) {
-		this.messageService = messageService;
 		super(commitState, SmartCommitAction.ID, SmartCommitAction.ALL, 'git-action smart-commit', gitService);
+		this.messageService = messageService;
 	}
 
 	protected onGitServiceChange(): void {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.travis.yml
code:
@@ -21,8 +21,9 @@ before_install:
   - git submodule update --init --recursive
   - git clone https://github.com/creationix/nvm.git ./.nvm
   - source ./.nvm/nvm.sh
-  - nvm install 0.12
-  - nvm use 0.12
+  - nvm install node
+  - nvm use node
+  - npm install -g npm@2
   - npm config set python `which python`
   - npm install -g gulp
   - if [ $TRAVIS_OS_NAME == "linux" ]; then

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.vscode/launch.json
code:
@@ -45,8 +45,14 @@
 			"type": "chrome",
 			"request": "attach",
 			"port": 9222,
-			"sourceMaps": true,
-			"outDir": "${workspaceRoot}/out"
+			"sourceMaps": true
+		},
+		{
+			"name": "Launch VSCode",
+			"type": "chrome",
+			"request": "launch",
+			"runtimeExecutable": "${workspaceRoot}/scripts/code.bat",
+			"sourceMaps": true
 		},
 		{
 			"name": "Convert css-schema to browser.js",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/.eslintrc
code:
@@ -0,0 +1,6 @@
+{
+	"rules": {
+		"no-undef": 2,
+		"no-unused-vars": 1
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-/*global process,__dirname, Buffer*/
+/*global process,__dirname,Buffer,require*/
 
 var gulp = require('gulp');
 var fs = require('fs');
@@ -16,11 +16,8 @@ var rename = require('gulp-rename');
 var replace = require('gulp-replace');
 var filter = require('gulp-filter');
 var json = require('gulp-json-editor');
-var insert = require('gulp-insert');
 var remote = require('gulp-remote-src');
 var shell = require("gulp-shell");
-var File = require('vinyl');
-var rimraf = require('rimraf');
 var _ = require('underscore');
 var packageJson = require('../package.json');
 var util = require('./lib/util');
@@ -40,10 +37,6 @@ var baseModules = [
 
 // Build
 
-var builtInExtensions = {
-	'ms-vscode.omnisharp': '0.3.2',
-};
-
 var vscodeEntryPoints = _.flatten([
 	buildfile.entrypoint('vs/workbench/workbench.main'),
 	buildfile.base,
@@ -160,12 +153,8 @@ function packageTask(platform, arch, opts) {
 
 	return function () {
 		var out = opts.minified ? 'out-vscode-min' : 'out-vscode';
-		var pluginHostFilter = filter(out + '/vs/workbench/node/pluginHostProcess.js', { restore: true });
 
 		var src = gulp.src(out + '/**', { base: '.' })
-			.pipe(pluginHostFilter)
-			.pipe(insert.append('\n//# sourceMappingURL=pluginHostProcess.js.map'))
-			.pipe(pluginHostFilter.restore)
 			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }))
 			.pipe(util.setExecutableBit(['**/*.sh']));
 
@@ -184,13 +173,9 @@ function packageTask(platform, arch, opts) {
 			'!extensions/json/server/node_modules/mocha/**'
 		], { base: '.' });
 
-		var pluginHostSourceMap = gulp.src(out + '/vs/workbench/node/pluginHostProcess.js.map', { base: '.' })
-			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }));
-
-		var sources = es.merge(
-			es.merge(src, extensions).pipe(filter(['**', '!**/*.js.map'])),
-			pluginHostSourceMap
-		).pipe(util.handleAzureJson({ platform: platform }));
+		var sources = es.merge(src, extensions)
+			.pipe(filter(['**', '!**/*.js.map']))
+			.pipe(util.handleAzureJson({ platform: platform }));
 
 		var version = packageJson.version;
 		var quality = product.quality;
@@ -218,19 +203,13 @@ function packageTask(platform, arch, opts) {
 			.pipe(util.cleanNodeModule('native-keymap', ['binding.gyp', 'build/**', 'src/**', 'deps/**'], true))
 			.pipe(util.cleanNodeModule('weak', ['binding.gyp', 'build/**', 'src/**'], true));
 
-		var extraExtensions = util.downloadExtensions(builtInExtensions)
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join('extensions', p.dirname);
-			}));
-
 		var all = es.merge(
 			api,
 			packageJsonStream,
 			mixinProduct(),
 			license,
 			sources,
-			deps,
-			extraExtensions
+			deps
 		);
 
 		if (platform === 'win32') {
@@ -267,11 +246,15 @@ function getDebPackageArch(arch) {
 	return { x64: 'amd64', ia32: 'i386' }[arch];
 }
 
+function getEpochTime() {
+	return Math.floor(new Date().getTime() / 1000);
+}
+
 function prepareDebPackage(arch) {
 	var binaryDir = '../VSCode-linux-' + arch;
 	var debArch = getDebPackageArch(arch);
-	var destination = '.build/linux/vscode-' + debArch;
-	var packageRevision = '1';
+	var destination = '.build/linux/' + debArch + '/vscode-' + debArch;
+	var packageRevision = getEpochTime();
 
 	return function () {
 		var shortcut = gulp.src('resources/linux/bin/code.sh')
@@ -309,16 +292,25 @@ function prepareDebPackage(arch) {
 }
 
 function buildDebPackage(arch) {
-	return shell.task(['fakeroot dpkg-deb -b .build/linux/vscode-' + getDebPackageArch(arch)]);
+	var debArch = getDebPackageArch(arch);
+	return shell.task([
+		'fakeroot dpkg-deb -b vscode-' + debArch,
+		'dpkg-scanpackages . /dev/null > Packages'
+	], { cwd: '.build/linux/' + debArch});
+}
+
+function buildDebPackageCatalog(arch) {
+	var debArch = getDebPackageArch(arch);
+	return shell.task([], { cwd: '.build/linux/' + debArch});
 }
 
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
 gulp.task('clean-vscode-darwin', util.rimraf(path.join(path.dirname(root), 'VSCode-darwin')));
 gulp.task('clean-vscode-linux-ia32', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-ia32')));
 gulp.task('clean-vscode-linux-x64', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-x64')));
 gulp.task('clean-vscode-linux-arm', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-arm')));
-gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/vscode-i386*'));
-gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/vscode-amd64*'));
+gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/i386'));
+gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/amd64'));
 
 gulp.task('vscode-win32', ['optimize-vscode', 'clean-vscode-win32'], packageTask('win32'));
 gulp.task('vscode-darwin', ['optimize-vscode', 'clean-vscode-darwin'], packageTask('darwin'));
@@ -336,7 +328,8 @@ gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vsco
 gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb', 'vscode-linux-x64-min'], prepareDebPackage('x64'));
 gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
 gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
-gulp.task('vscode-linux-packages', ['vscode-linux-ia32-build-deb', 'vscode-linux-x64-build-deb']);
+gulp.task('vscode-linux-ia32-build-deb-catalog', ['vscode-linux-ia32-build-deb'], buildDebPackageCatalog('ia32'));
+gulp.task('vscode-linux-x64-build-deb-catalog', ['vscode-linux-x64-build-deb'], buildDebPackageCatalog('x64'));
 
 // Sourcemaps
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/lib/util.js
code:
@@ -1,11 +1,17 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+/*global require,exports,process,Buffer*/
+
 var es = require('event-stream');
 var debounce = require('debounce');
 var filter = require('gulp-filter');
 var azure = require('gulp-azure-storage');
 var rename = require('gulp-rename');
 var vzip = require('gulp-vinyl-zip');
 var util = require('gulp-util');
-var remote = require('gulp-remote-src');
 var _ = require('underscore');
 var path = require('path');
 var fs = require('fs');
@@ -252,32 +258,6 @@ exports.rimraf = function(dir) {
 	};
 };
 
-exports.downloadExtensions = function(extensions) {
-	var streams = Object.keys(extensions).map(function (fullName) {
-		var version = extensions[fullName];
-		var match = /^([^.]+)\.([^.]+)$/.exec(fullName);
-
-		if (!match) {
-			throw new Error('Bad extension: ' + fullName);
-		}
-
-		var publisher = match[1];
-		var name = match[2];
-		var url = 'https://' + publisher + '.gallery.vsassets.io/_apis/public/gallery/publisher/'
-			+ publisher + '/extension/' + name + '/' + version
-			+ '/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage';
-
-		return remote(url, { base: '' })
-			.pipe(vzip.src())
-			.pipe(filter('extension/**'))
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join(fullName, p.dirname.replace(/^extension[/\\]?/, ''));
-			}));
-	});
-
-	return es.merge(streams);
-};
-
 exports.getVersion = function (root) {
 	var version = process.env['BUILD_SOURCEVERSION'];
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/package.json
code:
@@ -0,0 +1,28 @@
+{
+	"name": "javascript-migration",
+	"displayName": "Helper extension for migrating to Salsa",
+	"description": "Informs users about the JS Salsa upgrade",
+	"version": "0.0.1",
+	"publisher": "vscode",
+	"engines": {
+		"vscode": "*"
+	},
+	"categories": [
+		"Other"
+	],
+	"activationEvents": [
+		"onLanguage:javascript",
+		"onLanguage:javascriptreact"
+	],
+	"main": "./out/extension",
+
+	"scripts": {
+		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:javascript-migration ./src/tsconfig.json"
+	},
+	"devDependencies": {
+		"typescript": "^1.7.5",
+		"vscode": "^0.11.0"
+	},
+    "dependencies": {
+    }
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/extension.ts
code:
@@ -0,0 +1,42 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as vscode from 'vscode';
+import * as cp from 'child_process';
+
+
+export function activate(context: vscode.ExtensionContext) {
+	const releaseNotesShown = 'javascript.releasenotesshown';
+
+	if (!context.globalState.get(releaseNotesShown)) {
+		// cheating with nls, this is a temporary extenion only, that doesn't need be localized
+		vscode.window.showInformationMessage('The JavaScript infrastructure has changed, please read the change notes.', 'Change Notes').then(selection => {
+			if (selection) {
+				open('http://go.microsoft.com/fwlink/?LinkId=733559');
+			}
+			context.globalState.update(releaseNotesShown, true);
+		});
+	}
+}
+
+function open(url: string) {
+	var cmd: string;
+
+	switch (process.platform) {
+		case 'darwin':
+			cmd = 'open';
+			break;
+		case 'win32':
+			cmd = 'start';
+			break;
+		default:
+			cmd = 'xdg-open';
+	}
+	return cp.exec(cmd + ' ' + url);
+}
+
+export function deactivate() {
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/tsconfig.json
code:
@@ -0,0 +1,12 @@
+{
+	"compilerOptions": {
+		"noLib": true,
+		"target": "es5",
+		"module": "commonjs",
+		"sourceMap": false,
+		"outDir": "../out"
+	},
+	"exclude": [
+		"node_modules"
+	]
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/json/src/jsonMain.ts
code:
@@ -75,7 +75,17 @@ export function activate(context: ExtensionContext) {
 	context.subscriptions.push(disposable);
 
 	languages.setLanguageConfiguration('json', {
-		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g
+		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g,
+		__characterPairSupport: {
+			autoClosingPairs: [
+				{ open: '{', close: '}' },
+				{ open: '[', close: ']' },
+				{ open: '(', close: ')' },
+				{ open: '"', close: '"', notIn: ['string'] },
+				{ open: '\'', close: '\'', notIn: ['string', 'comment'] },
+				{ open: '`', close: '`', notIn: ['string', 'comment'] }
+			]
+		}
 	});
 }
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node-debug/node-debug.azure.json
code:
@@ -1,6 +1,6 @@
 {
 	"account": "monacobuild",
 	"container": "debuggers",
-	"zip": "91c3d00/node-debug.zip",
+	"zip": "609a344/node-debug.zip",
 	"output": ""
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node.d.ts
code:
@@ -648,7 +648,7 @@ declare module "child_process" {
         maxBuffer?: number;
         killSignal?: string;
     }, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
-    export function exec(command: string, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
+    export function exec(command: string, callback?: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
     export function execFile(file: string, args: string[], options: {
         cwd?: string;
         stdio?: any;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/php/src/features/validationProvider.ts
code:
@@ -184,41 +184,49 @@ export default class PHPValidationProvider {
 			} else {
 				args = PHPValidationProvider.BufferArgs;
 			}
-			let childProcess = cp.spawn(executable, args, options);
-			childProcess.on('error', (error: Error) => {
-				if (this.executableNotFound) {
+			try {
+				let childProcess = cp.spawn(executable, args, options);
+				childProcess.on('error', (error: Error) => {
+					if (this.executableNotFound) {
+						resolve();
+						return;
+					}
+					this.showError(error, executable);
+					this.executableNotFound = true;
 					resolve();
-					return;
-				}
-				let message: string = null;
-				if ((<any>error).code === 'ENOENT') {
-					message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
-				} else {
-					message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
-				}
-				vscode.window.showInformationMessage(message);
-				this.executableNotFound = true;
-				resolve();
-			});
-			if (childProcess.pid) {
-				if (this.trigger === RunTrigger.onType) {
-					childProcess.stdin.write(textDocument.getText());
-					childProcess.stdin.end();
-				}
-				childProcess.stdout.on('data', (data: Buffer) => {
-					decoder.write(data).forEach(processLine);
 				});
-				childProcess.stdout.on('end', () => {
-					let line = decoder.end();
-					if (line) {
-						processLine(line);
+				if (childProcess.pid) {
+					if (this.trigger === RunTrigger.onType) {
+						childProcess.stdin.write(textDocument.getText());
+						childProcess.stdin.end();
 					}
-					this.diagnosticCollection.set(textDocument.uri, diagnostics);
+					childProcess.stdout.on('data', (data: Buffer) => {
+						decoder.write(data).forEach(processLine);
+					});
+					childProcess.stdout.on('end', () => {
+						let line = decoder.end();
+						if (line) {
+							processLine(line);
+						}
+						this.diagnosticCollection.set(textDocument.uri, diagnostics);
+						resolve();
+					});
+				} else {
 					resolve();
-				});
-			} else {
-				resolve();
+				}
+			} catch (error) {
+				this.showError(error, executable);
 			}
 		});
 	}
+
+	private showError(error: any, executable: string): void {
+		let message: string = null;
+		if (error.code === 'ENOENT') {
+			message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
+		} else {
+			message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
+		}
+		vscode.window.showInformationMessage(message);
+	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/swift/snippets/swift.json
code:
@@ -1,22 +1,22 @@
 {
-	"println(\"...\")": {
+	"print(\"...\")": {
 		"prefix": "pr",
-		"body": "println(\"$1\")$0"
+		"body": "print(\"$1\")$0"
 	},
-	"println(\"\\(...)\")": {
+	"print(\"\\(...)\")": {
 		"prefix": "po",
-		"body": "println(\"\\($1)\")$0"
+		"body": "print(\"\\($1)\")$0"
 	},
 
-	"do...while loop": {
+	"repeat...while loop": {
 
-		"prefix": "do",
+		"prefix": "repeat",
 		"body": [
-			"do {",
+			"repeat {",
 			"	$0",
 			"} while ${true}"
 		],
-		"description": "do...while loop"
+		"description": "repeat...while loop"
 	},
 
 	"While loop": {
@@ -96,6 +96,28 @@
 		"description": "Else statement"
 	},
 
+	"Guard statement": {
+
+		"prefix": "guard",
+		"body": [
+			"guard let ${a} = ${optional} else {",
+			"	$0",
+			"}"
+		],
+		"description": "Guard statement"
+	},
+
+	"Optional Binding statement": {
+
+		"prefix": "ifnil",
+		"body": [
+			"if let ${a} = ${optional} {",
+			"	$0",
+			"}"
+		],
+		"description": "Optional Binding statement"
+	},
+
 	"Switch statement": {
 
 		"prefix": "switch",
@@ -133,4 +155,4 @@
 		],
 		"description": "Enum"
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/tasks/src/tasksMain.ts
code:
@@ -72,6 +72,17 @@ function createCompletionItems(): CompletionItem[] {
 	].join('\n');
 	result.push(item);
 
+	item = new CompletionItem('dotnet build');
+	item.kind = CompletionItemKind.Snippet;
+	item.detail = 'Use dotnet build.';
+	item.filterText = 'ts-dotnet build';
+	item.insertText = [
+		'"version": "0.1.0",',
+		'"command": "dotnet build",',
+		'"showOutput": "always"'
+	].join('\n');
+	result.push(item);
+
 	item = new CompletionItem('msbuild');
 	item.kind = CompletionItemKind.Snippet;
 	item.detail = 'Use msbuild to compile your project.';

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/package.json
code:
@@ -6,9 +6,13 @@
 	"author": "Microsoft Corporation",
 	"license": "MIT",
 	"publisher": "vscode",
+	"aiKey":"AIF-d9b70cd4-b9f9-4d70-929b-a071c400b217",
 	"engines": {
 		"vscode": "*"
 	},
+	"dependencies": {
+    "vscode-extension-telemetry": "^0.0.4"
+	},
 	"scripts": {
 		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:typescript ./src/tsconfig.json"
 	},

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptMain.ts
code:
@@ -113,11 +113,6 @@ function registerSupports(modeID: string, host: TypeScriptServiceClientHost, cli
 		],
 
 		__electricCharacterSupport: {
-			brackets: [
-				{ tokenType: 'delimiter.curly.' + modeID, open: '{', close: '}', isElectric: true },
-				{ tokenType: 'delimiter.square.' + modeID, open: '[', close: ']', isElectric: true },
-				{ tokenType: 'delimiter.paren.' + modeID, open: '(', close: ')', isElectric: true }
-			],
 			docComment: { scope: 'comment.documentation', open: '/**', lineStart: ' * ', close: ' */' }
 		},
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptServiceClient.ts
code:
@@ -18,6 +18,8 @@ import { ITypescriptServiceClient, ITypescriptServiceClientHost }  from './types
 
 import * as VersionStatus from './utils/versionStatus';
 
+import TelemetryReporter from 'vscode-extension-telemetry';
+
 interface CallbackItem {
 	c: (value: any) => void;
 	e: (err: any) => void;
@@ -34,6 +36,12 @@ interface RequestItem {
 	callbacks: CallbackItem;
 }
 
+interface IPackageInfo {
+	name: string;
+	version: string;
+	aiKey: string;
+}
+
 export default class TypeScriptServiceClient implements ITypescriptServiceClient {
 
 	public static Trace: boolean = process.env.TSS_TRACE || false;
@@ -56,6 +64,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 	private pendingResponses: number;
 	private callbacks: CallbackMap;
 
+	private _packageInfo: IPackageInfo;
+	private telemetryReporter: TelemetryReporter;
+
 	constructor(host: ITypescriptServiceClientHost) {
 		this.host = host;
 		this.pathSeparator = path.sep;
@@ -83,6 +94,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				this.startService();
 			}
 		});
+		if (this.packageInfo && this.packageInfo.aiKey) {
+			this.telemetryReporter = new TelemetryReporter(this.packageInfo.name, this.packageInfo.version, this.packageInfo.aiKey);
+		}
 		this.startService();
 	}
 
@@ -94,6 +108,32 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 		return TypeScriptServiceClient.Trace;
 	}
 
+	private get packageInfo(): IPackageInfo {
+
+		if (this._packageInfo !== undefined) {
+			return this._packageInfo;
+		}
+		let packagePath = path.join(__dirname, './../package.json');
+		let extensionPackage = require(packagePath);
+		if (extensionPackage) {
+			this._packageInfo = {
+				name: extensionPackage.name,
+				version: extensionPackage.version,
+				aiKey: extensionPackage.aiKey
+			};
+		} else {
+			this._packageInfo = null;
+		}
+
+		return this._packageInfo;
+	}
+
+	private logTelemetry(eventName: string, properties?: {[prop: string]: string}) {
+		if (this.telemetryReporter) {
+			this.telemetryReporter.sendTelemetryEvent(eventName, properties);
+		}
+	}
+
 	private service(): Promise<cp.ChildProcess> {
 		if (this.servicePromise) {
 			return this.servicePromise;
@@ -141,6 +181,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 					if (err) {
 						this.lastError = err;
 						window.showErrorMessage(`TypeScript language server couldn\'t be started. Error message is: ${err.message}`);
+						this.logTelemetry('error', {message: err.message});
 						return;
 					}
 					this.lastStart = Date.now();
@@ -212,6 +253,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				} else if (diff < 2 * 1000 /* 2 seconds */) {
 					startService = false;
 					window.showErrorMessage('The Typesrript language service died 5 times right after it got started. The service will not be restarted. Please open a bug report.');
+					this.logTelemetry('serviceExited');
 				}
 			}
 			if (startService) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/node.additions.d.ts
code:
@@ -25,4 +25,13 @@ interface Console {
 declare var Console: {
     prototype: Console;
     new(): Console;
+};
+
+declare var require: {
+	toUrl(path: string): string;
+	(moduleName: string): any;
+	(dependencies: string[], callback: (...args: any[]) => any, errorback?: (err: any) => void): any;
+	config(data: any): any;
+	onError: Function;
+	__$__nodeRequire<T>(moduleName: string): T;
 };
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/vscode-extension-telemetry.d.ts
code:
@@ -0,0 +1,6 @@
+declare module 'vscode-extension-telemetry' {
+	export default class TelemetryReporter {
+		constructor(extensionId: string,extensionVersion: string, key: string);
+		sendTelemetryEvent(eventName: string, properties?: { [key: string]: string }, measures?: { [key: string]: number }): void;
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:package.json
code:
@@ -13,7 +13,7 @@
   "scripts": {
     "test": "node node_modules/mocha/bin/_mocha",
     "preinstall": "node build/npm/preinstall.js",
-    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/"
+    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/ && npm --prefix extensions/typescript/ install extensions/typescript/"
   },
   "dependencies": {
     "applicationinsights": "0.15.6",
@@ -24,11 +24,11 @@
     "http-proxy-agent": "^0.2.6",
     "https-proxy-agent": "^0.3.5",
     "iconv-lite": "^0.4.13",
+    "native-keymap": "^0.1.2",
     "sax": "^1.1.1",
     "semver": "^4.2.0",
     "vscode-debugprotocol": "^1.5.0",
     "vscode-textmate": "^1.0.11",
-    "native-keymap": "^0.1.2",
     "weak": "^1.0.1",
     "winreg": "0.0.12",
     "yauzl": "^2.3.1"
@@ -52,7 +52,6 @@
     "gulp-concat": "^2.6.0",
     "gulp-cssnano": "^2.1.0",
     "gulp-filter": "^3.0.0",
-    "gulp-insert": "^0.5.0",
     "gulp-json-editor": "^2.2.1",
     "gulp-mocha": "^2.1.3",
     "gulp-remote-src": "^0.4.0",
@@ -82,7 +81,7 @@
     "rimraf": "^2.2.8",
     "sinon": "^1.17.2",
     "source-map": "^0.4.4",
-    "tslint": "^3.2.2",
+    "tslint": "^3.3.0",
     "typescript": "^1.8.0",
     "uglify-js": "2.4.8",
     "underscore": "^1.8.2",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/dom.ts
code:
@@ -4,18 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as mouseEvent from 'vs/base/browser/mouseEvent';
-import * as keyboardEvent from 'vs/base/browser/keyboardEvent';
-import {isChrome, isWebKit} from 'vs/base/browser/browser';
-import types = require('vs/base/common/types');
+import {TimeoutTimer} from 'vs/base/common/async';
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
 import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
-import {onUnexpectedError} from 'vs/base/common/errors';
-import browserService = require('vs/base/browser/browserService');
-import {TimeoutTimer} from 'vs/base/common/async';
-
-export type IKeyboardEvent = keyboardEvent.IKeyboardEvent;
-export type IMouseEvent = mouseEvent.IMouseEvent;
+import {isObject} from 'vs/base/common/types';
+import {isChrome, isWebKit} from 'vs/base/browser/browser';
+import {getService} from 'vs/base/browser/browserService';
+import {IKeyboardEvent, StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export function clearNode(node: HTMLElement) {
 	while (node.firstChild) {
@@ -37,7 +34,7 @@ export function safeStringifyDOMAware(obj: any): string {
 			return '[Element]';
 		}
 
-		if (types.isObject(value) || Array.isArray(value)) {
+		if (isObject(value) || Array.isArray(value)) {
 			if (seen.indexOf(value) !== -1) {
 				return '[Circular]';
 			} else {
@@ -243,12 +240,12 @@ export interface IAddStandardDisposableListenerSignature {
 }
 function _wrapAsStandardMouseEvent(handler: (e: IMouseEvent) => void): (e: MouseEvent) => void {
 	return function(e: MouseEvent) {
-		return handler(new mouseEvent.StandardMouseEvent(e));
+		return handler(new StandardMouseEvent(e));
 	};
 }
 function _wrapAsStandardKeyboardEvent(handler: (e: IKeyboardEvent) => void): (e: KeyboardEvent) => void {
 	return function(e: KeyboardEvent) {
-		return handler(new keyboardEvent.StandardKeyboardEvent(e));
+		return handler(new StandardKeyboardEvent(e));
 	};
 }
 export let addStandardDisposableListener: IAddStandardDisposableListenerSignature = function addStandardDisposableListener(node: HTMLElement, type: string, handler: (event: any) => void, useCapture?: boolean): IDisposable {
@@ -779,7 +776,7 @@ export function removeCSSRulesWithPrefix(ruleName: string, style = sharedStyle):
 }
 
 export function isHTMLElement(o: any): o is HTMLElement {
-	return browserService.getService().isHTMLElement(o);
+	return getService().isHTMLElement(o);
 }
 
 export const EventType = {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/globalMouseMoveMonitor.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import * as dom from 'vs/base/browser/dom';
 import {IframeUtils} from 'vs/base/browser/iframe';
+import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export interface IStandardMouseMoveEventData {
 	leftButton:boolean;
@@ -92,32 +92,32 @@ export class GlobalMouseMoveMonitor<R> implements IDisposable {
 
 		let windowChain = IframeUtils.getSameOriginWindowChain();
 		for (let i = 0; i < windowChain.length; i++) {
-			this.hooks.push(DomUtils.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
+			this.hooks.push(dom.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
 				(data:R) => this.mouseMoveCallback(data),
 				(lastEvent:R, currentEvent:MouseEvent) => this.mouseMoveEventMerger(lastEvent, currentEvent)
 			));
-			this.hooks.push(DomUtils.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
+			this.hooks.push(dom.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
 		}
 
 		if (IframeUtils.hasDifferentOriginAncestor()) {
 			let lastSameOriginAncestor = windowChain[windowChain.length - 1];
 			// We might miss a mouse up if it happens outside the iframe
 			// This one is for Chrome
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for FF
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for IE
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
 				this.stopMonitoring(true);
 			}));
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/htmlContentRenderer.ts
code:
@@ -11,11 +11,12 @@ import {IHTMLContentElement} from 'vs/base/common/htmlContent';
 // import {WorkerClient} from 'vs/base/common/worker/workerClient';
 // import {DefaultWorkerFactory} from 'vs/base/worker/defaultWorkerFactory';
 import {marked} from 'vs/base/common/marked/marked';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export type RenderableContent = string | IHTMLContentElement | IHTMLContentElement[];
 
 export interface RenderOptions {
-	actionCallback?: (content: string, event?: DOM.IMouseEvent) => void;
+	actionCallback?: (content: string, event?: IMouseEvent) => void;
 	codeBlockRenderer?: (modeId: string, value: string) => string;
 }
 
@@ -228,7 +229,7 @@ interface IFormatParseTree {
 	children?: IFormatParseTree[];
 }
 
-function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: DOM.IMouseEvent) => void) {
+function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: IMouseEvent) => void) {
 	var child: Node;
 
 	if (treeNode.type === FormatType.Text) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/idleMonitor.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
-import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
+import {TimeoutTimer} from 'vs/base/common/async';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
+import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
 import {getService} from 'vs/base/browser/browserService';
-import {TimeoutTimer} from 'vs/base/common/async';
+import * as dom from 'vs/base/browser/dom';
 
 export enum UserStatus {
 	Idle,
@@ -34,8 +34,8 @@ export class IdleMonitor extends Disposable {
 		this._idleTime = idleTime;
 
 		this._eventEmitter = this._register(new EventEmitter());
-		this._register(DomUtils.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
-		this._register(DomUtils.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
 		this._onUserActive();
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/keyboardEvent.ts
code:
@@ -5,9 +5,9 @@
 
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
-import {KeyMod, KeyCode} from 'vs/base/common/keyCodes';
+import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 
 let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 (function() {
@@ -127,18 +127,18 @@ let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 
 	KEY_CODE_MAP[226] = KeyCode.OEM_102;
 
-	if (Browser.isIE11orEarlier) {
+	if (browser.isIE11orEarlier) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-	} else if (Browser.isFirefox) {
+	} else if (browser.isFirefox) {
 		KEY_CODE_MAP[59] = KeyCode.US_SEMICOLON;
 		KEY_CODE_MAP[107] = KeyCode.US_EQUAL;
 		KEY_CODE_MAP[109] = KeyCode.US_MINUS;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			KEY_CODE_MAP[224] = KeyCode.Meta;
 		}
-	} else if (Browser.isWebKit) {
+	} else if (browser.isWebKit) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			// the two meta keys in the Mac have different key codes (91 and 93)
 			KEY_CODE_MAP[93] = KeyCode.Meta;
 		} else {
@@ -187,10 +187,10 @@ export interface IKeyboardEvent {
 	stopPropagation(): void;
 }
 
-const ctrlKeyMod = (Platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
+const ctrlKeyMod = (platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
 const altKeyMod = KeyMod.Alt;
 const shiftKeyMod = KeyMod.Shift;
-const metaKeyMod = (Platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
+const metaKeyMod = (platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
 
 export class StandardKeyboardEvent implements IKeyboardEvent {
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/mouseEvent.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 import {IframeUtils} from 'vs/base/browser/iframe';
 
 export interface IMouseEvent {
@@ -21,6 +21,7 @@ export interface IMouseEvent {
 	shiftKey:boolean;
 	altKey:boolean;
 	metaKey:boolean;
+	timestamp:number;
 
 	preventDefault(): void;
 	stopPropagation(): void;
@@ -82,7 +83,7 @@ export class StandardMouseEvent implements IMouseEvent {
 		};
 
 		let test1 = readPageCoords, test2 = readClientCoords;
-		if (Browser.isIE10) {
+		if (browser.isIE10) {
 			// The if A elseif B logic here is inversed in IE10 due to an IE10 issue
 			test1 = readClientCoords;
 			test2 = readPageCoords;
@@ -183,7 +184,7 @@ export class StandardMouseWheelEvent {
 
 			// horizontal delta scroll
 			if (typeof e1.wheelDeltaX !== 'undefined') {
-				if (Browser.isSafari && Platform.isWindows) {
+				if (browser.isSafari && platform.isWindows) {
 					this.deltaX = - (e1.wheelDeltaX / 120);
 				} else {
 					this.deltaX = e1.wheelDeltaX / 120;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/checkbox/checkbox.ts
code:
@@ -10,14 +10,14 @@ import 'vs/css!./checkbox';
 import DOM = require('vs/base/browser/dom');
 import {KeyCode} from 'vs/base/common/keyCodes';
 import {Widget} from 'vs/base/browser/ui/widget';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 
 export interface ICheckboxOpts {
 	actionClassName: string;
 	title: string;
 	isChecked: boolean;
 	onChange: (viaKeyboard: boolean) => void;
-	onKeyDown?: (e: StandardKeyboardEvent) => void;
+	onKeyDown?: (e: IKeyboardEvent) => void;
 }
 
 export class Checkbox extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/findinput/findInput.ts
code:
@@ -13,8 +13,8 @@ import {Checkbox} from 'vs/base/browser/ui/checkbox/checkbox';
 import {IContextViewProvider} from 'vs/base/browser/ui/contextview/contextview';
 import {Widget} from 'vs/base/browser/ui/widget';
 import Event, {Emitter} from 'vs/base/common/event';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
 export interface IFindInputOptions {
@@ -59,17 +59,17 @@ export class FindInput extends Widget {
 	private _onDidOptionChange = this._register(new Emitter<boolean>());
 	public onDidOptionChange: Event<boolean /* via keyboard */> = this._onDidOptionChange.event;
 
-	private _onKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyDown: Event<StandardKeyboardEvent> = this._onKeyDown.event;
+	private _onKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyDown: Event<IKeyboardEvent> = this._onKeyDown.event;
 
 	private _onInput = this._register(new Emitter<void>());
 	public onInput: Event<void> = this._onInput.event;
 
-	private _onKeyUp = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyUp: Event<StandardKeyboardEvent> = this._onKeyUp.event;
+	private _onKeyUp = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyUp: Event<IKeyboardEvent> = this._onKeyUp.event;
 
-	private _onCaseSensitiveKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onCaseSensitiveKeyDown: Event<StandardKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
+	private _onCaseSensitiveKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onCaseSensitiveKeyDown: Event<IKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
 
 	constructor(parent:HTMLElement, contextViewProvider: IContextViewProvider, options?:IFindInputOptions) {
 		super();
@@ -257,7 +257,7 @@ export class FindInput extends Widget {
 
 		// Arrow-Key support to navigate between options
 		let indexes = [this.caseSensitive.domNode, this.wholeWords.domNode, this.regex.domNode];
-		this.onkeydown(this.domNode, (event: StandardKeyboardEvent) => {
+		this.onkeydown(this.domNode, (event: IKeyboardEvent) => {
 			if (event.equals(CommonKeybindings.LEFT_ARROW) || event.equals(CommonKeybindings.RIGHT_ARROW) || event.equals(CommonKeybindings.ESCAPE)) {
 				let index = indexes.indexOf(<HTMLElement>document.activeElement);
 				if (index >= 0) {
@@ -317,7 +317,7 @@ export class FindInput extends Widget {
 }
 
 interface IMatchCountOpts {
-	onClick: (e:StandardMouseEvent) => void;
+	onClick: (e:IMouseEvent) => void;
 }
 
 class MatchCount extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/abstractScrollbar.ts
code:
@@ -7,7 +7,7 @@
 import * as Browser from 'vs/base/browser/browser';
 import * as Platform from 'vs/base/common/platform';
 import * as DomUtils from 'vs/base/browser/dom';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 import {IMouseWheelEvent, IParent, Visibility, IScrollbar} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {Disposable} from 'vs/base/common/lifecycle';
 import {GlobalMouseMoveMonitor, IStandardMouseMoveEventData, standardMouseMoveMerger} from 'vs/base/browser/globalMouseMoveMonitor';
@@ -215,7 +215,7 @@ class ScrollbarArrow extends Widget {
 		this._mousedownScheduleRepeatTimer = this._register(new TimeoutTimer());
 	}
 
-	private _arrowMouseDown(e: StandardMouseEvent): void {
+	private _arrowMouseDown(e: IMouseEvent): void {
 		let repeater = () => {
 			this._parent.onMouseWheel(this._mouseWheelEventFactory());
 		};
@@ -446,7 +446,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	// ----------------- DOM events
 
-	private _domNodeMouseDown(e: StandardMouseEvent): void {
+	private _domNodeMouseDown(e: IMouseEvent): void {
 		if (e.target !== this.domNode) {
 			return;
 		}
@@ -468,14 +468,14 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 		}
 	}
 
-	private _onMouseDown(e: StandardMouseEvent): void {
+	private _onMouseDown(e: IMouseEvent): void {
 		let domNodePosition = DomUtils.getDomNodePosition(this.domNode);
 		let desiredSliderPosition = this._mouseDownRelativePosition(e, domNodePosition) - this._scrollbarState.getArrowSize() - this._scrollbarState.getSliderSize() / 2;
 		this.setDesiredScrollPosition(this._scrollbarState.convertSliderPositionToScrollPosition(desiredSliderPosition));
 		this._sliderMouseDown(e);
 	}
 
-	private _sliderMouseDown(e: StandardMouseEvent): void {
+	private _sliderMouseDown(e: IMouseEvent): void {
 		if (e.leftButton) {
 			let initialMouseOrthogonalPosition = this._sliderOrthogonalMousePosition(e);
 			let initialScrollPosition = this._getScrollPosition();
@@ -523,7 +523,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	protected abstract _renderDomNode(largeSize: number, smallSize: number): void;
 	protected abstract _updateSlider(sliderSize: number, sliderPosition: number): void;
-	protected abstract _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
+	protected abstract _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
 	protected abstract _sliderMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _sliderOrthogonalMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _getScrollPosition(): number;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -57,7 +57,7 @@ export class HorizontalScrollbar extends AbstractScrollbar {
 		StyleMutator.setBottom(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posx - domNodePosition.left;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/scrollableElementImpl.ts
code:
@@ -8,7 +8,7 @@ import 'vs/css!./media/scrollbars';
 
 import * as DomUtils from 'vs/base/browser/dom';
 import * as Platform from 'vs/base/common/platform';
-import {StandardMouseWheelEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardMouseWheelEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 import {HorizontalScrollbar} from 'vs/base/browser/ui/scrollbar/horizontalScrollbar';
 import {VerticalScrollbar} from 'vs/base/browser/ui/scrollbar/verticalScrollbar';
@@ -319,12 +319,12 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 		this._hide();
 	}
 
-	private _onMouseOut(e: StandardMouseEvent): void {
+	private _onMouseOut(e: IMouseEvent): void {
 		this._mouseIsOver = false;
 		this._hide();
 	}
 
-	private _onMouseOver(e: StandardMouseEvent): void {
+	private _onMouseOver(e: IMouseEvent): void {
 		this._mouseIsOver = true;
 		this._reveal();
 	}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/verticalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -58,7 +58,7 @@ export class VerticalScrollbar extends AbstractScrollbar {
 		StyleMutator.setTop(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posy - domNodePosition.top;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/widget.ts
code:
@@ -6,33 +6,33 @@
 'use strict';
 
 import {Disposable} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {StandardMouseEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardKeyboardEvent, IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import * as DomUtils from 'vs/base/browser/dom';
 
 export abstract class Widget extends Disposable {
 
-	protected onclick(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onclick(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.CLICK, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmousedown(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmousedown(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_DOWN, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmouseover(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmouseover(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_OVER, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableNonBubblingMouseOutListener(domNode, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onkeydown(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeydown(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_DOWN, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 
-	protected onkeyup(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeyup(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_UP, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/buildfile.js
code:
@@ -2,22 +2,15 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
-function createModuleDescription(name, exclude) {
-	var result= {};
-	var excludes = ['vs/css', 'vs/nls', 'vs/text'];
-	result.name= name;
-	if (Array.isArray(exclude) && exclude.length > 0) {
-		excludes = excludes.concat(exclude);
-	}
-	result.exclude= excludes;
-	return result;
-}
+'use strict';
 
-exports.collectModules= function() {
-	return [
-		createModuleDescription('vs/base/common/worker/workerServer'),
-		createModuleDescription('vs/base/common/worker/simpleWorker'),
-	];
-};
\ No newline at end of file
+exports.collectModules = function() {
+	return [{
+		name: 'vs/base/common/worker/workerServer',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}, {
+		name: 'vs/base/common/worker/simpleWorker',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}];
+};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/flags.ts
code:
@@ -6,7 +6,6 @@
 
 import { globals } from 'vs/base/common/platform';
 
-export const workersCount = environment('workersCount', 2);
 export const enableTasks = environment('enableTasks');
 export const enableSendASmile = environment('enableSendASmile');
 export const enableJavaScriptRewriting = environment('enableJavaScriptRewriting');
@@ -25,4 +24,8 @@ function environment(name:string, fallback:any = false):any {
 	}
 
 	return fallback;
-}
\ No newline at end of file
+}
+
+export function workersCount(defaultCount:number): number {
+	return environment('workersCount', defaultCount);
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/http.ts
code:
@@ -4,47 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import nls = require('vs/nls');
-
-// Methods
-export var GET = 'GET';
-export var POST = 'POST';
-export var PUT = 'PUT';
-export var DELETE = 'DELETE';
-
-// Header
-export namespace Header {
-	export var CONTENT_TYPE = 'Content-Type';
-	export var CONTENT_LENGTH = 'Content-Length';
-	export var LAST_MODIFIED = 'Last-Modified';
-	export var LOCATION = 'Location';
-	export var ETAG = 'ETag';
-	export var X_CONTENT_CHARSET = 'X-Content-Charset';
-	export var X_CONTENT_TYPES = 'X-Content-Types';
-	export var X_CONTENT_HASH = 'X-Content-Hash';
-	export var X_FILEPATH = 'X-Filepath';
-	export var X_RESOURCE = 'X-Resource';
-}
-
-// Mime
-export namespace Mime {
-	export var RAW = 'application/octet-stream';
-	export var JSON = 'application/json';
-	export var TEXT = 'text/plain';
-	export var HTML = 'text/html';
-}
-
-// Charset
-export namespace Charset {
-	export var UTF8 = 'utf-8';
-	export var UTF8_BOM = 'UTF8_BOM';
-}
-
-export interface IDataChunk {
-	header(name:string):string;
-	value():string;
-}
-
+import * as nls from 'vs/nls';
 
 export interface IXHROptions {
 	type?:string;
@@ -66,73 +26,6 @@ export interface IXHRResponse {
 	getResponseHeader: (header:string) => string;
 }
 
-export function isRedirect(status: number) : boolean {
-	return status >= 300 && status <= 303 || status === 307;
-}
-
-var contentLengthPattern = /X-Chunk-Length:(\d+)\r\n\r\n/gi,
-	headerPattern = /(.+?):(.+?)\r\n(\r\n)?/gm;
-
-function newDataChunk(responseText:string, headerStartOffset:number, headerEndOffset:number, contentLength:number):IDataChunk {
-
-	var _value:string,
-		_headers:{[name:string]:string};
-
-	return {
-		header: function(name:string):string {
-			if(typeof _headers === 'undefined') {
-				_headers = Object.create(null);
-				headerPattern.lastIndex = headerStartOffset;
-				while(true) {
-					var match = headerPattern.exec(responseText);
-					if(!match) {
-						// no header found
-						break;
-					}
-					_headers[match[1].toLowerCase()] = match[2];
-
-					if(match[3]) {
-						// the last header found
-						break;
-					}
-				}
-			}
-			return _headers[name.toLowerCase()];
-		},
-		value: function() {
-			if(typeof _value === 'undefined') {
-				_value = responseText.substr(headerEndOffset + 2 /*crlf*/, contentLength);
-			}
-			return _value;
-		}
-	};
-}
-
-/**
- * Parses the response text of the provided request into individual data chunks. The chunks
- * are filled into the provided array.
- */
-export function parseChunkedData(request:IXHRResponse, collection:IDataChunk[], offset:number = 0):number {
-
-	var responseText = request.responseText;
-
-	contentLengthPattern.lastIndex = offset;
-
-	while(true) {
-		var match = contentLengthPattern.exec(responseText);
-		if(!match) {
-			return offset;
-		}
-		var contentLength = parseInt(match[1], 10);
-		if(responseText.length < contentLengthPattern.lastIndex + contentLength) {
-			return offset;
-		}
-
-		collection.push(newDataChunk(responseText, offset, contentLengthPattern.lastIndex - 2, contentLength));
-		offset = contentLengthPattern.lastIndex + contentLength;
-	}
-}
-
 export function getErrorStatusDescription(status: number) : string {
 	if (status < 400) {
 		return void 0;
@@ -158,4 +51,4 @@ export function getErrorStatusDescription(status: number) : string {
 		case 503: return nls.localize('status.503', 'Service Unavailable. The server is currently unavailable (overloaded or down).');
 		default: return nls.localize('status.416', 'HTTP status code {0}', status);
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/network.ts
code:
@@ -4,426 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import assert = require('vs/base/common/assert');
-import objects = require('vs/base/common/objects');
-import strings = require('vs/base/common/strings');
-import hash = require('vs/base/common/hash');
-import paths = require('vs/base/common/paths');
-import URI from 'vs/base/common/uri';
-
-var _colon = ':'.charCodeAt(0),
-	_slash = '/'.charCodeAt(0),
-	_questionMark = '?'.charCodeAt(0),
-	_hash = '#'.charCodeAt(0);
-
-export class ParsedUrl {
-
-	private spec:string;
-	private specLength:number;
-	private schemeStart:number;
-	private domainStart:number;
-	private portStart:number;
-	private pathStart:number;
-	private queryStringStart:number;
-	private fragmentIdStart:number;
-
-	constructor(spec:string) {
-		this.spec = spec || strings.empty;
-		this.specLength = this.spec.length;
-
-
-
-		this.parse();
-	}
-
-	private forwardSubstring(startIndex:number, endIndex:number): string {
-		if (startIndex < endIndex) {
-			return this.spec.substring(startIndex, endIndex);
-		}
-		return strings.empty;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart - 1);
-	}
-
-	/**
-	 * http: for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getProtocol(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart);
-	}
-
-	/**
-	 * www.test.com for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getDomain(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.portStart);
-	}
-
-	/**
-	 * 8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPort(): string {
-		return this.forwardSubstring(this.portStart + 1, this.pathStart);
-	}
-
-	/**
-	 * www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getHost(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.pathStart);
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath(): string {
-		return this.forwardSubstring(this.pathStart, this.queryStringStart);
-	}
-
-	/**
-	 * query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getQueryString(): string {
-		return this.forwardSubstring(this.queryStringStart + 1, this.fragmentIdStart);
-	}
-
-	/**
-	 * hash for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getFragmentId(): string {
-		return this.forwardSubstring(this.fragmentIdStart + 1, this.specLength);
-	}
-
-	/**
-	 * http://www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforePath(): string {
-		return this.forwardSubstring(0, this.pathStart);
-	}
-	/**
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforeFragmentId(): string {
-		return this.forwardSubstring(0, this.fragmentIdStart);
-	}
-
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):string {
-		var questionMarkIndex = relativeUrl.indexOf('?');
-		var hashIndex = relativeUrl.indexOf('#');
-		var suffixIndex = relativeUrl.length;
-		if (questionMarkIndex !== -1 && questionMarkIndex < suffixIndex) {
-			suffixIndex = questionMarkIndex;
-		}
-		if (hashIndex !== -1 && hashIndex < suffixIndex) {
-			suffixIndex = hashIndex;
-		}
-
-		var relativeUrlPath = relativeUrl.substring(0, suffixIndex);
-		var relativeUrlSuffix = relativeUrl.substring(suffixIndex);
-
-
-		relativeUrlPath = relativeUrlPath.replace('\\', '/');
-
-		var resultPath: string;
-		if (strings.startsWith(relativeUrlPath, '/')) {
-			// Looks like an absolute URL
-			resultPath = paths.join(relativeUrlPath);
-		} else {
-			resultPath = paths.join(paths.dirname(this.getPath()), relativeUrlPath);
-		}
-
-		while (resultPath.charAt(0) === '/') {
-			resultPath = resultPath.substr(1);
-		}
-
-		while (resultPath.indexOf('../') === 0) {
-			resultPath = resultPath.substr(3);
-		}
-
-		return this.getAllBeforePath() + '/' + resultPath + relativeUrlSuffix;
-	}
-
-	// scheme://domain:port/path?query_string#fragment_id
-	private parse(): void {
-		var IN_SCHEME = 0,
-			IN_DOMAIN = 1,
-			IN_PORT = 2,
-			IN_PATH = 3,
-			IN_QUERY_STRING = 4,
-			state = IN_SCHEME,
-			spec = this.spec,
-			length = this.specLength,
-			i:number,
-			prevChCode:number = -1,
-			prevPrevChCode:number = -1,
-			chCode:number;
-
-		this.schemeStart = 0;
-		this.domainStart = this.specLength;
-		this.portStart = this.specLength;
-		this.pathStart = this.specLength;
-		this.queryStringStart = this.specLength;
-		this.fragmentIdStart = this.specLength;
-
-		for (i = 0; i < length; i++) {
-			chCode = spec.charCodeAt(i);
-
-			switch (state) {
-				case IN_SCHEME:
-					if (prevChCode === _slash && chCode === _slash) {
-						// going into the domain
-						state = IN_DOMAIN;
-						this.domainStart = i - 1;
-					}
-					break;
-
-				case IN_DOMAIN:
-					if (chCode === _colon) {
-						// going into the port
-						state = IN_PORT;
-						this.portStart = i;
-					} else if (chCode === _slash) {
-						// skipping the port, going straight to the path
-						state = IN_PATH;
-						this.portStart = i;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the port, path & query string, going straight to the fragment, we can halt now
-						this.portStart = i;
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PORT:
-					if (chCode === _slash) {
-						// going into the path
-						state = IN_PATH;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the path & query string, going straight to the fragment, we can halt now
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PATH:
-					if (chCode === _questionMark) {
-						// going in to the query string
-						state = IN_QUERY_STRING;
-						this.queryStringStart = i;
-					} else if (chCode === _hash) {
-						// skipping the query string, going straight to the fragment, we can halt now
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_QUERY_STRING:
-					if (chCode === _hash) {
-						// going into the hash, we can halt now
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-			}
-
-			prevPrevChCode = prevChCode;
-			prevChCode = chCode;
-		}
-
-		if (state === IN_SCHEME) {
-			// Looks like we had a very bad url
-			this.schemeStart = this.specLength;
-		}
-	}
-}
-
-
-export class URL extends URI implements objects.IEqualable {
-
-	/**
-	 * Creates a new URL from the provided value
-	 * by decoding it first.
-	 * @param value An encoded url value.
-	 */
-	public static fromEncoded(value:string):URL {
-		return new URL(decodeURIComponent(value));
-	}
-
-	public static fromValue(value:string):URL {
-		return new URL(value);
-	}
-
-	public static fromUri(value: URI): URL {
-		if (!value) {
-			return <any>value;
-		} else if (value instanceof URL) {
-			return value;
-		} else {
-			return new URL(value);
-		}
-	}
-
-	private _spec:string;
-	private _uri: URI;
-	private _parsed:ParsedUrl;
-
-	constructor(spec: string);
-	constructor(spec: URI);
-	constructor(stringOrURI: string|URI) {
-		super();
-		assert.ok(!!stringOrURI, 'spec must not be null');
-		if(typeof stringOrURI === 'string') {
-			this._uri = URI.parse(stringOrURI);
-		} else {
-			this._uri = stringOrURI;
-		}
-		this._spec = this._uri.toString(); // make sure spec is normalized
-		this._parsed = null;
-	}
-
-	public equals(other:any):boolean {
-		if (this.toString() !== String(other)) {
-			return false;
-		}
-
-		return (other instanceof URL || other instanceof URI);
-	}
-
-	public hashCode():number {
-		return hash.computeMurmur2StringHashCode(this._spec);
-	}
-
-	public isInMemory(): boolean {
-		return this.scheme === schemas.inMemory;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme():string {
-		this._ensureParsedUrl();
-		return this._parsed.getScheme();
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath():string {
-		this._ensureParsedUrl();
-		return this._parsed.getPath();
-	}
-
-	/**
-	 * Strips out the hash part of the URL.
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public toUnique():string {
-		this._ensureParsedUrl();
-		return this._parsed.getAllBeforeFragmentId();
-	}
-
-	public startsWith(other:URL):boolean {
-		return strings.startsWith(this._spec, other._spec);
-	}
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):URL {
-		this._ensureParsedUrl();
-		return new URL(this._parsed.combine(relativeUrl));
-	}
-
-	private _ensureParsedUrl(): void {
-		if(this._parsed === null) {
-			this._parsed = new ParsedUrl(this._spec);
-		}
-	}
-
-	// ----- URI implementation -------------------------
-
-	public get scheme(): string {
-		return this._uri.scheme;
-	}
-
-	public get authority(): string {
-		return this._uri.authority;
-	}
-
-	public get path(): string {
-		return this._uri.path;
-	}
-
-	public get fsPath(): string {
-		return this._uri.fsPath;
-	}
-
-	public get query(): string {
-		return this._uri.query;
-	}
-
-	public get fragment(): string {
-		return this._uri.fragment;
-	}
-
-	public withScheme(value: string): URI {
-		return URI.create(value, this.authority, this.fsPath, this.query, this.fragment);
-	}
-
-	public withAuthority(value: string): URI {
-		return URI.create(this.scheme, value, this.fsPath, this.query, this.fragment);
-	}
-
-	public withPath(value: string): URI {
-		return URI.create(this.scheme, this.authority, value, this.query, this.fragment);
-	}
-
-	public withQuery(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, value, this.fragment);
-	}
-
-	public withFragment(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, this.query, value);
-	}
-
-	public with(scheme: string, authority: string, path: string, query: string, fragment: string): URI {
-		return URI.create(scheme, authority, path, query, fragment);
-	}
-
-	public toString():string {
-		return this._spec;
-	}
-
-	public toJSON(): any {
-		return this.toString();
-	}
-}
-
-export namespace schemas {
+export namespace Schemas {
 
 	/**
 	 * A schema that is used for models that exist in memory
@@ -436,4 +17,4 @@ export namespace schemas {
 	export var https:string = 'https';
 
 	export var file:string = 'file';
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/strings.ts
code:
@@ -277,36 +277,6 @@ export function normalizeNFC(str: string, cache?: { [str: string]: string }): st
 	return res;
 }
 
-export function isCamelCasePattern(pattern: string): boolean {
-	return (/^\w[\w.]*$/).test(pattern);
-}
-
-export function isFalsyOrWhitespace(s: string): boolean {
-	return !s || !s.trim();
-}
-
-export function anchorPattern(value: string, start: boolean, end: boolean): string {
-	if (start) {
-		value = '^' + value;
-	}
-
-	if (end) {
-		value = value + '$';
-	}
-
-	return value;
-}
-
-export function assertRegExp(pattern: string, modifiers: string): void {
-	if (regExpLeadsToEndlessLoop(new RegExp(pattern, modifiers))) {
-		throw new Error('Regular expression /' + pattern + '/g results in infinitive matches');
-	}
-}
-
-export function colorize(code: number, value: string): string {
-	return '\x1b[' + code + 'm' + value + '\x1b[0m';
-}
-
 /**
  * Returns first index of the string that is not whitespace.
  * If string is empty or contains only whitespaces, returns -1

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/simpleWorker.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IWorker, IWorkerFactory} from './workerClient';
-import {TPromise, ValueCallback, ErrorCallback} from 'vs/base/common/winjs.base';
-import errors = require('vs/base/common/errors');
+import {transformErrorForSerialization} from 'vs/base/common/errors';
 import {Disposable} from 'vs/base/common/lifecycle';
+import {ErrorCallback, TPromise, ValueCallback} from 'vs/base/common/winjs.base';
+import {IWorker, IWorkerFactory} from './workerClient';
 
 const INITIALIZE = '$initialize';
 
@@ -139,7 +139,7 @@ class SimpleWorkerProtocol {
 				vsWorker: this._workerId,
 				seq: req,
 				res: undefined,
-				err: errors.transformErrorForSerialization(e)
+				err: transformErrorForSerialization(e)
 			});
 		});
 	}
@@ -195,7 +195,7 @@ export class SimpleWorkerClient<T> extends Disposable {
 			moduleId,
 			loaderConfiguration
 		]);
-		this._onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this._onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
 		// Create proxy to loaded code
 		let proxyMethodRequest = (method:string, args:any[]):TPromise<any> => {
@@ -224,8 +224,12 @@ export class SimpleWorkerClient<T> extends Disposable {
 	}
 
 	private _request(method:string, args:any[]): TPromise<any> {
-		return this._onModuleLoaded.then(() => {
-			return this._protocol.sendMessage(method, args);
+		return new TPromise<any>((c, e, p) => {
+			this._onModuleLoaded.then(() => {
+				this._protocol.sendMessage(method, args).then(c, e);
+			}, e);
+		}, () => {
+			// Cancel intentionally not supported
 		});
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerClient.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import * as timer from 'vs/base/common/timer';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 export interface IWorker {
 	getId():number;
@@ -39,17 +39,17 @@ export class WorkerClient {
 	private _promises:{[id:string]:IActiveRequest;};
 	private _worker:IWorker;
 
-	private _messagesQueue:protocol.IClientMessage[];
+	private _messagesQueue:workerProtocol.IClientMessage[];
 	private _processQueueTimeout:number;
 	private _waitingForWorkerReply:boolean;
 	private _lastTimerEvent:timer.ITimerEvent;
 
-	private _remoteCom: protocol.RemoteCom;
-	private _decodeMessageName: (msg: protocol.IClientMessage) => string;
+	private _remoteCom: workerProtocol.RemoteCom;
+	private _decodeMessageName: (msg: workerProtocol.IClientMessage) => string;
 
 	public onModuleLoaded:TPromise<void>;
 
-	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:protocol.IClientMessage)=>string) {
+	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:workerProtocol.IClientMessage)=>string) {
 		this._decodeMessageName = decodeMessageName;
 		this._lastMessageId = 0;
 		this._promises = {};
@@ -74,18 +74,18 @@ export class WorkerClient {
 
 		let MonacoEnvironment = (<any>window).MonacoEnvironment || null;
 
-		this.onModuleLoaded = this._sendMessage(protocol.MessageType.INITIALIZE, {
+		this.onModuleLoaded = this._sendMessage(workerProtocol.MessageType.INITIALIZE, {
 			id: this._worker.getId(),
 			moduleId: moduleId,
 			loaderConfiguration: loaderConfiguration,
 			MonacoEnvironment: MonacoEnvironment
 		});
-		this.onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this.onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
@@ -172,7 +172,7 @@ export class WorkerClient {
 		return promise;
 	}
 
-	private _enqueueMessage(msg:protocol.IClientMessage): void {
+	private _enqueueMessage(msg:workerProtocol.IClientMessage): void {
 
 		let lastIndexSmallerOrEqual = -1,
 			i:number;
@@ -232,13 +232,13 @@ export class WorkerClient {
 	}
 
 	private _postMessage(msg:any): void {
-		this._worker.postMessage(marshalling.stringify(msg));
+		this._worker.postMessage(stringify(msg));
 	}
 
 	private _onSerializedMessage(msg:string): void {
-		let message:protocol.IServerMessage = null;
+		let message:workerProtocol.IServerMessage = null;
 		try {
-			message = marshalling.parse(msg);
+			message = parse(msg);
 		} catch (e) {
 			// nothing
 		}
@@ -247,7 +247,7 @@ export class WorkerClient {
 		}
 	}
 
-	private _onmessage(msg:protocol.IServerMessage): void {
+	private _onmessage(msg:workerProtocol.IServerMessage): void {
 		if (!msg.monacoWorker) {
 			return;
 		}
@@ -256,8 +256,8 @@ export class WorkerClient {
 		}
 
 		switch (msg.type) {
-			case protocol.MessageType.REPLY:
-				let serverReplyMessage = <protocol.IServerReplyMessage>msg;
+			case workerProtocol.MessageType.REPLY:
+				let serverReplyMessage = <workerProtocol.IServerReplyMessage>msg;
 
 				this._waitingForWorkerReply = false;
 				if(this._lastTimerEvent) {
@@ -270,12 +270,12 @@ export class WorkerClient {
 				}
 
 				switch (serverReplyMessage.action) {
-					case protocol.ReplyType.COMPLETE:
+					case workerProtocol.ReplyType.COMPLETE:
 						this._promises[serverReplyMessage.id].complete(serverReplyMessage.payload);
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.ERROR:
+					case workerProtocol.ReplyType.ERROR:
 						this._onError('Main Thread sent to worker the following message:', {
 							type: this._promises[serverReplyMessage.id].type,
 							payload: this._promises[serverReplyMessage.id].payload
@@ -286,14 +286,14 @@ export class WorkerClient {
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.PROGRESS:
+					case workerProtocol.ReplyType.PROGRESS:
 						this._promises[serverReplyMessage.id].progress(serverReplyMessage.payload);
 						break;
 				}
 				break;
 
-			case protocol.MessageType.PRINT:
-				let serverPrintMessage = <protocol.IServerPrintMessage>msg;
+			case workerProtocol.MessageType.PRINT:
+				let serverPrintMessage = <workerProtocol.IServerPrintMessage>msg;
 				this._consoleLog(serverPrintMessage.level, serverPrintMessage.payload);
 				break;
 
@@ -304,11 +304,11 @@ export class WorkerClient {
 		this._processMessagesQueue();
 	}
 
-	private _dispatchRequestFromWorker(msg:protocol.IServerMessage): void {
+	private _dispatchRequestFromWorker(msg:workerProtocol.IServerMessage): void {
 		this._handleWorkerRequest(msg).then((result) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -317,9 +317,9 @@ export class WorkerClient {
 			};
 			this._postMessage(reply);
 		}, (err) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -330,7 +330,7 @@ export class WorkerClient {
 		});
 	}
 
-	private _handleWorkerRequest(msg:protocol.IServerMessage): TPromise<any> {
+	private _handleWorkerRequest(msg:workerProtocol.IServerMessage): TPromise<any> {
 		if (msg.type === '_proxyObj') {
 			return this._remoteCom.handleMessage(msg.payload);
 		}
@@ -353,19 +353,19 @@ export class WorkerClient {
 
 	_consoleLog(level:string, payload:any): void {
 		switch (level) {
-			case protocol.PrintType.LOG:
+			case workerProtocol.PrintType.LOG:
 				console.log(payload);
 				break;
-			case protocol.PrintType.DEBUG:
+			case workerProtocol.PrintType.DEBUG:
 				console.info(payload);
 				break;
-			case protocol.PrintType.INFO:
+			case workerProtocol.PrintType.INFO:
 				console.info(payload);
 				break;
-			case protocol.PrintType.WARN:
+			case workerProtocol.PrintType.WARN:
 				console.warn(payload);
 				break;
-			case protocol.PrintType.ERROR:
+			case workerProtocol.PrintType.ERROR:
 				console.error(payload);
 				break;
 			default:

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerProtocol.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {IManyHandler, IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import remote = require('vs/base/common/remote');
 
 /**
  * A message sent from the UI thread to a worker
@@ -75,10 +75,10 @@ export interface IRequester {
 	request(requestName: string, payload: any): TPromise<any>;
 }
 
-export class RemoteCom implements remote.IRemoteCom {
+export class RemoteCom implements IRemoteCom {
 
 	private _requester: IRequester;
-	private _bigHandler: remote.IManyHandler;
+	private _bigHandler: IManyHandler;
 
 	constructor(requester:IRequester) {
 		this._requester = requester;
@@ -93,7 +93,7 @@ export class RemoteCom implements remote.IRemoteCom {
 		});
 	}
 
-	public setManyHandler(handler:remote.IManyHandler): void {
+	public setManyHandler(handler:IManyHandler): void {
 		this._bigHandler = handler;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerServer.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {setUnexpectedErrorHandler, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import errors = require('vs/base/common/errors');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 interface IReplyCallbacks {
 	c: (value:any)=>void;
@@ -23,7 +23,7 @@ export class WorkerServer {
 	private _requestHandler:any;
 	private _lastReq: number;
 	private _awaitedReplies: { [req:string]: IReplyCallbacks; };
-	private _remoteCom: protocol.RemoteCom;
+	private _remoteCom: workerProtocol.RemoteCom;
 
 	constructor(postSerializedMessage:(msg:string)=>void) {
 		this._postSerializedMessage = postSerializedMessage;
@@ -33,48 +33,48 @@ export class WorkerServer {
 		this._awaitedReplies = {};
 		this._bindConsole();
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
 	private _bindConsole(): void {
 		(<any> self).console = {
-			log: this._sendPrintMessage.bind(this, protocol.PrintType.LOG),
-			debug: this._sendPrintMessage.bind(this, protocol.PrintType.DEBUG),
-			info: this._sendPrintMessage.bind(this, protocol.PrintType.INFO),
-			warn: this._sendPrintMessage.bind(this, protocol.PrintType.WARN),
-			error: this._sendPrintMessage.bind(this, protocol.PrintType.ERROR)
+			log: this._sendPrintMessage.bind(this, workerProtocol.PrintType.LOG),
+			debug: this._sendPrintMessage.bind(this, workerProtocol.PrintType.DEBUG),
+			info: this._sendPrintMessage.bind(this, workerProtocol.PrintType.INFO),
+			warn: this._sendPrintMessage.bind(this, workerProtocol.PrintType.WARN),
+			error: this._sendPrintMessage.bind(this, workerProtocol.PrintType.ERROR)
 		};
-		errors.setUnexpectedErrorHandler((e) => {
+		setUnexpectedErrorHandler((e) => {
 			self.console.error(e);
 		});
 	}
 
 	private _sendPrintMessage(level:string, ...objects:any[]): void {
-		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? errors.transformErrorForSerialization(obj) : obj);
-		var msg:protocol.IServerPrintMessage = {
+		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? transformErrorForSerialization(obj) : obj);
+		var msg:workerProtocol.IServerPrintMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
-			type: protocol.MessageType.PRINT,
+			type: workerProtocol.MessageType.PRINT,
 			level: level,
 			payload: (transformedObjects.length === 1 ? transformedObjects[0] : transformedObjects)
 		};
 		this._postMessage(msg);
 	}
 
 	private _sendReply(msgId:number, action:string, payload:any): void {
-		var msg:protocol.IServerReplyMessage = {
+		var msg:workerProtocol.IServerReplyMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
 			id: msgId,
-			type: protocol.MessageType.REPLY,
+			type: workerProtocol.MessageType.REPLY,
 			action: action,
-			payload: (payload instanceof Error) ? errors.transformErrorForSerialization(payload) : payload
+			payload: (payload instanceof Error) ? transformErrorForSerialization(payload) : payload
 		};
 		this._postMessage(msg);
 	}
@@ -86,7 +86,7 @@ export class WorkerServer {
 
 		var req = String(++this._lastReq);
 
-		var msg:protocol.IServerMessage = {
+		var msg:workerProtocol.IServerMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: req,
@@ -120,19 +120,19 @@ export class WorkerServer {
 	}
 
 	public onmessage(msg:string): void {
-		this._onmessage(marshalling.parse(msg));
+		this._onmessage(parse(msg));
 	}
 
-	private _postMessage(msg:protocol.IServerMessage): void {
-		this._postSerializedMessage(marshalling.stringify(msg));
+	private _postMessage(msg:workerProtocol.IServerMessage): void {
+		this._postSerializedMessage(stringify(msg));
 	}
 
-	private _onmessage(msg:protocol.IClientMessage): void {
+	private _onmessage(msg:workerProtocol.IClientMessage): void {
 
-		if (msg.type === protocol.MessageType.REPLY) {
+		if (msg.type === workerProtocol.MessageType.REPLY) {
 			// this message is a reply to a request we've made to the main thread previously
 
-			var typedMsg = <protocol.IClientReplyMessage>msg;
+			var typedMsg = <workerProtocol.IClientReplyMessage>msg;
 
 			if (!typedMsg.seq || !this._awaitedReplies.hasOwnProperty(typedMsg.seq)) {
 				console.error('Worker received unexpected reply from main thread', msg);
@@ -151,12 +151,12 @@ export class WorkerServer {
 			return;
 		}
 
-		var c = this._sendReply.bind(this, msg.id, protocol.ReplyType.COMPLETE);
-		var e = this._sendReply.bind(this, msg.id, protocol.ReplyType.ERROR);
-		var p = this._sendReply.bind(this, msg.id, protocol.ReplyType.PROGRESS);
+		var c = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.COMPLETE);
+		var e = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.ERROR);
+		var p = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.PROGRESS);
 
 		switch(msg.type) {
-			case protocol.MessageType.INITIALIZE:
+			case workerProtocol.MessageType.INITIALIZE:
 				this._workerId = msg.payload.id;
 
 				var loaderConfig = msg.payload.loaderConfiguration;
@@ -201,7 +201,7 @@ export class WorkerServer {
 		}
 	}
 
-	private _handleMessage(msg:protocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
+	private _handleMessage(msg:workerProtocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
 
 		if (msg.type === '_proxyObj') {
 			this._remoteCom.handleMessage(msg.payload).then(c, e, p);
@@ -218,7 +218,7 @@ export class WorkerServer {
 			try {
 				this._requestHandler[msg.type].call(this._requestHandler, this, c, e, p, msg.payload);
 			} catch (handlerError) {
-				e(errors.transformErrorForSerialization(handlerError));
+				e(transformErrorForSerialization(handlerError));
 			}
 			// var what = msg.type;
 			// console.info(what + ' took ' + ((new Date().getTime())-now));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/request.ts
code:
@@ -76,8 +76,8 @@ export function request(options: IRequestOptions): TPromise<IRequestResult> {
 	() => req && req.abort());
 }
 
-export function download(filePath: string, opts: IRequestOptions): Promise {
-	return request(assign(opts, { followRedirects: 3 })).then(pair => new Promise((c, e) => {
+export function download(filePath: string, opts: IRequestOptions): TPromise<void> {
+	return request(assign(opts, { followRedirects: 3 })).then(pair => new TPromise<void>((c, e) => {
 		let out = createWriteStream(filePath);
 
 		out.once('finish', () => c(null));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/tree.ts
code:
@@ -435,9 +435,9 @@ export /* abstract */ class ContextMenuEvent {
 
 export class MouseContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Mouse.StandardMouseEvent;
+	private originalEvent: Mouse.IMouseEvent;
 
-	constructor(originalEvent: Mouse.StandardMouseEvent) {
+	constructor(originalEvent: Mouse.IMouseEvent) {
 		super(originalEvent.posx, originalEvent.posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -453,9 +453,9 @@ export class MouseContextMenuEvent extends ContextMenuEvent {
 
 export class KeyboardContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Keyboard.StandardKeyboardEvent;
+	private originalEvent: Keyboard.IKeyboardEvent;
 
-	constructor(posx: number, posy: number, originalEvent: Keyboard.StandardKeyboardEvent) {
+	constructor(posx: number, posy: number, originalEvent: Keyboard.IKeyboardEvent) {
 		super(posx, posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -474,7 +474,7 @@ export interface IController {
 	/**
 	 * Called when an element is clicked.
 	 */
-	onClick(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onClick(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when an element is requested for a context menu.
@@ -489,22 +489,22 @@ export interface IController {
 	/**
 	 * Called when a key is pressed down while selecting elements.
 	 */
-	onKeyDown(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyDown(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a key is released while selecting elements.
 	 */
-	onKeyUp(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyUp(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a mouse button is pressed down on an element.
 	 */
-	onMouseDown?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseDown?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when a mouse button goes up on an element.
 	 */
-	onMouseUp?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseUp?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 }
 
 export enum DragOverEffect {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/treeDefaults.ts
code:
@@ -9,7 +9,7 @@ import touch = require('vs/base/browser/touch');
 import errors = require('vs/base/common/errors');
 import dom = require('vs/base/browser/dom');
 import mouse = require('vs/base/browser/mouseEvent');
-import keyboard = require('vs/base/browser/keyboardEvent');
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import _ = require('vs/base/parts/tree/browser/tree');
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
@@ -58,7 +58,7 @@ export class LegacyRenderer implements _.IRenderer {
 }
 
 export interface IKeyBindingCallback {
-	(tree:_.ITree, event:keyboard.StandardKeyboardEvent):void;
+	(tree:_.ITree, event:IKeyboardEvent):void;
 }
 
 export interface ICancelableEvent {
@@ -140,7 +140,7 @@ export class DefaultController implements _.IController {
 		this.upKeyBindingDispatcher.set(CommonKeybindings.CTRLCMD_ENTER, this.onEnter.bind(this));
 	}
 
-	public onMouseDown(tree:_.ITree, element: any, event:mouse.StandardMouseEvent, origin: string = 'mouse'):boolean {
+	public onMouseDown(tree:_.ITree, element: any, event:mouse.IMouseEvent, origin: string = 'mouse'):boolean {
 		if (this.options.clickBehavior === ClickBehavior.ON_MOUSE_DOWN && event.leftButton) {
 			if (event.target) {
 				if (event.target.tagName && event.target.tagName.toLowerCase() === 'input') {
@@ -159,7 +159,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	public onClick(tree:_.ITree, element: any, event:mouse.StandardMouseEvent):boolean {
+	public onClick(tree:_.ITree, element: any, event:mouse.IMouseEvent):boolean {
 		var isMac = platform.isMacintosh;
 
 		// A Ctrl click on the Mac is a context menu event
@@ -191,7 +191,7 @@ export class DefaultController implements _.IController {
 			tree.clearFocus(payload);
 			tree.clearSelection(payload);
 		} else {
-			var isMouseDown = eventish && (<mouse.StandardMouseEvent>eventish).browserEvent && (<mouse.StandardMouseEvent>eventish).browserEvent.type === 'mousedown';
+			var isMouseDown = eventish && (<mouse.IMouseEvent>eventish).browserEvent && (<mouse.IMouseEvent>eventish).browserEvent.type === 'mousedown';
 			if (!isMouseDown) {
 				eventish.preventDefault(); // we cannot preventDefault onMouseDown because this would break DND otherwise
 			}
@@ -235,15 +235,15 @@ export class DefaultController implements _.IController {
 		return this.onLeftClick(tree, element, event, 'touch');
 	}
 
-	public onKeyDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.downKeyBindingDispatcher, tree, event);
 	}
 
-	public onKeyUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.upKeyBindingDispatcher, tree, event);
 	}
 
-	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:IKeyboardEvent):boolean {
 		var handler = bindings.dispatch(event.asKeybinding());
 		if (handler) {
 			if (handler(tree, event)) {
@@ -255,7 +255,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	protected onUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -267,7 +267,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -279,7 +279,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -291,7 +291,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -303,7 +303,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onLeft(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onLeft(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -319,7 +319,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onRight(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onRight(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -331,7 +331,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEnter(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEnter(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -344,7 +344,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onSpace(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onSpace(tree:_.ITree, event:IKeyboardEvent):boolean {
 		if (tree.getHighlight()) {
 			return false;
 		}
@@ -355,7 +355,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEscape(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEscape(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/network.test.ts
code:
@@ -6,21 +6,8 @@
 
 import * as assert from 'assert';
 import URI from 'vs/base/common/uri';
-import { URL, ParsedUrl } from 'vs/base/common/network';
 
 function assertUrl(raw:string, scheme:string, domain:string, port:string, path:string, queryString:string, fragmentId:string): void {
-	var url = new ParsedUrl(raw);
-	assert.equal(url.getScheme(), scheme, 'getScheme ok for ' + raw);
-	var protocol = scheme ? scheme + ':' : scheme;
-	assert.equal(url.getProtocol(), protocol, 'getProtocol ok for ' + raw);
-	assert.equal(url.getDomain(), domain, 'getDomain ok for ' + raw);
-	assert.equal(url.getPort(), port, 'getPort ok for ' + raw);
-	var host = domain + (port ? ':' + port : '');
-	assert.equal(url.getHost(), host, 'getHost ok for ' + raw);
-	assert.equal(url.getPath(), path, 'getPath ok for ' + raw);
-	assert.equal(url.getQueryString(), queryString, 'getQueryString ok for ' + raw);
-	assert.equal(url.getFragmentId(), fragmentId, 'getFragmentId ok for ' + raw);
-
 	// check for equivalent behaviour
 	var uri = URI.parse(raw);
 	assert.equal(uri.scheme, scheme);
@@ -30,12 +17,6 @@ function assertUrl(raw:string, scheme:string, domain:string, port:string, path:s
 	assert.equal(uri.fragment, fragmentId);
 }
 
-function assertCombine(base:string, relativeUrl:string, expectedUrl:string): void {
-	var url = new ParsedUrl(base);
-	var result = url.combine(relativeUrl);
-	assert.equal(result, expectedUrl, 'combine ok for ' + base + ' and ' + relativeUrl);
-}
-
 suite('Network', () => {
 	test('urls', () => {
 		assertUrl('http://www.test.com:8000/this/that/theother.html?query=foo#hash',
@@ -107,114 +88,5 @@ suite('Network', () => {
 		);
 
 		assertUrl('file:///c/far/boo/file.cs', 'file', '', '', '/c/far/boo/file.cs', '', '');
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '/test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '////test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?token=123',
-			'http://www.test.com:8000/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?query=foo#hash',
-			'http://www.test.com:8000/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js#hash',
-			'http://www.test.com:8000/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '../test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?token=123',
-			'http://www.test.com:8000/this/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?query=foo#hash',
-			'http://www.test.com:8000/this/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js#hash',
-			'http://www.test.com:8000/this/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/', './test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/', './test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000', 'test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', '../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/a/b', 'a/b/../../../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/index.html', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-
-		var url = new URL('inmemory://model/1#css');
-		assert.equal(url.toUnique(), 'inmemory://model/1');
 	});
-
 });

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/strings.test.ts
code:
author:joaomoreno
date:2016-02-23T08:56:21Z
title:compile: gitActions
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -66,9 +66,9 @@ export abstract class GitAction extends Action {
 	protected toDispose: IDisposable[];
 
 	constructor(id: string, label: string, cssClass: string, gitService: IGitService) {
-		this.gitService = gitService;
 		super(id, label, cssClass, false);
 
+		this.gitService = gitService;
 		this.toDispose = [this.gitService.addBulkListener2(() => this.onGitServiceChange())];
 		this.onGitServiceChange();
 	}
@@ -101,8 +101,8 @@ export class OpenChangeAction extends GitAction {
 	protected editorService: IWorkbenchEditorService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IGitService gitService: IGitService) {
-		this.editorService = editorService;
 		super(OpenChangeAction.ID, nls.localize('openChange', "Open Change"), 'git-action open-change', gitService);
+		this.editorService = editorService;
 	}
 
 	protected isEnabled():boolean {
@@ -132,10 +132,10 @@ export class OpenFileAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IFileService fileService: IFileService, @IGitService gitService: IGitService, @IWorkspaceContextService contextService: IWorkspaceContextService) {
+		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 		this.fileService = fileService;
 		this.editorService = editorService;
 		this.contextService = contextService;
-		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -312,12 +312,12 @@ export abstract class BaseUndoAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(id: string, label: string, className: string, gitService: IGitService, eventService: IEventService, messageService: IMessageService, fileService:IFileService, editorService: IWorkbenchEditorService, contextService: IWorkspaceContextService) {
+		super(id, label, className, gitService);
 		this.eventService = eventService;
 		this.editorService = editorService;
 		this.messageService = messageService;
 		this.fileService = fileService;
 		this.contextService = contextService;
-		super(id, label, className, gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -595,13 +595,13 @@ export class CheckoutAction extends GitAction {
 	private runPromises: Promise[];
 
 	constructor(branch: IBranch, @IGitService gitService: IGitService, @IWorkbenchEditorService editorService: IWorkbenchEditorService) {
+		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
+
 		this.editorService = editorService;
 		this.branch = branch;
 		this.HEAD = null;
 		this.state = LifecycleState.Alive;
 		this.runPromises = [];
-
-		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
 	}
 
 	protected onGitServiceChange(): void {
@@ -766,8 +766,8 @@ export class SmartCommitAction extends BaseCommitAction {
 	private messageService: IMessageService;
 
 	constructor(commitState: ICommitState, @IGitService gitService: IGitService, @IMessageService messageService: IMessageService) {
-		this.messageService = messageService;
 		super(commitState, SmartCommitAction.ID, SmartCommitAction.ALL, 'git-action smart-commit', gitService);
+		this.messageService = messageService;
 	}
 
 	protected onGitServiceChange(): void {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.travis.yml
code:
@@ -21,8 +21,9 @@ before_install:
   - git submodule update --init --recursive
   - git clone https://github.com/creationix/nvm.git ./.nvm
   - source ./.nvm/nvm.sh
-  - nvm install 0.12
-  - nvm use 0.12
+  - nvm install node
+  - nvm use node
+  - npm install -g npm@2
   - npm config set python `which python`
   - npm install -g gulp
   - if [ $TRAVIS_OS_NAME == "linux" ]; then

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.vscode/launch.json
code:
@@ -45,8 +45,14 @@
 			"type": "chrome",
 			"request": "attach",
 			"port": 9222,
-			"sourceMaps": true,
-			"outDir": "${workspaceRoot}/out"
+			"sourceMaps": true
+		},
+		{
+			"name": "Launch VSCode",
+			"type": "chrome",
+			"request": "launch",
+			"runtimeExecutable": "${workspaceRoot}/scripts/code.bat",
+			"sourceMaps": true
 		},
 		{
 			"name": "Convert css-schema to browser.js",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/.eslintrc
code:
@@ -0,0 +1,6 @@
+{
+	"rules": {
+		"no-undef": 2,
+		"no-unused-vars": 1
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-/*global process,__dirname, Buffer*/
+/*global process,__dirname,Buffer,require*/
 
 var gulp = require('gulp');
 var fs = require('fs');
@@ -16,11 +16,8 @@ var rename = require('gulp-rename');
 var replace = require('gulp-replace');
 var filter = require('gulp-filter');
 var json = require('gulp-json-editor');
-var insert = require('gulp-insert');
 var remote = require('gulp-remote-src');
 var shell = require("gulp-shell");
-var File = require('vinyl');
-var rimraf = require('rimraf');
 var _ = require('underscore');
 var packageJson = require('../package.json');
 var util = require('./lib/util');
@@ -40,10 +37,6 @@ var baseModules = [
 
 // Build
 
-var builtInExtensions = {
-	'ms-vscode.omnisharp': '0.3.2',
-};
-
 var vscodeEntryPoints = _.flatten([
 	buildfile.entrypoint('vs/workbench/workbench.main'),
 	buildfile.base,
@@ -160,12 +153,8 @@ function packageTask(platform, arch, opts) {
 
 	return function () {
 		var out = opts.minified ? 'out-vscode-min' : 'out-vscode';
-		var pluginHostFilter = filter(out + '/vs/workbench/node/pluginHostProcess.js', { restore: true });
 
 		var src = gulp.src(out + '/**', { base: '.' })
-			.pipe(pluginHostFilter)
-			.pipe(insert.append('\n//# sourceMappingURL=pluginHostProcess.js.map'))
-			.pipe(pluginHostFilter.restore)
 			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }))
 			.pipe(util.setExecutableBit(['**/*.sh']));
 
@@ -184,13 +173,9 @@ function packageTask(platform, arch, opts) {
 			'!extensions/json/server/node_modules/mocha/**'
 		], { base: '.' });
 
-		var pluginHostSourceMap = gulp.src(out + '/vs/workbench/node/pluginHostProcess.js.map', { base: '.' })
-			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }));
-
-		var sources = es.merge(
-			es.merge(src, extensions).pipe(filter(['**', '!**/*.js.map'])),
-			pluginHostSourceMap
-		).pipe(util.handleAzureJson({ platform: platform }));
+		var sources = es.merge(src, extensions)
+			.pipe(filter(['**', '!**/*.js.map']))
+			.pipe(util.handleAzureJson({ platform: platform }));
 
 		var version = packageJson.version;
 		var quality = product.quality;
@@ -218,19 +203,13 @@ function packageTask(platform, arch, opts) {
 			.pipe(util.cleanNodeModule('native-keymap', ['binding.gyp', 'build/**', 'src/**', 'deps/**'], true))
 			.pipe(util.cleanNodeModule('weak', ['binding.gyp', 'build/**', 'src/**'], true));
 
-		var extraExtensions = util.downloadExtensions(builtInExtensions)
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join('extensions', p.dirname);
-			}));
-
 		var all = es.merge(
 			api,
 			packageJsonStream,
 			mixinProduct(),
 			license,
 			sources,
-			deps,
-			extraExtensions
+			deps
 		);
 
 		if (platform === 'win32') {
@@ -267,11 +246,15 @@ function getDebPackageArch(arch) {
 	return { x64: 'amd64', ia32: 'i386' }[arch];
 }
 
+function getEpochTime() {
+	return Math.floor(new Date().getTime() / 1000);
+}
+
 function prepareDebPackage(arch) {
 	var binaryDir = '../VSCode-linux-' + arch;
 	var debArch = getDebPackageArch(arch);
-	var destination = '.build/linux/vscode-' + debArch;
-	var packageRevision = '1';
+	var destination = '.build/linux/' + debArch + '/vscode-' + debArch;
+	var packageRevision = getEpochTime();
 
 	return function () {
 		var shortcut = gulp.src('resources/linux/bin/code.sh')
@@ -309,16 +292,25 @@ function prepareDebPackage(arch) {
 }
 
 function buildDebPackage(arch) {
-	return shell.task(['fakeroot dpkg-deb -b .build/linux/vscode-' + getDebPackageArch(arch)]);
+	var debArch = getDebPackageArch(arch);
+	return shell.task([
+		'fakeroot dpkg-deb -b vscode-' + debArch,
+		'dpkg-scanpackages . /dev/null > Packages'
+	], { cwd: '.build/linux/' + debArch});
+}
+
+function buildDebPackageCatalog(arch) {
+	var debArch = getDebPackageArch(arch);
+	return shell.task([], { cwd: '.build/linux/' + debArch});
 }
 
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
 gulp.task('clean-vscode-darwin', util.rimraf(path.join(path.dirname(root), 'VSCode-darwin')));
 gulp.task('clean-vscode-linux-ia32', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-ia32')));
 gulp.task('clean-vscode-linux-x64', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-x64')));
 gulp.task('clean-vscode-linux-arm', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-arm')));
-gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/vscode-i386*'));
-gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/vscode-amd64*'));
+gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/i386'));
+gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/amd64'));
 
 gulp.task('vscode-win32', ['optimize-vscode', 'clean-vscode-win32'], packageTask('win32'));
 gulp.task('vscode-darwin', ['optimize-vscode', 'clean-vscode-darwin'], packageTask('darwin'));
@@ -336,7 +328,8 @@ gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vsco
 gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb', 'vscode-linux-x64-min'], prepareDebPackage('x64'));
 gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
 gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
-gulp.task('vscode-linux-packages', ['vscode-linux-ia32-build-deb', 'vscode-linux-x64-build-deb']);
+gulp.task('vscode-linux-ia32-build-deb-catalog', ['vscode-linux-ia32-build-deb'], buildDebPackageCatalog('ia32'));
+gulp.task('vscode-linux-x64-build-deb-catalog', ['vscode-linux-x64-build-deb'], buildDebPackageCatalog('x64'));
 
 // Sourcemaps
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/lib/util.js
code:
@@ -1,11 +1,17 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+/*global require,exports,process,Buffer*/
+
 var es = require('event-stream');
 var debounce = require('debounce');
 var filter = require('gulp-filter');
 var azure = require('gulp-azure-storage');
 var rename = require('gulp-rename');
 var vzip = require('gulp-vinyl-zip');
 var util = require('gulp-util');
-var remote = require('gulp-remote-src');
 var _ = require('underscore');
 var path = require('path');
 var fs = require('fs');
@@ -252,32 +258,6 @@ exports.rimraf = function(dir) {
 	};
 };
 
-exports.downloadExtensions = function(extensions) {
-	var streams = Object.keys(extensions).map(function (fullName) {
-		var version = extensions[fullName];
-		var match = /^([^.]+)\.([^.]+)$/.exec(fullName);
-
-		if (!match) {
-			throw new Error('Bad extension: ' + fullName);
-		}
-
-		var publisher = match[1];
-		var name = match[2];
-		var url = 'https://' + publisher + '.gallery.vsassets.io/_apis/public/gallery/publisher/'
-			+ publisher + '/extension/' + name + '/' + version
-			+ '/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage';
-
-		return remote(url, { base: '' })
-			.pipe(vzip.src())
-			.pipe(filter('extension/**'))
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join(fullName, p.dirname.replace(/^extension[/\\]?/, ''));
-			}));
-	});
-
-	return es.merge(streams);
-};
-
 exports.getVersion = function (root) {
 	var version = process.env['BUILD_SOURCEVERSION'];
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/package.json
code:
@@ -0,0 +1,28 @@
+{
+	"name": "javascript-migration",
+	"displayName": "Helper extension for migrating to Salsa",
+	"description": "Informs users about the JS Salsa upgrade",
+	"version": "0.0.1",
+	"publisher": "vscode",
+	"engines": {
+		"vscode": "*"
+	},
+	"categories": [
+		"Other"
+	],
+	"activationEvents": [
+		"onLanguage:javascript",
+		"onLanguage:javascriptreact"
+	],
+	"main": "./out/extension",
+
+	"scripts": {
+		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:javascript-migration ./src/tsconfig.json"
+	},
+	"devDependencies": {
+		"typescript": "^1.7.5",
+		"vscode": "^0.11.0"
+	},
+    "dependencies": {
+    }
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/extension.ts
code:
@@ -0,0 +1,42 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as vscode from 'vscode';
+import * as cp from 'child_process';
+
+
+export function activate(context: vscode.ExtensionContext) {
+	const releaseNotesShown = 'javascript.releasenotesshown';
+
+	if (!context.globalState.get(releaseNotesShown)) {
+		// cheating with nls, this is a temporary extenion only, that doesn't need be localized
+		vscode.window.showInformationMessage('The JavaScript infrastructure has changed, please read the change notes.', 'Change Notes').then(selection => {
+			if (selection) {
+				open('http://go.microsoft.com/fwlink/?LinkId=733559');
+			}
+			context.globalState.update(releaseNotesShown, true);
+		});
+	}
+}
+
+function open(url: string) {
+	var cmd: string;
+
+	switch (process.platform) {
+		case 'darwin':
+			cmd = 'open';
+			break;
+		case 'win32':
+			cmd = 'start';
+			break;
+		default:
+			cmd = 'xdg-open';
+	}
+	return cp.exec(cmd + ' ' + url);
+}
+
+export function deactivate() {
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/tsconfig.json
code:
@@ -0,0 +1,12 @@
+{
+	"compilerOptions": {
+		"noLib": true,
+		"target": "es5",
+		"module": "commonjs",
+		"sourceMap": false,
+		"outDir": "../out"
+	},
+	"exclude": [
+		"node_modules"
+	]
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/json/src/jsonMain.ts
code:
@@ -75,7 +75,17 @@ export function activate(context: ExtensionContext) {
 	context.subscriptions.push(disposable);
 
 	languages.setLanguageConfiguration('json', {
-		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g
+		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g,
+		__characterPairSupport: {
+			autoClosingPairs: [
+				{ open: '{', close: '}' },
+				{ open: '[', close: ']' },
+				{ open: '(', close: ')' },
+				{ open: '"', close: '"', notIn: ['string'] },
+				{ open: '\'', close: '\'', notIn: ['string', 'comment'] },
+				{ open: '`', close: '`', notIn: ['string', 'comment'] }
+			]
+		}
 	});
 }
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node-debug/node-debug.azure.json
code:
@@ -1,6 +1,6 @@
 {
 	"account": "monacobuild",
 	"container": "debuggers",
-	"zip": "91c3d00/node-debug.zip",
+	"zip": "609a344/node-debug.zip",
 	"output": ""
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node.d.ts
code:
@@ -648,7 +648,7 @@ declare module "child_process" {
         maxBuffer?: number;
         killSignal?: string;
     }, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
-    export function exec(command: string, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
+    export function exec(command: string, callback?: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
     export function execFile(file: string, args: string[], options: {
         cwd?: string;
         stdio?: any;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/php/src/features/validationProvider.ts
code:
@@ -184,41 +184,49 @@ export default class PHPValidationProvider {
 			} else {
 				args = PHPValidationProvider.BufferArgs;
 			}
-			let childProcess = cp.spawn(executable, args, options);
-			childProcess.on('error', (error: Error) => {
-				if (this.executableNotFound) {
+			try {
+				let childProcess = cp.spawn(executable, args, options);
+				childProcess.on('error', (error: Error) => {
+					if (this.executableNotFound) {
+						resolve();
+						return;
+					}
+					this.showError(error, executable);
+					this.executableNotFound = true;
 					resolve();
-					return;
-				}
-				let message: string = null;
-				if ((<any>error).code === 'ENOENT') {
-					message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
-				} else {
-					message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
-				}
-				vscode.window.showInformationMessage(message);
-				this.executableNotFound = true;
-				resolve();
-			});
-			if (childProcess.pid) {
-				if (this.trigger === RunTrigger.onType) {
-					childProcess.stdin.write(textDocument.getText());
-					childProcess.stdin.end();
-				}
-				childProcess.stdout.on('data', (data: Buffer) => {
-					decoder.write(data).forEach(processLine);
 				});
-				childProcess.stdout.on('end', () => {
-					let line = decoder.end();
-					if (line) {
-						processLine(line);
+				if (childProcess.pid) {
+					if (this.trigger === RunTrigger.onType) {
+						childProcess.stdin.write(textDocument.getText());
+						childProcess.stdin.end();
 					}
-					this.diagnosticCollection.set(textDocument.uri, diagnostics);
+					childProcess.stdout.on('data', (data: Buffer) => {
+						decoder.write(data).forEach(processLine);
+					});
+					childProcess.stdout.on('end', () => {
+						let line = decoder.end();
+						if (line) {
+							processLine(line);
+						}
+						this.diagnosticCollection.set(textDocument.uri, diagnostics);
+						resolve();
+					});
+				} else {
 					resolve();
-				});
-			} else {
-				resolve();
+				}
+			} catch (error) {
+				this.showError(error, executable);
 			}
 		});
 	}
+
+	private showError(error: any, executable: string): void {
+		let message: string = null;
+		if (error.code === 'ENOENT') {
+			message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
+		} else {
+			message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
+		}
+		vscode.window.showInformationMessage(message);
+	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/swift/snippets/swift.json
code:
@@ -1,22 +1,22 @@
 {
-	"println(\"...\")": {
+	"print(\"...\")": {
 		"prefix": "pr",
-		"body": "println(\"$1\")$0"
+		"body": "print(\"$1\")$0"
 	},
-	"println(\"\\(...)\")": {
+	"print(\"\\(...)\")": {
 		"prefix": "po",
-		"body": "println(\"\\($1)\")$0"
+		"body": "print(\"\\($1)\")$0"
 	},
 
-	"do...while loop": {
+	"repeat...while loop": {
 
-		"prefix": "do",
+		"prefix": "repeat",
 		"body": [
-			"do {",
+			"repeat {",
 			"	$0",
 			"} while ${true}"
 		],
-		"description": "do...while loop"
+		"description": "repeat...while loop"
 	},
 
 	"While loop": {
@@ -96,6 +96,28 @@
 		"description": "Else statement"
 	},
 
+	"Guard statement": {
+
+		"prefix": "guard",
+		"body": [
+			"guard let ${a} = ${optional} else {",
+			"	$0",
+			"}"
+		],
+		"description": "Guard statement"
+	},
+
+	"Optional Binding statement": {
+
+		"prefix": "ifnil",
+		"body": [
+			"if let ${a} = ${optional} {",
+			"	$0",
+			"}"
+		],
+		"description": "Optional Binding statement"
+	},
+
 	"Switch statement": {
 
 		"prefix": "switch",
@@ -133,4 +155,4 @@
 		],
 		"description": "Enum"
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/tasks/src/tasksMain.ts
code:
@@ -72,6 +72,17 @@ function createCompletionItems(): CompletionItem[] {
 	].join('\n');
 	result.push(item);
 
+	item = new CompletionItem('dotnet build');
+	item.kind = CompletionItemKind.Snippet;
+	item.detail = 'Use dotnet build.';
+	item.filterText = 'ts-dotnet build';
+	item.insertText = [
+		'"version": "0.1.0",',
+		'"command": "dotnet build",',
+		'"showOutput": "always"'
+	].join('\n');
+	result.push(item);
+
 	item = new CompletionItem('msbuild');
 	item.kind = CompletionItemKind.Snippet;
 	item.detail = 'Use msbuild to compile your project.';

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/package.json
code:
@@ -6,9 +6,13 @@
 	"author": "Microsoft Corporation",
 	"license": "MIT",
 	"publisher": "vscode",
+	"aiKey":"AIF-d9b70cd4-b9f9-4d70-929b-a071c400b217",
 	"engines": {
 		"vscode": "*"
 	},
+	"dependencies": {
+    "vscode-extension-telemetry": "^0.0.4"
+	},
 	"scripts": {
 		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:typescript ./src/tsconfig.json"
 	},

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptMain.ts
code:
@@ -113,11 +113,6 @@ function registerSupports(modeID: string, host: TypeScriptServiceClientHost, cli
 		],
 
 		__electricCharacterSupport: {
-			brackets: [
-				{ tokenType: 'delimiter.curly.' + modeID, open: '{', close: '}', isElectric: true },
-				{ tokenType: 'delimiter.square.' + modeID, open: '[', close: ']', isElectric: true },
-				{ tokenType: 'delimiter.paren.' + modeID, open: '(', close: ')', isElectric: true }
-			],
 			docComment: { scope: 'comment.documentation', open: '/**', lineStart: ' * ', close: ' */' }
 		},
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptServiceClient.ts
code:
@@ -18,6 +18,8 @@ import { ITypescriptServiceClient, ITypescriptServiceClientHost }  from './types
 
 import * as VersionStatus from './utils/versionStatus';
 
+import TelemetryReporter from 'vscode-extension-telemetry';
+
 interface CallbackItem {
 	c: (value: any) => void;
 	e: (err: any) => void;
@@ -34,6 +36,12 @@ interface RequestItem {
 	callbacks: CallbackItem;
 }
 
+interface IPackageInfo {
+	name: string;
+	version: string;
+	aiKey: string;
+}
+
 export default class TypeScriptServiceClient implements ITypescriptServiceClient {
 
 	public static Trace: boolean = process.env.TSS_TRACE || false;
@@ -56,6 +64,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 	private pendingResponses: number;
 	private callbacks: CallbackMap;
 
+	private _packageInfo: IPackageInfo;
+	private telemetryReporter: TelemetryReporter;
+
 	constructor(host: ITypescriptServiceClientHost) {
 		this.host = host;
 		this.pathSeparator = path.sep;
@@ -83,6 +94,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				this.startService();
 			}
 		});
+		if (this.packageInfo && this.packageInfo.aiKey) {
+			this.telemetryReporter = new TelemetryReporter(this.packageInfo.name, this.packageInfo.version, this.packageInfo.aiKey);
+		}
 		this.startService();
 	}
 
@@ -94,6 +108,32 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 		return TypeScriptServiceClient.Trace;
 	}
 
+	private get packageInfo(): IPackageInfo {
+
+		if (this._packageInfo !== undefined) {
+			return this._packageInfo;
+		}
+		let packagePath = path.join(__dirname, './../package.json');
+		let extensionPackage = require(packagePath);
+		if (extensionPackage) {
+			this._packageInfo = {
+				name: extensionPackage.name,
+				version: extensionPackage.version,
+				aiKey: extensionPackage.aiKey
+			};
+		} else {
+			this._packageInfo = null;
+		}
+
+		return this._packageInfo;
+	}
+
+	private logTelemetry(eventName: string, properties?: {[prop: string]: string}) {
+		if (this.telemetryReporter) {
+			this.telemetryReporter.sendTelemetryEvent(eventName, properties);
+		}
+	}
+
 	private service(): Promise<cp.ChildProcess> {
 		if (this.servicePromise) {
 			return this.servicePromise;
@@ -141,6 +181,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 					if (err) {
 						this.lastError = err;
 						window.showErrorMessage(`TypeScript language server couldn\'t be started. Error message is: ${err.message}`);
+						this.logTelemetry('error', {message: err.message});
 						return;
 					}
 					this.lastStart = Date.now();
@@ -212,6 +253,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				} else if (diff < 2 * 1000 /* 2 seconds */) {
 					startService = false;
 					window.showErrorMessage('The Typesrript language service died 5 times right after it got started. The service will not be restarted. Please open a bug report.');
+					this.logTelemetry('serviceExited');
 				}
 			}
 			if (startService) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/node.additions.d.ts
code:
@@ -25,4 +25,13 @@ interface Console {
 declare var Console: {
     prototype: Console;
     new(): Console;
+};
+
+declare var require: {
+	toUrl(path: string): string;
+	(moduleName: string): any;
+	(dependencies: string[], callback: (...args: any[]) => any, errorback?: (err: any) => void): any;
+	config(data: any): any;
+	onError: Function;
+	__$__nodeRequire<T>(moduleName: string): T;
 };
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/vscode-extension-telemetry.d.ts
code:
@@ -0,0 +1,6 @@
+declare module 'vscode-extension-telemetry' {
+	export default class TelemetryReporter {
+		constructor(extensionId: string,extensionVersion: string, key: string);
+		sendTelemetryEvent(eventName: string, properties?: { [key: string]: string }, measures?: { [key: string]: number }): void;
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:package.json
code:
@@ -13,7 +13,7 @@
   "scripts": {
     "test": "node node_modules/mocha/bin/_mocha",
     "preinstall": "node build/npm/preinstall.js",
-    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/"
+    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/ && npm --prefix extensions/typescript/ install extensions/typescript/"
   },
   "dependencies": {
     "applicationinsights": "0.15.6",
@@ -24,11 +24,11 @@
     "http-proxy-agent": "^0.2.6",
     "https-proxy-agent": "^0.3.5",
     "iconv-lite": "^0.4.13",
+    "native-keymap": "^0.1.2",
     "sax": "^1.1.1",
     "semver": "^4.2.0",
     "vscode-debugprotocol": "^1.5.0",
     "vscode-textmate": "^1.0.11",
-    "native-keymap": "^0.1.2",
     "weak": "^1.0.1",
     "winreg": "0.0.12",
     "yauzl": "^2.3.1"
@@ -52,7 +52,6 @@
     "gulp-concat": "^2.6.0",
     "gulp-cssnano": "^2.1.0",
     "gulp-filter": "^3.0.0",
-    "gulp-insert": "^0.5.0",
     "gulp-json-editor": "^2.2.1",
     "gulp-mocha": "^2.1.3",
     "gulp-remote-src": "^0.4.0",
@@ -82,7 +81,7 @@
     "rimraf": "^2.2.8",
     "sinon": "^1.17.2",
     "source-map": "^0.4.4",
-    "tslint": "^3.2.2",
+    "tslint": "^3.3.0",
     "typescript": "^1.8.0",
     "uglify-js": "2.4.8",
     "underscore": "^1.8.2",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/dom.ts
code:
@@ -4,18 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as mouseEvent from 'vs/base/browser/mouseEvent';
-import * as keyboardEvent from 'vs/base/browser/keyboardEvent';
-import {isChrome, isWebKit} from 'vs/base/browser/browser';
-import types = require('vs/base/common/types');
+import {TimeoutTimer} from 'vs/base/common/async';
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
 import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
-import {onUnexpectedError} from 'vs/base/common/errors';
-import browserService = require('vs/base/browser/browserService');
-import {TimeoutTimer} from 'vs/base/common/async';
-
-export type IKeyboardEvent = keyboardEvent.IKeyboardEvent;
-export type IMouseEvent = mouseEvent.IMouseEvent;
+import {isObject} from 'vs/base/common/types';
+import {isChrome, isWebKit} from 'vs/base/browser/browser';
+import {getService} from 'vs/base/browser/browserService';
+import {IKeyboardEvent, StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export function clearNode(node: HTMLElement) {
 	while (node.firstChild) {
@@ -37,7 +34,7 @@ export function safeStringifyDOMAware(obj: any): string {
 			return '[Element]';
 		}
 
-		if (types.isObject(value) || Array.isArray(value)) {
+		if (isObject(value) || Array.isArray(value)) {
 			if (seen.indexOf(value) !== -1) {
 				return '[Circular]';
 			} else {
@@ -243,12 +240,12 @@ export interface IAddStandardDisposableListenerSignature {
 }
 function _wrapAsStandardMouseEvent(handler: (e: IMouseEvent) => void): (e: MouseEvent) => void {
 	return function(e: MouseEvent) {
-		return handler(new mouseEvent.StandardMouseEvent(e));
+		return handler(new StandardMouseEvent(e));
 	};
 }
 function _wrapAsStandardKeyboardEvent(handler: (e: IKeyboardEvent) => void): (e: KeyboardEvent) => void {
 	return function(e: KeyboardEvent) {
-		return handler(new keyboardEvent.StandardKeyboardEvent(e));
+		return handler(new StandardKeyboardEvent(e));
 	};
 }
 export let addStandardDisposableListener: IAddStandardDisposableListenerSignature = function addStandardDisposableListener(node: HTMLElement, type: string, handler: (event: any) => void, useCapture?: boolean): IDisposable {
@@ -779,7 +776,7 @@ export function removeCSSRulesWithPrefix(ruleName: string, style = sharedStyle):
 }
 
 export function isHTMLElement(o: any): o is HTMLElement {
-	return browserService.getService().isHTMLElement(o);
+	return getService().isHTMLElement(o);
 }
 
 export const EventType = {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/globalMouseMoveMonitor.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import * as dom from 'vs/base/browser/dom';
 import {IframeUtils} from 'vs/base/browser/iframe';
+import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export interface IStandardMouseMoveEventData {
 	leftButton:boolean;
@@ -92,32 +92,32 @@ export class GlobalMouseMoveMonitor<R> implements IDisposable {
 
 		let windowChain = IframeUtils.getSameOriginWindowChain();
 		for (let i = 0; i < windowChain.length; i++) {
-			this.hooks.push(DomUtils.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
+			this.hooks.push(dom.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
 				(data:R) => this.mouseMoveCallback(data),
 				(lastEvent:R, currentEvent:MouseEvent) => this.mouseMoveEventMerger(lastEvent, currentEvent)
 			));
-			this.hooks.push(DomUtils.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
+			this.hooks.push(dom.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
 		}
 
 		if (IframeUtils.hasDifferentOriginAncestor()) {
 			let lastSameOriginAncestor = windowChain[windowChain.length - 1];
 			// We might miss a mouse up if it happens outside the iframe
 			// This one is for Chrome
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for FF
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for IE
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
 				this.stopMonitoring(true);
 			}));
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/htmlContentRenderer.ts
code:
@@ -11,11 +11,12 @@ import {IHTMLContentElement} from 'vs/base/common/htmlContent';
 // import {WorkerClient} from 'vs/base/common/worker/workerClient';
 // import {DefaultWorkerFactory} from 'vs/base/worker/defaultWorkerFactory';
 import {marked} from 'vs/base/common/marked/marked';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export type RenderableContent = string | IHTMLContentElement | IHTMLContentElement[];
 
 export interface RenderOptions {
-	actionCallback?: (content: string, event?: DOM.IMouseEvent) => void;
+	actionCallback?: (content: string, event?: IMouseEvent) => void;
 	codeBlockRenderer?: (modeId: string, value: string) => string;
 }
 
@@ -228,7 +229,7 @@ interface IFormatParseTree {
 	children?: IFormatParseTree[];
 }
 
-function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: DOM.IMouseEvent) => void) {
+function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: IMouseEvent) => void) {
 	var child: Node;
 
 	if (treeNode.type === FormatType.Text) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/idleMonitor.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
-import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
+import {TimeoutTimer} from 'vs/base/common/async';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
+import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
 import {getService} from 'vs/base/browser/browserService';
-import {TimeoutTimer} from 'vs/base/common/async';
+import * as dom from 'vs/base/browser/dom';
 
 export enum UserStatus {
 	Idle,
@@ -34,8 +34,8 @@ export class IdleMonitor extends Disposable {
 		this._idleTime = idleTime;
 
 		this._eventEmitter = this._register(new EventEmitter());
-		this._register(DomUtils.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
-		this._register(DomUtils.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
 		this._onUserActive();
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/keyboardEvent.ts
code:
@@ -5,9 +5,9 @@
 
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
-import {KeyMod, KeyCode} from 'vs/base/common/keyCodes';
+import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 
 let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 (function() {
@@ -127,18 +127,18 @@ let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 
 	KEY_CODE_MAP[226] = KeyCode.OEM_102;
 
-	if (Browser.isIE11orEarlier) {
+	if (browser.isIE11orEarlier) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-	} else if (Browser.isFirefox) {
+	} else if (browser.isFirefox) {
 		KEY_CODE_MAP[59] = KeyCode.US_SEMICOLON;
 		KEY_CODE_MAP[107] = KeyCode.US_EQUAL;
 		KEY_CODE_MAP[109] = KeyCode.US_MINUS;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			KEY_CODE_MAP[224] = KeyCode.Meta;
 		}
-	} else if (Browser.isWebKit) {
+	} else if (browser.isWebKit) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			// the two meta keys in the Mac have different key codes (91 and 93)
 			KEY_CODE_MAP[93] = KeyCode.Meta;
 		} else {
@@ -187,10 +187,10 @@ export interface IKeyboardEvent {
 	stopPropagation(): void;
 }
 
-const ctrlKeyMod = (Platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
+const ctrlKeyMod = (platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
 const altKeyMod = KeyMod.Alt;
 const shiftKeyMod = KeyMod.Shift;
-const metaKeyMod = (Platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
+const metaKeyMod = (platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
 
 export class StandardKeyboardEvent implements IKeyboardEvent {
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/mouseEvent.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 import {IframeUtils} from 'vs/base/browser/iframe';
 
 export interface IMouseEvent {
@@ -21,6 +21,7 @@ export interface IMouseEvent {
 	shiftKey:boolean;
 	altKey:boolean;
 	metaKey:boolean;
+	timestamp:number;
 
 	preventDefault(): void;
 	stopPropagation(): void;
@@ -82,7 +83,7 @@ export class StandardMouseEvent implements IMouseEvent {
 		};
 
 		let test1 = readPageCoords, test2 = readClientCoords;
-		if (Browser.isIE10) {
+		if (browser.isIE10) {
 			// The if A elseif B logic here is inversed in IE10 due to an IE10 issue
 			test1 = readClientCoords;
 			test2 = readPageCoords;
@@ -183,7 +184,7 @@ export class StandardMouseWheelEvent {
 
 			// horizontal delta scroll
 			if (typeof e1.wheelDeltaX !== 'undefined') {
-				if (Browser.isSafari && Platform.isWindows) {
+				if (browser.isSafari && platform.isWindows) {
 					this.deltaX = - (e1.wheelDeltaX / 120);
 				} else {
 					this.deltaX = e1.wheelDeltaX / 120;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/checkbox/checkbox.ts
code:
@@ -10,14 +10,14 @@ import 'vs/css!./checkbox';
 import DOM = require('vs/base/browser/dom');
 import {KeyCode} from 'vs/base/common/keyCodes';
 import {Widget} from 'vs/base/browser/ui/widget';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 
 export interface ICheckboxOpts {
 	actionClassName: string;
 	title: string;
 	isChecked: boolean;
 	onChange: (viaKeyboard: boolean) => void;
-	onKeyDown?: (e: StandardKeyboardEvent) => void;
+	onKeyDown?: (e: IKeyboardEvent) => void;
 }
 
 export class Checkbox extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/findinput/findInput.ts
code:
@@ -13,8 +13,8 @@ import {Checkbox} from 'vs/base/browser/ui/checkbox/checkbox';
 import {IContextViewProvider} from 'vs/base/browser/ui/contextview/contextview';
 import {Widget} from 'vs/base/browser/ui/widget';
 import Event, {Emitter} from 'vs/base/common/event';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
 export interface IFindInputOptions {
@@ -59,17 +59,17 @@ export class FindInput extends Widget {
 	private _onDidOptionChange = this._register(new Emitter<boolean>());
 	public onDidOptionChange: Event<boolean /* via keyboard */> = this._onDidOptionChange.event;
 
-	private _onKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyDown: Event<StandardKeyboardEvent> = this._onKeyDown.event;
+	private _onKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyDown: Event<IKeyboardEvent> = this._onKeyDown.event;
 
 	private _onInput = this._register(new Emitter<void>());
 	public onInput: Event<void> = this._onInput.event;
 
-	private _onKeyUp = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyUp: Event<StandardKeyboardEvent> = this._onKeyUp.event;
+	private _onKeyUp = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyUp: Event<IKeyboardEvent> = this._onKeyUp.event;
 
-	private _onCaseSensitiveKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onCaseSensitiveKeyDown: Event<StandardKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
+	private _onCaseSensitiveKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onCaseSensitiveKeyDown: Event<IKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
 
 	constructor(parent:HTMLElement, contextViewProvider: IContextViewProvider, options?:IFindInputOptions) {
 		super();
@@ -257,7 +257,7 @@ export class FindInput extends Widget {
 
 		// Arrow-Key support to navigate between options
 		let indexes = [this.caseSensitive.domNode, this.wholeWords.domNode, this.regex.domNode];
-		this.onkeydown(this.domNode, (event: StandardKeyboardEvent) => {
+		this.onkeydown(this.domNode, (event: IKeyboardEvent) => {
 			if (event.equals(CommonKeybindings.LEFT_ARROW) || event.equals(CommonKeybindings.RIGHT_ARROW) || event.equals(CommonKeybindings.ESCAPE)) {
 				let index = indexes.indexOf(<HTMLElement>document.activeElement);
 				if (index >= 0) {
@@ -317,7 +317,7 @@ export class FindInput extends Widget {
 }
 
 interface IMatchCountOpts {
-	onClick: (e:StandardMouseEvent) => void;
+	onClick: (e:IMouseEvent) => void;
 }
 
 class MatchCount extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/abstractScrollbar.ts
code:
@@ -7,7 +7,7 @@
 import * as Browser from 'vs/base/browser/browser';
 import * as Platform from 'vs/base/common/platform';
 import * as DomUtils from 'vs/base/browser/dom';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 import {IMouseWheelEvent, IParent, Visibility, IScrollbar} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {Disposable} from 'vs/base/common/lifecycle';
 import {GlobalMouseMoveMonitor, IStandardMouseMoveEventData, standardMouseMoveMerger} from 'vs/base/browser/globalMouseMoveMonitor';
@@ -215,7 +215,7 @@ class ScrollbarArrow extends Widget {
 		this._mousedownScheduleRepeatTimer = this._register(new TimeoutTimer());
 	}
 
-	private _arrowMouseDown(e: StandardMouseEvent): void {
+	private _arrowMouseDown(e: IMouseEvent): void {
 		let repeater = () => {
 			this._parent.onMouseWheel(this._mouseWheelEventFactory());
 		};
@@ -446,7 +446,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	// ----------------- DOM events
 
-	private _domNodeMouseDown(e: StandardMouseEvent): void {
+	private _domNodeMouseDown(e: IMouseEvent): void {
 		if (e.target !== this.domNode) {
 			return;
 		}
@@ -468,14 +468,14 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 		}
 	}
 
-	private _onMouseDown(e: StandardMouseEvent): void {
+	private _onMouseDown(e: IMouseEvent): void {
 		let domNodePosition = DomUtils.getDomNodePosition(this.domNode);
 		let desiredSliderPosition = this._mouseDownRelativePosition(e, domNodePosition) - this._scrollbarState.getArrowSize() - this._scrollbarState.getSliderSize() / 2;
 		this.setDesiredScrollPosition(this._scrollbarState.convertSliderPositionToScrollPosition(desiredSliderPosition));
 		this._sliderMouseDown(e);
 	}
 
-	private _sliderMouseDown(e: StandardMouseEvent): void {
+	private _sliderMouseDown(e: IMouseEvent): void {
 		if (e.leftButton) {
 			let initialMouseOrthogonalPosition = this._sliderOrthogonalMousePosition(e);
 			let initialScrollPosition = this._getScrollPosition();
@@ -523,7 +523,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	protected abstract _renderDomNode(largeSize: number, smallSize: number): void;
 	protected abstract _updateSlider(sliderSize: number, sliderPosition: number): void;
-	protected abstract _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
+	protected abstract _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
 	protected abstract _sliderMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _sliderOrthogonalMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _getScrollPosition(): number;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -57,7 +57,7 @@ export class HorizontalScrollbar extends AbstractScrollbar {
 		StyleMutator.setBottom(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posx - domNodePosition.left;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/scrollableElementImpl.ts
code:
@@ -8,7 +8,7 @@ import 'vs/css!./media/scrollbars';
 
 import * as DomUtils from 'vs/base/browser/dom';
 import * as Platform from 'vs/base/common/platform';
-import {StandardMouseWheelEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardMouseWheelEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 import {HorizontalScrollbar} from 'vs/base/browser/ui/scrollbar/horizontalScrollbar';
 import {VerticalScrollbar} from 'vs/base/browser/ui/scrollbar/verticalScrollbar';
@@ -319,12 +319,12 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 		this._hide();
 	}
 
-	private _onMouseOut(e: StandardMouseEvent): void {
+	private _onMouseOut(e: IMouseEvent): void {
 		this._mouseIsOver = false;
 		this._hide();
 	}
 
-	private _onMouseOver(e: StandardMouseEvent): void {
+	private _onMouseOver(e: IMouseEvent): void {
 		this._mouseIsOver = true;
 		this._reveal();
 	}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/verticalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -58,7 +58,7 @@ export class VerticalScrollbar extends AbstractScrollbar {
 		StyleMutator.setTop(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posy - domNodePosition.top;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/widget.ts
code:
@@ -6,33 +6,33 @@
 'use strict';
 
 import {Disposable} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {StandardMouseEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardKeyboardEvent, IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import * as DomUtils from 'vs/base/browser/dom';
 
 export abstract class Widget extends Disposable {
 
-	protected onclick(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onclick(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.CLICK, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmousedown(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmousedown(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_DOWN, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmouseover(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmouseover(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_OVER, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableNonBubblingMouseOutListener(domNode, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onkeydown(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeydown(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_DOWN, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 
-	protected onkeyup(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeyup(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_UP, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/buildfile.js
code:
@@ -2,22 +2,15 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
-function createModuleDescription(name, exclude) {
-	var result= {};
-	var excludes = ['vs/css', 'vs/nls', 'vs/text'];
-	result.name= name;
-	if (Array.isArray(exclude) && exclude.length > 0) {
-		excludes = excludes.concat(exclude);
-	}
-	result.exclude= excludes;
-	return result;
-}
+'use strict';
 
-exports.collectModules= function() {
-	return [
-		createModuleDescription('vs/base/common/worker/workerServer'),
-		createModuleDescription('vs/base/common/worker/simpleWorker'),
-	];
-};
\ No newline at end of file
+exports.collectModules = function() {
+	return [{
+		name: 'vs/base/common/worker/workerServer',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}, {
+		name: 'vs/base/common/worker/simpleWorker',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}];
+};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/flags.ts
code:
@@ -6,7 +6,6 @@
 
 import { globals } from 'vs/base/common/platform';
 
-export const workersCount = environment('workersCount', 2);
 export const enableTasks = environment('enableTasks');
 export const enableSendASmile = environment('enableSendASmile');
 export const enableJavaScriptRewriting = environment('enableJavaScriptRewriting');
@@ -25,4 +24,8 @@ function environment(name:string, fallback:any = false):any {
 	}
 
 	return fallback;
-}
\ No newline at end of file
+}
+
+export function workersCount(defaultCount:number): number {
+	return environment('workersCount', defaultCount);
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/http.ts
code:
@@ -4,47 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import nls = require('vs/nls');
-
-// Methods
-export var GET = 'GET';
-export var POST = 'POST';
-export var PUT = 'PUT';
-export var DELETE = 'DELETE';
-
-// Header
-export namespace Header {
-	export var CONTENT_TYPE = 'Content-Type';
-	export var CONTENT_LENGTH = 'Content-Length';
-	export var LAST_MODIFIED = 'Last-Modified';
-	export var LOCATION = 'Location';
-	export var ETAG = 'ETag';
-	export var X_CONTENT_CHARSET = 'X-Content-Charset';
-	export var X_CONTENT_TYPES = 'X-Content-Types';
-	export var X_CONTENT_HASH = 'X-Content-Hash';
-	export var X_FILEPATH = 'X-Filepath';
-	export var X_RESOURCE = 'X-Resource';
-}
-
-// Mime
-export namespace Mime {
-	export var RAW = 'application/octet-stream';
-	export var JSON = 'application/json';
-	export var TEXT = 'text/plain';
-	export var HTML = 'text/html';
-}
-
-// Charset
-export namespace Charset {
-	export var UTF8 = 'utf-8';
-	export var UTF8_BOM = 'UTF8_BOM';
-}
-
-export interface IDataChunk {
-	header(name:string):string;
-	value():string;
-}
-
+import * as nls from 'vs/nls';
 
 export interface IXHROptions {
 	type?:string;
@@ -66,73 +26,6 @@ export interface IXHRResponse {
 	getResponseHeader: (header:string) => string;
 }
 
-export function isRedirect(status: number) : boolean {
-	return status >= 300 && status <= 303 || status === 307;
-}
-
-var contentLengthPattern = /X-Chunk-Length:(\d+)\r\n\r\n/gi,
-	headerPattern = /(.+?):(.+?)\r\n(\r\n)?/gm;
-
-function newDataChunk(responseText:string, headerStartOffset:number, headerEndOffset:number, contentLength:number):IDataChunk {
-
-	var _value:string,
-		_headers:{[name:string]:string};
-
-	return {
-		header: function(name:string):string {
-			if(typeof _headers === 'undefined') {
-				_headers = Object.create(null);
-				headerPattern.lastIndex = headerStartOffset;
-				while(true) {
-					var match = headerPattern.exec(responseText);
-					if(!match) {
-						// no header found
-						break;
-					}
-					_headers[match[1].toLowerCase()] = match[2];
-
-					if(match[3]) {
-						// the last header found
-						break;
-					}
-				}
-			}
-			return _headers[name.toLowerCase()];
-		},
-		value: function() {
-			if(typeof _value === 'undefined') {
-				_value = responseText.substr(headerEndOffset + 2 /*crlf*/, contentLength);
-			}
-			return _value;
-		}
-	};
-}
-
-/**
- * Parses the response text of the provided request into individual data chunks. The chunks
- * are filled into the provided array.
- */
-export function parseChunkedData(request:IXHRResponse, collection:IDataChunk[], offset:number = 0):number {
-
-	var responseText = request.responseText;
-
-	contentLengthPattern.lastIndex = offset;
-
-	while(true) {
-		var match = contentLengthPattern.exec(responseText);
-		if(!match) {
-			return offset;
-		}
-		var contentLength = parseInt(match[1], 10);
-		if(responseText.length < contentLengthPattern.lastIndex + contentLength) {
-			return offset;
-		}
-
-		collection.push(newDataChunk(responseText, offset, contentLengthPattern.lastIndex - 2, contentLength));
-		offset = contentLengthPattern.lastIndex + contentLength;
-	}
-}
-
 export function getErrorStatusDescription(status: number) : string {
 	if (status < 400) {
 		return void 0;
@@ -158,4 +51,4 @@ export function getErrorStatusDescription(status: number) : string {
 		case 503: return nls.localize('status.503', 'Service Unavailable. The server is currently unavailable (overloaded or down).');
 		default: return nls.localize('status.416', 'HTTP status code {0}', status);
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/network.ts
code:
@@ -4,426 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import assert = require('vs/base/common/assert');
-import objects = require('vs/base/common/objects');
-import strings = require('vs/base/common/strings');
-import hash = require('vs/base/common/hash');
-import paths = require('vs/base/common/paths');
-import URI from 'vs/base/common/uri';
-
-var _colon = ':'.charCodeAt(0),
-	_slash = '/'.charCodeAt(0),
-	_questionMark = '?'.charCodeAt(0),
-	_hash = '#'.charCodeAt(0);
-
-export class ParsedUrl {
-
-	private spec:string;
-	private specLength:number;
-	private schemeStart:number;
-	private domainStart:number;
-	private portStart:number;
-	private pathStart:number;
-	private queryStringStart:number;
-	private fragmentIdStart:number;
-
-	constructor(spec:string) {
-		this.spec = spec || strings.empty;
-		this.specLength = this.spec.length;
-
-
-
-		this.parse();
-	}
-
-	private forwardSubstring(startIndex:number, endIndex:number): string {
-		if (startIndex < endIndex) {
-			return this.spec.substring(startIndex, endIndex);
-		}
-		return strings.empty;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart - 1);
-	}
-
-	/**
-	 * http: for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getProtocol(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart);
-	}
-
-	/**
-	 * www.test.com for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getDomain(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.portStart);
-	}
-
-	/**
-	 * 8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPort(): string {
-		return this.forwardSubstring(this.portStart + 1, this.pathStart);
-	}
-
-	/**
-	 * www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getHost(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.pathStart);
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath(): string {
-		return this.forwardSubstring(this.pathStart, this.queryStringStart);
-	}
-
-	/**
-	 * query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getQueryString(): string {
-		return this.forwardSubstring(this.queryStringStart + 1, this.fragmentIdStart);
-	}
-
-	/**
-	 * hash for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getFragmentId(): string {
-		return this.forwardSubstring(this.fragmentIdStart + 1, this.specLength);
-	}
-
-	/**
-	 * http://www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforePath(): string {
-		return this.forwardSubstring(0, this.pathStart);
-	}
-	/**
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforeFragmentId(): string {
-		return this.forwardSubstring(0, this.fragmentIdStart);
-	}
-
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):string {
-		var questionMarkIndex = relativeUrl.indexOf('?');
-		var hashIndex = relativeUrl.indexOf('#');
-		var suffixIndex = relativeUrl.length;
-		if (questionMarkIndex !== -1 && questionMarkIndex < suffixIndex) {
-			suffixIndex = questionMarkIndex;
-		}
-		if (hashIndex !== -1 && hashIndex < suffixIndex) {
-			suffixIndex = hashIndex;
-		}
-
-		var relativeUrlPath = relativeUrl.substring(0, suffixIndex);
-		var relativeUrlSuffix = relativeUrl.substring(suffixIndex);
-
-
-		relativeUrlPath = relativeUrlPath.replace('\\', '/');
-
-		var resultPath: string;
-		if (strings.startsWith(relativeUrlPath, '/')) {
-			// Looks like an absolute URL
-			resultPath = paths.join(relativeUrlPath);
-		} else {
-			resultPath = paths.join(paths.dirname(this.getPath()), relativeUrlPath);
-		}
-
-		while (resultPath.charAt(0) === '/') {
-			resultPath = resultPath.substr(1);
-		}
-
-		while (resultPath.indexOf('../') === 0) {
-			resultPath = resultPath.substr(3);
-		}
-
-		return this.getAllBeforePath() + '/' + resultPath + relativeUrlSuffix;
-	}
-
-	// scheme://domain:port/path?query_string#fragment_id
-	private parse(): void {
-		var IN_SCHEME = 0,
-			IN_DOMAIN = 1,
-			IN_PORT = 2,
-			IN_PATH = 3,
-			IN_QUERY_STRING = 4,
-			state = IN_SCHEME,
-			spec = this.spec,
-			length = this.specLength,
-			i:number,
-			prevChCode:number = -1,
-			prevPrevChCode:number = -1,
-			chCode:number;
-
-		this.schemeStart = 0;
-		this.domainStart = this.specLength;
-		this.portStart = this.specLength;
-		this.pathStart = this.specLength;
-		this.queryStringStart = this.specLength;
-		this.fragmentIdStart = this.specLength;
-
-		for (i = 0; i < length; i++) {
-			chCode = spec.charCodeAt(i);
-
-			switch (state) {
-				case IN_SCHEME:
-					if (prevChCode === _slash && chCode === _slash) {
-						// going into the domain
-						state = IN_DOMAIN;
-						this.domainStart = i - 1;
-					}
-					break;
-
-				case IN_DOMAIN:
-					if (chCode === _colon) {
-						// going into the port
-						state = IN_PORT;
-						this.portStart = i;
-					} else if (chCode === _slash) {
-						// skipping the port, going straight to the path
-						state = IN_PATH;
-						this.portStart = i;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the port, path & query string, going straight to the fragment, we can halt now
-						this.portStart = i;
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PORT:
-					if (chCode === _slash) {
-						// going into the path
-						state = IN_PATH;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the path & query string, going straight to the fragment, we can halt now
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PATH:
-					if (chCode === _questionMark) {
-						// going in to the query string
-						state = IN_QUERY_STRING;
-						this.queryStringStart = i;
-					} else if (chCode === _hash) {
-						// skipping the query string, going straight to the fragment, we can halt now
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_QUERY_STRING:
-					if (chCode === _hash) {
-						// going into the hash, we can halt now
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-			}
-
-			prevPrevChCode = prevChCode;
-			prevChCode = chCode;
-		}
-
-		if (state === IN_SCHEME) {
-			// Looks like we had a very bad url
-			this.schemeStart = this.specLength;
-		}
-	}
-}
-
-
-export class URL extends URI implements objects.IEqualable {
-
-	/**
-	 * Creates a new URL from the provided value
-	 * by decoding it first.
-	 * @param value An encoded url value.
-	 */
-	public static fromEncoded(value:string):URL {
-		return new URL(decodeURIComponent(value));
-	}
-
-	public static fromValue(value:string):URL {
-		return new URL(value);
-	}
-
-	public static fromUri(value: URI): URL {
-		if (!value) {
-			return <any>value;
-		} else if (value instanceof URL) {
-			return value;
-		} else {
-			return new URL(value);
-		}
-	}
-
-	private _spec:string;
-	private _uri: URI;
-	private _parsed:ParsedUrl;
-
-	constructor(spec: string);
-	constructor(spec: URI);
-	constructor(stringOrURI: string|URI) {
-		super();
-		assert.ok(!!stringOrURI, 'spec must not be null');
-		if(typeof stringOrURI === 'string') {
-			this._uri = URI.parse(stringOrURI);
-		} else {
-			this._uri = stringOrURI;
-		}
-		this._spec = this._uri.toString(); // make sure spec is normalized
-		this._parsed = null;
-	}
-
-	public equals(other:any):boolean {
-		if (this.toString() !== String(other)) {
-			return false;
-		}
-
-		return (other instanceof URL || other instanceof URI);
-	}
-
-	public hashCode():number {
-		return hash.computeMurmur2StringHashCode(this._spec);
-	}
-
-	public isInMemory(): boolean {
-		return this.scheme === schemas.inMemory;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme():string {
-		this._ensureParsedUrl();
-		return this._parsed.getScheme();
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath():string {
-		this._ensureParsedUrl();
-		return this._parsed.getPath();
-	}
-
-	/**
-	 * Strips out the hash part of the URL.
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public toUnique():string {
-		this._ensureParsedUrl();
-		return this._parsed.getAllBeforeFragmentId();
-	}
-
-	public startsWith(other:URL):boolean {
-		return strings.startsWith(this._spec, other._spec);
-	}
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):URL {
-		this._ensureParsedUrl();
-		return new URL(this._parsed.combine(relativeUrl));
-	}
-
-	private _ensureParsedUrl(): void {
-		if(this._parsed === null) {
-			this._parsed = new ParsedUrl(this._spec);
-		}
-	}
-
-	// ----- URI implementation -------------------------
-
-	public get scheme(): string {
-		return this._uri.scheme;
-	}
-
-	public get authority(): string {
-		return this._uri.authority;
-	}
-
-	public get path(): string {
-		return this._uri.path;
-	}
-
-	public get fsPath(): string {
-		return this._uri.fsPath;
-	}
-
-	public get query(): string {
-		return this._uri.query;
-	}
-
-	public get fragment(): string {
-		return this._uri.fragment;
-	}
-
-	public withScheme(value: string): URI {
-		return URI.create(value, this.authority, this.fsPath, this.query, this.fragment);
-	}
-
-	public withAuthority(value: string): URI {
-		return URI.create(this.scheme, value, this.fsPath, this.query, this.fragment);
-	}
-
-	public withPath(value: string): URI {
-		return URI.create(this.scheme, this.authority, value, this.query, this.fragment);
-	}
-
-	public withQuery(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, value, this.fragment);
-	}
-
-	public withFragment(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, this.query, value);
-	}
-
-	public with(scheme: string, authority: string, path: string, query: string, fragment: string): URI {
-		return URI.create(scheme, authority, path, query, fragment);
-	}
-
-	public toString():string {
-		return this._spec;
-	}
-
-	public toJSON(): any {
-		return this.toString();
-	}
-}
-
-export namespace schemas {
+export namespace Schemas {
 
 	/**
 	 * A schema that is used for models that exist in memory
@@ -436,4 +17,4 @@ export namespace schemas {
 	export var https:string = 'https';
 
 	export var file:string = 'file';
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/strings.ts
code:
@@ -277,36 +277,6 @@ export function normalizeNFC(str: string, cache?: { [str: string]: string }): st
 	return res;
 }
 
-export function isCamelCasePattern(pattern: string): boolean {
-	return (/^\w[\w.]*$/).test(pattern);
-}
-
-export function isFalsyOrWhitespace(s: string): boolean {
-	return !s || !s.trim();
-}
-
-export function anchorPattern(value: string, start: boolean, end: boolean): string {
-	if (start) {
-		value = '^' + value;
-	}
-
-	if (end) {
-		value = value + '$';
-	}
-
-	return value;
-}
-
-export function assertRegExp(pattern: string, modifiers: string): void {
-	if (regExpLeadsToEndlessLoop(new RegExp(pattern, modifiers))) {
-		throw new Error('Regular expression /' + pattern + '/g results in infinitive matches');
-	}
-}
-
-export function colorize(code: number, value: string): string {
-	return '\x1b[' + code + 'm' + value + '\x1b[0m';
-}
-
 /**
  * Returns first index of the string that is not whitespace.
  * If string is empty or contains only whitespaces, returns -1

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/simpleWorker.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IWorker, IWorkerFactory} from './workerClient';
-import {TPromise, ValueCallback, ErrorCallback} from 'vs/base/common/winjs.base';
-import errors = require('vs/base/common/errors');
+import {transformErrorForSerialization} from 'vs/base/common/errors';
 import {Disposable} from 'vs/base/common/lifecycle';
+import {ErrorCallback, TPromise, ValueCallback} from 'vs/base/common/winjs.base';
+import {IWorker, IWorkerFactory} from './workerClient';
 
 const INITIALIZE = '$initialize';
 
@@ -139,7 +139,7 @@ class SimpleWorkerProtocol {
 				vsWorker: this._workerId,
 				seq: req,
 				res: undefined,
-				err: errors.transformErrorForSerialization(e)
+				err: transformErrorForSerialization(e)
 			});
 		});
 	}
@@ -195,7 +195,7 @@ export class SimpleWorkerClient<T> extends Disposable {
 			moduleId,
 			loaderConfiguration
 		]);
-		this._onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this._onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
 		// Create proxy to loaded code
 		let proxyMethodRequest = (method:string, args:any[]):TPromise<any> => {
@@ -224,8 +224,12 @@ export class SimpleWorkerClient<T> extends Disposable {
 	}
 
 	private _request(method:string, args:any[]): TPromise<any> {
-		return this._onModuleLoaded.then(() => {
-			return this._protocol.sendMessage(method, args);
+		return new TPromise<any>((c, e, p) => {
+			this._onModuleLoaded.then(() => {
+				this._protocol.sendMessage(method, args).then(c, e);
+			}, e);
+		}, () => {
+			// Cancel intentionally not supported
 		});
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerClient.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import * as timer from 'vs/base/common/timer';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 export interface IWorker {
 	getId():number;
@@ -39,17 +39,17 @@ export class WorkerClient {
 	private _promises:{[id:string]:IActiveRequest;};
 	private _worker:IWorker;
 
-	private _messagesQueue:protocol.IClientMessage[];
+	private _messagesQueue:workerProtocol.IClientMessage[];
 	private _processQueueTimeout:number;
 	private _waitingForWorkerReply:boolean;
 	private _lastTimerEvent:timer.ITimerEvent;
 
-	private _remoteCom: protocol.RemoteCom;
-	private _decodeMessageName: (msg: protocol.IClientMessage) => string;
+	private _remoteCom: workerProtocol.RemoteCom;
+	private _decodeMessageName: (msg: workerProtocol.IClientMessage) => string;
 
 	public onModuleLoaded:TPromise<void>;
 
-	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:protocol.IClientMessage)=>string) {
+	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:workerProtocol.IClientMessage)=>string) {
 		this._decodeMessageName = decodeMessageName;
 		this._lastMessageId = 0;
 		this._promises = {};
@@ -74,18 +74,18 @@ export class WorkerClient {
 
 		let MonacoEnvironment = (<any>window).MonacoEnvironment || null;
 
-		this.onModuleLoaded = this._sendMessage(protocol.MessageType.INITIALIZE, {
+		this.onModuleLoaded = this._sendMessage(workerProtocol.MessageType.INITIALIZE, {
 			id: this._worker.getId(),
 			moduleId: moduleId,
 			loaderConfiguration: loaderConfiguration,
 			MonacoEnvironment: MonacoEnvironment
 		});
-		this.onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this.onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
@@ -172,7 +172,7 @@ export class WorkerClient {
 		return promise;
 	}
 
-	private _enqueueMessage(msg:protocol.IClientMessage): void {
+	private _enqueueMessage(msg:workerProtocol.IClientMessage): void {
 
 		let lastIndexSmallerOrEqual = -1,
 			i:number;
@@ -232,13 +232,13 @@ export class WorkerClient {
 	}
 
 	private _postMessage(msg:any): void {
-		this._worker.postMessage(marshalling.stringify(msg));
+		this._worker.postMessage(stringify(msg));
 	}
 
 	private _onSerializedMessage(msg:string): void {
-		let message:protocol.IServerMessage = null;
+		let message:workerProtocol.IServerMessage = null;
 		try {
-			message = marshalling.parse(msg);
+			message = parse(msg);
 		} catch (e) {
 			// nothing
 		}
@@ -247,7 +247,7 @@ export class WorkerClient {
 		}
 	}
 
-	private _onmessage(msg:protocol.IServerMessage): void {
+	private _onmessage(msg:workerProtocol.IServerMessage): void {
 		if (!msg.monacoWorker) {
 			return;
 		}
@@ -256,8 +256,8 @@ export class WorkerClient {
 		}
 
 		switch (msg.type) {
-			case protocol.MessageType.REPLY:
-				let serverReplyMessage = <protocol.IServerReplyMessage>msg;
+			case workerProtocol.MessageType.REPLY:
+				let serverReplyMessage = <workerProtocol.IServerReplyMessage>msg;
 
 				this._waitingForWorkerReply = false;
 				if(this._lastTimerEvent) {
@@ -270,12 +270,12 @@ export class WorkerClient {
 				}
 
 				switch (serverReplyMessage.action) {
-					case protocol.ReplyType.COMPLETE:
+					case workerProtocol.ReplyType.COMPLETE:
 						this._promises[serverReplyMessage.id].complete(serverReplyMessage.payload);
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.ERROR:
+					case workerProtocol.ReplyType.ERROR:
 						this._onError('Main Thread sent to worker the following message:', {
 							type: this._promises[serverReplyMessage.id].type,
 							payload: this._promises[serverReplyMessage.id].payload
@@ -286,14 +286,14 @@ export class WorkerClient {
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.PROGRESS:
+					case workerProtocol.ReplyType.PROGRESS:
 						this._promises[serverReplyMessage.id].progress(serverReplyMessage.payload);
 						break;
 				}
 				break;
 
-			case protocol.MessageType.PRINT:
-				let serverPrintMessage = <protocol.IServerPrintMessage>msg;
+			case workerProtocol.MessageType.PRINT:
+				let serverPrintMessage = <workerProtocol.IServerPrintMessage>msg;
 				this._consoleLog(serverPrintMessage.level, serverPrintMessage.payload);
 				break;
 
@@ -304,11 +304,11 @@ export class WorkerClient {
 		this._processMessagesQueue();
 	}
 
-	private _dispatchRequestFromWorker(msg:protocol.IServerMessage): void {
+	private _dispatchRequestFromWorker(msg:workerProtocol.IServerMessage): void {
 		this._handleWorkerRequest(msg).then((result) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -317,9 +317,9 @@ export class WorkerClient {
 			};
 			this._postMessage(reply);
 		}, (err) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -330,7 +330,7 @@ export class WorkerClient {
 		});
 	}
 
-	private _handleWorkerRequest(msg:protocol.IServerMessage): TPromise<any> {
+	private _handleWorkerRequest(msg:workerProtocol.IServerMessage): TPromise<any> {
 		if (msg.type === '_proxyObj') {
 			return this._remoteCom.handleMessage(msg.payload);
 		}
@@ -353,19 +353,19 @@ export class WorkerClient {
 
 	_consoleLog(level:string, payload:any): void {
 		switch (level) {
-			case protocol.PrintType.LOG:
+			case workerProtocol.PrintType.LOG:
 				console.log(payload);
 				break;
-			case protocol.PrintType.DEBUG:
+			case workerProtocol.PrintType.DEBUG:
 				console.info(payload);
 				break;
-			case protocol.PrintType.INFO:
+			case workerProtocol.PrintType.INFO:
 				console.info(payload);
 				break;
-			case protocol.PrintType.WARN:
+			case workerProtocol.PrintType.WARN:
 				console.warn(payload);
 				break;
-			case protocol.PrintType.ERROR:
+			case workerProtocol.PrintType.ERROR:
 				console.error(payload);
 				break;
 			default:

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerProtocol.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {IManyHandler, IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import remote = require('vs/base/common/remote');
 
 /**
  * A message sent from the UI thread to a worker
@@ -75,10 +75,10 @@ export interface IRequester {
 	request(requestName: string, payload: any): TPromise<any>;
 }
 
-export class RemoteCom implements remote.IRemoteCom {
+export class RemoteCom implements IRemoteCom {
 
 	private _requester: IRequester;
-	private _bigHandler: remote.IManyHandler;
+	private _bigHandler: IManyHandler;
 
 	constructor(requester:IRequester) {
 		this._requester = requester;
@@ -93,7 +93,7 @@ export class RemoteCom implements remote.IRemoteCom {
 		});
 	}
 
-	public setManyHandler(handler:remote.IManyHandler): void {
+	public setManyHandler(handler:IManyHandler): void {
 		this._bigHandler = handler;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerServer.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {setUnexpectedErrorHandler, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import errors = require('vs/base/common/errors');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 interface IReplyCallbacks {
 	c: (value:any)=>void;
@@ -23,7 +23,7 @@ export class WorkerServer {
 	private _requestHandler:any;
 	private _lastReq: number;
 	private _awaitedReplies: { [req:string]: IReplyCallbacks; };
-	private _remoteCom: protocol.RemoteCom;
+	private _remoteCom: workerProtocol.RemoteCom;
 
 	constructor(postSerializedMessage:(msg:string)=>void) {
 		this._postSerializedMessage = postSerializedMessage;
@@ -33,48 +33,48 @@ export class WorkerServer {
 		this._awaitedReplies = {};
 		this._bindConsole();
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
 	private _bindConsole(): void {
 		(<any> self).console = {
-			log: this._sendPrintMessage.bind(this, protocol.PrintType.LOG),
-			debug: this._sendPrintMessage.bind(this, protocol.PrintType.DEBUG),
-			info: this._sendPrintMessage.bind(this, protocol.PrintType.INFO),
-			warn: this._sendPrintMessage.bind(this, protocol.PrintType.WARN),
-			error: this._sendPrintMessage.bind(this, protocol.PrintType.ERROR)
+			log: this._sendPrintMessage.bind(this, workerProtocol.PrintType.LOG),
+			debug: this._sendPrintMessage.bind(this, workerProtocol.PrintType.DEBUG),
+			info: this._sendPrintMessage.bind(this, workerProtocol.PrintType.INFO),
+			warn: this._sendPrintMessage.bind(this, workerProtocol.PrintType.WARN),
+			error: this._sendPrintMessage.bind(this, workerProtocol.PrintType.ERROR)
 		};
-		errors.setUnexpectedErrorHandler((e) => {
+		setUnexpectedErrorHandler((e) => {
 			self.console.error(e);
 		});
 	}
 
 	private _sendPrintMessage(level:string, ...objects:any[]): void {
-		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? errors.transformErrorForSerialization(obj) : obj);
-		var msg:protocol.IServerPrintMessage = {
+		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? transformErrorForSerialization(obj) : obj);
+		var msg:workerProtocol.IServerPrintMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
-			type: protocol.MessageType.PRINT,
+			type: workerProtocol.MessageType.PRINT,
 			level: level,
 			payload: (transformedObjects.length === 1 ? transformedObjects[0] : transformedObjects)
 		};
 		this._postMessage(msg);
 	}
 
 	private _sendReply(msgId:number, action:string, payload:any): void {
-		var msg:protocol.IServerReplyMessage = {
+		var msg:workerProtocol.IServerReplyMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
 			id: msgId,
-			type: protocol.MessageType.REPLY,
+			type: workerProtocol.MessageType.REPLY,
 			action: action,
-			payload: (payload instanceof Error) ? errors.transformErrorForSerialization(payload) : payload
+			payload: (payload instanceof Error) ? transformErrorForSerialization(payload) : payload
 		};
 		this._postMessage(msg);
 	}
@@ -86,7 +86,7 @@ export class WorkerServer {
 
 		var req = String(++this._lastReq);
 
-		var msg:protocol.IServerMessage = {
+		var msg:workerProtocol.IServerMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: req,
@@ -120,19 +120,19 @@ export class WorkerServer {
 	}
 
 	public onmessage(msg:string): void {
-		this._onmessage(marshalling.parse(msg));
+		this._onmessage(parse(msg));
 	}
 
-	private _postMessage(msg:protocol.IServerMessage): void {
-		this._postSerializedMessage(marshalling.stringify(msg));
+	private _postMessage(msg:workerProtocol.IServerMessage): void {
+		this._postSerializedMessage(stringify(msg));
 	}
 
-	private _onmessage(msg:protocol.IClientMessage): void {
+	private _onmessage(msg:workerProtocol.IClientMessage): void {
 
-		if (msg.type === protocol.MessageType.REPLY) {
+		if (msg.type === workerProtocol.MessageType.REPLY) {
 			// this message is a reply to a request we've made to the main thread previously
 
-			var typedMsg = <protocol.IClientReplyMessage>msg;
+			var typedMsg = <workerProtocol.IClientReplyMessage>msg;
 
 			if (!typedMsg.seq || !this._awaitedReplies.hasOwnProperty(typedMsg.seq)) {
 				console.error('Worker received unexpected reply from main thread', msg);
@@ -151,12 +151,12 @@ export class WorkerServer {
 			return;
 		}
 
-		var c = this._sendReply.bind(this, msg.id, protocol.ReplyType.COMPLETE);
-		var e = this._sendReply.bind(this, msg.id, protocol.ReplyType.ERROR);
-		var p = this._sendReply.bind(this, msg.id, protocol.ReplyType.PROGRESS);
+		var c = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.COMPLETE);
+		var e = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.ERROR);
+		var p = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.PROGRESS);
 
 		switch(msg.type) {
-			case protocol.MessageType.INITIALIZE:
+			case workerProtocol.MessageType.INITIALIZE:
 				this._workerId = msg.payload.id;
 
 				var loaderConfig = msg.payload.loaderConfiguration;
@@ -201,7 +201,7 @@ export class WorkerServer {
 		}
 	}
 
-	private _handleMessage(msg:protocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
+	private _handleMessage(msg:workerProtocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
 
 		if (msg.type === '_proxyObj') {
 			this._remoteCom.handleMessage(msg.payload).then(c, e, p);
@@ -218,7 +218,7 @@ export class WorkerServer {
 			try {
 				this._requestHandler[msg.type].call(this._requestHandler, this, c, e, p, msg.payload);
 			} catch (handlerError) {
-				e(errors.transformErrorForSerialization(handlerError));
+				e(transformErrorForSerialization(handlerError));
 			}
 			// var what = msg.type;
 			// console.info(what + ' took ' + ((new Date().getTime())-now));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/request.ts
code:
@@ -76,8 +76,8 @@ export function request(options: IRequestOptions): TPromise<IRequestResult> {
 	() => req && req.abort());
 }
 
-export function download(filePath: string, opts: IRequestOptions): Promise {
-	return request(assign(opts, { followRedirects: 3 })).then(pair => new Promise((c, e) => {
+export function download(filePath: string, opts: IRequestOptions): TPromise<void> {
+	return request(assign(opts, { followRedirects: 3 })).then(pair => new TPromise<void>((c, e) => {
 		let out = createWriteStream(filePath);
 
 		out.once('finish', () => c(null));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/tree.ts
code:
@@ -435,9 +435,9 @@ export /* abstract */ class ContextMenuEvent {
 
 export class MouseContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Mouse.StandardMouseEvent;
+	private originalEvent: Mouse.IMouseEvent;
 
-	constructor(originalEvent: Mouse.StandardMouseEvent) {
+	constructor(originalEvent: Mouse.IMouseEvent) {
 		super(originalEvent.posx, originalEvent.posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -453,9 +453,9 @@ export class MouseContextMenuEvent extends ContextMenuEvent {
 
 export class KeyboardContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Keyboard.StandardKeyboardEvent;
+	private originalEvent: Keyboard.IKeyboardEvent;
 
-	constructor(posx: number, posy: number, originalEvent: Keyboard.StandardKeyboardEvent) {
+	constructor(posx: number, posy: number, originalEvent: Keyboard.IKeyboardEvent) {
 		super(posx, posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -474,7 +474,7 @@ export interface IController {
 	/**
 	 * Called when an element is clicked.
 	 */
-	onClick(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onClick(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when an element is requested for a context menu.
@@ -489,22 +489,22 @@ export interface IController {
 	/**
 	 * Called when a key is pressed down while selecting elements.
 	 */
-	onKeyDown(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyDown(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a key is released while selecting elements.
 	 */
-	onKeyUp(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyUp(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a mouse button is pressed down on an element.
 	 */
-	onMouseDown?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseDown?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when a mouse button goes up on an element.
 	 */
-	onMouseUp?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseUp?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 }
 
 export enum DragOverEffect {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/treeDefaults.ts
code:
@@ -9,7 +9,7 @@ import touch = require('vs/base/browser/touch');
 import errors = require('vs/base/common/errors');
 import dom = require('vs/base/browser/dom');
 import mouse = require('vs/base/browser/mouseEvent');
-import keyboard = require('vs/base/browser/keyboardEvent');
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import _ = require('vs/base/parts/tree/browser/tree');
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
@@ -58,7 +58,7 @@ export class LegacyRenderer implements _.IRenderer {
 }
 
 export interface IKeyBindingCallback {
-	(tree:_.ITree, event:keyboard.StandardKeyboardEvent):void;
+	(tree:_.ITree, event:IKeyboardEvent):void;
 }
 
 export interface ICancelableEvent {
@@ -140,7 +140,7 @@ export class DefaultController implements _.IController {
 		this.upKeyBindingDispatcher.set(CommonKeybindings.CTRLCMD_ENTER, this.onEnter.bind(this));
 	}
 
-	public onMouseDown(tree:_.ITree, element: any, event:mouse.StandardMouseEvent, origin: string = 'mouse'):boolean {
+	public onMouseDown(tree:_.ITree, element: any, event:mouse.IMouseEvent, origin: string = 'mouse'):boolean {
 		if (this.options.clickBehavior === ClickBehavior.ON_MOUSE_DOWN && event.leftButton) {
 			if (event.target) {
 				if (event.target.tagName && event.target.tagName.toLowerCase() === 'input') {
@@ -159,7 +159,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	public onClick(tree:_.ITree, element: any, event:mouse.StandardMouseEvent):boolean {
+	public onClick(tree:_.ITree, element: any, event:mouse.IMouseEvent):boolean {
 		var isMac = platform.isMacintosh;
 
 		// A Ctrl click on the Mac is a context menu event
@@ -191,7 +191,7 @@ export class DefaultController implements _.IController {
 			tree.clearFocus(payload);
 			tree.clearSelection(payload);
 		} else {
-			var isMouseDown = eventish && (<mouse.StandardMouseEvent>eventish).browserEvent && (<mouse.StandardMouseEvent>eventish).browserEvent.type === 'mousedown';
+			var isMouseDown = eventish && (<mouse.IMouseEvent>eventish).browserEvent && (<mouse.IMouseEvent>eventish).browserEvent.type === 'mousedown';
 			if (!isMouseDown) {
 				eventish.preventDefault(); // we cannot preventDefault onMouseDown because this would break DND otherwise
 			}
@@ -235,15 +235,15 @@ export class DefaultController implements _.IController {
 		return this.onLeftClick(tree, element, event, 'touch');
 	}
 
-	public onKeyDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.downKeyBindingDispatcher, tree, event);
 	}
 
-	public onKeyUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.upKeyBindingDispatcher, tree, event);
 	}
 
-	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:IKeyboardEvent):boolean {
 		var handler = bindings.dispatch(event.asKeybinding());
 		if (handler) {
 			if (handler(tree, event)) {
@@ -255,7 +255,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	protected onUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -267,7 +267,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -279,7 +279,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -291,7 +291,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -303,7 +303,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onLeft(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onLeft(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -319,7 +319,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onRight(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onRight(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -331,7 +331,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEnter(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEnter(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -344,7 +344,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onSpace(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onSpace(tree:_.ITree, event:IKeyboardEvent):boolean {
 		if (tree.getHighlight()) {
 			return false;
 		}
@@ -355,7 +355,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEscape(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEscape(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/network.test.ts
code:
@@ -6,21 +6,8 @@
 
 import * as assert from 'assert';
 import URI from 'vs/base/common/uri';
-import { URL, ParsedUrl } from 'vs/base/common/network';
 
 function assertUrl(raw:string, scheme:string, domain:string, port:string, path:string, queryString:string, fragmentId:string): void {
-	var url = new ParsedUrl(raw);
-	assert.equal(url.getScheme(), scheme, 'getScheme ok for ' + raw);
-	var protocol = scheme ? scheme + ':' : scheme;
-	assert.equal(url.getProtocol(), protocol, 'getProtocol ok for ' + raw);
-	assert.equal(url.getDomain(), domain, 'getDomain ok for ' + raw);
-	assert.equal(url.getPort(), port, 'getPort ok for ' + raw);
-	var host = domain + (port ? ':' + port : '');
-	assert.equal(url.getHost(), host, 'getHost ok for ' + raw);
-	assert.equal(url.getPath(), path, 'getPath ok for ' + raw);
-	assert.equal(url.getQueryString(), queryString, 'getQueryString ok for ' + raw);
-	assert.equal(url.getFragmentId(), fragmentId, 'getFragmentId ok for ' + raw);
-
 	// check for equivalent behaviour
 	var uri = URI.parse(raw);
 	assert.equal(uri.scheme, scheme);
@@ -30,12 +17,6 @@ function assertUrl(raw:string, scheme:string, domain:string, port:string, path:s
 	assert.equal(uri.fragment, fragmentId);
 }
 
-function assertCombine(base:string, relativeUrl:string, expectedUrl:string): void {
-	var url = new ParsedUrl(base);
-	var result = url.combine(relativeUrl);
-	assert.equal(result, expectedUrl, 'combine ok for ' + base + ' and ' + relativeUrl);
-}
-
 suite('Network', () => {
 	test('urls', () => {
 		assertUrl('http://www.test.com:8000/this/that/theother.html?query=foo#hash',
@@ -107,114 +88,5 @@ suite('Network', () => {
 		);
 
 		assertUrl('file:///c/far/boo/file.cs', 'file', '', '', '/c/far/boo/file.cs', '', '');
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '/test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '////test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?token=123',
-			'http://www.test.com:8000/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?query=foo#hash',
-			'http://www.test.com:8000/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js#hash',
-			'http://www.test.com:8000/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '../test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?token=123',
-			'http://www.test.com:8000/this/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?query=foo#hash',
-			'http://www.test.com:8000/this/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js#hash',
-			'http://www.test.com:8000/this/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/', './test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/', './test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000', 'test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', '../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/a/b', 'a/b/../../../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/index.html', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-
-		var url = new URL('inmemory://model/1#css');
-		assert.equal(url.toUnique(), 'inmemory://model/1');
 	});
-
 });

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/strings.test.ts
code:
author:joaomoreno
date:2016-02-23T08:56:21Z
title:compile: gitActions
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -66,9 +66,9 @@ export abstract class GitAction extends Action {
 	protected toDispose: IDisposable[];
 
 	constructor(id: string, label: string, cssClass: string, gitService: IGitService) {
-		this.gitService = gitService;
 		super(id, label, cssClass, false);
 
+		this.gitService = gitService;
 		this.toDispose = [this.gitService.addBulkListener2(() => this.onGitServiceChange())];
 		this.onGitServiceChange();
 	}
@@ -101,8 +101,8 @@ export class OpenChangeAction extends GitAction {
 	protected editorService: IWorkbenchEditorService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IGitService gitService: IGitService) {
-		this.editorService = editorService;
 		super(OpenChangeAction.ID, nls.localize('openChange', "Open Change"), 'git-action open-change', gitService);
+		this.editorService = editorService;
 	}
 
 	protected isEnabled():boolean {
@@ -132,10 +132,10 @@ export class OpenFileAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(@IWorkbenchEditorService editorService: IWorkbenchEditorService, @IFileService fileService: IFileService, @IGitService gitService: IGitService, @IWorkspaceContextService contextService: IWorkspaceContextService) {
+		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 		this.fileService = fileService;
 		this.editorService = editorService;
 		this.contextService = contextService;
-		super(OpenFileAction.ID, nls.localize('openFile', "Open File"), 'git-action open-file', gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -312,12 +312,12 @@ export abstract class BaseUndoAction extends GitAction {
 	private contextService: IWorkspaceContextService;
 
 	constructor(id: string, label: string, className: string, gitService: IGitService, eventService: IEventService, messageService: IMessageService, fileService:IFileService, editorService: IWorkbenchEditorService, contextService: IWorkspaceContextService) {
+		super(id, label, className, gitService);
 		this.eventService = eventService;
 		this.editorService = editorService;
 		this.messageService = messageService;
 		this.fileService = fileService;
 		this.contextService = contextService;
-		super(id, label, className, gitService);
 	}
 
 	protected isEnabled():boolean {
@@ -595,13 +595,13 @@ export class CheckoutAction extends GitAction {
 	private runPromises: Promise[];
 
 	constructor(branch: IBranch, @IGitService gitService: IGitService, @IWorkbenchEditorService editorService: IWorkbenchEditorService) {
+		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
+
 		this.editorService = editorService;
 		this.branch = branch;
 		this.HEAD = null;
 		this.state = LifecycleState.Alive;
 		this.runPromises = [];
-
-		super(CheckoutAction.ID, branch.name, 'git-action checkout', gitService);
 	}
 
 	protected onGitServiceChange(): void {
@@ -766,8 +766,8 @@ export class SmartCommitAction extends BaseCommitAction {
 	private messageService: IMessageService;
 
 	constructor(commitState: ICommitState, @IGitService gitService: IGitService, @IMessageService messageService: IMessageService) {
-		this.messageService = messageService;
 		super(commitState, SmartCommitAction.ID, SmartCommitAction.ALL, 'git-action smart-commit', gitService);
+		this.messageService = messageService;
 	}
 
 	protected onGitServiceChange(): void {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.travis.yml
code:
@@ -21,8 +21,9 @@ before_install:
   - git submodule update --init --recursive
   - git clone https://github.com/creationix/nvm.git ./.nvm
   - source ./.nvm/nvm.sh
-  - nvm install 0.12
-  - nvm use 0.12
+  - nvm install node
+  - nvm use node
+  - npm install -g npm@2
   - npm config set python `which python`
   - npm install -g gulp
   - if [ $TRAVIS_OS_NAME == "linux" ]; then

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:.vscode/launch.json
code:
@@ -45,8 +45,14 @@
 			"type": "chrome",
 			"request": "attach",
 			"port": 9222,
-			"sourceMaps": true,
-			"outDir": "${workspaceRoot}/out"
+			"sourceMaps": true
+		},
+		{
+			"name": "Launch VSCode",
+			"type": "chrome",
+			"request": "launch",
+			"runtimeExecutable": "${workspaceRoot}/scripts/code.bat",
+			"sourceMaps": true
 		},
 		{
 			"name": "Convert css-schema to browser.js",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/.eslintrc
code:
@@ -0,0 +1,6 @@
+{
+	"rules": {
+		"no-undef": 2,
+		"no-unused-vars": 1
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-/*global process,__dirname, Buffer*/
+/*global process,__dirname,Buffer,require*/
 
 var gulp = require('gulp');
 var fs = require('fs');
@@ -16,11 +16,8 @@ var rename = require('gulp-rename');
 var replace = require('gulp-replace');
 var filter = require('gulp-filter');
 var json = require('gulp-json-editor');
-var insert = require('gulp-insert');
 var remote = require('gulp-remote-src');
 var shell = require("gulp-shell");
-var File = require('vinyl');
-var rimraf = require('rimraf');
 var _ = require('underscore');
 var packageJson = require('../package.json');
 var util = require('./lib/util');
@@ -40,10 +37,6 @@ var baseModules = [
 
 // Build
 
-var builtInExtensions = {
-	'ms-vscode.omnisharp': '0.3.2',
-};
-
 var vscodeEntryPoints = _.flatten([
 	buildfile.entrypoint('vs/workbench/workbench.main'),
 	buildfile.base,
@@ -160,12 +153,8 @@ function packageTask(platform, arch, opts) {
 
 	return function () {
 		var out = opts.minified ? 'out-vscode-min' : 'out-vscode';
-		var pluginHostFilter = filter(out + '/vs/workbench/node/pluginHostProcess.js', { restore: true });
 
 		var src = gulp.src(out + '/**', { base: '.' })
-			.pipe(pluginHostFilter)
-			.pipe(insert.append('\n//# sourceMappingURL=pluginHostProcess.js.map'))
-			.pipe(pluginHostFilter.restore)
 			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }))
 			.pipe(util.setExecutableBit(['**/*.sh']));
 
@@ -184,13 +173,9 @@ function packageTask(platform, arch, opts) {
 			'!extensions/json/server/node_modules/mocha/**'
 		], { base: '.' });
 
-		var pluginHostSourceMap = gulp.src(out + '/vs/workbench/node/pluginHostProcess.js.map', { base: '.' })
-			.pipe(rename(function (path) { path.dirname = path.dirname.replace(new RegExp('^' + out), 'out'); }));
-
-		var sources = es.merge(
-			es.merge(src, extensions).pipe(filter(['**', '!**/*.js.map'])),
-			pluginHostSourceMap
-		).pipe(util.handleAzureJson({ platform: platform }));
+		var sources = es.merge(src, extensions)
+			.pipe(filter(['**', '!**/*.js.map']))
+			.pipe(util.handleAzureJson({ platform: platform }));
 
 		var version = packageJson.version;
 		var quality = product.quality;
@@ -218,19 +203,13 @@ function packageTask(platform, arch, opts) {
 			.pipe(util.cleanNodeModule('native-keymap', ['binding.gyp', 'build/**', 'src/**', 'deps/**'], true))
 			.pipe(util.cleanNodeModule('weak', ['binding.gyp', 'build/**', 'src/**'], true));
 
-		var extraExtensions = util.downloadExtensions(builtInExtensions)
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join('extensions', p.dirname);
-			}));
-
 		var all = es.merge(
 			api,
 			packageJsonStream,
 			mixinProduct(),
 			license,
 			sources,
-			deps,
-			extraExtensions
+			deps
 		);
 
 		if (platform === 'win32') {
@@ -267,11 +246,15 @@ function getDebPackageArch(arch) {
 	return { x64: 'amd64', ia32: 'i386' }[arch];
 }
 
+function getEpochTime() {
+	return Math.floor(new Date().getTime() / 1000);
+}
+
 function prepareDebPackage(arch) {
 	var binaryDir = '../VSCode-linux-' + arch;
 	var debArch = getDebPackageArch(arch);
-	var destination = '.build/linux/vscode-' + debArch;
-	var packageRevision = '1';
+	var destination = '.build/linux/' + debArch + '/vscode-' + debArch;
+	var packageRevision = getEpochTime();
 
 	return function () {
 		var shortcut = gulp.src('resources/linux/bin/code.sh')
@@ -309,16 +292,25 @@ function prepareDebPackage(arch) {
 }
 
 function buildDebPackage(arch) {
-	return shell.task(['fakeroot dpkg-deb -b .build/linux/vscode-' + getDebPackageArch(arch)]);
+	var debArch = getDebPackageArch(arch);
+	return shell.task([
+		'fakeroot dpkg-deb -b vscode-' + debArch,
+		'dpkg-scanpackages . /dev/null > Packages'
+	], { cwd: '.build/linux/' + debArch});
+}
+
+function buildDebPackageCatalog(arch) {
+	var debArch = getDebPackageArch(arch);
+	return shell.task([], { cwd: '.build/linux/' + debArch});
 }
 
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
 gulp.task('clean-vscode-darwin', util.rimraf(path.join(path.dirname(root), 'VSCode-darwin')));
 gulp.task('clean-vscode-linux-ia32', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-ia32')));
 gulp.task('clean-vscode-linux-x64', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-x64')));
 gulp.task('clean-vscode-linux-arm', util.rimraf(path.join(path.dirname(root), 'VSCode-linux-arm')));
-gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/vscode-i386*'));
-gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/vscode-amd64*'));
+gulp.task('clean-vscode-linux-ia32-deb', util.rimraf('.build/linux/i386'));
+gulp.task('clean-vscode-linux-x64-deb', util.rimraf('.build/linux/amd64'));
 
 gulp.task('vscode-win32', ['optimize-vscode', 'clean-vscode-win32'], packageTask('win32'));
 gulp.task('vscode-darwin', ['optimize-vscode', 'clean-vscode-darwin'], packageTask('darwin'));
@@ -336,7 +328,8 @@ gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vsco
 gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb', 'vscode-linux-x64-min'], prepareDebPackage('x64'));
 gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
 gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
-gulp.task('vscode-linux-packages', ['vscode-linux-ia32-build-deb', 'vscode-linux-x64-build-deb']);
+gulp.task('vscode-linux-ia32-build-deb-catalog', ['vscode-linux-ia32-build-deb'], buildDebPackageCatalog('ia32'));
+gulp.task('vscode-linux-x64-build-deb-catalog', ['vscode-linux-x64-build-deb'], buildDebPackageCatalog('x64'));
 
 // Sourcemaps
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/lib/util.js
code:
@@ -1,11 +1,17 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+/*global require,exports,process,Buffer*/
+
 var es = require('event-stream');
 var debounce = require('debounce');
 var filter = require('gulp-filter');
 var azure = require('gulp-azure-storage');
 var rename = require('gulp-rename');
 var vzip = require('gulp-vinyl-zip');
 var util = require('gulp-util');
-var remote = require('gulp-remote-src');
 var _ = require('underscore');
 var path = require('path');
 var fs = require('fs');
@@ -252,32 +258,6 @@ exports.rimraf = function(dir) {
 	};
 };
 
-exports.downloadExtensions = function(extensions) {
-	var streams = Object.keys(extensions).map(function (fullName) {
-		var version = extensions[fullName];
-		var match = /^([^.]+)\.([^.]+)$/.exec(fullName);
-
-		if (!match) {
-			throw new Error('Bad extension: ' + fullName);
-		}
-
-		var publisher = match[1];
-		var name = match[2];
-		var url = 'https://' + publisher + '.gallery.vsassets.io/_apis/public/gallery/publisher/'
-			+ publisher + '/extension/' + name + '/' + version
-			+ '/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage';
-
-		return remote(url, { base: '' })
-			.pipe(vzip.src())
-			.pipe(filter('extension/**'))
-			.pipe(rename(function (p) {
-				p.dirname = path.posix.join(fullName, p.dirname.replace(/^extension[/\\]?/, ''));
-			}));
-	});
-
-	return es.merge(streams);
-};
-
 exports.getVersion = function (root) {
 	var version = process.env['BUILD_SOURCEVERSION'];
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/package.json
code:
@@ -0,0 +1,28 @@
+{
+	"name": "javascript-migration",
+	"displayName": "Helper extension for migrating to Salsa",
+	"description": "Informs users about the JS Salsa upgrade",
+	"version": "0.0.1",
+	"publisher": "vscode",
+	"engines": {
+		"vscode": "*"
+	},
+	"categories": [
+		"Other"
+	],
+	"activationEvents": [
+		"onLanguage:javascript",
+		"onLanguage:javascriptreact"
+	],
+	"main": "./out/extension",
+
+	"scripts": {
+		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:javascript-migration ./src/tsconfig.json"
+	},
+	"devDependencies": {
+		"typescript": "^1.7.5",
+		"vscode": "^0.11.0"
+	},
+    "dependencies": {
+    }
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/extension.ts
code:
@@ -0,0 +1,42 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import * as vscode from 'vscode';
+import * as cp from 'child_process';
+
+
+export function activate(context: vscode.ExtensionContext) {
+	const releaseNotesShown = 'javascript.releasenotesshown';
+
+	if (!context.globalState.get(releaseNotesShown)) {
+		// cheating with nls, this is a temporary extenion only, that doesn't need be localized
+		vscode.window.showInformationMessage('The JavaScript infrastructure has changed, please read the change notes.', 'Change Notes').then(selection => {
+			if (selection) {
+				open('http://go.microsoft.com/fwlink/?LinkId=733559');
+			}
+			context.globalState.update(releaseNotesShown, true);
+		});
+	}
+}
+
+function open(url: string) {
+	var cmd: string;
+
+	switch (process.platform) {
+		case 'darwin':
+			cmd = 'open';
+			break;
+		case 'win32':
+			cmd = 'start';
+			break;
+		default:
+			cmd = 'xdg-open';
+	}
+	return cp.exec(cmd + ' ' + url);
+}
+
+export function deactivate() {
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript-migration/src/tsconfig.json
code:
@@ -0,0 +1,12 @@
+{
+	"compilerOptions": {
+		"noLib": true,
+		"target": "es5",
+		"module": "commonjs",
+		"sourceMap": false,
+		"outDir": "../out"
+	},
+	"exclude": [
+		"node_modules"
+	]
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/json/src/jsonMain.ts
code:
@@ -75,7 +75,17 @@ export function activate(context: ExtensionContext) {
 	context.subscriptions.push(disposable);
 
 	languages.setLanguageConfiguration('json', {
-		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g
+		wordPattern: /(-?\d*\.\d\w*)|([^\[\{\]\}\:\"\,\s]+)/g,
+		__characterPairSupport: {
+			autoClosingPairs: [
+				{ open: '{', close: '}' },
+				{ open: '[', close: ']' },
+				{ open: '(', close: ')' },
+				{ open: '"', close: '"', notIn: ['string'] },
+				{ open: '\'', close: '\'', notIn: ['string', 'comment'] },
+				{ open: '`', close: '`', notIn: ['string', 'comment'] }
+			]
+		}
 	});
 }
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node-debug/node-debug.azure.json
code:
@@ -1,6 +1,6 @@
 {
 	"account": "monacobuild",
 	"container": "debuggers",
-	"zip": "91c3d00/node-debug.zip",
+	"zip": "609a344/node-debug.zip",
 	"output": ""
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node.d.ts
code:
@@ -648,7 +648,7 @@ declare module "child_process" {
         maxBuffer?: number;
         killSignal?: string;
     }, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
-    export function exec(command: string, callback: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
+    export function exec(command: string, callback?: (error: Error, stdout: Buffer, stderr: Buffer) =>void ): ChildProcess;
     export function execFile(file: string, args: string[], options: {
         cwd?: string;
         stdio?: any;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/php/src/features/validationProvider.ts
code:
@@ -184,41 +184,49 @@ export default class PHPValidationProvider {
 			} else {
 				args = PHPValidationProvider.BufferArgs;
 			}
-			let childProcess = cp.spawn(executable, args, options);
-			childProcess.on('error', (error: Error) => {
-				if (this.executableNotFound) {
+			try {
+				let childProcess = cp.spawn(executable, args, options);
+				childProcess.on('error', (error: Error) => {
+					if (this.executableNotFound) {
+						resolve();
+						return;
+					}
+					this.showError(error, executable);
+					this.executableNotFound = true;
 					resolve();
-					return;
-				}
-				let message: string = null;
-				if ((<any>error).code === 'ENOENT') {
-					message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
-				} else {
-					message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
-				}
-				vscode.window.showInformationMessage(message);
-				this.executableNotFound = true;
-				resolve();
-			});
-			if (childProcess.pid) {
-				if (this.trigger === RunTrigger.onType) {
-					childProcess.stdin.write(textDocument.getText());
-					childProcess.stdin.end();
-				}
-				childProcess.stdout.on('data', (data: Buffer) => {
-					decoder.write(data).forEach(processLine);
 				});
-				childProcess.stdout.on('end', () => {
-					let line = decoder.end();
-					if (line) {
-						processLine(line);
+				if (childProcess.pid) {
+					if (this.trigger === RunTrigger.onType) {
+						childProcess.stdin.write(textDocument.getText());
+						childProcess.stdin.end();
 					}
-					this.diagnosticCollection.set(textDocument.uri, diagnostics);
+					childProcess.stdout.on('data', (data: Buffer) => {
+						decoder.write(data).forEach(processLine);
+					});
+					childProcess.stdout.on('end', () => {
+						let line = decoder.end();
+						if (line) {
+							processLine(line);
+						}
+						this.diagnosticCollection.set(textDocument.uri, diagnostics);
+						resolve();
+					});
+				} else {
 					resolve();
-				});
-			} else {
-				resolve();
+				}
+			} catch (error) {
+				this.showError(error, executable);
 			}
 		});
 	}
+
+	private showError(error: any, executable: string): void {
+		let message: string = null;
+		if (error.code === 'ENOENT') {
+			message = `Cannot validate the php file. The php program was not found. Use the 'php.validate.executablePath' setting to configure the location of 'php'`;
+		} else {
+			message = error.message ? error.message : `Failed to run php using path: ${executable}. Reason is unknown.`;
+		}
+		vscode.window.showInformationMessage(message);
+	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/swift/snippets/swift.json
code:
@@ -1,22 +1,22 @@
 {
-	"println(\"...\")": {
+	"print(\"...\")": {
 		"prefix": "pr",
-		"body": "println(\"$1\")$0"
+		"body": "print(\"$1\")$0"
 	},
-	"println(\"\\(...)\")": {
+	"print(\"\\(...)\")": {
 		"prefix": "po",
-		"body": "println(\"\\($1)\")$0"
+		"body": "print(\"\\($1)\")$0"
 	},
 
-	"do...while loop": {
+	"repeat...while loop": {
 
-		"prefix": "do",
+		"prefix": "repeat",
 		"body": [
-			"do {",
+			"repeat {",
 			"	$0",
 			"} while ${true}"
 		],
-		"description": "do...while loop"
+		"description": "repeat...while loop"
 	},
 
 	"While loop": {
@@ -96,6 +96,28 @@
 		"description": "Else statement"
 	},
 
+	"Guard statement": {
+
+		"prefix": "guard",
+		"body": [
+			"guard let ${a} = ${optional} else {",
+			"	$0",
+			"}"
+		],
+		"description": "Guard statement"
+	},
+
+	"Optional Binding statement": {
+
+		"prefix": "ifnil",
+		"body": [
+			"if let ${a} = ${optional} {",
+			"	$0",
+			"}"
+		],
+		"description": "Optional Binding statement"
+	},
+
 	"Switch statement": {
 
 		"prefix": "switch",
@@ -133,4 +155,4 @@
 		],
 		"description": "Enum"
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/tasks/src/tasksMain.ts
code:
@@ -72,6 +72,17 @@ function createCompletionItems(): CompletionItem[] {
 	].join('\n');
 	result.push(item);
 
+	item = new CompletionItem('dotnet build');
+	item.kind = CompletionItemKind.Snippet;
+	item.detail = 'Use dotnet build.';
+	item.filterText = 'ts-dotnet build';
+	item.insertText = [
+		'"version": "0.1.0",',
+		'"command": "dotnet build",',
+		'"showOutput": "always"'
+	].join('\n');
+	result.push(item);
+
 	item = new CompletionItem('msbuild');
 	item.kind = CompletionItemKind.Snippet;
 	item.detail = 'Use msbuild to compile your project.';

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/package.json
code:
@@ -6,9 +6,13 @@
 	"author": "Microsoft Corporation",
 	"license": "MIT",
 	"publisher": "vscode",
+	"aiKey":"AIF-d9b70cd4-b9f9-4d70-929b-a071c400b217",
 	"engines": {
 		"vscode": "*"
 	},
+	"dependencies": {
+    "vscode-extension-telemetry": "^0.0.4"
+	},
 	"scripts": {
 		"vscode:prepublish": "node ../../node_modules/gulp/bin/gulp.js --gulpfile ../../gulpfile.plugins.js compile-plugin:typescript ./src/tsconfig.json"
 	},

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptMain.ts
code:
@@ -113,11 +113,6 @@ function registerSupports(modeID: string, host: TypeScriptServiceClientHost, cli
 		],
 
 		__electricCharacterSupport: {
-			brackets: [
-				{ tokenType: 'delimiter.curly.' + modeID, open: '{', close: '}', isElectric: true },
-				{ tokenType: 'delimiter.square.' + modeID, open: '[', close: ']', isElectric: true },
-				{ tokenType: 'delimiter.paren.' + modeID, open: '(', close: ')', isElectric: true }
-			],
 			docComment: { scope: 'comment.documentation', open: '/**', lineStart: ' * ', close: ' */' }
 		},
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typescriptServiceClient.ts
code:
@@ -18,6 +18,8 @@ import { ITypescriptServiceClient, ITypescriptServiceClientHost }  from './types
 
 import * as VersionStatus from './utils/versionStatus';
 
+import TelemetryReporter from 'vscode-extension-telemetry';
+
 interface CallbackItem {
 	c: (value: any) => void;
 	e: (err: any) => void;
@@ -34,6 +36,12 @@ interface RequestItem {
 	callbacks: CallbackItem;
 }
 
+interface IPackageInfo {
+	name: string;
+	version: string;
+	aiKey: string;
+}
+
 export default class TypeScriptServiceClient implements ITypescriptServiceClient {
 
 	public static Trace: boolean = process.env.TSS_TRACE || false;
@@ -56,6 +64,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 	private pendingResponses: number;
 	private callbacks: CallbackMap;
 
+	private _packageInfo: IPackageInfo;
+	private telemetryReporter: TelemetryReporter;
+
 	constructor(host: ITypescriptServiceClientHost) {
 		this.host = host;
 		this.pathSeparator = path.sep;
@@ -83,6 +94,9 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				this.startService();
 			}
 		});
+		if (this.packageInfo && this.packageInfo.aiKey) {
+			this.telemetryReporter = new TelemetryReporter(this.packageInfo.name, this.packageInfo.version, this.packageInfo.aiKey);
+		}
 		this.startService();
 	}
 
@@ -94,6 +108,32 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 		return TypeScriptServiceClient.Trace;
 	}
 
+	private get packageInfo(): IPackageInfo {
+
+		if (this._packageInfo !== undefined) {
+			return this._packageInfo;
+		}
+		let packagePath = path.join(__dirname, './../package.json');
+		let extensionPackage = require(packagePath);
+		if (extensionPackage) {
+			this._packageInfo = {
+				name: extensionPackage.name,
+				version: extensionPackage.version,
+				aiKey: extensionPackage.aiKey
+			};
+		} else {
+			this._packageInfo = null;
+		}
+
+		return this._packageInfo;
+	}
+
+	private logTelemetry(eventName: string, properties?: {[prop: string]: string}) {
+		if (this.telemetryReporter) {
+			this.telemetryReporter.sendTelemetryEvent(eventName, properties);
+		}
+	}
+
 	private service(): Promise<cp.ChildProcess> {
 		if (this.servicePromise) {
 			return this.servicePromise;
@@ -141,6 +181,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 					if (err) {
 						this.lastError = err;
 						window.showErrorMessage(`TypeScript language server couldn\'t be started. Error message is: ${err.message}`);
+						this.logTelemetry('error', {message: err.message});
 						return;
 					}
 					this.lastStart = Date.now();
@@ -212,6 +253,7 @@ export default class TypeScriptServiceClient implements ITypescriptServiceClient
 				} else if (diff < 2 * 1000 /* 2 seconds */) {
 					startService = false;
 					window.showErrorMessage('The Typesrript language service died 5 times right after it got started. The service will not be restarted. Please open a bug report.');
+					this.logTelemetry('serviceExited');
 				}
 			}
 			if (startService) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/node.additions.d.ts
code:
@@ -25,4 +25,13 @@ interface Console {
 declare var Console: {
     prototype: Console;
     new(): Console;
+};
+
+declare var require: {
+	toUrl(path: string): string;
+	(moduleName: string): any;
+	(dependencies: string[], callback: (...args: any[]) => any, errorback?: (err: any) => void): any;
+	config(data: any): any;
+	onError: Function;
+	__$__nodeRequire<T>(moduleName: string): T;
 };
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/src/typings/vscode-extension-telemetry.d.ts
code:
@@ -0,0 +1,6 @@
+declare module 'vscode-extension-telemetry' {
+	export default class TelemetryReporter {
+		constructor(extensionId: string,extensionVersion: string, key: string);
+		sendTelemetryEvent(eventName: string, properties?: { [key: string]: string }, measures?: { [key: string]: number }): void;
+	}
+}
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:package.json
code:
@@ -13,7 +13,7 @@
   "scripts": {
     "test": "node node_modules/mocha/bin/_mocha",
     "preinstall": "node build/npm/preinstall.js",
-    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/"
+    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/json/ install extensions/json/ && npm --prefix extensions/typescript/ install extensions/typescript/"
   },
   "dependencies": {
     "applicationinsights": "0.15.6",
@@ -24,11 +24,11 @@
     "http-proxy-agent": "^0.2.6",
     "https-proxy-agent": "^0.3.5",
     "iconv-lite": "^0.4.13",
+    "native-keymap": "^0.1.2",
     "sax": "^1.1.1",
     "semver": "^4.2.0",
     "vscode-debugprotocol": "^1.5.0",
     "vscode-textmate": "^1.0.11",
-    "native-keymap": "^0.1.2",
     "weak": "^1.0.1",
     "winreg": "0.0.12",
     "yauzl": "^2.3.1"
@@ -52,7 +52,6 @@
     "gulp-concat": "^2.6.0",
     "gulp-cssnano": "^2.1.0",
     "gulp-filter": "^3.0.0",
-    "gulp-insert": "^0.5.0",
     "gulp-json-editor": "^2.2.1",
     "gulp-mocha": "^2.1.3",
     "gulp-remote-src": "^0.4.0",
@@ -82,7 +81,7 @@
     "rimraf": "^2.2.8",
     "sinon": "^1.17.2",
     "source-map": "^0.4.4",
-    "tslint": "^3.2.2",
+    "tslint": "^3.3.0",
     "typescript": "^1.8.0",
     "uglify-js": "2.4.8",
     "underscore": "^1.8.2",

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/dom.ts
code:
@@ -4,18 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as mouseEvent from 'vs/base/browser/mouseEvent';
-import * as keyboardEvent from 'vs/base/browser/keyboardEvent';
-import {isChrome, isWebKit} from 'vs/base/browser/browser';
-import types = require('vs/base/common/types');
+import {TimeoutTimer} from 'vs/base/common/async';
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
 import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
-import {onUnexpectedError} from 'vs/base/common/errors';
-import browserService = require('vs/base/browser/browserService');
-import {TimeoutTimer} from 'vs/base/common/async';
-
-export type IKeyboardEvent = keyboardEvent.IKeyboardEvent;
-export type IMouseEvent = mouseEvent.IMouseEvent;
+import {isObject} from 'vs/base/common/types';
+import {isChrome, isWebKit} from 'vs/base/browser/browser';
+import {getService} from 'vs/base/browser/browserService';
+import {IKeyboardEvent, StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export function clearNode(node: HTMLElement) {
 	while (node.firstChild) {
@@ -37,7 +34,7 @@ export function safeStringifyDOMAware(obj: any): string {
 			return '[Element]';
 		}
 
-		if (types.isObject(value) || Array.isArray(value)) {
+		if (isObject(value) || Array.isArray(value)) {
 			if (seen.indexOf(value) !== -1) {
 				return '[Circular]';
 			} else {
@@ -243,12 +240,12 @@ export interface IAddStandardDisposableListenerSignature {
 }
 function _wrapAsStandardMouseEvent(handler: (e: IMouseEvent) => void): (e: MouseEvent) => void {
 	return function(e: MouseEvent) {
-		return handler(new mouseEvent.StandardMouseEvent(e));
+		return handler(new StandardMouseEvent(e));
 	};
 }
 function _wrapAsStandardKeyboardEvent(handler: (e: IKeyboardEvent) => void): (e: KeyboardEvent) => void {
 	return function(e: KeyboardEvent) {
-		return handler(new keyboardEvent.StandardKeyboardEvent(e));
+		return handler(new StandardKeyboardEvent(e));
 	};
 }
 export let addStandardDisposableListener: IAddStandardDisposableListenerSignature = function addStandardDisposableListener(node: HTMLElement, type: string, handler: (event: any) => void, useCapture?: boolean): IDisposable {
@@ -779,7 +776,7 @@ export function removeCSSRulesWithPrefix(ruleName: string, style = sharedStyle):
 }
 
 export function isHTMLElement(o: any): o is HTMLElement {
-	return browserService.getService().isHTMLElement(o);
+	return getService().isHTMLElement(o);
 }
 
 export const EventType = {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/globalMouseMoveMonitor.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import * as dom from 'vs/base/browser/dom';
 import {IframeUtils} from 'vs/base/browser/iframe';
+import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export interface IStandardMouseMoveEventData {
 	leftButton:boolean;
@@ -92,32 +92,32 @@ export class GlobalMouseMoveMonitor<R> implements IDisposable {
 
 		let windowChain = IframeUtils.getSameOriginWindowChain();
 		for (let i = 0; i < windowChain.length; i++) {
-			this.hooks.push(DomUtils.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
+			this.hooks.push(dom.addDisposableThrottledListener(windowChain[i].window.document, 'mousemove',
 				(data:R) => this.mouseMoveCallback(data),
 				(lastEvent:R, currentEvent:MouseEvent) => this.mouseMoveEventMerger(lastEvent, currentEvent)
 			));
-			this.hooks.push(DomUtils.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
+			this.hooks.push(dom.addDisposableListener(windowChain[i].window.document, 'mouseup', (e:MouseEvent) => this.stopMonitoring(true)));
 		}
 
 		if (IframeUtils.hasDifferentOriginAncestor()) {
 			let lastSameOriginAncestor = windowChain[windowChain.length - 1];
 			// We might miss a mouse up if it happens outside the iframe
 			// This one is for Chrome
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for FF
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent:MouseEvent) => {
 				let e = new StandardMouseEvent(browserEvent);
 				if (e.target.tagName.toLowerCase() === 'html') {
 					this.stopMonitoring(true);
 				}
 			}));
 			// This one is for IE
-			this.hooks.push(DomUtils.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
+			this.hooks.push(dom.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent:MouseEvent) => {
 				this.stopMonitoring(true);
 			}));
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/htmlContentRenderer.ts
code:
@@ -11,11 +11,12 @@ import {IHTMLContentElement} from 'vs/base/common/htmlContent';
 // import {WorkerClient} from 'vs/base/common/worker/workerClient';
 // import {DefaultWorkerFactory} from 'vs/base/worker/defaultWorkerFactory';
 import {marked} from 'vs/base/common/marked/marked';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 
 export type RenderableContent = string | IHTMLContentElement | IHTMLContentElement[];
 
 export interface RenderOptions {
-	actionCallback?: (content: string, event?: DOM.IMouseEvent) => void;
+	actionCallback?: (content: string, event?: IMouseEvent) => void;
 	codeBlockRenderer?: (modeId: string, value: string) => string;
 }
 
@@ -228,7 +229,7 @@ interface IFormatParseTree {
 	children?: IFormatParseTree[];
 }
 
-function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: DOM.IMouseEvent) => void) {
+function renderFormattedText(element: Node, treeNode: IFormatParseTree, actionCallback?: (content: string, event?: IMouseEvent) => void) {
 	var child: Node;
 
 	if (treeNode.type === FormatType.Text) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/idleMonitor.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as DomUtils from 'vs/base/browser/dom';
-import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
+import {TimeoutTimer} from 'vs/base/common/async';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
+import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
 import {getService} from 'vs/base/browser/browserService';
-import {TimeoutTimer} from 'vs/base/common/async';
+import * as dom from 'vs/base/browser/dom';
 
 export enum UserStatus {
 	Idle,
@@ -34,8 +34,8 @@ export class IdleMonitor extends Disposable {
 		this._idleTime = idleTime;
 
 		this._eventEmitter = this._register(new EventEmitter());
-		this._register(DomUtils.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
-		this._register(DomUtils.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'mousemove', () => this._onUserActive()));
+		this._register(dom.addDisposableListener(getService().document, 'keydown', () => this._onUserActive()));
 		this._onUserActive();
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/keyboardEvent.ts
code:
@@ -5,9 +5,9 @@
 
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
-import {KeyMod, KeyCode} from 'vs/base/common/keyCodes';
+import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 
 let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 (function() {
@@ -127,18 +127,18 @@ let KEY_CODE_MAP: {[keyCode:number]:KeyCode} = {};
 
 	KEY_CODE_MAP[226] = KeyCode.OEM_102;
 
-	if (Browser.isIE11orEarlier) {
+	if (browser.isIE11orEarlier) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-	} else if (Browser.isFirefox) {
+	} else if (browser.isFirefox) {
 		KEY_CODE_MAP[59] = KeyCode.US_SEMICOLON;
 		KEY_CODE_MAP[107] = KeyCode.US_EQUAL;
 		KEY_CODE_MAP[109] = KeyCode.US_MINUS;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			KEY_CODE_MAP[224] = KeyCode.Meta;
 		}
-	} else if (Browser.isWebKit) {
+	} else if (browser.isWebKit) {
 		KEY_CODE_MAP[91] = KeyCode.Meta;
-		if (Platform.isMacintosh) {
+		if (platform.isMacintosh) {
 			// the two meta keys in the Mac have different key codes (91 and 93)
 			KEY_CODE_MAP[93] = KeyCode.Meta;
 		} else {
@@ -187,10 +187,10 @@ export interface IKeyboardEvent {
 	stopPropagation(): void;
 }
 
-const ctrlKeyMod = (Platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
+const ctrlKeyMod = (platform.isMacintosh ? KeyMod.WinCtrl : KeyMod.CtrlCmd);
 const altKeyMod = KeyMod.Alt;
 const shiftKeyMod = KeyMod.Shift;
-const metaKeyMod = (Platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
+const metaKeyMod = (platform.isMacintosh ? KeyMod.CtrlCmd : KeyMod.WinCtrl);
 
 export class StandardKeyboardEvent implements IKeyboardEvent {
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/mouseEvent.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as Platform from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
 import {IframeUtils} from 'vs/base/browser/iframe';
 
 export interface IMouseEvent {
@@ -21,6 +21,7 @@ export interface IMouseEvent {
 	shiftKey:boolean;
 	altKey:boolean;
 	metaKey:boolean;
+	timestamp:number;
 
 	preventDefault(): void;
 	stopPropagation(): void;
@@ -82,7 +83,7 @@ export class StandardMouseEvent implements IMouseEvent {
 		};
 
 		let test1 = readPageCoords, test2 = readClientCoords;
-		if (Browser.isIE10) {
+		if (browser.isIE10) {
 			// The if A elseif B logic here is inversed in IE10 due to an IE10 issue
 			test1 = readClientCoords;
 			test2 = readPageCoords;
@@ -183,7 +184,7 @@ export class StandardMouseWheelEvent {
 
 			// horizontal delta scroll
 			if (typeof e1.wheelDeltaX !== 'undefined') {
-				if (Browser.isSafari && Platform.isWindows) {
+				if (browser.isSafari && platform.isWindows) {
 					this.deltaX = - (e1.wheelDeltaX / 120);
 				} else {
 					this.deltaX = e1.wheelDeltaX / 120;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/checkbox/checkbox.ts
code:
@@ -10,14 +10,14 @@ import 'vs/css!./checkbox';
 import DOM = require('vs/base/browser/dom');
 import {KeyCode} from 'vs/base/common/keyCodes';
 import {Widget} from 'vs/base/browser/ui/widget';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 
 export interface ICheckboxOpts {
 	actionClassName: string;
 	title: string;
 	isChecked: boolean;
 	onChange: (viaKeyboard: boolean) => void;
-	onKeyDown?: (e: StandardKeyboardEvent) => void;
+	onKeyDown?: (e: IKeyboardEvent) => void;
 }
 
 export class Checkbox extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/findinput/findInput.ts
code:
@@ -13,8 +13,8 @@ import {Checkbox} from 'vs/base/browser/ui/checkbox/checkbox';
 import {IContextViewProvider} from 'vs/base/browser/ui/contextview/contextview';
 import {Widget} from 'vs/base/browser/ui/widget';
 import Event, {Emitter} from 'vs/base/common/event';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
 export interface IFindInputOptions {
@@ -59,17 +59,17 @@ export class FindInput extends Widget {
 	private _onDidOptionChange = this._register(new Emitter<boolean>());
 	public onDidOptionChange: Event<boolean /* via keyboard */> = this._onDidOptionChange.event;
 
-	private _onKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyDown: Event<StandardKeyboardEvent> = this._onKeyDown.event;
+	private _onKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyDown: Event<IKeyboardEvent> = this._onKeyDown.event;
 
 	private _onInput = this._register(new Emitter<void>());
 	public onInput: Event<void> = this._onInput.event;
 
-	private _onKeyUp = this._register(new Emitter<StandardKeyboardEvent>());
-	public onKeyUp: Event<StandardKeyboardEvent> = this._onKeyUp.event;
+	private _onKeyUp = this._register(new Emitter<IKeyboardEvent>());
+	public onKeyUp: Event<IKeyboardEvent> = this._onKeyUp.event;
 
-	private _onCaseSensitiveKeyDown = this._register(new Emitter<StandardKeyboardEvent>());
-	public onCaseSensitiveKeyDown: Event<StandardKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
+	private _onCaseSensitiveKeyDown = this._register(new Emitter<IKeyboardEvent>());
+	public onCaseSensitiveKeyDown: Event<IKeyboardEvent> = this._onCaseSensitiveKeyDown.event;
 
 	constructor(parent:HTMLElement, contextViewProvider: IContextViewProvider, options?:IFindInputOptions) {
 		super();
@@ -257,7 +257,7 @@ export class FindInput extends Widget {
 
 		// Arrow-Key support to navigate between options
 		let indexes = [this.caseSensitive.domNode, this.wholeWords.domNode, this.regex.domNode];
-		this.onkeydown(this.domNode, (event: StandardKeyboardEvent) => {
+		this.onkeydown(this.domNode, (event: IKeyboardEvent) => {
 			if (event.equals(CommonKeybindings.LEFT_ARROW) || event.equals(CommonKeybindings.RIGHT_ARROW) || event.equals(CommonKeybindings.ESCAPE)) {
 				let index = indexes.indexOf(<HTMLElement>document.activeElement);
 				if (index >= 0) {
@@ -317,7 +317,7 @@ export class FindInput extends Widget {
 }
 
 interface IMatchCountOpts {
-	onClick: (e:StandardMouseEvent) => void;
+	onClick: (e:IMouseEvent) => void;
 }
 
 class MatchCount extends Widget {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/abstractScrollbar.ts
code:
@@ -7,7 +7,7 @@
 import * as Browser from 'vs/base/browser/browser';
 import * as Platform from 'vs/base/common/platform';
 import * as DomUtils from 'vs/base/browser/dom';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 import {IMouseWheelEvent, IParent, Visibility, IScrollbar} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {Disposable} from 'vs/base/common/lifecycle';
 import {GlobalMouseMoveMonitor, IStandardMouseMoveEventData, standardMouseMoveMerger} from 'vs/base/browser/globalMouseMoveMonitor';
@@ -215,7 +215,7 @@ class ScrollbarArrow extends Widget {
 		this._mousedownScheduleRepeatTimer = this._register(new TimeoutTimer());
 	}
 
-	private _arrowMouseDown(e: StandardMouseEvent): void {
+	private _arrowMouseDown(e: IMouseEvent): void {
 		let repeater = () => {
 			this._parent.onMouseWheel(this._mouseWheelEventFactory());
 		};
@@ -446,7 +446,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	// ----------------- DOM events
 
-	private _domNodeMouseDown(e: StandardMouseEvent): void {
+	private _domNodeMouseDown(e: IMouseEvent): void {
 		if (e.target !== this.domNode) {
 			return;
 		}
@@ -468,14 +468,14 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 		}
 	}
 
-	private _onMouseDown(e: StandardMouseEvent): void {
+	private _onMouseDown(e: IMouseEvent): void {
 		let domNodePosition = DomUtils.getDomNodePosition(this.domNode);
 		let desiredSliderPosition = this._mouseDownRelativePosition(e, domNodePosition) - this._scrollbarState.getArrowSize() - this._scrollbarState.getSliderSize() / 2;
 		this.setDesiredScrollPosition(this._scrollbarState.convertSliderPositionToScrollPosition(desiredSliderPosition));
 		this._sliderMouseDown(e);
 	}
 
-	private _sliderMouseDown(e: StandardMouseEvent): void {
+	private _sliderMouseDown(e: IMouseEvent): void {
 		if (e.leftButton) {
 			let initialMouseOrthogonalPosition = this._sliderOrthogonalMousePosition(e);
 			let initialScrollPosition = this._getScrollPosition();
@@ -523,7 +523,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	protected abstract _renderDomNode(largeSize: number, smallSize: number): void;
 	protected abstract _updateSlider(sliderSize: number, sliderPosition: number): void;
-	protected abstract _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
+	protected abstract _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: DomUtils.IDomNodePosition): number;
 	protected abstract _sliderMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _sliderOrthogonalMousePosition(e: IMouseMoveEventData): number;
 	protected abstract _getScrollPosition(): number;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -57,7 +57,7 @@ export class HorizontalScrollbar extends AbstractScrollbar {
 		StyleMutator.setBottom(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posx - domNodePosition.left;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/scrollableElementImpl.ts
code:
@@ -8,7 +8,7 @@ import 'vs/css!./media/scrollbars';
 
 import * as DomUtils from 'vs/base/browser/dom';
 import * as Platform from 'vs/base/common/platform';
-import {StandardMouseWheelEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardMouseWheelEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 import {HorizontalScrollbar} from 'vs/base/browser/ui/scrollbar/horizontalScrollbar';
 import {VerticalScrollbar} from 'vs/base/browser/ui/scrollbar/verticalScrollbar';
@@ -319,12 +319,12 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 		this._hide();
 	}
 
-	private _onMouseOut(e: StandardMouseEvent): void {
+	private _onMouseOut(e: IMouseEvent): void {
 		this._mouseIsOver = false;
 		this._hide();
 	}
 
-	private _onMouseOver(e: StandardMouseEvent): void {
+	private _onMouseOver(e: IMouseEvent): void {
 		this._mouseIsOver = true;
 		this._reveal();
 	}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/scrollbar/verticalScrollbar.ts
code:
@@ -6,7 +6,7 @@
 
 import * as Browser from 'vs/base/browser/browser';
 import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData} from 'vs/base/browser/ui/scrollbar/abstractScrollbar';
-import {StandardMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
+import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IScrollable} from 'vs/base/common/scrollable';
@@ -58,7 +58,7 @@ export class VerticalScrollbar extends AbstractScrollbar {
 		StyleMutator.setTop(this.domNode, 0);
 	}
 
-	protected _mouseDownRelativePosition(e: StandardMouseEvent, domNodePosition: IDomNodePosition): number {
+	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {
 		return e.posy - domNodePosition.top;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/widget.ts
code:
@@ -6,33 +6,33 @@
 'use strict';
 
 import {Disposable} from 'vs/base/common/lifecycle';
-import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
-import {StandardKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {StandardMouseEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
+import {StandardKeyboardEvent, IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import * as DomUtils from 'vs/base/browser/dom';
 
 export abstract class Widget extends Disposable {
 
-	protected onclick(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onclick(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.CLICK, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmousedown(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmousedown(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_DOWN, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onmouseover(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onmouseover(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.MOUSE_OVER, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:StandardMouseEvent)=>void): void {
+	protected onnonbubblingmouseout(domNode:HTMLElement, listener:(e:IMouseEvent)=>void): void {
 		this._register(DomUtils.addDisposableNonBubblingMouseOutListener(domNode, (e:MouseEvent) => listener(new StandardMouseEvent(e))));
 	}
 
-	protected onkeydown(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeydown(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_DOWN, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 
-	protected onkeyup(domNode:HTMLElement, listener:(e:StandardKeyboardEvent)=>void): void {
+	protected onkeyup(domNode:HTMLElement, listener:(e:IKeyboardEvent)=>void): void {
 		this._register(DomUtils.addDisposableListener(domNode, DomUtils.EventType.KEY_UP, (e:KeyboardEvent) => listener(new StandardKeyboardEvent(e))));
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/buildfile.js
code:
@@ -2,22 +2,15 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
 
-function createModuleDescription(name, exclude) {
-	var result= {};
-	var excludes = ['vs/css', 'vs/nls', 'vs/text'];
-	result.name= name;
-	if (Array.isArray(exclude) && exclude.length > 0) {
-		excludes = excludes.concat(exclude);
-	}
-	result.exclude= excludes;
-	return result;
-}
+'use strict';
 
-exports.collectModules= function() {
-	return [
-		createModuleDescription('vs/base/common/worker/workerServer'),
-		createModuleDescription('vs/base/common/worker/simpleWorker'),
-	];
-};
\ No newline at end of file
+exports.collectModules = function() {
+	return [{
+		name: 'vs/base/common/worker/workerServer',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}, {
+		name: 'vs/base/common/worker/simpleWorker',
+		exclude: [ 'vs/css', 'vs/nls', 'vs/text' ]
+	}];
+};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/flags.ts
code:
@@ -6,7 +6,6 @@
 
 import { globals } from 'vs/base/common/platform';
 
-export const workersCount = environment('workersCount', 2);
 export const enableTasks = environment('enableTasks');
 export const enableSendASmile = environment('enableSendASmile');
 export const enableJavaScriptRewriting = environment('enableJavaScriptRewriting');
@@ -25,4 +24,8 @@ function environment(name:string, fallback:any = false):any {
 	}
 
 	return fallback;
-}
\ No newline at end of file
+}
+
+export function workersCount(defaultCount:number): number {
+	return environment('workersCount', defaultCount);
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/http.ts
code:
@@ -4,47 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import nls = require('vs/nls');
-
-// Methods
-export var GET = 'GET';
-export var POST = 'POST';
-export var PUT = 'PUT';
-export var DELETE = 'DELETE';
-
-// Header
-export namespace Header {
-	export var CONTENT_TYPE = 'Content-Type';
-	export var CONTENT_LENGTH = 'Content-Length';
-	export var LAST_MODIFIED = 'Last-Modified';
-	export var LOCATION = 'Location';
-	export var ETAG = 'ETag';
-	export var X_CONTENT_CHARSET = 'X-Content-Charset';
-	export var X_CONTENT_TYPES = 'X-Content-Types';
-	export var X_CONTENT_HASH = 'X-Content-Hash';
-	export var X_FILEPATH = 'X-Filepath';
-	export var X_RESOURCE = 'X-Resource';
-}
-
-// Mime
-export namespace Mime {
-	export var RAW = 'application/octet-stream';
-	export var JSON = 'application/json';
-	export var TEXT = 'text/plain';
-	export var HTML = 'text/html';
-}
-
-// Charset
-export namespace Charset {
-	export var UTF8 = 'utf-8';
-	export var UTF8_BOM = 'UTF8_BOM';
-}
-
-export interface IDataChunk {
-	header(name:string):string;
-	value():string;
-}
-
+import * as nls from 'vs/nls';
 
 export interface IXHROptions {
 	type?:string;
@@ -66,73 +26,6 @@ export interface IXHRResponse {
 	getResponseHeader: (header:string) => string;
 }
 
-export function isRedirect(status: number) : boolean {
-	return status >= 300 && status <= 303 || status === 307;
-}
-
-var contentLengthPattern = /X-Chunk-Length:(\d+)\r\n\r\n/gi,
-	headerPattern = /(.+?):(.+?)\r\n(\r\n)?/gm;
-
-function newDataChunk(responseText:string, headerStartOffset:number, headerEndOffset:number, contentLength:number):IDataChunk {
-
-	var _value:string,
-		_headers:{[name:string]:string};
-
-	return {
-		header: function(name:string):string {
-			if(typeof _headers === 'undefined') {
-				_headers = Object.create(null);
-				headerPattern.lastIndex = headerStartOffset;
-				while(true) {
-					var match = headerPattern.exec(responseText);
-					if(!match) {
-						// no header found
-						break;
-					}
-					_headers[match[1].toLowerCase()] = match[2];
-
-					if(match[3]) {
-						// the last header found
-						break;
-					}
-				}
-			}
-			return _headers[name.toLowerCase()];
-		},
-		value: function() {
-			if(typeof _value === 'undefined') {
-				_value = responseText.substr(headerEndOffset + 2 /*crlf*/, contentLength);
-			}
-			return _value;
-		}
-	};
-}
-
-/**
- * Parses the response text of the provided request into individual data chunks. The chunks
- * are filled into the provided array.
- */
-export function parseChunkedData(request:IXHRResponse, collection:IDataChunk[], offset:number = 0):number {
-
-	var responseText = request.responseText;
-
-	contentLengthPattern.lastIndex = offset;
-
-	while(true) {
-		var match = contentLengthPattern.exec(responseText);
-		if(!match) {
-			return offset;
-		}
-		var contentLength = parseInt(match[1], 10);
-		if(responseText.length < contentLengthPattern.lastIndex + contentLength) {
-			return offset;
-		}
-
-		collection.push(newDataChunk(responseText, offset, contentLengthPattern.lastIndex - 2, contentLength));
-		offset = contentLengthPattern.lastIndex + contentLength;
-	}
-}
-
 export function getErrorStatusDescription(status: number) : string {
 	if (status < 400) {
 		return void 0;
@@ -158,4 +51,4 @@ export function getErrorStatusDescription(status: number) : string {
 		case 503: return nls.localize('status.503', 'Service Unavailable. The server is currently unavailable (overloaded or down).');
 		default: return nls.localize('status.416', 'HTTP status code {0}', status);
 	}
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/network.ts
code:
@@ -4,426 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import assert = require('vs/base/common/assert');
-import objects = require('vs/base/common/objects');
-import strings = require('vs/base/common/strings');
-import hash = require('vs/base/common/hash');
-import paths = require('vs/base/common/paths');
-import URI from 'vs/base/common/uri';
-
-var _colon = ':'.charCodeAt(0),
-	_slash = '/'.charCodeAt(0),
-	_questionMark = '?'.charCodeAt(0),
-	_hash = '#'.charCodeAt(0);
-
-export class ParsedUrl {
-
-	private spec:string;
-	private specLength:number;
-	private schemeStart:number;
-	private domainStart:number;
-	private portStart:number;
-	private pathStart:number;
-	private queryStringStart:number;
-	private fragmentIdStart:number;
-
-	constructor(spec:string) {
-		this.spec = spec || strings.empty;
-		this.specLength = this.spec.length;
-
-
-
-		this.parse();
-	}
-
-	private forwardSubstring(startIndex:number, endIndex:number): string {
-		if (startIndex < endIndex) {
-			return this.spec.substring(startIndex, endIndex);
-		}
-		return strings.empty;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart - 1);
-	}
-
-	/**
-	 * http: for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getProtocol(): string {
-		return this.forwardSubstring(this.schemeStart, this.domainStart);
-	}
-
-	/**
-	 * www.test.com for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getDomain(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.portStart);
-	}
-
-	/**
-	 * 8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPort(): string {
-		return this.forwardSubstring(this.portStart + 1, this.pathStart);
-	}
-
-	/**
-	 * www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getHost(): string {
-		return this.forwardSubstring(this.domainStart + 2, this.pathStart);
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath(): string {
-		return this.forwardSubstring(this.pathStart, this.queryStringStart);
-	}
-
-	/**
-	 * query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getQueryString(): string {
-		return this.forwardSubstring(this.queryStringStart + 1, this.fragmentIdStart);
-	}
-
-	/**
-	 * hash for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getFragmentId(): string {
-		return this.forwardSubstring(this.fragmentIdStart + 1, this.specLength);
-	}
-
-	/**
-	 * http://www.test.com:8000 for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforePath(): string {
-		return this.forwardSubstring(0, this.pathStart);
-	}
-	/**
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getAllBeforeFragmentId(): string {
-		return this.forwardSubstring(0, this.fragmentIdStart);
-	}
-
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):string {
-		var questionMarkIndex = relativeUrl.indexOf('?');
-		var hashIndex = relativeUrl.indexOf('#');
-		var suffixIndex = relativeUrl.length;
-		if (questionMarkIndex !== -1 && questionMarkIndex < suffixIndex) {
-			suffixIndex = questionMarkIndex;
-		}
-		if (hashIndex !== -1 && hashIndex < suffixIndex) {
-			suffixIndex = hashIndex;
-		}
-
-		var relativeUrlPath = relativeUrl.substring(0, suffixIndex);
-		var relativeUrlSuffix = relativeUrl.substring(suffixIndex);
-
-
-		relativeUrlPath = relativeUrlPath.replace('\\', '/');
-
-		var resultPath: string;
-		if (strings.startsWith(relativeUrlPath, '/')) {
-			// Looks like an absolute URL
-			resultPath = paths.join(relativeUrlPath);
-		} else {
-			resultPath = paths.join(paths.dirname(this.getPath()), relativeUrlPath);
-		}
-
-		while (resultPath.charAt(0) === '/') {
-			resultPath = resultPath.substr(1);
-		}
-
-		while (resultPath.indexOf('../') === 0) {
-			resultPath = resultPath.substr(3);
-		}
-
-		return this.getAllBeforePath() + '/' + resultPath + relativeUrlSuffix;
-	}
-
-	// scheme://domain:port/path?query_string#fragment_id
-	private parse(): void {
-		var IN_SCHEME = 0,
-			IN_DOMAIN = 1,
-			IN_PORT = 2,
-			IN_PATH = 3,
-			IN_QUERY_STRING = 4,
-			state = IN_SCHEME,
-			spec = this.spec,
-			length = this.specLength,
-			i:number,
-			prevChCode:number = -1,
-			prevPrevChCode:number = -1,
-			chCode:number;
-
-		this.schemeStart = 0;
-		this.domainStart = this.specLength;
-		this.portStart = this.specLength;
-		this.pathStart = this.specLength;
-		this.queryStringStart = this.specLength;
-		this.fragmentIdStart = this.specLength;
-
-		for (i = 0; i < length; i++) {
-			chCode = spec.charCodeAt(i);
-
-			switch (state) {
-				case IN_SCHEME:
-					if (prevChCode === _slash && chCode === _slash) {
-						// going into the domain
-						state = IN_DOMAIN;
-						this.domainStart = i - 1;
-					}
-					break;
-
-				case IN_DOMAIN:
-					if (chCode === _colon) {
-						// going into the port
-						state = IN_PORT;
-						this.portStart = i;
-					} else if (chCode === _slash) {
-						// skipping the port, going straight to the path
-						state = IN_PATH;
-						this.portStart = i;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the port, path & query string, going straight to the fragment, we can halt now
-						this.portStart = i;
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PORT:
-					if (chCode === _slash) {
-						// going into the path
-						state = IN_PATH;
-						this.pathStart = i;
-					} else if (chCode === _hash) {
-						// skipping the path & query string, going straight to the fragment, we can halt now
-						this.pathStart = i;
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_PATH:
-					if (chCode === _questionMark) {
-						// going in to the query string
-						state = IN_QUERY_STRING;
-						this.queryStringStart = i;
-					} else if (chCode === _hash) {
-						// skipping the query string, going straight to the fragment, we can halt now
-						this.queryStringStart = i;
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-
-				case IN_QUERY_STRING:
-					if (chCode === _hash) {
-						// going into the hash, we can halt now
-						this.fragmentIdStart = i;
-						i = length;
-					}
-					break;
-			}
-
-			prevPrevChCode = prevChCode;
-			prevChCode = chCode;
-		}
-
-		if (state === IN_SCHEME) {
-			// Looks like we had a very bad url
-			this.schemeStart = this.specLength;
-		}
-	}
-}
-
-
-export class URL extends URI implements objects.IEqualable {
-
-	/**
-	 * Creates a new URL from the provided value
-	 * by decoding it first.
-	 * @param value An encoded url value.
-	 */
-	public static fromEncoded(value:string):URL {
-		return new URL(decodeURIComponent(value));
-	}
-
-	public static fromValue(value:string):URL {
-		return new URL(value);
-	}
-
-	public static fromUri(value: URI): URL {
-		if (!value) {
-			return <any>value;
-		} else if (value instanceof URL) {
-			return value;
-		} else {
-			return new URL(value);
-		}
-	}
-
-	private _spec:string;
-	private _uri: URI;
-	private _parsed:ParsedUrl;
-
-	constructor(spec: string);
-	constructor(spec: URI);
-	constructor(stringOrURI: string|URI) {
-		super();
-		assert.ok(!!stringOrURI, 'spec must not be null');
-		if(typeof stringOrURI === 'string') {
-			this._uri = URI.parse(stringOrURI);
-		} else {
-			this._uri = stringOrURI;
-		}
-		this._spec = this._uri.toString(); // make sure spec is normalized
-		this._parsed = null;
-	}
-
-	public equals(other:any):boolean {
-		if (this.toString() !== String(other)) {
-			return false;
-		}
-
-		return (other instanceof URL || other instanceof URI);
-	}
-
-	public hashCode():number {
-		return hash.computeMurmur2StringHashCode(this._spec);
-	}
-
-	public isInMemory(): boolean {
-		return this.scheme === schemas.inMemory;
-	}
-
-	/**
-	 * http for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getScheme():string {
-		this._ensureParsedUrl();
-		return this._parsed.getScheme();
-	}
-
-	/**
-	 * /this/that/theother.html for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public getPath():string {
-		this._ensureParsedUrl();
-		return this._parsed.getPath();
-	}
-
-	/**
-	 * Strips out the hash part of the URL.
-	 * http://www.test.com:8000/this/that/theother.html?query=foo for http://www.test.com:8000/this/that/theother.html?query=foo#hash
-	 */
-	public toUnique():string {
-		this._ensureParsedUrl();
-		return this._parsed.getAllBeforeFragmentId();
-	}
-
-	public startsWith(other:URL):boolean {
-		return strings.startsWith(this._spec, other._spec);
-	}
-
-	/**
-	 * Combine with a relative url, returns absolute url
-	 * e.g.
-	 * http://www.test.com/this/that/theother.html?query=foo#hash=hash
-	 * combined with ../test.js?query=foo#hash
-	 * results in http://www.test.com/this/test.js?query=foo#hash
-	 */
-	public combine(relativeUrl:string):URL {
-		this._ensureParsedUrl();
-		return new URL(this._parsed.combine(relativeUrl));
-	}
-
-	private _ensureParsedUrl(): void {
-		if(this._parsed === null) {
-			this._parsed = new ParsedUrl(this._spec);
-		}
-	}
-
-	// ----- URI implementation -------------------------
-
-	public get scheme(): string {
-		return this._uri.scheme;
-	}
-
-	public get authority(): string {
-		return this._uri.authority;
-	}
-
-	public get path(): string {
-		return this._uri.path;
-	}
-
-	public get fsPath(): string {
-		return this._uri.fsPath;
-	}
-
-	public get query(): string {
-		return this._uri.query;
-	}
-
-	public get fragment(): string {
-		return this._uri.fragment;
-	}
-
-	public withScheme(value: string): URI {
-		return URI.create(value, this.authority, this.fsPath, this.query, this.fragment);
-	}
-
-	public withAuthority(value: string): URI {
-		return URI.create(this.scheme, value, this.fsPath, this.query, this.fragment);
-	}
-
-	public withPath(value: string): URI {
-		return URI.create(this.scheme, this.authority, value, this.query, this.fragment);
-	}
-
-	public withQuery(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, value, this.fragment);
-	}
-
-	public withFragment(value: string): URI {
-		return URI.create(this.scheme, this.authority, this.fsPath, this.query, value);
-	}
-
-	public with(scheme: string, authority: string, path: string, query: string, fragment: string): URI {
-		return URI.create(scheme, authority, path, query, fragment);
-	}
-
-	public toString():string {
-		return this._spec;
-	}
-
-	public toJSON(): any {
-		return this.toString();
-	}
-}
-
-export namespace schemas {
+export namespace Schemas {
 
 	/**
 	 * A schema that is used for models that exist in memory
@@ -436,4 +17,4 @@ export namespace schemas {
 	export var https:string = 'https';
 
 	export var file:string = 'file';
-}
\ No newline at end of file
+}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/strings.ts
code:
@@ -277,36 +277,6 @@ export function normalizeNFC(str: string, cache?: { [str: string]: string }): st
 	return res;
 }
 
-export function isCamelCasePattern(pattern: string): boolean {
-	return (/^\w[\w.]*$/).test(pattern);
-}
-
-export function isFalsyOrWhitespace(s: string): boolean {
-	return !s || !s.trim();
-}
-
-export function anchorPattern(value: string, start: boolean, end: boolean): string {
-	if (start) {
-		value = '^' + value;
-	}
-
-	if (end) {
-		value = value + '$';
-	}
-
-	return value;
-}
-
-export function assertRegExp(pattern: string, modifiers: string): void {
-	if (regExpLeadsToEndlessLoop(new RegExp(pattern, modifiers))) {
-		throw new Error('Regular expression /' + pattern + '/g results in infinitive matches');
-	}
-}
-
-export function colorize(code: number, value: string): string {
-	return '\x1b[' + code + 'm' + value + '\x1b[0m';
-}
-
 /**
  * Returns first index of the string that is not whitespace.
  * If string is empty or contains only whitespaces, returns -1

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/simpleWorker.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IWorker, IWorkerFactory} from './workerClient';
-import {TPromise, ValueCallback, ErrorCallback} from 'vs/base/common/winjs.base';
-import errors = require('vs/base/common/errors');
+import {transformErrorForSerialization} from 'vs/base/common/errors';
 import {Disposable} from 'vs/base/common/lifecycle';
+import {ErrorCallback, TPromise, ValueCallback} from 'vs/base/common/winjs.base';
+import {IWorker, IWorkerFactory} from './workerClient';
 
 const INITIALIZE = '$initialize';
 
@@ -139,7 +139,7 @@ class SimpleWorkerProtocol {
 				vsWorker: this._workerId,
 				seq: req,
 				res: undefined,
-				err: errors.transformErrorForSerialization(e)
+				err: transformErrorForSerialization(e)
 			});
 		});
 	}
@@ -195,7 +195,7 @@ export class SimpleWorkerClient<T> extends Disposable {
 			moduleId,
 			loaderConfiguration
 		]);
-		this._onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this._onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
 		// Create proxy to loaded code
 		let proxyMethodRequest = (method:string, args:any[]):TPromise<any> => {
@@ -224,8 +224,12 @@ export class SimpleWorkerClient<T> extends Disposable {
 	}
 
 	private _request(method:string, args:any[]): TPromise<any> {
-		return this._onModuleLoaded.then(() => {
-			return this._protocol.sendMessage(method, args);
+		return new TPromise<any>((c, e, p) => {
+			this._onModuleLoaded.then(() => {
+				this._protocol.sendMessage(method, args).then(c, e);
+			}, e);
+		}, () => {
+			// Cancel intentionally not supported
 		});
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerClient.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import * as timer from 'vs/base/common/timer';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {onUnexpectedError, transformErrorForSerialization} from 'vs/base/common/errors';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 export interface IWorker {
 	getId():number;
@@ -39,17 +39,17 @@ export class WorkerClient {
 	private _promises:{[id:string]:IActiveRequest;};
 	private _worker:IWorker;
 
-	private _messagesQueue:protocol.IClientMessage[];
+	private _messagesQueue:workerProtocol.IClientMessage[];
 	private _processQueueTimeout:number;
 	private _waitingForWorkerReply:boolean;
 	private _lastTimerEvent:timer.ITimerEvent;
 
-	private _remoteCom: protocol.RemoteCom;
-	private _decodeMessageName: (msg: protocol.IClientMessage) => string;
+	private _remoteCom: workerProtocol.RemoteCom;
+	private _decodeMessageName: (msg: workerProtocol.IClientMessage) => string;
 
 	public onModuleLoaded:TPromise<void>;
 
-	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:protocol.IClientMessage)=>string) {
+	constructor(workerFactory:IWorkerFactory, moduleId:string, decodeMessageName:(msg:workerProtocol.IClientMessage)=>string) {
 		this._decodeMessageName = decodeMessageName;
 		this._lastMessageId = 0;
 		this._promises = {};
@@ -74,18 +74,18 @@ export class WorkerClient {
 
 		let MonacoEnvironment = (<any>window).MonacoEnvironment || null;
 
-		this.onModuleLoaded = this._sendMessage(protocol.MessageType.INITIALIZE, {
+		this.onModuleLoaded = this._sendMessage(workerProtocol.MessageType.INITIALIZE, {
 			id: this._worker.getId(),
 			moduleId: moduleId,
 			loaderConfiguration: loaderConfiguration,
 			MonacoEnvironment: MonacoEnvironment
 		});
-		this.onModuleLoaded.then(null, () => this._onError('Worker failed to load ' + moduleId));
+		this.onModuleLoaded.then(null, (e) => this._onError('Worker failed to load ' + moduleId, e));
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
@@ -172,7 +172,7 @@ export class WorkerClient {
 		return promise;
 	}
 
-	private _enqueueMessage(msg:protocol.IClientMessage): void {
+	private _enqueueMessage(msg:workerProtocol.IClientMessage): void {
 
 		let lastIndexSmallerOrEqual = -1,
 			i:number;
@@ -232,13 +232,13 @@ export class WorkerClient {
 	}
 
 	private _postMessage(msg:any): void {
-		this._worker.postMessage(marshalling.stringify(msg));
+		this._worker.postMessage(stringify(msg));
 	}
 
 	private _onSerializedMessage(msg:string): void {
-		let message:protocol.IServerMessage = null;
+		let message:workerProtocol.IServerMessage = null;
 		try {
-			message = marshalling.parse(msg);
+			message = parse(msg);
 		} catch (e) {
 			// nothing
 		}
@@ -247,7 +247,7 @@ export class WorkerClient {
 		}
 	}
 
-	private _onmessage(msg:protocol.IServerMessage): void {
+	private _onmessage(msg:workerProtocol.IServerMessage): void {
 		if (!msg.monacoWorker) {
 			return;
 		}
@@ -256,8 +256,8 @@ export class WorkerClient {
 		}
 
 		switch (msg.type) {
-			case protocol.MessageType.REPLY:
-				let serverReplyMessage = <protocol.IServerReplyMessage>msg;
+			case workerProtocol.MessageType.REPLY:
+				let serverReplyMessage = <workerProtocol.IServerReplyMessage>msg;
 
 				this._waitingForWorkerReply = false;
 				if(this._lastTimerEvent) {
@@ -270,12 +270,12 @@ export class WorkerClient {
 				}
 
 				switch (serverReplyMessage.action) {
-					case protocol.ReplyType.COMPLETE:
+					case workerProtocol.ReplyType.COMPLETE:
 						this._promises[serverReplyMessage.id].complete(serverReplyMessage.payload);
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.ERROR:
+					case workerProtocol.ReplyType.ERROR:
 						this._onError('Main Thread sent to worker the following message:', {
 							type: this._promises[serverReplyMessage.id].type,
 							payload: this._promises[serverReplyMessage.id].payload
@@ -286,14 +286,14 @@ export class WorkerClient {
 						delete this._promises[serverReplyMessage.id];
 						break;
 
-					case protocol.ReplyType.PROGRESS:
+					case workerProtocol.ReplyType.PROGRESS:
 						this._promises[serverReplyMessage.id].progress(serverReplyMessage.payload);
 						break;
 				}
 				break;
 
-			case protocol.MessageType.PRINT:
-				let serverPrintMessage = <protocol.IServerPrintMessage>msg;
+			case workerProtocol.MessageType.PRINT:
+				let serverPrintMessage = <workerProtocol.IServerPrintMessage>msg;
 				this._consoleLog(serverPrintMessage.level, serverPrintMessage.payload);
 				break;
 
@@ -304,11 +304,11 @@ export class WorkerClient {
 		this._processMessagesQueue();
 	}
 
-	private _dispatchRequestFromWorker(msg:protocol.IServerMessage): void {
+	private _dispatchRequestFromWorker(msg:workerProtocol.IServerMessage): void {
 		this._handleWorkerRequest(msg).then((result) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -317,9 +317,9 @@ export class WorkerClient {
 			};
 			this._postMessage(reply);
 		}, (err) => {
-			let reply: protocol.IClientReplyMessage = {
+			let reply: workerProtocol.IClientReplyMessage = {
 				id: 0,
-				type: protocol.MessageType.REPLY,
+				type: workerProtocol.MessageType.REPLY,
 				timestamp: (new Date()).getTime(),
 
 				seq: msg.req,
@@ -330,7 +330,7 @@ export class WorkerClient {
 		});
 	}
 
-	private _handleWorkerRequest(msg:protocol.IServerMessage): TPromise<any> {
+	private _handleWorkerRequest(msg:workerProtocol.IServerMessage): TPromise<any> {
 		if (msg.type === '_proxyObj') {
 			return this._remoteCom.handleMessage(msg.payload);
 		}
@@ -353,19 +353,19 @@ export class WorkerClient {
 
 	_consoleLog(level:string, payload:any): void {
 		switch (level) {
-			case protocol.PrintType.LOG:
+			case workerProtocol.PrintType.LOG:
 				console.log(payload);
 				break;
-			case protocol.PrintType.DEBUG:
+			case workerProtocol.PrintType.DEBUG:
 				console.info(payload);
 				break;
-			case protocol.PrintType.INFO:
+			case workerProtocol.PrintType.INFO:
 				console.info(payload);
 				break;
-			case protocol.PrintType.WARN:
+			case workerProtocol.PrintType.WARN:
 				console.warn(payload);
 				break;
-			case protocol.PrintType.ERROR:
+			case workerProtocol.PrintType.ERROR:
 				console.error(payload);
 				break;
 			default:

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerProtocol.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {IManyHandler, IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import remote = require('vs/base/common/remote');
 
 /**
  * A message sent from the UI thread to a worker
@@ -75,10 +75,10 @@ export interface IRequester {
 	request(requestName: string, payload: any): TPromise<any>;
 }
 
-export class RemoteCom implements remote.IRemoteCom {
+export class RemoteCom implements IRemoteCom {
 
 	private _requester: IRequester;
-	private _bigHandler: remote.IManyHandler;
+	private _bigHandler: IManyHandler;
 
 	constructor(requester:IRequester) {
 		this._requester = requester;
@@ -93,7 +93,7 @@ export class RemoteCom implements remote.IRemoteCom {
 		});
 	}
 
-	public setManyHandler(handler:remote.IManyHandler): void {
+	public setManyHandler(handler:IManyHandler): void {
 		this._bigHandler = handler;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/worker/workerServer.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {setUnexpectedErrorHandler, transformErrorForSerialization} from 'vs/base/common/errors';
+import {parse, stringify} from 'vs/base/common/marshalling';
+import {IRemoteCom} from 'vs/base/common/remote';
 import {TPromise} from 'vs/base/common/winjs.base';
-import protocol = require('vs/base/common/worker/workerProtocol');
-import errors = require('vs/base/common/errors');
-import remote = require('vs/base/common/remote');
-import marshalling = require('vs/base/common/marshalling');
+import * as workerProtocol from 'vs/base/common/worker/workerProtocol';
 
 interface IReplyCallbacks {
 	c: (value:any)=>void;
@@ -23,7 +23,7 @@ export class WorkerServer {
 	private _requestHandler:any;
 	private _lastReq: number;
 	private _awaitedReplies: { [req:string]: IReplyCallbacks; };
-	private _remoteCom: protocol.RemoteCom;
+	private _remoteCom: workerProtocol.RemoteCom;
 
 	constructor(postSerializedMessage:(msg:string)=>void) {
 		this._postSerializedMessage = postSerializedMessage;
@@ -33,48 +33,48 @@ export class WorkerServer {
 		this._awaitedReplies = {};
 		this._bindConsole();
 
-		this._remoteCom = new protocol.RemoteCom(this);
+		this._remoteCom = new workerProtocol.RemoteCom(this);
 	}
 
-	public getRemoteCom(): remote.IRemoteCom {
+	public getRemoteCom(): IRemoteCom {
 		return this._remoteCom;
 	}
 
 	private _bindConsole(): void {
 		(<any> self).console = {
-			log: this._sendPrintMessage.bind(this, protocol.PrintType.LOG),
-			debug: this._sendPrintMessage.bind(this, protocol.PrintType.DEBUG),
-			info: this._sendPrintMessage.bind(this, protocol.PrintType.INFO),
-			warn: this._sendPrintMessage.bind(this, protocol.PrintType.WARN),
-			error: this._sendPrintMessage.bind(this, protocol.PrintType.ERROR)
+			log: this._sendPrintMessage.bind(this, workerProtocol.PrintType.LOG),
+			debug: this._sendPrintMessage.bind(this, workerProtocol.PrintType.DEBUG),
+			info: this._sendPrintMessage.bind(this, workerProtocol.PrintType.INFO),
+			warn: this._sendPrintMessage.bind(this, workerProtocol.PrintType.WARN),
+			error: this._sendPrintMessage.bind(this, workerProtocol.PrintType.ERROR)
 		};
-		errors.setUnexpectedErrorHandler((e) => {
+		setUnexpectedErrorHandler((e) => {
 			self.console.error(e);
 		});
 	}
 
 	private _sendPrintMessage(level:string, ...objects:any[]): void {
-		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? errors.transformErrorForSerialization(obj) : obj);
-		var msg:protocol.IServerPrintMessage = {
+		var transformedObjects = objects.map((obj) => (obj instanceof Error) ? transformErrorForSerialization(obj) : obj);
+		var msg:workerProtocol.IServerPrintMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
-			type: protocol.MessageType.PRINT,
+			type: workerProtocol.MessageType.PRINT,
 			level: level,
 			payload: (transformedObjects.length === 1 ? transformedObjects[0] : transformedObjects)
 		};
 		this._postMessage(msg);
 	}
 
 	private _sendReply(msgId:number, action:string, payload:any): void {
-		var msg:protocol.IServerReplyMessage = {
+		var msg:workerProtocol.IServerReplyMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: '0',
 			id: msgId,
-			type: protocol.MessageType.REPLY,
+			type: workerProtocol.MessageType.REPLY,
 			action: action,
-			payload: (payload instanceof Error) ? errors.transformErrorForSerialization(payload) : payload
+			payload: (payload instanceof Error) ? transformErrorForSerialization(payload) : payload
 		};
 		this._postMessage(msg);
 	}
@@ -86,7 +86,7 @@ export class WorkerServer {
 
 		var req = String(++this._lastReq);
 
-		var msg:protocol.IServerMessage = {
+		var msg:workerProtocol.IServerMessage = {
 			monacoWorker: true,
 			from: this._workerId,
 			req: req,
@@ -120,19 +120,19 @@ export class WorkerServer {
 	}
 
 	public onmessage(msg:string): void {
-		this._onmessage(marshalling.parse(msg));
+		this._onmessage(parse(msg));
 	}
 
-	private _postMessage(msg:protocol.IServerMessage): void {
-		this._postSerializedMessage(marshalling.stringify(msg));
+	private _postMessage(msg:workerProtocol.IServerMessage): void {
+		this._postSerializedMessage(stringify(msg));
 	}
 
-	private _onmessage(msg:protocol.IClientMessage): void {
+	private _onmessage(msg:workerProtocol.IClientMessage): void {
 
-		if (msg.type === protocol.MessageType.REPLY) {
+		if (msg.type === workerProtocol.MessageType.REPLY) {
 			// this message is a reply to a request we've made to the main thread previously
 
-			var typedMsg = <protocol.IClientReplyMessage>msg;
+			var typedMsg = <workerProtocol.IClientReplyMessage>msg;
 
 			if (!typedMsg.seq || !this._awaitedReplies.hasOwnProperty(typedMsg.seq)) {
 				console.error('Worker received unexpected reply from main thread', msg);
@@ -151,12 +151,12 @@ export class WorkerServer {
 			return;
 		}
 
-		var c = this._sendReply.bind(this, msg.id, protocol.ReplyType.COMPLETE);
-		var e = this._sendReply.bind(this, msg.id, protocol.ReplyType.ERROR);
-		var p = this._sendReply.bind(this, msg.id, protocol.ReplyType.PROGRESS);
+		var c = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.COMPLETE);
+		var e = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.ERROR);
+		var p = this._sendReply.bind(this, msg.id, workerProtocol.ReplyType.PROGRESS);
 
 		switch(msg.type) {
-			case protocol.MessageType.INITIALIZE:
+			case workerProtocol.MessageType.INITIALIZE:
 				this._workerId = msg.payload.id;
 
 				var loaderConfig = msg.payload.loaderConfiguration;
@@ -201,7 +201,7 @@ export class WorkerServer {
 		}
 	}
 
-	private _handleMessage(msg:protocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
+	private _handleMessage(msg:workerProtocol.IClientMessage, c:(value:any)=>void, e:(err:any)=>void, p:(progress:any)=>void): void {
 
 		if (msg.type === '_proxyObj') {
 			this._remoteCom.handleMessage(msg.payload).then(c, e, p);
@@ -218,7 +218,7 @@ export class WorkerServer {
 			try {
 				this._requestHandler[msg.type].call(this._requestHandler, this, c, e, p, msg.payload);
 			} catch (handlerError) {
-				e(errors.transformErrorForSerialization(handlerError));
+				e(transformErrorForSerialization(handlerError));
 			}
 			// var what = msg.type;
 			// console.info(what + ' took ' + ((new Date().getTime())-now));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/node/request.ts
code:
@@ -76,8 +76,8 @@ export function request(options: IRequestOptions): TPromise<IRequestResult> {
 	() => req && req.abort());
 }
 
-export function download(filePath: string, opts: IRequestOptions): Promise {
-	return request(assign(opts, { followRedirects: 3 })).then(pair => new Promise((c, e) => {
+export function download(filePath: string, opts: IRequestOptions): TPromise<void> {
+	return request(assign(opts, { followRedirects: 3 })).then(pair => new TPromise<void>((c, e) => {
 		let out = createWriteStream(filePath);
 
 		out.once('finish', () => c(null));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/tree.ts
code:
@@ -435,9 +435,9 @@ export /* abstract */ class ContextMenuEvent {
 
 export class MouseContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Mouse.StandardMouseEvent;
+	private originalEvent: Mouse.IMouseEvent;
 
-	constructor(originalEvent: Mouse.StandardMouseEvent) {
+	constructor(originalEvent: Mouse.IMouseEvent) {
 		super(originalEvent.posx, originalEvent.posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -453,9 +453,9 @@ export class MouseContextMenuEvent extends ContextMenuEvent {
 
 export class KeyboardContextMenuEvent extends ContextMenuEvent {
 
-	private originalEvent: Keyboard.StandardKeyboardEvent;
+	private originalEvent: Keyboard.IKeyboardEvent;
 
-	constructor(posx: number, posy: number, originalEvent: Keyboard.StandardKeyboardEvent) {
+	constructor(posx: number, posy: number, originalEvent: Keyboard.IKeyboardEvent) {
 		super(posx, posy, originalEvent.target);
 		this.originalEvent = originalEvent;
 	}
@@ -474,7 +474,7 @@ export interface IController {
 	/**
 	 * Called when an element is clicked.
 	 */
-	onClick(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onClick(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when an element is requested for a context menu.
@@ -489,22 +489,22 @@ export interface IController {
 	/**
 	 * Called when a key is pressed down while selecting elements.
 	 */
-	onKeyDown(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyDown(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a key is released while selecting elements.
 	 */
-	onKeyUp(tree: ITree, event: Keyboard.StandardKeyboardEvent): boolean;
+	onKeyUp(tree: ITree, event: Keyboard.IKeyboardEvent): boolean;
 
 	/**
 	 * Called when a mouse button is pressed down on an element.
 	 */
-	onMouseDown?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseDown?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 
 	/**
 	 * Called when a mouse button goes up on an element.
 	 */
-	onMouseUp?(tree: ITree, element: any, event: Mouse.StandardMouseEvent): boolean;
+	onMouseUp?(tree: ITree, element: any, event: Mouse.IMouseEvent): boolean;
 }
 
 export enum DragOverEffect {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/parts/tree/browser/treeDefaults.ts
code:
@@ -9,7 +9,7 @@ import touch = require('vs/base/browser/touch');
 import errors = require('vs/base/common/errors');
 import dom = require('vs/base/browser/dom');
 import mouse = require('vs/base/browser/mouseEvent');
-import keyboard = require('vs/base/browser/keyboardEvent');
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import _ = require('vs/base/parts/tree/browser/tree');
 import {CommonKeybindings} from 'vs/base/common/keyCodes';
 
@@ -58,7 +58,7 @@ export class LegacyRenderer implements _.IRenderer {
 }
 
 export interface IKeyBindingCallback {
-	(tree:_.ITree, event:keyboard.StandardKeyboardEvent):void;
+	(tree:_.ITree, event:IKeyboardEvent):void;
 }
 
 export interface ICancelableEvent {
@@ -140,7 +140,7 @@ export class DefaultController implements _.IController {
 		this.upKeyBindingDispatcher.set(CommonKeybindings.CTRLCMD_ENTER, this.onEnter.bind(this));
 	}
 
-	public onMouseDown(tree:_.ITree, element: any, event:mouse.StandardMouseEvent, origin: string = 'mouse'):boolean {
+	public onMouseDown(tree:_.ITree, element: any, event:mouse.IMouseEvent, origin: string = 'mouse'):boolean {
 		if (this.options.clickBehavior === ClickBehavior.ON_MOUSE_DOWN && event.leftButton) {
 			if (event.target) {
 				if (event.target.tagName && event.target.tagName.toLowerCase() === 'input') {
@@ -159,7 +159,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	public onClick(tree:_.ITree, element: any, event:mouse.StandardMouseEvent):boolean {
+	public onClick(tree:_.ITree, element: any, event:mouse.IMouseEvent):boolean {
 		var isMac = platform.isMacintosh;
 
 		// A Ctrl click on the Mac is a context menu event
@@ -191,7 +191,7 @@ export class DefaultController implements _.IController {
 			tree.clearFocus(payload);
 			tree.clearSelection(payload);
 		} else {
-			var isMouseDown = eventish && (<mouse.StandardMouseEvent>eventish).browserEvent && (<mouse.StandardMouseEvent>eventish).browserEvent.type === 'mousedown';
+			var isMouseDown = eventish && (<mouse.IMouseEvent>eventish).browserEvent && (<mouse.IMouseEvent>eventish).browserEvent.type === 'mousedown';
 			if (!isMouseDown) {
 				eventish.preventDefault(); // we cannot preventDefault onMouseDown because this would break DND otherwise
 			}
@@ -235,15 +235,15 @@ export class DefaultController implements _.IController {
 		return this.onLeftClick(tree, element, event, 'touch');
 	}
 
-	public onKeyDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.downKeyBindingDispatcher, tree, event);
 	}
 
-	public onKeyUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	public onKeyUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		return this.onKey(this.upKeyBindingDispatcher, tree, event);
 	}
 
-	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	private onKey(bindings:KeybindingDispatcher, tree:_.ITree, event:IKeyboardEvent):boolean {
 		var handler = bindings.dispatch(event.asKeybinding());
 		if (handler) {
 			if (handler(tree, event)) {
@@ -255,7 +255,7 @@ export class DefaultController implements _.IController {
 		return false;
 	}
 
-	protected onUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -267,7 +267,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageUp(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageUp(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -279,7 +279,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -291,7 +291,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onPageDown(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onPageDown(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -303,7 +303,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onLeft(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onLeft(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -319,7 +319,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onRight(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onRight(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -331,7 +331,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEnter(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEnter(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {
@@ -344,7 +344,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onSpace(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onSpace(tree:_.ITree, event:IKeyboardEvent):boolean {
 		if (tree.getHighlight()) {
 			return false;
 		}
@@ -355,7 +355,7 @@ export class DefaultController implements _.IController {
 		return true;
 	}
 
-	protected onEscape(tree:_.ITree, event:keyboard.StandardKeyboardEvent):boolean {
+	protected onEscape(tree:_.ITree, event:IKeyboardEvent):boolean {
 		var payload = { origin: 'keyboard', originalEvent: event };
 
 		if (tree.getHighlight()) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/network.test.ts
code:
@@ -6,21 +6,8 @@
 
 import * as assert from 'assert';
 import URI from 'vs/base/common/uri';
-import { URL, ParsedUrl } from 'vs/base/common/network';
 
 function assertUrl(raw:string, scheme:string, domain:string, port:string, path:string, queryString:string, fragmentId:string): void {
-	var url = new ParsedUrl(raw);
-	assert.equal(url.getScheme(), scheme, 'getScheme ok for ' + raw);
-	var protocol = scheme ? scheme + ':' : scheme;
-	assert.equal(url.getProtocol(), protocol, 'getProtocol ok for ' + raw);
-	assert.equal(url.getDomain(), domain, 'getDomain ok for ' + raw);
-	assert.equal(url.getPort(), port, 'getPort ok for ' + raw);
-	var host = domain + (port ? ':' + port : '');
-	assert.equal(url.getHost(), host, 'getHost ok for ' + raw);
-	assert.equal(url.getPath(), path, 'getPath ok for ' + raw);
-	assert.equal(url.getQueryString(), queryString, 'getQueryString ok for ' + raw);
-	assert.equal(url.getFragmentId(), fragmentId, 'getFragmentId ok for ' + raw);
-
 	// check for equivalent behaviour
 	var uri = URI.parse(raw);
 	assert.equal(uri.scheme, scheme);
@@ -30,12 +17,6 @@ function assertUrl(raw:string, scheme:string, domain:string, port:string, path:s
 	assert.equal(uri.fragment, fragmentId);
 }
 
-function assertCombine(base:string, relativeUrl:string, expectedUrl:string): void {
-	var url = new ParsedUrl(base);
-	var result = url.combine(relativeUrl);
-	assert.equal(result, expectedUrl, 'combine ok for ' + base + ' and ' + relativeUrl);
-}
-
 suite('Network', () => {
 	test('urls', () => {
 		assertUrl('http://www.test.com:8000/this/that/theother.html?query=foo#hash',
@@ -107,114 +88,5 @@ suite('Network', () => {
 		);
 
 		assertUrl('file:///c/far/boo/file.cs', 'file', '', '', '/c/far/boo/file.cs', '', '');
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '/test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '////test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?token=123',
-			'http://www.test.com:8000/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js?query=foo#hash',
-			'http://www.test.com:8000/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '\\test.js#hash',
-			'http://www.test.com:8000/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '../test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js',
-			'http://www.test.com:8000/this/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?token=123',
-			'http://www.test.com:8000/this/test.js?token=123'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js?query=foo#hash',
-			'http://www.test.com:8000/this/test.js?query=foo#hash'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/theother.html?query=foo#hash', '..\\test.js#hash',
-			'http://www.test.com:8000/this/test.js#hash'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/this/that/', 'test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/this/that/', './test.js',
-			'http://www.test.com:8000/this/that/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000/', './test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000/', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-
-		assertCombine(
-			'http://www.test.com:8000', './././test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com:8000', 'test.js',
-			'http://www.test.com:8000/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', '../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/a/b', 'a/b/../../../../../test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'test.js',
-			'http://www.test.com/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', 'a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-		assertCombine(
-			'http://www.test.com/index.html', './a/b/test.js',
-			'http://www.test.com/a/b/test.js'
-		);
-
-		var url = new URL('inmemory://model/1#css');
-		assert.equal(url.toUnique(), 'inmemory://model/1');
 	});
-
 });

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/test/common/strings.test.ts
code:
@@ -21,26 +21,15 @@ suite('Strings', () => {
 		assert(strings.equalsIgnoreCase('L', 'l'));
 	});
 
-	test('isNullOrWhitespace', function() {
-		assert(strings.isFalsyOrWhitespace(null));
-		assert(strings.isFalsyOrWhitespace(undefined));
-		assert(strings.isFalsyOrWhitespace(''));
-		assert(strings.isFalsyOrWhitespace(""));
-		assert(strings.isFalsyOrWhitespace(' '));
-		assert(strings.isFalsyOrWhitespace('\t'));
-		assert(strings.isFalsyOrWhitespace('\n'));
-		assert(strings.isFalsyOrWhitespace(' \t\n'));
-	});
-
-	test("format", function () {
-		assert.strictEqual(strings.format("Foo Bar"), "Foo Bar");
-		assert.strictEqual(strings.format("Foo {0} Bar"), "Foo {0} Bar");
-		assert.strictEqual(strings.format("Foo {0} Bar", "yes"), "Foo yes Bar");
-		assert.strictEqual(strings.format("Foo {0} Bar {0}", "yes"), "Foo yes Bar yes");
-		assert.strictEqual(strings.format("Foo {0} Bar {1}{2}", "yes"), "Foo yes Bar {1}{2}");
-		assert.strictEqual(strings.format("Foo {0} Bar {1}{2}", "yes", undefined), "Foo yes Bar undefined{2}");
-		assert.strictEqual(strings.format("Foo {0} Bar {1}{2}", "yes", 5, false), "Foo yes Bar 5false");
-		assert.strictEqual(strings.format("Foo {0} Bar. {1}", "(foo)", ".test"), "Foo (foo) Bar. .test");
+	test('format', function () {
+		assert.strictEqual(strings.format('Foo Bar'), 'Foo Bar');
+		assert.strictEqual(strings.format('Foo {0} Bar'), 'Foo {0} Bar');
+		assert.strictEqual(strings.format('Foo {0} Bar', 'yes'), 'Foo yes Bar');
+		assert.strictEqual(strings.format('Foo {0} Bar {0}', 'yes'), 'Foo yes Bar yes');
+		assert.strictEqual(strings.format('Foo {0} Bar {1}{2}', 'yes'), 'Foo yes Bar {1}{2}');
+		assert.strictEqual(strings.format('Foo {0} Bar {1}{2}', 'yes', undefined), 'Foo yes Bar undefined{2}');
+		assert.strictEqual(strings.format('Foo {0} Bar {1}{2}', 'yes', 5, false), 'Foo yes Bar 5false');
+		assert.strictEqual(strings.format('Foo {0} Bar. {1}', '(foo)', '.test'), 'Foo (foo) Bar. .test');
 	});
 
 	test('computeLineStarts', function () {
@@ -66,87 +55,87 @@ suite('Strings', () => {
 	});
 
 
-	test("pad", function () {
-		assert.strictEqual(strings.pad(1, 0), "1");
-		assert.strictEqual(strings.pad(1, 1), "1");
-		assert.strictEqual(strings.pad(1, 2), "01");
-		assert.strictEqual(strings.pad(0, 2), "00");
+	test('pad', function () {
+		assert.strictEqual(strings.pad(1, 0), '1');
+		assert.strictEqual(strings.pad(1, 1), '1');
+		assert.strictEqual(strings.pad(1, 2), '01');
+		assert.strictEqual(strings.pad(0, 2), '00');
 	});
 
-	test("escape", function () {
-		assert.strictEqual(strings.escape(""), "");
-		assert.strictEqual(strings.escape("foo"), "foo");
-		assert.strictEqual(strings.escape("foo bar"), "foo bar");
-		assert.strictEqual(strings.escape("<foo bar>"), "&lt;foo bar&gt;");
-		assert.strictEqual(strings.escape("<foo>Hello</foo>"), "&lt;foo&gt;Hello&lt;/foo&gt;");
+	test('escape', function () {
+		assert.strictEqual(strings.escape(''), '');
+		assert.strictEqual(strings.escape('foo'), 'foo');
+		assert.strictEqual(strings.escape('foo bar'), 'foo bar');
+		assert.strictEqual(strings.escape('<foo bar>'), '&lt;foo bar&gt;');
+		assert.strictEqual(strings.escape('<foo>Hello</foo>'), '&lt;foo&gt;Hello&lt;/foo&gt;');
 	});
 
-	test("startsWith", function () {
-		assert(strings.startsWith("foo", "f"));
-		assert(strings.startsWith("foo", "fo"));
-		assert(strings.startsWith("foo", "foo"));
-		assert(!strings.startsWith("foo", "o"));
-		assert(!strings.startsWith("", "f"));
-		assert(strings.startsWith("foo", ""));
-		assert(strings.startsWith("", ""));
+	test('startsWith', function () {
+		assert(strings.startsWith('foo', 'f'));
+		assert(strings.startsWith('foo', 'fo'));
+		assert(strings.startsWith('foo', 'foo'));
+		assert(!strings.startsWith('foo', 'o'));
+		assert(!strings.startsWith('', 'f'));
+		assert(strings.startsWith('foo', ''));
+		assert(strings.startsWith('', ''));
 	});
 
-	test("endsWith", function () {
-		assert(strings.endsWith("foo", "o"));
-		assert(strings.endsWith("foo", "oo"));
-		assert(strings.endsWith("foo", "foo"));
-		assert(strings.endsWith("foo bar foo", "foo"));
-		assert(!strings.endsWith("foo", "f"));
-		assert(!strings.endsWith("", "f"));
-		assert(strings.endsWith("foo", ""));
-		assert(strings.endsWith("", ""));
-		assert(strings.endsWith("/", "/"));
+	test('endsWith', function () {
+		assert(strings.endsWith('foo', 'o'));
+		assert(strings.endsWith('foo', 'oo'));
+		assert(strings.endsWith('foo', 'foo'));
+		assert(strings.endsWith('foo bar foo', 'foo'));
+		assert(!strings.endsWith('foo', 'f'));
+		assert(!strings.endsWith('', 'f'));
+		assert(strings.endsWith('foo', ''));
+		assert(strings.endsWith('', ''));
+		assert(strings.endsWith('/', '/'));
 	});
 
-	test("ltrim", function () {
-		assert.strictEqual(strings.ltrim("foo", "f"), "oo");
-		assert.strictEqual(strings.ltrim("foo", "o"), "foo");
-		assert.strictEqual(strings.ltrim("http://www.test.de", "http://"), "www.test.de");
-		assert.strictEqual(strings.ltrim("/foo/", "/"), "foo/");
-		assert.strictEqual(strings.ltrim("//foo/", "/"), "foo/");
-		assert.strictEqual(strings.ltrim("/", ""), "/");
-		assert.strictEqual(strings.ltrim("/", "/"), "");
-		assert.strictEqual(strings.ltrim("///", "/"), "");
-		assert.strictEqual(strings.ltrim("", ""), "");
-		assert.strictEqual(strings.ltrim("", "/"), "");
+	test('ltrim', function () {
+		assert.strictEqual(strings.ltrim('foo', 'f'), 'oo');
+		assert.strictEqual(strings.ltrim('foo', 'o'), 'foo');
+		assert.strictEqual(strings.ltrim('http://www.test.de', 'http://'), 'www.test.de');
+		assert.strictEqual(strings.ltrim('/foo/', '/'), 'foo/');
+		assert.strictEqual(strings.ltrim('//foo/', '/'), 'foo/');
+		assert.strictEqual(strings.ltrim('/', ''), '/');
+		assert.strictEqual(strings.ltrim('/', '/'), '');
+		assert.strictEqual(strings.ltrim('///', '/'), '');
+		assert.strictEqual(strings.ltrim('', ''), '');
+		assert.strictEqual(strings.ltrim('', '/'), '');
 	});
 
-	test("rtrim", function () {
-		assert.strictEqual(strings.rtrim("foo", "o"), "f");
-		assert.strictEqual(strings.rtrim("foo", "f"), "foo");
-		assert.strictEqual(strings.rtrim("http://www.test.de", ".de"), "http://www.test");
-		assert.strictEqual(strings.rtrim("/foo/", "/"), "/foo");
-		assert.strictEqual(strings.rtrim("/foo//", "/"), "/foo");
-		assert.strictEqual(strings.rtrim("/", ""), "/");
-		assert.strictEqual(strings.rtrim("/", "/"), "");
-		assert.strictEqual(strings.rtrim("///", "/"), "");
-		assert.strictEqual(strings.rtrim("", ""), "");
-		assert.strictEqual(strings.rtrim("", "/"), "");
+	test('rtrim', function () {
+		assert.strictEqual(strings.rtrim('foo', 'o'), 'f');
+		assert.strictEqual(strings.rtrim('foo', 'f'), 'foo');
+		assert.strictEqual(strings.rtrim('http://www.test.de', '.de'), 'http://www.test');
+		assert.strictEqual(strings.rtrim('/foo/', '/'), '/foo');
+		assert.strictEqual(strings.rtrim('/foo//', '/'), '/foo');
+		assert.strictEqual(strings.rtrim('/', ''), '/');
+		assert.strictEqual(strings.rtrim('/', '/'), '');
+		assert.strictEqual(strings.rtrim('///', '/'), '');
+		assert.strictEqual(strings.rtrim('', ''), '');
+		assert.strictEqual(strings.rtrim('', '/'), '');
 	});
 
-	test("trim", function () {
-		assert.strictEqual(strings.trim(" foo "), "foo");
-		assert.strictEqual(strings.trim("  foo"), "foo");
-		assert.strictEqual(strings.trim("bar  "), "bar");
-		assert.strictEqual(strings.trim("   "), "");
-		assert.strictEqual(strings.trim("foo bar", "bar"), "foo ");
+	test('trim', function () {
+		assert.strictEqual(strings.trim(' foo '), 'foo');
+		assert.strictEqual(strings.trim('  foo'), 'foo');
+		assert.strictEqual(strings.trim('bar  '), 'bar');
+		assert.strictEqual(strings.trim('   '), '');
+		assert.strictEqual(strings.trim('foo bar', 'bar'), 'foo ');
 	});
 
-	test("trimWhitespace", function () {
-		assert.strictEqual(" foo ".trim(), "foo");
-		assert.strictEqual("	 foo	".trim(), "foo");
-		assert.strictEqual("  foo".trim(), "foo");
-		assert.strictEqual("bar  ".trim(), "bar");
-		assert.strictEqual("   ".trim(), "");
-		assert.strictEqual(" 	  ".trim(), "");
+	test('trimWhitespace', function () {
+		assert.strictEqual(' foo '.trim(), 'foo');
+		assert.strictEqual('	 foo	'.trim(), 'foo');
+		assert.strictEqual('  foo'.trim(), 'foo');
+		assert.strictEqual('bar  '.trim(), 'bar');
+		assert.strictEqual('   '.trim(), '');
+		assert.strictEqual(' 	  '.trim(), '');
 	});
 
-	test("localeCompare", function() {
+	test('localeCompare', function() {
 		assert.strictEqual(strings.localeCompare('a', 'a'), 'a'.localeCompare('a'));
 		assert.strictEqual(strings.localeCompare('A', 'A'), 'A'.localeCompare('A'));
 		assert.strictEqual(strings.localeCompare('All', 'A'), 'All'.localeCompare('A'));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/worker/defaultWorkerFactory.ts
code:
@@ -4,15 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import dom = require('vs/base/browser/dom');
-import lifecycle = require('vs/base/common/lifecycle');
-import env = require('vs/base/common/flags');
+import * as flags from 'vs/base/common/flags';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
 import {IWorker, IWorkerCallback, IWorkerFactory} from 'vs/base/common/worker/workerClient';
+import * as dom from 'vs/base/browser/dom';
 
 function defaultGetWorkerUrl(workerId:string, label:string): string {
 	return require.toUrl('./' + workerId + '?' + encodeURIComponent(label));
 }
-var getWorkerUrl = env.getCrossOriginWorkerScriptUrl || defaultGetWorkerUrl;
+var getWorkerUrl = flags.getCrossOriginWorkerScriptUrl || defaultGetWorkerUrl;
 
 
 /**
@@ -60,7 +60,7 @@ class FrameWorker implements IWorker {
 	private loaded: boolean;
 	private beforeLoadMessages: any[];
 
-	private _listeners: lifecycle.IDisposable[];
+	private _listeners: IDisposable[];
 
 	constructor(moduleId:string, id: number, onMessageCallback:IWorkerCallback) {
 		this.id = id;
@@ -87,7 +87,7 @@ class FrameWorker implements IWorker {
 	}
 
 	public dispose(): void {
-		this._listeners = lifecycle.disposeAll(this._listeners);
+		this._listeners = disposeAll(this._listeners);
 		window.removeEventListener('message', this.onMessage);
 		window.frames[this.iframeId()].close();
 	}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/config/configuration.ts
code:
@@ -4,14 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as Env from 'vs/base/common/platform';
-import * as Browser from 'vs/base/browser/browser';
-import * as DomUtils from 'vs/base/browser/dom';
-import {IEditorStyling, IGuessedIndentation, IDimension} from 'vs/editor/common/editorCommon';
-import {ElementSizeObserver} from 'vs/editor/browser/config/elementSizeObserver';
-import {CommonEditorConfiguration, ICSSConfig} from 'vs/editor/common/config/commonEditorConfig';
 import Event, {Emitter} from 'vs/base/common/event';
 import {Disposable} from 'vs/base/common/lifecycle';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
+import {CommonEditorConfiguration, ICSSConfig} from 'vs/editor/common/config/commonEditorConfig';
+import {IDimension, IEditorStyling, IGuessedIndentation} from 'vs/editor/common/editorCommon';
+import {ElementSizeObserver} from 'vs/editor/browser/config/elementSizeObserver';
 
 class CSSBasedConfigurationCache {
 
@@ -192,7 +192,7 @@ class CSSBasedConfiguration extends Disposable {
 		// Read various properties
 		let usualCharsWidths = this._readFromTestElements();
 		let firstTestElement = document.getElementById(this._testElementId(0));
-		let computedStyle = DomUtils.getComputedStyle(firstTestElement);
+		let computedStyle = dom.getComputedStyle(firstTestElement);
 		let result_font = this._getFontFromComputedStyle(computedStyle);
 		let result_fontSize = computedStyle ? parseInt(computedStyle.fontSize, 10) : 0;
 
@@ -302,15 +302,15 @@ export class Configuration extends CommonEditorConfiguration {
 
 	protected _getEditorClassName(theme:string, fontLigatures:boolean): string {
 		let extra = '';
-		if (Browser.isIE11orEarlier) {
+		if (browser.isIE11orEarlier) {
 			extra += 'ie ';
-		} else if (Browser.isFirefox) {
+		} else if (browser.isFirefox) {
 			extra += 'ff ';
 		}
-		if (Browser.isIE9) {
+		if (browser.isIE9) {
 			extra += 'ie9 ';
 		}
-		if (Env.isMacintosh) {
+		if (platform.isMacintosh) {
 			extra += 'mac ';
 		}
 		if (fontLigatures) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/config/elementSizeObserver.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IDimension} from 'vs/editor/common/editorCommon';
 import {Disposable} from 'vs/base/common/lifecycle';
+import {IDimension} from 'vs/editor/common/editorCommon';
 
 export class ElementSizeObserver extends Disposable {
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/controller/keyboardHandler.ts
code:
@@ -4,18 +4,19 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
-import DomUtils = require('vs/base/browser/dom');
-import Browser = require('vs/base/browser/browser');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import * as Lifecycle from 'vs/base/common/lifecycle';
-import {Range} from 'vs/editor/common/core/range';
 import Event, {Emitter} from 'vs/base/common/event';
-import {TextAreaHandler} from 'vs/editor/common/controller/textAreaHandler';
-import {ITextAreaWrapper, IClipboardEvent, IKeyboardEventWrapper, TextAreaStrategy} from 'vs/editor/common/controller/textAreaState';
-import {GlobalScreenReaderNVDA} from 'vs/editor/common/config/commonEditorConfig';
+import {Disposable, IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {GlobalScreenReaderNVDA} from 'vs/editor/common/config/commonEditorConfig';
+import {TextAreaHandler} from 'vs/editor/common/controller/textAreaHandler';
+import {IClipboardEvent, IKeyboardEventWrapper, ITextAreaWrapper, TextAreaStrategy} from 'vs/editor/common/controller/textAreaState';
+import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
+import {IKeyboardHandlerHelper, IViewContext, IViewController} from 'vs/editor/browser/editorBrowser';
 
 class ClipboardEventWrapper implements IClipboardEvent {
 
@@ -68,9 +69,9 @@ class ClipboardEventWrapper implements IClipboardEvent {
 
 class KeyboardEventWrapper implements IKeyboardEventWrapper {
 
-	public _actual: DomUtils.IKeyboardEvent;
+	public _actual: IKeyboardEvent;
 
-	constructor(actual:DomUtils.IKeyboardEvent) {
+	constructor(actual:IKeyboardEvent) {
 		this._actual = actual;
 	}
 
@@ -90,7 +91,7 @@ class KeyboardEventWrapper implements IKeyboardEventWrapper {
 	}
 }
 
-class TextAreaWrapper extends Lifecycle.Disposable implements ITextAreaWrapper {
+class TextAreaWrapper extends Disposable implements ITextAreaWrapper {
 
 	private _textArea: HTMLTextAreaElement;
 
@@ -125,15 +126,15 @@ class TextAreaWrapper extends Lifecycle.Disposable implements ITextAreaWrapper {
 		super();
 		this._textArea = textArea;
 
-		this._register(DomUtils.addStandardDisposableListener(this._textArea, 'keydown', (e) => this._onKeyDown.fire(new KeyboardEventWrapper(e))));
-		this._register(DomUtils.addStandardDisposableListener(this._textArea, 'keyup', (e) => this._onKeyUp.fire(new KeyboardEventWrapper(e))));
-		this._register(DomUtils.addStandardDisposableListener(this._textArea, 'keypress', (e) => this._onKeyPress.fire(new KeyboardEventWrapper(e))));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'compositionstart', (e) => this._onCompositionStart.fire()));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'compositionend', (e) => this._onCompositionEnd.fire()));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'input', (e) => this._onInput.fire()));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'cut', (e:ClipboardEvent) => this._onCut.fire(new ClipboardEventWrapper(e))));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'copy', (e:ClipboardEvent) => this._onCopy.fire(new ClipboardEventWrapper(e))));
-		this._register(DomUtils.addDisposableListener(this._textArea, 'paste', (e:ClipboardEvent) => this._onPaste.fire(new ClipboardEventWrapper(e))));
+		this._register(dom.addStandardDisposableListener(this._textArea, 'keydown', (e) => this._onKeyDown.fire(new KeyboardEventWrapper(e))));
+		this._register(dom.addStandardDisposableListener(this._textArea, 'keyup', (e) => this._onKeyUp.fire(new KeyboardEventWrapper(e))));
+		this._register(dom.addStandardDisposableListener(this._textArea, 'keypress', (e) => this._onKeyPress.fire(new KeyboardEventWrapper(e))));
+		this._register(dom.addDisposableListener(this._textArea, 'compositionstart', (e) => this._onCompositionStart.fire()));
+		this._register(dom.addDisposableListener(this._textArea, 'compositionend', (e) => this._onCompositionEnd.fire()));
+		this._register(dom.addDisposableListener(this._textArea, 'input', (e) => this._onInput.fire()));
+		this._register(dom.addDisposableListener(this._textArea, 'cut', (e:ClipboardEvent) => this._onCut.fire(new ClipboardEventWrapper(e))));
+		this._register(dom.addDisposableListener(this._textArea, 'copy', (e:ClipboardEvent) => this._onCopy.fire(new ClipboardEventWrapper(e))));
+		this._register(dom.addDisposableListener(this._textArea, 'paste', (e:ClipboardEvent) => this._onPaste.fire(new ClipboardEventWrapper(e))));
 	}
 
 	public get actual(): HTMLTextAreaElement {
@@ -161,10 +162,10 @@ class TextAreaWrapper extends Lifecycle.Disposable implements ITextAreaWrapper {
 	public setSelectionRange(selectionStart:number, selectionEnd:number): void {
 		// console.log('setSelectionRange: ' + selectionStart + ', ' + selectionEnd);
 		try {
-			let scrollState = DomUtils.saveParentsScrollTop(this._textArea);
+			let scrollState = dom.saveParentsScrollTop(this._textArea);
 			this._textArea.focus();
 			this._textArea.setSelectionRange(selectionStart, selectionEnd);
-			DomUtils.restoreParentsScrollTop(this._textArea, scrollState);
+			dom.restoreParentsScrollTop(this._textArea, scrollState);
 		} catch(e) {
 			// Sometimes IE throws when setting selection (e.g. textarea is off-DOM)
 			console.log('an error has been thrown!');
@@ -173,28 +174,28 @@ class TextAreaWrapper extends Lifecycle.Disposable implements ITextAreaWrapper {
 
 	public isInOverwriteMode(): boolean {
 		// In IE, pressing Insert will bring the typing into overwrite mode
-		if (Browser.isIE11orEarlier && document.queryCommandValue('OverWrite')) {
+		if (browser.isIE11orEarlier && document.queryCommandValue('OverWrite')) {
 			return true;
 		}
 		return false;
 	}
 }
 
 
-export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisposable {
+export class KeyboardHandler extends ViewEventHandler implements IDisposable {
 
-	private context:EditorBrowser.IViewContext;
-	private viewController:EditorBrowser.IViewController;
-	private viewHelper:EditorBrowser.IKeyboardHandlerHelper;
+	private context:IViewContext;
+	private viewController:IViewController;
+	private viewHelper:IKeyboardHandlerHelper;
 	private textArea:TextAreaWrapper;
 	private textAreaHandler:TextAreaHandler;
-	private _toDispose:Lifecycle.IDisposable[];
+	private _toDispose:IDisposable[];
 
 	private contentLeft:number;
 	private contentWidth:number;
 	private scrollLeft:number;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IKeyboardHandlerHelper) {
+	constructor(context:IViewContext, viewController:IViewController, viewHelper:IKeyboardHandlerHelper) {
 		super();
 
 		this.context = context;
@@ -206,11 +207,11 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 		this.contentWidth = 0;
 		this.scrollLeft = 0;
 
-		this.textAreaHandler = new TextAreaHandler(Browser, this._getStrategy(), this.textArea, this.context.model);
+		this.textAreaHandler = new TextAreaHandler(browser, this._getStrategy(), this.textArea, this.context.model);
 
 		this._toDispose = [];
-		this._toDispose.push(this.textAreaHandler.onKeyDown((e) => this.viewController.emitKeyDown(<DomUtils.IKeyboardEvent>e._actual)));
-		this._toDispose.push(this.textAreaHandler.onKeyUp((e) => this.viewController.emitKeyUp(<DomUtils.IKeyboardEvent>e._actual)));
+		this._toDispose.push(this.textAreaHandler.onKeyDown((e) => this.viewController.emitKeyDown(<IKeyboardEvent>e._actual)));
+		this._toDispose.push(this.textAreaHandler.onKeyUp((e) => this.viewController.emitKeyUp(<IKeyboardEvent>e._actual)));
 		this._toDispose.push(this.textAreaHandler.onPaste((e) => this.viewController.paste('keyboard', e.text, e.pasteOnNewLine)));
 		this._toDispose.push(this.textAreaHandler.onCut((e) => this.viewController.cut('keyboard')));
 		this._toDispose.push(this.textAreaHandler.onType((e) => {
@@ -224,12 +225,12 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 			let lineNumber = e.showAtLineNumber;
 			let column = e.showAtColumn;
 
-			let revealPositionEvent:EditorCommon.IViewRevealRangeEvent = {
+			let revealPositionEvent:editorCommon.IViewRevealRangeEvent = {
 				range: new Range(lineNumber, column, lineNumber, column),
-				verticalType: EditorCommon.VerticalRevealType.Simple,
+				verticalType: editorCommon.VerticalRevealType.Simple,
 				revealHorizontal: true
 			};
-			this.context.privateViewEventBus.emit(EditorCommon.ViewEventNames.RevealRangeEvent, revealPositionEvent);
+			this.context.privateViewEventBus.emit(editorCommon.ViewEventNames.RevealRangeEvent, revealPositionEvent);
 
 			// Find range pixel position
 			let visibleRange = this.viewHelper.visibleRangeForPositionRelativeToEditor(lineNumber, column);
@@ -239,20 +240,20 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 				StyleMutator.setLeft(this.textArea.actual, this.contentLeft + visibleRange.left - this.scrollLeft);
 			}
 
-			if (Browser.isIE11orEarlier) {
+			if (browser.isIE11orEarlier) {
 				StyleMutator.setWidth(this.textArea.actual, this.contentWidth);
 			}
 
 			// Show the textarea
 			StyleMutator.setHeight(this.textArea.actual, this.context.configuration.editor.lineHeight);
-			DomUtils.addClass(this.viewHelper.viewDomNode, 'ime-input');
+			dom.addClass(this.viewHelper.viewDomNode, 'ime-input');
 		}));
 		this._toDispose.push(this.textAreaHandler.onCompositionEnd((e) => {
 			this.textArea.actual.style.height = '';
 			this.textArea.actual.style.width = '';
 			StyleMutator.setLeft(this.textArea.actual, 0);
 			StyleMutator.setTop(this.textArea.actual, 0);
-			DomUtils.removeClass(this.viewHelper.viewDomNode, 'ime-input');
+			dom.removeClass(this.viewHelper.viewDomNode, 'ime-input');
 		}));
 		this._toDispose.push(GlobalScreenReaderNVDA.onChange((value) => {
 			this.textAreaHandler.setStrategy(this._getStrategy());
@@ -266,7 +267,7 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 		this.context.removeEventHandler(this);
 		this.textAreaHandler.dispose();
 		this.textArea.dispose();
-		this._toDispose = Lifecycle.disposeAll(this._toDispose);
+		this._toDispose = disposeAll(this._toDispose);
 	}
 
 	private _getStrategy(): TextAreaStrategy {
@@ -283,7 +284,7 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 		this.textAreaHandler.writePlaceholderAndSelectTextAreaSync();
 	}
 
-	public onConfigurationChanged(e: EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e: editorCommon.IConfigurationChangedEvent): boolean {
 		// Give textarea same font size & line height as editor, for the IME case (when the textarea is visible)
 		StyleMutator.setFontSize(this.textArea.actual, this.context.configuration.editor.fontSize);
 		StyleMutator.setLineHeight(this.textArea.actual, this.context.configuration.editor.lineHeight);
@@ -293,7 +294,7 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 		return false;
 	}
 
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		this.scrollLeft = e.scrollLeft;
 		return false;
 	}
@@ -303,17 +304,17 @@ export class KeyboardHandler extends ViewEventHandler implements Lifecycle.IDisp
 		return false;
 	}
 
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		this.textAreaHandler.setCursorSelections(e.selection, e.secondarySelections);
 		return false;
 	}
 
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		this.textAreaHandler.setCursorPosition(e.position);
 		return false;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this.contentLeft = layoutInfo.contentLeft;
 		this.contentWidth = layoutInfo.contentWidth;
 		return false;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/controller/mouseHandler.ts
code:
@@ -4,25 +4,25 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Platform = require('vs/base/common/platform');
-import Browser = require('vs/base/browser/browser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Mouse = require('vs/base/browser/mouseEvent');
-import DomUtils = require('vs/base/browser/dom');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import MouseTarget = require('vs/editor/browser/controller/mouseTarget');
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import Lifecycle = require('vs/base/common/lifecycle');
-import GlobalMouseMoveMonitor = require('vs/base/browser/globalMouseMoveMonitor');
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as platform from 'vs/base/common/platform';
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
+import {GlobalMouseMoveMonitor} from 'vs/base/browser/globalMouseMoveMonitor';
+import {IMouseEvent, StandardMouseEvent} from 'vs/base/browser/mouseEvent';
 import {Position} from 'vs/editor/common/core/position';
 import {Selection} from 'vs/editor/common/core/selection';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
+import {IDomNodePosition, MouseTargetFactory} from 'vs/editor/browser/controller/mouseTarget';
+import * as editorBrowser from 'vs/editor/browser/editorBrowser';
 
 /**
  * Merges mouse events when mouse move events are throttled
  */
-function createMouseMoveEventMerger(mouseTargetFactory:MouseTarget.MouseTargetFactory) {
-	return function(lastEvent:Mouse.StandardMouseEvent, currentEvent:MouseEvent): Mouse.StandardMouseEvent {
-		var r = new Mouse.StandardMouseEvent(currentEvent);
+function createMouseMoveEventMerger(mouseTargetFactory:MouseTargetFactory) {
+	return function(lastEvent:IMouseEvent, currentEvent:MouseEvent): IMouseEvent {
+		var r = new StandardMouseEvent(currentEvent);
 		var targetIsWidget = false;
 		if (mouseTargetFactory) {
 			targetIsWidget = mouseTargetFactory.mouseTargetIsWidget(r);
@@ -84,25 +84,25 @@ class EventGateKeeper<T> {
 	}
 }
 
-export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposable {
+export class MouseHandler extends ViewEventHandler implements IDisposable {
 
 	static CLEAR_MOUSE_DOWN_COUNT_TIME = 400; // ms
 	static MOUSE_MOVE_MINIMUM_TIME = 100; // ms
 
-	public context:EditorBrowser.IViewContext;
-	public viewController:EditorBrowser.IViewController;
-	public viewHelper:EditorBrowser.IPointerHandlerHelper;
-	public mouseTargetFactory: MouseTarget.MouseTargetFactory;
-	public listenersToRemove:Lifecycle.IDisposable[];
-	private toDispose:Lifecycle.IDisposable[];
+	public context:editorBrowser.IViewContext;
+	public viewController:editorBrowser.IViewController;
+	public viewHelper:editorBrowser.IPointerHandlerHelper;
+	public mouseTargetFactory: MouseTargetFactory;
+	public listenersToRemove:IDisposable[];
+	private toDispose:IDisposable[];
 
 	private hideTextAreaTimeout: number;
 
-	private mouseMoveMonitor:GlobalMouseMoveMonitor.GlobalMouseMoveMonitor<Mouse.StandardMouseEvent>;
-	private monitoringStartTargetType: EditorCommon.MouseTargetType;
-	private currentSelection: EditorCommon.IEditorSelection;
-	private lastMouseEvent: Mouse.StandardMouseEvent;
-	private lastMouseDownPosition: EditorCommon.IEditorPosition;
+	private mouseMoveMonitor:GlobalMouseMoveMonitor<IMouseEvent>;
+	private monitoringStartTargetType: editorCommon.MouseTargetType;
+	private currentSelection: editorCommon.IEditorSelection;
+	private lastMouseEvent: IMouseEvent;
+	private lastMouseDownPosition: editorCommon.IEditorPosition;
 	private lastMouseDownPositionEqualCount: number;
 	private lastMouseDownCount: number;
 	private lastSetMouseDownCountTime: number;
@@ -113,22 +113,22 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 
 	private lastMouseLeaveTime:number;
 
-	private _mouseMoveEventHandler: EventGateKeeper<Mouse.StandardMouseEvent>;
-	private _mouseDownThenMoveEventHandler: EventGateKeeper<Mouse.StandardMouseEvent>;
+	private _mouseMoveEventHandler: EventGateKeeper<IMouseEvent>;
+	private _mouseDownThenMoveEventHandler: EventGateKeeper<IMouseEvent>;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:editorBrowser.IViewContext, viewController:editorBrowser.IViewController, viewHelper:editorBrowser.IPointerHandlerHelper) {
 		super();
 
 		this.context = context;
 		this.viewController = viewController;
 		this.viewHelper = viewHelper;
-		this.mouseTargetFactory = new MouseTarget.MouseTargetFactory(this.context, viewHelper);
+		this.mouseTargetFactory = new MouseTargetFactory(this.context, viewHelper);
 		this.listenersToRemove = [];
 
 		this.hideTextAreaTimeout = -1;
 
 		this.toDispose = [];
-		this.mouseMoveMonitor = new GlobalMouseMoveMonitor.GlobalMouseMoveMonitor<Mouse.StandardMouseEvent>();
+		this.mouseMoveMonitor = new GlobalMouseMoveMonitor<IMouseEvent>();
 		this.toDispose.push(this.mouseMoveMonitor);
 
 		this.lastMouseEvent = null;
@@ -144,25 +144,25 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 
 		this.lastMouseLeaveTime = -1;
 
-		this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.viewDomNode, 'contextmenu',
+		this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.viewDomNode, 'contextmenu',
 			(e: MouseEvent) => this._onContextMenu(e)));
 
-		this._mouseMoveEventHandler = new EventGateKeeper<Mouse.StandardMouseEvent>((e) => this._onMouseMove(e), () => !this.viewHelper.isDirty());
+		this._mouseMoveEventHandler = new EventGateKeeper<IMouseEvent>((e) => this._onMouseMove(e), () => !this.viewHelper.isDirty());
 		this.toDispose.push(this._mouseMoveEventHandler);
-		this.listenersToRemove.push(DomUtils.addDisposableThrottledListener(this.viewHelper.viewDomNode, 'mousemove',
+		this.listenersToRemove.push(dom.addDisposableThrottledListener(this.viewHelper.viewDomNode, 'mousemove',
 			this._mouseMoveEventHandler.handler,
 			createMouseMoveEventMerger(this.mouseTargetFactory), MouseHandler.MOUSE_MOVE_MINIMUM_TIME));
 
-		this._mouseDownThenMoveEventHandler = new EventGateKeeper<Mouse.StandardMouseEvent>((e) => this._onMouseDownThenMove(e), () => !this.viewHelper.isDirty());
+		this._mouseDownThenMoveEventHandler = new EventGateKeeper<IMouseEvent>((e) => this._onMouseDownThenMove(e), () => !this.viewHelper.isDirty());
 		this.toDispose.push(this._mouseDownThenMoveEventHandler);
 
-		this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.viewDomNode, 'mouseup',
+		this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.viewDomNode, 'mouseup',
 			(e: MouseEvent) => this._onMouseUp(e)));
 
-		this.listenersToRemove.push(DomUtils.addDisposableNonBubblingMouseOutListener(this.viewHelper.viewDomNode,
+		this.listenersToRemove.push(dom.addDisposableNonBubblingMouseOutListener(this.viewHelper.viewDomNode,
 			(e:MouseEvent) => this._onMouseLeave(e)));
 
-		this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.viewDomNode, 'mousedown',
+		this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.viewDomNode, 'mousedown',
 			(e: MouseEvent) => this._onMouseDown(e)));
 
 
@@ -171,8 +171,8 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 
 	public dispose(): void {
 		this.context.removeEventHandler(this);
-		this.listenersToRemove = Lifecycle.disposeAll(this.listenersToRemove);
-		this.toDispose = Lifecycle.disposeAll(this.toDispose);
+		this.listenersToRemove = disposeAll(this.listenersToRemove);
+		this.toDispose = disposeAll(this.toDispose);
 		this._unhook();
 		if (this.hideTextAreaTimeout !== -1) {
 			window.clearTimeout(this.hideTextAreaTimeout);
@@ -181,39 +181,39 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 	}
 
 	// --- begin event handlers
-	_layoutInfo:EditorCommon.IEditorLayoutInfo;
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	_layoutInfo:editorCommon.IEditorLayoutInfo;
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._layoutInfo = layoutInfo;
 		return false;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		if (this.mouseMoveMonitor.isMonitoring()) {
 			this._hookedOnScroll(e);
 		}
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		this.currentSelection = e.selection;
 		return false;
 	}
 	// --- end event handlers
 
-	protected _createMouseTarget(e:Mouse.StandardMouseEvent, testEventTarget:boolean): EditorBrowser.IMouseTarget {
-		var editorContent = DomUtils.getDomNodePosition(this.viewHelper.viewDomNode);
+	protected _createMouseTarget(e:IMouseEvent, testEventTarget:boolean): editorBrowser.IMouseTarget {
+		var editorContent = dom.getDomNodePosition(this.viewHelper.viewDomNode);
 		return this.mouseTargetFactory.createMouseTarget(this._layoutInfo, editorContent, e, testEventTarget);
 	}
 
 	private _onContextMenu(rawEvent: MouseEvent): void {
-		var e = new Mouse.StandardMouseEvent(rawEvent);
+		var e = new StandardMouseEvent(rawEvent);
 		var t = this._createMouseTarget(e, true);
-		var mouseEvent: EditorBrowser.IMouseEvent = {
+		var mouseEvent: editorBrowser.IEditorMouseEvent = {
 			event: e,
 			target: t
 		};
 		this.viewController.emitContextMenu(mouseEvent);
 	}
 
-	private _onMouseMove(e: Mouse.StandardMouseEvent): void {
+	private _onMouseMove(e: IMouseEvent): void {
 		if (this.mouseMoveMonitor.isMonitoring()) {
 			// In selection/drag operation
 			return;
@@ -225,7 +225,7 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 		}
 
 		var t = this._createMouseTarget(e, true);
-		var mouseEvent: EditorBrowser.IMouseEvent = {
+		var mouseEvent: editorBrowser.IEditorMouseEvent = {
 			event: e,
 			target: t
 		};
@@ -234,41 +234,41 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 
 	private _onMouseLeave(rawEvent: MouseEvent): void {
 		this.lastMouseLeaveTime = (new Date()).getTime();
-		var mouseEvent: EditorBrowser.IMouseEvent = {
-			event: new Mouse.StandardMouseEvent(rawEvent),
+		var mouseEvent: editorBrowser.IEditorMouseEvent = {
+			event: new StandardMouseEvent(rawEvent),
 			target: null
 		};
 		this.viewController.emitMouseLeave(mouseEvent);
 	}
 
 	public _onMouseUp(rawEvent: MouseEvent): void {
-		var e = new Mouse.StandardMouseEvent(rawEvent);
+		var e = new StandardMouseEvent(rawEvent);
 		var t = this._createMouseTarget(e, true);
 
-		var mouseEvent: EditorBrowser.IMouseEvent = {
+		var mouseEvent: editorBrowser.IEditorMouseEvent = {
 			event: e,
 			target: t
 		};
 		this.viewController.emitMouseUp(mouseEvent);
 	}
 
 	public _onMouseDown(rawEvent: MouseEvent): void {
-		var e = new Mouse.StandardMouseEvent(rawEvent);
+		var e = new StandardMouseEvent(rawEvent);
 		var t = this._createMouseTarget(e, true);
 
-		var targetIsContent = (t.type === EditorCommon.MouseTargetType.CONTENT_TEXT || t.type === EditorCommon.MouseTargetType.CONTENT_EMPTY);
-		var targetIsGutter = (t.type === EditorCommon.MouseTargetType.GUTTER_GLYPH_MARGIN || t.type === EditorCommon.MouseTargetType.GUTTER_LINE_NUMBERS || t.type === EditorCommon.MouseTargetType.GUTTER_LINE_DECORATIONS);
-		var targetIsLineNumbers = (t.type === EditorCommon.MouseTargetType.GUTTER_LINE_NUMBERS);
+		var targetIsContent = (t.type === editorCommon.MouseTargetType.CONTENT_TEXT || t.type === editorCommon.MouseTargetType.CONTENT_EMPTY);
+		var targetIsGutter = (t.type === editorCommon.MouseTargetType.GUTTER_GLYPH_MARGIN || t.type === editorCommon.MouseTargetType.GUTTER_LINE_NUMBERS || t.type === editorCommon.MouseTargetType.GUTTER_LINE_DECORATIONS);
+		var targetIsLineNumbers = (t.type === editorCommon.MouseTargetType.GUTTER_LINE_NUMBERS);
 		var selectOnLineNumbers = this.context.configuration.editor.selectOnLineNumbers;
-		var targetIsViewZone = (t.type === EditorCommon.MouseTargetType.CONTENT_VIEW_ZONE || t.type === EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE);
+		var targetIsViewZone = (t.type === editorCommon.MouseTargetType.CONTENT_VIEW_ZONE || t.type === editorCommon.MouseTargetType.GUTTER_VIEW_ZONE);
 
 		var shouldHandle = e.leftButton;
-		if (Platform.isMacintosh && e.ctrlKey) {
+		if (platform.isMacintosh && e.ctrlKey) {
 			shouldHandle = false;
 		}
 
 		if (shouldHandle && (targetIsContent || (targetIsLineNumbers && selectOnLineNumbers))) {
-			if (Browser.isIE11orEarlier) {
+			if (browser.isIE11orEarlier) {
 				// IE does not want to focus when coming in from the browser's address bar
 				if ((<any>e.browserEvent).fromElement) {
 					e.preventDefault();
@@ -289,20 +289,20 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 			// Do not steal focus
 			e.preventDefault();
 		} else if (targetIsViewZone) {
-			var viewZoneData = <EditorBrowser.IViewZoneData>t.detail;
+			var viewZoneData = <editorBrowser.IViewZoneData>t.detail;
 			if (this.viewHelper.shouldSuppressMouseDownOnViewZone(viewZoneData.viewZoneId)) {
 				e.preventDefault();
 			}
 		}
 
-		var mouseEvent: EditorBrowser.IMouseEvent = {
+		var mouseEvent: editorBrowser.IEditorMouseEvent = {
 			event: e,
 			target: t
 		};
 		this.viewController.emitMouseDown(mouseEvent);
 	}
 
-	private _hookedOnScroll(rawEvent:EditorCommon.IScrollEvent): void {
+	private _hookedOnScroll(rawEvent:editorCommon.IScrollEvent): void {
 		if (this.onScrollTimeout === -1) {
 			this.onScrollTimeout = window.setTimeout(() => {
 				this.onScrollTimeout = -1;
@@ -311,7 +311,7 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 		}
 	}
 
-	private _hook(startTargetType:EditorCommon.MouseTargetType): void {
+	private _hook(startTargetType:editorCommon.MouseTargetType): void {
 		if (this.mouseMoveMonitor.isMonitoring()) {
 			// Already monitoring
 			return;
@@ -328,7 +328,7 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 		);
 	}
 
-	private _onMouseDownThenMove(e:Mouse.StandardMouseEvent): void {
+	private _onMouseDownThenMove(e:IMouseEvent): void {
 		this._updateMouse(this.monitoringStartTargetType, e, true);
 	}
 
@@ -339,7 +339,7 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 		}
 	}
 
-	private _getPositionOutsideEditor(editorContent: MouseTarget.IDomNodePosition, e: Mouse.StandardMouseEvent): EditorCommon.IPosition {
+	private _getPositionOutsideEditor(editorContent: IDomNodePosition, e: IMouseEvent): editorCommon.IPosition {
 		var possibleLineNumber: number;
 
 		if (e.posy < editorContent.top) {
@@ -377,11 +377,11 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 		return null;
 	}
 
-	private _updateMouse(startTargetType:EditorCommon.MouseTargetType, e:Mouse.StandardMouseEvent, inSelectionMode:boolean, setMouseDownCount:number = 0): void {
+	private _updateMouse(startTargetType:editorCommon.MouseTargetType, e:IMouseEvent, inSelectionMode:boolean, setMouseDownCount:number = 0): void {
 		e = e || this.lastMouseEvent;
 		this.lastMouseEvent = e;
 
-		var editorContent = DomUtils.getDomNodePosition(this.viewHelper.viewDomNode);
+		var editorContent = dom.getDomNodePosition(this.viewHelper.viewDomNode);
 		var positionOutsideEditor = this._getPositionOutsideEditor(editorContent, e);
 		var lineNumber: number, column: number;
 
@@ -396,11 +396,11 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 				return;
 			}
 
-			if (t.type === EditorCommon.MouseTargetType.CONTENT_VIEW_ZONE || t.type === EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE) {
+			if (t.type === editorCommon.MouseTargetType.CONTENT_VIEW_ZONE || t.type === editorCommon.MouseTargetType.GUTTER_VIEW_ZONE) {
 				// Force position on view zones to go above or below depending on where selection started from
 				if (this.lastMouseDownCount > 0) {
 					var selectionStart = new Position(this.currentSelection.selectionStartLineNumber, this.currentSelection.selectionStartColumn);
-					var viewZoneData = <EditorBrowser.IViewZoneData>t.detail;
+					var viewZoneData = <editorBrowser.IViewZoneData>t.detail;
 					var positionBefore = viewZoneData.positionBefore;
 					var positionAfter = viewZoneData.positionAfter;
 
@@ -448,7 +448,7 @@ export class MouseHandler extends ViewEventHandler implements Lifecycle.IDisposa
 			e.detail = this.lastMouseDownCount;
 		}
 
-		if (startTargetType === EditorCommon.MouseTargetType.GUTTER_LINE_NUMBERS) {
+		if (startTargetType === editorCommon.MouseTargetType.GUTTER_LINE_NUMBERS) {
 			// If the dragging started on the gutter, then have operations work on the entire line
 			if (e.altKey) {
 				if (inSelectionMode) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/controller/mouseTarget.ts
code:
@@ -4,14 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Mouse = require('vs/base/browser/mouseEvent');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import {Range as EditorRange} from 'vs/editor/common/core/range';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {Position} from 'vs/editor/common/core/position';
+import {Range as EditorRange} from 'vs/editor/common/core/range';
+import {IEditorLayoutInfo, IEditorPosition, IEditorRange, IPosition, MouseTargetType} from 'vs/editor/common/editorCommon';
+import {ClassNames, IMouseTarget, IPointerHandlerHelper, IViewContext, IViewZoneData} from 'vs/editor/browser/editorBrowser';
 
 interface IHitTestResult {
-	position: EditorCommon.IPosition;
+	position: IPosition;
 	hitTarget: Element;
 }
 
@@ -22,15 +22,15 @@ export interface IDomNodePosition {
 	height: number;
 }
 
-class MouseTarget implements EditorBrowser.IMouseTarget {
+class MouseTarget implements IMouseTarget {
 
 	public element: Element;
-	public type: EditorCommon.MouseTargetType;
-	public position: EditorCommon.IEditorPosition;
-	public range: EditorCommon.IEditorRange;
+	public type: MouseTargetType;
+	public position: IEditorPosition;
+	public range: IEditorRange;
 	public detail: any;
 
-	constructor(element: Element, type: EditorCommon.MouseTargetType, position:EditorCommon.IEditorPosition = null, range: EditorCommon.IEditorRange = null, detail: any = null) {
+	constructor(element: Element, type: MouseTargetType, position:IEditorPosition = null, range: IEditorRange = null, detail: any = null) {
 		this.element = element;
 		this.type = type;
 		this.position = position;
@@ -42,40 +42,40 @@ class MouseTarget implements EditorBrowser.IMouseTarget {
 	}
 
 	private _typeToString(): string {
-		if (this.type === EditorCommon.MouseTargetType.TEXTAREA) {
+		if (this.type === MouseTargetType.TEXTAREA) {
 			return 'TEXTAREA';
 		}
-		if (this.type === EditorCommon.MouseTargetType.GUTTER_GLYPH_MARGIN) {
+		if (this.type === MouseTargetType.GUTTER_GLYPH_MARGIN) {
 			return 'GUTTER_GLYPH_MARGIN';
 		}
-		if (this.type === EditorCommon.MouseTargetType.GUTTER_LINE_NUMBERS) {
+		if (this.type === MouseTargetType.GUTTER_LINE_NUMBERS) {
 			return 'GUTTER_LINE_NUMBERS';
 		}
-		if (this.type === EditorCommon.MouseTargetType.GUTTER_LINE_DECORATIONS) {
+		if (this.type === MouseTargetType.GUTTER_LINE_DECORATIONS) {
 			return 'GUTTER_LINE_DECORATIONS';
 		}
-		if (this.type === EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE) {
+		if (this.type === MouseTargetType.GUTTER_VIEW_ZONE) {
 			return 'GUTTER_VIEW_ZONE';
 		}
-		if (this.type === EditorCommon.MouseTargetType.CONTENT_TEXT) {
+		if (this.type === MouseTargetType.CONTENT_TEXT) {
 			return 'CONTENT_TEXT';
 		}
-		if (this.type === EditorCommon.MouseTargetType.CONTENT_EMPTY) {
+		if (this.type === MouseTargetType.CONTENT_EMPTY) {
 			return 'CONTENT_EMPTY';
 		}
-		if (this.type === EditorCommon.MouseTargetType.CONTENT_VIEW_ZONE) {
+		if (this.type === MouseTargetType.CONTENT_VIEW_ZONE) {
 			return 'CONTENT_VIEW_ZONE';
 		}
-		if (this.type === EditorCommon.MouseTargetType.CONTENT_WIDGET) {
+		if (this.type === MouseTargetType.CONTENT_WIDGET) {
 			return 'CONTENT_WIDGET';
 		}
-		if (this.type === EditorCommon.MouseTargetType.OVERVIEW_RULER) {
+		if (this.type === MouseTargetType.OVERVIEW_RULER) {
 			return 'OVERVIEW_RULER';
 		}
-		if (this.type === EditorCommon.MouseTargetType.SCROLLBAR) {
+		if (this.type === MouseTargetType.SCROLLBAR) {
 			return 'SCROLLBAR';
 		}
-		if (this.type === EditorCommon.MouseTargetType.OVERLAY_WIDGET) {
+		if (this.type === MouseTargetType.OVERLAY_WIDGET) {
 			return 'OVERLAY_WIDGET';
 		}
 		return 'UNKNOWN';
@@ -101,7 +101,7 @@ var REGEX = (function() {
 		return '[^/]+';
 	}
 
-	var ANCHOR = '^' + EditorBrowser.ClassNames.OVERFLOW_GUARD + '\\/';
+	var ANCHOR = '^' + ClassNames.OVERFLOW_GUARD + '\\/';
 
 	function createRegExp(...pieces:string[]): RegExp {
 		var forceEndMatch = false;
@@ -113,26 +113,26 @@ var REGEX = (function() {
 	}
 
 	return {
-		IS_TEXTAREA_COVER: createRegExp(nodeWithClass(EditorBrowser.ClassNames.TEXTAREA_COVER), '$'),
-		IS_TEXTAREA: createRegExp(EditorBrowser.ClassNames.TEXTAREA, '$'),
-		IS_VIEW_LINES: createRegExp(anyNode(), anyNode(), EditorBrowser.ClassNames.VIEW_LINES, '$'),
-		IS_CURSORS_LAYER: createRegExp(anyNode(), anyNode(), nodeWithClass(EditorBrowser.ClassNames.VIEW_CURSORS_LAYER), '$'),
-		IS_CHILD_OF_VIEW_LINES: createRegExp(anyNode(), anyNode(), EditorBrowser.ClassNames.VIEW_LINES),
-		IS_CHILD_OF_SCROLLABLE_ELEMENT: createRegExp(nodeWithClass(EditorBrowser.ClassNames.SCROLLABLE_ELEMENT)),
-		IS_CHILD_OF_CONTENT_WIDGETS: createRegExp(anyNode(), anyNode(), EditorBrowser.ClassNames.CONTENT_WIDGETS),
-		IS_CHILD_OF_OVERFLOWING_CONTENT_WIDGETS: new RegExp('^' + EditorBrowser.ClassNames.OVERFLOWING_CONTENT_WIDGETS + '\\/'),
-		IS_CHILD_OF_OVERLAY_WIDGETS: createRegExp(EditorBrowser.ClassNames.OVERLAY_WIDGETS),
-		IS_CHILD_OF_VIEW_OVERLAYS: createRegExp(EditorBrowser.ClassNames.MARGIN_VIEW_OVERLAYS),
-		IS_CHILD_OF_VIEW_ZONES: createRegExp(anyNode(), anyNode(), EditorBrowser.ClassNames.VIEW_ZONES),
+		IS_TEXTAREA_COVER: createRegExp(nodeWithClass(ClassNames.TEXTAREA_COVER), '$'),
+		IS_TEXTAREA: createRegExp(ClassNames.TEXTAREA, '$'),
+		IS_VIEW_LINES: createRegExp(anyNode(), anyNode(), ClassNames.VIEW_LINES, '$'),
+		IS_CURSORS_LAYER: createRegExp(anyNode(), anyNode(), nodeWithClass(ClassNames.VIEW_CURSORS_LAYER), '$'),
+		IS_CHILD_OF_VIEW_LINES: createRegExp(anyNode(), anyNode(), ClassNames.VIEW_LINES),
+		IS_CHILD_OF_SCROLLABLE_ELEMENT: createRegExp(nodeWithClass(ClassNames.SCROLLABLE_ELEMENT)),
+		IS_CHILD_OF_CONTENT_WIDGETS: createRegExp(anyNode(), anyNode(), ClassNames.CONTENT_WIDGETS),
+		IS_CHILD_OF_OVERFLOWING_CONTENT_WIDGETS: new RegExp('^' + ClassNames.OVERFLOWING_CONTENT_WIDGETS + '\\/'),
+		IS_CHILD_OF_OVERLAY_WIDGETS: createRegExp(ClassNames.OVERLAY_WIDGETS),
+		IS_CHILD_OF_VIEW_OVERLAYS: createRegExp(ClassNames.MARGIN_VIEW_OVERLAYS),
+		IS_CHILD_OF_VIEW_ZONES: createRegExp(anyNode(), anyNode(), ClassNames.VIEW_ZONES),
 	};
 })();
 
 export class MouseTargetFactory {
 
-	private context: EditorBrowser.IViewContext;
-	private viewHelper: EditorBrowser.IPointerHandlerHelper;
+	private context: IViewContext;
+	private viewHelper: IPointerHandlerHelper;
 
-	constructor(context:EditorBrowser.IViewContext, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:IViewContext, viewHelper:IPointerHandlerHelper) {
 		this.context = context;
 		this.viewHelper = viewHelper;
 	}
@@ -157,7 +157,7 @@ export class MouseTargetFactory {
 		return path.join('/');
 	}
 
-	public mouseTargetIsWidget(e:Mouse.StandardMouseEvent): boolean {
+	public mouseTargetIsWidget(e:IMouseEvent): boolean {
 		var t:Element = e.target;
 		var path = this.getClassNamePathTo(t, this.viewHelper.viewDomNode);
 
@@ -174,7 +174,7 @@ export class MouseTargetFactory {
 		return false;
 	}
 
-	public createMouseTarget(layoutInfo:EditorCommon.IEditorLayoutInfo, editorContent:IDomNodePosition, e:Mouse.StandardMouseEvent, testEventTarget:boolean): EditorBrowser.IMouseTarget {
+	public createMouseTarget(layoutInfo:IEditorLayoutInfo, editorContent:IDomNodePosition, e:IMouseEvent, testEventTarget:boolean): IMouseTarget {
 		try {
 			var r = this._unsafeCreateMouseTarget(layoutInfo, editorContent, e, testEventTarget);
 			return r;
@@ -183,7 +183,7 @@ export class MouseTargetFactory {
 		}
 	}
 
-	private _unsafeCreateMouseTarget(layoutInfo:EditorCommon.IEditorLayoutInfo, editorContent:IDomNodePosition, e:Mouse.StandardMouseEvent, testEventTarget:boolean): EditorBrowser.IMouseTarget {
+	private _unsafeCreateMouseTarget(layoutInfo:IEditorLayoutInfo, editorContent:IDomNodePosition, e:IMouseEvent, testEventTarget:boolean): IMouseTarget {
 		var mouseVerticalOffset = Math.max(0, this.viewHelper.getScrollTop() + (e.posy - editorContent.top));
 		var mouseContentHorizontalOffset = this.viewHelper.getScrollLeft() + (e.posx - editorContent.left) - layoutInfo.contentLeft;
 
@@ -220,15 +220,15 @@ export class MouseTargetFactory {
 
 		// Is it the textarea?
 		if (REGEX.IS_TEXTAREA.test(path)) {
-			return new MouseTarget(t, EditorCommon.MouseTargetType.TEXTAREA);
+			return new MouseTarget(t, MouseTargetType.TEXTAREA);
 		}
 
 		// Is it a view zone?
 		if (REGEX.IS_CHILD_OF_VIEW_ZONES.test(path)) {
 			// Check if it is at a view zone
 			var viewZoneData = this._getZoneAtCoord(mouseVerticalOffset);
 			if (viewZoneData) {
-				return new MouseTarget(t, EditorCommon.MouseTargetType.CONTENT_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
+				return new MouseTarget(t, MouseTargetType.CONTENT_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
 			}
 			return this.createMouseTargetFromUnknownTarget(t);
 		}
@@ -246,7 +246,7 @@ export class MouseTargetFactory {
 			// Check if it is at a view zone
 			var viewZoneData = this._getZoneAtCoord(mouseVerticalOffset);
 			if (viewZoneData) {
-				return new MouseTarget(t, EditorCommon.MouseTargetType.CONTENT_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
+				return new MouseTarget(t, MouseTargetType.CONTENT_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
 			}
 
 			// Check if it hits a position
@@ -272,7 +272,7 @@ export class MouseTargetFactory {
 
 		// Is it the cursors layer?
 		if (REGEX.IS_CURSORS_LAYER.test(path)) {
-			return new MouseTarget(t, EditorCommon.MouseTargetType.UNKNOWN);
+			return new MouseTarget(t, MouseTargetType.UNKNOWN);
 		}
 
 		// Is it a child of the scrollable element?
@@ -335,7 +335,7 @@ export class MouseTargetFactory {
 	/**
 	 * Most probably WebKit browsers
 	 */
-	private _doHitTestWithCaretRangeFromPoint(editorContent:IDomNodePosition, e: Mouse.StandardMouseEvent, mouseVerticalOffset: number): IHitTestResult {
+	private _doHitTestWithCaretRangeFromPoint(editorContent:IDomNodePosition, e: IMouseEvent, mouseVerticalOffset: number): IHitTestResult {
 
 		// In Chrome, especially on Linux it is possible to click between lines,
 		// so try to adjust the `hity` below so that it lands in the center of a line
@@ -362,7 +362,7 @@ export class MouseTargetFactory {
 	}
 
 	private _actualDoHitTestWithCaretRangeFromPoint(hitx:number, hity:number): IHitTestResult {
-		var resultPosition: EditorCommon.IPosition = null;
+		var resultPosition: IPosition = null;
 		var resultHitTarget: Element = null;
 
 		var range:Range = (<any>document).caretRangeFromPoint(hitx, hity);
@@ -375,9 +375,9 @@ export class MouseTargetFactory {
 		var parent2ClassName = parent2 && parent2.nodeType === parent2.ELEMENT_NODE ? (<HTMLElement>parent2).className : '';
 		var parent3ClassName = parent3 && parent3.nodeType === parent3.ELEMENT_NODE ? (<HTMLElement>parent3).className : '';
 
-		if (parent3ClassName === EditorBrowser.ClassNames.VIEW_LINE) {
+		if (parent3ClassName === ClassNames.VIEW_LINE) {
 			resultPosition = this.viewHelper.getPositionFromDOMInfo(<HTMLElement>range.startContainer.parentNode, range.startOffset);
-		} else if (parent2ClassName === EditorBrowser.ClassNames.VIEW_LINE) {
+		} else if (parent2ClassName === ClassNames.VIEW_LINE) {
 			resultPosition = this.viewHelper.getPositionFromDOMInfo(<HTMLElement>range.startContainer, range.startOffset);
 		} else {
 			// Looks like we've hit something foreign
@@ -396,8 +396,8 @@ export class MouseTargetFactory {
 	/**
 	 * Most probably Gecko
 	 */
-	private _doHitTestWithCaretPositionFromPoint(e: Mouse.StandardMouseEvent): IHitTestResult {
-		var resultPosition: EditorCommon.IPosition = null;
+	private _doHitTestWithCaretPositionFromPoint(e: IMouseEvent): IHitTestResult {
+		var resultPosition: IPosition = null;
 		var resultHitTarget: Element = null;
 
 		var hitx = e.posx - document.body.scrollLeft - document.documentElement.scrollLeft;
@@ -420,8 +420,8 @@ export class MouseTargetFactory {
 	/**
 	 * Most probably IE
 	 */
-	private _doHitTestWithMoveToPoint(e: Mouse.StandardMouseEvent): IHitTestResult {
-		var resultPosition: EditorCommon.IPosition = null;
+	private _doHitTestWithMoveToPoint(e: IMouseEvent): IHitTestResult {
+		var resultPosition: IPosition = null;
 		var resultHitTarget: Element = null;
 
 		var textRange:TextRange = (<any>document.body).createTextRange();
@@ -445,7 +445,7 @@ export class MouseTargetFactory {
 
 		var parent2ClassName = parent2 && parent2.nodeType === parent2.ELEMENT_NODE ? (<HTMLElement>parent2).className : '';
 
-		if (parent2ClassName === EditorBrowser.ClassNames.VIEW_LINE) {
+		if (parent2ClassName === ClassNames.VIEW_LINE) {
 			var rangeToContainEntireSpan = textRange.duplicate();
 			rangeToContainEntireSpan.moveToElementText(parentElement);
 			rangeToContainEntireSpan.setEndPoint('EndToStart', textRange);
@@ -469,7 +469,7 @@ export class MouseTargetFactory {
 		};
 	}
 
-	private _doHitTest(editorContent:IDomNodePosition, e:Mouse.StandardMouseEvent, mouseVerticalOffset: number): IHitTestResult {
+	private _doHitTest(editorContent:IDomNodePosition, e:IMouseEvent, mouseVerticalOffset: number): IHitTestResult {
 		// State of the art (18.10.2012):
 		// The spec says browsers should support document.caretPositionFromPoint, but nobody implemented it (http://dev.w3.org/csswg/cssom-view/)
 		// Gecko:
@@ -502,16 +502,16 @@ export class MouseTargetFactory {
 		};
 	}
 
-	private _getZoneAtCoord(mouseVerticalOffset: number): EditorBrowser.IViewZoneData {
+	private _getZoneAtCoord(mouseVerticalOffset: number): IViewZoneData {
 		// The target is either a view zone or the empty space after the last view-line
 		var viewZoneWhitespace = this.viewHelper.getWhitespaceAtVerticalOffset(mouseVerticalOffset);
 
 		if (viewZoneWhitespace) {
 			var viewZoneMiddle = viewZoneWhitespace.verticalOffset + viewZoneWhitespace.height / 2,
 				lineCount = this.context.model.getLineCount(),
-				positionBefore: EditorCommon.IEditorPosition = null,
-				position: EditorCommon.IEditorPosition,
-				positionAfter: EditorCommon.IEditorPosition = null;
+				positionBefore: IEditorPosition = null,
+				position: IEditorPosition,
+				positionAfter: IEditorPosition = null;
 
 			if (viewZoneWhitespace.afterLineNumber !== lineCount) {
 				// There are more lines after this view zone
@@ -543,7 +543,7 @@ export class MouseTargetFactory {
 		return null;
 	}
 
-	private _getFullLineRangeAtCoord(mouseVerticalOffset: number): { range: EditorCommon.IEditorRange; isAfterLines: boolean; } {
+	private _getFullLineRangeAtCoord(mouseVerticalOffset: number): { range: IEditorRange; isAfterLines: boolean; } {
 		if (this.viewHelper.isAfterLines(mouseVerticalOffset)) {
 			// Below the last line
 			var lineNumber = this.context.model.getLineCount();
@@ -563,14 +563,14 @@ export class MouseTargetFactory {
 	}
 
 	private createMouseTargetFromViewCursor(target:Element, lineNumber: number, column: number): MouseTarget {
-		return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_TEXT, new Position(lineNumber, column));
+		return new MouseTarget(target, MouseTargetType.CONTENT_TEXT, new Position(lineNumber, column));
 	}
 
 	private createMouseTargetFromViewLines(target:Element, mouseVerticalOffset: number): MouseTarget {
 		// This most likely indicates it happened after the last view-line
 		var lineCount = this.context.model.getLineCount();
 		var maxLineColumn = this.context.model.getLineMaxColumn(lineCount);
-		return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_EMPTY, new Position(lineCount, maxLineColumn));
+		return new MouseTarget(target, MouseTargetType.CONTENT_EMPTY, new Position(lineCount, maxLineColumn));
 	}
 
 	private createMouseTargetFromHitTestPosition(target:Element, lineNumber: number, column: number, mouseHorizontalOffset: number): MouseTarget {
@@ -579,19 +579,19 @@ export class MouseTargetFactory {
 		var lineWidth = this.viewHelper.getLineWidth(lineNumber);
 
 		if (mouseHorizontalOffset > lineWidth) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_EMPTY, pos);
+			return new MouseTarget(target, MouseTargetType.CONTENT_EMPTY, pos);
 		}
 
 		var visibleRange = this.viewHelper.visibleRangeForPosition2(lineNumber, column);
 
 		if (!visibleRange) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.UNKNOWN, pos);
+			return new MouseTarget(target, MouseTargetType.UNKNOWN, pos);
 		}
 
 		var columnHorizontalOffset = visibleRange.left;
 
 		if (mouseHorizontalOffset === columnHorizontalOffset) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_TEXT, pos);
+			return new MouseTarget(target, MouseTargetType.CONTENT_TEXT, pos);
 		}
 
 		var mouseIsBetween: boolean;
@@ -602,7 +602,7 @@ export class MouseTargetFactory {
 			mouseIsBetween = mouseIsBetween || (columnHorizontalOffset < mouseHorizontalOffset && mouseHorizontalOffset < prevColumnHorizontalOffset); // RTL case
 			if (mouseIsBetween) {
 				var rng = new EditorRange(lineNumber, column, lineNumber, column - 1);
-				return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_TEXT, pos, rng);
+				return new MouseTarget(target, MouseTargetType.CONTENT_TEXT, pos, rng);
 			}
 		}
 
@@ -616,68 +616,68 @@ export class MouseTargetFactory {
 				mouseIsBetween = mouseIsBetween || (nextColumnHorizontalOffset < mouseHorizontalOffset && mouseHorizontalOffset < columnHorizontalOffset); // RTL case
 				if (mouseIsBetween) {
 					var rng = new EditorRange(lineNumber, column, lineNumber, column + 1);
-					return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_TEXT, pos, rng);
+					return new MouseTarget(target, MouseTargetType.CONTENT_TEXT, pos, rng);
 				}
 			}
 		}
 
-		return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_TEXT, pos);
+		return new MouseTarget(target, MouseTargetType.CONTENT_TEXT, pos);
 	}
 
 	private createMouseTargetFromContentWidgetsChild(target: Element): MouseTarget {
 		var widgetId = this._findAttribute(target, 'widgetId', this.viewHelper.viewDomNode);
 
 		if (widgetId) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.CONTENT_WIDGET, null, null, widgetId);
+			return new MouseTarget(target, MouseTargetType.CONTENT_WIDGET, null, null, widgetId);
 		} else {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.UNKNOWN);
+			return new MouseTarget(target, MouseTargetType.UNKNOWN);
 		}
 	}
 
 	private createMouseTargetFromOverlayWidgetsChild(target: Element): MouseTarget {
 		var widgetId = this._findAttribute(target, 'widgetId', this.viewHelper.viewDomNode);
 
 		if (widgetId) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.OVERLAY_WIDGET, null, null, widgetId);
+			return new MouseTarget(target, MouseTargetType.OVERLAY_WIDGET, null, null, widgetId);
 		} else {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.UNKNOWN);
+			return new MouseTarget(target, MouseTargetType.UNKNOWN);
 		}
 	}
 
 	private createMouseTargetFromLinesDecorationsChild(target: Element, mouseVerticalOffset: number): MouseTarget {
 		var viewZoneData = this._getZoneAtCoord(mouseVerticalOffset);
 		if (viewZoneData) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
+			return new MouseTarget(target, MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
 		}
 
 		var res = this._getFullLineRangeAtCoord(mouseVerticalOffset);
-		return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_LINE_DECORATIONS, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
+		return new MouseTarget(target, MouseTargetType.GUTTER_LINE_DECORATIONS, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
 	}
 
 	private createMouseTargetFromLineNumbers(target: Element, mouseVerticalOffset: number): MouseTarget {
 		var viewZoneData = this._getZoneAtCoord(mouseVerticalOffset);
 		if (viewZoneData) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
+			return new MouseTarget(target, MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
 		}
 
 		var res = this._getFullLineRangeAtCoord(mouseVerticalOffset);
-		return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_LINE_NUMBERS, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
+		return new MouseTarget(target, MouseTargetType.GUTTER_LINE_NUMBERS, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
 	}
 
 	private createMouseTargetFromGlyphMargin(target: Element, mouseVerticalOffset: number): MouseTarget {
 		var viewZoneData = this._getZoneAtCoord(mouseVerticalOffset);
 		if (viewZoneData) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
+			return new MouseTarget(target, MouseTargetType.GUTTER_VIEW_ZONE, viewZoneData.position, null, viewZoneData);
 		}
 
 		var res = this._getFullLineRangeAtCoord(mouseVerticalOffset);
-		return new MouseTarget(target, EditorCommon.MouseTargetType.GUTTER_GLYPH_MARGIN, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
+		return new MouseTarget(target, MouseTargetType.GUTTER_GLYPH_MARGIN, new Position(res.range.startLineNumber, res.range.startColumn), res.range, res.isAfterLines);
 	}
 
 	private createMouseTargetFromScrollbar(target: Element, mouseVerticalOffset: number): MouseTarget {
 		var possibleLineNumber = this.viewHelper.getLineNumberAtVerticalOffset(mouseVerticalOffset);
 		var maxColumn = this.context.model.getLineMaxColumn(possibleLineNumber);
-		return new MouseTarget(target, EditorCommon.MouseTargetType.SCROLLBAR, new Position(possibleLineNumber, maxColumn));
+		return new MouseTarget(target, MouseTargetType.SCROLLBAR, new Position(possibleLineNumber, maxColumn));
 	}
 
 	private createMouseTargetFromUnknownTarget(target: Element): MouseTarget {
@@ -688,9 +688,9 @@ export class MouseTargetFactory {
 		}
 
 		if (widgetId) {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.OVERLAY_WIDGET, null, null, widgetId);
+			return new MouseTarget(target, MouseTargetType.OVERLAY_WIDGET, null, null, widgetId);
 		} else {
-			return new MouseTarget(target, EditorCommon.MouseTargetType.UNKNOWN);
+			return new MouseTarget(target, MouseTargetType.UNKNOWN);
 		}
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/controller/pointerHandler.ts
code:
@@ -4,13 +4,13 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Mouse = require('vs/base/browser/mouseEvent');
-import DomUtils = require('vs/base/browser/dom');
-import Touch = require('vs/base/browser/touch');
-import MouseHandler = require('vs/editor/browser/controller/mouseHandler');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Lifecycle = require('vs/base/common/lifecycle');
+import {IDisposable} from 'vs/base/common/lifecycle';
+import * as dom from 'vs/base/browser/dom';
+import {StandardMouseEvent} from 'vs/base/browser/mouseEvent';
+import {EventType, Gesture, GestureEvent} from 'vs/base/browser/touch';
+import {IScrollEvent} from 'vs/editor/common/editorCommon';
+import {MouseHandler} from 'vs/editor/browser/controller/mouseHandler';
+import {IPointerHandlerHelper, IViewContext, IViewController} from 'vs/editor/browser/editorBrowser';
 
 interface IThrottledGestureEvent {
 	translationX: number;
@@ -32,12 +32,12 @@ var gestureChangeEventMerger = (lastEvent:IThrottledGestureEvent, currentEvent:M
 /**
  * Basically IE10 and IE11
  */
-class MsPointerHandler extends MouseHandler.MouseHandler implements Lifecycle.IDisposable {
+class MsPointerHandler extends MouseHandler implements IDisposable {
 
 	private _lastPointerType: string;
 	private _installGestureHandlerTimeout: number;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:IViewContext, viewController:IViewController, viewHelper:IPointerHandlerHelper) {
 		super(context, viewController, viewHelper);
 
 		this.viewHelper.linesContentDomNode.style.msTouchAction = 'none';
@@ -66,8 +66,8 @@ class MsPointerHandler extends MouseHandler.MouseHandler implements Lifecycle.ID
 						penGesture.addPointer(e.pointerId);
 					}
 				});
-				this.listenersToRemove.push(DomUtils.addDisposableThrottledListener<IThrottledGestureEvent>(this.viewHelper.linesContentDomNode, 'MSGestureChange', (e) => this._onGestureChange(e), gestureChangeEventMerger));
-				this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.linesContentDomNode, 'MSGestureTap', (e) => this._onCaptureGestureTap(e), true));
+				this.listenersToRemove.push(dom.addDisposableThrottledListener<IThrottledGestureEvent>(this.viewHelper.linesContentDomNode, 'MSGestureChange', (e) => this._onGestureChange(e), gestureChangeEventMerger));
+				this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.linesContentDomNode, 'MSGestureTap', (e) => this._onCaptureGestureTap(e), true));
 			}
 		}, 100);
 		this._lastPointerType = 'mouse';
@@ -80,7 +80,7 @@ class MsPointerHandler extends MouseHandler.MouseHandler implements Lifecycle.ID
 	}
 
 	private _onCaptureGestureTap(rawEvent: MSGestureEvent): void {
-		var e = new Mouse.StandardMouseEvent(<MouseEvent><any>rawEvent);
+		var e = new StandardMouseEvent(<MouseEvent><any>rawEvent);
 		var t = this._createMouseTarget(e, false);
 		if (t.position) {
 			this.viewController.moveTo('mouse', t.position.lineNumber, t.position.column);
@@ -111,12 +111,12 @@ class MsPointerHandler extends MouseHandler.MouseHandler implements Lifecycle.ID
 /**
  * Basically Edge but should be modified to handle any pointerEnabled, even without support of MSGesture
  */
-class StandardPointerHandler extends MouseHandler.MouseHandler implements Lifecycle.IDisposable {
+class StandardPointerHandler extends MouseHandler implements IDisposable {
 
 	private _lastPointerType: string;
 	private _installGestureHandlerTimeout: number;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:IViewContext, viewController:IViewController, viewHelper:IPointerHandlerHelper) {
 		super(context, viewController, viewHelper);
 
 		this.viewHelper.linesContentDomNode.style.touchAction = 'none';
@@ -145,8 +145,8 @@ class StandardPointerHandler extends MouseHandler.MouseHandler implements Lifecy
 						penGesture.addPointer(e.pointerId);
 					}
 				});
-				this.listenersToRemove.push(DomUtils.addDisposableThrottledListener<IThrottledGestureEvent>(this.viewHelper.linesContentDomNode, 'MSGestureChange', (e) => this._onGestureChange(e), gestureChangeEventMerger));
-				this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.linesContentDomNode, 'MSGestureTap', (e) => this._onCaptureGestureTap(e), true));
+				this.listenersToRemove.push(dom.addDisposableThrottledListener<IThrottledGestureEvent>(this.viewHelper.linesContentDomNode, 'MSGestureChange', (e) => this._onGestureChange(e), gestureChangeEventMerger));
+				this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.linesContentDomNode, 'MSGestureTap', (e) => this._onCaptureGestureTap(e), true));
 			}
 		}, 100);
 		this._lastPointerType = 'mouse';
@@ -159,7 +159,7 @@ class StandardPointerHandler extends MouseHandler.MouseHandler implements Lifecy
 	}
 
 	private _onCaptureGestureTap(rawEvent: MSGestureEvent): void {
-		var e = new Mouse.StandardMouseEvent(<MouseEvent><any>rawEvent);
+		var e = new StandardMouseEvent(<MouseEvent><any>rawEvent);
 		var t = this._createMouseTarget(e, false);
 		if (t.position) {
 			this.viewController.moveTo('mouse', t.position.lineNumber, t.position.column);
@@ -187,59 +187,59 @@ class StandardPointerHandler extends MouseHandler.MouseHandler implements Lifecy
 	}
 }
 
-class TouchHandler extends MouseHandler.MouseHandler {
+class TouchHandler extends MouseHandler {
 
-	private gesture:Touch.Gesture;
+	private gesture:Gesture;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:IViewContext, viewController:IViewController, viewHelper:IPointerHandlerHelper) {
 		super(context, viewController, viewHelper);
 
-		this.gesture = new Touch.Gesture(this.viewHelper.linesContentDomNode);
+		this.gesture = new Gesture(this.viewHelper.linesContentDomNode);
 
-		this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.linesContentDomNode, Touch.EventType.Tap, (e) => this.onTap(e)));
-		this.listenersToRemove.push(DomUtils.addDisposableListener(this.viewHelper.linesContentDomNode, Touch.EventType.Change, (e) => this.onChange(e)));
+		this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.linesContentDomNode, EventType.Tap, (e) => this.onTap(e)));
+		this.listenersToRemove.push(dom.addDisposableListener(this.viewHelper.linesContentDomNode, EventType.Change, (e) => this.onChange(e)));
 	}
 
 	public dispose(): void {
 		this.gesture.dispose();
 		super.dispose();
 	}
 
-	private onTap(event:Touch.GestureEvent): void {
+	private onTap(event:GestureEvent): void {
 		event.preventDefault();
 
 		this.viewHelper.focusTextArea();
 
-		var mouseEvent = new Mouse.StandardMouseEvent(event);
+		var mouseEvent = new StandardMouseEvent(event);
 		var target = this._createMouseTarget(mouseEvent, false);
 
 		if (target.position) {
 			this.viewController.moveTo('mouse', target.position.lineNumber, target.position.column);
 		}
 	}
 
-	private onChange(event:Touch.GestureEvent): void {
+	private onChange(event:GestureEvent): void {
 		this.viewHelper.setScrollTop(this.viewHelper.getScrollTop() - event.translationY);
 		this.viewHelper.setScrollLeft(this.viewHelper.getScrollLeft() - event.translationX);
 	}
 }
 
-export class PointerHandler implements Lifecycle.IDisposable {
-	private handler:MouseHandler.MouseHandler;
+export class PointerHandler implements IDisposable {
+	private handler:MouseHandler;
 
-	constructor(context:EditorBrowser.IViewContext, viewController:EditorBrowser.IViewController, viewHelper:EditorBrowser.IPointerHandlerHelper) {
+	constructor(context:IViewContext, viewController:IViewController, viewHelper:IPointerHandlerHelper) {
 		if (window.navigator.msPointerEnabled) {
 			this.handler = new MsPointerHandler(context, viewController, viewHelper);
 		} else if((<any> window).TouchEvent) {
 			this.handler = new TouchHandler(context, viewController, viewHelper);
 		} else if (window.navigator.pointerEnabled) {
 			this.handler = new StandardPointerHandler(context, viewController, viewHelper);
 		} else {
-			this.handler = new MouseHandler.MouseHandler(context, viewController, viewHelper);
+			this.handler = new MouseHandler(context, viewController, viewHelper);
 		}
 	}
 
-	public onScrollChanged(e:EditorCommon.IScrollEvent): void {
+	public onScrollChanged(e:IScrollEvent): void {
 		this.handler.onScrollChanged(e);
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/editor.all.js
code:
@@ -1,49 +0,0 @@
-/*---------------------------------------------------------------------------------------------
- *  Copyright (c) Microsoft Corporation. All rights reserved.
- *  Licensed under the MIT License. See License.txt in the project root for license information.
- *--------------------------------------------------------------------------------------------*/
-define([
-	'vs/editor/browser/widget/codeEditorWidget',
-	'vs/editor/browser/widget/diffEditorWidget',
-
-	'vs/editor/contrib/accessibility/browser/accessibility',
-	'vs/editor/contrib/clipboard/browser/clipboard',
-	'vs/editor/contrib/codelens/browser/codelens',
-	'vs/editor/contrib/color/browser/color',
-	'vs/editor/contrib/comment/common/comment',
-	'vs/editor/contrib/contextmenu/browser/contextmenu',
-	'vs/editor/contrib/diffNavigator/common/diffNavigator',
-	'vs/editor/contrib/find/browser/find',
-	'vs/editor/contrib/format/common/formatActions',
-	'vs/editor/contrib/goToDeclaration/browser/goToDeclaration',
-	'vs/editor/contrib/gotoError/browser/gotoError',
-	'vs/editor/contrib/hover/browser/hover',
-	'vs/editor/contrib/inPlaceReplace/common/inPlaceReplace',
-	'vs/editor/contrib/iPadShowKeyboard/browser/iPadShowKeyboard',
-	'vs/editor/contrib/linesOperations/common/linesOperations',
-	'vs/editor/contrib/links/browser/links',
-	'vs/editor/contrib/multicursor/common/multicursor',
-	'vs/editor/contrib/outlineMarker/browser/outlineMarker',
-	'vs/editor/contrib/parameterHints/browser/parameterHints',
-	'vs/editor/contrib/quickFix/browser/quickFix',
-	'vs/editor/contrib/referenceSearch/browser/referenceSearch',
-	'vs/editor/contrib/rename/browser/rename2',
-	'vs/editor/contrib/smartSelect/common/smartSelect',
-	'vs/editor/contrib/smartSelect/common/jumpToBracket',
-	'vs/editor/contrib/snippet/common/snippet',
-	'vs/editor/contrib/snippet/browser/snippet',
-	'vs/editor/contrib/suggest/browser/suggest',
-	'vs/editor/contrib/toggleTabFocusMode/common/toggleTabFocusMode',
-	'vs/editor/contrib/toggleWordWrap/common/toggleWordWrap',
-	'vs/editor/contrib/wordHighlighter/common/wordHighlighter',
-	'vs/editor/contrib/workerStatusReporter/browser/workerStatusReporter',
-	'vs/editor/contrib/defineKeybinding/browser/defineKeybinding',
-	"vs/editor/contrib/folding/browser/folding",
-
-	// include these in the editor bundle because they are widely used by many languages
-	'vs/editor/common/languages.common'
-
-], function() {
-	'use strict';
-
-});

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/editor.all.ts
code:
@@ -0,0 +1,47 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+'use strict';
+
+import 'vs/editor/browser/widget/codeEditorWidget';
+import 'vs/editor/browser/widget/diffEditorWidget';
+
+import 'vs/editor/contrib/accessibility/browser/accessibility';
+import 'vs/editor/contrib/clipboard/browser/clipboard';
+import 'vs/editor/contrib/codelens/browser/codelens';
+import 'vs/editor/contrib/color/browser/color';
+import 'vs/editor/contrib/comment/common/comment';
+import 'vs/editor/contrib/contextmenu/browser/contextmenu';
+import 'vs/editor/contrib/diffNavigator/common/diffNavigator';
+import 'vs/editor/contrib/find/browser/find';
+import 'vs/editor/contrib/format/common/formatActions';
+import 'vs/editor/contrib/goToDeclaration/browser/goToDeclaration';
+import 'vs/editor/contrib/gotoError/browser/gotoError';
+import 'vs/editor/contrib/hover/browser/hover';
+import 'vs/editor/contrib/inPlaceReplace/common/inPlaceReplace';
+import 'vs/editor/contrib/iPadShowKeyboard/browser/iPadShowKeyboard';
+import 'vs/editor/contrib/linesOperations/common/linesOperations';
+import 'vs/editor/contrib/links/browser/links';
+import 'vs/editor/contrib/multicursor/common/multicursor';
+import 'vs/editor/contrib/outlineMarker/browser/outlineMarker';
+import 'vs/editor/contrib/parameterHints/browser/parameterHints';
+import 'vs/editor/contrib/quickFix/browser/quickFix';
+import 'vs/editor/contrib/referenceSearch/browser/referenceSearch';
+import 'vs/editor/contrib/rename/browser/rename2';
+import 'vs/editor/contrib/smartSelect/common/smartSelect';
+import 'vs/editor/contrib/smartSelect/common/jumpToBracket';
+import 'vs/editor/contrib/snippet/common/snippet';
+import 'vs/editor/contrib/snippet/browser/snippet';
+import 'vs/editor/contrib/suggest/browser/suggest';
+import 'vs/editor/contrib/toggleTabFocusMode/common/toggleTabFocusMode';
+import 'vs/editor/contrib/toggleWordWrap/common/toggleWordWrap';
+import 'vs/editor/contrib/wordHighlighter/common/wordHighlighter';
+import 'vs/editor/contrib/workerStatusReporter/browser/workerStatusReporter';
+import 'vs/editor/contrib/defineKeybinding/browser/defineKeybinding';
+import 'vs/editor/contrib/folding/browser/folding';
+import 'vs/editor/contrib/indentation/common/indentation';
+
+// include these in the editor bundle because they are widely used by many languages
+import 'vs/editor/common/languages.common';

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/editorBrowser.ts
code:
@@ -4,15 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
-import EventEmitter = require('vs/base/common/eventEmitter');
-import Lifecycle = require('vs/base/common/lifecycle');
-import DomUtils = require('vs/base/browser/dom');
-import Mouse = require('vs/base/browser/mouseEvent');
-
-import Instantiation = require('vs/platform/instantiation/common/instantiation');
-
-export interface IDynamicViewOverlay extends Lifecycle.IDisposable {
+import {IEmitterEvent, IEventEmitter} from 'vs/base/common/eventEmitter';
+import {IDisposable} from 'vs/base/common/lifecycle';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {IMouseEvent} from 'vs/base/browser/mouseEvent';
+import {IInstantiationService, IConstructorSignature1} from 'vs/platform/instantiation/common/instantiation';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+
+export interface IDynamicViewOverlay extends IDisposable {
 	shouldCallRender2(ctx:IRenderingContext): boolean;
 	render2(lineNumber:number): string[];
 }
@@ -42,7 +41,7 @@ export interface ICodeEditorHelper {
 export interface IKeyboardHandlerHelper {
 	viewDomNode:HTMLElement;
 	textArea:HTMLTextAreaElement;
-	visibleRangeForPositionRelativeToEditor(lineNumber:number, column:number): EditorCommon.VisibleRange;
+	visibleRangeForPositionRelativeToEditor(lineNumber:number, column:number): editorCommon.VisibleRange;
 }
 
 export interface IPointerHandlerHelper {
@@ -60,39 +59,39 @@ export interface IPointerHandlerHelper {
 	isAfterLines(verticalOffset:number): boolean;
 	getLineNumberAtVerticalOffset(verticalOffset: number): number;
 	getVerticalOffsetForLineNumber(lineNumber: number): number;
-	getWhitespaceAtVerticalOffset(verticalOffset:number): EditorCommon.IViewWhitespaceViewportData;
+	getWhitespaceAtVerticalOffset(verticalOffset:number): editorCommon.IViewWhitespaceViewportData;
 	shouldSuppressMouseDownOnViewZone(viewZoneId:number): boolean;
 
 	/**
 	 * Decode an Editor.IPosition from a rendered dom node
 	 */
-	getPositionFromDOMInfo(spanNode:HTMLElement, offset:number): EditorCommon.IPosition;
+	getPositionFromDOMInfo(spanNode:HTMLElement, offset:number): editorCommon.IPosition;
 
-	visibleRangeForPosition2(lineNumber:number, column:number): EditorCommon.VisibleRange;
+	visibleRangeForPosition2(lineNumber:number, column:number): editorCommon.VisibleRange;
 	getLineWidth(lineNumber:number): number;
 }
 
-export interface IView extends Lifecycle.IDisposable {
+export interface IView extends IDisposable {
 	domNode: HTMLElement;
 
-	getInternalEventBus(): EventEmitter.IEventEmitter;
+	getInternalEventBus(): IEventEmitter;
 
 	createOverviewRuler(cssClassName:string, minimumHeight:number, maximumHeight:number): IOverviewRuler;
 	getCodeEditorHelper(): ICodeEditorHelper;
 
-	getCenteredRangeInViewport(): EditorCommon.IEditorRange;
+	getCenteredRangeInViewport(): editorCommon.IEditorRange;
 
 	change(callback:(changeAccessor:IViewZoneChangeAccessor) => any): boolean;
-	getWhitespaces(): EditorCommon.IEditorWhitespace[];
+	getWhitespaces(): editorCommon.IEditorWhitespace[];
 	renderOnce(callback:() => any): any;
 
 	render(now:boolean): void;
 
 	focus(): void;
 	isFocused(): boolean;
 
-	saveState(): EditorCommon.IViewState;
-	restoreState(state:EditorCommon.IViewState): void;
+	saveState(): editorCommon.IViewState;
+	restoreState(state:editorCommon.IViewState): void;
 
 	addContentWidget(widgetData: IContentWidgetData): void;
 	layoutContentWidget(widgetData: IContentWidgetData): void;
@@ -105,9 +104,9 @@ export interface IView extends Lifecycle.IDisposable {
 
 export interface IViewZoneData {
 	viewZoneId: number;
-	positionBefore:EditorCommon.IEditorPosition;
-	positionAfter:EditorCommon.IEditorPosition;
-	position: EditorCommon.IEditorPosition;
+	positionBefore:editorCommon.IEditorPosition;
+	positionAfter:editorCommon.IEditorPosition;
+	position: editorCommon.IEditorPosition;
 	afterLineNumber: number;
 }
 
@@ -129,13 +128,13 @@ export interface IViewController {
 	lastCursorLineSelectDrag(source:string, lineNumber:number, column:number): void;
 	selectAll(source:string): void;
 
-	emitKeyDown(e:DomUtils.IKeyboardEvent): void;
-	emitKeyUp(e:DomUtils.IKeyboardEvent): void;
-	emitContextMenu(e:IMouseEvent): void;
-	emitMouseMove(e:IMouseEvent): void;
-	emitMouseLeave(e:IMouseEvent): void;
-	emitMouseUp(e:IMouseEvent): void;
-	emitMouseDown(e:IMouseEvent): void;
+	emitKeyDown(e:IKeyboardEvent): void;
+	emitKeyUp(e:IKeyboardEvent): void;
+	emitContextMenu(e:IEditorMouseEvent): void;
+	emitMouseMove(e:IEditorMouseEvent): void;
+	emitMouseLeave(e:IEditorMouseEvent): void;
+	emitMouseUp(e:IEditorMouseEvent): void;
+	emitMouseDown(e:IEditorMouseEvent): void;
 }
 
 export var ClassNames = {
@@ -158,12 +157,12 @@ export var ClassNames = {
 };
 
 export interface IRestrictedRenderingContext {
-	linesViewportData:EditorCommon.IViewLinesViewportData;
+	linesViewportData:editorCommon.IViewLinesViewportData;
 
 	scrollWidth:number;
 	scrollHeight:number;
 
-	visibleRange:EditorCommon.IEditorRange;
+	visibleRange:editorCommon.IEditorRange;
 	bigNumbersDelta:number;
 
 	viewportTop:number;
@@ -175,29 +174,29 @@ export interface IRestrictedRenderingContext {
 	getViewportVerticalOffsetForLineNumber(lineNumber:number): number;
 	lineIsVisible(lineNumber:number): boolean;
 
-	getDecorationsInViewport(): EditorCommon.IModelDecoration[];
+	getDecorationsInViewport(): editorCommon.IModelDecoration[];
 }
 
 export interface IRenderingContext extends IRestrictedRenderingContext {
 
-	linesVisibleRangesForRange(range:EditorCommon.IRange, includeNewLines:boolean): EditorCommon.LineVisibleRanges[];
+	linesVisibleRangesForRange(range:editorCommon.IRange, includeNewLines:boolean): editorCommon.LineVisibleRanges[];
 
-	visibleRangeForPosition(position:EditorCommon.IPosition): EditorCommon.VisibleRange;
+	visibleRangeForPosition(position:editorCommon.IPosition): editorCommon.VisibleRange;
 }
 
 export interface IViewEventHandler {
-	handleEvents(events:EventEmitter.IEmitterEvent[]): void;
+	handleEvents(events:IEmitterEvent[]): void;
 }
 
 export interface IViewportInfo {
-	visibleRange: EditorCommon.IEditorRange;
+	visibleRange: editorCommon.IEditorRange;
 	width:number;
 	height:number;
 	deltaTop:number;
 	deltaLeft:number;
 }
 
-export interface IViewPart extends Lifecycle.IDisposable {
+export interface IViewPart extends IDisposable {
 	onBeforeForcedLayout(): void;
 	onReadAfterForcedLayout(ctx:IRenderingContext): void;
 	onWriteAfterForcedLayout(): void;
@@ -210,9 +209,9 @@ export interface IViewContext {
 	addEventHandler(eventHandler:IViewEventHandler): void;
 	removeEventHandler(eventHandler:IViewEventHandler): void;
 
-	configuration:EditorCommon.IConfiguration;
-	model: EditorCommon.IViewModel;
-	privateViewEventBus:EditorCommon.IViewEventBus;
+	configuration:editorCommon.IConfiguration;
+	model: editorCommon.IViewModel;
+	privateViewEventBus:editorCommon.IViewEventBus;
 }
 
 export interface ILayoutProvider extends IVerticalLayoutProvider, IScrollingProvider {
@@ -221,12 +220,12 @@ export interface ILayoutProvider extends IVerticalLayoutProvider, IScrollingProv
 
 	getCenteredViewLineNumberInViewport(): number;
 
-	getCurrentViewport(): EditorCommon.IViewport;
+	getCurrentViewport(): editorCommon.IViewport;
 
 	onMaxLineWidthChanged(width:number): void;
 
-	saveState(): EditorCommon.IViewState;
-	restoreState(state:EditorCommon.IViewState): void;
+	saveState(): editorCommon.IViewState;
+	restoreState(state:editorCommon.IViewState): void;
 }
 
 export interface IScrollingProvider {
@@ -271,7 +270,7 @@ export interface IVerticalLayoutProvider {
 	/**
 	 * Compute the lines that need to be rendered in the current viewport position.
 	 */
-	getLinesViewportData(): EditorCommon.IViewLinesViewportData;
+	getLinesViewportData(): editorCommon.IViewLinesViewportData;
 }
 
 /**
@@ -367,7 +366,7 @@ export interface IContentWidgetPosition {
 	 * Desired position for the content widget.
 	 * `preference` will also affect the placement.
 	 */
-	position: EditorCommon.IPosition;
+	position: editorCommon.IPosition;
 	/**
 	 * Placement preference for position, in order of preference.
 	 */
@@ -454,15 +453,15 @@ export interface IMouseTarget {
 	/**
 	 * The target type
 	 */
-	type: EditorCommon.MouseTargetType;
+	type: editorCommon.MouseTargetType;
 	/**
 	 * The 'approximate' editor position
 	 */
-	position: EditorCommon.IEditorPosition;
+	position: editorCommon.IEditorPosition;
 	/**
 	 * The 'approximate' editor range
 	 */
-	range: EditorCommon.IEditorRange;
+	range: editorCommon.IEditorRange;
 	/**
 	 * Some extra detail.
 	 */
@@ -471,12 +470,12 @@ export interface IMouseTarget {
 /**
  * A mouse event originating from the editor.
  */
-export interface IMouseEvent {
-	event: Mouse.IMouseEvent;
+export interface IEditorMouseEvent {
+	event: IMouseEvent;
 	target: IMouseTarget;
 }
 
-export type ISimpleEditorContributionCtor = Instantiation.IConstructorSignature1<ICodeEditor, EditorCommon.IEditorContribution> | Instantiation.INewConstructorSignature1<ICodeEditor, EditorCommon.IEditorContribution>;
+export type ISimpleEditorContributionCtor = IConstructorSignature1<ICodeEditor, editorCommon.IEditorContribution>;
 
 /**
  * An editor contribution descriptor that will be used to construct editor contributions
@@ -485,7 +484,7 @@ export interface IEditorContributionDescriptor {
 	/**
 	 * Create an instance of the contribution
 	 */
-	createInstance(instantiationService:Instantiation.IInstantiationService, editor:ICodeEditor): EditorCommon.IEditorContribution;
+	createInstance(instantiationService:IInstantiationService, editor:ICodeEditor): editorCommon.IEditorContribution;
 }
 
 /**
@@ -497,7 +496,7 @@ export interface IOverviewRulerZone {
 	forceHeight?: number;
 	color: string;
 	darkColor: string;
-	position: EditorCommon.OverviewRulerLane;
+	position: editorCommon.OverviewRulerLane;
 }
 /**
  * An overview ruler
@@ -506,12 +505,12 @@ export interface IOverviewRuler {
 	getDomNode(): HTMLElement;
 	dispose(): void;
 	setZones(zones:IOverviewRulerZone[]): void;
-	setLayout(position:EditorCommon.IOverviewRulerPosition): void;
+	setLayout(position:editorCommon.IOverviewRulerPosition): void;
 }
 /**
  * A rich code editor.
  */
-export interface ICodeEditor extends EditorCommon.ICommonCodeEditor {
+export interface ICodeEditor extends editorCommon.ICommonCodeEditor {
 
 	/**
 	 * Returns the editor's dom node
@@ -554,12 +553,12 @@ export interface ICodeEditor extends EditorCommon.ICommonCodeEditor {
 	/**
 	 * Returns the range that is currently centered in the view port.
 	 */
-	getCenteredRangeInViewport(): EditorCommon.IEditorRange;
+	getCenteredRangeInViewport(): editorCommon.IEditorRange;
 
 	/**
 	 * Get the view zones.
 	 */
-	getWhitespaces(): EditorCommon.IEditorWhitespace[];
+	getWhitespaces(): editorCommon.IEditorWhitespace[];
 
 	/**
 	 * Get the horizontal position (left offset) for the column w.r.t to the beginning of the line.
@@ -590,18 +589,18 @@ export interface ICodeEditor extends EditorCommon.ICommonCodeEditor {
 	 * Explanation 2: the results of this method will not change if the container of the editor gets repositioned.
 	 * Warning: the results of this method are innacurate for positions that are outside the current editor viewport.
 	 */
-	getScrolledVisiblePosition(position: EditorCommon.IPosition): { top: number; left: number; height: number; };
+	getScrolledVisiblePosition(position: editorCommon.IPosition): { top: number; left: number; height: number; };
 
 	/**
 	 * Set the model ranges that will be hidden in the view.
 	 */
-	setHiddenAreas(ranges:EditorCommon.IRange[]): void;
+	setHiddenAreas(ranges:editorCommon.IRange[]): void;
 }
 
 /**
  * A rich diff editor.
  */
-export interface IDiffEditor extends EditorCommon.ICommonDiffEditor {
+export interface IDiffEditor extends editorCommon.ICommonDiffEditor {
 	/**
 	 * @see ICodeEditor.getDomNode
 	 */

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/editorBrowserExtensions.ts
code:
@@ -4,31 +4,31 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Platform = require('vs/platform/platform');
-import {IInstantiationService, INewConstructorSignature1} from 'vs/platform/instantiation/common/instantiation';
+import {IInstantiationService, IConstructorSignature1} from 'vs/platform/instantiation/common/instantiation';
+import {Registry} from 'vs/platform/platform';
+import {IEditorContribution} from 'vs/editor/common/editorCommon';
+import {ICodeEditor, IEditorContributionDescriptor, ISimpleEditorContributionCtor} from 'vs/editor/browser/editorBrowser';
 
 export namespace EditorBrowserRegistry {
 	// --- Editor Contributions
-	export function registerEditorContribution(ctor:EditorBrowser.ISimpleEditorContributionCtor): void {
-		(<EditorContributionRegistry>Platform.Registry.as(Extensions.EditorContributions)).registerEditorBrowserContribution(ctor);
+	export function registerEditorContribution(ctor:ISimpleEditorContributionCtor): void {
+		(<EditorContributionRegistry>Registry.as(Extensions.EditorContributions)).registerEditorBrowserContribution(ctor);
 	}
-	export function getEditorContributions(): EditorBrowser.IEditorContributionDescriptor[] {
-		return (<EditorContributionRegistry>Platform.Registry.as(Extensions.EditorContributions)).getEditorBrowserContributions();
+	export function getEditorContributions(): IEditorContributionDescriptor[] {
+		return (<EditorContributionRegistry>Registry.as(Extensions.EditorContributions)).getEditorBrowserContributions();
 	}
 }
 
-class SimpleEditorContributionDescriptor implements EditorBrowser.IEditorContributionDescriptor {
-	private _ctor:EditorBrowser.ISimpleEditorContributionCtor;
+class SimpleEditorContributionDescriptor implements IEditorContributionDescriptor {
+	private _ctor:ISimpleEditorContributionCtor;
 
-	constructor(ctor:EditorBrowser.ISimpleEditorContributionCtor) {
+	constructor(ctor:ISimpleEditorContributionCtor) {
 		this._ctor = ctor;
 	}
 
-	public createInstance(instantiationService:IInstantiationService, editor:EditorBrowser.ICodeEditor): EditorCommon.IEditorContribution {
+	public createInstance(instantiationService:IInstantiationService, editor:ICodeEditor): IEditorContribution {
 		// cast added to help the compiler, can remove once IConstructorSignature1 has been removed
-		return instantiationService.createInstance(<INewConstructorSignature1<EditorBrowser.ICodeEditor, EditorCommon.IEditorContribution>> this._ctor, editor);
+		return instantiationService.createInstance(<IConstructorSignature1<ICodeEditor, IEditorContribution>> this._ctor, editor);
 	}
 }
 
@@ -39,19 +39,19 @@ var Extensions = {
 
 class EditorContributionRegistry {
 
-	private editorContributions: EditorBrowser.IEditorContributionDescriptor[];
+	private editorContributions: IEditorContributionDescriptor[];
 
 	constructor() {
 		this.editorContributions = [];
 	}
 
-	public registerEditorBrowserContribution(ctor:EditorBrowser.ISimpleEditorContributionCtor): void {
+	public registerEditorBrowserContribution(ctor:ISimpleEditorContributionCtor): void {
 		this.editorContributions.push(new SimpleEditorContributionDescriptor(ctor));
 	}
 
-	public getEditorBrowserContributions(): EditorBrowser.IEditorContributionDescriptor[] {
+	public getEditorBrowserContributions(): IEditorContributionDescriptor[] {
 		return this.editorContributions.slice(0);
 	}
 }
 
-Platform.Registry.add(Extensions.EditorContributions, new EditorContributionRegistry());
+Registry.add(Extensions.EditorContributions, new EditorContributionRegistry());

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/services/codeEditorServiceImpl.ts
code:
@@ -4,18 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {
-	IThemeDecorationRenderOptions,
-	IDecorationRenderOptions,
-	IModelDecorationOptions,
-	IModelDecorationOverviewRulerOptions,
-	OverviewRulerLane
-} from 'vs/editor/common/editorCommon';
-import {AbstractCodeEditorService} from 'vs/editor/common/services/abstractCodeEditorService';
-import dom = require('vs/base/browser/dom');
-import objects = require('vs/base/common/objects');
-import strings = require('vs/base/common/strings');
+import * as objects from 'vs/base/common/objects';
+import * as strings from 'vs/base/common/strings';
 import URI from 'vs/base/common/uri';
+import * as dom from 'vs/base/browser/dom';
+import {IDecorationRenderOptions, IModelDecorationOptions, IModelDecorationOverviewRulerOptions, IThemeDecorationRenderOptions, OverviewRulerLane} from 'vs/editor/common/editorCommon';
+import {AbstractCodeEditorService} from 'vs/editor/common/services/abstractCodeEditorService';
 
 export class CodeEditorServiceImpl extends AbstractCodeEditorService {
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/colorizer.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {RunOnceScheduler} from 'vs/base/common/async';
 import {TPromise} from 'vs/base/common/winjs.base';
-import Schedulers = require('vs/base/common/async');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Modes = require('vs/editor/common/modes');
+import {ILineToken, IModel, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {ILineTokens, IMode} from 'vs/editor/common/modes';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {IRenderLineOutput, renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
 
@@ -20,106 +20,110 @@ export interface IColorizerElementOptions extends IColorizerOptions {
 	mimeType?: string;
 }
 
-export function colorizeElement(modeService:IModeService, domNode:HTMLElement, options:IColorizerElementOptions): TPromise<void> {
-	options = options || {};
-	var theme = options.theme || 'vs';
-	var mimeType = options.mimeType || domNode.getAttribute('lang') || domNode.getAttribute('data-lang');
-	if (!mimeType) {
-		console.error('Mode not detected');
-		return;
-	}
-	var text = domNode.firstChild.nodeValue;
-	domNode.className += 'monaco-editor ' + theme;
-	var render = (str:string) => {
-		domNode.innerHTML = str;
-	};
-	return colorize(modeService, text, mimeType, options).then(render, (err) => console.error(err), render);
-}
+export class Colorizer {
 
-export function colorize(modeService:IModeService, text:string, mimeType:string, options:IColorizerOptions): TPromise<string> {
-	options = options || {};
-	if (typeof options.tabSize === 'undefined') {
-		options.tabSize = 4;
-	}
-
-	var lines = text.split('\n'),
-		c: (v:string)=>void,
-		e: (err:any)=>void,
-		p: (v:string)=>void,
-		isCancelled = false,
-		mode: Modes.IMode;
-
-	var result = new TPromise<string>((_c, _e, _p) => {
-		c = _c;
-		e = _e;
-		p = _p;
-	}, () => {
-		isCancelled = true;
-	});
-
-	var colorize = new Schedulers.RunOnceScheduler(() => {
-		if (isCancelled) {
+	public static colorizeElement(modeService:IModeService, domNode:HTMLElement, options:IColorizerElementOptions): TPromise<void> {
+		options = options || {};
+		var theme = options.theme || 'vs';
+		var mimeType = options.mimeType || domNode.getAttribute('lang') || domNode.getAttribute('data-lang');
+		if (!mimeType) {
+			console.error('Mode not detected');
 			return;
 		}
-		var r = actualColorize(lines, mode, options.tabSize);
-		if (r.retokenize.length > 0) {
-			// There are retokenization requests
-			r.retokenize.forEach((p) => p.then(scheduleColorize));
-			p(r.result);
-		} else {
-			// There are no (more) retokenization requests
-			c(r.result);
-		}
-	}, 0);
-	var scheduleColorize = () => colorize.schedule();
+		var text = domNode.firstChild.nodeValue;
+		domNode.className += 'monaco-editor ' + theme;
+		var render = (str:string) => {
+			domNode.innerHTML = str;
+		};
+		return this.colorize(modeService, text, mimeType, options).then(render, (err) => console.error(err), render);
+	}
 
-	modeService.getOrCreateMode(mimeType).then((_mode) => {
-		if (!_mode) {
-			e('Mode not found: "' + mimeType + '".');
-			return;
-		}
-		if (!_mode.tokenizationSupport) {
-			e('Mode found ("' + _mode.getId() + '"), but does not support tokenization.');
-			return;
+	public static colorize(modeService:IModeService, text:string, mimeType:string, options:IColorizerOptions): TPromise<string> {
+		options = options || {};
+		if (typeof options.tabSize === 'undefined') {
+			options.tabSize = 4;
 		}
-		mode = _mode;
-		scheduleColorize();
-	});
 
-	return result;
-}
+		var lines = text.split('\n'),
+			c: (v:string)=>void,
+			e: (err:any)=>void,
+			p: (v:string)=>void,
+			isCancelled = false,
+			mode: IMode;
+
+		var result = new TPromise<string>((_c, _e, _p) => {
+			c = _c;
+			e = _e;
+			p = _p;
+		}, () => {
+			isCancelled = true;
+		});
 
-export function colorizeLine(line:string, tokens:EditorCommon.ILineToken[], tabSize:number = 4): string {
-	var renderResult = renderLine({
-		lineContent: line,
-		parts: tokens,
-		stopRenderingLineAfter: -1,
-		renderWhitespace: false,
-		tabSize: tabSize
-	});
-	return renderResult.output.join('');
-}
+		var colorize = new RunOnceScheduler(() => {
+			if (isCancelled) {
+				return;
+			}
+			var r = actualColorize(lines, mode, options.tabSize);
+			if (r.retokenize.length > 0) {
+				// There are retokenization requests
+				r.retokenize.forEach((p) => p.then(scheduleColorize));
+				p(r.result);
+			} else {
+				// There are no (more) retokenization requests
+				c(r.result);
+			}
+		}, 0);
+		var scheduleColorize = () => colorize.schedule();
+
+		modeService.getOrCreateMode(mimeType).then((_mode) => {
+			if (!_mode) {
+				e('Mode not found: "' + mimeType + '".');
+				return;
+			}
+			if (!_mode.tokenizationSupport) {
+				e('Mode found ("' + _mode.getId() + '"), but does not support tokenization.');
+				return;
+			}
+			mode = _mode;
+			scheduleColorize();
+		});
+
+		return result;
+	}
+
+	public static colorizeLine(line:string, tokens:ILineToken[], tabSize:number = 4): string {
+		var renderResult = renderLine({
+			lineContent: line,
+			parts: tokens,
+			stopRenderingLineAfter: -1,
+			renderWhitespace: false,
+			tabSize: tabSize
+		});
+		return renderResult.output.join('');
+	}
 
-export function colorizeModelLine(model:EditorCommon.IModel, lineNumber:number, tabSize:number = 4): string {
-	var content = model.getLineContent(lineNumber);
-	var tokens = model.getLineTokens(lineNumber, false);
-	var inflatedTokens = EditorCommon.LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
-	return colorizeLine(content, inflatedTokens, tabSize);
+	public static colorizeModelLine(model:IModel, lineNumber:number, tabSize:number = 4): string {
+		var content = model.getLineContent(lineNumber);
+		var tokens = model.getLineTokens(lineNumber, false);
+		var inflatedTokens = LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
+		return this.colorizeLine(content, inflatedTokens, tabSize);
+	}
 }
 
+
 interface IActualColorizeResult {
 	result:string;
 	retokenize:TPromise<void>[];
 }
 
-function actualColorize(lines:string[], mode:Modes.IMode, tabSize:number): IActualColorizeResult {
+function actualColorize(lines:string[], mode:IMode, tabSize:number): IActualColorizeResult {
 	var tokenization = mode.tokenizationSupport,
 		html:string[] = [],
 		state = tokenization.getInitialState(),
 		i:number,
 		length:number,
 		line: string,
-		tokenizeResult: Modes.ILineTokens,
+		tokenizeResult: ILineTokens,
 		renderResult: IRenderLineOutput,
 		retokenize: TPromise<void>[] = [];
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/simpleServices.ts
code:
@@ -4,63 +4,63 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {TPromise} from 'vs/base/common/winjs.base';
-import Errors = require('vs/base/common/errors');
-import Network = require('vs/base/common/network');
-import EventEmitter = require('vs/base/common/eventEmitter');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {toErrorMessage} from 'vs/base/common/errors';
+import {EventEmitter} from 'vs/base/common/eventEmitter';
+import {IDisposable} from 'vs/base/common/lifecycle';
+import {Schemas} from 'vs/base/common/network';
 import Severity from 'vs/base/common/severity';
-import Lifecycle = require('vs/base/common/lifecycle');
-import KeybindingService = require('vs/platform/keybinding/browser/keybindingServiceImpl');
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IEditor, IEditorInput, IEditorOptions, IEditorService, IResourceInput, ITextEditorModel, Position} from 'vs/platform/editor/common/editor';
+import {KeybindingService} from 'vs/platform/keybinding/browser/keybindingServiceImpl';
+import {IOSupport} from 'vs/platform/keybinding/common/keybindingResolver';
+import {ICommandHandler, ICommandsMap, IKeybindingItem} from 'vs/platform/keybinding/common/keybindingService';
+import {IConfirmation, IMessageService} from 'vs/platform/message/common/message';
+import {AbstractPluginService, ActivatedPlugin} from 'vs/platform/plugins/common/abstractPluginService';
+import {IPluginDescription} from 'vs/platform/plugins/common/plugins';
 import {BaseRequestService} from 'vs/platform/request/common/baseRequestService';
-import {IEditorInput, IEditorService, IEditorOptions, Position, IEditor, IResourceInput, ITextEditorModel} from 'vs/platform/editor/common/editor';
-import {IMessageService, IConfirmation} from 'vs/platform/message/common/message';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
-import {IKeybindingItem, ICommandHandler, ICommandsMap} from 'vs/platform/keybinding/common/keybindingService';
-import {AbstractPluginService, ActivatedPlugin} from 'vs/platform/plugins/common/abstractPluginService';
-import {IOSupport} from 'vs/platform/keybinding/common/keybindingResolver';
-import {IPluginDescription} from 'vs/platform/plugins/common/plugins';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ICodeEditor, IDiffEditor} from 'vs/editor/browser/editorBrowser';
 
 export class SimpleEditor implements IEditor {
 
 	public input:IEditorInput;
 	public options:IEditorOptions;
 	public position:Position;
 
-	public _widget:EditorCommon.IEditor;
+	public _widget:editorCommon.IEditor;
 
-	constructor(editor:EditorCommon.IEditor) {
+	constructor(editor:editorCommon.IEditor) {
 		this._widget = editor;
 	}
 
 	public getId():string { return 'editor'; }
-	public getControl():EditorCommon.IEditor { return this._widget; }
-	public getSelection():EditorCommon.IEditorSelection { return this._widget.getSelection(); }
+	public getControl():editorCommon.IEditor { return this._widget; }
+	public getSelection():editorCommon.IEditorSelection { return this._widget.getSelection(); }
 	public focus():void { this._widget.focus(); }
 
-	public withTypedEditor<T>(codeEditorCallback:(editor:EditorBrowser.ICodeEditor)=>T, diffEditorCallback:(editor:EditorBrowser.IDiffEditor)=>T): T {
-		if (this._widget.getEditorType() === EditorCommon.EditorType.ICodeEditor) {
+	public withTypedEditor<T>(codeEditorCallback:(editor:ICodeEditor)=>T, diffEditorCallback:(editor:IDiffEditor)=>T): T {
+		if (this._widget.getEditorType() === editorCommon.EditorType.ICodeEditor) {
 			// Single Editor
-			return codeEditorCallback(<EditorBrowser.ICodeEditor>this._widget);
+			return codeEditorCallback(<ICodeEditor>this._widget);
 		} else {
 			// Diff Editor
-			return diffEditorCallback(<EditorBrowser.IDiffEditor>this._widget);
+			return diffEditorCallback(<IDiffEditor>this._widget);
 		}
 	}
 }
 
-export class SimpleModel extends EventEmitter.EventEmitter implements ITextEditorModel  {
+export class SimpleModel extends EventEmitter implements ITextEditorModel  {
 
-	private model:EditorCommon.IModel;
+	private model:editorCommon.IModel;
 
-	constructor(model:EditorCommon.IModel) {
+	constructor(model:editorCommon.IModel) {
 		super();
 		this.model = model;
 	}
 
-	public get textEditorModel():EditorCommon.IModel {
+	public get textEditorModel():editorCommon.IModel {
 		return this.model;
 	}
 }
@@ -79,7 +79,7 @@ export class SimpleEditorService implements IEditorService {
 		this.openEditorDelegate = null;
 	}
 
-	public setEditor(editor:EditorCommon.IEditor): void {
+	public setEditor(editor:editorCommon.IEditor): void {
 		this.editor = new SimpleEditor(editor);
 	}
 
@@ -97,7 +97,7 @@ export class SimpleEditorService implements IEditorService {
 		));
 	}
 
-	private doOpenEditor(editor:EditorCommon.ICommonCodeEditor, data:IResourceInput): IEditor {
+	private doOpenEditor(editor:editorCommon.ICommonCodeEditor, data:IResourceInput): IEditor {
 		var model = this.findModel(editor, data);
 		if (!model) {
 			if (data.resource) {
@@ -106,7 +106,7 @@ export class SimpleEditorService implements IEditorService {
 					return null;
 				} else {
 					var schema = data.resource.scheme;
-					if (schema === Network.schemas.http || schema === Network.schemas.https) {
+					if (schema === Schemas.http || schema === Schemas.https) {
 						// This is a fully qualified http or https URL
 						window.open(data.resource.toString());
 						return this.editor;
@@ -117,7 +117,7 @@ export class SimpleEditorService implements IEditorService {
 		}
 
 
-		var selection = <EditorCommon.IRange>data.options.selection;
+		var selection = <editorCommon.IRange>data.options.selection;
 		if (selection) {
 			if (typeof selection.endLineNumber === 'number' && typeof selection.endColumn === 'number') {
 				editor.setSelection(selection);
@@ -135,7 +135,7 @@ export class SimpleEditorService implements IEditorService {
 		return this.editor;
 	}
 
-	private findModel(editor:EditorCommon.ICommonCodeEditor, data:IResourceInput): EditorCommon.IModel {
+	private findModel(editor:editorCommon.ICommonCodeEditor, data:IResourceInput): editorCommon.IModel {
 		var model = editor.getModel();
 		if(model.getAssociatedResource().toString() !== data.resource.toString()) {
 			return null;
@@ -145,7 +145,7 @@ export class SimpleEditorService implements IEditorService {
 	}
 
 	public resolveEditorModel(typedData: IResourceInput, refresh?: boolean): TPromise<ITextEditorModel> {
-		var model: EditorCommon.IModel;
+		var model: editorCommon.IModel;
 
 		model = this.editor.withTypedEditor(
 			(editor) => this.findModel(editor, typedData),
@@ -169,7 +169,7 @@ export class SimpleMessageService implements IMessageService {
 
 		switch(sev) {
 			case Severity.Error:
-				console.error(Errors.toErrorMessage(message, true));
+				console.error(toErrorMessage(message, true));
 				break;
 			case Severity.Warning:
 				console.warn(message);
@@ -195,7 +195,7 @@ export class SimpleMessageService implements IMessageService {
 		return window.confirm(messageText);
 	}
 
-	public setStatusMessage(message: string, autoDisposeAfter:number = -1): Lifecycle.IDisposable {
+	public setStatusMessage(message: string, autoDisposeAfter:number = -1): IDisposable {
 		return {
 			dispose: () => { /* Nothing to do here */ }
 		};
@@ -209,7 +209,7 @@ export class SimpleEditorRequestService extends BaseRequestService {
 	}
 }
 
-export class StandaloneKeybindingService extends KeybindingService.KeybindingService {
+export class StandaloneKeybindingService extends KeybindingService {
 	private static LAST_GENERATED_ID = 0;
 
 	private _dynamicKeybindings: IKeybindingItem[];

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/standaloneCodeEditor.ts
code:
@@ -5,63 +5,62 @@
 
 'use strict';
 
-import {TPromise} from 'vs/base/common/winjs.base';
-import CodeEditorWidget = require('vs/editor/browser/widget/codeEditorWidget');
-import SimpleServices = require('vs/editor/browser/standalone/simpleServices');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Modes = require('vs/editor/common/modes');
-import standaloneServices = require('vs/editor/browser/standalone/standaloneServices');
+import {IJSONSchema} from 'vs/base/common/jsonSchema';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
 import URI from 'vs/base/common/uri';
-import Lifecycle = require('vs/base/common/lifecycle');
-import MonarchTypes = require('vs/editor/common/modes/monarch/monarchTypes');
-import InstantiationService = require('vs/platform/instantiation/common/instantiationService');
-import DiffEditorWidget = require('vs/editor/browser/widget/diffEditorWidget');
-import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
-import {PluginsRegistry} from 'vs/platform/plugins/common/pluginsRegistry';
-import vscode = require('vscode');
-import {RemoteTelemetryServiceHelper} from 'vs/platform/telemetry/common/abstractRemoteTelemetryService';
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IContextViewService} from 'vs/platform/contextview/browser/contextView';
 import {IEditorService} from 'vs/platform/editor/common/editor';
+import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {createInstantiationService} from 'vs/platform/instantiation/common/instantiationService';
+import {Extensions, IJSONContributionRegistry} from 'vs/platform/jsonschemas/common/jsonContributionRegistry';
+import {AbstractKeybindingService} from 'vs/platform/keybinding/browser/keybindingServiceImpl';
+import {ICommandHandler, IKeybindingContextKey, IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
 import {IMarkerService} from 'vs/platform/markers/common/markers';
+import {Registry} from 'vs/platform/platform';
+import {PluginsRegistry} from 'vs/platform/plugins/common/pluginsRegistry';
+import {RemoteTelemetryServiceHelper} from 'vs/platform/telemetry/common/abstractRemoteTelemetryService';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
-import {IKeybindingService, IKeybindingContextKey, ICommandHandler} from 'vs/platform/keybinding/common/keybindingService';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IContextViewService} from 'vs/platform/contextview/browser/contextView';
-import {IModeService} from 'vs/editor/common/services/modeService';
-import {IModelService} from 'vs/editor/common/services/modelService';
-import colorizer = require('vs/editor/browser/standalone/colorizer');
+import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
+import {IActionDescriptor, ICodeEditorWidgetCreationOptions, IDiffEditorOptions, IModel} from 'vs/editor/common/editorCommon';
+import {IMode} from 'vs/editor/common/modes';
 import {ModesRegistry} from 'vs/editor/common/modes/modesRegistry';
-import {Registry} from 'vs/platform/platform';
-import {AbstractKeybindingService} from 'vs/platform/keybinding/browser/keybindingServiceImpl';
+import {ILanguage} from 'vs/editor/common/modes/monarch/monarchTypes';
 import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
-import {IJSONSchema} from 'vs/base/common/jsonSchema';
-import * as JSONContributionRegistry from 'vs/platform/jsonschemas/common/jsonContributionRegistry';
-import {ILanguageExtensionPoint} from 'vs/editor/common/services/modeService';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
+import {IModeService} from 'vs/editor/common/services/modeService';
+import {ILanguageExtensionPoint} from 'vs/editor/common/services/modeService';
+import {IModelService} from 'vs/editor/common/services/modelService';
+import {ICodeEditor, IDiffEditor} from 'vs/editor/browser/editorBrowser';
+import {Colorizer, IColorizerElementOptions, IColorizerOptions} from 'vs/editor/browser/standalone/colorizer';
+import {SimpleEditorService, StandaloneKeybindingService} from 'vs/editor/browser/standalone/simpleServices';
+import {IEditorContextViewService, IEditorOverrideServices, ensureDynamicPlatformServices, ensureStaticPlatformServices, getOrCreateStaticServices} from 'vs/editor/browser/standalone/standaloneServices';
+import {CodeEditorWidget} from 'vs/editor/browser/widget/codeEditorWidget';
+import {DiffEditorWidget} from 'vs/editor/browser/widget/diffEditorWidget';
 
 // Set defaults for standalone editor
 DefaultConfig.editor.wrappingIndent = 'none';
 
-export interface IEditorConstructionOptions extends EditorCommon.ICodeEditorWidgetCreationOptions {
+export interface IEditorConstructionOptions extends ICodeEditorWidgetCreationOptions {
 	value?: string;
 	mode?: string;
 }
-export interface IDiffEditorConstructionOptions extends EditorCommon.IDiffEditorOptions {
+export interface IDiffEditorConstructionOptions extends IDiffEditorOptions {
 }
 
-class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
+class StandaloneEditor extends CodeEditorWidget {
 
 	private _editorService:IEditorService;
-	private _standaloneKeybindingService: SimpleServices.StandaloneKeybindingService;
-	private _contextViewService:standaloneServices.IEditorContextViewService;
+	private _standaloneKeybindingService: StandaloneKeybindingService;
+	private _contextViewService:IEditorContextViewService;
 	private _markerService: IMarkerService;
 	private _ownsModel:boolean;
-	private _toDispose2: Lifecycle.IDisposable[];
+	private _toDispose2: IDisposable[];
 
 	constructor(
 		domElement:HTMLElement,
 		options:IEditorConstructionOptions,
-		toDispose: Lifecycle.IDisposable[],
+		toDispose: IDisposable[],
 		@IInstantiationService instantiationService: IInstantiationService,
 		@ICodeEditorService codeEditorService: ICodeEditorService,
 		@IKeybindingService keybindingService: IKeybindingService,
@@ -74,11 +73,11 @@ class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
 			(<AbstractKeybindingService><any>keybindingService).setInstantiationService(instantiationService);
 		}
 
-		if (keybindingService instanceof SimpleServices.StandaloneKeybindingService) {
-			this._standaloneKeybindingService = <SimpleServices.StandaloneKeybindingService>keybindingService;
+		if (keybindingService instanceof StandaloneKeybindingService) {
+			this._standaloneKeybindingService = <StandaloneKeybindingService>keybindingService;
 		}
 
-		this._contextViewService = <standaloneServices.IEditorContextViewService>contextViewService;
+		this._contextViewService = <IEditorContextViewService>contextViewService;
 		this._editorService = editorService;
 		this._markerService = markerService;
 		this._toDispose2 = toDispose;
@@ -96,7 +95,7 @@ class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
 
 	public dispose(): void {
 		super.dispose();
-		this._toDispose2 = Lifecycle.disposeAll(this._toDispose2);
+		this._toDispose2 = disposeAll(this._toDispose2);
 	}
 
 	public destroy(): void {
@@ -123,7 +122,7 @@ class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
 		return this._standaloneKeybindingService.createKey(key, defaultValue);
 	}
 
-	public addAction(descriptor:EditorCommon.IActionDescriptor): void {
+	public addAction(descriptor:IActionDescriptor): void {
 		super.addAction(descriptor);
 		if (!this._standaloneKeybindingService) {
 			console.warn('Cannot add keybinding because the editor is configured with an unrecognized KeybindingService');
@@ -147,14 +146,14 @@ class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
 		return this._editorService;
 	}
 
-	_attachModel(model:EditorCommon.IModel):void {
+	_attachModel(model:IModel):void {
 		super._attachModel(model);
 		if (this._view) {
 			this._contextViewService.setContainer(this._view.domNode);
 		}
 	}
 
-	_postDetachModelCleanup(detachedModel:EditorCommon.IModel): void {
+	_postDetachModelCleanup(detachedModel:IModel): void {
 		super._postDetachModelCleanup(detachedModel);
 		if (detachedModel && this._ownsModel) {
 			detachedModel.destroy();
@@ -163,19 +162,19 @@ class StandaloneEditor extends CodeEditorWidget.CodeEditorWidget {
 	}
 }
 
-class StandaloneDiffEditor extends DiffEditorWidget.DiffEditorWidget {
+class StandaloneDiffEditor extends DiffEditorWidget {
 
 	private _editorService:IEditorService;
-	private _contextViewService:standaloneServices.IEditorContextViewService;
-	private _standaloneKeybindingService: SimpleServices.StandaloneKeybindingService;
-	private _toDispose2: Lifecycle.IDisposable[];
+	private _contextViewService:IEditorContextViewService;
+	private _standaloneKeybindingService: StandaloneKeybindingService;
+	private _toDispose2: IDisposable[];
 	private _markerService: IMarkerService;
 	private _telemetryService: ITelemetryService;
 
 	constructor(
 		domElement:HTMLElement,
 		options:IDiffEditorConstructionOptions,
-		toDispose: Lifecycle.IDisposable[],
+		toDispose: IDisposable[],
 		@IInstantiationService instantiationService: IInstantiationService,
 		@IKeybindingService keybindingService: IKeybindingService,
 		@IContextViewService contextViewService: IContextViewService,
@@ -188,11 +187,11 @@ class StandaloneDiffEditor extends DiffEditorWidget.DiffEditorWidget {
 			(<AbstractKeybindingService><any>keybindingService).setInstantiationService(instantiationService);
 		}
 
-		if (keybindingService instanceof SimpleServices.StandaloneKeybindingService) {
-			this._standaloneKeybindingService = <SimpleServices.StandaloneKeybindingService>keybindingService;
+		if (keybindingService instanceof StandaloneKeybindingService) {
+			this._standaloneKeybindingService = <StandaloneKeybindingService>keybindingService;
 		}
 
-		this._contextViewService = <standaloneServices.IEditorContextViewService>contextViewService;
+		this._contextViewService = <IEditorContextViewService>contextViewService;
 		this._editorService = editorService;
 		this._markerService = markerService;
 		this._telemetryService = telemetryService;
@@ -208,7 +207,7 @@ class StandaloneDiffEditor extends DiffEditorWidget.DiffEditorWidget {
 
 	public dispose(): void {
 		super.dispose();
-		this._toDispose2 = Lifecycle.disposeAll(this._toDispose2);
+		this._toDispose2 = disposeAll(this._toDispose2);
 	}
 
 	public destroy(): void {
@@ -235,7 +234,7 @@ class StandaloneDiffEditor extends DiffEditorWidget.DiffEditorWidget {
 		return this._standaloneKeybindingService.createKey(key, defaultValue);
 	}
 
-	public addAction(descriptor:EditorCommon.IActionDescriptor): void {
+	public addAction(descriptor:IActionDescriptor): void {
 		super.addAction(descriptor);
 		if (!this._standaloneKeybindingService) {
 			console.warn('Cannot add keybinding because the editor is configured with an unrecognized KeybindingService');
@@ -267,13 +266,13 @@ var startup = (function() {
 				return;
 			}
 			modesRegistryInitialized = true;
-			var staticServices = standaloneServices.getOrCreateStaticServices();
+			var staticServices = getOrCreateStaticServices();
 
 			// Instantiate thread actors
 			staticServices.threadService.getRemotable(RemoteTelemetryServiceHelper);
 		},
 
-		setupServices: function(services: standaloneServices.IEditorOverrideServices): standaloneServices.IEditorOverrideServices {
+		setupServices: function(services: IEditorOverrideServices): IEditorOverrideServices {
 			if (setupServicesCalled) {
 				console.error('Call to Monaco.Editor.setupServices is ignored because it was called before');
 				return;
@@ -284,7 +283,7 @@ var startup = (function() {
 				return;
 			}
 
-			return standaloneServices.ensureStaticPlatformServices(services);
+			return ensureStaticPlatformServices(services);
 		}
 	};
 
@@ -304,13 +303,13 @@ function shallowClone<T>(obj:T): T {
 
 export var setupServices = startup.setupServices;
 
-export function create(domElement:HTMLElement, options:IEditorConstructionOptions, services:standaloneServices.IEditorOverrideServices):EditorBrowser.ICodeEditor {
+export function create(domElement:HTMLElement, options:IEditorConstructionOptions, services:IEditorOverrideServices):ICodeEditor {
 	startup.initStaticServicesIfNecessary();
 
 	services = shallowClone(services);
-	var editorService: SimpleServices.SimpleEditorService = null;
+	var editorService: SimpleEditorService = null;
 	if (!services || !services.editorService) {
-		editorService = new SimpleServices.SimpleEditorService();
+		editorService = new SimpleEditorService();
 		services.editorService = editorService;
 	}
 
@@ -324,13 +323,13 @@ export function create(domElement:HTMLElement, options:IEditorConstructionOption
 	return result;
 }
 
-export function createDiffEditor(domElement:HTMLElement, options:IDiffEditorConstructionOptions, services: standaloneServices.IEditorOverrideServices):EditorBrowser.IDiffEditor {
+export function createDiffEditor(domElement:HTMLElement, options:IDiffEditorConstructionOptions, services: IEditorOverrideServices):IDiffEditor {
 	startup.initStaticServicesIfNecessary();
 
 	services = shallowClone(services);
-	var editorService: SimpleServices.SimpleEditorService = null;
+	var editorService: SimpleEditorService = null;
 	if (!services || !services.editorService) {
-		editorService = new SimpleServices.SimpleEditorService();
+		editorService = new SimpleEditorService();
 		services.editorService = editorService;
 	}
 
@@ -344,18 +343,18 @@ export function createDiffEditor(domElement:HTMLElement, options:IDiffEditorCons
 	return result;
 }
 
-function prepareServices(domElement: HTMLElement, services: standaloneServices.IEditorOverrideServices): { ctx: standaloneServices.IEditorOverrideServices; toDispose: Lifecycle.IDisposable[]; } {
-	services = standaloneServices.ensureStaticPlatformServices(services);
-	var toDispose = standaloneServices.ensureDynamicPlatformServices(domElement, services);
-	services.instantiationService = InstantiationService.create(services);
+function prepareServices(domElement: HTMLElement, services: IEditorOverrideServices): { ctx: IEditorOverrideServices; toDispose: IDisposable[]; } {
+	services = ensureStaticPlatformServices(services);
+	var toDispose = ensureDynamicPlatformServices(domElement, services);
+	services.instantiationService = createInstantiationService(services);
 
 	return {
 		ctx: services,
 		toDispose: toDispose
 	};
 }
 
-function createModelWithRegistryMode(modelService:IModelService, modeService:IModeService, value:string, modeName:string, associatedResource?:URI): EditorCommon.IModel {
+function createModelWithRegistryMode(modelService:IModelService, modeService:IModeService, value:string, modeName:string, associatedResource?:URI): IModel {
 	var modeInformation = modeService.lookup(modeName);
 	if (modeInformation.length > 0) {
 		// Force usage of the first existing mode
@@ -371,9 +370,9 @@ function createModelWithRegistryMode(modelService:IModelService, modeService:IMo
 	return modelService.createModel(value, modeService.getOrCreateMode(modeName), associatedResource);
 }
 
-export function createModel(value:string, mode:string|MonarchTypes.ILanguage|Modes.IMode, associatedResource?:URI|string): EditorCommon.IModel {
+export function createModel(value:string, mode:string|ILanguage|IMode, associatedResource?:URI|string): IModel {
 	startup.initStaticServicesIfNecessary();
-	var modelService = standaloneServices.ensureStaticPlatformServices(null).modelService;
+	var modelService = ensureStaticPlatformServices(null).modelService;
 
 	var resource:URI;
 	if (typeof associatedResource === 'string') {
@@ -383,31 +382,31 @@ export function createModel(value:string, mode:string|MonarchTypes.ILanguage|Mod
 		resource = associatedResource;
 	}
 
-	if (typeof (<Modes.IMode>mode).getId === 'function') {
+	if (typeof (<IMode>mode).getId === 'function') {
 		// mode is an IMode
-		return modelService.createModel(value, <Modes.IMode>mode, resource);
+		return modelService.createModel(value, <IMode>mode, resource);
 	}
 
 	if (typeof mode === 'string') {
 		// mode is a string
-		var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
+		var modeService = ensureStaticPlatformServices(null).modeService;
 		return createModelWithRegistryMode(modelService, modeService, value, mode, resource);
 	}
 
 	// mode must be an ILanguage
-	return modelService.createModel(value, createCustomMode(<MonarchTypes.ILanguage>mode), resource);
+	return modelService.createModel(value, createCustomMode(<ILanguage>mode), resource);
 }
 
-export function getOrCreateMode(mimetypes: string):TPromise<Modes.IMode> {
+export function getOrCreateMode(mimetypes: string):TPromise<IMode> {
 	startup.initStaticServicesIfNecessary();
-	var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
+	var modeService = ensureStaticPlatformServices(null).modeService;
 
 	return modeService.getOrCreateMode(mimetypes);
 }
 
 export function configureMode(modeId: string, options: any): void {
 	startup.initStaticServicesIfNecessary();
-	var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
+	var modeService = ensureStaticPlatformServices(null).modeService;
 
 	modeService.configureModeById(modeId, options);
 }
@@ -416,25 +415,27 @@ export function registerWorkerParticipant(modeId:string, moduleName:string, ctor
 	ModesRegistry.registerWorkerParticipant(modeId, moduleName, ctorName);
 }
 
-export function getAPI(): typeof vscode {
+export function createCustomMode(language:ILanguage): TPromise<IMode> {
 	startup.initStaticServicesIfNecessary();
-	return require('vscode');
-}
+	let staticPlatformServices = ensureStaticPlatformServices(null);
+	let modeService = staticPlatformServices.modeService;
+	let modelService = staticPlatformServices.modelService;
+	let editorWorkerService = staticPlatformServices.editorWorkerService;
 
-export function createCustomMode(language:MonarchTypes.ILanguage): TPromise<Modes.IMode> {
-	startup.initStaticServicesIfNecessary();
-	var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
-
-	var modeId = language.name;
-	var name = language.name;
+	let modeId = language.name;
+	let name = language.name;
 
 	ModesRegistry.registerLanguage({
 		id: modeId,
 		aliases: [name]
 	});
 
-	PluginsRegistry.registerOneTimeActivationEventListener('onLanguage:' + modeId, () => {
-		modeService.registerMonarchDefinition(modeId, language);
+	let disposable = modeService.onDidCreateMode((mode) => {
+		if (mode.getId() !== modeId) {
+			return;
+		}
+		modeService.registerMonarchDefinition(modelService, editorWorkerService, modeId, language);
+		disposable.dispose();
 	});
 
 	return modeService.getOrCreateMode(modeId);
@@ -444,34 +445,38 @@ export function registerStandaloneLanguage(language:ILanguageExtensionPoint, def
 	ModesRegistry.registerLanguage(language);
 
 	PluginsRegistry.registerOneTimeActivationEventListener('onLanguage:' + language.id, () => {
-		require([defModule], (value:{language:MonarchTypes.ILanguage}) => {
+		require([defModule], (value:{language:ILanguage}) => {
 			if (!value.language) {
 				console.error('Expected ' + defModule + ' to export a `language`');
 				return;
 			}
 
 			startup.initStaticServicesIfNecessary();
-			var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
-			modeService.registerMonarchDefinition(language.id, value.language);
+			let staticPlatformServices = ensureStaticPlatformServices(null);
+			let modeService = staticPlatformServices.modeService;
+			let modelService = staticPlatformServices.modelService;
+			let editorWorkerService = staticPlatformServices.editorWorkerService;
+
+			modeService.registerMonarchDefinition(modelService, editorWorkerService, language.id, value.language);
 		}, (err) => {
 			console.error('Cannot find module ' + defModule, err);
 		});
 	});
 }
 
 export function registerStandaloneSchema(uri:string, schema:IJSONSchema) {
-	let schemaRegistry = <JSONContributionRegistry.IJSONContributionRegistry>Registry.as(JSONContributionRegistry.Extensions.JSONContribution);
+	let schemaRegistry = <IJSONContributionRegistry>Registry.as(Extensions.JSONContribution);
 	schemaRegistry.registerSchema(uri, schema);
 }
 
-export function colorizeElement(domNode:HTMLElement, options:colorizer.IColorizerElementOptions): TPromise<void> {
+export function colorizeElement(domNode:HTMLElement, options:IColorizerElementOptions): TPromise<void> {
 	startup.initStaticServicesIfNecessary();
-	var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
-	return colorizer.colorizeElement(modeService, domNode, options);
+	var modeService = ensureStaticPlatformServices(null).modeService;
+	return Colorizer.colorizeElement(modeService, domNode, options);
 }
 
-export function colorize(text:string, mimeType:string, options:colorizer.IColorizerOptions): TPromise<string> {
+export function colorize(text:string, mimeType:string, options:IColorizerOptions): TPromise<string> {
 	startup.initStaticServicesIfNecessary();
-	var modeService = standaloneServices.ensureStaticPlatformServices(null).modeService;
-	return colorizer.colorize(modeService, text, mimeType, options);
+	var modeService = ensureStaticPlatformServices(null).modeService;
+	return Colorizer.colorize(modeService, text, mimeType, options);
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/standaloneEditor.ts
code:
@@ -6,13 +6,12 @@
 
 import 'vs/editor/standalone-languages/all';
 import './standaloneSchemas';
-
-import Colorizer = require('vs/editor/browser/standalone/colorizer');
-import standaloneCodeEditor = require('vs/editor/browser/standalone/standaloneCodeEditor');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import {ILanguageDef} from 'vs/editor/standalone-languages/types';
 import {IJSONSchema} from 'vs/base/common/jsonSchema';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ClassNames, ContentWidgetPositionPreference, OverlayWidgetPositionPreference} from 'vs/editor/browser/editorBrowser';
+import {Colorizer} from 'vs/editor/browser/standalone/colorizer';
+import * as standaloneCodeEditor from 'vs/editor/browser/standalone/standaloneCodeEditor';
+import {ILanguageDef} from 'vs/editor/standalone-languages/types';
 
 var global:any = self;
 if (!global.Monaco) {
@@ -23,7 +22,6 @@ if (!Monaco.Editor) {
 	Monaco.Editor = {};
 }
 Monaco.Editor.setupServices = standaloneCodeEditor.setupServices;
-Monaco.Editor.getAPI = standaloneCodeEditor.getAPI;
 Monaco.Editor.create = standaloneCodeEditor.create;
 Monaco.Editor.createModel = standaloneCodeEditor.createModel;
 Monaco.Editor.createDiffEditor = standaloneCodeEditor.createDiffEditor;
@@ -37,33 +35,33 @@ Monaco.Editor.colorizeLine = Colorizer.colorizeLine;
 Monaco.Editor.colorizeModelLine = Colorizer.colorizeModelLine;
 
 // -- export common constants
-Monaco.Editor.SelectionDirection = EditorCommon.SelectionDirection;
-Monaco.Editor.WrappingIndent = EditorCommon.WrappingIndent;
-Monaco.Editor.wrappingIndentFromString = EditorCommon.wrappingIndentFromString;
-Monaco.Editor.OverviewRulerLane = EditorCommon.OverviewRulerLane;
-Monaco.Editor.EndOfLinePreference = EditorCommon.EndOfLinePreference;
-Monaco.Editor.EndOfLineSequence = EditorCommon.EndOfLineSequence;
-Monaco.Editor.LineTokensBinaryEncoding = EditorCommon.LineTokensBinaryEncoding;
-Monaco.Editor.TrackedRangeStickiness = EditorCommon.TrackedRangeStickiness;
-Monaco.Editor.VerticalRevealType = EditorCommon.VerticalRevealType;
-Monaco.Editor.MouseTargetType = EditorCommon.MouseTargetType;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS = EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_FOCUS = EditorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS = EditorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS = EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION = EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION;
-Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID = EditorCommon.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID;
-Monaco.Editor.ViewEventNames = EditorCommon.ViewEventNames;
-Monaco.Editor.CodeEditorStateFlag = EditorCommon.CodeEditorStateFlag;
-Monaco.Editor.EditorType = EditorCommon.EditorType;
-Monaco.Editor.ClassName = EditorCommon.ClassName;
-Monaco.Editor.EventType = EditorCommon.EventType;
-Monaco.Editor.Handler = EditorCommon.Handler;
+Monaco.Editor.SelectionDirection = editorCommon.SelectionDirection;
+Monaco.Editor.WrappingIndent = editorCommon.WrappingIndent;
+Monaco.Editor.wrappingIndentFromString = editorCommon.wrappingIndentFromString;
+Monaco.Editor.OverviewRulerLane = editorCommon.OverviewRulerLane;
+Monaco.Editor.EndOfLinePreference = editorCommon.EndOfLinePreference;
+Monaco.Editor.EndOfLineSequence = editorCommon.EndOfLineSequence;
+Monaco.Editor.LineTokensBinaryEncoding = editorCommon.LineTokensBinaryEncoding;
+Monaco.Editor.TrackedRangeStickiness = editorCommon.TrackedRangeStickiness;
+Monaco.Editor.VerticalRevealType = editorCommon.VerticalRevealType;
+Monaco.Editor.MouseTargetType = editorCommon.MouseTargetType;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS = editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_FOCUS = editorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS = editorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS = editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION = editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION;
+Monaco.Editor.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID = editorCommon.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID;
+Monaco.Editor.ViewEventNames = editorCommon.ViewEventNames;
+Monaco.Editor.CodeEditorStateFlag = editorCommon.CodeEditorStateFlag;
+Monaco.Editor.EditorType = editorCommon.EditorType;
+Monaco.Editor.ClassName = editorCommon.ClassName;
+Monaco.Editor.EventType = editorCommon.EventType;
+Monaco.Editor.Handler = editorCommon.Handler;
 
 // -- export browser constants
-Monaco.Editor.ClassNames = EditorBrowser.ClassNames;
-Monaco.Editor.ContentWidgetPositionPreference = EditorBrowser.ContentWidgetPositionPreference;
-Monaco.Editor.OverlayWidgetPositionPreference = EditorBrowser.OverlayWidgetPositionPreference;
+Monaco.Editor.ClassNames = ClassNames;
+Monaco.Editor.ContentWidgetPositionPreference = ContentWidgetPositionPreference;
+Monaco.Editor.OverlayWidgetPositionPreference = OverlayWidgetPositionPreference;
 
 // Register all built-in standalone languages
 let MonacoEditorLanguages: ILanguageDef[] = this.MonacoEditorLanguages || [];

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/standaloneSchemas.ts
code:
@@ -5,7 +5,7 @@
 
 'use strict';
 
-import nls = require('vs/nls');
+import * as nls from 'vs/nls';
 import {IJSONSchema} from 'vs/base/common/jsonSchema';
 
 this.MonacoEditorSchemas = this.MonacoEditorSchemas || {};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/standalone/standaloneServices.ts
code:
@@ -4,43 +4,43 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {ModelServiceImpl} from 'vs/editor/common/services/modelServiceImpl';
-import InstantiationService = require('vs/platform/instantiation/common/instantiationService');
-import mainThreadService = require('vs/platform/thread/common/mainThreadService');
-import MarkerService = require('vs/platform/markers/common/markerService');
-import Env = require('vs/base/common/flags');
+import * as flags from 'vs/base/common/flags';
+import {IDisposable} from 'vs/base/common/lifecycle';
 import URI from 'vs/base/common/uri';
-import MainTelemetryService = require('vs/platform/telemetry/browser/mainTelemetryService');
-import SimpleServices = require('vs/editor/browser/standalone/simpleServices');
-import Lifecycle = require('vs/base/common/lifecycle');
-import ContextViewService = require('vs/platform/contextview/browser/contextViewService');
-import ContextMenuService = require('vs/platform/contextview/browser/contextMenuService');
-import {BaseWorkspaceContextService} from 'vs/platform/workspace/common/baseWorkspaceContextService';
-import _eventService = require('vs/platform/event/common/eventService');
-import {CodeEditorServiceImpl} from 'vs/editor/browser/services/codeEditorServiceImpl';
-import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
-import {EditorWorkerServiceImpl} from 'vs/editor/common/services/editorWorkerServiceImpl';
-import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
-import {IModelService} from 'vs/editor/common/services/modelService';
-import {IStorageService} from 'vs/platform/storage/common/storage';
 import {IConfigurationService} from 'vs/platform/configuration/common/configuration';
-import {IContextViewService, IContextMenuService} from 'vs/platform/contextview/browser/contextView';
+import {ContextMenuService} from 'vs/platform/contextview/browser/contextMenuService';
+import {IContextMenuService, IContextViewService} from 'vs/platform/contextview/browser/contextView';
+import {ContextViewService} from 'vs/platform/contextview/browser/contextViewService';
 import {IEditorService} from 'vs/platform/editor/common/editor';
 import {IEventService} from 'vs/platform/event/common/event';
+import {EventService} from 'vs/platform/event/common/eventService';
 import {IFileService} from 'vs/platform/files/common/files';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {createInstantiationService} from 'vs/platform/instantiation/common/instantiationService';
+import {IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
+import {MainProcessMarkerService} from 'vs/platform/markers/common/markerService';
 import {IMarkerService} from 'vs/platform/markers/common/markers';
 import {IMessageService} from 'vs/platform/message/common/message';
+import {IPluginService} from 'vs/platform/plugins/common/plugins';
 import {IProgressService} from 'vs/platform/progress/common/progress';
 import {IRequestService} from 'vs/platform/request/common/request';
 import {ISearchService} from 'vs/platform/search/common/search';
+import {IStorageService} from 'vs/platform/storage/common/storage';
+import {MainTelemetryService} from 'vs/platform/telemetry/browser/mainTelemetryService';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {MainThreadService} from 'vs/platform/thread/common/mainThreadService';
 import {IThreadService} from 'vs/platform/thread/common/thread';
+import {BaseWorkspaceContextService} from 'vs/platform/workspace/common/baseWorkspaceContextService';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
-import {IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
-import {IPluginService} from 'vs/platform/plugins/common/plugins';
+import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
+import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
+import {EditorWorkerServiceImpl} from 'vs/editor/common/services/editorWorkerServiceImpl';
 import {IModeService} from 'vs/editor/common/services/modeService';
 import {MainThreadModeServiceImpl} from 'vs/editor/common/services/modeServiceImpl';
+import {IModelService} from 'vs/editor/common/services/modelService';
+import {ModelServiceImpl} from 'vs/editor/common/services/modelServiceImpl';
+import {CodeEditorServiceImpl} from 'vs/editor/browser/services/codeEditorServiceImpl';
+import {SimpleEditorRequestService, SimpleMessageService, SimplePluginService, StandaloneKeybindingService} from 'vs/editor/browser/standalone/simpleServices';
 
 export interface IEditorContextViewService extends IContextViewService {
 	dispose(): void;
@@ -122,22 +122,22 @@ export function ensureStaticPlatformServices(services: IEditorOverrideServices):
 	return services;
 }
 
-export function ensureDynamicPlatformServices(domElement:HTMLElement, services: IEditorOverrideServices): Lifecycle.IDisposable[] {
-	var r:Lifecycle.IDisposable[] = [];
+export function ensureDynamicPlatformServices(domElement:HTMLElement, services: IEditorOverrideServices): IDisposable[] {
+	var r:IDisposable[] = [];
 
 	if (typeof services.keybindingService === 'undefined') {
-		var keybindingService = new SimpleServices.StandaloneKeybindingService(domElement);
+		var keybindingService = new StandaloneKeybindingService(domElement);
 		r.push(keybindingService);
 		services.keybindingService = keybindingService;
 	}
 
 	if (typeof services.contextViewService === 'undefined') {
-		var contextViewService = new ContextViewService.ContextViewService(domElement, services.telemetryService, services.messageService);
+		var contextViewService = new ContextViewService(domElement, services.telemetryService, services.messageService);
 		r.push(contextViewService);
 		services.contextViewService = contextViewService;
 	}
 	if (typeof services.contextMenuService === 'undefined') {
-		var contextMenuService = new ContextMenuService.ContextMenuService(domElement, services.telemetryService, services.messageService, contextViewService);
+		var contextMenuService = new ContextMenuService(domElement, services.telemetryService, services.messageService, contextViewService);
 		r.push(contextMenuService);
 		services.contextMenuService = contextMenuService;
 	}
@@ -153,9 +153,9 @@ export function getOrCreateStaticServices(services?: IEditorOverrideServices): I
 	}
 	services = services || {};
 
-	var contextService = services.contextService;
+	let contextService = services.contextService;
 	if (!contextService) {
-		var workspaceUri = URI.create('inmemory', 'model', '/');
+		let workspaceUri = URI.create('inmemory', 'model', '/');
 		contextService = new BaseWorkspaceContextService({
 			resource: workspaceUri,
 			id: null,
@@ -165,42 +165,30 @@ export function getOrCreateStaticServices(services?: IEditorOverrideServices): I
 		}, {});
 	}
 
-	var telemetryService = services.telemetryService;
+	let telemetryService = services.telemetryService;
 
 	if (!telemetryService) {
 		let config = contextService.getConfiguration();
 		let enableTelemetry = config && config.env ? !!config.env.enableTelemetry: false;
-		telemetryService = new MainTelemetryService.MainTelemetryService({enableTelemetry: enableTelemetry});
+		telemetryService = new MainTelemetryService({enableTelemetry: enableTelemetry});
 	}
 
 
 	// warn the user that standaloneEdiktorTelemetryEndpint is absolete
-	if (Env.standaloneEditorTelemetryEndpoint) {
+	if (flags.standaloneEditorTelemetryEndpoint) {
 		console.warn('standaloneEditorTelemetryEndpoint is obsolete');
 	}
 
-	var threadService = services.threadService;
-	if (!threadService) {
-		threadService = new mainThreadService.MainThreadService(contextService, 'vs/editor/common/worker/editorWorkerServer');
-	}
-
-	var messageService = services.messageService || new SimpleServices.SimpleMessageService();
-	var pluginService = services.pluginService || new SimpleServices.SimplePluginService();
-	var markerService = services.markerService || new MarkerService.MainProcessMarkerService(threadService);
-	var requestService = services.requestService || new SimpleServices.SimpleEditorRequestService(contextService, telemetryService);
-
-	var modelService = services.modelService || new ModelServiceImpl(threadService, markerService);
-
-	var editorWorkerService = services.editorWorkerService || new EditorWorkerServiceImpl(modelService);
-
-	var modeService = services.modeService;
-	if (!modeService) {
-		modeService = new MainThreadModeServiceImpl(threadService, pluginService, modelService, editorWorkerService);
-	}
-
-	var codeEditorService = services.codeEditorService || new CodeEditorServiceImpl();
-
-	var eventService = services.eventService || new _eventService.EventService();
+	let threadService = services.threadService || new MainThreadService(contextService, 'vs/editor/common/worker/editorWorkerServer', 2);
+	let messageService = services.messageService || new SimpleMessageService();
+	let pluginService = services.pluginService || new SimplePluginService();
+	let markerService = services.markerService || new MainProcessMarkerService(threadService);
+	let requestService = services.requestService || new SimpleEditorRequestService(contextService, telemetryService);
+	let modeService = services.modeService || new MainThreadModeServiceImpl(threadService, pluginService);
+	let modelService = services.modelService || new ModelServiceImpl(threadService, markerService, modeService);
+	let editorWorkerService = services.editorWorkerService || new EditorWorkerServiceImpl(modelService);
+	let codeEditorService = services.codeEditorService || new CodeEditorServiceImpl();
+	let eventService = services.eventService || new EventService();
 
 	staticServices = {
 		pluginService: pluginService,
@@ -218,12 +206,12 @@ export function getOrCreateStaticServices(services?: IEditorOverrideServices): I
 		instantiationService: void 0
 	};
 
-	var instantiationService = InstantiationService.create(staticServices);
-	staticServices.instantiationService = InstantiationService.create(staticServices);
-	if (threadService instanceof mainThreadService.MainThreadService) {
+	let instantiationService = createInstantiationService(staticServices);
+	staticServices.instantiationService = createInstantiationService(staticServices);
+	if (threadService instanceof MainThreadService) {
 		threadService.setInstantiationService(instantiationService);
 	}
-	(<MainTelemetryService.MainTelemetryService> telemetryService).setInstantiationService(instantiationService);
+	(<MainTelemetryService> telemetryService).setInstantiationService(instantiationService);
 
 
 	return staticServices;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewController.ts
code:
@@ -4,48 +4,47 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EventEmitter = require('vs/base/common/eventEmitter');
-import DomUtils = require('vs/base/browser/dom');
+import {IEventEmitter} from 'vs/base/common/eventEmitter';
+import {IKeyboardEvent} from 'vs/base/browser/keyboardEvent';
+import {Position} from 'vs/editor/common/core/position';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {Configuration} from 'vs/editor/browser/config/configuration';
+import {IEditorMouseEvent, IViewController} from 'vs/editor/browser/editorBrowser';
 
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import Configuration = require('vs/editor/browser/config/configuration');
-import Position = require('vs/editor/common/core/position');
-import EditorCommon = require('vs/editor/common/editorCommon');
+export class ViewController implements IViewController {
 
-export class ViewController implements EditorBrowser.IViewController {
+	private viewModel:editorCommon.IViewModel;
+	private configuration:Configuration;
+	private outgoingEventBus:IEventEmitter;
 
-	private viewModel:EditorCommon.IViewModel;
-	private configuration:Configuration.Configuration;
-	private outgoingEventBus:EventEmitter.IEventEmitter;
-
-	constructor(viewModel:EditorCommon.IViewModel, configuration:Configuration.Configuration, outgoingEventBus:EventEmitter.IEventEmitter) {
+	constructor(viewModel:editorCommon.IViewModel, configuration:Configuration, outgoingEventBus:IEventEmitter) {
 		this.viewModel = viewModel;
 		this.configuration = configuration;
 		this.outgoingEventBus = outgoingEventBus;
 	}
 
 	public paste(source:string, text:string, pasteOnNewLine:boolean): void {
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.Paste, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.Paste, {
 			text: text,
 			pasteOnNewLine: pasteOnNewLine,
 		});
 	}
 
 	public type(source:string, text:string): void {
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.Type, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.Type, {
 			text: text
 		});
 	}
 
 	public replacePreviousChar(source: string, text: string, replaceCharCnt:number): void {
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.ReplacePreviousChar, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.ReplacePreviousChar, {
 			text: text,
 			replaceCharCnt: replaceCharCnt
 		});
 	}
 
 	public cut(source:string): void {
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.Cut, null);
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.Cut, null);
 	}
 
 	private _validateViewColumn(lineNumber: number, column: number): number {
@@ -58,108 +57,108 @@ export class ViewController implements EditorBrowser.IViewController {
 
 	public moveTo(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.MoveTo, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.MoveTo, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public moveToSelect(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.MoveToSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.MoveToSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public createCursor(source:string, lineNumber:number, column:number, wholeLine:boolean): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.CreateCursor, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.CreateCursor, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column),
+			viewPosition: new Position(lineNumber, column),
 			wholeLine: wholeLine
 		});
 	}
 
 	public lastCursorMoveToSelect(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LastCursorMoveToSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LastCursorMoveToSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public wordSelect(source:string, lineNumber:number, column:number, preference:string): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.WordSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.WordSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
 			preference: preference
 		});
 	}
 
 	public wordSelectDrag(source:string, lineNumber:number, column:number, preference:string): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.WordSelectDrag, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.WordSelectDrag, {
 			position: this.convertViewToModelPosition(lineNumber, column),
 			preference: preference
 		});
 	}
 
 	public lastCursorWordSelect(source:string, lineNumber:number, column:number, preference:string): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LastCursorWordSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LastCursorWordSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
 			preference: preference
 		});
 	}
 
 	public lineSelect(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LineSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LineSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public lineSelectDrag(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LineSelectDrag, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LineSelectDrag, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public lastCursorLineSelect(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LastCursorLineSelect, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LastCursorLineSelect, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public lastCursorLineSelectDrag(source:string, lineNumber:number, column:number): void {
 		column = this._validateViewColumn(lineNumber, column);
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.LastCursorLineSelectDrag, {
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.LastCursorLineSelectDrag, {
 			position: this.convertViewToModelPosition(lineNumber, column),
-			viewPosition: new Position.Position(lineNumber, column)
+			viewPosition: new Position(lineNumber, column)
 		});
 	}
 
 	public selectAll(source:string): void {
-		this.configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.SelectAll, null);
+		this.configuration.handlerDispatcher.trigger(source, editorCommon.Handler.SelectAll, null);
 	}
 
 	// ----------------------
 
-	private convertViewToModelPosition(lineNumber:number, column:number): EditorCommon.IEditorPosition {
+	private convertViewToModelPosition(lineNumber:number, column:number): editorCommon.IEditorPosition {
 		return this.viewModel.convertViewPositionToModelPosition(lineNumber, column);
 	}
 
-	private convertViewToModelRange(viewRange:EditorCommon.IRange): EditorCommon.IEditorRange {
+	private convertViewToModelRange(viewRange:editorCommon.IRange): editorCommon.IEditorRange {
 		return this.viewModel.convertViewRangeToModelRange(viewRange);
 	}
 
-	private convertViewToModelMouseEvent(e:EditorBrowser.IMouseEvent): void {
+	private convertViewToModelMouseEvent(e:IEditorMouseEvent): void {
 		if (e.target) {
 			if (e.target.position) {
 				e.target.position = this.convertViewToModelPosition(e.target.position.lineNumber, e.target.position.column);
@@ -170,37 +169,37 @@ export class ViewController implements EditorBrowser.IViewController {
 		}
 	}
 
-	public emitKeyDown(e:DomUtils.IKeyboardEvent): void {
-		this.outgoingEventBus.emit(EditorCommon.EventType.KeyDown, e);
+	public emitKeyDown(e:IKeyboardEvent): void {
+		this.outgoingEventBus.emit(editorCommon.EventType.KeyDown, e);
 	}
 
-	public emitKeyUp(e:DomUtils.IKeyboardEvent): void {
-		this.outgoingEventBus.emit(EditorCommon.EventType.KeyUp, e);
+	public emitKeyUp(e:IKeyboardEvent): void {
+		this.outgoingEventBus.emit(editorCommon.EventType.KeyUp, e);
 	}
 
-	public emitContextMenu(e:EditorBrowser.IMouseEvent): void {
+	public emitContextMenu(e:IEditorMouseEvent): void {
 		this.convertViewToModelMouseEvent(e);
-		this.outgoingEventBus.emit(EditorCommon.EventType.ContextMenu, e);
+		this.outgoingEventBus.emit(editorCommon.EventType.ContextMenu, e);
 	}
 
-	public emitMouseMove(e:EditorBrowser.IMouseEvent): void {
+	public emitMouseMove(e:IEditorMouseEvent): void {
 		this.convertViewToModelMouseEvent(e);
-		this.outgoingEventBus.emit(EditorCommon.EventType.MouseMove, e);
+		this.outgoingEventBus.emit(editorCommon.EventType.MouseMove, e);
 	}
 
-	public emitMouseLeave(e:EditorBrowser.IMouseEvent): void {
+	public emitMouseLeave(e:IEditorMouseEvent): void {
 		this.convertViewToModelMouseEvent(e);
-		this.outgoingEventBus.emit(EditorCommon.EventType.MouseLeave, e);
+		this.outgoingEventBus.emit(editorCommon.EventType.MouseLeave, e);
 	}
 
-	public emitMouseUp(e:EditorBrowser.IMouseEvent): void {
+	public emitMouseUp(e:IEditorMouseEvent): void {
 		this.convertViewToModelMouseEvent(e);
-		this.outgoingEventBus.emit(EditorCommon.EventType.MouseUp, e);
+		this.outgoingEventBus.emit(editorCommon.EventType.MouseUp, e);
 	}
 
-	public emitMouseDown(e:EditorBrowser.IMouseEvent): void {
+	public emitMouseDown(e:IEditorMouseEvent): void {
 		this.convertViewToModelMouseEvent(e);
-		this.outgoingEventBus.emit(EditorCommon.EventType.MouseDown, e);
+		this.outgoingEventBus.emit(editorCommon.EventType.MouseDown, e);
 	}
 
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewEventDispatcher.ts
code:
@@ -4,16 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EventEmitter = require('vs/base/common/eventEmitter');
+import {EmitterEvent, IEmitterEvent} from 'vs/base/common/eventEmitter';
+import {IViewEventBus} from 'vs/editor/common/editorCommon';
+import {IViewEventHandler} from 'vs/editor/browser/editorBrowser';
 
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-
-export class ViewEventDispatcher implements EditorCommon.IViewEventBus {
+export class ViewEventDispatcher implements IViewEventBus {
 
 	private eventHandlerGateKeeper:(callback:()=>void)=>void;
-	private eventHandlers:EditorBrowser.IViewEventHandler[];
-	private eventQueue:EventEmitter.IEmitterEvent[];
+	private eventHandlers:IViewEventHandler[];
+	private eventQueue:IEmitterEvent[];
 	private isConsumingQueue:boolean;
 
 	constructor(eventHandlerGateKeeper:(callback:()=>void)=>void) {
@@ -23,7 +22,7 @@ export class ViewEventDispatcher implements EditorCommon.IViewEventBus {
 		this.isConsumingQueue = false;
 	}
 
-	public addEventHandler(eventHandler: EditorBrowser.IViewEventHandler): void {
+	public addEventHandler(eventHandler: IViewEventHandler): void {
 		for (var i = 0, len = this.eventHandlers.length; i < len; i++) {
 			if (this.eventHandlers[i] === eventHandler) {
 				console.warn('Detected duplicate listener in ViewEventDispatcher', eventHandler);
@@ -32,7 +31,7 @@ export class ViewEventDispatcher implements EditorCommon.IViewEventBus {
 		this.eventHandlers.push(eventHandler);
 	}
 
-	public removeEventHandler(eventHandler:EditorBrowser.IViewEventHandler): void {
+	public removeEventHandler(eventHandler:IViewEventHandler): void {
 		for (var i = 0; i < this.eventHandlers.length; i++) {
 			if (this.eventHandlers[i] === eventHandler) {
 				this.eventHandlers.splice(i, 1);
@@ -42,13 +41,13 @@ export class ViewEventDispatcher implements EditorCommon.IViewEventBus {
 	}
 
 	public emit(eventType:string, data?:any): void {
-		this.eventQueue.push(new EventEmitter.EmitterEvent(eventType, data));
+		this.eventQueue.push(new EmitterEvent(eventType, data));
 		if (!this.isConsumingQueue) {
 			this.consumeQueue();
 		}
 	}
 
-	public emitMany(events:EventEmitter.IEmitterEvent[]): void {
+	public emitMany(events:IEmitterEvent[]): void {
 		this.eventQueue = this.eventQueue.concat(events);
 		if (!this.isConsumingQueue) {
 			this.consumeQueue();
@@ -62,8 +61,8 @@ export class ViewEventDispatcher implements EditorCommon.IViewEventBus {
 
 				var i:number,
 					len:number,
-					eventHandlers:EditorBrowser.IViewEventHandler[],
-					events:EventEmitter.IEmitterEvent[];
+					eventHandlers:IViewEventHandler[],
+					events:IEmitterEvent[];
 
 				while (this.eventQueue.length > 0) {
 					// Empty event queue, as events might come in while sending these off

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewImpl.ts
code:
@@ -4,56 +4,50 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Lifecycle = require('vs/base/common/lifecycle');
-import DomUtils = require('vs/base/browser/dom');
-import EventEmitter = require('vs/base/common/eventEmitter');
-import Errors = require('vs/base/common/errors');
-import Timer = require('vs/base/common/timer');
+import {onUnexpectedError} from 'vs/base/common/errors';
+import {EventEmitter, IEmitterEvent, IEventEmitter, ListenerUnbind} from 'vs/base/common/eventEmitter';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as timer from 'vs/base/common/timer';
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
-
+import {IKeybindingContextKey, IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
+import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
+import {Configuration} from 'vs/editor/browser/config/configuration';
 import {KeyboardHandler} from 'vs/editor/browser/controller/keyboardHandler';
 import {PointerHandler} from 'vs/editor/browser/controller/pointerHandler';
-import {LayoutProvider} from 'vs/editor/browser/viewLayout/layoutProvider';
-import {Configuration} from 'vs/editor/browser/config/configuration';
-import {ViewEventDispatcher} from 'vs/editor/browser/view/viewEventDispatcher';
+import * as editorBrowser from 'vs/editor/browser/editorBrowser';
 import {ViewController} from 'vs/editor/browser/view/viewController';
+import {ViewEventDispatcher} from 'vs/editor/browser/view/viewEventDispatcher';
 import {ContentViewOverlays, MarginViewOverlays} from 'vs/editor/browser/view/viewOverlays';
-
-// -- START VIEW PARTS
-import {ViewZones} from 'vs/editor/browser/viewParts/viewZones/viewZones';
-import {ViewLines} from 'vs/editor/browser/viewParts/lines/viewLines';
-import {OverviewRuler} from 'vs/editor/browser/viewParts/overviewRuler/overviewRuler';
-import {DecorationsOverviewRuler} from 'vs/editor/browser/viewParts/overviewRuler/decorationsOverviewRuler';
-import {ViewCursors} from 'vs/editor/browser/viewParts/viewCursors/viewCursors';
+import {LayoutProvider} from 'vs/editor/browser/viewLayout/layoutProvider';
 import {ViewContentWidgets} from 'vs/editor/browser/viewParts/contentWidgets/contentWidgets';
-import {ViewOverlayWidgets} from 'vs/editor/browser/viewParts/overlayWidgets/overlayWidgets';
 import {CurrentLineHighlightOverlay} from 'vs/editor/browser/viewParts/currentLineHighlight/currentLineHighlight';
-import {SelectionsOverlay} from 'vs/editor/browser/viewParts/selections/selections';
 import {DecorationsOverlay} from 'vs/editor/browser/viewParts/decorations/decorations';
 import {GlyphMarginOverlay} from 'vs/editor/browser/viewParts/glyphMargin/glyphMargin';
-import {LinesDecorationsOverlay} from 'vs/editor/browser/viewParts/linesDecorations/linesDecorations';
 import {LineNumbersOverlay} from 'vs/editor/browser/viewParts/lineNumbers/lineNumbers';
-import {ScrollDecorationViewPart} from 'vs/editor/browser/viewParts/scrollDecoration/scrollDecoration';
+import {ViewLines} from 'vs/editor/browser/viewParts/lines/viewLines';
+import {LinesDecorationsOverlay} from 'vs/editor/browser/viewParts/linesDecorations/linesDecorations';
+import {ViewOverlayWidgets} from 'vs/editor/browser/viewParts/overlayWidgets/overlayWidgets';
+import {DecorationsOverviewRuler} from 'vs/editor/browser/viewParts/overviewRuler/decorationsOverviewRuler';
+import {OverviewRuler} from 'vs/editor/browser/viewParts/overviewRuler/overviewRuler';
 import {Rulers} from 'vs/editor/browser/viewParts/rulers/rulers';
-// -- END VIEW PARTS
-
-import Browser = require('vs/base/browser/browser');
-
-import EditorCommon = require('vs/editor/common/editorCommon');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import {Range} from 'vs/editor/common/core/range';
-import {IKeybindingService, IKeybindingContextKey} from 'vs/platform/keybinding/common/keybindingService';
+import {ScrollDecorationViewPart} from 'vs/editor/browser/viewParts/scrollDecoration/scrollDecoration';
+import {SelectionsOverlay} from 'vs/editor/browser/viewParts/selections/selections';
+import {ViewCursors} from 'vs/editor/browser/viewParts/viewCursors/viewCursors';
+import {ViewZones} from 'vs/editor/browser/viewParts/viewZones/viewZones';
 
-export class View extends ViewEventHandler implements EditorBrowser.IView, Lifecycle.IDisposable {
+export class View extends ViewEventHandler implements editorBrowser.IView, IDisposable {
 
 	private eventDispatcher:ViewEventDispatcher;
 
-	private listenersToRemove:EventEmitter.ListenerUnbind[];
-	private listenersToDispose:Lifecycle.IDisposable[];
+	private listenersToRemove:ListenerUnbind[];
+	private listenersToDispose:IDisposable[];
 
 	private layoutProvider: LayoutProvider;
-	public context: EditorBrowser.IViewContext;
+	public context: editorBrowser.IViewContext;
 
 	// The view lines
 	private viewLines: ViewLines;
@@ -62,12 +56,12 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 	private viewZones: ViewZones;
 	private contentWidgets: ViewContentWidgets;
 	private overlayWidgets: ViewOverlayWidgets;
-	private viewParts: EditorBrowser.IViewPart[];
+	private viewParts: editorBrowser.IViewPart[];
 
 	private keyboardHandler: KeyboardHandler;
 	private pointerHandler: PointerHandler;
 
-	private outgoingEventBus: EventEmitter.EventEmitter;
+	private outgoingEventBus: EventEmitter;
 
 	// Dom nodes
 	private linesContent: HTMLElement;
@@ -82,19 +76,19 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 	private _isDisposed: boolean;
 
 	private handleAccumulatedModelEventsTimeout:number;
-	private accumulatedModelEvents: EventEmitter.IEmitterEvent[];
-	private _renderAnimationFrame: Lifecycle.IDisposable;
+	private accumulatedModelEvents: IEmitterEvent[];
+	private _renderAnimationFrame: IDisposable;
 
 	private _editorId: number;
 	private _keybindingService: IKeybindingService;
 	private _editorTextFocusContextKey: IKeybindingContextKey<boolean>;
 
-	constructor(editorId:number, configuration:Configuration, model:EditorCommon.IViewModel, keybindingService: IKeybindingService) {
+	constructor(editorId:number, configuration:Configuration, model:editorCommon.IViewModel, keybindingService: IKeybindingService) {
 		super();
 		this._isDisposed = false;
 		this._editorId = editorId;
 		this._renderAnimationFrame = null;
-		this.outgoingEventBus = new EventEmitter.EventEmitter();
+		this.outgoingEventBus = new EventEmitter();
 
 		var viewController = new ViewController(model, configuration, this.outgoingEventBus);
 
@@ -106,12 +100,12 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 
 		// These two dom nodes must be constructed up front, since references are needed in the layout provider (scrolling & co.)
 		this.linesContent = document.createElement('div');
-		this.linesContent.className = EditorBrowser.ClassNames.LINES_CONTENT + ' monaco-editor-background';
+		this.linesContent.className = editorBrowser.ClassNames.LINES_CONTENT + ' monaco-editor-background';
 		this.domNode = document.createElement('div');
 		Configuration.applyEditorStyling(this.domNode, configuration.editor.stylingInfo);
 
 		this.overflowGuardContainer = document.createElement('div');
-		this.overflowGuardContainer.className = EditorBrowser.ClassNames.OVERFLOW_GUARD;
+		this.overflowGuardContainer.className = editorBrowser.ClassNames.OVERFLOW_GUARD;
 
 		// The layout provider has such responsibilities as:
 		// - scrolling (i.e. viewport / full size) & co.
@@ -123,8 +117,8 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		// The view context is passed on to most classes (basically to reduce param. counts in ctors)
 		this.context = new ViewContext(
 				editorId, configuration, model, this.eventDispatcher,
-				(eventHandler:EditorBrowser.IViewEventHandler) => this.eventDispatcher.addEventHandler(eventHandler),
-				(eventHandler:EditorBrowser.IViewEventHandler) => this.eventDispatcher.removeEventHandler(eventHandler)
+				(eventHandler:editorBrowser.IViewEventHandler) => this.eventDispatcher.addEventHandler(eventHandler),
+				(eventHandler:editorBrowser.IViewEventHandler) => this.eventDispatcher.removeEventHandler(eventHandler)
 		);
 
 		this.createTextArea(keybindingService);
@@ -145,7 +139,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		// This delayed processing of incoming model events acts as a guard against undesired/unexpected recursion.
 		this.handleAccumulatedModelEventsTimeout = -1;
 		this.accumulatedModelEvents = [];
-		this.listenersToRemove.push(model.addBulkListener((events:EventEmitter.IEmitterEvent[]) => {
+		this.listenersToRemove.push(model.addBulkListener((events:IEmitterEvent[]) => {
 			this.accumulatedModelEvents = this.accumulatedModelEvents.concat(events);
 			if (this.handleAccumulatedModelEventsTimeout === -1) {
 				this.handleAccumulatedModelEventsTimeout = setTimeout(() => {
@@ -168,8 +162,8 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		// Text Area (The focus will always be in the textarea when the cursor is blinking)
 		this.textArea = <HTMLTextAreaElement>document.createElement('textarea');
 		this._keybindingService = keybindingService.createScoped(this.textArea);
-		this._editorTextFocusContextKey = this._keybindingService.createKey(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS, undefined);
-		this.textArea.className = EditorBrowser.ClassNames.TEXTAREA;
+		this._editorTextFocusContextKey = this._keybindingService.createKey(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS, undefined);
+		this.textArea.className = editorBrowser.ClassNames.TEXTAREA;
 		this.textArea.setAttribute('wrap', 'off');
 		this.textArea.setAttribute('autocorrect', 'off');
 		this.textArea.setAttribute('autocapitalize', 'off');
@@ -183,20 +177,20 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		StyleMutator.setFontSize(this.textArea, this.context.configuration.editor.fontSize);
 		StyleMutator.setLineHeight(this.textArea, this.context.configuration.editor.lineHeight);
 
-		this.listenersToDispose.push(DomUtils.addDisposableListener(this.textArea, 'focus', () => this._setHasFocus(true)));
-		this.listenersToDispose.push(DomUtils.addDisposableListener(this.textArea, 'blur', () => this._setHasFocus(false)));
+		this.listenersToDispose.push(dom.addDisposableListener(this.textArea, 'focus', () => this._setHasFocus(true)));
+		this.listenersToDispose.push(dom.addDisposableListener(this.textArea, 'blur', () => this._setHasFocus(false)));
 
 		// On top of the text area, we position a dom node to cover it up
 		// (there have been reports of tiny blinking cursors)
 		// (in WebKit the textarea is 1px by 1px because it cannot handle input to a 0x0 textarea)
 		this.textAreaCover = document.createElement('div');
 		if (this.context.configuration.editor.glyphMargin) {
-			this.textAreaCover.className = 'monaco-editor-background ' + EditorBrowser.ClassNames.GLYPH_MARGIN + ' ' + EditorBrowser.ClassNames.TEXTAREA_COVER;
+			this.textAreaCover.className = 'monaco-editor-background ' + editorBrowser.ClassNames.GLYPH_MARGIN + ' ' + editorBrowser.ClassNames.TEXTAREA_COVER;
 		} else {
 			if (this.context.configuration.editor.lineNumbers) {
-				this.textAreaCover.className = 'monaco-editor-background ' + EditorBrowser.ClassNames.LINE_NUMBERS + ' ' + EditorBrowser.ClassNames.TEXTAREA_COVER;
+				this.textAreaCover.className = 'monaco-editor-background ' + editorBrowser.ClassNames.LINE_NUMBERS + ' ' + editorBrowser.ClassNames.TEXTAREA_COVER;
 			} else {
-				this.textAreaCover.className = 'monaco-editor-background ' + EditorBrowser.ClassNames.TEXTAREA_COVER;
+				this.textAreaCover.className = 'monaco-editor-background ' + editorBrowser.ClassNames.TEXTAREA_COVER;
 			}
 		}
 		this.textAreaCover.style.position = 'absolute';
@@ -285,7 +279,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		this._renderNow();
 	}
 
-	private createPointerHandlerHelper(): EditorBrowser.IPointerHandlerHelper {
+	private createPointerHandlerHelper(): editorBrowser.IPointerHandlerHelper {
 		return {
 			viewDomNode: this.domNode,
 			linesContentDomNode: this.linesContent,
@@ -387,7 +381,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		};
 	}
 
-	private createKeyboardHandlerHelper(): EditorBrowser.IKeyboardHandlerHelper {
+	private createKeyboardHandlerHelper(): editorBrowser.IKeyboardHandlerHelper {
 		return {
 			viewDomNode: this.domNode,
 			textArea: this.textArea,
@@ -408,8 +402,8 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 
 	// --- begin event handlers
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
-		if (Browser.isChrome) {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
+		if (browser.isChrome) {
 			/* tslint:disable:no-unused-variable */
 			// Access overflowGuardContainer.clientWidth to prevent relayouting bug in Chrome
 			// See Bug 19676: Editor misses a layout event
@@ -429,10 +423,10 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		StyleMutator.setWidth(this.linesContentContainer, layoutInfo.contentWidth);
 		StyleMutator.setHeight(this.linesContentContainer, layoutInfo.contentHeight);
 
-		this.outgoingEventBus.emit(EditorCommon.EventType.ViewLayoutChanged, layoutInfo);
+		this.outgoingEventBus.emit(editorCommon.EventType.ViewLayoutChanged, layoutInfo);
 		return false;
 	}
-	public onConfigurationChanged(e: EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e: editorCommon.IConfigurationChangedEvent): boolean {
 		if (e.stylingInfo) {
 			Configuration.applyEditorStyling(this.domNode, this.context.configuration.editor.stylingInfo);
 		}
@@ -441,7 +435,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		}
 		return false;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		this.outgoingEventBus.emit('scroll', {
 			scrollTop: this.layoutProvider.getScrollTop(),
 			scrollLeft: this.layoutProvider.getScrollLeft()
@@ -456,13 +450,13 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		return super.onScrollHeightChanged(scrollHeight);
 	}
 	public onViewFocusChanged(isFocused:boolean): boolean {
-		DomUtils.toggleClass(this.domNode, 'focused', isFocused);
+		dom.toggleClass(this.domNode, 'focused', isFocused);
 		if (isFocused) {
 			this._editorTextFocusContextKey.set(true);
-			this.outgoingEventBus.emit(EditorCommon.EventType.ViewFocusGained, {});
+			this.outgoingEventBus.emit(editorCommon.EventType.ViewFocusGained, {});
 		} else {
 			this._editorTextFocusContextKey.reset();
-			this.outgoingEventBus.emit(EditorCommon.EventType.ViewFocusLost, {});
+			this.outgoingEventBus.emit(editorCommon.EventType.ViewFocusLost, {});
 		}
 		return false;
 	}
@@ -487,7 +481,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 		this.listenersToRemove = [];
 
-		this.listenersToDispose = Lifecycle.disposeAll(this.listenersToDispose);
+		this.listenersToDispose = disposeAll(this.listenersToDispose);
 
 		this.keyboardHandler.dispose();
 		this.pointerHandler.dispose();
@@ -506,8 +500,8 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 
 	// --- begin Code Editor APIs
 
-	private codeEditorHelper:EditorBrowser.ICodeEditorHelper;
-	public getCodeEditorHelper(): EditorBrowser.ICodeEditorHelper {
+	private codeEditorHelper:editorBrowser.ICodeEditorHelper;
+	public getCodeEditorHelper(): editorBrowser.ICodeEditorHelper {
 		if (!this.codeEditorHelper) {
 			this.codeEditorHelper = {
 				getScrollTop: () => {
@@ -584,7 +578,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		return this.codeEditorHelper;
 	}
 
-	public getCenteredRangeInViewport(): EditorCommon.IEditorRange {
+	public getCenteredRangeInViewport(): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.getCenteredRangeInViewport: View is disposed');
 		}
@@ -598,21 +592,21 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 //		return this.viewLines;
 //	}
 
-	public getInternalEventBus(): EventEmitter.IEventEmitter {
+	public getInternalEventBus(): IEventEmitter {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.getInternalEventBus: View is disposed');
 		}
 		return this.outgoingEventBus;
 	}
 
-	public saveState(): EditorCommon.IViewState {
+	public saveState(): editorCommon.IViewState {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.saveState: View is disposed');
 		}
 		return this.layoutProvider.saveState();
 	}
 
-	public restoreState(state: EditorCommon.IViewState): void {
+	public restoreState(state: editorCommon.IViewState): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.restoreState: View is disposed');
 		}
@@ -647,16 +641,16 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		);
 	}
 
-	public change(callback: (changeAccessor: EditorBrowser.IViewZoneChangeAccessor) => any): boolean {
+	public change(callback: (changeAccessor: editorBrowser.IViewZoneChangeAccessor) => any): boolean {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.change: View is disposed');
 		}
 		var zonesHaveChanged = false;
 		this._renderOnce(() => {
 			// Handle events to avoid "adjusting" newly inserted view zones
 			this._flushAnyAccumulatedEvents();
-			var changeAccessor:EditorBrowser.IViewZoneChangeAccessor = {
-				addZone: (zone:EditorBrowser.IViewZone): number => {
+			var changeAccessor:editorBrowser.IViewZoneChangeAccessor = {
+				addZone: (zone:editorBrowser.IViewZone): number => {
 					zonesHaveChanged = true;
 					return this.viewZones.addZone(zone);
 				},
@@ -672,30 +666,30 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 			try {
 				r = callback(changeAccessor);
 			} catch (e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 			}
 
 			// Invalidate changeAccessor
 			changeAccessor.addZone = null;
 			changeAccessor.removeZone = null;
 
 			if (zonesHaveChanged) {
-				this.context.privateViewEventBus.emit(EditorCommon.EventType.ViewZonesChanged, null);
+				this.context.privateViewEventBus.emit(editorCommon.EventType.ViewZonesChanged, null);
 			}
 
 			return r;
 		});
 		return zonesHaveChanged;
 	}
 
-	public getWhitespaces(): EditorCommon.IEditorWhitespace[]{
+	public getWhitespaces(): editorCommon.IEditorWhitespace[]{
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.getWhitespaces: View is disposed');
 		}
 		return this.layoutProvider.getWhitespaces();
 	}
 
-	public addContentWidget(widgetData: EditorBrowser.IContentWidgetData): void {
+	public addContentWidget(widgetData: editorBrowser.IContentWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.addContentWidget: View is disposed');
 		}
@@ -705,7 +699,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 	}
 
-	public layoutContentWidget(widgetData: EditorBrowser.IContentWidgetData): void {
+	public layoutContentWidget(widgetData: editorBrowser.IContentWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.layoutContentWidget: View is disposed');
 		}
@@ -716,7 +710,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 	}
 
-	public removeContentWidget(widgetData: EditorBrowser.IContentWidgetData): void {
+	public removeContentWidget(widgetData: editorBrowser.IContentWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.removeContentWidget: View is disposed');
 		}
@@ -725,7 +719,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 	}
 
-	public addOverlayWidget(widgetData: EditorBrowser.IOverlayWidgetData): void {
+	public addOverlayWidget(widgetData: editorBrowser.IOverlayWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.addOverlayWidget: View is disposed');
 		}
@@ -735,7 +729,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 	}
 
-	public layoutOverlayWidget(widgetData: EditorBrowser.IOverlayWidgetData): void {
+	public layoutOverlayWidget(widgetData: editorBrowser.IOverlayWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.layoutOverlayWidget: View is disposed');
 		}
@@ -745,7 +739,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		});
 	}
 
-	public removeOverlayWidget(widgetData: EditorBrowser.IOverlayWidgetData): void {
+	public removeOverlayWidget(widgetData: editorBrowser.IOverlayWidgetData): void {
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.removeOverlayWidget: View is disposed');
 		}
@@ -794,7 +788,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 			throw new Error('ViewImpl._scheduleRender: View is disposed');
 		}
 		if (this._renderAnimationFrame === null) {
-			this._renderAnimationFrame = DomUtils.runAtThisOrScheduleAtNextAnimationFrame(this._onRenderScheduled.bind(this), 100);
+			this._renderAnimationFrame = dom.runAtThisOrScheduleAtNextAnimationFrame(this._onRenderScheduled.bind(this), 100);
 		}
 	}
 
@@ -810,13 +804,13 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		this.actualRender();
 	}
 
-	private createRenderingContext(linesViewportData:EditorCommon.IViewLinesViewportData): EditorBrowser.IRenderingContext {
+	private createRenderingContext(linesViewportData:editorCommon.IViewLinesViewportData): editorBrowser.IRenderingContext {
 
 		var vInfo = this.layoutProvider.getCurrentViewport();
 
 		var deltaTop = linesViewportData.visibleRangesDeltaTop;
 
-		var r:EditorBrowser.IRenderingContext = {
+		var r:editorBrowser.IRenderingContext = {
 			linesViewportData: linesViewportData,
 			scrollWidth: this.layoutProvider.getScrollWidth(),
 			scrollHeight: this.layoutProvider.getScrollHeight(),
@@ -841,11 +835,11 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 
 			getDecorationsInViewport: () => linesViewportData.getDecorationsInViewport(),
 
-			linesVisibleRangesForRange: (range:EditorCommon.IRange, includeNewLines:boolean) => {
+			linesVisibleRangesForRange: (range:editorCommon.IRange, includeNewLines:boolean) => {
 				return this.viewLines.linesVisibleRangesForRange(range, includeNewLines);
 			},
 
-			visibleRangeForPosition: (position:EditorCommon.IPosition) => {
+			visibleRangeForPosition: (position:editorCommon.IPosition) => {
 				var visibleRanges = this.viewLines.visibleRangesForRange2(new Range(position.lineNumber, position.column, position.lineNumber, position.column), deltaTop);
 				if (!visibleRanges) {
 					return null;
@@ -864,11 +858,11 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 		if (this._isDisposed) {
 			throw new Error('ViewImpl.actualRender: View is disposed');
 		}
-		if (!DomUtils.isInDOM(this.domNode)) {
+		if (!dom.isInDOM(this.domNode)) {
 			return;
 		}
 
-		var t = Timer.start(Timer.Topic.EDITOR, 'View.render');
+		var t = timer.start(timer.Topic.EDITOR, 'View.render');
 
 		var i:number,
 			len:number;
@@ -892,7 +886,7 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 				this.viewParts[i].onWriteAfterForcedLayout();
 			}
 		} catch (err) {
-			Errors.onUnexpectedError(err);
+			onUnexpectedError(err);
 		}
 
 		t.stop();
@@ -901,27 +895,27 @@ export class View extends ViewEventHandler implements EditorBrowser.IView, Lifec
 	private _setHasFocus(newHasFocus:boolean): void {
 		if (this.hasFocus !== newHasFocus) {
 			this.hasFocus = newHasFocus;
-			this.context.privateViewEventBus.emit(EditorCommon.EventType.ViewFocusChanged, this.hasFocus);
+			this.context.privateViewEventBus.emit(editorCommon.EventType.ViewFocusChanged, this.hasFocus);
 		}
 	}
 }
 
-class ViewContext implements EditorBrowser.IViewContext {
+class ViewContext implements editorBrowser.IViewContext {
 
 	public editorId:number;
-	public configuration:EditorCommon.IConfiguration;
-	public model: EditorCommon.IViewModel;
-	public privateViewEventBus:EditorCommon.IViewEventBus;
-	public addEventHandler:(eventHandler:EditorBrowser.IViewEventHandler)=>void;
-	public removeEventHandler:(eventHandler:EditorBrowser.IViewEventHandler)=>void;
+	public configuration:editorCommon.IConfiguration;
+	public model: editorCommon.IViewModel;
+	public privateViewEventBus:editorCommon.IViewEventBus;
+	public addEventHandler:(eventHandler:editorBrowser.IViewEventHandler)=>void;
+	public removeEventHandler:(eventHandler:editorBrowser.IViewEventHandler)=>void;
 
 	constructor(
 					editorId:number,
-					configuration:EditorCommon.IConfiguration,
-					model: EditorCommon.IViewModel,
-					privateViewEventBus:EditorCommon.IViewEventBus,
-					addEventHandler:(eventHandler:EditorBrowser.IViewEventHandler)=>void,
-					removeEventHandler:(eventHandler:EditorBrowser.IViewEventHandler)=>void
+					configuration:editorCommon.IConfiguration,
+					model: editorCommon.IViewModel,
+					privateViewEventBus:editorCommon.IViewEventBus,
+					addEventHandler:(eventHandler:editorBrowser.IViewEventHandler)=>void,
+					removeEventHandler:(eventHandler:editorBrowser.IViewEventHandler)=>void
 				)
 	{
 		this.editorId = editorId;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewLayer.ts
code:
@@ -4,11 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import DomUtils = require('vs/base/browser/dom');
-
+import * as dom from 'vs/base/browser/dom';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
 
 export interface IVisibleLineData {
 	getDomNode(): HTMLElement;
@@ -19,12 +18,12 @@ export interface IVisibleLineData {
 	onLinesDeletedAbove(): void;
 	onLineChangedAbove(): void;
 	onTokensChanged(): void;
-	onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): void;
+	onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): void;
 
 	getLineOuterHTML(out:string[], lineNumber: number, deltaTop: number): void;
 	getLineInnerHTML(lineNumber: number): string;
 
-	shouldUpdateHTML(lineNumber:number, inlineDecorations:EditorCommon.IModelDecoration[]): boolean;
+	shouldUpdateHTML(lineNumber:number, inlineDecorations:editorCommon.IModelDecoration[]): boolean;
 	layoutLine(lineNumber: number, deltaTop:number): void;
 }
 
@@ -33,7 +32,7 @@ interface IRendererContext {
 	rendLineNumberStart: number;
 	lines: IVisibleLineData[];
 	linesLength: number;
-	getInlineDecorationsForLineInViewport(lineNumber:number): EditorCommon.IModelDecoration[];
+	getInlineDecorationsForLineInViewport(lineNumber:number): editorCommon.IModelDecoration[];
 	viewportTop: number;
 	viewportHeight: number;
 	scrollDomNode: HTMLElement;
@@ -49,7 +48,7 @@ export class ViewLayer extends ViewPart {
 
 	private _renderer: ViewLayerRenderer;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super(context);
 
 		this.domNode = this._createDomNode();
@@ -74,18 +73,18 @@ export class ViewLayer extends ViewPart {
 
 	// ---- begin view event handlers
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		for (var i = 0; i < this._lines.length; i++) {
 			this._lines[i].onConfigurationChanged(e);
 		}
 		return true;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
 
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 
@@ -96,11 +95,11 @@ export class ViewLayer extends ViewPart {
 	public onModelFlushed(): boolean {
 		this._lines = [];
 		this._rendLineNumberStart = 1;
-		DomUtils.clearNode(this.domNode);
+		dom.clearNode(this.domNode);
 		return true;
 	}
 
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		var from = Math.max(e.fromLineNumber - this._rendLineNumberStart, 0);
 		var to = Math.min(e.toLineNumber - this._rendLineNumberStart, this._lines.length - 1);
 		var i:number;
@@ -139,7 +138,7 @@ export class ViewLayer extends ViewPart {
 		return true;
 	}
 
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		var lineIndex = e.lineNumber - this._rendLineNumberStart,
 			shouldRender = false;
 
@@ -157,7 +156,7 @@ export class ViewLayer extends ViewPart {
 		return shouldRender;
 	}
 
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		var i:number;
 
 		if (e.fromLineNumber <= this._rendLineNumberStart) {
@@ -211,7 +210,7 @@ export class ViewLayer extends ViewPart {
 		return true;
 	}
 
-	public onModelTokensChanged(e:EditorCommon.IViewTokensChangedEvent): boolean {
+	public onModelTokensChanged(e:editorCommon.IViewTokensChangedEvent): boolean {
 		var changedFromIndex = e.fromLineNumber - this._rendLineNumberStart;
 		var changedToIndex = e.toLineNumber - this._rendLineNumberStart;
 
@@ -236,7 +235,7 @@ export class ViewLayer extends ViewPart {
 	// ---- end view event handlers
 	private _scrollDomNode: HTMLElement = null;
 	private _scrollDomNodeIsAbove: boolean = false;
-	public _renderLines(linesViewportData:EditorCommon.IViewLinesViewportData): void {
+	public _renderLines(linesViewportData:editorCommon.IViewLinesViewportData): void {
 
 		var ctx: IRendererContext = {
 			domNode: this.domNode,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewOverlays.ts
code:
@@ -4,20 +4,19 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Browser = require('vs/base/browser/browser');
-import DomUtils = require('vs/base/browser/dom');
-
-import {ViewLayer, IVisibleLineData} from 'vs/editor/browser/view/viewLayer';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {IConfigurationChangedEvent, IEditorLayoutInfo, IModelDecoration, IScrollEvent} from 'vs/editor/common/editorCommon';
+import * as editorBrowser from 'vs/editor/browser/editorBrowser';
+import {IVisibleLineData, ViewLayer} from 'vs/editor/browser/view/viewLayer';
 
 export class ViewOverlays extends ViewLayer {
-	private _dynamicOverlays:EditorBrowser.IDynamicViewOverlay[];
+	private _dynamicOverlays:editorBrowser.IDynamicViewOverlay[];
 
-	_layoutProvider:EditorBrowser.ILayoutProvider;
+	_layoutProvider:editorBrowser.ILayoutProvider;
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context);
 
 		this._layoutProvider = layoutProvider;
@@ -41,15 +40,15 @@ export class ViewOverlays extends ViewLayer {
 		return this.domNode;
 	}
 
-	public addDynamicOverlay(overlay:EditorBrowser.IDynamicViewOverlay): void {
+	public addDynamicOverlay(overlay:editorBrowser.IDynamicViewOverlay): void {
 		this._dynamicOverlays.push(overlay);
 	}
 
 	// ----- event handlers
 
 	public onViewFocusChanged(isFocused:boolean): boolean {
 		this._requestModificationFrame(() => {
-			DomUtils.toggleClass(this.domNode, 'focused', isFocused);
+			dom.toggleClass(this.domNode, 'focused', isFocused);
 		});
 		return false;
 	}
@@ -62,7 +61,7 @@ export class ViewOverlays extends ViewLayer {
 	}
 
 
-	public onReadAfterForcedLayout(ctx:EditorBrowser.IRenderingContext): void {
+	public onReadAfterForcedLayout(ctx:editorBrowser.IRenderingContext): void {
 		// Overwriting to bypass `shouldRender` flag
 		for (var i = 0; i < this._dynamicOverlays.length; i++) {
 			this._dynamicOverlays[i].shouldCallRender2(ctx);
@@ -75,7 +74,7 @@ export class ViewOverlays extends ViewLayer {
 		return null;
 	}
 
-	_viewOverlaysRender(ctx:EditorBrowser.IRestrictedRenderingContext): void {
+	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
 		super._renderLines(ctx.linesViewportData);
 	}
 
@@ -87,12 +86,12 @@ export class ViewOverlays extends ViewLayer {
 
 class ViewOverlayLine implements IVisibleLineData {
 
-	private _context:EditorBrowser.IViewContext;
-	private _dynamicOverlays:EditorBrowser.IDynamicViewOverlay[];
+	private _context:editorBrowser.IViewContext;
+	private _dynamicOverlays:editorBrowser.IDynamicViewOverlay[];
 	private _domNode: HTMLElement;
 	private _renderPieces: string[];
 
-	constructor(context:EditorBrowser.IViewContext, dynamicOverlays:EditorBrowser.IDynamicViewOverlay[]) {
+	constructor(context:editorBrowser.IViewContext, dynamicOverlays:editorBrowser.IDynamicViewOverlay[]) {
 		this._context = context;
 		this._dynamicOverlays = dynamicOverlays;
 
@@ -122,7 +121,7 @@ class ViewOverlayLine implements IVisibleLineData {
 	onTokensChanged(): void {
 		// Nothing
 	}
-	onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): void {
+	onConfigurationChanged(e:IConfigurationChangedEvent): void {
 		// Nothing
 	}
 
@@ -138,7 +137,7 @@ class ViewOverlayLine implements IVisibleLineData {
 		return true;
 	}
 
-	shouldUpdateHTML(lineNumber:number, inlineDecorations:EditorCommon.IModelDecoration[]): boolean {
+	shouldUpdateHTML(lineNumber:number, inlineDecorations:IModelDecoration[]): boolean {
 		var newPieces: string[] = [];
 		for (var i = 0; i < this._dynamicOverlays.length; i++) {
 			var pieces = this._dynamicOverlays[i].render2(lineNumber);
@@ -163,7 +162,7 @@ class ViewOverlayLine implements IVisibleLineData {
 		out.push('px;height:');
 		out.push(this._context.configuration.editor.lineHeight.toString());
 		out.push('px;" class="');
-		out.push(EditorBrowser.ClassNames.VIEW_LINE);
+		out.push(editorBrowser.ClassNames.VIEW_LINE);
 		out.push('">');
 		out.push(this.getLineInnerHTML(lineNumber));
 		out.push('</div>');
@@ -185,7 +184,7 @@ class ViewOverlayLine implements IVisibleLineData {
 
 export class ContentViewOverlays extends ViewOverlays {
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context, layoutProvider);
 
 		StyleMutator.setWidth(this.domNode, 0);
@@ -196,7 +195,7 @@ export class ContentViewOverlays extends ViewOverlays {
 		return true;
 	}
 
-	_viewOverlaysRender(ctx:EditorBrowser.IRestrictedRenderingContext): void {
+	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
 		super._viewOverlaysRender(ctx);
 
 		StyleMutator.setWidth(this.domNode, this._layoutProvider.getScrollWidth());
@@ -209,22 +208,22 @@ export class MarginViewOverlays extends ViewOverlays {
 	private _glyphMarginWidth:number;
 	private _scrollHeight:number;
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context, layoutProvider);
 
 		this._glyphMarginLeft = 0;
 		this._glyphMarginWidth = 0;
 		this._scrollHeight = layoutProvider.getScrollHeight();
 
-		this.domNode.className = EditorBrowser.ClassNames.MARGIN_VIEW_OVERLAYS + ' monaco-editor-background';
+		this.domNode.className = editorBrowser.ClassNames.MARGIN_VIEW_OVERLAYS + ' monaco-editor-background';
 		StyleMutator.setWidth(this.domNode, 1);
 		this._hasVerticalScroll = true;
 	}
 
 	protected _extraDomNodeHTML(): string {
 		return [
 			'<div class="',
-			EditorBrowser.ClassNames.GLYPH_MARGIN,
+			editorBrowser.ClassNames.GLYPH_MARGIN,
 			'" style="left:',
 			String(this._glyphMarginLeft),
 			'px;width:',
@@ -250,7 +249,7 @@ export class MarginViewOverlays extends ViewOverlays {
 		return super.onScrollHeightChanged(scrollHeight) || true;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:IEditorLayoutInfo): boolean {
 		this._glyphMarginLeft = layoutInfo.glyphMarginLeft;
 		this._glyphMarginWidth = layoutInfo.glyphMarginWidth;
 		this._scrollHeight = this._layoutProvider.getScrollHeight();
@@ -268,15 +267,15 @@ export class MarginViewOverlays extends ViewOverlays {
 	}
 
 	private _hasVerticalScroll = false;
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:IScrollEvent): boolean {
 		this._hasVerticalScroll = this._hasVerticalScroll || e.vertical;
 		return super.onScrollChanged(e);
 	}
 
-	_viewOverlaysRender(ctx:EditorBrowser.IRestrictedRenderingContext): void {
+	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
 		super._viewOverlaysRender(ctx);
 		if (this._hasVerticalScroll) {
-			if (Browser.canUseTranslate3d) {
+			if (browser.canUseTranslate3d) {
 				var transform = 'translate3d(0px, ' + ctx.linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
 				StyleMutator.setTransform(this.domNode, transform);
 			} else {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/view/viewPart.ts
code:
@@ -5,19 +5,19 @@
 'use strict';
 
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
+import {IRenderingContext, IViewContext, IViewPart} from 'vs/editor/browser/editorBrowser';
 
 export interface IRunner {
 	(): void;
 }
 
-export class ViewPart extends ViewEventHandler implements EditorBrowser.IViewPart {
+export class ViewPart extends ViewEventHandler implements IViewPart {
 
-	_context:EditorBrowser.IViewContext;
+	_context:IViewContext;
 	private _modificationBeforeRenderingRunners:IRunner[];
 	private _modificationRunners:IRunner[];
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._context.addEventHandler(this);
@@ -55,7 +55,7 @@ export class ViewPart extends ViewEventHandler implements EditorBrowser.IViewPar
 		}
 	}
 
-	public onReadAfterForcedLayout(ctx:EditorBrowser.IRenderingContext): void {
+	public onReadAfterForcedLayout(ctx:IRenderingContext): void {
 		if (!this.shouldRender) {
 			return;
 		}
@@ -80,7 +80,7 @@ export class ViewPart extends ViewEventHandler implements EditorBrowser.IViewPar
 		}
 	}
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 		throw new Error('Implement me!');
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewLayout/layoutProvider.ts
code:
@@ -4,27 +4,26 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Lifecycle = require('vs/base/common/lifecycle');
-
+import {IDisposable} from 'vs/base/common/lifecycle';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {EditorScrollable} from 'vs/editor/common/viewLayout/editorScrollable';
 import {LinesLayout} from 'vs/editor/common/viewLayout/linesLayout';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
+import {ILayoutProvider} from 'vs/editor/browser/editorBrowser';
 import {ScrollManager} from 'vs/editor/browser/viewLayout/scrollManager';
-import {EditorScrollable} from 'vs/editor/common/viewLayout/editorScrollable';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
 
-export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDisposable, EditorBrowser.ILayoutProvider, EditorCommon.IWhitespaceManager {
+export class LayoutProvider extends ViewEventHandler implements IDisposable, ILayoutProvider, editorCommon.IWhitespaceManager {
 
 	static LINES_HORIZONTAL_EXTRA_PX = 30;
 
-	private configuration: EditorCommon.IConfiguration;
-	private privateViewEventBus:EditorCommon.IViewEventBus;
-	private model:EditorCommon.IViewModel;
+	private configuration: editorCommon.IConfiguration;
+	private privateViewEventBus:editorCommon.IViewEventBus;
+	private model:editorCommon.IViewModel;
 	private scrollManager:ScrollManager;
 	private linesLayout: LinesLayout;
 	private scrollable: EditorScrollable;
 
-	constructor(configuration:EditorCommon.IConfiguration, model:EditorCommon.IViewModel, privateViewEventBus:EditorCommon.IViewEventBus, linesContent:HTMLElement, viewDomNode:HTMLElement, overflowGuardDomNode:HTMLElement) {
+	constructor(configuration:editorCommon.IConfiguration, model:editorCommon.IViewModel, privateViewEventBus:editorCommon.IViewEventBus, linesContent:HTMLElement, viewDomNode:HTMLElement, overflowGuardDomNode:HTMLElement) {
 		super();
 
 		this.configuration = configuration;
@@ -66,21 +65,21 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 		return false;
 	}
 
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		this.linesLayout.onModelLinesDeleted(e);
 		this.updateLineCount();
 		this._updateHeight();
 		return false;
 	}
 
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		this.linesLayout.onModelLinesInserted(e);
 		this.updateLineCount();
 		this._updateHeight();
 		return false;
 	}
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		if (e.layoutInfo) {
 			this.scrollable.setWidth(this.configuration.editor.layoutInfo.contentWidth);
 			this.scrollable.setHeight(this.configuration.editor.layoutInfo.contentHeight);
@@ -96,15 +95,15 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 		this.scrollable.setScrollHeight(this.getTotalHeight());
 		var newScrollHeight = this.scrollable.getScrollHeight();
 		if (oldScrollHeight !== newScrollHeight) {
-			this.privateViewEventBus.emit(EditorCommon.EventType.ViewScrollHeightChanged, newScrollHeight);
+			this.privateViewEventBus.emit(editorCommon.EventType.ViewScrollHeightChanged, newScrollHeight);
 		}
 	}
 
 	// ---- end view event handlers
 
 	// ---- Layouting logic
 
-	public getCurrentViewport(): EditorCommon.IViewport {
+	public getCurrentViewport(): editorCommon.IViewport {
 		return {
 			top: this.scrollable.getScrollTop(),
 			left: this.scrollable.getScrollLeft(),
@@ -118,7 +117,7 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 	}
 
 	private _emitLayoutChangedEvent(): void {
-		this.privateViewEventBus.emit(EditorCommon.EventType.ViewLayoutChanged, this.configuration.editor.layoutInfo);
+		this.privateViewEventBus.emit(editorCommon.EventType.ViewLayoutChanged, this.configuration.editor.layoutInfo);
 	}
 
 	public emitLayoutChangedEvent(): void {
@@ -141,15 +140,15 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 		newScrollWidth = this.scrollable.getScrollWidth();
 
 		if (newScrollWidth !== oldScrollWidth) {
-			this.privateViewEventBus.emit(EditorCommon.EventType.ViewScrollWidthChanged, newScrollWidth);
+			this.privateViewEventBus.emit(editorCommon.EventType.ViewScrollWidthChanged, newScrollWidth);
 			// The height might depend on the fact that there is a horizontal scrollbar or not
 			this._updateHeight();
 		}
 	}
 
 	// ---- view state
 
-	public saveState(): EditorCommon.IViewState {
+	public saveState(): editorCommon.IViewState {
 		var scrollTop = this.scrollable.getScrollTop();
 		var firstLineNumberInViewport = this.linesLayout.getLineNumberAtOrAfterVerticalOffset(scrollTop);
 		var whitespaceAboveFirstLine = this.linesLayout.getWhitespaceAccumulatedHeightBeforeLineNumber(firstLineNumberInViewport);
@@ -160,7 +159,7 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 		};
 	}
 
-	public restoreState(state:EditorCommon.IViewState): void {
+	public restoreState(state:editorCommon.IViewState): void {
 		var restoreScrollTop = state.scrollTop;
 		if (typeof state.scrollTopWithoutViewZones === 'number' && !this.linesLayout.hasWhitespace()) {
 			restoreScrollTop = state.scrollTopWithoutViewZones;
@@ -203,16 +202,16 @@ export class LayoutProvider extends ViewEventHandler implements Lifecycle.IDispo
 		}
 		return this.linesLayout.getTotalHeight(this.getCurrentViewport(), reserveHorizontalScrollbarHeight);
 	}
-	public getWhitespaceAtVerticalOffset(verticalOffset:number): EditorCommon.IViewWhitespaceViewportData {
+	public getWhitespaceAtVerticalOffset(verticalOffset:number): editorCommon.IViewWhitespaceViewportData {
 		return this.linesLayout.getWhitespaceAtVerticalOffset(verticalOffset);
 	}
-	public getLinesViewportData(): EditorCommon.IViewLinesViewportData {
+	public getLinesViewportData(): editorCommon.IViewLinesViewportData {
 		return this.linesLayout.getLinesViewportData(this.getCurrentViewport());
 	}
-	public getWhitespaceViewportData(): EditorCommon.IViewWhitespaceViewportData[] {
+	public getWhitespaceViewportData(): editorCommon.IViewWhitespaceViewportData[] {
 		return this.linesLayout.getWhitespaceViewportData(this.getCurrentViewport());
 	}
-	public getWhitespaces(): EditorCommon.IEditorWhitespace[] {
+	public getWhitespaces(): editorCommon.IEditorWhitespace[] {
 		return this.linesLayout.getWhitespaces();
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewLayout/scrollManager.ts
code:
@@ -4,52 +4,51 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import ScrollableElement = require('vs/base/browser/ui/scrollbar/scrollableElement');
-import ScrollableElementImpl = require('vs/base/browser/ui/scrollbar/scrollableElementImpl');
-import DomUtils = require('vs/base/browser/dom');
-import Lifecycle = require('vs/base/common/lifecycle');
-
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as dom from 'vs/base/browser/dom';
+import {IOverviewRulerLayoutInfo, IScrollableElement, IScrollableElementCreationOptions} from 'vs/base/browser/ui/scrollbar/scrollableElement';
+import {ScrollableElement} from 'vs/base/browser/ui/scrollbar/scrollableElementImpl';
+import {EventType, IConfiguration, IConfigurationChangedEvent, IScrollEvent, IViewEventBus} from 'vs/editor/common/editorCommon';
 import {EditorScrollable} from 'vs/editor/common/viewLayout/editorScrollable';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {ClassNames} from 'vs/editor/browser/editorBrowser';
 
 function addPropertyIfPresent(src:any, dst:any, prop:string): void {
 	if (src.hasOwnProperty(prop)) {
 		dst[prop] = src[prop];
 	}
 }
 
-export class ScrollManager implements Lifecycle.IDisposable {
+export class ScrollManager implements IDisposable {
 
-	private configuration: EditorCommon.IConfiguration;
-	private privateViewEventBus:EditorCommon.IViewEventBus;
+	private configuration: IConfiguration;
+	private privateViewEventBus:IViewEventBus;
 
-	private toDispose:Lifecycle.IDisposable[];
+	private toDispose:IDisposable[];
 	private scrollable: EditorScrollable;
 	private linesContent: HTMLElement;
-	private scrollbar: ScrollableElement.IScrollableElement;
+	private scrollbar: IScrollableElement;
 
-	constructor(scrollable:EditorScrollable, configuration:EditorCommon.IConfiguration, privateViewEventBus:EditorCommon.IViewEventBus, linesContent:HTMLElement, viewDomNode:HTMLElement, overflowGuardDomNode:HTMLElement) {
+	constructor(scrollable:EditorScrollable, configuration:IConfiguration, privateViewEventBus:IViewEventBus, linesContent:HTMLElement, viewDomNode:HTMLElement, overflowGuardDomNode:HTMLElement) {
 		this.toDispose = [];
 		this.scrollable = scrollable;
 		this.configuration = configuration;
 		this.privateViewEventBus = privateViewEventBus;
 		this.linesContent = linesContent;
 
-		this.toDispose.push(this.scrollable.addScrollListener((e:EditorCommon.IScrollEvent) => {
-			this.privateViewEventBus.emit(EditorCommon.EventType.ViewScrollChanged, e);
+		this.toDispose.push(this.scrollable.addScrollListener((e:IScrollEvent) => {
+			this.privateViewEventBus.emit(EventType.ViewScrollChanged, e);
 		}));
 
 		var configScrollbarOpts = this.configuration.editor.scrollbar;
 
-		var scrollbarOptions:ScrollableElement.IScrollableElementCreationOptions = {
+		var scrollbarOptions:IScrollableElementCreationOptions = {
 			scrollable: this.scrollable,
 			listenOnDomNode: viewDomNode,
 			vertical: configScrollbarOpts.vertical,
 			horizontal: configScrollbarOpts.horizontal,
-			className: EditorBrowser.ClassNames.SCROLLABLE_ELEMENT + ' ' + this.configuration.editor.theme,
+			className: ClassNames.SCROLLABLE_ELEMENT + ' ' + this.configuration.editor.theme,
 			useShadows: false,
-			saveLastScrollTimeOnClassName: EditorBrowser.ClassNames.VIEW_LINE
+			saveLastScrollTimeOnClassName: ClassNames.VIEW_LINE
 		};
 		addPropertyIfPresent(configScrollbarOpts, scrollbarOptions, 'verticalHasArrows');
 		addPropertyIfPresent(configScrollbarOpts, scrollbarOptions, 'horizontalHasArrows');
@@ -62,7 +61,7 @@ export class ScrollManager implements Lifecycle.IDisposable {
 		addPropertyIfPresent(configScrollbarOpts, scrollbarOptions, 'mouseWheelScrollSensitivity');
 
 
-		this.scrollbar = new ScrollableElementImpl.ScrollableElement(linesContent, scrollbarOptions, {
+		this.scrollbar = new ScrollableElement(linesContent, scrollbarOptions, {
 			width: this.configuration.editor.layoutInfo.contentWidth,
 			height: this.configuration.editor.layoutInfo.contentHeight,
 		});
@@ -71,7 +70,7 @@ export class ScrollManager implements Lifecycle.IDisposable {
 		this.toDispose.push(this.scrollable.addInternalSizeChangeListener(() => {
 			this.scrollbar.onElementInternalDimensions();
 		}));
-		this.toDispose.push(this.configuration.onDidChange((e:EditorCommon.IConfigurationChangedEvent) => {
+		this.toDispose.push(this.configuration.onDidChange((e:IConfigurationChangedEvent) => {
 			this.scrollbar.updateClassName(this.configuration.editor.theme);
 			if (e.scrollbar) {
 				this.scrollbar.updateOptions(this.configuration.editor.scrollbar);
@@ -101,13 +100,13 @@ export class ScrollManager implements Lifecycle.IDisposable {
 		};
 
 		// I've seen this happen both on the view dom node & on the lines content dom node.
-		this.toDispose.push(DomUtils.addDisposableListener(viewDomNode, 'scroll', (e:Event) => onBrowserDesperateReveal(viewDomNode, true, true)));
-		this.toDispose.push(DomUtils.addDisposableListener(linesContent, 'scroll', (e:Event) => onBrowserDesperateReveal(linesContent, true, false)));
-		this.toDispose.push(DomUtils.addDisposableListener(overflowGuardDomNode, 'scroll', (e:Event) => onBrowserDesperateReveal(overflowGuardDomNode, true, false)));
+		this.toDispose.push(dom.addDisposableListener(viewDomNode, 'scroll', (e:Event) => onBrowserDesperateReveal(viewDomNode, true, true)));
+		this.toDispose.push(dom.addDisposableListener(linesContent, 'scroll', (e:Event) => onBrowserDesperateReveal(linesContent, true, false)));
+		this.toDispose.push(dom.addDisposableListener(overflowGuardDomNode, 'scroll', (e:Event) => onBrowserDesperateReveal(overflowGuardDomNode, true, false)));
 	}
 
 	public dispose(): void {
-		this.toDispose = Lifecycle.disposeAll(this.toDispose);
+		this.toDispose = disposeAll(this.toDispose);
 	}
 
 	public onSizeProviderLayoutChanged(): void {
@@ -119,7 +118,7 @@ export class ScrollManager implements Lifecycle.IDisposable {
 		}
 	}
 
-	public getOverviewRulerLayoutInfo(): ScrollableElement.IOverviewRulerLayoutInfo {
+	public getOverviewRulerLayoutInfo(): IOverviewRulerLayoutInfo {
 		if (this.scrollbar) {
 			return this.scrollbar.getOverviewRulerLayoutInfo();
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts
code:
@@ -6,18 +6,17 @@
 'use strict';
 
 import 'vs/css!./contentWidgets';
-
-import * as DomUtils from 'vs/base/browser/dom';
-import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import * as EditorBrowser from 'vs/editor/browser/editorBrowser';
-import * as EditorCommon from 'vs/editor/common/editorCommon';
+import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ClassNames, ContentWidgetPositionPreference, IContentWidget, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 interface IWidgetData {
 	allowEditorOverflow: boolean;
-	widget: EditorBrowser.IContentWidget;
-	position: EditorCommon.IPosition;
-	preference: EditorBrowser.ContentWidgetPositionPreference[];
+	widget: IContentWidget;
+	position: editorCommon.IPosition;
+	preference: ContentWidgetPositionPreference[];
 	isVisible: boolean;
 }
 
@@ -52,7 +51,7 @@ export class ViewContentWidgets extends ViewPart {
 	public overflowingContentWidgetsDomNode:HTMLElement;
 	private _viewDomNode: HTMLElement;
 
-	constructor(context:EditorBrowser.IViewContext, viewDomNode:HTMLElement) {
+	constructor(context:IViewContext, viewDomNode:HTMLElement) {
 		super(context);
 		this._viewDomNode = viewDomNode;
 
@@ -61,10 +60,10 @@ export class ViewContentWidgets extends ViewPart {
 		this._contentLeft = 0;
 
 		this.domNode = document.createElement('div');
-		this.domNode.className = EditorBrowser.ClassNames.CONTENT_WIDGETS;
+		this.domNode.className = ClassNames.CONTENT_WIDGETS;
 
 		this.overflowingContentWidgetsDomNode = document.createElement('div');
-		this.overflowingContentWidgetsDomNode.className = EditorBrowser.ClassNames.OVERFLOWING_CONTENT_WIDGETS;
+		this.overflowingContentWidgetsDomNode.className = ClassNames.OVERFLOWING_CONTENT_WIDGETS;
 	}
 
 	public dispose(): void {
@@ -78,32 +77,32 @@ export class ViewContentWidgets extends ViewPart {
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		// true for inline decorations that can end up relayouting text
 		return e.inlineDecorationsChanged;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._contentWidth = layoutInfo.contentWidth;
 		this._contentLeft = layoutInfo.contentLeft;
 
@@ -120,7 +119,7 @@ export class ViewContentWidgets extends ViewPart {
 
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return true;
 	}
 	public onZonesChanged(): boolean {
@@ -135,7 +134,7 @@ export class ViewContentWidgets extends ViewPart {
 
 	// ---- end view event handlers
 
-	public addWidget(widget: EditorBrowser.IContentWidget): void {
+	public addWidget(widget: IContentWidget): void {
 		let widgetData: IWidgetData = {
 			allowEditorOverflow: widget.allowEditorOverflow || false,
 			widget: widget,
@@ -160,14 +159,14 @@ export class ViewContentWidgets extends ViewPart {
 		this.shouldRender = true;
 	}
 
-	public setWidgetPosition(widget: EditorBrowser.IContentWidget, position: EditorCommon.IPosition, preference:EditorBrowser.ContentWidgetPositionPreference[]): void {
+	public setWidgetPosition(widget: IContentWidget, position: editorCommon.IPosition, preference:ContentWidgetPositionPreference[]): void {
 		let widgetData = this._widgets[widget.getId()];
 		widgetData.position = position;
 		widgetData.preference = preference;
 		this.shouldRender = true;
 	}
 
-	public removeWidget(widget: EditorBrowser.IContentWidget): void {
+	public removeWidget(widget: IContentWidget): void {
 		let widgetId = widget.getId();
 		if (this._widgets.hasOwnProperty(widgetId)) {
 			let widgetData = this._widgets[widgetId];
@@ -181,7 +180,7 @@ export class ViewContentWidgets extends ViewPart {
 		}
 	}
 
-	private _layoutBoxInViewport(position:EditorCommon.IEditorPosition, domNode:HTMLElement, ctx:EditorBrowser.IRenderingContext): IBoxLayoutResult {
+	private _layoutBoxInViewport(position:editorCommon.IEditorPosition, domNode:HTMLElement, ctx:IRenderingContext): IBoxLayoutResult {
 
 		let visibleRange = ctx.visibleRangeForPosition(position);
 
@@ -225,7 +224,7 @@ export class ViewContentWidgets extends ViewPart {
 		};
 	}
 
-	private _layoutBoxInPage(position: EditorCommon.IEditorPosition, domNode: HTMLElement, ctx: EditorBrowser.IRenderingContext): IBoxLayoutResult {
+	private _layoutBoxInPage(position: editorCommon.IEditorPosition, domNode: HTMLElement, ctx: IRenderingContext): IBoxLayoutResult {
 		let visibleRange = ctx.visibleRangeForPosition(position);
 
 		if (!visibleRange) {
@@ -245,7 +244,7 @@ export class ViewContentWidgets extends ViewPart {
 			belowTop = visibleRange.top + this._context.configuration.editor.lineHeight,
 			left = left0 + this._contentLeft;
 
-		let domNodePosition = DomUtils.getDomNodePosition(this._viewDomNode);
+		let domNodePosition = dom.getDomNodePosition(this._viewDomNode);
 		let absoluteAboveTop = domNodePosition.top + aboveTop - document.body.scrollTop - document.documentElement.scrollTop,
 			absoluteBelowTop = domNodePosition.top + belowTop - document.body.scrollTop - document.documentElement.scrollTop,
 			absoluteLeft = domNodePosition.left + left - document.body.scrollLeft - document.documentElement.scrollLeft;
@@ -279,7 +278,7 @@ export class ViewContentWidgets extends ViewPart {
 		};
 	}
 
-	private _prepareRenderWidgetAtExactPosition(position:EditorCommon.IEditorPosition, ctx:EditorBrowser.IRenderingContext): IMyWidgetRenderData {
+	private _prepareRenderWidgetAtExactPosition(position:editorCommon.IEditorPosition, ctx:IRenderingContext): IMyWidgetRenderData {
 		let visibleRange = ctx.visibleRangeForPosition(position);
 
 		if (!visibleRange) {
@@ -292,15 +291,15 @@ export class ViewContentWidgets extends ViewPart {
 		};
 	}
 
-	private _prepareRenderWidget(widgetData:IWidgetData, ctx:EditorBrowser.IRenderingContext): IMyWidgetRenderData {
+	private _prepareRenderWidget(widgetData:IWidgetData, ctx:IRenderingContext): IMyWidgetRenderData {
 		if (!widgetData.position || !widgetData.preference) {
 			return null;
 		}
 
 		// Do not trust that widgets have a valid position
 		let validModelPosition = this._context.model.validateModelPosition(widgetData.position),
 			position = this._context.model.convertModelPositionToViewPosition(validModelPosition.lineNumber, validModelPosition.column),
-			pref:EditorBrowser.ContentWidgetPositionPreference,
+			pref:ContentWidgetPositionPreference,
 			pass:number,
 			i:number;
 
@@ -322,7 +321,7 @@ export class ViewContentWidgets extends ViewPart {
 		for (pass = 1; pass <= 2; pass++) {
 			for (i = 0; i < widgetData.preference.length; i++) {
 				pref = widgetData.preference[i];
-				if (pref === EditorBrowser.ContentWidgetPositionPreference.ABOVE) {
+				if (pref === ContentWidgetPositionPreference.ABOVE) {
 					fetchPlacement();
 					if (!placement) {
 						// Widget outside of viewport
@@ -334,7 +333,7 @@ export class ViewContentWidgets extends ViewPart {
 							left: placement.left
 						};
 					}
-				} else if (pref === EditorBrowser.ContentWidgetPositionPreference.BELOW) {
+				} else if (pref === ContentWidgetPositionPreference.BELOW) {
 					fetchPlacement();
 					if (!placement) {
 						// Widget outside of viewport
@@ -353,7 +352,7 @@ export class ViewContentWidgets extends ViewPart {
 		}
 	}
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 		let data:IMyRenderData = {},
 			renderData: IMyWidgetRenderData,
 			widgetId: string;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/currentLineHighlight/currentLineHighlight.ts
code:
@@ -6,20 +6,19 @@
 'use strict';
 
 import 'vs/css!./currentLineHighlight';
-
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDynamicViewOverlay, ILayoutProvider, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-export class CurrentLineHighlightOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
-	private _context:EditorBrowser.IViewContext;
-	private _layoutProvider:EditorBrowser.ILayoutProvider;
+export class CurrentLineHighlightOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+	private _context:IViewContext;
+	private _layoutProvider:ILayoutProvider;
 	private _selectionIsEmpty:boolean;
 	private _primaryCursorIsInEditableRange:boolean;
 	private _primaryCursorLineNumber:number;
 	private _scrollWidth:number;
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:IViewContext, layoutProvider:ILayoutProvider) {
 		super();
 		this._context = context;
 		this._layoutProvider = layoutProvider;
@@ -46,13 +45,13 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements Edi
 		this._scrollWidth = this._layoutProvider.getScrollWidth();
 		return true;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		var hasChanged = false;
 		if (this._primaryCursorIsInEditableRange !== e.isInEditableRange) {
 			this._primaryCursorIsInEditableRange = e.isInEditableRange;
@@ -64,21 +63,21 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements Edi
 		}
 		return hasChanged;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		var isEmpty = e.selection.isEmpty();
 		if (this._selectionIsEmpty !== isEmpty) {
 			this._selectionIsEmpty = isEmpty;
 			return true;
 		}
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return true;
 	}
 	public onZonesChanged(): boolean {
@@ -93,7 +92,7 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements Edi
 	}
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/decorations/decorations.ts
code:
@@ -6,20 +6,20 @@
 'use strict';
 
 import 'vs/css!./decorations';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 interface IRenderResult {
 	[lineNumber:string]:string[];
 }
 
-export class DecorationsOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
+export class DecorationsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
 
-	private _context:EditorBrowser.IViewContext;
+	private _context:IViewContext;
 	private _renderResult:IRenderResult;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._renderResult = null;
@@ -38,34 +38,34 @@ export class DecorationsOverlay extends ViewEventHandler implements EditorBrowse
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 	public onZonesChanged(): boolean {
@@ -80,7 +80,7 @@ export class DecorationsOverlay extends ViewEventHandler implements EditorBrowse
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}
@@ -121,7 +121,7 @@ export class DecorationsOverlay extends ViewEventHandler implements EditorBrowse
 		return true;
 	}
 
-	private _renderWholeLineDecorations(ctx:EditorBrowser.IRenderingContext, decorations:EditorCommon.IModelDecoration[], output: IRenderResult): void {
+	private _renderWholeLineDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: IRenderResult): void {
 		let lineHeight = String(this._context.configuration.editor.lineHeight);
 
 		for (let i = 0, lenI = decorations.length; i < lenI; i++) {
@@ -156,7 +156,7 @@ export class DecorationsOverlay extends ViewEventHandler implements EditorBrowse
 		}
 	}
 
-	private _renderNormalDecorations(ctx:EditorBrowser.IRenderingContext, decorations:EditorCommon.IModelDecoration[], output: IRenderResult): void {
+	private _renderNormalDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: IRenderResult): void {
 		let lineHeight = String(this._context.configuration.editor.lineHeight);
 
 		for (let i = 0, lenI = decorations.length; i < lenI; i++) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/glyphMargin/glyphMargin.ts
code:
@@ -6,23 +6,22 @@
 'use strict';
 
 import 'vs/css!./glyphMargin';
-
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 interface IRenderResult {
 	[lineNumber:string]:string[];
 }
 
-export class GlyphMarginOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
+export class GlyphMarginOverlay extends ViewEventHandler implements IDynamicViewOverlay {
 
-	private _context:EditorBrowser.IViewContext;
+	private _context:IViewContext;
 	private _glyphMarginLeft:number;
 	private _glyphMarginWidth:number;
 	private _renderResult:IRenderResult;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._glyphMarginLeft = 0;
@@ -42,36 +41,36 @@ export class GlyphMarginOverlay extends ViewEventHandler implements EditorBrowse
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._glyphMarginLeft = layoutInfo.glyphMarginLeft;
 		this._glyphMarginWidth = layoutInfo.glyphMarginWidth;
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 	public onZonesChanged(): boolean {
@@ -86,7 +85,7 @@ export class GlyphMarginOverlay extends ViewEventHandler implements EditorBrowse
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}
@@ -102,8 +101,8 @@ export class GlyphMarginOverlay extends ViewEventHandler implements EditorBrowse
 
 		var decorations = ctx.getDecorationsInViewport(),
 			lineHeight = this._context.configuration.editor.lineHeight.toString(),
-			d:EditorCommon.IModelDecoration,
-			rng:EditorCommon.IRange,
+			d:editorCommon.IModelDecoration,
+			rng:editorCommon.IRange,
 			i:number, lenI:number,
 			classNames:{[lineNumber:string]:{[className:string]:boolean;};} = {},
 			lineClassNames:{[className:string]:boolean;},

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/lineNumbers/lineNumbers.ts
code:
@@ -6,23 +6,23 @@
 'use strict';
 
 import 'vs/css!./lineNumbers';
+import * as platform from 'vs/base/common/platform';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import * as Platform from 'vs/base/common/platform';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {ClassNames, IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 interface IRenderResult {
 	[lineNumber:string]:string[];
 }
 
-export class LineNumbersOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
+export class LineNumbersOverlay extends ViewEventHandler implements IDynamicViewOverlay {
 
-	private _context:EditorBrowser.IViewContext;
+	private _context:IViewContext;
 	private _lineNumbersLeft:number;
 	private _lineNumbersWidth:number;
 	private _renderResult:IRenderResult;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._lineNumbersLeft = 0;
@@ -42,36 +42,36 @@ export class LineNumbersOverlay extends ViewEventHandler implements EditorBrowse
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		return false;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._lineNumbersLeft = layoutInfo.lineNumbersLeft;
 		this._lineNumbersWidth = layoutInfo.lineNumbersWidth;
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 	public onZonesChanged(): boolean {
@@ -86,7 +86,7 @@ export class LineNumbersOverlay extends ViewEventHandler implements EditorBrowse
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}
@@ -99,12 +99,12 @@ export class LineNumbersOverlay extends ViewEventHandler implements EditorBrowse
 
 		var output: IRenderResult = {};
 
-		var lineHeightClassName = (Platform.isLinux ? (this._context.configuration.editor.lineHeight % 2 === 0 ? ' lh-even': ' lh-odd') : '');
+		var lineHeightClassName = (platform.isLinux ? (this._context.configuration.editor.lineHeight % 2 === 0 ? ' lh-even': ' lh-odd') : '');
 		var lineHeight = this._context.configuration.editor.lineHeight.toString(),
 			lineNumber:number,
 			renderLineNumber:string;
 
-		var common = '<div class="' + EditorBrowser.ClassNames.LINE_NUMBERS + lineHeightClassName + '" style="left:' + this._lineNumbersLeft.toString() + 'px;width:' + this._lineNumbersWidth.toString() + 'px;height:' + lineHeight + 'px;">';
+		var common = '<div class="' + ClassNames.LINE_NUMBERS + lineHeightClassName + '" style="left:' + this._lineNumbersLeft.toString() + 'px;width:' + this._lineNumbersWidth.toString() + 'px;height:' + lineHeight + 'px;">';
 
 		for (lineNumber = ctx.visibleRange.startLineNumber; lineNumber <= ctx.visibleRange.endLineNumber; lineNumber++) {
 			renderLineNumber = this._context.model.getLineRenderLineNumber(lineNumber);

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/lines/viewLine.ts
code:
@@ -4,13 +4,13 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as Browser from 'vs/base/browser/browser';
-import {IVisibleLineData} from 'vs/editor/browser/view/viewLayer';
+import * as browser from 'vs/base/browser/browser';
+import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {HorizontalRange, IConfigurationChangedEvent, IModelDecoration} from 'vs/editor/common/editorCommon';
 import {ILineParts, createLineParts} from 'vs/editor/common/viewLayout/viewLineParts';
-import {ClassNames, IViewContext} from 'vs/editor/browser/editorBrowser';
-import {IModelDecoration, IConfigurationChangedEvent, HorizontalRange} from 'vs/editor/common/editorCommon';
 import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {ClassNames, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {IVisibleLineData} from 'vs/editor/browser/view/viewLayer';
 
 export class ViewLine implements IVisibleLineData {
 
@@ -504,7 +504,7 @@ export let createLine: (context: IViewContext) => ViewLine = (function() {
 		// IE11 doesn't need the screen.logicalXDPI / screen.deviceXDPI ratio multiplication
 		// for TextRange.getClientRects() anymore
 		return createIELine;
-	} else if (Browser.isWebKit) {
+	} else if (browser.isWebKit) {
 		return createWebKitLine;
 	}
 	return createNormalLine;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/lines/viewLines.ts
code:
@@ -4,15 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Browser = require('vs/base/browser/browser');
-import Schedulers = require('vs/base/common/async');
-
-import {createLine, ViewLine} from 'vs/editor/browser/viewParts/lines/viewLine';
-import {IVisibleLineData, ViewLayer} from 'vs/editor/browser/view/viewLayer';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {Range} from 'vs/editor/common/core/range';
+import {RunOnceScheduler} from 'vs/base/common/async';
+import * as browser from 'vs/base/browser/browser';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ClassNames, ILayoutProvider, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {IVisibleLineData, ViewLayer} from 'vs/editor/browser/view/viewLayer';
+import {ViewLine, createLine} from 'vs/editor/browser/viewParts/lines/viewLine';
 
 export class ViewLines extends ViewLayer {
 
@@ -26,28 +25,28 @@ export class ViewLines extends ViewLayer {
 	 */
 	private static HORIZONTAL_EXTRA_PX = 30;
 
-	private _layoutProvider:EditorBrowser.ILayoutProvider;
+	private _layoutProvider:ILayoutProvider;
 	_lines:ViewLine[];
 
 	public textRangeRestingSpot:HTMLElement;
 
 	// --- width
 	private _maxLineWidth: number;
-	private _asyncUpdateLineWidths: Schedulers.RunOnceScheduler;
+	private _asyncUpdateLineWidths: RunOnceScheduler;
 
-	private _currentVisibleRange: EditorCommon.IEditorRange;
+	private _currentVisibleRange: editorCommon.IEditorRange;
 
-	private _lastCursorRevealRangeHorizontallyEvent:EditorCommon.IViewRevealRangeEvent;
+	private _lastCursorRevealRangeHorizontallyEvent:editorCommon.IViewRevealRangeEvent;
 	private _bigNumbersDelta: number;
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:IViewContext, layoutProvider:ILayoutProvider) {
 		super(context);
 		this._layoutProvider = layoutProvider;
-		this.domNode.className = EditorBrowser.ClassNames.VIEW_LINES;
+		this.domNode.className = ClassNames.VIEW_LINES;
 
 		// --- width & height
 		this._maxLineWidth = 0;
-		this._asyncUpdateLineWidths = new Schedulers.RunOnceScheduler(() => {
+		this._asyncUpdateLineWidths = new RunOnceScheduler(() => {
 			this._updateLineWidths();
 		}, 200);
 
@@ -70,15 +69,15 @@ export class ViewLines extends ViewLayer {
 
 	// ---- begin view event handlers
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		var shouldRender = super.onConfigurationChanged(e);
 		if (e.wrappingInfo) {
 			this._maxLineWidth = 0;
 		}
 		return shouldRender;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		var shouldRender = super.onLayoutChanged(layoutInfo);
 		this._maxLineWidth = 0;
 		return shouldRender;
@@ -95,15 +94,15 @@ export class ViewLines extends ViewLayer {
 		return false;
 	}
 
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		var shouldRender = super.onModelDecorationsChanged(e);
 		for (var i = 0; i < this._lines.length; i++) {
 			this._lines[i].onModelDecorationsChanged();
 		}
 		return shouldRender || true;
 	}
 
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		var newScrollTop = this._computeScrollTopToRevealRange(this._layoutProvider.getCurrentViewport(), e.range, e.verticalType);
 
 		if (e.revealHorizontal) {
@@ -115,7 +114,7 @@ export class ViewLines extends ViewLayer {
 		return true;
 	}
 
-	public onCursorScrollRequest(e:EditorCommon.IViewScrollRequestEvent): boolean {
+	public onCursorScrollRequest(e:editorCommon.IViewScrollRequestEvent): boolean {
 		let currentScrollTop = this._layoutProvider.getScrollTop();
 		let newScrollTop = currentScrollTop + e.deltaLines * this._context.configuration.editor.lineHeight;
 		this._layoutProvider.setScrollTop(newScrollTop);
@@ -124,7 +123,7 @@ export class ViewLines extends ViewLayer {
 
 	private _hasVerticalScroll = false;
 	private _hasHorizontalScroll = false;
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		this._hasVerticalScroll = this._hasVerticalScroll || e.vertical;
 		this._hasHorizontalScroll = this._hasHorizontalScroll || e.horizontal;
 		return super.onScrollChanged(e);
@@ -134,7 +133,7 @@ export class ViewLines extends ViewLayer {
 
 	// ----------- HELPERS FOR OTHERS
 
-	public getPositionFromDOMInfo(spanNode:HTMLElement, offset:number): EditorCommon.IPosition {
+	public getPositionFromDOMInfo(spanNode:HTMLElement, offset:number): editorCommon.IPosition {
 		var lineNumber = this._getLineNumberFromDOMInfo(spanNode);
 
 		if (lineNumber === -1) {
@@ -174,7 +173,7 @@ export class ViewLines extends ViewLayer {
 
 	private _getLineNumberFromDOMInfo(spanNode:HTMLElement): number {
 		while (spanNode && spanNode.nodeType === 1) {
-			if (spanNode.className === EditorBrowser.ClassNames.VIEW_LINE) {
+			if (spanNode.className === ClassNames.VIEW_LINE) {
 				return parseInt(spanNode.getAttribute('lineNumber'), 10);
 			}
 			spanNode = spanNode.parentElement;
@@ -191,7 +190,7 @@ export class ViewLines extends ViewLayer {
 		return this._lines[lineIndex].getWidth();
 	}
 
-	public linesVisibleRangesForRange(range:EditorCommon.IRange, includeNewLines:boolean): EditorCommon.LineVisibleRanges[] {
+	public linesVisibleRangesForRange(range:editorCommon.IRange, includeNewLines:boolean): editorCommon.LineVisibleRanges[] {
 		if (this.shouldRender) {
 			// Cannot read from the DOM because it is dirty
 			// i.e. the model & the dom are out of sync, so I'd be reading something stale
@@ -204,8 +203,8 @@ export class ViewLines extends ViewLayer {
 			return null;
 		}
 
-		var visibleRangesForLine:EditorCommon.HorizontalRange[],
-			visibleRanges:EditorCommon.LineVisibleRanges[] = [],
+		var visibleRangesForLine:editorCommon.HorizontalRange[],
+			visibleRanges:editorCommon.LineVisibleRanges[] = [],
 			lineNumber:number,
 			lineIndex:number,
 			startColumn:number,
@@ -245,7 +244,7 @@ export class ViewLines extends ViewLayer {
 				}
 			}
 
-			visibleRanges.push(new EditorCommon.LineVisibleRanges(lineNumber, visibleRangesForLine));
+			visibleRanges.push(new editorCommon.LineVisibleRanges(lineNumber, visibleRangesForLine));
 		}
 
 		if (visibleRanges.length === 0) {
@@ -255,7 +254,7 @@ export class ViewLines extends ViewLayer {
 		return visibleRanges;
 	}
 
-	public visibleRangesForRange2(range:EditorCommon.IRange, deltaTop:number): EditorCommon.VisibleRange[] {
+	public visibleRangesForRange2(range:editorCommon.IRange, deltaTop:number): editorCommon.VisibleRange[] {
 
 		if (this.shouldRender) {
 			// Cannot read from the DOM because it is dirty
@@ -268,7 +267,7 @@ export class ViewLines extends ViewLayer {
 			return null;
 		}
 
-		let result:EditorCommon.VisibleRange[] = [];
+		let result:editorCommon.VisibleRange[] = [];
 		let boundingClientRect = this.domNode.getBoundingClientRect();
 		let clientRectDeltaLeft = boundingClientRect.left;
 
@@ -289,7 +288,7 @@ export class ViewLines extends ViewLayer {
 
 			let adjustedLineNumberVerticalOffset = this._layoutProvider.getVerticalOffsetForLineNumber(lineNumber) - this._bigNumbersDelta + deltaTop;
 			for (let i = 0, len = visibleRangesForLine.length; i < len; i++) {
-				result.push(new EditorCommon.VisibleRange(adjustedLineNumberVerticalOffset, visibleRangesForLine[i].left, visibleRangesForLine[i].width));
+				result.push(new editorCommon.VisibleRange(adjustedLineNumberVerticalOffset, visibleRangesForLine[i].left, visibleRangesForLine[i].width));
 			}
 		}
 
@@ -306,7 +305,7 @@ export class ViewLines extends ViewLayer {
 		return createLine(this._context);
 	}
 
-	private _renderAndUpdateLineHeights(linesViewportData: EditorCommon.IViewLinesViewportData): void {
+	private _renderAndUpdateLineHeights(linesViewportData: editorCommon.IViewLinesViewportData): void {
 		super._renderLines(linesViewportData);
 
 		// Update internal current visible range
@@ -345,7 +344,7 @@ export class ViewLines extends ViewLayer {
 		this._ensureMaxLineWidth(localMaxLineWidth);
 	}
 
-	public render(): EditorCommon.IViewLinesViewportData {
+	public render(): editorCommon.IViewLinesViewportData {
 
 		var linesViewportData = this._layoutProvider.getLinesViewportData();
 		this._bigNumbersDelta = linesViewportData.bigNumbersDelta;
@@ -360,7 +359,7 @@ export class ViewLines extends ViewLayer {
 		}
 
 		if (this._hasVerticalScroll || this._hasHorizontalScroll) {
-			if (Browser.canUseTranslate3d) {
+			if (browser.canUseTranslate3d) {
 				var transform = 'translate3d(' + -this._layoutProvider.getScrollLeft() + 'px, ' + linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
 				StyleMutator.setTransform(<HTMLElement>this.domNode.parentNode, transform);
 			} else {
@@ -392,7 +391,7 @@ export class ViewLines extends ViewLayer {
 		}
 	}
 
-	private _computeScrollTopToRevealRange(viewport:EditorCommon.IViewport, range: EditorCommon.IEditorRange, verticalType: EditorCommon.VerticalRevealType): number {
+	private _computeScrollTopToRevealRange(viewport:editorCommon.IViewport, range: editorCommon.IEditorRange, verticalType: editorCommon.VerticalRevealType): number {
 		var viewportStartY = viewport.top,
 			viewportHeight = viewport.height,
 			viewportEndY = viewportStartY + viewportHeight,
@@ -402,15 +401,15 @@ export class ViewLines extends ViewLayer {
 		// Have a box that includes one extra line height (for the horizontal scrollbar)
 		boxStartY = this._layoutProvider.getVerticalOffsetForLineNumber(range.startLineNumber);
 		boxEndY = this._layoutProvider.getVerticalOffsetForLineNumber(range.endLineNumber) + this._layoutProvider.heightInPxForLine(range.endLineNumber);
-		if (verticalType === EditorCommon.VerticalRevealType.Simple) {
+		if (verticalType === editorCommon.VerticalRevealType.Simple) {
 			// Reveal one line more for the arrow down case, when the last line would be covered by the scrollbar
 			boxEndY += this._context.configuration.editor.lineHeight;
 		}
 
 		var newScrollTop: number;
 
-		if (verticalType === EditorCommon.VerticalRevealType.Center || verticalType === EditorCommon.VerticalRevealType.CenterIfOutsideViewport) {
-			if (verticalType === EditorCommon.VerticalRevealType.CenterIfOutsideViewport && viewportStartY <= boxStartY && boxEndY <= viewportEndY) {
+		if (verticalType === editorCommon.VerticalRevealType.Center || verticalType === editorCommon.VerticalRevealType.CenterIfOutsideViewport) {
+			if (verticalType === editorCommon.VerticalRevealType.CenterIfOutsideViewport && viewportStartY <= boxStartY && boxEndY <= viewportEndY) {
 				// Box is already in the viewport... do nothing
 				newScrollTop = viewportStartY;
 			} else {
@@ -425,7 +424,7 @@ export class ViewLines extends ViewLayer {
 		return newScrollTop;
 	}
 
-	private _computeScrollLeftToRevealRange(range: EditorCommon.IEditorRange): { scrollLeft: number; maxHorizontalOffset: number; } {
+	private _computeScrollLeftToRevealRange(range: editorCommon.IEditorRange): { scrollLeft: number; maxHorizontalOffset: number; } {
 
 		var maxHorizontalOffset = 0;
 
@@ -454,7 +453,7 @@ export class ViewLines extends ViewLayer {
 		}
 
 		var i:number,
-			visibleRange:EditorCommon.VisibleRange;
+			visibleRange:editorCommon.VisibleRange;
 
 		for (i = 0; i < visibleRanges.length; i++) {
 			visibleRange = visibleRanges[i];

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/linesDecorations/linesDecorations.ts
code:
@@ -6,23 +6,23 @@
 'use strict';
 
 import 'vs/css!./linesDecorations';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 interface IRenderResult {
 	[lineNumber:string]:string[];
 }
 
-export class LinesDecorationsOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
+export class LinesDecorationsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
 
-	private _context:EditorBrowser.IViewContext;
+	private _context:IViewContext;
 
 	private _decorationsLeft:number;
 	private _decorationsWidth:number;
 	private _renderResult:IRenderResult;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._decorationsLeft = 0;
@@ -42,36 +42,36 @@ export class LinesDecorationsOverlay extends ViewEventHandler implements EditorB
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._decorationsLeft = layoutInfo.decorationsLeft;
 		this._decorationsWidth = layoutInfo.decorationsWidth;
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 	public onZonesChanged(): boolean {
@@ -86,7 +86,7 @@ export class LinesDecorationsOverlay extends ViewEventHandler implements EditorB
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}
@@ -97,8 +97,8 @@ export class LinesDecorationsOverlay extends ViewEventHandler implements EditorB
 
 		var decorations = ctx.getDecorationsInViewport(),
 			lineHeight = this._context.configuration.editor.lineHeight.toString(),
-			d:EditorCommon.IModelDecoration,
-			rng:EditorCommon.IRange,
+			d:editorCommon.IModelDecoration,
+			rng:editorCommon.IRange,
 			i:number, lenI:number,
 			classNames:{[top:string]:{[className:string]:boolean;};} = {},
 			lineClassNames:{[className:string]:boolean;},

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts
code:
@@ -6,15 +6,14 @@
 'use strict';
 
 import 'vs/css!./overlayWidgets';
-
-import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {IEditorLayoutInfo} from 'vs/editor/common/editorCommon';
+import {ClassNames, IOverlayWidget, IRenderingContext, IViewContext, OverlayWidgetPositionPreference} from 'vs/editor/browser/editorBrowser';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 interface IWidgetData {
-	widget: EditorBrowser.IOverlayWidget;
-	preference: EditorBrowser.OverlayWidgetPositionPreference;
+	widget: IOverlayWidget;
+	preference: OverlayWidgetPositionPreference;
 }
 
 interface IWidgetMap {
@@ -30,7 +29,7 @@ export class ViewOverlayWidgets extends ViewPart {
 	private _horizontalScrollbarHeight:number;
 	private _editorHeight:number;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super(context);
 
 		this._widgets = {};
@@ -39,7 +38,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		this._editorHeight = 0;
 
 		this.domNode = document.createElement('div');
-		this.domNode.className = EditorBrowser.ClassNames.OVERLAY_WIDGETS;
+		this.domNode.className = ClassNames.OVERLAY_WIDGETS;
 	}
 
 	public dispose(): void {
@@ -49,7 +48,7 @@ export class ViewOverlayWidgets extends ViewPart {
 
 	// ---- begin view event handlers
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:IEditorLayoutInfo): boolean {
 		this._verticalScrollbarWidth = layoutInfo.verticalScrollbarWidth;
 		this._horizontalScrollbarHeight = layoutInfo.horizontalScrollbarHeight;
 		this._editorHeight = layoutInfo.height;
@@ -62,7 +61,7 @@ export class ViewOverlayWidgets extends ViewPart {
 
 	// ---- end view event handlers
 
-	public addWidget(widget: EditorBrowser.IOverlayWidget): void {
+	public addWidget(widget: IOverlayWidget): void {
 		this._widgets[widget.getId()] = {
 			widget: widget,
 			preference: null
@@ -75,7 +74,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		this.domNode.appendChild(domNode);
 	}
 
-	public setWidgetPosition(widget: EditorBrowser.IOverlayWidget, preference:EditorBrowser.OverlayWidgetPositionPreference): void {
+	public setWidgetPosition(widget: IOverlayWidget, preference:OverlayWidgetPositionPreference): void {
 		var widgetData = this._widgets[widget.getId()];
 		widgetData.preference = preference;
 
@@ -86,7 +85,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		});
 	}
 
-	public removeWidget(widget: EditorBrowser.IOverlayWidget): void {
+	public removeWidget(widget: IOverlayWidget): void {
 		var widgetId = widget.getId();
 		if (this._widgets.hasOwnProperty(widgetId)) {
 			var widgetData = this._widgets[widgetId];
@@ -110,20 +109,20 @@ export class ViewOverlayWidgets extends ViewPart {
 			return;
 		}
 
-		if (widgetData.preference === EditorBrowser.OverlayWidgetPositionPreference.TOP_RIGHT_CORNER) {
+		if (widgetData.preference === OverlayWidgetPositionPreference.TOP_RIGHT_CORNER) {
 			if (!domNode.hasAttribute(_RESTORE_STYLE_TOP)) {
 				domNode.setAttribute(_RESTORE_STYLE_TOP, domNode.style.top);
 			}
 			StyleMutator.setTop(domNode, 0);
 			StyleMutator.setRight(domNode, (2 * this._verticalScrollbarWidth));
-		} else if (widgetData.preference === EditorBrowser.OverlayWidgetPositionPreference.BOTTOM_RIGHT_CORNER) {
+		} else if (widgetData.preference === OverlayWidgetPositionPreference.BOTTOM_RIGHT_CORNER) {
 			if (!domNode.hasAttribute(_RESTORE_STYLE_TOP)) {
 				domNode.setAttribute(_RESTORE_STYLE_TOP, domNode.style.top);
 			}
 			var widgetHeight = domNode.clientHeight;
 			StyleMutator.setTop(domNode, (this._editorHeight - widgetHeight - 2 * this._horizontalScrollbarHeight));
 			StyleMutator.setRight(domNode, (2 * this._verticalScrollbarWidth));
-		} else if (widgetData.preference === EditorBrowser.OverlayWidgetPositionPreference.TOP_CENTER) {
+		} else if (widgetData.preference === OverlayWidgetPositionPreference.TOP_CENTER) {
 			if (!domNode.hasAttribute(_RESTORE_STYLE_TOP)) {
 				domNode.setAttribute(_RESTORE_STYLE_TOP, domNode.style.top);
 			}
@@ -132,7 +131,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		}
 	}
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 		var widgetId:string;
 
 		this._requestModificationFrame(() => {
@@ -144,7 +143,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		});
 	}
 
-	public onReadAfterForcedLayout(ctx:EditorBrowser.IRenderingContext): void {
+	public onReadAfterForcedLayout(ctx:IRenderingContext): void {
 		// Overwriting to bypass `shouldRender` flag
 		this._render(ctx);
 		return null;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/overviewRuler/decorationsOverviewRuler.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
+import * as themes from 'vs/platform/theme/common/themes';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {IOverviewRulerZone, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Themes = require('vs/platform/theme/common/themes');
+import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
 
 export class DecorationsOverviewRuler extends ViewPart {
 
@@ -24,18 +24,18 @@ export class DecorationsOverviewRuler extends ViewPart {
 	private _shouldForceRender:boolean;
 	private _hideCursor:boolean;
 
-	private _zonesFromDecorations: EditorBrowser.IOverviewRulerZone[];
-	private _zonesFromCursors: EditorBrowser.IOverviewRulerZone[];
+	private _zonesFromDecorations: IOverviewRulerZone[];
+	private _zonesFromCursors: IOverviewRulerZone[];
 
-	private _cursorPositions: EditorCommon.IEditorPosition[];
+	private _cursorPositions: editorCommon.IEditorPosition[];
 
-	constructor(context:EditorBrowser.IViewContext, scrollHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
+	constructor(context:IViewContext, scrollHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
 		super(context);
 		this._overviewRuler = new OverviewRulerImpl(1, 'decorationsOverviewRuler', scrollHeight, this._context.configuration.editor.lineHeight,
 					DecorationsOverviewRuler.DECORATION_HEIGHT, DecorationsOverviewRuler.DECORATION_HEIGHT, getVerticalOffsetForLine);
 		this._overviewRuler.setLanesCount(this._context.configuration.editor.overviewRulerLanes, false);
 		let theme = this._context.configuration.editor.theme;
-		this._overviewRuler.setUseDarkColor(!Themes.isLightTheme(theme), false);
+		this._overviewRuler.setUseDarkColor(!themes.isLightTheme(theme), false);
 
 		this._shouldUpdateDecorations = true;
 		this._zonesFromDecorations = [];
@@ -56,14 +56,14 @@ export class DecorationsOverviewRuler extends ViewPart {
 
 	// ---- begin view event handlers
 
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		this._shouldUpdateCursorPosition = true;
 		this._cursorPositions = [ e.position ];
 		this._cursorPositions = this._cursorPositions.concat(e.secondaryPositions);
 		return true;
 	}
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		var prevLanesCount = this._overviewRuler.getLanesCount();
 		var newLanesCount = this._context.configuration.editor.overviewRulerLanes;
 
@@ -89,15 +89,15 @@ export class DecorationsOverviewRuler extends ViewPart {
 
 		if (e.theme) {
 			let theme = this._context.configuration.editor.theme;
-			this._overviewRuler.setUseDarkColor(!Themes.isLightTheme(theme), false);
+			this._overviewRuler.setUseDarkColor(!themes.isLightTheme(theme), false);
 			this._shouldForceRender = true;
 			shouldRender = true;
 		}
 
 		return shouldRender;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		this._shouldForceRender = true;
 		this._requestModificationFrame(() => {
 			this._overviewRuler.setLayout(layoutInfo.overviewRuler, false);
@@ -115,7 +115,7 @@ export class DecorationsOverviewRuler extends ViewPart {
 		return true;
 	}
 
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		this._shouldUpdateDecorations = true;
 		return true;
 	}
@@ -132,12 +132,12 @@ export class DecorationsOverviewRuler extends ViewPart {
 		return this._overviewRuler.getDomNode();
 	}
 
-	private _createZonesFromDecorations(): EditorBrowser.IOverviewRulerZone[] {
+	private _createZonesFromDecorations(): IOverviewRulerZone[] {
 		var decorations = this._context.model.getAllDecorations(),
-			zones:EditorBrowser.IOverviewRulerZone[] = [],
+			zones:IOverviewRulerZone[] = [],
 			i:number,
 			len:number,
-			dec:EditorCommon.IModelDecoration;
+			dec:editorCommon.IModelDecoration;
 
 		for (i = 0, len = decorations.length; i < len; i++) {
 			dec = decorations[i];
@@ -155,11 +155,11 @@ export class DecorationsOverviewRuler extends ViewPart {
 		return zones;
 	}
 
-	private _createZonesFromCursors(): EditorBrowser.IOverviewRulerZone[] {
-		var zones:EditorBrowser.IOverviewRulerZone[] = [],
+	private _createZonesFromCursors(): IOverviewRulerZone[] {
+		var zones:IOverviewRulerZone[] = [],
 			i:number,
 			len:number,
-			cursor:EditorCommon.IEditorPosition;
+			cursor:editorCommon.IEditorPosition;
 
 		for (i = 0, len = this._cursorPositions.length; i < len; i++) {
 			cursor = this._cursorPositions[i];
@@ -170,14 +170,14 @@ export class DecorationsOverviewRuler extends ViewPart {
 				endLineNumber: cursor.lineNumber,
 				color: DecorationsOverviewRuler._CURSOR_COLOR,
 				darkColor: DecorationsOverviewRuler._CURSOR_COLOR_DARK,
-				position: EditorCommon.OverviewRulerLane.Full
+				position: editorCommon.OverviewRulerLane.Full
 			});
 		}
 
 		return zones;
 	}
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 
 		var shouldForceRender = this._shouldForceRender;
 		this._shouldForceRender = false;
@@ -200,7 +200,7 @@ export class DecorationsOverviewRuler extends ViewPart {
 				}
 			}
 
-			var allZones:EditorBrowser.IOverviewRulerZone[] = [];
+			var allZones:IOverviewRulerZone[] = [];
 			allZones = allZones.concat(this._zonesFromCursors);
 			allZones = allZones.concat(this._zonesFromDecorations);
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/overviewRuler/overviewRuler.ts
code:
@@ -4,17 +4,17 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
+import {IConfigurationChangedEvent, IOverviewRulerPosition} from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IOverviewRuler, IOverviewRulerZone, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
 
-export class OverviewRuler extends ViewEventHandler implements EditorBrowser.IOverviewRuler {
+export class OverviewRuler extends ViewEventHandler implements IOverviewRuler {
 
-	private _context:EditorBrowser.IViewContext;
+	private _context:IViewContext;
 	private _overviewRuler:OverviewRulerImpl;
 
-	constructor(context:EditorBrowser.IViewContext, cssClassName:string, scrollHeight:number, minimumHeight:number, maximumHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
+	constructor(context:IViewContext, cssClassName:string, scrollHeight:number, minimumHeight:number, maximumHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
 		super();
 		this._context = context;
 		this._overviewRuler = new OverviewRulerImpl(0, cssClassName, scrollHeight, this._context.configuration.editor.lineHeight,
@@ -32,7 +32,7 @@ export class OverviewRuler extends ViewEventHandler implements EditorBrowser.IOv
 		this._overviewRuler.dispose();
 	}
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:IConfigurationChangedEvent): boolean {
 		if (e.lineHeight) {
 			this._overviewRuler.setLineHeight(this._context.configuration.editor.lineHeight, true);
 			return true;
@@ -57,11 +57,11 @@ export class OverviewRuler extends ViewEventHandler implements EditorBrowser.IOv
 		return this._overviewRuler.getDomNode();
 	}
 
-	public setLayout(position:EditorCommon.IOverviewRulerPosition): void {
+	public setLayout(position:IOverviewRulerPosition): void {
 		this._overviewRuler.setLayout(position, true);
 	}
 
-	public setZones(zones:EditorBrowser.IOverviewRulerZone[]): void {
+	public setZones(zones:IOverviewRulerZone[]): void {
 		this._overviewRuler.setZones(zones, true);
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl.ts
code:
@@ -4,11 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Browser = require('vs/base/browser/browser');
+import * as browser from 'vs/base/browser/browser';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
-
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IOverviewRulerPosition, OverviewRulerLane} from 'vs/editor/common/editorCommon';
+import {IOverviewRulerZone} from 'vs/editor/browser/editorBrowser';
 
 interface IColorZone {
 	from: number;
@@ -19,7 +18,7 @@ interface IColorZoneMap {
 	[color:string]:IColorZone[];
 }
 
-function zoneEquals(a:EditorBrowser.IOverviewRulerZone, b:EditorBrowser.IOverviewRulerZone): boolean {
+function zoneEquals(a:IOverviewRulerZone, b:IOverviewRulerZone): boolean {
 	return (
 		a.startLineNumber === b.startLineNumber
 		&& a.endLineNumber === b.endLineNumber
@@ -29,7 +28,7 @@ function zoneEquals(a:EditorBrowser.IOverviewRulerZone, b:EditorBrowser.IOvervie
 	);
 }
 
-function zonesEqual(a:EditorBrowser.IOverviewRulerZone[], b:EditorBrowser.IOverviewRulerZone[]): boolean {
+function zonesEqual(a:IOverviewRulerZone[], b:IOverviewRulerZone[]): boolean {
 	if (a === b) {
 		return true;
 	}
@@ -52,8 +51,8 @@ export class OverviewRulerImpl {
 	private _minimumHeight: number;
 	private _maximumHeight: number;
 	private _getVerticalOffsetForLine:(lineNumber:number)=>number;
-	private _zones:EditorBrowser.IOverviewRulerZone[];
-	private _renderedZones:EditorBrowser.IOverviewRulerZone[];
+	private _zones:IOverviewRulerZone[];
+	private _renderedZones:IOverviewRulerZone[];
 	private _canvasLeftOffset: number;
 
 	private _domNode: HTMLCanvasElement;
@@ -77,7 +76,7 @@ export class OverviewRulerImpl {
 		this._domNode = <HTMLCanvasElement>document.createElement('canvas');
 		this._domNode.className = cssClassName;
 		this._domNode.style.position = 'absolute';
-		if (Browser.canUseTranslate3d) {
+		if (browser.canUseTranslate3d) {
 			this._domNode.style.transform = 'translate3d(0px, 0px, 0px)';
 		}
 
@@ -92,7 +91,7 @@ export class OverviewRulerImpl {
 		this._zones = [];
 	}
 
-	public setLayout(position:EditorCommon.IOverviewRulerPosition, render:boolean): void {
+	public setLayout(position:IOverviewRulerPosition, render:boolean): void {
 		StyleMutator.setTop(this._domNode, position.top);
 		StyleMutator.setRight(this._domNode, position.right);
 
@@ -154,7 +153,7 @@ export class OverviewRulerImpl {
 		}
 	}
 
-	public setZones(zones:EditorBrowser.IOverviewRulerZone[], render:boolean): void {
+	public setZones(zones:IOverviewRulerZone[], render:boolean): void {
 		this._zones = zones;
 		if (render) {
 			this.render(false);
@@ -187,7 +186,7 @@ export class OverviewRulerImpl {
 		});
 	}
 
-	private _getColorForZone(zone:EditorBrowser.IOverviewRulerZone): string {
+	private _getColorForZone(zone:IOverviewRulerZone): string {
 		if (this._useDarkColor) {
 			return zone.darkColor;
 		}
@@ -196,7 +195,7 @@ export class OverviewRulerImpl {
 
 	private _renderVerticalPatch(ctx:CanvasRenderingContext2D, heightRatio:number, laneMask:number, xpos:number, width:number): void {
 		var colorsZones:IColorZoneMap = {};
-		var i:number, len:number, zone:EditorBrowser.IOverviewRulerZone, y1:number, y2:number, zoneLineNumbers:number, zoneMaximumHeight:number;
+		var i:number, len:number, zone:IOverviewRulerZone, y1:number, y2:number, zoneLineNumbers:number, zoneMaximumHeight:number;
 		for (i = 0, len = this._zones.length; i < len; i++) {
 			zone = this._zones[i];
 
@@ -295,7 +294,7 @@ export class OverviewRulerImpl {
 
 	private _renderOneLane(ctx:CanvasRenderingContext2D, heightRatio:number, w:number): void {
 
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Left | EditorCommon.OverviewRulerLane.Center | EditorCommon.OverviewRulerLane.Right, this._canvasLeftOffset, w);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left | OverviewRulerLane.Center | OverviewRulerLane.Right, this._canvasLeftOffset, w);
 
 	}
 
@@ -306,8 +305,8 @@ export class OverviewRulerImpl {
 			leftOffset = this._canvasLeftOffset,
 			rightOffset = this._canvasLeftOffset + leftWidth;
 
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Left | EditorCommon.OverviewRulerLane.Center, leftOffset, leftWidth);
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Right, rightOffset, rightWidth);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left | OverviewRulerLane.Center, leftOffset, leftWidth);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Right, rightOffset, rightWidth);
 	}
 
 	private _renderThreeLanes(ctx:CanvasRenderingContext2D, heightRatio:number, w:number): void {
@@ -319,8 +318,8 @@ export class OverviewRulerImpl {
 			centerOffset = this._canvasLeftOffset + leftWidth,
 			rightOffset = this._canvasLeftOffset + leftWidth + centerWidth;
 
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Left, leftOffset, leftWidth);
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Center, centerOffset, centerWidth);
-		this._renderVerticalPatch(ctx, heightRatio, EditorCommon.OverviewRulerLane.Right, rightOffset, rightWidth);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left, leftOffset, leftWidth);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Center, centerOffset, centerWidth);
+		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Right, rightOffset, rightWidth);
 	}
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/rulers/rulers.css
code:
@@ -10,5 +10,5 @@
 	background: lightgrey;
 }
 .monaco-editor.vs-dark .view-ruler {
-	background: darkgrey;
+	background: #5A5A5A;
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/rulers/rulers.ts
code:
@@ -6,21 +6,20 @@
 'use strict';
 
 import 'vs/css!./rulers';
-
-import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {IConfigurationChangedEvent} from 'vs/editor/common/editorCommon';
+import {ILayoutProvider, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export class Rulers extends ViewPart {
 
 	public domNode: HTMLElement;
-	private _layoutProvider:EditorBrowser.ILayoutProvider;
+	private _layoutProvider:ILayoutProvider;
 	private _rulers: number[];
 	private _height: number;
 	private _typicalHalfwidthCharacterWidth: number;
 
-	constructor(context:EditorBrowser.IViewContext, layoutProvider:EditorBrowser.ILayoutProvider) {
+	constructor(context:IViewContext, layoutProvider:ILayoutProvider) {
 		super(context);
 		this._layoutProvider = layoutProvider;
 		this.domNode = document.createElement('div');
@@ -36,7 +35,7 @@ export class Rulers extends ViewPart {
 
 	// --- begin event handlers
 
-	public onConfigurationChanged(e: EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e: IConfigurationChangedEvent): boolean {
 		if (e.rulers || e.layoutInfo || e.typicalHalfwidthCharacterWidth) {
 			this._rulers = this._context.configuration.editor.rulers;
 			this._height = this._context.configuration.editor.layoutInfo.contentHeight;
@@ -48,7 +47,7 @@ export class Rulers extends ViewPart {
 
 	// --- end event handlers
 
-	_render(ctx: EditorBrowser.IRenderingContext): void {
+	_render(ctx: IRenderingContext): void {
 		this._requestModificationFrame(() => {
 			let existingRulersLength = this.domNode.children.length;
 			let max = Math.max(existingRulersLength, this._rulers.length);

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/scrollDecoration/scrollDecoration.ts
code:
@@ -6,12 +6,11 @@
 'use strict';
 
 import 'vs/css!./scrollDecoration';
-import DomUtils = require('vs/base/browser/dom');
-
-import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {IConfigurationChangedEvent, IEditorLayoutInfo, IScrollEvent} from 'vs/editor/common/editorCommon';
+import {ClassNames, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export class ScrollDecorationViewPart extends ViewPart {
 
@@ -20,7 +19,7 @@ export class ScrollDecorationViewPart extends ViewPart {
 	private _width: number;
 	private _shouldShow: boolean;
 
-	constructor(context: EditorBrowser.IViewContext) {
+	constructor(context: IViewContext) {
 		super(context);
 
 		this._scrollTop = 0;
@@ -44,27 +43,27 @@ export class ScrollDecorationViewPart extends ViewPart {
 
 	// --- begin event handlers
 
-	public onConfigurationChanged(e: EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e: IConfigurationChangedEvent): boolean {
 		return this._updateShouldShow();
 	}
-	public onLayoutChanged(layoutInfo: EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo: IEditorLayoutInfo): boolean {
 		if (this._width !== layoutInfo.width) {
 			this._width = layoutInfo.width;
 			return true;
 		}
 		return false;
 	}
-	public onScrollChanged(e: EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e: IScrollEvent): boolean {
 		this._scrollTop = e.scrollTop;
 		return this._updateShouldShow();
 	}
 
 	// --- end event handlers
 
-	_render(ctx: EditorBrowser.IRenderingContext): void {
+	_render(ctx: IRenderingContext): void {
 		this._requestModificationFrame(() => {
 			StyleMutator.setWidth(this._domNode, this._width);
-			DomUtils.toggleClass(this._domNode, EditorBrowser.ClassNames.SCROLL_DECORATION, this._shouldShow);
+			dom.toggleClass(this._domNode, ClassNames.SCROLL_DECORATION, this._shouldShow);
 		});
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/selections/selections.ts
code:
@@ -6,12 +6,12 @@
 'use strict';
 
 import 'vs/css!./selections';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-type HorizontalRange = EditorCommon.HorizontalRange;
-type LineVisibleRanges = EditorCommon.LineVisibleRanges;
+type HorizontalRange = editorCommon.HorizontalRange;
+type LineVisibleRanges = editorCommon.LineVisibleRanges;
 
 interface IRenderResult {
 	[lineNumber:string]:string[];
@@ -69,7 +69,7 @@ const isIEWithZoomingIssuesNearRoundedBorders = (
 );
 
 
-export class SelectionsOverlay extends ViewEventHandler implements EditorBrowser.IDynamicViewOverlay {
+export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
 
 	private static SELECTION_CLASS_NAME = 'selected-text';
 	private static SELECTION_TOP_LEFT = 'top-left-radius';
@@ -80,11 +80,11 @@ export class SelectionsOverlay extends ViewEventHandler implements EditorBrowser
 
 	private static ROUNDED_PIECE_WIDTH = 10;
 
-	private _context:EditorBrowser.IViewContext;
-	private _selections:EditorCommon.IEditorRange[];
+	private _context:IViewContext;
+	private _selections:editorCommon.IEditorRange[];
 	private _renderResult:IRenderResult;
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._selections = [];
@@ -104,37 +104,37 @@ export class SelectionsOverlay extends ViewEventHandler implements EditorBrowser
 	public onModelFlushed(): boolean {
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		// true for inline decorations that can end up relayouting text
 		return e.inlineDecorationsChanged;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		return false;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		this._selections = [e.selection];
 		this._selections = this._selections.concat(e.secondarySelections);
 		return true;
 	}
-	public onCursorRevealRange(e:EditorCommon.IViewRevealRangeEvent): boolean {
+	public onCursorRevealRange(e:editorCommon.IViewRevealRangeEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 	public onZonesChanged(): boolean {
@@ -272,7 +272,7 @@ export class SelectionsOverlay extends ViewEventHandler implements EditorBrowser
 		}
 	}
 
-	private _getVisibleRangesWithStyle(selection: EditorCommon.IEditorRange, ctx: EditorBrowser.IRenderingContext, previousFrame:LineVisibleRangesWithStyle[]): LineVisibleRangesWithStyle[] {
+	private _getVisibleRangesWithStyle(selection: editorCommon.IEditorRange, ctx: IRenderingContext, previousFrame:LineVisibleRangesWithStyle[]): LineVisibleRangesWithStyle[] {
 		let _linesVisibleRanges = ctx.linesVisibleRangesForRange(selection, true) || [];
 		let linesVisibleRanges = _linesVisibleRanges.map(toStyled);
 		let visibleRangesHaveGaps = this._visibleRangesHaveGaps(linesVisibleRanges);
@@ -384,14 +384,14 @@ export class SelectionsOverlay extends ViewEventHandler implements EditorBrowser
 	}
 
 	private _previousFrameVisibleRangesWithStyle: LineVisibleRangesWithStyle[][] = [];
-	public shouldCallRender2(ctx:EditorBrowser.IRenderingContext): boolean {
+	public shouldCallRender2(ctx:IRenderingContext): boolean {
 		if (!this.shouldRender) {
 			return false;
 		}
 		this.shouldRender = false;
 
 		var output: IRenderResult = {},
-			selection:EditorCommon.IEditorRange,
+			selection:editorCommon.IEditorRange,
 			visibleRangesWithStyle:LineVisibleRangesWithStyle[],
 			piecesCount = 0,
 			i:number,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/viewCursors/viewCursor.ts
code:
@@ -4,21 +4,21 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {IConfigurationChangedEvent, IPosition} from 'vs/editor/common/editorCommon';
+import {IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 export class ViewCursor {
-	private _context:EditorBrowser.IViewContext;
-	private _position: EditorCommon.IPosition;
+	private _context:IViewContext;
+	private _position: IPosition;
 	private _domNode:HTMLElement;
 	private _positionTop:number;
 	private _positionLeft:number;
 	private _isInEditableRange:boolean;
 	private _isVisible:boolean;
 	private _isInViewport:boolean;
 
-	constructor(context:EditorBrowser.IViewContext, isSecondary:boolean) {
+	constructor(context:IViewContext, isSecondary:boolean) {
 		this._context = context;
 
 		this._isInEditableRange = true;
@@ -58,7 +58,7 @@ export class ViewCursor {
 		return this._positionTop;
 	}
 
-	public getPosition(): EditorCommon.IPosition {
+	public getPosition(): IPosition {
 		return this._position;
 	}
 
@@ -85,20 +85,20 @@ export class ViewCursor {
 		return true;
 	}
 
-	public onCursorPositionChanged(position: EditorCommon.IPosition, isInEditableRange: boolean): boolean {
+	public onCursorPositionChanged(position: IPosition, isInEditableRange: boolean): boolean {
 		this.updatePosition(position);
 		this._isInEditableRange = isInEditableRange;
 		return true;
 	}
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:IConfigurationChangedEvent): boolean {
 		if (e.lineHeight) {
 			StyleMutator.setHeight(this._domNode, this._context.configuration.editor.lineHeight);
 		}
 		return true;
 	}
 
-	public prepareRender(ctx:EditorBrowser.IRenderingContext): void {
+	public prepareRender(ctx:IRenderingContext): void {
 		var visibleRange = ctx.visibleRangeForPosition(this._position);
 		if (visibleRange) {
 			this._positionTop = visibleRange.top;
@@ -109,7 +109,7 @@ export class ViewCursor {
 		}
 	}
 
-	public render(ctx:EditorBrowser.IRestrictedRenderingContext): void {
+	public render(ctx:IRestrictedRenderingContext): void {
 		if (this._isInViewport) {
 			StyleMutator.setDisplay(this._domNode, 'block');
 			StyleMutator.setLeft(this._domNode, this._positionLeft);
@@ -119,7 +119,7 @@ export class ViewCursor {
 		}
 	}
 
-	private updatePosition(newPosition:EditorCommon.IPosition): void {
+	private updatePosition(newPosition:IPosition): void {
 		this._position = newPosition;
 		this._domNode.setAttribute('lineNumber', this._position.lineNumber.toString());
 		this._domNode.setAttribute('column', this._position.column.toString());

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/viewCursors/viewCursors.ts
code:
@@ -6,12 +6,11 @@
 'use strict';
 
 import 'vs/css!./viewCursors';
-import Browser = require('vs/base/browser/browser');
-
-import {ViewCursor} from 'vs/editor/browser/viewParts/viewCursors/viewCursor';
+import * as browser from 'vs/base/browser/browser';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ClassNames, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {ViewCursor} from 'vs/editor/browser/viewParts/viewCursors/viewCursor';
 
 enum RenderType {
 	Hidden,
@@ -34,15 +33,15 @@ export class ViewCursors extends ViewPart {
 	private _primaryCursor: ViewCursor;
 	private _secondaryCursors: ViewCursor[];
 
-	constructor(context:EditorBrowser.IViewContext) {
+	constructor(context:IViewContext) {
 		super(context);
 
 		this._primaryCursor = new ViewCursor(this._context, false);
 		this._secondaryCursors = [];
 
 		this._domNode = document.createElement('div');
 		this._updateDomClassName();
-		if (Browser.canUseTranslate3d) {
+		if (browser.canUseTranslate3d) {
 			this._domNode.style.transform = 'translate3d(0px, 0px, 0px)';
 		}
 
@@ -77,21 +76,21 @@ export class ViewCursors extends ViewPart {
 		this._secondaryCursors = [];
 		return true;
 	}
-	public onModelDecorationsChanged(e:EditorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
 		// true for inline decorations that can end up relayouting text
 		return e.inlineDecorationsChanged;
 	}
-	public onModelLinesDeleted(e:EditorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:EditorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onModelTokensChanged(e:EditorCommon.IViewTokensChangedEvent): boolean {
-		var shouldRender = (position:EditorCommon.IPosition) => {
+	public onModelTokensChanged(e:editorCommon.IViewTokensChangedEvent): boolean {
+		var shouldRender = (position:editorCommon.IPosition) => {
 			return e.fromLineNumber <= position.lineNumber && position.lineNumber <= e.toLineNumber;
 		};
 		if (shouldRender(this._primaryCursor.getPosition())) {
@@ -104,7 +103,7 @@ export class ViewCursors extends ViewPart {
 		}
 		return false;
 	}
-	public onCursorPositionChanged(e:EditorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
 		this._primaryCursor.onCursorPositionChanged(e.position, e.isInEditableRange);
 		this._updateBlinking();
 
@@ -131,10 +130,10 @@ export class ViewCursors extends ViewPart {
 
 		return true;
 	}
-	public onCursorSelectionChanged(e:EditorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		this._primaryCursor.onConfigurationChanged(e);
 		this._updateBlinking();
 		if (e.cursorStyle) {
@@ -145,10 +144,10 @@ export class ViewCursors extends ViewPart {
 		}
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return true;
 	}
 	public onZonesChanged(): boolean {
@@ -167,7 +166,7 @@ export class ViewCursors extends ViewPart {
 	}
 	// --- end event handlers
 
-	public getPosition(): EditorCommon.IPosition {
+	public getPosition(): editorCommon.IPosition {
 		return this._primaryCursor.getPosition();
 	}
 
@@ -217,7 +216,7 @@ export class ViewCursors extends ViewPart {
 	}
 
 	private _getClassName(): string {
-		let result = EditorBrowser.ClassNames.VIEW_CURSORS_LAYER;
+		let result = ClassNames.VIEW_CURSORS_LAYER;
 		let extraClassName: string;
 		switch (this._context.configuration.editor.cursorStyle) {
 			case 'line':
@@ -258,7 +257,7 @@ export class ViewCursors extends ViewPart {
 
 	// ---- IViewPart implementation
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 		this._primaryCursor.prepareRender(ctx);
 		for (var i = 0, len = this._secondaryCursors.length; i < len; i++) {
 			this._secondaryCursors[i].prepareRender(ctx);

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/viewParts/viewZones/viewZones.ts
code:
@@ -4,35 +4,34 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import errors = require('vs/base/common/errors');
-
-import {ViewPart} from 'vs/editor/browser/view/viewPart';
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ClassNames, IRenderingContext, IViewContext, IViewZone} from 'vs/editor/browser/editorBrowser';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export interface IMyViewZone {
 	whitespaceId: number;
-	delegate: EditorBrowser.IViewZone;
+	delegate: IViewZone;
 	isVisible: boolean;
 }
 
 export interface IMyRenderData {
-	data: EditorCommon.IViewWhitespaceViewportData[];
+	data: editorCommon.IViewWhitespaceViewportData[];
 }
 
 export class ViewZones extends ViewPart {
 
-	private _whitespaceManager:EditorCommon.IWhitespaceManager;
+	private _whitespaceManager:editorCommon.IWhitespaceManager;
 	private _zones: { [id:string]:IMyViewZone; };
 
 	public domNode: HTMLElement;
 
-	constructor(context:EditorBrowser.IViewContext, whitespaceManager:EditorCommon.IWhitespaceManager) {
+	constructor(context:IViewContext, whitespaceManager:editorCommon.IWhitespaceManager) {
 		super(context);
 		this._whitespaceManager = whitespaceManager;
 		this.domNode = document.createElement('div');
-		this.domNode.className = EditorBrowser.ClassNames.VIEW_ZONES;
+		this.domNode.className = ClassNames.VIEW_ZONES;
 		this.domNode.style.position = 'absolute';
 		this.domNode.setAttribute('role', 'presentation');
 		this.domNode.setAttribute('aria-hidden', 'true');
@@ -47,7 +46,7 @@ export class ViewZones extends ViewPart {
 
 	// ---- begin view event handlers
 
-	public onConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 
 		if (e.lineHeight) {
 			var id:string,
@@ -99,11 +98,11 @@ export class ViewZones extends ViewPart {
 		return hadAChange;
 	}
 
-	public onLayoutChanged(layoutInfo:EditorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
 
-	public onScrollChanged(e:EditorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
 		return e.vertical;
 	}
 
@@ -115,17 +114,17 @@ export class ViewZones extends ViewPart {
 		return true;
 	}
 
-	public onModelLinesDeleted(e:EditorCommon.IModelContentChangedLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e:editorCommon.IModelContentChangedLinesDeletedEvent): boolean {
 		return true;
 	}
 
-	public onModelLinesInserted(e:EditorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
 
 	// ---- end view event handlers
 
-	private _getZoneOrdinal(zone:EditorBrowser.IViewZone): number {
+	private _getZoneOrdinal(zone:IViewZone): number {
 
 		if (typeof zone.afterColumn !== 'undefined') {
 			return zone.afterColumn;
@@ -135,12 +134,12 @@ export class ViewZones extends ViewPart {
 	}
 
 
-	private _computeWhitespaceAfterLineNumber(zone:EditorBrowser.IViewZone): number {
+	private _computeWhitespaceAfterLineNumber(zone:IViewZone): number {
 		if (zone.afterLineNumber === 0) {
 			return 0;
 		}
 
-		var zoneAfterModelPosition:EditorCommon.IPosition;
+		var zoneAfterModelPosition:editorCommon.IPosition;
 		if (typeof zone.afterColumn !== 'undefined') {
 			zoneAfterModelPosition = this._context.model.validateModelPosition({
 				lineNumber: zone.afterLineNumber,
@@ -162,7 +161,7 @@ export class ViewZones extends ViewPart {
 		return viewPosition.lineNumber;
 	}
 
-	public addZone(zone:EditorBrowser.IViewZone): number {
+	public addZone(zone:IViewZone): number {
 		var computedHeight = this._heightInPixels(zone);
 		var whitespaceId = this._whitespaceManager.addWhitespace(this._computeWhitespaceAfterLineNumber(zone), this._getZoneOrdinal(zone), computedHeight);
 
@@ -240,7 +239,7 @@ export class ViewZones extends ViewPart {
 		return false;
 	}
 
-	private _heightInPixels(zone:EditorBrowser.IViewZone): number {
+	private _heightInPixels(zone:IViewZone): number {
 		if (typeof zone.heightInPx === 'number') {
 			return zone.heightInPx;
 		}
@@ -250,31 +249,31 @@ export class ViewZones extends ViewPart {
 		return this._context.configuration.editor.lineHeight;
 	}
 
-	private _safeCallOnComputedHeight(zone: EditorBrowser.IViewZone, height: number): void {
+	private _safeCallOnComputedHeight(zone: IViewZone, height: number): void {
 		if (typeof zone.onComputedHeight === 'function') {
 			try {
 				zone.onComputedHeight(height);
 			} catch (e) {
-				errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 			}
 		}
 	}
 
-	private _safeCallOnDomNodeTop(zone: EditorBrowser.IViewZone, top: number): void {
+	private _safeCallOnDomNodeTop(zone: IViewZone, top: number): void {
 		if (typeof zone.onDomNodeTop === 'function') {
 			try {
 				zone.onDomNodeTop(top);
 			} catch (e) {
-				errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 			}
 		}
 	}
 
-	_render(ctx:EditorBrowser.IRenderingContext): void {
+	_render(ctx:IRenderingContext): void {
 		var visibleWhitespaces = this._whitespaceManager.getWhitespaceViewportData();
 
 		this._requestModificationFrame(() => {
-			var visibleZones:{[id:string]:EditorCommon.IViewWhitespaceViewportData;} = {},
+			var visibleZones:{[id:string]:editorCommon.IViewWhitespaceViewportData;} = {},
 				i:number,
 				len:number,
 				hasVisibleZone = false;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/widget/codeEditorWidget.ts
code:
@@ -4,45 +4,44 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import 'vs/css!./media/default-theme';
 import 'vs/css!./media/editor';
 import 'vs/css!./media/tokens';
-import 'vs/css!./media/default-theme';
-
-import * as EditorCommon from 'vs/editor/common/editorCommon';
-import * as Browser from 'vs/base/browser/browser';
-import {colorizeLine} from 'vs/editor/browser/standalone/colorizer';
 import {onUnexpectedError} from 'vs/base/common/errors';
-import * as DOM from 'vs/base/browser/dom';
 import {IEventEmitter} from 'vs/base/common/eventEmitter';
-import {Configuration} from 'vs/editor/browser/config/configuration';
-import * as EditorBrowser from 'vs/editor/browser/editorBrowser';
-import {View} from 'vs/editor/browser/view/viewImpl';
-import {EditorBrowserRegistry} from 'vs/editor/browser/editorBrowserExtensions';
-import {CommonEditorRegistry} from 'vs/editor/common/editorCommonExtensions';
-import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
-import {Range} from 'vs/editor/common/core/range';
-import {Selection} from 'vs/editor/common/core/selection';
+import * as browser from 'vs/base/browser/browser';
+import * as dom from 'vs/base/browser/dom';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
+import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {CommonCodeEditor} from 'vs/editor/common/commonCodeEditor';
 import {CommonEditorConfiguration, IIndentationGuesser} from 'vs/editor/common/config/commonEditorConfig';
+import {Range} from 'vs/editor/common/core/range';
+import {Selection} from 'vs/editor/common/core/selection';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {CommonEditorRegistry} from 'vs/editor/common/editorCommonExtensions';
+import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
+import {Configuration} from 'vs/editor/browser/config/configuration';
+import * as editorBrowser from 'vs/editor/browser/editorBrowser';
+import {EditorBrowserRegistry} from 'vs/editor/browser/editorBrowserExtensions';
+import {Colorizer} from 'vs/editor/browser/standalone/colorizer';
+import {View} from 'vs/editor/browser/view/viewImpl';
 
-export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.ICodeEditor {
+export class CodeEditorWidget extends CommonCodeEditor implements editorBrowser.ICodeEditor {
 
 	protected domElement:HTMLElement;
-	private focusTracker:DOM.IFocusTracker;
+	private focusTracker:dom.IFocusTracker;
 
 	_configuration:Configuration;
 
-	private contentWidgets:{ [key:string]:EditorBrowser.IContentWidgetData; };
-	private overlayWidgets:{ [key:string]:EditorBrowser.IOverlayWidgetData; };
+	private contentWidgets:{ [key:string]:editorBrowser.IContentWidgetData; };
+	private overlayWidgets:{ [key:string]:editorBrowser.IOverlayWidgetData; };
 
-	_view:EditorBrowser.IView;
+	_view:editorBrowser.IView;
 
 	constructor(
 		domElement:HTMLElement,
-		options:EditorCommon.ICodeEditorWidgetCreationOptions,
+		options:editorCommon.ICodeEditorWidgetCreationOptions,
 		@IInstantiationService instantiationService: IInstantiationService,
 		@ICodeEditorService codeEditorService: ICodeEditorService,
 		@IKeybindingService keybindingService: IKeybindingService,
@@ -53,17 +52,17 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		super(domElement, options, instantiationService, codeEditorService, keybindingService, telemetryService);
 
 		// track focus of the domElement and all its anchestors
-		this.focusTracker = DOM.trackFocus(this.domElement);
+		this.focusTracker = dom.trackFocus(this.domElement);
 		this.focusTracker.addFocusListener(() => {
 			if (this.forcedWidgetFocusCount === 0) {
 				this._editorFocusContextKey.set(true);
-				this.emit(EditorCommon.EventType.EditorFocus, {});
+				this.emit(editorCommon.EventType.EditorFocus, {});
 			}
 		});
 		this.focusTracker.addBlurListener(() => {
 			if (this.forcedWidgetFocusCount === 0) {
 				this._editorFocusContextKey.reset();
-				this.emit(EditorCommon.EventType.EditorBlur, {});
+				this.emit(editorCommon.EventType.EditorBlur, {});
 			}
 		});
 
@@ -82,7 +81,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	protected _createConfiguration(options:EditorCommon.ICodeEditorWidgetCreationOptions, indentationGuesser:IIndentationGuesser): CommonEditorConfiguration {
+	protected _createConfiguration(options:editorCommon.ICodeEditorWidgetCreationOptions, indentationGuesser:IIndentationGuesser): CommonEditorConfiguration {
 		return new Configuration(options, this.domElement, indentationGuesser);
 	}
 
@@ -94,17 +93,17 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		super.dispose();
 	}
 
-	public colorizeModelLine(lineNumber:number, model:EditorCommon.IModel = this.model): string {
+	public colorizeModelLine(lineNumber:number, model:editorCommon.IModel = this.model): string {
 		if (!model) {
 			return '';
 		}
 		var content = model.getLineContent(lineNumber);
 		var tokens = model.getLineTokens(lineNumber, false);
-		var inflatedTokens = EditorCommon.LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
+		var inflatedTokens = editorCommon.LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
 		var indent = this._configuration.getIndentationOptions();
-		return colorizeLine(content, inflatedTokens, indent.tabSize);
+		return Colorizer.colorizeLine(content, inflatedTokens, indent.tabSize);
 	}
-	public getView(): EditorBrowser.IView {
+	public getView(): editorBrowser.IView {
 		return this._view;
 	}
 
@@ -115,7 +114,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		return this._view.domNode;
 	}
 
-	public getCenteredRangeInViewport(): EditorCommon.IEditorRange {
+	public getCenteredRangeInViewport(): editorCommon.IEditorRange {
 		if (!this.hasView) {
 			return null;
 		}
@@ -177,7 +176,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		return this._view.getCodeEditorHelper().getScrollHeight();
 	}
 
-	public saveViewState(): EditorCommon.ICodeEditorViewState {
+	public saveViewState(): editorCommon.ICodeEditorViewState {
 		if (!this.cursor || !this.hasView) {
 			return null;
 		}
@@ -198,19 +197,19 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		};
 	}
 
-	public restoreViewState(state:EditorCommon.IEditorViewState): void {
+	public restoreViewState(state:editorCommon.IEditorViewState): void {
 		if (!this.cursor || !this.hasView) {
 			return;
 		}
 		var s = <any>state;
 		if (s && s.cursorState && s.viewState) {
-			var codeEditorState = <EditorCommon.ICodeEditorViewState>s;
+			var codeEditorState = <editorCommon.ICodeEditorViewState>s;
 			var cursorState = <any>codeEditorState.cursorState;
 			if (Array.isArray(cursorState)) {
-				this.cursor.restoreState(<EditorCommon.ICursorState[]>cursorState);
+				this.cursor.restoreState(<editorCommon.ICursorState[]>cursorState);
 			} else {
 				// Backwards compatibility
-				this.cursor.restoreState([<EditorCommon.ICursorState>cursorState]);
+				this.cursor.restoreState([<editorCommon.ICursorState>cursorState]);
 			}
 			this._view.restoreState(codeEditorState.viewState);
 
@@ -224,8 +223,9 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public layout(dimension?:EditorCommon.IDimension): void {
+	public layout(dimension?:editorCommon.IDimension): void {
 		this._configuration.observeReferenceElement(dimension);
+		this.render();
 	}
 
 	public focus(): void {
@@ -239,8 +239,8 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		return this.hasView && this._view.isFocused();
 	}
 
-	public addContentWidget(widget: EditorBrowser.IContentWidget): void {
-		var widgetData: EditorBrowser.IContentWidgetData = {
+	public addContentWidget(widget: editorBrowser.IContentWidget): void {
+		var widgetData: editorBrowser.IContentWidgetData = {
 			widget: widget,
 			position: widget.getPosition()
 		};
@@ -256,7 +256,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public layoutContentWidget(widget: EditorBrowser.IContentWidget): void {
+	public layoutContentWidget(widget: editorBrowser.IContentWidget): void {
 		var widgetId = widget.getId();
 		if (this.contentWidgets.hasOwnProperty(widgetId)) {
 			var widgetData = this.contentWidgets[widgetId];
@@ -267,7 +267,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public removeContentWidget(widget: EditorBrowser.IContentWidget): void {
+	public removeContentWidget(widget: editorBrowser.IContentWidget): void {
 		var widgetId = widget.getId();
 		if (this.contentWidgets.hasOwnProperty(widgetId)) {
 			var widgetData = this.contentWidgets[widgetId];
@@ -278,8 +278,8 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public addOverlayWidget(widget: EditorBrowser.IOverlayWidget): void {
-		var widgetData: EditorBrowser.IOverlayWidgetData = {
+	public addOverlayWidget(widget: editorBrowser.IOverlayWidget): void {
+		var widgetData: editorBrowser.IOverlayWidgetData = {
 			widget: widget,
 			position: widget.getPosition()
 		};
@@ -295,7 +295,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public layoutOverlayWidget(widget: EditorBrowser.IOverlayWidget): void {
+	public layoutOverlayWidget(widget: editorBrowser.IOverlayWidget): void {
 		var widgetId = widget.getId();
 		if (this.overlayWidgets.hasOwnProperty(widgetId)) {
 			var widgetData = this.overlayWidgets[widgetId];
@@ -306,7 +306,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public removeOverlayWidget(widget: EditorBrowser.IOverlayWidget): void {
+	public removeOverlayWidget(widget: editorBrowser.IOverlayWidget): void {
 		var widgetId = widget.getId();
 		if (this.overlayWidgets.hasOwnProperty(widgetId)) {
 			var widgetData = this.overlayWidgets[widgetId];
@@ -317,18 +317,18 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		}
 	}
 
-	public changeViewZones(callback:(accessor:EditorBrowser.IViewZoneChangeAccessor)=>void): void {
+	public changeViewZones(callback:(accessor:editorBrowser.IViewZoneChangeAccessor)=>void): void {
 		if (!this.hasView) {
 //			console.warn('Cannot change view zones on editor that is not attached to a model, since there is no view.');
 			return;
 		}
 		var hasChanges = this._view.change(callback);
 		if (hasChanges) {
-			this.emit(EditorCommon.EventType.ViewZonesChanged);
+			this.emit(editorCommon.EventType.ViewZonesChanged);
 		}
 	}
 
-	public getWhitespaces(): EditorCommon.IEditorWhitespace[] {
+	public getWhitespaces(): editorCommon.IEditorWhitespace[] {
 		if (!this.hasView) {
 			return [];
 		}
@@ -349,7 +349,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		return this._view.getCodeEditorHelper().getVerticalOffsetForPosition(lineNumber, column);
 	}
 
-	public getScrolledVisiblePosition(rawPosition:EditorCommon.IPosition): { top:number; left:number; height:number; } {
+	public getScrolledVisiblePosition(rawPosition:editorCommon.IPosition): { top:number; left:number; height:number; } {
 		if (!this.hasView) {
 			return null;
 		}
@@ -382,13 +382,13 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		this._view.render(true);
 	}
 
-	public setHiddenAreas(ranges:EditorCommon.IRange[]): void {
+	public setHiddenAreas(ranges:editorCommon.IRange[]): void {
 		if (this.viewModel) {
 			this.viewModel.setHiddenAreas(ranges);
 		}
 	}
 
-	_attachModel(model:EditorCommon.IModel): void {
+	_attachModel(model:editorCommon.IModel): void {
 		this._view = null;
 
 		super._attachModel(model);
@@ -418,7 +418,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 	}
 
 	protected _enableEmptySelectionClipboard(): boolean {
-		return Browser.enableEmptySelectionClipboard;
+		return browser.enableEmptySelectionClipboard;
 	}
 
 	protected _createView(): void {
@@ -434,7 +434,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 		return this._view.getInternalEventBus();
 	}
 
-	protected _detachModel(): EditorCommon.IModel {
+	protected _detachModel(): editorCommon.IModel {
 		var removeDomNode:HTMLElement = null;
 
 		if (this._view) {
@@ -453,13 +453,13 @@ export class CodeEditorWidget extends CommonCodeEditor implements EditorBrowser.
 	}
 }
 
-class OverlayWidget2 implements EditorBrowser.IOverlayWidget {
+class OverlayWidget2 implements editorBrowser.IOverlayWidget {
 
 	private _id: string;
-	private _position: EditorBrowser.IOverlayWidgetPosition;
+	private _position: editorBrowser.IOverlayWidgetPosition;
 	private _domNode: HTMLElement;
 
-	constructor(id:string, position:EditorBrowser.IOverlayWidgetPosition) {
+	constructor(id:string, position:editorBrowser.IOverlayWidgetPosition) {
 		this._id = id;
 		this._position = position;
 		this._domNode = document.createElement('div');
@@ -474,7 +474,7 @@ class OverlayWidget2 implements EditorBrowser.IOverlayWidget {
 		return this._domNode;
 	}
 
-	public getPosition(): EditorBrowser.IOverlayWidgetPosition {
+	public getPosition(): editorBrowser.IOverlayWidgetPosition {
 		return this._position;
 	}
 }
@@ -483,17 +483,17 @@ export enum EditCursorState {
 	EndOfLastEditOperation = 0
 }
 
-export class CommandRunner implements EditorCommon.ICommand {
+export class CommandRunner implements editorCommon.ICommand {
 
-	private _ops: EditorCommon.ISingleEditOperation[];
+	private _ops: editorCommon.ISingleEditOperation[];
 	private _editCursorState: EditCursorState;
 
-	constructor(ops: EditorCommon.ISingleEditOperation[], editCursorState: EditCursorState) {
+	constructor(ops: editorCommon.ISingleEditOperation[], editCursorState: EditCursorState) {
 		this._ops = ops;
 		this._editCursorState = editCursorState;
 	}
 
-	public getEditOperations(model: EditorCommon.ITokenizedModel, builder: EditorCommon.IEditOperationBuilder): void {
+	public getEditOperations(model: editorCommon.ITokenizedModel, builder: editorCommon.IEditOperationBuilder): void {
 		if (this._ops.length === 0) {
 			return;
 		}
@@ -504,7 +504,7 @@ export class CommandRunner implements EditorCommon.ICommand {
 		});
 
 		// Merge operations that touch each other
-		var resultOps:EditorCommon.ISingleEditOperation[] = [];
+		var resultOps:editorCommon.ISingleEditOperation[] = [];
 		var previousOp = this._ops[0];
 		for (var i = 1; i < this._ops.length; i++) {
 			if (previousOp.range.endLineNumber === this._ops[i].range.startLineNumber && previousOp.range.endColumn === this._ops[i].range.startColumn) {
@@ -523,7 +523,7 @@ export class CommandRunner implements EditorCommon.ICommand {
 		}
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData): editorCommon.IEditorSelection {
 		var inverseEditOperations = helper.getInverseEditOperations();
 		var srcRange = inverseEditOperations[inverseEditOperations.length - 1].range;
 		return Selection.createSelection(

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/widget/diffEditorWidget.ts
code:
@@ -6,36 +6,36 @@
 'use strict';
 
 import 'vs/css!./media/diffEditor';
+import {IAction} from 'vs/base/common/actions';
+import {RunOnceScheduler} from 'vs/base/common/async';
+import {EventEmitter, IEmitterEvent} from 'vs/base/common/eventEmitter';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as objects from 'vs/base/common/objects';
+import * as dom from 'vs/base/browser/dom';
+import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {ISashEvent, IVerticalSashLayoutProvider, Sash} from 'vs/base/browser/ui/sash/sash';
+import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
-import Lifecycle = require('vs/base/common/lifecycle');
-import Objects = require('vs/base/common/objects');
-import CodeEditorWidget = require('vs/editor/browser/widget/codeEditorWidget');
-import DomUtils = require('vs/base/browser/dom');
-import EventEmitter = require('vs/base/common/eventEmitter');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import Actions = require('vs/base/common/actions');
-import Sash = require('vs/base/browser/ui/sash/sash');
-import ViewLineParts = require('vs/editor/common/viewLayout/viewLineParts');
-import Schedulers = require('vs/base/common/async');
 import {Range} from 'vs/editor/common/core/range';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
+import {ILineParts, createLineParts} from 'vs/editor/common/viewLayout/viewLineParts';
+import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import * as editorBrowser from 'vs/editor/browser/editorBrowser';
+import {CodeEditorWidget} from 'vs/editor/browser/widget/codeEditorWidget';
 
 interface IEditorScrollEvent {
 	scrollLeft: number;
 	scrollTop: number;
 }
 
 interface IEditorDiffDecorations {
-	decorations:EditorCommon.IModelDeltaDecoration[];
-	overviewZones:EditorBrowser.IOverviewRulerZone[];
+	decorations:editorCommon.IModelDeltaDecoration[];
+	overviewZones:editorBrowser.IOverviewRulerZone[];
 }
 
 interface IEditorDiffDecorationsWithZones extends IEditorDiffDecorations {
-	zones:EditorBrowser.IViewZone[];
+	zones:editorBrowser.IViewZone[];
 }
 
 interface IEditorsDiffDecorations {
@@ -49,12 +49,12 @@ interface IEditorsDiffDecorationsWithZones {
 }
 
 interface IEditorsZones {
-	original:EditorBrowser.IViewZone[];
-	modified:EditorBrowser.IViewZone[];
+	original:editorBrowser.IViewZone[];
+	modified:editorBrowser.IViewZone[];
 }
 
 interface IDiffEditorWidgetStyle {
-	getEditorsDiffDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalWhitespaces:EditorCommon.IEditorWhitespace[], modifiedWhitespaces:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorsDiffDecorationsWithZones;
+	getEditorsDiffDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalWhitespaces:editorCommon.IEditorWhitespace[], modifiedWhitespaces:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorsDiffDecorationsWithZones;
 	setEnableSplitViewResizing(enableSplitViewResizing:boolean): void;
 	layout(): number;
 	dispose(): void;
@@ -71,14 +71,14 @@ class VisualEditorState {
 		this._decorations = [];
 	}
 
-	public getForeignViewZones(allViewZones:EditorCommon.IEditorWhitespace[]): EditorCommon.IEditorWhitespace[] {
+	public getForeignViewZones(allViewZones:editorCommon.IEditorWhitespace[]): editorCommon.IEditorWhitespace[] {
 		return allViewZones.filter((z) => !this._zonesMap[String(z.id)]);
 	}
 
-	public clean(editor:CodeEditorWidget.CodeEditorWidget): void {
+	public clean(editor:CodeEditorWidget): void {
 		// (1) View zones
 		if (this._zones.length > 0) {
-			editor.changeViewZones((viewChangeAccessor:EditorBrowser.IViewZoneChangeAccessor) => {
+			editor.changeViewZones((viewChangeAccessor:editorBrowser.IViewZoneChangeAccessor) => {
 				for (var i = 0, length = this._zones.length; i < length; i++) {
 					viewChangeAccessor.removeZone(this._zones[i]);
 				}
@@ -89,19 +89,19 @@ class VisualEditorState {
 
 		// (2) Model decorations
 		if (this._decorations.length > 0) {
-			editor.changeDecorations((changeAccessor:EditorCommon.IModelDecorationsChangeAccessor) => {
+			editor.changeDecorations((changeAccessor:editorCommon.IModelDecorationsChangeAccessor) => {
 				changeAccessor.deltaDecorations(this._decorations, []);
 			});
 		}
 		this._decorations = [];
 	}
 
-	public apply(editor:CodeEditorWidget.CodeEditorWidget, overviewRuler:EditorBrowser.IOverviewRuler, newDecorations:IEditorDiffDecorationsWithZones): void {
+	public apply(editor:CodeEditorWidget, overviewRuler:editorBrowser.IOverviewRuler, newDecorations:IEditorDiffDecorationsWithZones): void {
 		var i:number,
 			length: number;
 
 		// view zones
-		editor.changeViewZones((viewChangeAccessor:EditorBrowser.IViewZoneChangeAccessor) => {
+		editor.changeViewZones((viewChangeAccessor:editorBrowser.IViewZoneChangeAccessor) => {
 			for (i = 0, length = this._zones.length; i < length; i++) {
 				viewChangeAccessor.removeZone(this._zones[i]);
 			}
@@ -125,15 +125,15 @@ class VisualEditorState {
 
 var DIFF_EDITOR_ID = 0;
 
-export class DiffEditorWidget extends EventEmitter.EventEmitter implements EditorBrowser.IDiffEditor {
+export class DiffEditorWidget extends EventEmitter implements editorBrowser.IDiffEditor {
 
 	private static ONE_OVERVIEW_WIDTH = 15;
 	public static ENTIRE_DIFF_OVERVIEW_WIDTH = 30;
 	private static UPDATE_DIFF_DECORATIONS_DELAY = 200; // ms
 
 	private id: number;
 
-	private _toDispose:Lifecycle.IDisposable[];
+	private _toDispose:IDisposable[];
 
 	private _theme:string;
 	private _domElement:HTMLElement;
@@ -145,20 +145,20 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 	private _height:number;
 	private _measureDomElementToken:number;
 
-	private originalEditor:CodeEditorWidget.CodeEditorWidget;
+	private originalEditor:CodeEditorWidget;
 	private _originalDomNode:HTMLElement;
 	private _originalEditorState:VisualEditorState;
-	private _originalOverviewRuler:EditorBrowser.IOverviewRuler;
+	private _originalOverviewRuler:editorBrowser.IOverviewRuler;
 
-	private modifiedEditor:CodeEditorWidget.CodeEditorWidget;
+	private modifiedEditor:CodeEditorWidget;
 	private _modifiedDomNode:HTMLElement;
 	private _modifiedEditorState:VisualEditorState;
-	private _modifiedOverviewRuler:EditorBrowser.IOverviewRuler;
+	private _modifiedOverviewRuler:editorBrowser.IOverviewRuler;
 
 	private _currentlyChangingViewZones:boolean;
 	private _beginUpdateDecorationsTimeout:number;
 	private _diffComputationToken:number;
-	private _lineChanges:EditorCommon.ILineChange[];
+	private _lineChanges:editorCommon.ILineChange[];
 
 	private _isVisible:boolean;
 	private _isHandlingScrollEvent:boolean;
@@ -169,13 +169,13 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 	private _enableSplitViewResizing:boolean;
 	private _strategy:IDiffEditorWidgetStyle;
 
-	private _updateDecorationsRunner:Schedulers.RunOnceScheduler;
+	private _updateDecorationsRunner:RunOnceScheduler;
 
 	private _editorWorkerService: IEditorWorkerService;
 
 	constructor(
 		domElement:HTMLElement,
-		options:EditorCommon.IDiffEditorOptions,
+		options:editorCommon.IDiffEditorOptions,
 		@IEditorWorkerService editorWorkerService: IEditorWorkerService,
 		@IInstantiationService instantiationService: IInstantiationService
 	) {
@@ -200,7 +200,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 			this._ignoreTrimWhitespace = options.ignoreTrimWhitespace;
 		}
 
-		this._updateDecorationsRunner = new Schedulers.RunOnceScheduler(() => this._updateDecorations(), 0);
+		this._updateDecorationsRunner = new RunOnceScheduler(() => this._updateDecorations(), 0);
 
 		this._toDispose = [];
 		this._toDispose.push(this._updateDecorationsRunner);
@@ -222,7 +222,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 
 		this._overviewDomElement.appendChild(this._overviewViewportDomElement);
 
-		this._toDispose.push(DomUtils.addDisposableListener(this._overviewDomElement, 'mousedown', (e:MouseEvent) => {
+		this._toDispose.push(dom.addDisposableListener(this._overviewDomElement, 'mousedown', (e:MouseEvent) => {
 			this.modifiedEditor.delegateVerticalScrollbarMouseDown(e);
 		}));
 		this._containerDomElement.appendChild(this._overviewDomElement);
@@ -316,14 +316,14 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		this._containerDomElement.appendChild(this._modifiedDomNode);
 	}
 
-	private _createLeftHandSideEditor(options:EditorCommon.IDiffEditorOptions, instantiationService:IInstantiationService): void {
-		this.originalEditor = instantiationService.createInstance(CodeEditorWidget.CodeEditorWidget, this._originalDomNode, <any> this._adjustOptionsForLeftHandSide(options)); //TS bug: IDiffEditorOptions are not compatable with IEditorCreationOptions
+	private _createLeftHandSideEditor(options:editorCommon.IDiffEditorOptions, instantiationService:IInstantiationService): void {
+		this.originalEditor = instantiationService.createInstance(CodeEditorWidget, this._originalDomNode, <any> this._adjustOptionsForLeftHandSide(options)); //TS bug: IDiffEditorOptions are not compatable with IEditorCreationOptions
 		this._toDispose.push(this.originalEditor.addBulkListener2((events: any) => this._onOriginalEditorEvents(events)));
 		this._toDispose.push(this.addEmitter2(this.originalEditor, 'leftHandSide'));
 	}
 
-	private _createRightHandSideEditor(options:EditorCommon.IDiffEditorOptions, instantiationService:IInstantiationService): void {
-		this.modifiedEditor = instantiationService.createInstance(CodeEditorWidget.CodeEditorWidget, this._modifiedDomNode, <any> this._adjustOptionsForRightHandSide(options)); //TS bug: IDiffEditorOptions are not compatable with IEditorCreationOptions
+	private _createRightHandSideEditor(options:editorCommon.IDiffEditorOptions, instantiationService:IInstantiationService): void {
+		this.modifiedEditor = instantiationService.createInstance(CodeEditorWidget, this._modifiedDomNode, <any> this._adjustOptionsForRightHandSide(options)); //TS bug: IDiffEditorOptions are not compatable with IEditorCreationOptions
 		this._toDispose.push(this.modifiedEditor.addBulkListener2((events: any) => this._onModifiedEditorEvents(events)));
 		this._toDispose.push(this.addEmitter2(this.modifiedEditor, 'rightHandSide'));
 	}
@@ -333,7 +333,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 	}
 
 	public dispose(): void {
-		this._toDispose = Lifecycle.disposeAll(this._toDispose);
+		this._toDispose = disposeAll(this._toDispose);
 
 		window.clearInterval(this._measureDomElementToken);
 
@@ -357,22 +357,22 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 	}
 
 	public getEditorType(): string {
-		return EditorCommon.EditorType.IDiffEditor;
+		return editorCommon.EditorType.IDiffEditor;
 	}
 
-	public getLineChanges(): EditorCommon.ILineChange[] {
+	public getLineChanges(): editorCommon.ILineChange[] {
 		return this._lineChanges;
 	}
 
-	public getOriginalEditor(): EditorBrowser.ICodeEditor {
+	public getOriginalEditor(): editorBrowser.ICodeEditor {
 		return this.originalEditor;
 	}
 
-	public getModifiedEditor(): EditorBrowser.ICodeEditor {
+	public getModifiedEditor(): editorBrowser.ICodeEditor {
 		return this.modifiedEditor;
 	}
 
-	public updateOptions(newOptions:EditorCommon.IDiffEditorOptions): void {
+	public updateOptions(newOptions:editorCommon.IDiffEditorOptions): void {
 		// Handle new theme
 		this._theme = newOptions && newOptions.theme ? newOptions.theme : this._theme;
 
@@ -419,14 +419,14 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		return this.modifiedEditor.getValue(options);
 	}
 
-	public getModel(): EditorCommon.IDiffEditorModel {
+	public getModel(): editorCommon.IDiffEditorModel {
 		return {
 			original: this.originalEditor.getModel(),
 			modified: this.modifiedEditor.getModel()
 		};
 	}
 
-	public setModel(model:EditorCommon.IDiffEditorModel): void {
+	public setModel(model:editorCommon.IDiffEditorModel): void {
 		// Guard us against partial null model
 		if (model && (!model.original || !model.modified)) {
 			throw new Error(!model.original ? 'DiffEditorWidget.setModel: Original model is null' : 'DiffEditorWidget.setModel: Modified model is null');
@@ -465,15 +465,15 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		return this._domElement;
 	}
 
-	public getVisibleColumnFromPosition(position:EditorCommon.IPosition): number {
+	public getVisibleColumnFromPosition(position:editorCommon.IPosition): number {
 		return this.modifiedEditor.getVisibleColumnFromPosition(position);
 	}
 
-	public getPosition(): EditorCommon.IEditorPosition {
+	public getPosition(): editorCommon.IEditorPosition {
 		return this.modifiedEditor.getPosition();
 	}
 
-	public setPosition(position: EditorCommon.IPosition, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void {
+	public setPosition(position: editorCommon.IPosition, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void {
 		this.modifiedEditor.setPosition(position, reveal, revealVerticalInCenter, revealHorizontal);
 	}
 
@@ -489,35 +489,35 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		this.modifiedEditor.revealLineInCenterIfOutsideViewport(lineNumber);
 	}
 
-	public revealPosition(position: EditorCommon.IPosition, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = false): void {
+	public revealPosition(position: editorCommon.IPosition, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = false): void {
 		this.modifiedEditor.revealPosition(position, revealVerticalInCenter, revealHorizontal);
 	}
 
-	public revealPositionInCenter(position: EditorCommon.IPosition): void {
+	public revealPositionInCenter(position: editorCommon.IPosition): void {
 		this.modifiedEditor.revealPositionInCenter(position);
 	}
 
-	public revealPositionInCenterIfOutsideViewport(position: EditorCommon.IPosition): void {
+	public revealPositionInCenterIfOutsideViewport(position: editorCommon.IPosition): void {
 		this.modifiedEditor.revealPositionInCenterIfOutsideViewport(position);
 	}
 
-	public getSelection(): EditorCommon.IEditorSelection {
+	public getSelection(): editorCommon.IEditorSelection {
 		return this.modifiedEditor.getSelection();
 	}
 
-	public getSelections(): EditorCommon.IEditorSelection[] {
+	public getSelections(): editorCommon.IEditorSelection[] {
 		return this.modifiedEditor.getSelections();
 	}
 
-	public setSelection(range:EditorCommon.IRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(editorRange:EditorCommon.IEditorRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(selection:EditorCommon.ISelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(editorSelection:EditorCommon.IEditorSelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(range:editorCommon.IRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(editorRange:editorCommon.IEditorRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(selection:editorCommon.ISelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(editorSelection:editorCommon.IEditorSelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
 	public setSelection(something:any, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void {
 		this.modifiedEditor.setSelection(something, reveal, revealVerticalInCenter, revealHorizontal);
 	}
 
-	public setSelections(ranges: EditorCommon.ISelection[]): void {
+	public setSelections(ranges: editorCommon.ISelection[]): void {
 		this.modifiedEditor.setSelections(ranges);
 	}
 
@@ -533,31 +533,31 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		this.modifiedEditor.revealLinesInCenterIfOutsideViewport(startLineNumber, endLineNumber);
 	}
 
-	public revealRange(range: EditorCommon.IRange, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = true): void {
+	public revealRange(range: editorCommon.IRange, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = true): void {
 		this.modifiedEditor.revealRange(range, revealVerticalInCenter, revealHorizontal);
 	}
 
-	public revealRangeInCenter(range: EditorCommon.IRange): void {
+	public revealRangeInCenter(range: editorCommon.IRange): void {
 		this.modifiedEditor.revealRangeInCenter(range);
 	}
 
-	public revealRangeInCenterIfOutsideViewport(range: EditorCommon.IRange): void {
+	public revealRangeInCenterIfOutsideViewport(range: editorCommon.IRange): void {
 		this.modifiedEditor.revealRangeInCenterIfOutsideViewport(range);
 	}
 
-	public addAction(descriptor:EditorCommon.IActionDescriptor): void {
+	public addAction(descriptor:editorCommon.IActionDescriptor): void {
 		this.modifiedEditor.addAction(descriptor);
 	}
 
-	public getActions(): Actions.IAction[] {
+	public getActions(): IAction[] {
 		return this.modifiedEditor.getActions();
 	}
 
-	public getAction(id:string): Actions.IAction {
+	public getAction(id:string): IAction {
 		return this.modifiedEditor.getAction(id);
 	}
 
-	public saveViewState(): EditorCommon.IDiffEditorViewState {
+	public saveViewState(): editorCommon.IDiffEditorViewState {
 		var originalViewState = this.originalEditor.saveViewState();
 		var modifiedViewState = this.modifiedEditor.saveViewState();
 		return {
@@ -566,16 +566,16 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		};
 	}
 
-	public restoreViewState(state:EditorCommon.IEditorViewState): void {
+	public restoreViewState(state:editorCommon.IEditorViewState): void {
 		var s = <any>state;
 		if (s.original && s.original) {
-			var diffEditorState = <EditorCommon.IDiffEditorViewState>s;
+			var diffEditorState = <editorCommon.IDiffEditorViewState>s;
 			this.originalEditor.restoreViewState(diffEditorState.original);
 			this.modifiedEditor.restoreViewState(diffEditorState.modified);
 		}
 	}
 
-	public layout(dimension?:EditorCommon.IDimension): void {
+	public layout(dimension?:editorCommon.IDimension): void {
 		this._measureDomElement(false, dimension);
 	}
 
@@ -607,7 +607,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		this.modifiedEditor.trigger(source, handlerId, payload);
 	}
 
-	public changeDecorations(callback:(changeAccessor:EditorCommon.IModelDecorationsChangeAccessor)=>any): any {
+	public changeDecorations(callback:(changeAccessor:editorCommon.IModelDecorationsChangeAccessor)=>any): any {
 		return this.modifiedEditor.changeDecorations(callback);
 	}
 
@@ -617,8 +617,8 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 
 	//------------ begin layouting methods
 
-	private _measureDomElement(forceDoLayoutCall:boolean, dimensions?:EditorCommon.IDimension): void {
-		dimensions = dimensions || DomUtils.getDomNodePosition(this._containerDomElement);
+	private _measureDomElement(forceDoLayoutCall:boolean, dimensions?:editorCommon.IDimension): void {
+		dimensions = dimensions || dom.getDomNodePosition(this._containerDomElement);
 
 		if (dimensions.width <= 0) {
 			return;
@@ -643,24 +643,24 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 				top: 0,
 				width: DiffEditorWidget.ONE_OVERVIEW_WIDTH,
 				right: freeSpace + DiffEditorWidget.ONE_OVERVIEW_WIDTH,
-				height: this._height - layoutInfo.horizontalScrollbarHeight
+				height: this._height
 			});
 			this._modifiedOverviewRuler.setLayout({
 				top: 0,
 				right: 0,
 				width: DiffEditorWidget.ONE_OVERVIEW_WIDTH,
-				height: this._height - layoutInfo.horizontalScrollbarHeight
+				height: this._height
 			});
 		}
 	}
 
 	//------------ end layouting methods
 
-	private _recomputeIfNecessary(events:EventEmitter.IEmitterEvent[]): void {
+	private _recomputeIfNecessary(events:IEmitterEvent[]): void {
 		var changed = false;
 		for (var i = 0; !changed && i < events.length; i++) {
 			var type = events[i].getType();
-			changed = changed || type === 'change' || type === EditorCommon.EventType.ModelModeChanged;
+			changed = changed || type === 'change' || type === editorCommon.EventType.ModelModeChanged;
 		}
 		if (changed && this._isVisible) {
 			// Clear previous timeout if necessary
@@ -672,19 +672,19 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		}
 	}
 
-	private _onOriginalEditorEvents(events:EventEmitter.IEmitterEvent[]): void {
+	private _onOriginalEditorEvents(events:IEmitterEvent[]): void {
 		for (var i = 0; i < events.length; i++) {
 			if (events[i].getType() === 'scroll') {
 				this._onOriginalEditorScroll(events[i].getData());
 			}
-			if (events[i].getType() === EditorCommon.EventType.ViewZonesChanged) {
+			if (events[i].getType() === editorCommon.EventType.ViewZonesChanged) {
 				this._onViewZonesChanged();
 			}
 		}
 		this._recomputeIfNecessary(events);
 	}
 
-	private _onModifiedEditorEvents(events:EventEmitter.IEmitterEvent[]): void {
+	private _onModifiedEditorEvents(events:IEmitterEvent[]): void {
 		for (var i = 0; i < events.length; i++) {
 			if (events[i].getType() === 'scroll') {
 				this._onModifiedEditorScroll(events[i].getData());
@@ -697,7 +697,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 				this._layoutOverviewViewport();
 			}
 
-			if (events[i].getType() === EditorCommon.EventType.ViewZonesChanged) {
+			if (events[i].getType() === editorCommon.EventType.ViewZonesChanged) {
 				this._onViewZonesChanged();
 			}
 		}
@@ -733,7 +733,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 			{
 				this._lineChanges = result;
 				this._updateDecorationsRunner.schedule();
-				this.emit(EditorCommon.EventType.DiffUpdated, { editor: this, lineChanges: result });
+				this.emit(editorCommon.EventType.DiffUpdated, { editor: this, lineChanges: result });
 			}
 		}, (error) => {
 			if (currentToken === this._diffComputationToken
@@ -769,27 +769,31 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		}
 	}
 
-	private _adjustOptionsForLeftHandSide(options:EditorCommon.IDiffEditorOptions): EditorCommon.IDiffEditorOptions {
-		var clonedOptions:EditorCommon.IDiffEditorOptions = Objects.clone(options || {});
+	private _adjustOptionsForLeftHandSide(options:editorCommon.IDiffEditorOptions): editorCommon.IDiffEditorOptions {
+		var clonedOptions:editorCommon.IDiffEditorOptions = objects.clone(options || {});
 		clonedOptions.wrappingColumn = -1;
 		clonedOptions.readOnly = true;
 		clonedOptions.automaticLayout = false;
 		clonedOptions.scrollbar = clonedOptions.scrollbar || {};
 		clonedOptions.scrollbar.vertical = 'visible';
 		clonedOptions.overviewRulerLanes = 1;
 		clonedOptions.theme = this._theme + ' original-in-monaco-diff-editor';
+		clonedOptions.folding = false;
+		clonedOptions.referenceInfos = false;
 		return clonedOptions;
 	}
 
-	private _adjustOptionsForRightHandSide(options:EditorCommon.IDiffEditorOptions): EditorCommon.IDiffEditorOptions {
-		var clonedOptions:EditorCommon.IDiffEditorOptions = Objects.clone(options || {});
+	private _adjustOptionsForRightHandSide(options:editorCommon.IDiffEditorOptions): editorCommon.IDiffEditorOptions {
+		var clonedOptions:editorCommon.IDiffEditorOptions = objects.clone(options || {});
 		clonedOptions.wrappingColumn = -1;
 		clonedOptions.automaticLayout = false;
 		clonedOptions.revealHorizontalRightPadding = DefaultConfig.editor.revealHorizontalRightPadding + DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH;
 		clonedOptions.scrollbar = clonedOptions.scrollbar || {};
 		clonedOptions.scrollbar.vertical = 'visible';
 		clonedOptions.scrollbar.verticalHasArrows = false;
 		clonedOptions.theme = this._theme + ' modified-in-monaco-diff-editor';
+		clonedOptions.folding = false;
+		clonedOptions.referenceInfos = false;
 		return clonedOptions;
 	}
 
@@ -858,7 +862,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		var scrollTop = this.modifiedEditor.getScrollTop();
 		var scrollHeight = this.modifiedEditor.getScrollHeight();
 
-		var computedAvailableSize = Math.max(0, layoutInfo.contentHeight - layoutInfo.horizontalScrollbarHeight);
+		var computedAvailableSize = Math.max(0, layoutInfo.contentHeight);
 		var computedRepresentableSize = Math.max(0, computedAvailableSize - 2 * 0);
 		var computedRatio = scrollHeight > 0 ? (computedRepresentableSize / scrollHeight) : 0;
 
@@ -914,7 +918,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		this._measureDomElement(true);
 	}
 
-	private _getLineChangeAtOrBeforeLineNumber(lineNumber: number, startLineNumberExtractor:(lineChange:EditorCommon.ILineChange)=>number): EditorCommon.ILineChange {
+	private _getLineChangeAtOrBeforeLineNumber(lineNumber: number, startLineNumberExtractor:(lineChange:editorCommon.ILineChange)=>number): editorCommon.ILineChange {
 		if (this._lineChanges.length === 0 || lineNumber < startLineNumberExtractor(this._lineChanges[0])) {
 			// There are no changes or `lineNumber` is before the first change
 			return null;
@@ -983,7 +987,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		return originalEquivalentLineNumber + lineChangeOriginalLength - lineChangeModifiedLength + delta ;
 	}
 
-	public getDiffLineInformationForOriginal(lineNumber:number): EditorCommon.IDiffLineInformation {
+	public getDiffLineInformationForOriginal(lineNumber:number): editorCommon.IDiffLineInformation {
 		if (!this._lineChanges) {
 			// Cannot answer that which I don't know
 			return null;
@@ -993,7 +997,7 @@ export class DiffEditorWidget extends EventEmitter.EventEmitter implements Edito
 		};
 	}
 
-	public getDiffLineInformationForModified(lineNumber:number): EditorCommon.IDiffLineInformation {
+	public getDiffLineInformationForModified(lineNumber:number): editorCommon.IDiffLineInformation {
 		if (!this._lineChanges) {
 			// Cannot answer that which I don't know
 			return null;
@@ -1010,8 +1014,8 @@ interface IDataSource {
 	getContainerDomNode(): HTMLElement;
 	relayoutEditors(): void;
 
-	getOriginalEditor(): EditorBrowser.ICodeEditor;
-	getModifiedEditor(): EditorBrowser.ICodeEditor;
+	getOriginalEditor(): editorBrowser.ICodeEditor;
+	getModifiedEditor(): editorBrowser.ICodeEditor;
 }
 
 class DiffEditorWidgetStyle {
@@ -1022,7 +1026,7 @@ class DiffEditorWidgetStyle {
 		this._dataSource = dataSource;
 	}
 
-	public getEditorsDiffDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalWhitespaces:EditorCommon.IEditorWhitespace[], modifiedWhitespaces:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorsDiffDecorationsWithZones {
+	public getEditorsDiffDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalWhitespaces:editorCommon.IEditorWhitespace[], modifiedWhitespaces:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorsDiffDecorationsWithZones {
 		// Get view zones
 		modifiedWhitespaces = modifiedWhitespaces.sort((a, b) => {
 			return a.afterLineNumber - b.afterLineNumber;
@@ -1050,30 +1054,30 @@ class DiffEditorWidgetStyle {
 		};
 	}
 
-	_getViewZones(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorsZones {
+	_getViewZones(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorsZones {
 		return null;
 	}
 
-	_getOriginalEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getOriginalEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 		return null;
 	}
 
-	_getModifiedEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getModifiedEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 		return null;
 	}
 }
 
-interface IMyViewZone extends EditorBrowser.IViewZone {
+interface IMyViewZone extends editorBrowser.IViewZone {
 	shouldNotShrink?: boolean;
 }
 
 class ForeignViewZonesIterator {
 
 	private _index: number;
-	private _source: EditorCommon.IEditorWhitespace[];
-	public current: EditorCommon.IEditorWhitespace;
+	private _source: editorCommon.IEditorWhitespace[];
+	public current: editorCommon.IEditorWhitespace;
 
-	constructor(source: EditorCommon.IEditorWhitespace[]) {
+	constructor(source: editorCommon.IEditorWhitespace[]) {
 		this._source = source;
 		this._index = -1;
 		this.advance();
@@ -1091,11 +1095,11 @@ class ForeignViewZonesIterator {
 
 class ViewZonesComputer {
 
-	private lineChanges:EditorCommon.ILineChange[];
-	private originalForeignVZ:EditorCommon.IEditorWhitespace[];
-	private modifiedForeignVZ:EditorCommon.IEditorWhitespace[];
+	private lineChanges:editorCommon.ILineChange[];
+	private originalForeignVZ:editorCommon.IEditorWhitespace[];
+	private modifiedForeignVZ:editorCommon.IEditorWhitespace[];
 
-	constructor(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[]) {
+	constructor(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[]) {
 		this.lineChanges = lineChanges;
 		this.originalForeignVZ = originalForeignVZ;
 		this.modifiedForeignVZ = modifiedForeignVZ;
@@ -1109,7 +1113,7 @@ class ViewZonesComputer {
 
 		var i:number,
 			length:number,
-			lineChange:EditorCommon.ILineChange;
+			lineChange:editorCommon.ILineChange;
 
 		var stepOriginal: IMyViewZone[],
 			stepModified: IMyViewZone[],
@@ -1127,7 +1131,7 @@ class ViewZonesComputer {
 			return a.afterLineNumber - b.afterLineNumber;
 		};
 
-		var addAndCombineIfPossible = (destination:EditorBrowser.IViewZone[], item:IMyViewZone) => {
+		var addAndCombineIfPossible = (destination:editorBrowser.IViewZone[], item:IMyViewZone) => {
 			if (item.domNode === null && destination.length > 0) {
 				var lastItem = destination[destination.length - 1];
 				if (lastItem.afterLineNumber === item.afterLineNumber && lastItem.domNode === null) {
@@ -1281,21 +1285,21 @@ class ViewZonesComputer {
 		return result;
 	}
 
-	_produceOriginalFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+	_produceOriginalFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
 		throw new Error('NotImplemented');
 	}
 
-	_produceModifiedFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+	_produceModifiedFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
 		throw new Error('NotImplemented');
 	}
 }
 
-class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEditorWidgetStyle, Sash.IVerticalSashLayoutProvider {
+class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEditorWidgetStyle, IVerticalSashLayoutProvider {
 
 	static MINIMUM_EDITOR_WIDTH = 100;
 
 	private _disableSash: boolean;
-	private _sash:Sash.Sash;
+	private _sash:Sash;
 	private _sashRatio:number;
 	private _sashPosition:number;
 	private _startSashPosition:number;
@@ -1306,14 +1310,14 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		this._disableSash = (enableSplitViewResizing === false);
 		this._sashRatio = null;
 		this._sashPosition = null;
-		this._sash = new Sash.Sash(this._dataSource.getContainerDomNode(), this);
+		this._sash = new Sash(this._dataSource.getContainerDomNode(), this);
 
 		if (this._disableSash) {
 			this._sash.disable();
 		}
 
 		this._sash.on('start', () => this._onSashDragStart());
-		this._sash.on('change', (e: Sash.ISashEvent) => this._onSashDrag(e));
+		this._sash.on('change', (e: ISashEvent) => this._onSashDrag(e));
 		this._sash.on('end', () => this._onSashDragEnd());
 	}
 
@@ -1367,7 +1371,7 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		this._startSashPosition = this._sashPosition;
 	}
 
-	private _onSashDrag(e:Sash.ISashEvent): void {
+	private _onSashDrag(e:ISashEvent): void {
 		var w = this._dataSource.getWidth();
 		var contentWidth = w - DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH;
 		var sashPosition = this.layout((this._startSashPosition + (e.currentX - e.startX)) / contentWidth);
@@ -1381,24 +1385,24 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		this._sash.layout();
 	}
 
-	public getVerticalSashTop(sash: Sash.Sash): number {
+	public getVerticalSashTop(sash: Sash): number {
 		return 0;
 	}
 
-	public getVerticalSashLeft(sash: Sash.Sash): number {
+	public getVerticalSashLeft(sash: Sash): number {
 		return this._sashPosition;
 	}
 
-	public getVerticalSashHeight(sash: Sash.Sash): number {
+	public getVerticalSashHeight(sash: Sash): number {
 		return this._dataSource.getHeight();
 	}
 
-	_getViewZones(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorsZones {
+	_getViewZones(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorsZones {
 		var c = new SideBySideViewZonesComputer(lineChanges, originalForeignVZ, modifiedForeignVZ);
 		return c.getViewZones();
 	}
 
-	_getOriginalEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getOriginalEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 
 		var result:IEditorDiffDecorations = {
 				decorations: [],
@@ -1408,8 +1412,8 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 			length:number,
 			j:number,
 			lengthJ:number,
-			lineChange:EditorCommon.ILineChange,
-			charChange:EditorCommon.ICharChange,
+			lineChange:editorCommon.ILineChange,
+			charChange:editorCommon.ICharChange,
 			lineNumber:number,
 			startColumn:number,
 			endColumn:number,
@@ -1430,7 +1434,7 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 					endLineNumber: lineChange.originalEndLineNumber,
 					color: 'rgba(255, 0, 0, 0.4)',
 					darkColor: 'rgba(255, 0, 0, 0.4)',
-					position: EditorCommon.OverviewRulerLane.Full
+					position: editorCommon.OverviewRulerLane.Full
 				});
 
 				if (lineChange.charChanges) {
@@ -1463,7 +1467,7 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		return result;
 	}
 
-	_getModifiedEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getModifiedEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 
 		var result:IEditorDiffDecorations = {
 				decorations: [],
@@ -1473,8 +1477,8 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 			length:number,
 			j:number,
 			lengthJ:number,
-			lineChange:EditorCommon.ILineChange,
-			charChange:EditorCommon.ICharChange,
+			lineChange:editorCommon.ILineChange,
+			charChange:editorCommon.ICharChange,
 			lineNumber:number,
 			startColumn:number,
 			endColumn:number,
@@ -1494,7 +1498,7 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 					endLineNumber: lineChange.modifiedEndLineNumber,
 					color: 'rgba(155, 185, 85, 0.4)',
 					darkColor: 'rgba(155, 185, 85, 0.4)',
-					position: EditorCommon.OverviewRulerLane.Full
+					position: editorCommon.OverviewRulerLane.Full
 				});
 
 				if (lineChange.charChanges) {
@@ -1530,11 +1534,11 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 
 class SideBySideViewZonesComputer extends ViewZonesComputer {
 
-	constructor(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[]) {
+	constructor(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[]) {
 		super(lineChanges, originalForeignVZ, modifiedForeignVZ);
 	}
 
-	_produceOriginalFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+	_produceOriginalFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
 		if (lineChangeModifiedLength > lineChangeOriginalLength) {
 			return {
 				afterLineNumber: Math.max(lineChange.originalStartLineNumber, lineChange.originalEndLineNumber),
@@ -1545,7 +1549,7 @@ class SideBySideViewZonesComputer extends ViewZonesComputer {
 		return null;
 	}
 
-	_produceModifiedFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+	_produceModifiedFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
 		if (lineChangeOriginalLength > lineChangeModifiedLength) {
 			return {
 				afterLineNumber: Math.max(lineChange.modifiedStartLineNumber, lineChange.modifiedEndLineNumber),
@@ -1559,7 +1563,7 @@ class SideBySideViewZonesComputer extends ViewZonesComputer {
 
 class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditorWidgetStyle {
 
-	private toDispose:Lifecycle.IDisposable[];
+	private toDispose:IDisposable[];
 	private decorationsLeft: number;
 
 	constructor(dataSource:IDataSource, enableSplitViewResizing:boolean) {
@@ -1568,7 +1572,7 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 		this.decorationsLeft = 40;
 
 		this.toDispose = [];
-		this.toDispose.push(dataSource.getOriginalEditor().addListener2(EditorCommon.EventType.EditorLayout, (layoutInfo:EditorCommon.IEditorLayoutInfo) => {
+		this.toDispose.push(dataSource.getOriginalEditor().addListener2(editorCommon.EventType.EditorLayout, (layoutInfo:editorCommon.IEditorLayoutInfo) => {
 			if (this.decorationsLeft !== layoutInfo.decorationsLeft) {
 				this.decorationsLeft = layoutInfo.decorationsLeft;
 				dataSource.relayoutEditors();
@@ -1577,26 +1581,26 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 	}
 
 	public dispose(): void {
-		this.toDispose = Lifecycle.disposeAll(this.toDispose);
+		this.toDispose = disposeAll(this.toDispose);
 	}
 
 	public setEnableSplitViewResizing(enableSplitViewResizing:boolean): void {
 		// Nothing to do..
 	}
 
-	_getViewZones(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorsZones {
+	_getViewZones(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorsZones {
 		var computer = new InlineViewZonesComputer(lineChanges, originalForeignVZ, modifiedForeignVZ, originalEditor, modifiedEditor);
 		return computer.getViewZones();
 	}
 
-	_getOriginalEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getOriginalEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 		var result:IEditorDiffDecorations = {
 				decorations: [],
 				overviewZones: []
 			},
 			i:number,
 			length:number,
-			lineChange:EditorCommon.ILineChange;
+			lineChange:editorCommon.ILineChange;
 
 		for (i = 0, length = lineChanges.length; i < length; i++) {
 			lineChange = lineChanges[i];
@@ -1608,26 +1612,26 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 					endLineNumber: lineChange.originalEndLineNumber,
 					color: 'rgba(255, 0, 0, 0.4)',
 					darkColor: 'rgba(255, 0, 0, 0.4)',
-					position: EditorCommon.OverviewRulerLane.Full
+					position: editorCommon.OverviewRulerLane.Full
 				});
 			}
 		}
 
 		return result;
 	}
 
-	_getModifiedEditorDecorations(lineChanges:EditorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor): IEditorDiffDecorations {
+	_getModifiedEditorDecorations(lineChanges:editorCommon.ILineChange[], ignoreTrimWhitespace:boolean, originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor): IEditorDiffDecorations {
 
 		var result:IEditorDiffDecorations = {
 				decorations: [],
 				overviewZones: []
 			},
 			i:number,
 			length:number,
-			lineChange:EditorCommon.ILineChange,
+			lineChange:editorCommon.ILineChange,
 			j:number,
 			lengthJ:number,
-			charChange: EditorCommon.ICharChange,
+			charChange: editorCommon.ICharChange,
 			lineNumber:number,
 			startColumn:number,
 			endColumn:number,
@@ -1645,7 +1649,7 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 					endLineNumber: lineChange.modifiedEndLineNumber,
 					color: 'rgba(155, 185, 85, 0.4)',
 					darkColor: 'rgba(155, 185, 85, 0.4)',
-					position: EditorCommon.OverviewRulerLane.Full
+					position: editorCommon.OverviewRulerLane.Full
 				});
 
 				if (lineChange.charChanges) {
@@ -1689,31 +1693,31 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 
 class InlineViewZonesComputer extends ViewZonesComputer {
 
-	private originalModel:EditorCommon.IModel;
-	private modifiedEditorConfiguration:EditorCommon.IInternalEditorOptions;
-	private modifiedEditorIndentation:EditorCommon.IInternalIndentationOptions;
+	private originalModel:editorCommon.IModel;
+	private modifiedEditorConfiguration:editorCommon.IInternalEditorOptions;
+	private modifiedEditorIndentation:editorCommon.IInternalIndentationOptions;
 
-	constructor(lineChanges:EditorCommon.ILineChange[], originalForeignVZ:EditorCommon.IEditorWhitespace[], modifiedForeignVZ:EditorCommon.IEditorWhitespace[], originalEditor:EditorBrowser.ICodeEditor, modifiedEditor:EditorBrowser.ICodeEditor) {
+	constructor(lineChanges:editorCommon.ILineChange[], originalForeignVZ:editorCommon.IEditorWhitespace[], modifiedForeignVZ:editorCommon.IEditorWhitespace[], originalEditor:editorBrowser.ICodeEditor, modifiedEditor:editorBrowser.ICodeEditor) {
 		super(lineChanges, originalForeignVZ, modifiedForeignVZ);
 		this.originalModel = originalEditor.getModel();
 		this.modifiedEditorConfiguration = modifiedEditor.getConfiguration();
 		this.modifiedEditorIndentation = modifiedEditor.getIndentationOptions();
 	}
 
-	_produceOriginalFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+	_produceOriginalFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
 		return {
 			afterLineNumber:Math.max(lineChange.originalStartLineNumber, lineChange.originalEndLineNumber),
 			heightInLines: lineChangeModifiedLength,
 			domNode: document.createElement('div')
 		};
 	}
 
-	_produceModifiedFromDiff(lineChange:EditorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
-		var decorations:EditorCommon.IModelDecoration[] = [],
+	_produceModifiedFromDiff(lineChange:editorCommon.ILineChange, lineChangeOriginalLength:number, lineChangeModifiedLength:number): IMyViewZone {
+		var decorations:editorCommon.IModelDecoration[] = [],
 			j:number,
 			lengthJ:number,
-			charChange:EditorCommon.ICharChange,
-			tempDecoration:EditorCommon.IModelDecoration;
+			charChange:editorCommon.ICharChange,
+			tempDecoration:editorCommon.IModelDecoration;
 
 		if (lineChange.charChanges) {
 			for (j = 0, lengthJ = lineChange.charChanges.length; j < lengthJ; j++) {
@@ -1744,10 +1748,10 @@ class InlineViewZonesComputer extends ViewZonesComputer {
 		};
 	}
 
-	private renderOriginalLine(count:number, originalModel:EditorCommon.IModel, config:EditorCommon.IInternalEditorOptions, indentation:EditorCommon.IInternalIndentationOptions, lineNumber:number, decorations:EditorCommon.IModelDecoration[]): string[] {
+	private renderOriginalLine(count:number, originalModel:editorCommon.IModel, config:editorCommon.IInternalEditorOptions, indentation:editorCommon.IInternalIndentationOptions, lineNumber:number, decorations:editorCommon.IModelDecoration[]): string[] {
 		var lineContent = originalModel.getLineContent(lineNumber),
-			lineTokens:EditorCommon.IViewLineTokens,
-			parts:ViewLineParts.ILineParts;
+			lineTokens:editorCommon.IViewLineTokens,
+			parts:ILineParts;
 
 		lineTokens = {
 			getTokens: () => {
@@ -1759,15 +1763,15 @@ class InlineViewZonesComputer extends ViewZonesComputer {
 			getTextLength: () => {
 				return lineContent.length;
 			},
-			equals: (other:EditorCommon.IViewLineTokens) => {
+			equals: (other:editorCommon.IViewLineTokens) => {
 				return false;
 			},
 			findIndexOfOffset: (offset:number) => {
 				return 0;
 			}
 		};
 
-		parts = ViewLineParts.createLineParts(lineNumber, lineContent, lineTokens, decorations, config.renderWhitespace);
+		parts = createLineParts(lineNumber, lineContent, lineTokens, decorations, config.renderWhitespace);
 
 		var r = renderLine({
 			lineContent: lineContent,
@@ -1795,15 +1799,15 @@ class InlineViewZonesComputer extends ViewZonesComputer {
 	}
 }
 
-function isChangeOrInsert(lineChange:EditorCommon.IChange): boolean {
+function isChangeOrInsert(lineChange:editorCommon.IChange): boolean {
 	return lineChange.modifiedEndLineNumber > 0;
 }
 
-function isChangeOrDelete(lineChange:EditorCommon.IChange): boolean {
+function isChangeOrDelete(lineChange:editorCommon.IChange): boolean {
 	return lineChange.originalEndLineNumber > 0;
 }
 
-function createDecoration(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, className:string, isWholeLine:boolean): EditorCommon.IModelDeltaDecoration {
+function createDecoration(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, className:string, isWholeLine:boolean): editorCommon.IModelDeltaDecoration {
 	return {
 		range: new Range(startLineNumber, startColumn, endLineNumber, endColumn),
 		options: {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/browser/widget/embeddedCodeEditorWidget.ts
code:
@@ -4,24 +4,24 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import CodeEditorWidget = require('vs/editor/browser/widget/codeEditorWidget');
-import EditorBrowser = require('vs/editor/browser/editorBrowser');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Objects = require('vs/base/common/objects');
+import * as objects from 'vs/base/common/objects';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
 import {IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
+import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {EventType, ICodeEditorWidgetCreationOptions, IConfigurationChangedEvent, IEditorOptions} from 'vs/editor/common/editorCommon';
 import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
+import {ICodeEditor} from 'vs/editor/browser/editorBrowser';
+import {CodeEditorWidget} from 'vs/editor/browser/widget/codeEditorWidget';
 
-export class EmbeddedCodeEditorWidget extends CodeEditorWidget.CodeEditorWidget {
+export class EmbeddedCodeEditorWidget extends CodeEditorWidget {
 
-	private _parentEditor: EditorBrowser.ICodeEditor;
-	private _overwriteOptions: EditorCommon.ICodeEditorWidgetCreationOptions;
+	private _parentEditor: ICodeEditor;
+	private _overwriteOptions: ICodeEditorWidgetCreationOptions;
 
 	constructor(
 		domElement:HTMLElement,
-		options:EditorCommon.ICodeEditorWidgetCreationOptions,
-		parentEditor:EditorBrowser.ICodeEditor,
+		options:ICodeEditorWidgetCreationOptions,
+		parentEditor:ICodeEditor,
 		@IInstantiationService instantiationService: IInstantiationService,
 		@ICodeEditorService codeEditorService: ICodeEditorService,
 		@IKeybindingService keybindingService: IKeybindingService,
@@ -35,16 +35,16 @@ export class EmbeddedCodeEditorWidget extends CodeEditorWidget.CodeEditorWidget
 		// Overwrite parent's options
 		super.updateOptions(this._overwriteOptions);
 
-		this._lifetimeDispose.push(parentEditor.addListener2(EditorCommon.EventType.ConfigurationChanged, (e:EditorCommon.IConfigurationChangedEvent) => this._onParentConfigurationChanged(e)));
+		this._lifetimeDispose.push(parentEditor.addListener2(EventType.ConfigurationChanged, (e:IConfigurationChangedEvent) => this._onParentConfigurationChanged(e)));
 	}
 
-	private _onParentConfigurationChanged(e:EditorCommon.IConfigurationChangedEvent): void {
+	private _onParentConfigurationChanged(e:IConfigurationChangedEvent): void {
 		super.updateOptions(this._parentEditor.getRawConfiguration());
 		super.updateOptions(this._overwriteOptions);
 	}
 
-	public updateOptions(newOptions:EditorCommon.IEditorOptions): void {
-		Objects.mixin(this._overwriteOptions, newOptions, true);
+	public updateOptions(newOptions:IEditorOptions): void {
+		objects.mixin(this._overwriteOptions, newOptions, true);
 		super.updateOptions(this._overwriteOptions);
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/buildfile.js
code:
@@ -2,36 +2,16 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
-'use strict';
-
-function createModuleDescription(name, exclude) {
-	var result= {};
-	result.name= name;
-	var excludes = ['vs/css', 'vs/nls', 'vs/text'];
-	if (Array.isArray(exclude) && exclude.length > 0) {
-		excludes = excludes.concat(exclude);
-	}
-	result.exclude= excludes;
-	return result;
-}
 
-function addInclude(config, include) {
-	if (!config.include) {
-		config.include = [];
-	}
-	config.include.push(include);
-	return config;
-}
+'use strict';
 
-exports.collectModules= function() {
-	return [
-		// Include the severity module into the base worker code since it is used by many languages
-		// It can cause waterfall loading if one language excludes another language it depends on and
-		// both use vs/base/common/severity
-		addInclude(
-			createModuleDescription('vs/editor/common/worker/editorWorkerServer', ['vs/base/common/worker/workerServer']),
-			'vs/base/common/severity'
-		),
-		createModuleDescription('vs/editor/common/services/editorSimpleWorker', ['vs/base/common/worker/simpleWorker']),
-	];
-};
\ No newline at end of file
+exports.collectModules = function() {
+	return [{
+		name: 'vs/editor/common/worker/editorWorkerServer',
+		include: [ 'vs/base/common/severity' ],
+		exclude: [ 'vs/base/common/worker/workerServer', 'vs/css', 'vs/nls', 'vs/text' ]
+	}, {
+		name: 'vs/editor/common/services/editorSimpleWorker',
+		exclude: [ 'vs/base/common/worker/simpleWorker', 'vs/css', 'vs/nls', 'vs/text' ]
+	}];
+};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/commands/replaceCommand.ts
code:
@@ -5,14 +5,14 @@
 'use strict';
 
 import {Selection} from 'vs/editor/common/core/selection';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as editorCommon from 'vs/editor/common/editorCommon';
 
-export class ReplaceCommand implements EditorCommon.ICommand {
+export class ReplaceCommand implements editorCommon.ICommand {
 
-	private _range: EditorCommon.IEditorRange;
+	private _range: editorCommon.IEditorRange;
 	private _text: string;
 
-	constructor(range: EditorCommon.IEditorRange, text: string) {
+	constructor(range: editorCommon.IEditorRange, text: string) {
 		this._range = range;
 		this._text = text;
 	}
@@ -21,19 +21,19 @@ export class ReplaceCommand implements EditorCommon.ICommand {
 		return this._text;
 	}
 
-	public getRange():EditorCommon.IEditorRange {
+	public getRange():editorCommon.IEditorRange {
 		return this._range;
 	}
 
-	public setRange(newRange:EditorCommon.IEditorRange): void {
+	public setRange(newRange:editorCommon.IEditorRange): void {
 		this._range = newRange;
 	}
 
-	public getEditOperations(model: EditorCommon.ITokenizedModel, builder: EditorCommon.IEditOperationBuilder): void {
+	public getEditOperations(model: editorCommon.ITokenizedModel, builder: editorCommon.IEditOperationBuilder): void {
 		builder.addEditOperation(this._range, this._text);
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData): editorCommon.IEditorSelection {
 		var inverseEditOperations = helper.getInverseEditOperations();
 		var srcRange = inverseEditOperations[0].range;
 		return new Selection(
@@ -47,11 +47,11 @@ export class ReplaceCommand implements EditorCommon.ICommand {
 
 export class ReplaceCommandWithoutChangingPosition extends ReplaceCommand {
 
-	constructor(range: EditorCommon.IEditorRange, text: string) {
+	constructor(range: editorCommon.IEditorRange, text: string) {
 		super(range, text);
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData): editorCommon.IEditorSelection {
 		var inverseEditOperations = helper.getInverseEditOperations();
 		var srcRange = inverseEditOperations[0].range;
 		return new Selection(
@@ -68,13 +68,13 @@ export class ReplaceCommandWithOffsetCursorState extends ReplaceCommand {
 	private _columnDeltaOffset: number;
 	private _lineNumberDeltaOffset: number;
 
-	constructor(range: EditorCommon.IEditorRange, text: string, lineNumberDeltaOffset: number, columnDeltaOffset: number) {
+	constructor(range: editorCommon.IEditorRange, text: string, lineNumberDeltaOffset: number, columnDeltaOffset: number) {
 		super(range, text);
 		this._columnDeltaOffset = columnDeltaOffset;
 		this._lineNumberDeltaOffset = lineNumberDeltaOffset;
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData): editorCommon.IEditorSelection {
 		var inverseEditOperations = helper.getInverseEditOperations();
 		var srcRange = inverseEditOperations[0].range;
 		return new Selection(
@@ -88,21 +88,21 @@ export class ReplaceCommandWithOffsetCursorState extends ReplaceCommand {
 
 export class ReplaceCommandThatPreservesSelection extends ReplaceCommand {
 
-	private _initialSelection: EditorCommon.IEditorSelection;
+	private _initialSelection: editorCommon.IEditorSelection;
 	private _selectionId: string;
 
-	constructor(editRange: EditorCommon.IEditorRange, text: string, initialSelection: EditorCommon.IEditorSelection) {
+	constructor(editRange: editorCommon.IEditorRange, text: string, initialSelection: editorCommon.IEditorSelection) {
 		super(editRange, text);
 		this._initialSelection = initialSelection;
 	}
 
-	public getEditOperations(model: EditorCommon.ITokenizedModel, builder: EditorCommon.IEditOperationBuilder): void {
+	public getEditOperations(model: editorCommon.ITokenizedModel, builder: editorCommon.IEditOperationBuilder): void {
 		super.getEditOperations(model, builder);
 
 		this._selectionId = builder.trackSelection(this._initialSelection);
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData): editorCommon.IEditorSelection {
 		return helper.getTrackedSelection(this._selectionId);
 	}
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/commands/shiftCommand.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Strings = require('vs/base/common/strings');
+import * as strings from 'vs/base/common/strings';
+import {CursorMoveHelper} from 'vs/editor/common/controller/cursorMoveHelper';
 import {Range} from 'vs/editor/common/core/range';
 import {Selection} from 'vs/editor/common/core/selection';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {CursorMoveHelper} from 'vs/editor/common/controller/cursorMoveHelper';
+import {ICommand, ICursorStateComputerData, IEditOperationBuilder, IEditorSelection, ITokenizedModel} from 'vs/editor/common/editorCommon';
 import {getRawEnterActionAtPosition} from 'vs/editor/common/modes/supports/onEnter';
 
 export interface IShiftCommandOpts {
@@ -17,7 +17,7 @@ export interface IShiftCommandOpts {
 	oneIndent: string;
 }
 
-export class ShiftCommand implements EditorCommon.ICommand {
+export class ShiftCommand implements ICommand {
 
 	public static unshiftIndentCount(line:string, column:number, tabSize:number): number {
 		// Determine the visible column where the content starts
@@ -40,17 +40,17 @@ export class ShiftCommand implements EditorCommon.ICommand {
 	}
 
 	private _opts: IShiftCommandOpts;
-	private _selection: EditorCommon.IEditorSelection;
+	private _selection: IEditorSelection;
 	private _selectionId: string;
 	private _useLastEditRangeForCursorEndPosition: boolean;
 
-	constructor(range: EditorCommon.IEditorSelection, opts:IShiftCommandOpts) {
+	constructor(range: IEditorSelection, opts:IShiftCommandOpts) {
 		this._opts = opts;
 		this._selection = range;
 		this._useLastEditRangeForCursorEndPosition = false;
 	}
 
-	public getEditOperations(model: EditorCommon.ITokenizedModel, builder: EditorCommon.IEditOperationBuilder): void {
+	public getEditOperations(model: ITokenizedModel, builder: IEditOperationBuilder): void {
 		let startLine = this._selection.startLineNumber,
 			endLine = this._selection.endLineNumber,
 			_SPACE = ' '.charCodeAt(0);
@@ -79,7 +79,7 @@ export class ShiftCommand implements EditorCommon.ICommand {
 		for (lineNumber = startLine; lineNumber <= endLine; lineNumber++, previousLineExtraSpaces = extraSpaces) {
 			extraSpaces = 0;
 			let lineText = model.getLineContent(lineNumber);
-			let indentationEndIndex = Strings.firstNonWhitespaceIndex(lineText);
+			let indentationEndIndex = strings.firstNonWhitespaceIndex(lineText);
 
 			if (this._opts.isUnshift && (lineText.length === 0 || indentationEndIndex === 0)) {
 				// empty line or line with no leading whitespace => nothing to do
@@ -152,7 +152,7 @@ export class ShiftCommand implements EditorCommon.ICommand {
 		this._selectionId = builder.trackSelection(this._selection);
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: ITokenizedModel, helper: ICursorStateComputerData): IEditorSelection {
 		if (this._useLastEditRangeForCursorEndPosition) {
 			var lastOp = helper.getInverseEditOperations()[0];
 			return new Selection(lastOp.range.endLineNumber, lastOp.range.endColumn, lastOp.range.endLineNumber, lastOp.range.endColumn);

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/commands/surroundSelectionCommand.ts
code:
@@ -6,20 +6,20 @@
 
 import {Range} from 'vs/editor/common/core/range';
 import {Selection} from 'vs/editor/common/core/selection';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {ICommand, ICursorStateComputerData, IEditOperationBuilder, IEditorSelection, ITokenizedModel} from 'vs/editor/common/editorCommon';
 
-export class SurroundSelectionCommand implements EditorCommon.ICommand {
-	private _range: EditorCommon.IEditorSelection;
+export class SurroundSelectionCommand implements ICommand {
+	private _range: IEditorSelection;
 	private _charBeforeSelection: string;
 	private _charAfterSelection: string;
 
-	constructor(range:EditorCommon.IEditorSelection, charBeforeSelection:string, charAfterSelection:string) {
+	constructor(range:IEditorSelection, charBeforeSelection:string, charAfterSelection:string) {
 		this._range = range;
 		this._charBeforeSelection = charBeforeSelection;
 		this._charAfterSelection = charAfterSelection;
 	}
 
-	public getEditOperations(model:EditorCommon.ITokenizedModel, builder:EditorCommon.IEditOperationBuilder): void {
+	public getEditOperations(model:ITokenizedModel, builder:IEditOperationBuilder): void {
 		builder.addEditOperation(new Range(
 			this._range.startLineNumber,
 			this._range.startColumn,
@@ -35,7 +35,7 @@ export class SurroundSelectionCommand implements EditorCommon.ICommand {
 		), this._charAfterSelection);
 	}
 
-	public computeCursorState(model: EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData): EditorCommon.IEditorSelection {
+	public computeCursorState(model: ITokenizedModel, helper: ICursorStateComputerData): IEditorSelection {
 		var inverseEditOperations = helper.getInverseEditOperations();
 		var firstOperationRange = inverseEditOperations[0].range;
 		var secondOperationRange = inverseEditOperations[1].range;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/commands/trimTrailingWhitespaceCommand.ts
code:
@@ -4,21 +4,21 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {Range} from 'vs/editor/common/core/range';
+import * as strings from 'vs/base/common/strings';
 import {EditOperation} from 'vs/editor/common/core/editOperation';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Strings = require('vs/base/common/strings');
+import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 
-export class TrimTrailingWhitespaceCommand implements EditorCommon.ICommand {
+export class TrimTrailingWhitespaceCommand implements editorCommon.ICommand {
 
-	private selection:EditorCommon.IEditorSelection;
+	private selection:editorCommon.IEditorSelection;
 	private selectionId:string;
 
-	constructor(selection:EditorCommon.IEditorSelection) {
+	constructor(selection:editorCommon.IEditorSelection) {
 		this.selection = selection;
 	}
 
-	public getEditOperations(model:EditorCommon.ITokenizedModel, builder:EditorCommon.IEditOperationBuilder):void {
+	public getEditOperations(model:editorCommon.ITokenizedModel, builder:editorCommon.IEditOperationBuilder):void {
 		var ops = trimTrailingWhitespace(model, []);
 		for (var i = 0, len = ops.length; i < len; i++) {
 			var op = ops[i];
@@ -29,15 +29,15 @@ export class TrimTrailingWhitespaceCommand implements EditorCommon.ICommand {
 		this.selectionId = builder.trackSelection(this.selection);
 	}
 
-	public computeCursorState(model:EditorCommon.ITokenizedModel, helper: EditorCommon.ICursorStateComputerData):EditorCommon.IEditorSelection {
+	public computeCursorState(model:editorCommon.ITokenizedModel, helper: editorCommon.ICursorStateComputerData):editorCommon.IEditorSelection {
 		return helper.getTrackedSelection(this.selectionId);
 	}
 }
 
 /**
  * Generate commands for trimming trailing whitespace on a model and ignore lines on which cursors are sitting.
  */
-export function trimTrailingWhitespace(model:EditorCommon.ITextModel, cursors: EditorCommon.IPosition[]): EditorCommon.IIdentifiedSingleEditOperation[] {
+export function trimTrailingWhitespace(model:editorCommon.ITextModel, cursors: editorCommon.IPosition[]): editorCommon.IIdentifiedSingleEditOperation[] {
 	// Sort cursors ascending
 	cursors.sort((a, b) => {
 		if (a.lineNumber === b.lineNumber) {
@@ -54,7 +54,7 @@ export function trimTrailingWhitespace(model:EditorCommon.ITextModel, cursors: E
 		}
 	}
 
-	var r:EditorCommon.IIdentifiedSingleEditOperation[] = [],
+	var r:editorCommon.IIdentifiedSingleEditOperation[] = [],
 		cursorIndex = 0,
 		cursorLen = cursors.length,
 		lineNumber:number,
@@ -84,7 +84,7 @@ export function trimTrailingWhitespace(model:EditorCommon.ITextModel, cursors: E
 			continue;
 		}
 
-		lastNonWhitespaceIndex = Strings.lastNonWhitespaceIndex(lineContent);
+		lastNonWhitespaceIndex = strings.lastNonWhitespaceIndex(lineContent);
 
 		fromColumn = 0;
 		if (lastNonWhitespaceIndex === -1) {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/commonCodeEditor.ts
code:
@@ -5,35 +5,35 @@
 'use strict';
 
 import * as nls from 'vs/nls';
-import * as EditorCommon from 'vs/editor/common/editorCommon';
-import {TPromise} from 'vs/base/common/winjs.base';
-import * as Objects from 'vs/base/common/objects';
+import {IAction, IActionProvider, isAction} from 'vs/base/common/actions';
 import {onUnexpectedError} from 'vs/base/common/errors';
-import EventEmitter = require('vs/base/common/eventEmitter');
+import {EventEmitter, IEventEmitter, ListenerUnbind} from 'vs/base/common/eventEmitter';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import * as objects from 'vs/base/common/objects';
+import * as timer from 'vs/base/common/timer';
+import {TPromise} from 'vs/base/common/winjs.base';
+import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {IKeybindingContextKey, IKeybindingScopeLocation, IKeybindingService} from 'vs/platform/keybinding/common/keybindingService';
+import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {CommonEditorConfiguration, IIndentationGuesser} from 'vs/editor/common/config/commonEditorConfig';
+import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
 import {Cursor} from 'vs/editor/common/controller/cursor';
-import {CharacterHardWrappingLineMapperFactory} from 'vs/editor/common/viewModel/characterHardWrappingLineMapper';
-import {SplitLinesCollection} from 'vs/editor/common/viewModel/splitLinesCollection';
-import {ViewModel} from 'vs/editor/common/viewModel/viewModel';
-import * as Timer from 'vs/base/common/timer';
-import {IActionProvider, IAction, isAction} from 'vs/base/common/actions';
 import {CursorMoveHelper} from 'vs/editor/common/controller/cursorMoveHelper';
 import {IViewModelHelper} from 'vs/editor/common/controller/oneCursor';
-import {IDisposable,disposeAll} from 'vs/base/common/lifecycle';
-import {DynamicEditorAction} from 'vs/editor/common/editorAction';
-import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
-import {Range} from 'vs/editor/common/core/range';
+import {EditorState} from 'vs/editor/common/core/editorState';
 import {Position} from 'vs/editor/common/core/position';
+import {Range} from 'vs/editor/common/core/range';
 import {Selection} from 'vs/editor/common/core/selection';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
-import {EditorState} from 'vs/editor/common/core/editorState';
-import {IKeybindingScopeLocation, IKeybindingService, IKeybindingContextKey} from 'vs/platform/keybinding/common/keybindingService';
-import {CommonEditorConfiguration, IIndentationGuesser} from 'vs/editor/common/config/commonEditorConfig';
-import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
+import {DynamicEditorAction} from 'vs/editor/common/editorAction';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
+import {CharacterHardWrappingLineMapperFactory} from 'vs/editor/common/viewModel/characterHardWrappingLineMapper';
+import {SplitLinesCollection} from 'vs/editor/common/viewModel/splitLinesCollection';
+import {ViewModel} from 'vs/editor/common/viewModel/viewModel';
 
 var EDITOR_ID = 0;
 
-export abstract class CommonCodeEditor extends EventEmitter.EventEmitter implements IActionProvider, EditorCommon.ICommonCodeEditor {
+export abstract class CommonCodeEditor extends EventEmitter implements IActionProvider, editorCommon.ICommonCodeEditor {
 
 	protected domElement: IKeybindingScopeLocation;
 
@@ -44,13 +44,13 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 
 	_telemetryService:ITelemetryService;
 
-	protected contributions:{ [key:string]:EditorCommon.IEditorContribution; };
+	protected contributions:{ [key:string]:editorCommon.IEditorContribution; };
 
 	protected forcedWidgetFocusCount:number;
 
 	// --- Members logically associated to a model
-	protected model:EditorCommon.IModel;
-	protected listenersToRemove:EventEmitter.ListenerUnbind[];
+	protected model:editorCommon.IModel;
+	protected listenersToRemove:ListenerUnbind[];
 	protected hasView: boolean;
 
 	protected viewModel:ViewModel;
@@ -71,7 +71,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 
 	constructor(
 		domElement: IKeybindingScopeLocation,
-		options:EditorCommon.ICodeEditorWidgetCreationOptions,
+		options:editorCommon.ICodeEditorWidgetCreationOptions,
 		instantiationService: IInstantiationService,
 		codeEditorService: ICodeEditorService,
 		keybindingService: IKeybindingService,
@@ -84,23 +84,23 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		this.id = (++EDITOR_ID);
 		this._codeEditorService = codeEditorService;
 
-		var timerEvent = Timer.start(Timer.Topic.EDITOR, 'CodeEditor.ctor');
+		var timerEvent = timer.start(timer.Topic.EDITOR, 'CodeEditor.ctor');
 
 		this._lifetimeDispose = [];
 
 		this._keybindingService = keybindingService.createScoped(domElement);
 		this._editorIdContextKey = this._keybindingService.createKey('editorId', this.getId());
-		this._editorFocusContextKey = this._keybindingService.createKey(EditorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS, undefined);
-		this._editorTabMovesFocusKey = this._keybindingService.createKey(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS, false);
-		this._hasMultipleSelectionsKey = this._keybindingService.createKey(EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS, false);
-		this._hasNonEmptySelectionKey = this._keybindingService.createKey(EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION, false);
-		this._langIdKey = this._keybindingService.createKey<string>(EditorCommon.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID, undefined);
+		this._editorFocusContextKey = this._keybindingService.createKey(editorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS, undefined);
+		this._editorTabMovesFocusKey = this._keybindingService.createKey(editorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS, false);
+		this._hasMultipleSelectionsKey = this._keybindingService.createKey(editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS, false);
+		this._hasNonEmptySelectionKey = this._keybindingService.createKey(editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION, false);
+		this._langIdKey = this._keybindingService.createKey<string>(editorCommon.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID, undefined);
 
 		// listeners that are kept during the whole editor lifetime
 		this._decorationTypeKeysToIds = {};
 
 		options = options || {};
-		var model: EditorCommon.IModel = null;
+		var model: editorCommon.IModel = null;
 		if (options.model) {
 			model = options.model;
 			delete options.model;
@@ -120,7 +120,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		if (this._configuration.editor.tabFocusMode) {
 			this._editorTabMovesFocusKey.set(true);
 		}
-		this._lifetimeDispose.push(this._configuration.onDidChange((e) => this.emit(EditorCommon.EventType.ConfigurationChanged, e)));
+		this._lifetimeDispose.push(this._configuration.onDidChange((e) => this.emit(editorCommon.EventType.ConfigurationChanged, e)));
 
 		this.forcedWidgetFocusCount = 0;
 
@@ -140,14 +140,14 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		this._codeEditorService.addCodeEditor(this);
 	}
 
-	protected abstract _createConfiguration(options:EditorCommon.ICodeEditorWidgetCreationOptions, indentationGuesser:IIndentationGuesser): CommonEditorConfiguration;
+	protected abstract _createConfiguration(options:editorCommon.ICodeEditorWidgetCreationOptions, indentationGuesser:IIndentationGuesser): CommonEditorConfiguration;
 
 	public getId(): string {
 		return this.getEditorType() + ':' + this.id;
 	}
 
 	public getEditorType(): string {
-		return EditorCommon.EditorType.ICodeEditor;
+		return editorCommon.EditorType.ICodeEditor;
 	}
 
 	public destroy(): void {
@@ -169,23 +169,23 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		this._postDetachModelCleanup(this._detachModel());
 		this._configuration.dispose();
 		this._keybindingService.dispose();
-		this.emit(EditorCommon.EventType.Disposed, {});
+		this.emit(editorCommon.EventType.Disposed, {});
 		super.dispose();
 	}
 
-	public captureState(...flags:EditorCommon.CodeEditorStateFlag[]): EditorCommon.ICodeEditorState {
+	public captureState(...flags:editorCommon.CodeEditorStateFlag[]): editorCommon.ICodeEditorState {
 		return new EditorState(this, flags);
 	}
 
 	private _ariaLabelAppendMessage(): string {
-		let keybindings = this._keybindingService.lookupKeybindings(EditorCommon.SHOW_ACCESSIBILITY_HELP_ACTION_ID);
+		let keybindings = this._keybindingService.lookupKeybindings(editorCommon.SHOW_ACCESSIBILITY_HELP_ACTION_ID);
 		if (keybindings.length > 0) {
 			return nls.localize('showAccessibilityHelp', "Press {0} for more info.", this._keybindingService.getLabelFor(keybindings[0]));
 		}
 		return '';
 	}
 
-	public updateOptions(newOptions:EditorCommon.IEditorOptions): void {
+	public updateOptions(newOptions:editorCommon.IEditorOptions): void {
 		if (typeof newOptions.ariaLabel !== 'undefined') {
 			newOptions.ariaLabel += this._ariaLabelAppendMessage();
 		}
@@ -197,34 +197,38 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	public getConfiguration(): EditorCommon.IInternalEditorOptions {
+	public getConfiguration(): editorCommon.IInternalEditorOptions {
 		return this._configuration.editorClone;
 	}
 
-	public getRawConfiguration(): EditorCommon.IEditorOptions {
+	public getRawConfiguration(): editorCommon.IEditorOptions {
 		return this._configuration.getRawOptions();
 	}
 
-	public getIndentationOptions(): EditorCommon.IInternalIndentationOptions {
+	public getIndentationOptions(): editorCommon.IInternalIndentationOptions {
 		let r = this._configuration.getIndentationOptions();
 		return {
 			tabSize: r.tabSize,
 			insertSpaces: r.insertSpaces
 		};
 	}
 
+	public setIndentationOptions(indentationOptions: editorCommon.IInternalIndentationOptions): void {
+		this._configuration.setIndentationOptions(indentationOptions);
+	}
+
 	public normalizeIndentation(str:string): string {
 		return this._configuration.normalizeIndentation(str);
 	}
 
 	public getValue(options:{ preserveBOM:boolean; lineEnding:string; }=null): string {
 		if (this.model) {
 			var preserveBOM:boolean = (options && options.preserveBOM) ? true : false;
-			var eolPreference = EditorCommon.EndOfLinePreference.TextDefined;
+			var eolPreference = editorCommon.EndOfLinePreference.TextDefined;
 			if (options && options.lineEnding && options.lineEnding === '\n') {
-				eolPreference = EditorCommon.EndOfLinePreference.LF;
+				eolPreference = editorCommon.EndOfLinePreference.LF;
 			} else if (options  && options.lineEnding && options.lineEnding === '\r\n') {
-				eolPreference = EditorCommon.EndOfLinePreference.CRLF;
+				eolPreference = editorCommon.EndOfLinePreference.CRLF;
 			}
 			return this.model.getValue(eolPreference, preserveBOM);
 		}
@@ -237,17 +241,17 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	public getModel(): EditorCommon.IModel {
+	public getModel(): editorCommon.IModel {
 		return this.model;
 	}
 
-	public setModel(model:EditorCommon.IModel = null): void {
+	public setModel(model:editorCommon.IModel = null): void {
 		if (this.model === model) {
 			// Current model is the new model
 			return;
 		}
 
-		var timerEvent = Timer.start(Timer.Topic.EDITOR, 'CodeEditor.setModel');
+		var timerEvent = timer.start(timer.Topic.EDITOR, 'CodeEditor.setModel');
 
 		var detachedModel = this._detachModel();
 		this._attachModel(model);
@@ -261,20 +265,20 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		if (model) {
 			newModelUrl = model.getAssociatedResource().toString();
 		}
-		var e: EditorCommon.IModelChangedEvent = {
+		var e: editorCommon.IModelChangedEvent = {
 			oldModelUrl: oldModelUrl,
 			newModelUrl: newModelUrl
 		};
 
 		timerEvent.stop();
 
-		this.emit(EditorCommon.EventType.ModelChanged, e);
+		this.emit(editorCommon.EventType.ModelChanged, e);
 		this._postDetachModelCleanup(detachedModel);
 	}
 
-	public abstract getCenteredRangeInViewport(): EditorCommon.IEditorRange;
+	public abstract getCenteredRangeInViewport(): editorCommon.IEditorRange;
 
-	public getVisibleColumnFromPosition(rawPosition:EditorCommon.IPosition): number {
+	public getVisibleColumnFromPosition(rawPosition:editorCommon.IPosition): number {
 		if (!this.model) {
 			return rawPosition.column;
 		}
@@ -284,14 +288,14 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		return CursorMoveHelper.visibleColumnFromColumn(this.model, position.lineNumber, position.column, this._configuration.getIndentationOptions().tabSize) + 1;
 	}
 
-	public getPosition(): EditorCommon.IEditorPosition {
+	public getPosition(): editorCommon.IEditorPosition {
 		if (!this.cursor) {
 			return null;
 		}
 		return this.cursor.getPosition().clone();
 	}
 
-	public setPosition(position:EditorCommon.IPosition, reveal:boolean = false, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = false): void {
+	public setPosition(position:editorCommon.IPosition, reveal:boolean = false, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = false): void {
 		if (!this.cursor) {
 			return;
 		}
@@ -309,7 +313,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	private _sendRevealRange(range: EditorCommon.IRange, verticalType: EditorCommon.VerticalRevealType, revealHorizontal: boolean): void {
+	private _sendRevealRange(range: editorCommon.IRange, verticalType: editorCommon.VerticalRevealType, revealHorizontal: boolean): void {
 		if (!this.model || !this.cursor) {
 			return;
 		}
@@ -318,13 +322,13 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 		var validatedRange = this.model.validateRange(range);
 
-		var revealRangeEvent: EditorCommon.ICursorRevealRangeEvent = {
+		var revealRangeEvent: editorCommon.ICursorRevealRangeEvent = {
 			range: validatedRange,
 			viewRange: null,
 			verticalType: verticalType,
 			revealHorizontal: revealHorizontal
 		};
-		this.cursor.emit(EditorCommon.EventType.CursorRevealRange, revealRangeEvent);
+		this.cursor.emit(editorCommon.EventType.CursorRevealRange, revealRangeEvent);
 	}
 
 	public revealLine(lineNumber: number): void {
@@ -333,7 +337,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: lineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.Simple, false);
+		}, editorCommon.VerticalRevealType.Simple, false);
 	}
 
 	public revealLineInCenter(lineNumber: number): void {
@@ -342,7 +346,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: lineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.Center, false);
+		}, editorCommon.VerticalRevealType.Center, false);
 	}
 
 	public revealLineInCenterIfOutsideViewport(lineNumber: number): void {
@@ -351,10 +355,10 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: lineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.CenterIfOutsideViewport, false);
+		}, editorCommon.VerticalRevealType.CenterIfOutsideViewport, false);
 	}
 
-	public revealPosition(position: EditorCommon.IPosition, revealVerticalInCenter:boolean=false, revealHorizontal:boolean=false): void {
+	public revealPosition(position: editorCommon.IPosition, revealVerticalInCenter:boolean=false, revealHorizontal:boolean=false): void {
 		if (!Position.isIPosition(position)) {
 			throw new Error('Invalid arguments');
 		}
@@ -363,10 +367,10 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: position.column,
 			endLineNumber: position.lineNumber,
 			endColumn: position.column
-		}, revealVerticalInCenter ? EditorCommon.VerticalRevealType.Center : EditorCommon.VerticalRevealType.Simple, revealHorizontal);
+		}, revealVerticalInCenter ? editorCommon.VerticalRevealType.Center : editorCommon.VerticalRevealType.Simple, revealHorizontal);
 	}
 
-	public revealPositionInCenter(position: EditorCommon.IPosition): void {
+	public revealPositionInCenter(position: editorCommon.IPosition): void {
 		if (!Position.isIPosition(position)) {
 			throw new Error('Invalid arguments');
 		}
@@ -375,10 +379,10 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: position.column,
 			endLineNumber: position.lineNumber,
 			endColumn: position.column
-		}, EditorCommon.VerticalRevealType.Center, true);
+		}, editorCommon.VerticalRevealType.Center, true);
 	}
 
-	public revealPositionInCenterIfOutsideViewport(position: EditorCommon.IPosition): void {
+	public revealPositionInCenterIfOutsideViewport(position: editorCommon.IPosition): void {
 		if (!Position.isIPosition(position)) {
 			throw new Error('Invalid arguments');
 		}
@@ -387,32 +391,32 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: position.column,
 			endLineNumber: position.lineNumber,
 			endColumn: position.column
-		}, EditorCommon.VerticalRevealType.CenterIfOutsideViewport, true);
+		}, editorCommon.VerticalRevealType.CenterIfOutsideViewport, true);
 	}
 
-	public getSelection(): EditorCommon.IEditorSelection {
+	public getSelection(): editorCommon.IEditorSelection {
 		if (!this.cursor) {
 			return null;
 		}
 		return this.cursor.getSelection().clone();
 	}
 
-	public getSelections(): EditorCommon.IEditorSelection[] {
+	public getSelections(): editorCommon.IEditorSelection[] {
 		if (!this.cursor) {
 			return null;
 		}
 		var selections = this.cursor.getSelections();
-		var result:EditorCommon.IEditorSelection[] = [];
+		var result:editorCommon.IEditorSelection[] = [];
 		for (var i = 0, len = selections.length; i < len; i++) {
 			result[i] = selections[i].clone();
 		}
 		return result;
 	}
 
-	public setSelection(range:EditorCommon.IRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(editorRange:EditorCommon.IEditorRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(selection:EditorCommon.ISelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
-	public setSelection(editorSelection:EditorCommon.IEditorSelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(range:editorCommon.IRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(editorRange:editorCommon.IEditorRange, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(selection:editorCommon.ISelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
+	public setSelection(editorSelection:editorCommon.IEditorSelection, reveal?:boolean, revealVerticalInCenter?:boolean, revealHorizontal?:boolean): void;
 	public setSelection(something:any, reveal:boolean = false, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = false): void {
 		var isSelection = Selection.isISelection(something);
 		var isRange = Range.isIRange(something);
@@ -422,10 +426,10 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 
 		if (isSelection) {
-			this._setSelectionImpl(<EditorCommon.ISelection>something, reveal, revealVerticalInCenter, revealHorizontal);
+			this._setSelectionImpl(<editorCommon.ISelection>something, reveal, revealVerticalInCenter, revealHorizontal);
 		} else if (isRange) {
 			// act as if it was an IRange
-			var selection:EditorCommon.ISelection = {
+			var selection:editorCommon.ISelection = {
 				selectionStartLineNumber: something.startLineNumber,
 				selectionStartColumn: something.startColumn,
 				positionLineNumber: something.endLineNumber,
@@ -435,7 +439,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	private _setSelectionImpl(sel:EditorCommon.ISelection, reveal:boolean, revealVerticalInCenter:boolean, revealHorizontal:boolean): void {
+	private _setSelectionImpl(sel:editorCommon.ISelection, reveal:boolean, revealVerticalInCenter:boolean, revealHorizontal:boolean): void {
 		if (!this.cursor) {
 			return;
 		}
@@ -452,7 +456,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: endLineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.Simple, false);
+		}, editorCommon.VerticalRevealType.Simple, false);
 	}
 
 	public revealLinesInCenter(startLineNumber: number, endLineNumber: number): void {
@@ -461,7 +465,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: endLineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.Center, false);
+		}, editorCommon.VerticalRevealType.Center, false);
 	}
 
 	public revealLinesInCenterIfOutsideViewport(startLineNumber: number, endLineNumber: number): void {
@@ -470,22 +474,22 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 			startColumn: 1,
 			endLineNumber: endLineNumber,
 			endColumn: 1
-		}, EditorCommon.VerticalRevealType.CenterIfOutsideViewport, false);
+		}, editorCommon.VerticalRevealType.CenterIfOutsideViewport, false);
 	}
 
-	public revealRange(range: EditorCommon.IRange, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = true): void {
-		this._sendRevealRange(range, revealVerticalInCenter ? EditorCommon.VerticalRevealType.Center : EditorCommon.VerticalRevealType.Simple, revealHorizontal);
+	public revealRange(range: editorCommon.IRange, revealVerticalInCenter:boolean = false, revealHorizontal:boolean = true): void {
+		this._sendRevealRange(range, revealVerticalInCenter ? editorCommon.VerticalRevealType.Center : editorCommon.VerticalRevealType.Simple, revealHorizontal);
 	}
 
-	public revealRangeInCenter(range: EditorCommon.IRange): void {
-		this._sendRevealRange(range, EditorCommon.VerticalRevealType.Center, true);
+	public revealRangeInCenter(range: editorCommon.IRange): void {
+		this._sendRevealRange(range, editorCommon.VerticalRevealType.Center, true);
 	}
 
-	public revealRangeInCenterIfOutsideViewport(range: EditorCommon.IRange): void {
-		this._sendRevealRange(range, EditorCommon.VerticalRevealType.CenterIfOutsideViewport, true);
+	public revealRangeInCenterIfOutsideViewport(range: editorCommon.IRange): void {
+		this._sendRevealRange(range, editorCommon.VerticalRevealType.CenterIfOutsideViewport, true);
 	}
 
-	public setSelections(ranges: EditorCommon.ISelection[]): void {
+	public setSelections(ranges: editorCommon.ISelection[]): void {
 		if (!this.cursor) {
 			return;
 		}
@@ -512,17 +516,17 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 
 	public abstract getScrollHeight(): number;
 
-	public abstract saveViewState(): EditorCommon.ICodeEditorViewState;
+	public abstract saveViewState(): editorCommon.ICodeEditorViewState;
 
-	public abstract restoreViewState(state:EditorCommon.IEditorViewState): void;
+	public abstract restoreViewState(state:editorCommon.IEditorViewState): void;
 
 	public onVisible(): void {
 	}
 
 	public onHide(): void {
 	}
 
-	public abstract layout(dimension?:EditorCommon.IDimension): void;
+	public abstract layout(dimension?:editorCommon.IDimension): void;
 
 	public abstract focus(): void;
 
@@ -536,11 +540,11 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 
 	public abstract isFocused(): boolean;
 
-	public getContribution(id: string): EditorCommon.IEditorContribution {
+	public getContribution(id: string): editorCommon.IEditorContribution {
 		return this.contributions[id] || null;
 	}
 
-	public addAction(descriptor:EditorCommon.IActionDescriptor): void {
+	public addAction(descriptor:editorCommon.IActionDescriptor): void {
 		var action = this._instantiationService.createInstance(DynamicEditorAction, descriptor, this);
 		this.contributions[action.getId()] = action;
 	}
@@ -588,12 +592,12 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	public executeCommand(source: string, command: EditorCommon.ICommand): boolean {
+	public executeCommand(source: string, command: editorCommon.ICommand): boolean {
 		// forward to handler dispatcher
-		return this._configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.ExecuteCommand, command);
+		return this._configuration.handlerDispatcher.trigger(source, editorCommon.Handler.ExecuteCommand, command);
 	}
 
-	public executeEdits(source: string, edits: EditorCommon.IIdentifiedSingleEditOperation[]): boolean {
+	public executeEdits(source: string, edits: editorCommon.IIdentifiedSingleEditOperation[]): boolean {
 		if (!this.cursor) {
 			// no view, no cursor
 			return false;
@@ -608,12 +612,12 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		return true;
 	}
 
-	public executeCommands(source: string, commands: EditorCommon.ICommand[]): boolean {
+	public executeCommands(source: string, commands: editorCommon.ICommand[]): boolean {
 		// forward to handler dispatcher
-		return this._configuration.handlerDispatcher.trigger(source, EditorCommon.Handler.ExecuteCommands, commands);
+		return this._configuration.handlerDispatcher.trigger(source, editorCommon.Handler.ExecuteCommands, commands);
 	}
 
-	public changeDecorations(callback:(changeAccessor:EditorCommon.IModelDecorationsChangeAccessor)=>any): any {
+	public changeDecorations(callback:(changeAccessor:editorCommon.IModelDecorationsChangeAccessor)=>any): any {
 		if (!this.model) {
 //			console.warn('Cannot change decorations on editor that is not attached to a model');
 			// callback will not be called
@@ -622,14 +626,14 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		return this.model.changeDecorations(callback, this.id);
 	}
 
-	public getLineDecorations(lineNumber: number): EditorCommon.IModelDecoration[] {
+	public getLineDecorations(lineNumber: number): editorCommon.IModelDecoration[] {
 		if (!this.model) {
 			return null;
 		}
 		return this.model.getLineDecorations(lineNumber, this.id, this._configuration.editor.readOnly);
 	}
 
-	public deltaDecorations(oldDecorations:string[], newDecorations:EditorCommon.IModelDeltaDecoration[]): string[] {
+	public deltaDecorations(oldDecorations:string[], newDecorations:editorCommon.IModelDeltaDecoration[]): string[] {
 		if (!this.model) {
 			return [];
 		}
@@ -641,14 +645,14 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		return this.model.deltaDecorations(oldDecorations, newDecorations, this.id);
 	}
 
-	public setDecorations(decorationTypeKey: string, ranges:EditorCommon.IRangeWithMessage[]): void {
+	public setDecorations(decorationTypeKey: string, ranges:editorCommon.IRangeWithMessage[]): void {
 		var opts = this._codeEditorService.resolveDecorationType(decorationTypeKey);
 		var oldDecorationIds = this._decorationTypeKeysToIds[decorationTypeKey] || [];
-		this._decorationTypeKeysToIds[decorationTypeKey] = this.deltaDecorations(oldDecorationIds, ranges.map((r) : EditorCommon.IModelDeltaDecoration => {
-			let decOpts: EditorCommon.IModelDecorationOptions;
+		this._decorationTypeKeysToIds[decorationTypeKey] = this.deltaDecorations(oldDecorationIds, ranges.map((r) : editorCommon.IModelDeltaDecoration => {
+			let decOpts: editorCommon.IModelDecorationOptions;
 			if (r.hoverMessage) {
-				// TODO@Alex: avoid Objects.clone
-				decOpts = Objects.clone(opts);
+				// TODO@Alex: avoid objects.clone
+				decOpts = objects.clone(opts);
 				decOpts.htmlMessage = r.hoverMessage;
 			} else {
 				decOpts = opts;
@@ -667,7 +671,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		}
 	}
 
-	public addTypingListener(character:string, callback: () => void): EventEmitter.ListenerUnbind {
+	public addTypingListener(character:string, callback: () => void): ListenerUnbind {
 		if (!this.cursor) {
 			return () => {
 				// no-op
@@ -681,11 +685,11 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 		};
 	}
 
-	public getLayoutInfo(): EditorCommon.IEditorLayoutInfo {
+	public getLayoutInfo(): editorCommon.IEditorLayoutInfo {
 		return this._configuration.editor.layoutInfo;
 	}
 
-	_attachModel(model:EditorCommon.IModel): void {
+	_attachModel(model:editorCommon.IModel): void {
 		this.model = model ? model : null;
 		this.listenersToRemove = [];
 		this.viewModel = null;
@@ -712,7 +716,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 				this._configuration.getIndentationOptions().tabSize,
 				this._configuration.editor.wrappingInfo.wrappingColumn,
 				this._configuration.editor.typicalFullwidthCharacterWidth / this._configuration.editor.typicalHalfwidthCharacterWidth,
-				EditorCommon.wrappingIndentFromString(this._configuration.editor.wrappingIndent)
+				editorCommon.wrappingIndentFromString(this._configuration.editor.wrappingIndent)
 			);
 
 			this.viewModel = new ViewModel(
@@ -728,16 +732,16 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 				convertModelPositionToViewPosition: (lineNumber:number, column:number) => {
 					return this.viewModel.convertModelPositionToViewPosition(lineNumber, column);
 				},
-				convertModelRangeToViewRange: (modelRange:EditorCommon.IEditorRange) => {
+				convertModelRangeToViewRange: (modelRange:editorCommon.IEditorRange) => {
 					return this.viewModel.convertModelRangeToViewRange(modelRange);
 				},
 				convertViewToModelPosition: (lineNumber:number, column:number) => {
 					return this.viewModel.convertViewPositionToModelPosition(lineNumber, column);
 				},
-				validateViewPosition: (viewLineNumber:number, viewColumn:number, modelPosition:EditorCommon.IEditorPosition) => {
+				validateViewPosition: (viewLineNumber:number, viewColumn:number, modelPosition:editorCommon.IEditorPosition) => {
 					return this.viewModel.validateViewPosition(viewLineNumber, viewColumn, modelPosition);
 				},
-				validateViewRange: (viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:EditorCommon.IEditorRange) => {
+				validateViewRange: (viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:editorCommon.IEditorRange) => {
 					return this.viewModel.validateViewRange(viewStartLineNumber, viewStartColumn, viewEndLineNumber, viewEndColumn, modelRange);
 				}
 			};
@@ -760,10 +764,10 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 					var e = events[i].getData();
 
 					switch (eventType) {
-						case EditorCommon.EventType.ViewFocusGained:
-							this.emit(EditorCommon.EventType.EditorTextFocus);
+						case editorCommon.EventType.ViewFocusGained:
+							this.emit(editorCommon.EventType.EditorTextFocus);
 							// In IE, the focus is not synchronous, so we give it a little help
-							this.emit(EditorCommon.EventType.EditorFocus, {});
+							this.emit(editorCommon.EventType.EditorFocus, {});
 							break;
 
 						case 'scroll':
@@ -774,40 +778,40 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 							this.emit('scrollSize', e);
 							break;
 
-						case EditorCommon.EventType.ViewFocusLost:
-							this.emit(EditorCommon.EventType.EditorTextBlur);
+						case editorCommon.EventType.ViewFocusLost:
+							this.emit(editorCommon.EventType.EditorTextBlur);
 							break;
 
-						case EditorCommon.EventType.ContextMenu:
-							this.emit(EditorCommon.EventType.ContextMenu, e);
+						case editorCommon.EventType.ContextMenu:
+							this.emit(editorCommon.EventType.ContextMenu, e);
 							break;
 
-						case EditorCommon.EventType.MouseDown:
-							this.emit(EditorCommon.EventType.MouseDown, e);
+						case editorCommon.EventType.MouseDown:
+							this.emit(editorCommon.EventType.MouseDown, e);
 							break;
 
-						case EditorCommon.EventType.MouseUp:
-							this.emit(EditorCommon.EventType.MouseUp, e);
+						case editorCommon.EventType.MouseUp:
+							this.emit(editorCommon.EventType.MouseUp, e);
 							break;
 
-						case EditorCommon.EventType.KeyUp:
-							this.emit(EditorCommon.EventType.KeyUp, e);
+						case editorCommon.EventType.KeyUp:
+							this.emit(editorCommon.EventType.KeyUp, e);
 							break;
 
-						case EditorCommon.EventType.MouseMove:
-							this.emit(EditorCommon.EventType.MouseMove, e);
+						case editorCommon.EventType.MouseMove:
+							this.emit(editorCommon.EventType.MouseMove, e);
 							break;
 
-						case EditorCommon.EventType.MouseLeave:
-							this.emit(EditorCommon.EventType.MouseLeave, e);
+						case editorCommon.EventType.MouseLeave:
+							this.emit(editorCommon.EventType.MouseLeave, e);
 							break;
 
-						case EditorCommon.EventType.KeyDown:
-							this.emit(EditorCommon.EventType.KeyDown, e);
+						case editorCommon.EventType.KeyDown:
+							this.emit(editorCommon.EventType.KeyDown, e);
 							break;
 
-						case EditorCommon.EventType.ViewLayoutChanged:
-							this.emit(EditorCommon.EventType.EditorLayout, e);
+						case editorCommon.EventType.ViewLayoutChanged:
+							this.emit(editorCommon.EventType.EditorLayout, e);
 							break;
 
 						default:
@@ -822,27 +826,27 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 					var e = events[i].getData();
 
 					switch (eventType) {
-						case EditorCommon.EventType.ModelDecorationsChanged:
-							this.emit(EditorCommon.EventType.ModelDecorationsChanged, e);
+						case editorCommon.EventType.ModelDecorationsChanged:
+							this.emit(editorCommon.EventType.ModelDecorationsChanged, e);
 							break;
 
-						case EditorCommon.EventType.ModelModeChanged:
+						case editorCommon.EventType.ModelModeChanged:
 							this.domElement.setAttribute('data-mode-id', this.model.getMode().getId());
 							this._langIdKey.set(this.model.getMode().getId());
-							this.emit(EditorCommon.EventType.ModelModeChanged, e);
+							this.emit(editorCommon.EventType.ModelModeChanged, e);
 							break;
 
-						case EditorCommon.EventType.ModelModeSupportChanged:
-							this.emit(EditorCommon.EventType.ModelModeSupportChanged, e);
+						case editorCommon.EventType.ModelModeSupportChanged:
+							this.emit(editorCommon.EventType.ModelModeSupportChanged, e);
 							break;
 
-						case EditorCommon.EventType.ModelContentChanged:
+						case editorCommon.EventType.ModelContentChanged:
 							// TODO@Alex
-							this.emit(EditorCommon.EventType.ModelContentChanged, e);
+							this.emit(editorCommon.EventType.ModelContentChanged, e);
 							this.emit('change', {});
 							break;
 
-						case EditorCommon.EventType.ModelDispose:
+						case editorCommon.EventType.ModelDispose:
 							// Someone might destroy the model from under the editor, so prevent any exceptions by setting a null model
 							this.setModel(null);
 							break;
@@ -853,7 +857,7 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 				}
 			}));
 
-			var _hasNonEmptySelection = (e: EditorCommon.ICursorSelectionChangedEvent) => {
+			var _hasNonEmptySelection = (e: editorCommon.ICursorSelectionChangedEvent) => {
 				var allSelections = [e.selection].concat(e.secondarySelections);
 				return allSelections.some(s => !s.isEmpty());
 			};
@@ -869,20 +873,20 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 					var e = events[i].getData();
 
 					switch (eventType) {
-						case EditorCommon.EventType.CursorPositionChanged:
-							var cursorPositionChangedEvent = <EditorCommon.ICursorPositionChangedEvent>e;
+						case editorCommon.EventType.CursorPositionChanged:
+							var cursorPositionChangedEvent = <editorCommon.ICursorPositionChangedEvent>e;
 							updateHasMultipleCursors = true;
 							hasMultipleCursors = (cursorPositionChangedEvent.secondaryPositions.length > 0);
-							this.emit(EditorCommon.EventType.CursorPositionChanged, e);
+							this.emit(editorCommon.EventType.CursorPositionChanged, e);
 							break;
 
-						case EditorCommon.EventType.CursorSelectionChanged:
-							var cursorSelectionChangedEvent = <EditorCommon.ICursorSelectionChangedEvent>e;
+						case editorCommon.EventType.CursorSelectionChanged:
+							var cursorSelectionChangedEvent = <editorCommon.ICursorSelectionChangedEvent>e;
 							updateHasMultipleCursors = true;
 							hasMultipleCursors = (cursorSelectionChangedEvent.secondarySelections.length > 0);
 							updateHasNonEmptySelection = true;
 							hasNonEmptySelection = _hasNonEmptySelection(cursorSelectionChangedEvent);
-							this.emit(EditorCommon.EventType.CursorSelectionChanged, e);
+							this.emit(editorCommon.EventType.CursorSelectionChanged, e);
 							break;
 
 						default:
@@ -914,16 +918,16 @@ export abstract class CommonCodeEditor extends EventEmitter.EventEmitter impleme
 
 	protected abstract _createView(): void;
 
-	protected abstract _getViewInternalEventBus(): EventEmitter.IEventEmitter;
+	protected abstract _getViewInternalEventBus(): IEventEmitter;
 
-	_postDetachModelCleanup(detachedModel:EditorCommon.IModel): void {
+	_postDetachModelCleanup(detachedModel:editorCommon.IModel): void {
 		if (detachedModel) {
 			this._decorationTypeKeysToIds = {};
 			detachedModel.removeAllDecorationsWithOwnerId(this.id);
 		}
 	}
 
-	protected _detachModel(): EditorCommon.IModel {
+	protected _detachModel(): editorCommon.IModel {
 		if (this.model) {
 			this.model.onBeforeDetached();
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/config/commonEditorConfig.ts
code:
@@ -5,16 +5,16 @@
 'use strict';
 
 import * as nls from 'vs/nls';
-import * as Objects from 'vs/base/common/objects';
 import Event, {Emitter} from 'vs/base/common/event';
-import * as Strings from 'vs/base/common/strings';
+import {Disposable} from 'vs/base/common/lifecycle';
+import * as objects from 'vs/base/common/objects';
+import * as strings from 'vs/base/common/strings';
+import {Extensions, IConfigurationRegistry} from 'vs/platform/configuration/common/configurationRegistry';
 import {Registry} from 'vs/platform/platform';
-import ConfigurationRegistry = require('vs/platform/configuration/common/configurationRegistry');
-import * as EditorCommon from 'vs/editor/common/editorCommon';
 import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
 import {HandlerDispatcher} from 'vs/editor/common/controller/handlerDispatcher';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {EditorLayoutProvider} from 'vs/editor/common/viewLayout/editorLayoutProvider';
-import {Disposable} from 'vs/base/common/lifecycle';
 
 /**
  * Experimental screen reader support toggle
@@ -40,32 +40,33 @@ export class GlobalScreenReaderNVDA {
 
 export class ConfigurationWithDefaults {
 
-	private _editor:EditorCommon.IEditorOptions;
+	private _editor:editorCommon.IEditorOptions;
 
-	constructor(options:EditorCommon.IEditorOptions) {
-		this._editor = <EditorCommon.IEditorOptions>Objects.clone(DefaultConfig.editor);
+	constructor(options:editorCommon.IEditorOptions) {
+		this._editor = <editorCommon.IEditorOptions>objects.clone(DefaultConfig.editor);
 
 		this._mergeOptionsIn(options);
 	}
 
-	public getEditorOptions(): EditorCommon.IEditorOptions {
+	public getEditorOptions(): editorCommon.IEditorOptions {
 		return this._editor;
 	}
 
-	private _mergeOptionsIn(newOptions:EditorCommon.IEditorOptions): void {
-		this._editor = Objects.mixin(this._editor, newOptions || {});
+	private _mergeOptionsIn(newOptions:editorCommon.IEditorOptions): void {
+		this._editor = objects.mixin(this._editor, newOptions || {});
 	}
 
-	public updateOptions(newOptions:EditorCommon.IEditorOptions): void {
+	public updateOptions(newOptions:editorCommon.IEditorOptions): void {
 		// Apply new options
 		this._mergeOptionsIn(newOptions);
 	}
 }
 
-function cloneInternalEditorOptions(opts: EditorCommon.IInternalEditorOptions): EditorCommon.IInternalEditorOptions {
+function cloneInternalEditorOptions(opts: editorCommon.IInternalEditorOptions): editorCommon.IInternalEditorOptions {
 	return {
 		experimentalScreenReader: opts.experimentalScreenReader,
 		rulers: opts.rulers.slice(0),
+		wordSeparators: opts.wordSeparators,
 		ariaLabel: opts.ariaLabel,
 		lineNumbers: opts.lineNumbers,
 		selectOnLineNumbers: opts.selectOnLineNumbers,
@@ -172,7 +173,7 @@ class InternalEditorOptionsHelper {
 	public static createInternalEditorOptions(
 		outerWidth:number,
 		outerHeight:number,
-		opts:EditorCommon.IEditorOptions,
+		opts:editorCommon.IEditorOptions,
 		editorClassName:string,
 		requestedFontFamily:string,
 		requestedFontSize:number,
@@ -181,8 +182,8 @@ class InternalEditorOptionsHelper {
 		themeOpts: ICSSConfig,
 		isDominatedByLongLines:boolean,
 		lineCount: number,
-		indentationOptions: EditorCommon.IInternalIndentationOptions
-	): EditorCommon.IInternalEditorOptions {
+		indentationOptions: editorCommon.IInternalIndentationOptions
+	): editorCommon.IInternalEditorOptions {
 
 		let wrappingColumn = toInteger(opts.wrappingColumn, -1);
 
@@ -237,7 +238,7 @@ class InternalEditorOptionsHelper {
 			wrappingColumn = 0;
 		}
 
-		let wrappingInfo: EditorCommon.IEditorWrappingInfo;
+		let wrappingInfo: editorCommon.IEditorWrappingInfo;
 
 		if (wrappingColumn === 0) {
 			// If viewport width wrapping is enabled
@@ -279,6 +280,7 @@ class InternalEditorOptionsHelper {
 			cursorBlinking: opts.cursorBlinking,
 			experimentalScreenReader: toBoolean(opts.experimentalScreenReader),
 			rulers: toSortedIntegerArray(opts.rulers),
+			wordSeparators: String(opts.wordSeparators),
 			ariaLabel: String(opts.ariaLabel),
 			cursorStyle: opts.cursorStyle,
 			fontLigatures: toBoolean(opts.fontLigatures),
@@ -332,7 +334,7 @@ class InternalEditorOptionsHelper {
 		};
 	}
 
-	private static _sanitizeScrollbarOpts(raw:EditorCommon.IEditorScrollbarOptions, mouseWheelScrollSensitivity:number): EditorCommon.IInternalEditorScrollbarOptions {
+	private static _sanitizeScrollbarOpts(raw:editorCommon.IEditorScrollbarOptions, mouseWheelScrollSensitivity:number): editorCommon.IInternalEditorScrollbarOptions {
 		let horizontalScrollbarSize = toIntegerWithDefault(raw.horizontalScrollbarSize, 10);
 		let verticalScrollbarSize = toIntegerWithDefault(raw.verticalScrollbarSize, 14);
 		return {
@@ -356,10 +358,11 @@ class InternalEditorOptionsHelper {
 		};
 	}
 
-	public static createConfigurationChangedEvent(prevOpts:EditorCommon.IInternalEditorOptions, newOpts:EditorCommon.IInternalEditorOptions): EditorCommon.IConfigurationChangedEvent {
+	public static createConfigurationChangedEvent(prevOpts:editorCommon.IInternalEditorOptions, newOpts:editorCommon.IInternalEditorOptions): editorCommon.IConfigurationChangedEvent {
 		return {
 			experimentalScreenReader:		(prevOpts.experimentalScreenReader !== newOpts.experimentalScreenReader),
 			rulers:							(!this._numberArraysEqual(prevOpts.rulers, newOpts.rulers)),
+			wordSeparators:					(prevOpts.wordSeparators !== newOpts.wordSeparators),
 			ariaLabel:						(prevOpts.ariaLabel !== newOpts.ariaLabel),
 
 			lineNumbers:					(prevOpts.lineNumbers !== newOpts.lineNumbers),
@@ -414,7 +417,7 @@ class InternalEditorOptionsHelper {
 		};
 	}
 
-	private static _scrollbarOptsEqual(a:EditorCommon.IInternalEditorScrollbarOptions, b:EditorCommon.IInternalEditorScrollbarOptions): boolean {
+	private static _scrollbarOptsEqual(a:editorCommon.IInternalEditorScrollbarOptions, b:editorCommon.IInternalEditorScrollbarOptions): boolean {
 		return (
 			a.arrowSize === b.arrowSize
 			&& a.vertical === b.vertical
@@ -431,7 +434,7 @@ class InternalEditorOptionsHelper {
 		);
 	}
 
-	private static _stylingInfoEqual(a:EditorCommon.IEditorStyling, b:EditorCommon.IEditorStyling): boolean {
+	private static _stylingInfoEqual(a:editorCommon.IEditorStyling, b:editorCommon.IEditorStyling): boolean {
 		return (
 			a.editorClassName === b.editorClassName
 			&& a.fontFamily === b.fontFamily
@@ -440,14 +443,14 @@ class InternalEditorOptionsHelper {
 		);
 	}
 
-	private static _wrappingInfoEqual(a:EditorCommon.IEditorWrappingInfo, b:EditorCommon.IEditorWrappingInfo): boolean {
+	private static _wrappingInfoEqual(a:editorCommon.IEditorWrappingInfo, b:editorCommon.IEditorWrappingInfo): boolean {
 		return (
 			a.isViewportWrapping === b.isViewportWrapping
 			&& a.wrappingColumn === b.wrappingColumn
 		);
 	}
 
-	private static _indentInfoEqual(a:EditorCommon.IInternalIndentationOptions, b:EditorCommon.IInternalIndentationOptions): boolean {
+	private static _indentInfoEqual(a:editorCommon.IInternalIndentationOptions, b:editorCommon.IInternalIndentationOptions): boolean {
 		return (
 			a.insertSpaces === b.insertSpaces
 			&& a.tabSize === b.tabSize
@@ -544,24 +547,24 @@ interface IValidatedIndentationOptions {
 }
 
 export interface IIndentationGuesser {
-	(tabSize:number): EditorCommon.IGuessedIndentation;
+	(tabSize:number): editorCommon.IGuessedIndentation;
 }
 
-export abstract class CommonEditorConfiguration extends Disposable implements EditorCommon.IConfiguration {
+export abstract class CommonEditorConfiguration extends Disposable implements editorCommon.IConfiguration {
 
-	public handlerDispatcher:EditorCommon.IHandlerDispatcher;
-	public editor:EditorCommon.IInternalEditorOptions;
-	public editorClone:EditorCommon.IInternalEditorOptions;
+	public handlerDispatcher:editorCommon.IHandlerDispatcher;
+	public editor:editorCommon.IInternalEditorOptions;
+	public editorClone:editorCommon.IInternalEditorOptions;
 
 	protected _configWithDefaults:ConfigurationWithDefaults;
 	private _indentationGuesser:IIndentationGuesser;
 	private _cachedGuessedIndentationTabSize: number;
-	private _cachedGuessedIndentation:EditorCommon.IGuessedIndentation;
+	private _cachedGuessedIndentation:editorCommon.IGuessedIndentation;
 	private _isDominatedByLongLines:boolean;
 	private _lineCount:number;
 
-	private _onDidChange = this._register(new Emitter<EditorCommon.IConfigurationChangedEvent>());
-	public onDidChange: Event<EditorCommon.IConfigurationChangedEvent> = this._onDidChange.event;
+	private _onDidChange = this._register(new Emitter<editorCommon.IConfigurationChangedEvent>());
+	public onDidChange: Event<editorCommon.IConfigurationChangedEvent> = this._onDidChange.event;
 
 	constructor(options:any, indentationGuesser:IIndentationGuesser = null) {
 		super();
@@ -604,11 +607,11 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		}
 	}
 
-	public getRawOptions(): EditorCommon.IEditorOptions {
+	public getRawOptions(): editorCommon.IEditorOptions {
 		return this._configWithDefaults.getEditorOptions();
 	}
 
-	private _computeInternalOptions(): EditorCommon.IInternalEditorOptions {
+	private _computeInternalOptions(): editorCommon.IInternalEditorOptions {
 		let opts = this._configWithDefaults.getEditorOptions();
 
 		let editorClassName = this._getEditorClassName(opts.theme, toBoolean(opts.fontLigatures));
@@ -639,7 +642,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		);
 	}
 
-	public updateOptions(newOptions:EditorCommon.IEditorOptions): void {
+	public updateOptions(newOptions:editorCommon.IEditorOptions): void {
 		this._configWithDefaults.updateOptions(newOptions);
 		this._recomputeOptions();
 	}
@@ -660,7 +663,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		this._recomputeOptions();
 	}
 
-	private _guessIndentationOptionsCached(tabSize:number): EditorCommon.IGuessedIndentation {
+	private _guessIndentationOptionsCached(tabSize:number): editorCommon.IGuessedIndentation {
 		if (!this._cachedGuessedIndentation || this._cachedGuessedIndentationTabSize !== tabSize) {
 			this._cachedGuessedIndentationTabSize = tabSize;
 
@@ -673,7 +676,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		return this._cachedGuessedIndentation;
 	}
 
-	private static _getValidatedIndentationOptions(opts: EditorCommon.IEditorOptions): IValidatedIndentationOptions {
+	private static _getValidatedIndentationOptions(opts: editorCommon.IEditorOptions): IValidatedIndentationOptions {
 		let r: IValidatedIndentationOptions = {
 			tabSizeIsAuto: false,
 			tabSize: 4,
@@ -696,16 +699,16 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		return r;
 	}
 
-	private static _computeIndentationOptions(allOpts: EditorCommon.IEditorOptions, indentationGuesser:IIndentationGuesser): EditorCommon.IInternalIndentationOptions {
+	private static _computeIndentationOptions(allOpts: editorCommon.IEditorOptions, indentationGuesser:IIndentationGuesser): editorCommon.IInternalIndentationOptions {
 		let opts = this._getValidatedIndentationOptions(allOpts);
 
-		let guessedIndentation:EditorCommon.IGuessedIndentation = null;
+		let guessedIndentation:editorCommon.IGuessedIndentation = null;
 		if (opts.tabSizeIsAuto || opts.insertSpacesIsAuto) {
 			// We must use the indentation guesser to come up with the indentation options
 			guessedIndentation = indentationGuesser(opts.tabSize);
 		}
 
-		let r: EditorCommon.IInternalIndentationOptions = {
+		let r: editorCommon.IInternalIndentationOptions = {
 			insertSpaces: opts.insertSpaces,
 			tabSize: opts.tabSize
 		};
@@ -720,10 +723,14 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 		return r;
 	}
 
-	public getIndentationOptions(): EditorCommon.IInternalIndentationOptions {
+	public getIndentationOptions(): editorCommon.IInternalIndentationOptions {
 		return this.editor.indentInfo;
 	}
 
+	public setIndentationOptions(indentationOptions: editorCommon.IInternalIndentationOptions): void {
+		this.editor.indentInfo = indentationOptions;
+	}
+
 	private _normalizeIndentationFromWhitespace(str:string): string {
 		let indentation = this.getIndentationOptions(),
 			spacesCnt = 0,
@@ -754,7 +761,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements Ed
 	}
 
 	public normalizeIndentation(str:string): string {
-		let firstNonWhitespaceIndex = Strings.firstNonWhitespaceIndex(str);
+		let firstNonWhitespaceIndex = strings.firstNonWhitespaceIndex(str);
 		if (firstNonWhitespaceIndex === -1) {
 			firstNonWhitespaceIndex = str.length;
 		}
@@ -793,14 +800,14 @@ export class EditorConfiguration {
 	/**
 	 * Ask the provided configuration service to apply its configuration to the provided editor.
 	 */
-	public static apply(config:any, editor?:EditorCommon.IEditor): void;
-	public static apply(config:any, editor?:EditorCommon.IEditor[]): void;
+	public static apply(config:any, editor?:editorCommon.IEditor): void;
+	public static apply(config:any, editor?:editorCommon.IEditor[]): void;
 	public static apply(config:any, editorOrArray?:any): void {
 		if (!config) {
 			return;
 		}
 
-		let editors:EditorCommon.IEditor[] = editorOrArray;
+		let editors:editorCommon.IEditor[] = editorOrArray;
 		if (!Array.isArray(editorOrArray)) {
 			editors = [editorOrArray];
 		}
@@ -811,18 +818,18 @@ export class EditorConfiguration {
 			// Editor Settings (Code Editor, Diff, Terminal)
 			if (editor && typeof editor.updateOptions === 'function') {
 				let type = editor.getEditorType();
-				if (type !== EditorCommon.EditorType.ICodeEditor && type !== EditorCommon.EditorType.IDiffEditor) {
+				if (type !== editorCommon.EditorType.ICodeEditor && type !== editorCommon.EditorType.IDiffEditor) {
 					continue;
 				}
 
 				let editorConfig = config[EditorConfiguration.EDITOR_SECTION];
-				if (type === EditorCommon.EditorType.IDiffEditor) {
+				if (type === editorCommon.EditorType.IDiffEditor) {
 					let diffEditorConfig = config[EditorConfiguration.DIFF_EDITOR_SECTION];
 					if (diffEditorConfig) {
 						if (!editorConfig) {
 							editorConfig = diffEditorConfig;
 						} else {
-							editorConfig = Objects.mixin(editorConfig, diffEditorConfig);
+							editorConfig = objects.mixin(editorConfig, diffEditorConfig);
 						}
 					}
 				}
@@ -836,7 +843,7 @@ export class EditorConfiguration {
 	}
 }
 
-let configurationRegistry = <ConfigurationRegistry.IConfigurationRegistry>Registry.as(ConfigurationRegistry.Extensions.Configuration);
+let configurationRegistry = <IConfigurationRegistry>Registry.as(Extensions.Configuration);
 configurationRegistry.registerConfiguration({
 	'id': 'editor',
 	'order': 5,
@@ -876,6 +883,11 @@ configurationRegistry.registerConfiguration({
 			'default': DefaultConfig.editor.rulers,
 			'description': nls.localize('rulers', "Columns at which to show vertical rulers")
 		},
+		'editor.wordSeparators' : {
+			'type': 'string',
+			'default': DefaultConfig.editor.wordSeparators,
+			'description': nls.localize('wordSeparators', "Characters that will be used as word separators when doing word related navigations or operations")
+		},
 		'editor.tabSize' : {
 			'oneOf': [
 				{

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/config/config.ts
code:
@@ -4,15 +4,15 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {KeybindingsRegistry,ICommandDescriptor} from 'vs/platform/keybinding/common/keybindingsRegistry';
-import {KbExpr, IKeybindings} from 'vs/platform/keybinding/common/keybindingService';
-import {ServicesAccessor} from 'vs/platform/instantiation/common/instantiation';
+import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
 import {IEditorService} from 'vs/platform/editor/common/editor';
+import {ServicesAccessor} from 'vs/platform/instantiation/common/instantiation';
+import {IKeybindings, KbExpr} from 'vs/platform/keybinding/common/keybindingService';
+import {ICommandDescriptor, KeybindingsRegistry} from 'vs/platform/keybinding/common/keybindingsRegistry';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ICodeEditorService} from 'vs/editor/common/services/codeEditorService';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {KeyMod, KeyCode} from 'vs/base/common/keyCodes';
 
-export function findFocusedEditor(commandId: string, accessor: ServicesAccessor, args: any, complain: boolean): EditorCommon.ICommonCodeEditor {
+export function findFocusedEditor(commandId: string, accessor: ServicesAccessor, args: any, complain: boolean): editorCommon.ICommonCodeEditor {
 	var codeEditorService = accessor.get(ICodeEditorService);
 	var editorId = args.context.editorId;
 	if (!editorId) {
@@ -31,22 +31,22 @@ export function findFocusedEditor(commandId: string, accessor: ServicesAccessor,
 	return editor;
 }
 
-export function withCodeEditorFromCommandHandler(commandId: string, accessor: ServicesAccessor, args: any, callback: (editor:EditorCommon.ICommonCodeEditor) => void): void {
+export function withCodeEditorFromCommandHandler(commandId: string, accessor: ServicesAccessor, args: any, callback: (editor:editorCommon.ICommonCodeEditor) => void): void {
 	var editor = findFocusedEditor(commandId, accessor, args, true);
 	if (editor) {
 		callback(editor);
 	}
 }
 
-export function getActiveEditor(accessor: ServicesAccessor): EditorCommon.ICommonCodeEditor {
+export function getActiveEditor(accessor: ServicesAccessor): editorCommon.ICommonCodeEditor {
 	var editorService = accessor.get(IEditorService);
 	var activeEditor = (<any>editorService).getActiveEditor && (<any>editorService).getActiveEditor();
 	if (activeEditor) {
-		var editor = <EditorCommon.IEditor>activeEditor.getControl();
+		var editor = <editorCommon.IEditor>activeEditor.getControl();
 
 		// Substitute for (editor instanceof ICodeEditor)
 		if (editor && typeof editor.getEditorType === 'function') {
-			var codeEditor = <EditorCommon.ICommonCodeEditor>editor;
+			var codeEditor = <editorCommon.ICommonCodeEditor>editor;
 			return codeEditor;
 		}
 	}
@@ -65,7 +65,7 @@ function registerCoreCommand(handlerId: string, kb: IKeybindings, weight: number
 		id: handlerId,
 		handler: triggerEditorHandler.bind(null, handlerId),
 		weight: weight,
-		context: (context ? context : KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS)),
+		context: (context ? context : KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS)),
 		primary: kb.primary,
 		secondary: kb.secondary,
 		win: kb.win,
@@ -93,7 +93,7 @@ function getWordNavigationKB(shift:boolean, key:KeyCode): number {
 	}
 }
 
-var H = EditorCommon.Handler;
+var H = editorCommon.Handler;
 
 // https://support.apple.com/en-gb/HT201236
 // [ADDED] Control-H					Delete the character to the left of the insertion point. Or use Delete.
@@ -123,7 +123,7 @@ var H = EditorCommon.Handler;
 // [ADDED] Control-O					Insert a new line after the insertion point.
 //Control-T								Swap the character behind the insertion point with the character in front of the insertion point.
 // Unconfirmed????
-//	Config.addKeyBinding(EditorCommon.Handler.CursorPageDown,		KeyMod.WinCtrl | KeyCode.KEY_V);
+//	Config.addKeyBinding(editorCommon.Handler.CursorPageDown,		KeyMod.WinCtrl | KeyCode.KEY_V);
 
 // OS X built in commands
 // Control+y => yank
@@ -220,14 +220,14 @@ registerCoreCommand(H.ScrollPageDown, {
 registerCoreCommand(H.Tab, {
 	primary: KeyCode.Tab
 }, KeybindingsRegistry.WEIGHT.editorCore(), KbExpr.and(
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
-	KbExpr.not(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS)
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
+	KbExpr.not(editorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS)
 ));
 registerCoreCommand(H.Outdent, {
 	primary: KeyMod.Shift | KeyCode.Tab
 }, KeybindingsRegistry.WEIGHT.editorCore(), KbExpr.and(
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
-	KbExpr.not(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS)
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
+	KbExpr.not(editorCommon.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS)
 ));
 
 registerCoreCommand(H.DeleteLeft, {
@@ -264,14 +264,14 @@ registerWordCommand(H.DeleteWordRight, false, KeyCode.Delete);
 registerCoreCommand(H.CancelSelection, {
 	primary: KeyCode.Escape
 }, KeybindingsRegistry.WEIGHT.editorCore(), KbExpr.and(
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION)
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION)
 ));
 registerCoreCommand(H.RemoveSecondaryCursors, {
 	primary: KeyCode.Escape
 }, KeybindingsRegistry.WEIGHT.editorCore(1), KbExpr.and(
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
-	KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS)
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS),
+	KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS)
 ));
 
 registerCoreCommand(H.CursorTop, {
@@ -310,10 +310,10 @@ registerCoreCommand(H.Redo, {
 
 
 function selectAll(accessor: ServicesAccessor, args: any): void {
-	var HANDLER = EditorCommon.Handler.SelectAll;
+	var HANDLER = editorCommon.Handler.SelectAll;
 
 	// If editor text focus
-	if (args.context[EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS]) {
+	if (args.context[editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS]) {
 		var focusedEditor = findFocusedEditor(HANDLER, accessor, args, false);
 		if (focusedEditor) {
 			focusedEditor.trigger('keyboard', HANDLER, args);

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/config/defaultConfig.ts
code:
@@ -5,20 +5,23 @@
 'use strict';
 
 import * as nls from 'vs/nls';
-import * as EditorCommon from 'vs/editor/common/editorCommon';
+import {IEditorOptions} from 'vs/editor/common/editorCommon';
 
 export interface IConfiguration {
-	editor:EditorCommon.IEditorOptions;
+	editor:IEditorOptions;
 }
 
+export const USUAL_WORD_SEPARATORS = '`~!@#$%^&*()-=+[{]}\\|;:\'",.<>/?';
+
 class ConfigClass implements IConfiguration {
 
-	public editor: EditorCommon.IEditorOptions;
+	public editor: IEditorOptions;
 
 	constructor() {
 		this.editor = {
 			experimentalScreenReader: false,
 			rulers: [],
+			wordSeparators: USUAL_WORD_SEPARATORS,
 			ariaLabel: nls.localize('editorViewAccessibleLabel', "Editor content"),
 			lineNumbers: true,
 			selectOnLineNumbers: true,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/cursor.ts
code:
@@ -4,18 +4,18 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import nls = require('vs/nls');
+import * as nls from 'vs/nls';
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {EventEmitter} from 'vs/base/common/eventEmitter';
-import {Range} from 'vs/editor/common/core/range';
-import {Selection} from 'vs/editor/common/core/selection';
-import {Position} from 'vs/editor/common/core/position';
+import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
 import {ReplaceCommand} from 'vs/editor/common/commands/replaceCommand';
-import {OneCursor, OneCursorOp, IViewModelHelper, IOneCursorOperationContext, IPostOperationRunnable} from 'vs/editor/common/controller/oneCursor';
-import {DispatcherEvent} from 'vs/editor/common/controller/handlerDispatcher';
 import {CursorCollection, ICursorCollectionState} from 'vs/editor/common/controller/cursorCollection';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
-import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import {DispatcherEvent} from 'vs/editor/common/controller/handlerDispatcher';
+import {IOneCursorOperationContext, IPostOperationRunnable, IViewModelHelper, OneCursor, OneCursorOp} from 'vs/editor/common/controller/oneCursor';
+import {Position} from 'vs/editor/common/core/position';
+import {Range} from 'vs/editor/common/core/range';
+import {Selection} from 'vs/editor/common/core/selection';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 
 export interface ITypingListener {
 	(): void;
@@ -39,7 +39,7 @@ interface IMultipleCursorOperationContext {
 	eventData: any;
 	hasExecutedCommands: boolean;
 	isCursorUndo: boolean;
-	executeCommands: EditorCommon.ICommand[];
+	executeCommands: editorCommon.ICommand[];
 	postOperationRunnables: IPostOperationRunnable[];
 	requestScrollDeltaLines: number;
 }
@@ -50,21 +50,21 @@ interface IExecContext {
 }
 
 interface ICommandData {
-	operations: EditorCommon.IIdentifiedSingleEditOperation[];
+	operations: editorCommon.IIdentifiedSingleEditOperation[];
 	hadTrackedRange: boolean;
 }
 
 interface ICommandsData {
-	operations: EditorCommon.IIdentifiedSingleEditOperation[];
+	operations: editorCommon.IIdentifiedSingleEditOperation[];
 	hadTrackedRanges: boolean[];
 	anyoneHadTrackedRange: boolean;
 }
 
 export class Cursor extends EventEmitter {
 
 	private editorId:number;
-	/* protected */public configuration:EditorCommon.IConfiguration;
-	private model:EditorCommon.IModel;
+	/* protected */public configuration:editorCommon.IConfiguration;
+	private model:editorCommon.IModel;
 
 	private modelUnbinds:IDisposable[];
 
@@ -82,12 +82,12 @@ export class Cursor extends EventEmitter {
 
 	private enableEmptySelectionClipboard:boolean;
 
-	constructor(editorId:number, configuration:EditorCommon.IConfiguration, model:EditorCommon.IModel, viewModelHelper:IViewModelHelper, enableEmptySelectionClipboard:boolean) {
+	constructor(editorId:number, configuration:editorCommon.IConfiguration, model:editorCommon.IModel, viewModelHelper:IViewModelHelper, enableEmptySelectionClipboard:boolean) {
 		super([
-			EditorCommon.EventType.CursorPositionChanged,
-			EditorCommon.EventType.CursorSelectionChanged,
-			EditorCommon.EventType.CursorRevealRange,
-			EditorCommon.EventType.CursorScrollRequest
+			editorCommon.EventType.CursorPositionChanged,
+			editorCommon.EventType.CursorSelectionChanged,
+			editorCommon.EventType.CursorRevealRange,
+			editorCommon.EventType.CursorScrollRequest
 		]);
 		this.editorId = editorId;
 		this.configuration = configuration;
@@ -100,16 +100,16 @@ export class Cursor extends EventEmitter {
 				convertModelPositionToViewPosition: (lineNumber:number, column:number) => {
 					return new Position(lineNumber, column);
 				},
-				convertModelRangeToViewRange: (modelRange: EditorCommon.IEditorRange) => {
+				convertModelRangeToViewRange: (modelRange: editorCommon.IEditorRange) => {
 					return modelRange;
 				},
 				convertViewToModelPosition: (lineNumber:number, column:number) => {
 					return new Position(lineNumber, column);
 				},
-				validateViewPosition: (viewLineNumber:number, viewColumn:number, modelPosition:EditorCommon.IEditorPosition) => {
+				validateViewPosition: (viewLineNumber:number, viewColumn:number, modelPosition:editorCommon.IEditorPosition) => {
 					return modelPosition;
 				},
-				validateViewRange: (viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:EditorCommon.IEditorRange) => {
+				validateViewRange: (viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:editorCommon.IEditorRange) => {
 					return modelRange;
 				}
 
@@ -124,13 +124,13 @@ export class Cursor extends EventEmitter {
 		this._isHandling = false;
 
 		this.modelUnbinds = [];
-		this.modelUnbinds.push(this.model.addListener2(EditorCommon.EventType.ModelContentChanged, (e:EditorCommon.IModelContentChangedEvent) => {
+		this.modelUnbinds.push(this.model.addListener2(editorCommon.EventType.ModelContentChanged, (e:editorCommon.IModelContentChangedEvent) => {
 			this._onModelContentChanged(e);
 		}));
-		this.modelUnbinds.push(this.model.addListener2(EditorCommon.EventType.ModelModeChanged, (e:EditorCommon.IModelModeChangedEvent) => {
+		this.modelUnbinds.push(this.model.addListener2(editorCommon.EventType.ModelModeChanged, (e:editorCommon.IModelModeChangedEvent) => {
 			this._onModelModeChanged();
 		}));
-		this.modelUnbinds.push(this.model.addListener2(EditorCommon.EventType.ModelModeSupportChanged, (e: EditorCommon.IModeSupportChangedEvent) => {
+		this.modelUnbinds.push(this.model.addListener2(editorCommon.EventType.ModelModeSupportChanged, (e: editorCommon.IModeSupportChangedEvent) => {
 			// TODO@Alex: react only if certain supports changed?
 			this._onModelModeChanged();
 		}));
@@ -149,11 +149,11 @@ export class Cursor extends EventEmitter {
 		super.dispose();
 	}
 
-	public saveState(): EditorCommon.ICursorState[] {
+	public saveState(): editorCommon.ICursorState[] {
 
 		var selections = this.cursors.getSelections(),
-			result:EditorCommon.ICursorState[] = [],
-			selection: EditorCommon.IEditorSelection;
+			result:editorCommon.ICursorState[] = [],
+			selection: editorCommon.IEditorSelection;
 
 		for (var i = 0; i < selections.length; i++) {
 			selection = selections[i];
@@ -174,10 +174,10 @@ export class Cursor extends EventEmitter {
 		return result;
 	}
 
-	public restoreState(states:EditorCommon.ICursorState[]): void {
+	public restoreState(states:editorCommon.ICursorState[]): void {
 
-		var desiredSelections:EditorCommon.ISelection[] = [],
-			state:EditorCommon.ICursorState;
+		var desiredSelections:editorCommon.ISelection[] = [],
+			state:editorCommon.ICursorState;
 
 		for (var i = 0; i < states.length; i++) {
 			state = states[i];
@@ -216,11 +216,11 @@ export class Cursor extends EventEmitter {
 		}, new DispatcherEvent('restoreState', null));
 	}
 
-	public setEditableRange(range:EditorCommon.IRange): void {
+	public setEditableRange(range:editorCommon.IRange): void {
 		this.model.setEditableRange(range);
 	}
 
-	public getEditableRange(): EditorCommon.IEditorRange {
+	public getEditableRange(): editorCommon.IEditorRange {
 		return this.model.getEditableRange();
 	}
 
@@ -248,8 +248,8 @@ export class Cursor extends EventEmitter {
 		this.cursors.updateMode();
 	}
 
-	private _onModelContentChanged(e:EditorCommon.IModelContentChangedEvent): void {
-		if (e.changeType === EditorCommon.EventType.ModelContentChangedFlush) {
+	private _onModelContentChanged(e:editorCommon.IModelContentChangedEvent): void {
+		if (e.changeType === editorCommon.EventType.ModelContentChangedFlush) {
 			// a model.setValue() was called
 			this.cursors.dispose();
 
@@ -271,19 +271,19 @@ export class Cursor extends EventEmitter {
 
 	// ------ some getters/setters
 
-	public getSelection(): EditorCommon.IEditorSelection {
+	public getSelection(): editorCommon.IEditorSelection {
 		return this.cursors.getSelection(0);
 	}
 
-	public getSelections(): EditorCommon.IEditorSelection[] {
+	public getSelections(): editorCommon.IEditorSelection[] {
 		return this.cursors.getSelections();
 	}
 
-	public getPosition(): EditorCommon.IEditorPosition {
+	public getPosition(): editorCommon.IEditorPosition {
 		return this.cursors.getPosition(0);
 	}
 
-	public setSelections(source: string, selections: EditorCommon.ISelection[]): void {
+	public setSelections(source: string, selections: editorCommon.ISelection[]): void {
 		this._onHandler('setSelections', (ctx:IMultipleCursorOperationContext) => {
 			ctx.shouldReveal = false;
 			this.cursors.setSelections(selections);
@@ -320,7 +320,7 @@ export class Cursor extends EventEmitter {
 		return currentHandlerCtx.hasExecutedCommands;
 	}
 
-	private _onHandler(command:string, handler:(ctx:IMultipleCursorOperationContext)=>boolean, e:EditorCommon.IDispatcherEvent): boolean {
+	private _onHandler(command:string, handler:(ctx:IMultipleCursorOperationContext)=>boolean, e:editorCommon.IDispatcherEvent): boolean {
 
 		this._isHandling = true;
 		this.charactersTyped = '';
@@ -367,7 +367,7 @@ export class Cursor extends EventEmitter {
 						try {
 							listeners[j]();
 						} catch (e) {
-							Errors.onUnexpectedError(e);
+							onUnexpectedError(e);
 						}
 					}
 				}
@@ -403,7 +403,7 @@ export class Cursor extends EventEmitter {
 				this.emitCursorPositionChanged(eventSource, cursorPositionChangeReason);
 
 				if (shouldReveal) {
-					this.emitCursorRevealRange(shouldRevealTarget, shouldRevealVerticalInCenter ? EditorCommon.VerticalRevealType.Center : EditorCommon.VerticalRevealType.Simple, shouldRevealHorizontal);
+					this.emitCursorRevealRange(shouldRevealTarget, shouldRevealVerticalInCenter ? editorCommon.VerticalRevealType.Center : editorCommon.VerticalRevealType.Simple, shouldRevealHorizontal);
 				}
 				this.emitCursorSelectionChanged(eventSource, cursorPositionChangeReason);
 			}
@@ -412,7 +412,7 @@ export class Cursor extends EventEmitter {
 				this.emitCursorScrollRequest(requestScrollDeltaLines);
 			}
 		} catch (err) {
-			Errors.onUnexpectedError(err);
+			onUnexpectedError(err);
 		}
 
 		this._isHandling = false;
@@ -457,7 +457,7 @@ export class Cursor extends EventEmitter {
 		}
 	}
 
-	private _interpretCommandResult(cursorState:EditorCommon.IEditorSelection[]): boolean {
+	private _interpretCommandResult(cursorState:editorCommon.IEditorSelection[]): boolean {
 		if (!cursorState) {
 			return false;
 		}
@@ -466,13 +466,13 @@ export class Cursor extends EventEmitter {
 		return true;
 	}
 
-	private _getEditOperationsFromCommand(ctx: IExecContext, majorIdentifier: number, command: EditorCommon.ICommand): ICommandData {
+	private _getEditOperationsFromCommand(ctx: IExecContext, majorIdentifier: number, command: editorCommon.ICommand): ICommandData {
 		// This method acts as a transaction, if the command fails
 		// everything it has done is ignored
-		var operations: EditorCommon.IIdentifiedSingleEditOperation[] = [],
+		var operations: editorCommon.IIdentifiedSingleEditOperation[] = [],
 			operationMinor = 0;
 
-		var addEditOperation = (selection:EditorCommon.IEditorRange, text:string) => {
+		var addEditOperation = (selection:editorCommon.IEditorRange, text:string) => {
 			if (selection.isEmpty() && text === '') {
 				// This command wants to add a no-op => no thank you
 				return;
@@ -489,7 +489,7 @@ export class Cursor extends EventEmitter {
 		};
 
 		var hadTrackedRange = false;
-		var trackSelection = (selection: EditorCommon.IEditorSelection, trackPreviousOnEmpty?:boolean ) => {
+		var trackSelection = (selection: editorCommon.IEditorSelection, trackPreviousOnEmpty?:boolean ) => {
 			var selectionMarkerStickToPreviousCharacter:boolean,
 				positionMarkerStickToPreviousCharacter:boolean;
 
@@ -509,7 +509,7 @@ export class Cursor extends EventEmitter {
 					}
 				}
 			} else {
-				if (selection.getDirection() === EditorCommon.SelectionDirection.LTR) {
+				if (selection.getDirection() === editorCommon.SelectionDirection.LTR) {
 					selectionMarkerStickToPreviousCharacter = false;
 					positionMarkerStickToPreviousCharacter = true;
 				} else {
@@ -524,7 +524,7 @@ export class Cursor extends EventEmitter {
 			return l.toString();
 		};
 
-		var editOperationBuilder:EditorCommon.IEditOperationBuilder = {
+		var editOperationBuilder:editorCommon.IEditOperationBuilder = {
 			addEditOperation: addEditOperation,
 			trackSelection: trackSelection
 		};
@@ -533,7 +533,7 @@ export class Cursor extends EventEmitter {
 			command.getEditOperations(this.model, editOperationBuilder);
 		} catch (e) {
 			e.friendlyMessage = nls.localize('corrupt.commands', "Unexpected exception while executing command.");
-			Errors.onUnexpectedError(e);
+			onUnexpectedError(e);
 			return {
 				operations: [],
 				hadTrackedRange: false
@@ -546,9 +546,9 @@ export class Cursor extends EventEmitter {
 		};
 	}
 
-	private _getEditOperations(ctx: IExecContext, commands: EditorCommon.ICommand[]): ICommandsData {
+	private _getEditOperations(ctx: IExecContext, commands: editorCommon.ICommand[]): ICommandsData {
 		var oneResult: ICommandData;
-		var operations: EditorCommon.IIdentifiedSingleEditOperation[] = [];
+		var operations: editorCommon.IIdentifiedSingleEditOperation[] = [];
 		var hadTrackedRanges: boolean[] = [];
 		var anyoneHadTrackedRange: boolean;
 
@@ -569,21 +569,21 @@ export class Cursor extends EventEmitter {
 		};
 	}
 
-	private _getLoserCursorMap(operations: EditorCommon.IIdentifiedSingleEditOperation[]): { [index: string]: boolean; } {
+	private _getLoserCursorMap(operations: editorCommon.IIdentifiedSingleEditOperation[]): { [index: string]: boolean; } {
 		// This is destructive on the array
 		operations = operations.slice(0);
 
 		// Sort operations with last one first
-		operations.sort((a:EditorCommon.IIdentifiedSingleEditOperation, b:EditorCommon.IIdentifiedSingleEditOperation): number => {
+		operations.sort((a:editorCommon.IIdentifiedSingleEditOperation, b:editorCommon.IIdentifiedSingleEditOperation): number => {
 			// Note the minus!
 			return -(Range.compareRangesUsingEnds(a.range, b.range));
 		});
 
 		// Operations can not overlap!
 		var loserCursorsMap:{ [index:string]: boolean; } = {};
 
-		var previousOp: EditorCommon.IIdentifiedSingleEditOperation;
-		var currentOp: EditorCommon.IIdentifiedSingleEditOperation;
+		var previousOp: editorCommon.IIdentifiedSingleEditOperation;
+		var currentOp: editorCommon.IIdentifiedSingleEditOperation;
 		var loserMajor: number;
 
 		for (var i = 1; i < operations.length; i++) {
@@ -620,7 +620,7 @@ export class Cursor extends EventEmitter {
 		return loserCursorsMap;
 	}
 
-	private _collapseDeleteCommands(rawCmds: EditorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
+	private _collapseDeleteCommands(rawCmds: editorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
 		if (rawCmds.length === 1) {
 			return ;
 		}
@@ -676,7 +676,7 @@ export class Cursor extends EventEmitter {
 		}
 	}
 
-	private _internalExecuteCommands(commands: EditorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
+	private _internalExecuteCommands(commands: editorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
 		var ctx:IExecContext = {
 			selectionStartMarkers: [],
 			positionMarkers: []
@@ -692,7 +692,7 @@ export class Cursor extends EventEmitter {
 		return r;
 	}
 
-	private _arrayIsEmpty(commands: EditorCommon.ICommand[]): boolean {
+	private _arrayIsEmpty(commands: editorCommon.ICommand[]): boolean {
 		var i:number,
 			len:number;
 
@@ -705,7 +705,7 @@ export class Cursor extends EventEmitter {
 		return true;
 	}
 
-	private _innerExecuteCommands(ctx: IExecContext, commands: EditorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
+	private _innerExecuteCommands(ctx: IExecContext, commands: editorCommon.ICommand[], postOperationRunnables: IPostOperationRunnable[]): boolean {
 
 		if (this.configuration.editor.readOnly) {
 			return false;
@@ -743,26 +743,26 @@ export class Cursor extends EventEmitter {
 		}
 
 		// Remove operations belonging to losing cursors
-		var filteredOperations: EditorCommon.IIdentifiedSingleEditOperation[] = [];
+		var filteredOperations: editorCommon.IIdentifiedSingleEditOperation[] = [];
 		for (var i = 0; i < rawOperations.length; i++) {
 			if (!loserCursorsMap.hasOwnProperty(rawOperations[i].identifier.major.toString())) {
 				filteredOperations.push(rawOperations[i]);
 			}
 		}
 
-		var selectionsAfter = this.model.pushEditOperations(selectionsBefore, filteredOperations, (inverseEditOperations:EditorCommon.IIdentifiedSingleEditOperation[]): EditorCommon.IEditorSelection[] => {
-			var groupedInverseEditOperations:EditorCommon.IIdentifiedSingleEditOperation[][] = [];
+		var selectionsAfter = this.model.pushEditOperations(selectionsBefore, filteredOperations, (inverseEditOperations:editorCommon.IIdentifiedSingleEditOperation[]): editorCommon.IEditorSelection[] => {
+			var groupedInverseEditOperations:editorCommon.IIdentifiedSingleEditOperation[][] = [];
 			for (var i = 0; i < selectionsBefore.length; i++) {
 				groupedInverseEditOperations[i] = [];
 			}
 			for (var i = 0; i < inverseEditOperations.length; i++) {
 				var op = inverseEditOperations[i];
 				groupedInverseEditOperations[op.identifier.major].push(op);
 			}
-			var minorBasedSorter = (a:EditorCommon.IIdentifiedSingleEditOperation, b:EditorCommon.IIdentifiedSingleEditOperation) => {
+			var minorBasedSorter = (a:editorCommon.IIdentifiedSingleEditOperation, b:editorCommon.IIdentifiedSingleEditOperation) => {
 				return a.identifier.minor - b.identifier.minor;
 			};
-			var cursorSelections: EditorCommon.IEditorSelection[] = [];
+			var cursorSelections: editorCommon.IEditorSelection[] = [];
 			for (var i = 0; i < selectionsBefore.length; i++) {
 				if (groupedInverseEditOperations[i].length > 0 || commandsData.hadTrackedRanges[i]) {
 					groupedInverseEditOperations[i].sort(minorBasedSorter);
@@ -828,7 +828,7 @@ export class Cursor extends EventEmitter {
 				isInEditableRange = false;
 			}
 		}
-		var e:EditorCommon.ICursorPositionChangedEvent = {
+		var e:editorCommon.ICursorPositionChangedEvent = {
 			position: primaryPosition,
 			viewPosition: primaryViewPosition,
 			secondaryPositions: secondaryPositions,
@@ -837,7 +837,7 @@ export class Cursor extends EventEmitter {
 			source: source,
 			isInEditableRange: isInEditableRange
 		};
-		this.emit(EditorCommon.EventType.CursorPositionChanged, e);
+		this.emit(editorCommon.EventType.CursorPositionChanged, e);
 	}
 
 	private emitCursorSelectionChanged(source:string, reason:string): void {
@@ -849,25 +849,25 @@ export class Cursor extends EventEmitter {
 		let primaryViewSelection = viewSelections[0];
 		let secondaryViewSelections = viewSelections.slice(1);
 
-		let e:EditorCommon.ICursorSelectionChangedEvent = {
+		let e:editorCommon.ICursorSelectionChangedEvent = {
 			selection: primarySelection,
 			viewSelection: primaryViewSelection,
 			secondarySelections: secondarySelections,
 			secondaryViewSelections: secondaryViewSelections,
 			source: source,
 			reason: reason
 		};
-		this.emit(EditorCommon.EventType.CursorSelectionChanged, e);
+		this.emit(editorCommon.EventType.CursorSelectionChanged, e);
 	}
 
 	private emitCursorScrollRequest(lineScrollOffset: number): void {
-		var e:EditorCommon.ICursorScrollRequestEvent = {
+		var e:editorCommon.ICursorScrollRequestEvent = {
 			deltaLines: lineScrollOffset
 		};
-		this.emit(EditorCommon.EventType.CursorScrollRequest, e);
+		this.emit(editorCommon.EventType.CursorScrollRequest, e);
 	}
 
-	private emitCursorRevealRange(revealTarget: RevealTarget, verticalType: EditorCommon.VerticalRevealType, revealHorizontal: boolean): void {
+	private emitCursorRevealRange(revealTarget: RevealTarget, verticalType: editorCommon.VerticalRevealType, revealHorizontal: boolean): void {
 		var positions = this.cursors.getPositions();
 		var viewPositions = this.cursors.getViewPositions();
 
@@ -897,20 +897,20 @@ export class Cursor extends EventEmitter {
 
 		var range = new Range(position.lineNumber, position.column, position.lineNumber, position.column);
 		var viewRange = new Range(viewPosition.lineNumber, viewPosition.column, viewPosition.lineNumber, viewPosition.column);
-		var e:EditorCommon.ICursorRevealRangeEvent = {
+		var e:editorCommon.ICursorRevealRangeEvent = {
 			range: range,
 			viewRange: viewRange,
 			verticalType: verticalType,
 			revealHorizontal: revealHorizontal
 		};
-		this.emit(EditorCommon.EventType.CursorRevealRange, e);
+		this.emit(editorCommon.EventType.CursorRevealRange, e);
 	}
 
 	// -----------------------------------------------------------------------------------------------------------
 	// ----- handlers beyond this point
 
 	private _registerHandlers(): void {
-		var H = EditorCommon.Handler;
+		var H = editorCommon.Handler;
 		var handlersMap:{
 			[key:string]:(ctx:IMultipleCursorOperationContext)=>boolean;
 		} = {};
@@ -1003,7 +1003,7 @@ export class Cursor extends EventEmitter {
 		handlersMap[H.ExecuteCommands] =			(ctx:IMultipleCursorOperationContext) => this._externalExecuteCommands(ctx);
 
 		var createHandler = (handlerId:string, handlerExec:(ctx:IMultipleCursorOperationContext)=>boolean) => {
-			return (e:EditorCommon.IDispatcherEvent) => this._onHandler(handlerId, handlerExec, e);
+			return (e:editorCommon.IDispatcherEvent) => this._onHandler(handlerId, handlerExec, e);
 		};
 
 		var handler:string;
@@ -1014,15 +1014,30 @@ export class Cursor extends EventEmitter {
 		}
 	}
 
+	private _invokeForAllSorted(ctx: IMultipleCursorOperationContext, callable: (cursorIndex: number, cursor: OneCursor, ctx: IOneCursorOperationContext) => boolean, pushStackElementBefore: boolean = true, pushStackElementAfter: boolean = true): boolean {
+		return this._doInvokeForAll(ctx, true, callable, pushStackElementBefore, pushStackElementAfter);
+	}
+
 	private _invokeForAll(ctx: IMultipleCursorOperationContext, callable: (cursorIndex: number, cursor: OneCursor, ctx: IOneCursorOperationContext) => boolean, pushStackElementBefore: boolean = true, pushStackElementAfter: boolean = true): boolean {
-		var result = false;
-		var cursors = this.cursors.getAll();
-		var context:IOneCursorOperationContext;
+		return this._doInvokeForAll(ctx, false, callable, pushStackElementBefore, pushStackElementAfter);
+	}
+
+	private _doInvokeForAll(ctx: IMultipleCursorOperationContext, sorted: boolean, callable: (cursorIndex: number, cursor: OneCursor, ctx: IOneCursorOperationContext) => boolean, pushStackElementBefore: boolean = true, pushStackElementAfter: boolean = true): boolean {
+		let result = false;
+		let cursors = this.cursors.getAll();
+
+		if (sorted) {
+			cursors = cursors.sort((a, b) => {
+				return Range.compareRangesUsingStarts(a.getSelection(), b.getSelection());
+			});
+		}
+
+		let context:IOneCursorOperationContext;
 
 		ctx.shouldPushStackElementBefore = pushStackElementBefore;
 		ctx.shouldPushStackElementAfter = pushStackElementAfter;
 
-		for (var i = 0; i < cursors.length; i++) {
+		for (let i = 0; i < cursors.length; i++) {
 			context = {
 				cursorPositionChangeReason: '',
 				shouldReveal: true,
@@ -1322,7 +1337,7 @@ export class Cursor extends EventEmitter {
 		var distributedPaste = this._distributePasteToCursors(ctx);
 
 		if (distributedPaste) {
-			return this._invokeForAll(ctx, (cursorIndex: number, oneCursor: OneCursor, oneCtx: IOneCursorOperationContext) => OneCursorOp.paste(oneCursor, distributedPaste[cursorIndex], false, oneCtx));
+			return this._invokeForAllSorted(ctx, (cursorIndex: number, oneCursor: OneCursor, oneCtx: IOneCursorOperationContext) => OneCursorOp.paste(oneCursor, distributedPaste[cursorIndex], false, oneCtx));
 		} else {
 			return this._invokeForAll(ctx, (cursorIndex: number, oneCursor: OneCursor, oneCtx: IOneCursorOperationContext) => OneCursorOp.paste(oneCursor, ctx.eventData.text, ctx.eventData.pasteOnNewLine, oneCtx));
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/cursorCollection.ts
code:
@@ -4,11 +4,11 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {onUnexpectedError} from 'vs/base/common/errors';
+import {IModeConfiguration, IOneCursorState, IViewModelHelper, OneCursor} from 'vs/editor/common/controller/oneCursor';
 import {Selection} from 'vs/editor/common/core/selection';
-import {OneCursor, IOneCursorState, IModeConfiguration, IViewModelHelper} from 'vs/editor/common/controller/oneCursor';
+import {IConfiguration, IEditorPosition, IEditorSelection, IModel, ISelection} from 'vs/editor/common/editorCommon';
 import {IAutoClosingPair} from 'vs/editor/common/modes';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
 
 export interface ICursorCollectionState {
 	primary: IOneCursorState;
@@ -18,8 +18,8 @@ export interface ICursorCollectionState {
 export class CursorCollection {
 
 	private editorId: number;
-	private model: EditorCommon.IModel;
-	private configuration: EditorCommon.IConfiguration;
+	private model: IModel;
+	private configuration: IConfiguration;
 	private modeConfiguration: IModeConfiguration;
 
 	private primaryCursor: OneCursor;
@@ -30,7 +30,7 @@ export class CursorCollection {
 
 	private viewModelHelper:IViewModelHelper;
 
-	constructor(editorId: number, model: EditorCommon.IModel, configuration: EditorCommon.IConfiguration, viewModelHelper:IViewModelHelper) {
+	constructor(editorId: number, model: IModel, configuration: IConfiguration, viewModelHelper:IViewModelHelper) {
 		this.editorId = editorId;
 		this.model = model;
 		this.configuration = configuration;
@@ -78,67 +78,67 @@ export class CursorCollection {
 		return result;
 	}
 
-	public getPosition(index: number): EditorCommon.IEditorPosition {
+	public getPosition(index: number): IEditorPosition {
 		if (index === 0) {
 			return this.primaryCursor.getPosition();
 		} else {
 			return this.secondaryCursors[index - 1].getPosition();
 		}
 	}
 
-	public getViewPosition(index: number): EditorCommon.IEditorPosition {
+	public getViewPosition(index: number): IEditorPosition {
 		if (index === 0) {
 			return this.primaryCursor.getViewPosition();
 		} else {
 			return this.secondaryCursors[index - 1].getViewPosition();
 		}
 	}
 
-	public getPositions(): EditorCommon.IEditorPosition[] {
-		var result: EditorCommon.IEditorPosition[] = [];
+	public getPositions(): IEditorPosition[] {
+		var result: IEditorPosition[] = [];
 		result.push(this.primaryCursor.getPosition());
 		for (var i = 0, len = this.secondaryCursors.length; i < len; i++) {
 			result.push(this.secondaryCursors[i].getPosition());
 		}
 		return result;
 	}
 
-	public getViewPositions(): EditorCommon.IEditorPosition[] {
-		var result: EditorCommon.IEditorPosition[] = [];
+	public getViewPositions(): IEditorPosition[] {
+		var result: IEditorPosition[] = [];
 		result.push(this.primaryCursor.getViewPosition());
 		for (var i = 0, len = this.secondaryCursors.length; i < len; i++) {
 			result.push(this.secondaryCursors[i].getViewPosition());
 		}
 		return result;
 	}
 
-	public getSelection(index: number): EditorCommon.IEditorSelection {
+	public getSelection(index: number): IEditorSelection {
 		if (index === 0) {
 			return this.primaryCursor.getSelection();
 		} else {
 			return this.secondaryCursors[index - 1].getSelection();
 		}
 	}
 
-	public getSelections(): EditorCommon.IEditorSelection[] {
-		var result: EditorCommon.IEditorSelection[] = [];
+	public getSelections(): IEditorSelection[] {
+		var result: IEditorSelection[] = [];
 		result.push(this.primaryCursor.getSelection());
 		for (var i = 0, len = this.secondaryCursors.length; i < len; i++) {
 			result.push(this.secondaryCursors[i].getSelection());
 		}
 		return result;
 	}
 
-	public getViewSelections(): EditorCommon.IEditorSelection[] {
-		var result: EditorCommon.IEditorSelection[] = [];
+	public getViewSelections(): IEditorSelection[] {
+		var result: IEditorSelection[] = [];
 		result.push(this.primaryCursor.getViewSelection());
 		for (var i = 0, len = this.secondaryCursors.length; i < len; i++) {
 			result.push(this.secondaryCursors[i].getViewSelection());
 		}
 		return result;
 	}
 
-	public setSelections(selections: EditorCommon.ISelection[]): void {
+	public setSelections(selections: ISelection[]): void {
 		this.primaryCursor.setSelection(selections[0]);
 		this._setSecondarySelections(selections.slice(1));
 	}
@@ -156,7 +156,7 @@ export class CursorCollection {
 		}
 	}
 
-	public addSecondaryCursor(selection: EditorCommon.ISelection): void {
+	public addSecondaryCursor(selection: ISelection): void {
 		var newCursor = new OneCursor(this.editorId, this.model, this.configuration, this.modeConfiguration, this.viewModelHelper);
 		if (selection) {
 			newCursor.setSelection(selection);
@@ -191,7 +191,7 @@ export class CursorCollection {
 	 * 		- a negative number indicates the number of secondary cursors removed
 	 * 		- 0 indicates that no changes have been done to the secondary cursors list
 	 */
-	private _setSecondarySelections(secondarySelections: EditorCommon.ISelection[]): number {
+	private _setSecondarySelections(secondarySelections: ISelection[]): number {
 		var secondaryCursorsLength = this.secondaryCursors.length;
 		var secondarySelectionsLength = secondarySelections.length;
 		var returnValue = secondarySelectionsLength - secondaryCursorsLength;
@@ -232,7 +232,7 @@ export class CursorCollection {
 		var cursors = this.getAll();
 		var sortedCursors:{
 			index: number;
-			selection: EditorCommon.IEditorSelection;
+			selection: IEditorSelection;
 		}[] = [];
 		for (var i = 0; i < cursors.length; i++) {
 			sortedCursors.push({
@@ -280,7 +280,7 @@ export class CursorCollection {
 						resultingSelectionIsLTR = winnerSelectionIsLTR;
 					}
 
-					var resultingSelection: EditorCommon.IEditorSelection;
+					var resultingSelection: IEditorSelection;
 					if (resultingSelectionIsLTR) {
 						resultingSelection = new Selection(resultingRange.startLineNumber, resultingRange.startColumn, resultingRange.endLineNumber, resultingRange.endColumn);
 					} else {
@@ -323,7 +323,7 @@ export class CursorCollection {
 			try {
 				electricChars = richEditSupport.electricCharacter.getElectricCharacters();
 			} catch(e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 				electricChars = null;
 			}
 		}
@@ -338,7 +338,7 @@ export class CursorCollection {
 			try {
 				autoClosingPairs = richEditSupport.characterPair.getAutoClosingPairs();
 			} catch(e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 				autoClosingPairs = null;
 			}
 		}
@@ -354,7 +354,7 @@ export class CursorCollection {
 			try {
 				surroundingPairs = richEditSupport.characterPair.getSurroundingPairs();
 			} catch(e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 				surroundingPairs = null;
 			}
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/cursorMoveHelper.ts
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IInternalIndentationOptions, IPosition} from 'vs/editor/common/editorCommon';
 
 export interface IMoveResult {
 	lineNumber:number;
@@ -22,7 +22,7 @@ export interface ICursorMoveHelperModel {
 }
 
 export interface IConfiguration {
-	getIndentationOptions(): EditorCommon.IInternalIndentationOptions;
+	getIndentationOptions(): IInternalIndentationOptions;
 }
 
 function isHighSurrogate(model, lineNumber, column) {
@@ -43,7 +43,7 @@ export class CursorMoveHelper {
 		this.configuration = configuration;
 	}
 
-	public getLeftOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
+	public getLeftOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): IPosition {
 
 		if (column > model.getLineMinColumn(lineNumber)) {
 			column = column - (isLowSurrogate(model, lineNumber, column - 1) ? 2 : 1);
@@ -58,7 +58,7 @@ export class CursorMoveHelper {
 		};
 	}
 
-	public getRightOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
+	public getRightOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): IPosition {
 
 		if (column < model.getLineMaxColumn(lineNumber)) {
 			column = column + (isHighSurrogate(model, lineNumber, column) ? 2 : 1);
@@ -73,13 +73,17 @@ export class CursorMoveHelper {
 		};
 	}
 
-	public getPositionUp(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
+	public getPositionUp(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnFirstLine:boolean): IMoveResult {
 		var currentVisibleColumn = this.visibleColumnFromColumn(model, lineNumber, column) + leftoverVisibleColumns;
 
 		lineNumber = lineNumber - count;
 		if (lineNumber < 1) {
 			lineNumber = 1;
-			column = model.getLineMinColumn(lineNumber);
+			if (allowMoveOnFirstLine) {
+				column = model.getLineMinColumn(lineNumber);
+			} else {
+				column = Math.min(model.getLineMaxColumn(lineNumber), column);
+			}
 		} else {
 			column = this.columnFromVisibleColumn(model, lineNumber, currentVisibleColumn);
 		}
@@ -93,14 +97,18 @@ export class CursorMoveHelper {
 		};
 	}
 
-	public getPositionDown(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
+	public getPositionDown(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnLastLine:boolean): IMoveResult {
 		var currentVisibleColumn = this.visibleColumnFromColumn(model, lineNumber, column) + leftoverVisibleColumns;
 
 		lineNumber = lineNumber + count;
 		var lineCount = model.getLineCount();
 		if (lineNumber > lineCount) {
 			lineNumber = lineCount;
-			column = model.getLineMaxColumn(lineNumber);
+			if (allowMoveOnLastLine) {
+				column = model.getLineMaxColumn(lineNumber);
+			} else {
+				column = Math.min(model.getLineMaxColumn(lineNumber), column);
+			}
 		} else {
 			column = this.columnFromVisibleColumn(model, lineNumber, currentVisibleColumn);
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/handlerDispatcher.ts
code:
@@ -4,9 +4,9 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDispatcherEvent, IHandler} from 'vs/editor/common/editorCommon';
 
-export class DispatcherEvent implements EditorCommon.IDispatcherEvent {
+export class DispatcherEvent implements IDispatcherEvent {
 
 	private source:string;
 	private data:any;
@@ -26,7 +26,7 @@ export class DispatcherEvent implements EditorCommon.IDispatcherEvent {
 }
 
 interface IHandlersMap {
-	[key:string]:EditorCommon.IHandler;
+	[key:string]:IHandler;
 }
 
 export class HandlerDispatcher {
@@ -36,15 +36,15 @@ export class HandlerDispatcher {
 		this.registry = {};
 	}
 
-	public setHandler(handlerId:string, handlerCallback:EditorCommon.IHandler): void {
+	public setHandler(handlerId:string, handlerCallback:IHandler): void {
 		this.registry[handlerId] = handlerCallback;
 	}
 
 	public clearHandlers(): void {
 		this.registry = {};
 	}
 
-	private getHandler(handlerId:string): EditorCommon.IHandler {
+	private getHandler(handlerId:string): IHandler {
 		return this.registry.hasOwnProperty(handlerId) ? this.registry[handlerId] : null;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/oneCursor.ts
code:
@@ -4,17 +4,17 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Strings = require('vs/base/common/strings');
-import {Position} from 'vs/editor/common/core/position';
-import {Range} from 'vs/editor/common/core/range';
-import {ShiftCommand} from 'vs/editor/common/commands/shiftCommand';
+import {onUnexpectedError} from 'vs/base/common/errors';
+import * as strings from 'vs/base/common/strings';
 import {ReplaceCommand, ReplaceCommandWithOffsetCursorState, ReplaceCommandWithoutChangingPosition} from 'vs/editor/common/commands/replaceCommand';
+import {ShiftCommand} from 'vs/editor/common/commands/shiftCommand';
 import {SurroundSelectionCommand} from 'vs/editor/common/commands/surroundSelectionCommand';
-import {Selection} from 'vs/editor/common/core/selection';
-import {IndentAction,IElectricAction} from 'vs/editor/common/modes';
 import {CursorMoveHelper, ICursorMoveHelperModel, IMoveResult} from 'vs/editor/common/controller/cursorMoveHelper';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
+import {Position} from 'vs/editor/common/core/position';
+import {Range} from 'vs/editor/common/core/range';
+import {Selection} from 'vs/editor/common/core/selection';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {IElectricAction, IndentAction} from 'vs/editor/common/modes';
 import {getEnterActionAtPosition} from 'vs/editor/common/modes/supports/onEnter';
 
 export interface IPostOperationRunnable {
@@ -28,7 +28,7 @@ export interface IOneCursorOperationContext {
 	shouldRevealHorizontal: boolean;
 	shouldPushStackElementBefore: boolean;
 	shouldPushStackElementAfter: boolean;
-	executeCommand: EditorCommon.ICommand;
+	executeCommand: editorCommon.ICommand;
 	postOperationRunnable: IPostOperationRunnable;
 	requestScrollDeltaLines: number;
 }
@@ -56,55 +56,59 @@ export interface IViewModelHelper {
 
 	viewModel:ICursorMoveHelperModel;
 
-	convertModelPositionToViewPosition(lineNumber:number, column:number): EditorCommon.IEditorPosition;
-	convertModelRangeToViewRange(modelRange:EditorCommon.IEditorRange): EditorCommon.IEditorRange;
+	convertModelPositionToViewPosition(lineNumber:number, column:number): editorCommon.IEditorPosition;
+	convertModelRangeToViewRange(modelRange:editorCommon.IEditorRange): editorCommon.IEditorRange;
 
-	convertViewToModelPosition(lineNumber:number, column:number): EditorCommon.IEditorPosition;
+	convertViewToModelPosition(lineNumber:number, column:number): editorCommon.IEditorPosition;
 
-	validateViewPosition(viewLineNumber:number, viewColumn:number, modelPosition:EditorCommon.IEditorPosition): EditorCommon.IEditorPosition;
-	validateViewRange(viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:EditorCommon.IEditorRange): EditorCommon.IEditorRange;
+	validateViewPosition(viewLineNumber:number, viewColumn:number, modelPosition:editorCommon.IEditorPosition): editorCommon.IEditorPosition;
+	validateViewRange(viewStartLineNumber:number, viewStartColumn:number, viewEndLineNumber:number, viewEndColumn:number, modelRange:editorCommon.IEditorRange): editorCommon.IEditorRange;
 }
 
 export interface IOneCursorState {
-	selectionStart: EditorCommon.IEditorRange;
-	viewSelectionStart: EditorCommon.IEditorRange;
-	position: EditorCommon.IEditorPosition;
-	viewPosition: EditorCommon.IEditorPosition;
+	selectionStart: editorCommon.IEditorRange;
+	viewSelectionStart: editorCommon.IEditorRange;
+	position: editorCommon.IEditorPosition;
+	viewPosition: editorCommon.IEditorPosition;
 	leftoverVisibleColumns: number;
 	selectionStartLeftoverVisibleColumns: number;
 }
 
+export interface IFindWordResult extends editorCommon.IWordRange {
+	wordType: WordType;
+}
+
 export class OneCursor {
 
 	// --- contextual state
 	private editorId: number;
-	public model: EditorCommon.IModel;
-	public configuration: EditorCommon.IConfiguration;
+	public model: editorCommon.IModel;
+	public configuration: editorCommon.IConfiguration;
 	public modeConfiguration: IModeConfiguration;
 	private helper: CursorHelper;
 	private viewModelHelper:IViewModelHelper;
 
 	// --- selection can start as a range (think double click and drag)
-	private selectionStart: EditorCommon.IEditorRange;
-	private viewSelectionStart: EditorCommon.IEditorRange;
+	private selectionStart: editorCommon.IEditorRange;
+	private viewSelectionStart: editorCommon.IEditorRange;
 	private selectionStartLeftoverVisibleColumns: number;
 
 	// --- position
-	private position: EditorCommon.IEditorPosition;
-	private viewPosition: EditorCommon.IEditorPosition;
+	private position: editorCommon.IEditorPosition;
+	private viewPosition: editorCommon.IEditorPosition;
 	private leftoverVisibleColumns: number;
 
 	// --- bracket match decorations
 	private bracketDecorations: string[];
 
 	// --- computed properties
-	private _cachedSelection: EditorCommon.IEditorSelection;
-	private _cachedViewSelection: EditorCommon.IEditorSelection;
+	private _cachedSelection: editorCommon.IEditorSelection;
+	private _cachedViewSelection: editorCommon.IEditorSelection;
 	private _selStartMarker: string;
 	private _selEndMarker: string;
-	private _selDirection: EditorCommon.SelectionDirection;
+	private _selDirection: editorCommon.SelectionDirection;
 
-	constructor(editorId: number, model: EditorCommon.IModel, configuration: EditorCommon.IConfiguration, modeConfiguration: IModeConfiguration, viewModelHelper:IViewModelHelper) {
+	constructor(editorId: number, model: editorCommon.IModel, configuration: editorCommon.IConfiguration, modeConfiguration: IModeConfiguration, viewModelHelper:IViewModelHelper) {
 		this.editorId = editorId;
 		this.model = model;
 		this.configuration = configuration;
@@ -122,9 +126,9 @@ export class OneCursor {
 	}
 
 	private _set(
-		selectionStart: EditorCommon.IEditorRange, selectionStartLeftoverVisibleColumns: number,
-		position: EditorCommon.IEditorPosition, leftoverVisibleColumns:number,
-		viewSelectionStart: EditorCommon.IEditorRange, viewPosition: EditorCommon.IEditorPosition
+		selectionStart: editorCommon.IEditorRange, selectionStartLeftoverVisibleColumns: number,
+		position: editorCommon.IEditorPosition, leftoverVisibleColumns:number,
+		viewSelectionStart: editorCommon.IEditorRange, viewPosition: editorCommon.IEditorPosition
 	): void {
 		this.selectionStart = selectionStart;
 		this.selectionStartLeftoverVisibleColumns = selectionStartLeftoverVisibleColumns;
@@ -166,15 +170,15 @@ export class OneCursor {
 
 	public restoreState(state:IOneCursorState): void {
 		let position = this.model.validatePosition(state.position);
-		let selectionStart: EditorCommon.IEditorRange;
+		let selectionStart: editorCommon.IEditorRange;
 		if (state.selectionStart) {
 			selectionStart = this.model.validateRange(state.selectionStart);
 		} else {
 			selectionStart = new Range(position.lineNumber, position.column, position.lineNumber, position.column);
 		}
 
 		let viewPosition = this.viewModelHelper.validateViewPosition(state.viewPosition.lineNumber, state.viewPosition.column, position);
-		let viewSelectionStart: EditorCommon.IEditorRange;
+		let viewSelectionStart: editorCommon.IEditorRange;
 		if (state.viewSelectionStart) {
 			viewSelectionStart = this.viewModelHelper.validateViewRange(state.viewSelectionStart.startLineNumber, state.viewSelectionStart.startColumn, state.viewSelectionStart.endLineNumber, state.viewSelectionStart.endColumn, selectionStart);
 		} else {
@@ -209,16 +213,16 @@ export class OneCursor {
 	}
 
 	public adjustBracketDecorations(): void {
-		let bracketMatch: EditorCommon.IMatchBracketResult = null;
+		let bracketMatch: editorCommon.IMatchBracketResult = null;
 		let selection = this.getSelection();
 		if (selection.isEmpty()) {
 			bracketMatch = this.model.matchBracket(this.position, /*inaccurateResultAcceptable*/true);
 		}
 
-		let newDecorations: EditorCommon.IModelDeltaDecoration[] = [];
+		let newDecorations: editorCommon.IModelDeltaDecoration[] = [];
 		if (bracketMatch && bracketMatch.brackets) {
-			let options: EditorCommon.IModelDecorationOptions = {
-				stickiness: EditorCommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,
+			let options: editorCommon.IModelDecorationOptions = {
+				stickiness: editorCommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,
 				className: 'bracket-match'
 			};
 			newDecorations.push({ range: bracketMatch.brackets[0], options: options });
@@ -228,7 +232,7 @@ export class OneCursor {
 		this.bracketDecorations = this.model.deltaDecorations(this.bracketDecorations, newDecorations, this.editorId);
 	}
 
-	private static computeSelection(selectionStart:EditorCommon.IEditorRange, position:EditorCommon.IEditorPosition): Selection {
+	private static computeSelection(selectionStart:editorCommon.IEditorRange, position:editorCommon.IEditorPosition): Selection {
 		let startLineNumber: number, startColumn: number, endLineNumber: number, endColumn: number;
 		if (selectionStart.isEmpty()) {
 			startLineNumber = selectionStart.startLineNumber;
@@ -256,7 +260,7 @@ export class OneCursor {
 		);
 	}
 
-	public setSelection(desiredSelection: EditorCommon.ISelection): void {
+	public setSelection(desiredSelection: editorCommon.ISelection): void {
 		let position = this.model.validatePosition({
 			lineNumber: desiredSelection.positionLineNumber,
 			column: desiredSelection.positionColumn
@@ -279,7 +283,7 @@ export class OneCursor {
 
 	// -------------------- START modifications
 
-	public setSelectionStart(rng:EditorCommon.IEditorRange, viewRng:EditorCommon.IEditorRange): void {
+	public setSelectionStart(rng:editorCommon.IEditorRange, viewRng:editorCommon.IEditorRange): void {
 		this._set(
 			rng, this.selectionStartLeftoverVisibleColumns,
 			this.position, this.leftoverVisibleColumns,
@@ -356,7 +360,7 @@ export class OneCursor {
 		let start = this.model._getMarker(this._selStartMarker);
 		let end = this.model._getMarker(this._selEndMarker);
 
-		if (this._selDirection === EditorCommon.SelectionDirection.LTR) {
+		if (this._selDirection === editorCommon.SelectionDirection.LTR) {
 			return new Selection(start.lineNumber, start.column, end.lineNumber, end.column);
 		}
 
@@ -391,23 +395,23 @@ export class OneCursor {
 
 	// -------------------- START reading API
 
-	public getSelectionStart(): EditorCommon.IEditorRange {
+	public getSelectionStart(): editorCommon.IEditorRange {
 		return this.selectionStart;
 	}
-	public getPosition(): EditorCommon.IEditorPosition {
+	public getPosition(): editorCommon.IEditorPosition {
 		return this.position;
 	}
-	public getSelection(): EditorCommon.IEditorSelection {
+	public getSelection(): editorCommon.IEditorSelection {
 		return this._cachedSelection;
 	}
 
-	public getViewPosition(): EditorCommon.IEditorPosition {
+	public getViewPosition(): editorCommon.IEditorPosition {
 		return this.viewPosition;
 	}
-	public getViewSelection(): EditorCommon.IEditorSelection {
+	public getViewSelection(): editorCommon.IEditorSelection {
 		return this._cachedViewSelection;
 	}
-	public getValidViewPosition(): EditorCommon.IEditorPosition {
+	public getValidViewPosition(): editorCommon.IEditorPosition {
 		return this.viewModelHelper.validateViewPosition(this.viewPosition.lineNumber, this.viewPosition.column, this.position);
 	}
 
@@ -428,34 +432,43 @@ export class OneCursor {
 	}
 
 	// -- utils
-	public validatePosition(position:EditorCommon.IPosition): EditorCommon.IEditorPosition {
+	public validatePosition(position:editorCommon.IPosition): editorCommon.IEditorPosition {
 		return this.model.validatePosition(position);
 	}
-	public validateViewPosition(viewLineNumber:number, viewColumn:number, modelPosition:EditorCommon.IEditorPosition): EditorCommon.IEditorPosition {
+	public validateViewPosition(viewLineNumber:number, viewColumn:number, modelPosition:editorCommon.IEditorPosition): editorCommon.IEditorPosition {
 		return this.viewModelHelper.validateViewPosition(viewLineNumber, viewColumn, modelPosition);
 	}
-	public convertViewToModelPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public convertViewToModelPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.viewModelHelper.convertViewToModelPosition(lineNumber, column);
 	}
-	public convertModelPositionToViewPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public convertModelPositionToViewPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.viewModelHelper.convertModelPositionToViewPosition(lineNumber, column);
 	}
 
 	// -- model
-	public findWord(position:EditorCommon.IEditorPosition, preference:string, skipSyntaxTokens?:boolean): EditorCommon.IWordRange {
-		return this.helper.findWord(position, preference, skipSyntaxTokens);
+	public getLineContent(lineNumber:number): string {
+		return this.model.getLineContent(lineNumber);
+	}
+	// public findWord(position:editorCommon.IEditorPosition, preference:string, skipSyntaxTokens?:boolean): editorCommon.IWordRange {
+	// 	return this.helper.findWord(position, preference, skipSyntaxTokens);
+	// }
+	public findPreviousWordOnLine(position:editorCommon.IEditorPosition): IFindWordResult {
+		return this.helper.findPreviousWordOnLine(position);
 	}
-	public getLeftOfPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public findNextWordOnLine(position:editorCommon.IEditorPosition): IFindWordResult {
+		return this.helper.findNextWordOnLine(position);
+	}
+	public getLeftOfPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.helper.getLeftOfPosition(this.model, lineNumber, column);
 	}
-	public getRightOfPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public getRightOfPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.helper.getRightOfPosition(this.model, lineNumber, column);
 	}
-	public getPositionUp(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.helper.getPositionUp(this.model, lineNumber, column, leftoverVisibleColumns, count);
+	public getPositionUp(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnFirstLine:boolean): IMoveResult {
+		return this.helper.getPositionUp(this.model, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnFirstLine);
 	}
-	public getPositionDown(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.helper.getPositionDown(this.model, lineNumber, column, leftoverVisibleColumns, count);
+	public getPositionDown(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnLastLine:boolean): IMoveResult {
+		return this.helper.getPositionDown(this.model, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnLastLine);
 	}
 	public getColumnAtBeginningOfLine(lineNumber:number, column:number): number {
 		return this.helper.getColumnAtBeginningOfLine(this.model, lineNumber, column);
@@ -465,20 +478,23 @@ export class OneCursor {
 	}
 
 	// -- view
+	public getViewLineCount(): number {
+		return this.viewModelHelper.viewModel.getLineCount();
+	}
 	public getViewLineMaxColumn(lineNumber:number): number {
 		return this.viewModelHelper.viewModel.getLineMaxColumn(lineNumber);
 	}
-	public getLeftOfViewPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public getLeftOfViewPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.helper.getLeftOfPosition(this.viewModelHelper.viewModel, lineNumber, column);
 	}
-	public getRightOfViewPosition(lineNumber:number, column:number): EditorCommon.IPosition {
+	public getRightOfViewPosition(lineNumber:number, column:number): editorCommon.IPosition {
 		return this.helper.getRightOfPosition(this.viewModelHelper.viewModel, lineNumber, column);
 	}
-	public getViewPositionUp(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.helper.getPositionUp(this.viewModelHelper.viewModel, lineNumber, column, leftoverVisibleColumns, count);
+	public getViewPositionUp(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnFirstLine:boolean): IMoveResult {
+		return this.helper.getPositionUp(this.viewModelHelper.viewModel, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnFirstLine);
 	}
-	public getViewPositionDown(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.helper.getPositionDown(this.viewModelHelper.viewModel, lineNumber, column, leftoverVisibleColumns, count);
+	public getViewPositionDown(lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnLastLine:boolean): IMoveResult {
+		return this.helper.getPositionDown(this.viewModelHelper.viewModel, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnLastLine);
 	}
 	public getColumnAtBeginningOfViewLine(lineNumber:number, column:number): number {
 		return this.helper.getColumnAtBeginningOfLine(this.viewModelHelper.viewModel, lineNumber, column);
@@ -517,10 +533,10 @@ export class OneCursorOp {
 		return false;
 	}
 
-	public static moveTo(cursor:OneCursor, inSelectionMode: boolean, position: EditorCommon.IPosition, viewPosition:EditorCommon.IPosition, eventSource: string, ctx: IOneCursorOperationContext): boolean {
+	public static moveTo(cursor:OneCursor, inSelectionMode: boolean, position: editorCommon.IPosition, viewPosition:editorCommon.IPosition, eventSource: string, ctx: IOneCursorOperationContext): boolean {
 
 		var validatedPosition = cursor.model.validatePosition(position);
-		var validatedViewPosition: EditorCommon.IPosition;
+		var validatedViewPosition: editorCommon.IPosition;
 		if (viewPosition) {
 			validatedViewPosition = cursor.validateViewPosition(viewPosition.lineNumber, viewPosition.column, validatedPosition);
 		} else {
@@ -574,10 +590,11 @@ export class OneCursorOp {
 				column = cursor.model.getLineMaxColumn(lineNumber);
 			}
 		}
-		var word = cursor.findWord(new Position(lineNumber, column), 'left', true);
 
-		if (word) {
-			column = word.start + 1;
+		let prevWordOnLine = cursor.findPreviousWordOnLine(new Position(lineNumber, column));
+
+		if (prevWordOnLine) {
+			column = prevWordOnLine.start + 1;
 		} else {
 			column = 1;
 		}
@@ -623,10 +640,10 @@ export class OneCursorOp {
 			}
 		}
 
-		var word = cursor.findWord(new Position(lineNumber, column), 'right', true);
+		let nextWordOnLine = cursor.findNextWordOnLine(new Position(lineNumber, column));
 
-		if (word) {
-			column = word.end + 1;
+		if (nextWordOnLine) {
+			column = nextWordOnLine.end + 1;
 		} else {
 			column = cursor.model.getLineMaxColumn(lineNumber);
 		}
@@ -654,7 +671,7 @@ export class OneCursorOp {
 			viewColumn = validatedViewPosition.column;
 		}
 
-		var r = cursor.getViewPositionDown(viewLineNumber, viewColumn, cursor.getLeftoverVisibleColumns(), linesCount);
+		var r = cursor.getViewPositionDown(viewLineNumber, viewColumn, cursor.getLeftoverVisibleColumns(), linesCount, true);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(inSelectionMode, r.lineNumber, r.column, r.leftoverVisibleColumns, true);
 		return true;
@@ -664,11 +681,11 @@ export class OneCursorOp {
 
 		var selection = cursor.getViewSelection();
 
-		var selectionStart = cursor.getViewPositionDown(selection.selectionStartLineNumber, selection.selectionStartColumn, cursor.getSelectionStartLeftoverVisibleColumns(), 1);
+		var selectionStart = cursor.getViewPositionDown(selection.selectionStartLineNumber, selection.selectionStartColumn, cursor.getSelectionStartLeftoverVisibleColumns(), 1, false);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(false, selectionStart.lineNumber, selectionStart.column, cursor.getLeftoverVisibleColumns(), true);
 
-		var position = cursor.getViewPositionDown(selection.positionLineNumber, selection.positionColumn, cursor.getLeftoverVisibleColumns(), 1);
+		var position = cursor.getViewPositionDown(selection.positionLineNumber, selection.positionColumn, cursor.getLeftoverVisibleColumns(), 1, false);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(true, position.lineNumber, position.column, position.leftoverVisibleColumns, true);
 
@@ -695,7 +712,7 @@ export class OneCursorOp {
 			viewColumn = validatedViewPosition.column;
 		}
 
-		var r = cursor.getViewPositionUp(viewLineNumber, viewColumn, cursor.getLeftoverVisibleColumns(), linesCount);
+		var r = cursor.getViewPositionUp(viewLineNumber, viewColumn, cursor.getLeftoverVisibleColumns(), linesCount, true);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(inSelectionMode, r.lineNumber, r.column, r.leftoverVisibleColumns, true);
 
@@ -706,11 +723,11 @@ export class OneCursorOp {
 
 		var selection = cursor.getViewSelection();
 
-		var selectionStart = cursor.getViewPositionUp(selection.selectionStartLineNumber, selection.selectionStartColumn, cursor.getSelectionStartLeftoverVisibleColumns(), 1);
+		var selectionStart = cursor.getViewPositionUp(selection.selectionStartLineNumber, selection.selectionStartColumn, cursor.getSelectionStartLeftoverVisibleColumns(), 1, false);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(false, selectionStart.lineNumber, selectionStart.column, cursor.getLeftoverVisibleColumns(), true);
 
-		var position = cursor.getViewPositionUp(selection.positionLineNumber, selection.positionColumn, cursor.getLeftoverVisibleColumns(), 1);
+		var position = cursor.getViewPositionUp(selection.positionLineNumber, selection.positionColumn, cursor.getLeftoverVisibleColumns(), 1, false);
 		ctx.cursorPositionChangeReason = 'explicit';
 		cursor.moveViewPosition(true, position.lineNumber, position.column, position.leftoverVisibleColumns, true);
 
@@ -756,7 +773,7 @@ export class OneCursorOp {
 			viewEndColumn = viewEndMaxColumn;
 		} else {
 			// Expand selection with one more line down
-			let moveResult = cursor.getViewPositionDown(viewEndLineNumber, viewEndColumn, 0, 1);
+			let moveResult = cursor.getViewPositionDown(viewEndLineNumber, viewEndColumn, 0, 1, true);
 			viewEndLineNumber = moveResult.lineNumber;
 			viewEndColumn = cursor.getViewLineMaxColumn(viewEndLineNumber);
 		}
@@ -820,85 +837,128 @@ export class OneCursorOp {
 		return true;
 	}
 
-	public static line(cursor:OneCursor, inSelectionMode: boolean, position:EditorCommon.IPosition, viewPosition:EditorCommon.IPosition, ctx: IOneCursorOperationContext): boolean {
+	public static line(cursor:OneCursor, inSelectionMode: boolean, position:editorCommon.IPosition, viewPosition:editorCommon.IPosition, ctx: IOneCursorOperationContext): boolean {
 		// TODO@Alex -> select in editable range
 
-		var validatedPosition = cursor.validatePosition(position);
-		var validatedViewPosition: EditorCommon.IPosition;
-		if (viewPosition) {
-			validatedViewPosition = cursor.validateViewPosition(viewPosition.lineNumber, viewPosition.column, validatedPosition);
-		} else {
-			validatedViewPosition = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, validatedPosition.column);
-		}
-
-		var viewLineNumber:number, viewColumn:number;
+		let validatedPosition = cursor.validatePosition(position);
+		ctx.cursorPositionChangeReason = 'explicit';
+		ctx.shouldRevealHorizontal = false;
 
 		if (!inSelectionMode || !cursor.hasSelection()) {
-			var viewSelectionStartRange = new Range(validatedViewPosition.lineNumber, 1, validatedViewPosition.lineNumber, cursor.getViewLineMaxColumn(validatedViewPosition.lineNumber));
-			var r1 = cursor.convertViewToModelPosition(viewSelectionStartRange.startLineNumber, viewSelectionStartRange.startColumn);
-			var r2 = cursor.convertViewToModelPosition(viewSelectionStartRange.endLineNumber, viewSelectionStartRange.endColumn);
-			cursor.setSelectionStart(new Range(r1.lineNumber, r1.column, r2.lineNumber, r2.column), viewSelectionStartRange);
-			viewLineNumber = viewSelectionStartRange.endLineNumber;
-			viewColumn = viewSelectionStartRange.endColumn;
+			let nextLinePosition: editorCommon.IPosition;
+			if (validatedPosition.lineNumber === cursor.model.getLineCount()) {
+				nextLinePosition = {
+					lineNumber: validatedPosition.lineNumber,
+					column: cursor.model.getLineMaxColumn(validatedPosition.lineNumber)
+				};
+			} else {
+				nextLinePosition = {
+					lineNumber: validatedPosition.lineNumber + 1,
+					column: 1
+				};
+			}
+			let selectionStartRange = new Range(validatedPosition.lineNumber, 1, nextLinePosition.lineNumber, nextLinePosition.column);
+			let r1 = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, 1);
+			let r2 = cursor.convertModelPositionToViewPosition(nextLinePosition.lineNumber, nextLinePosition.column);
+			cursor.setSelectionStart(selectionStartRange, new Range(r1.lineNumber, r1.column, r2.lineNumber, r2.column));
+			cursor.moveModelPosition(cursor.hasSelection(), selectionStartRange.endLineNumber, selectionStartRange.endColumn, 0, false);
+			return true;
 		} else {
-			viewLineNumber = validatedViewPosition.lineNumber;
-			if (validatedPosition.isBeforeOrEqual(cursor.getSelectionStart().getStartPosition())) {
-				viewColumn = 1;
+			if (validatedPosition.lineNumber !== cursor.getSelectionStart().getStartPosition().lineNumber) {
+				let validatedViewPosition: editorCommon.IPosition;
+				if (viewPosition) {
+					validatedViewPosition = cursor.validateViewPosition(viewPosition.lineNumber, viewPosition.column, validatedPosition);
+				} else {
+					validatedViewPosition = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, validatedPosition.column);
+				}
+				let column = validatedViewPosition.column;
+				if (validatedViewPosition.lineNumber !== cursor.getViewLineCount() || validatedViewPosition.column !== cursor.getViewLineMaxColumn(validatedViewPosition.lineNumber)) {
+					column = 1;
+				}
+				cursor.moveViewPosition(cursor.hasSelection(), validatedViewPosition.lineNumber, column, 0, false);
 			} else {
-				viewColumn = cursor.getViewLineMaxColumn(viewLineNumber);
+				let column = validatedPosition.column;
+				if (validatedPosition.lineNumber !== cursor.model.getLineCount() || validatedPosition.column !== cursor.model.getLineMaxColumn(validatedPosition.lineNumber)) {
+					column = 1;
+				}
+				cursor.moveModelPosition(cursor.hasSelection(), validatedPosition.lineNumber, column, 0, false);
 			}
+
+			return true;
 		}
 
-		ctx.cursorPositionChangeReason = 'explicit';
-		ctx.shouldRevealHorizontal = false;
-		cursor.moveViewPosition(cursor.hasSelection(), viewLineNumber, viewColumn, 0, false);
-		return true;
 	}
 
-	public static word(cursor:OneCursor, inSelectionMode: boolean, position: EditorCommon.IPosition, preference: string, ctx: IOneCursorOperationContext): boolean {
+	public static word(cursor:OneCursor, inSelectionMode: boolean, position: editorCommon.IPosition, preference: string, ctx: IOneCursorOperationContext): boolean {
 		// TODO@Alex -> select in editable range
 
-		var validatedPosition = cursor.validatePosition(position);
-		var word = cursor.findWord(validatedPosition, preference);
-
-		var wordStartColumn:number, wordEndColumn:number;
-		var lineNumber:number, column:number;
+		let validatedPosition = cursor.validatePosition(position);
+		let prevWord = cursor.findPreviousWordOnLine(validatedPosition);
+		let isInPrevWord = (prevWord && prevWord.wordType === WordType.Regular && prevWord.start < validatedPosition.column - 1 && validatedPosition.column - 1 <= prevWord.end);
+		let nextWord = cursor.findNextWordOnLine(validatedPosition);
+		let isInNextWord = (nextWord && nextWord.wordType === WordType.Regular && nextWord.start < validatedPosition.column - 1 && validatedPosition.column - 1 <= nextWord.end);
 
+		let lineNumber: number;
+		let column: number;
 		if (!inSelectionMode || !cursor.hasSelection()) {
-			if (word) {
-				wordStartColumn = word.start + 1;
-				wordEndColumn = word.end + 1;
+
+			let startColumn: number;
+			let endColumn: number;
+
+			if (isInPrevWord) {
+				startColumn = prevWord.start + 1;
+				endColumn = prevWord.end + 1;
+			} else if (isInNextWord) {
+				startColumn = nextWord.start + 1;
+				endColumn = nextWord.end + 1;
 			} else {
-				var maxColumn = cursor.model.getLineMaxColumn(validatedPosition.lineNumber);
-				if (validatedPosition.column === maxColumn || preference === 'left') {
-					wordStartColumn = validatedPosition.column - 1;
-					wordEndColumn = validatedPosition.column;
+				if (prevWord) {
+					startColumn = prevWord.end + 1;
 				} else {
-					wordStartColumn = validatedPosition.column;
-					wordEndColumn = validatedPosition.column + 1;
-				}
-				if (wordStartColumn <= 1) {
-					wordStartColumn = 1;
+					startColumn = 1;
 				}
-				if (wordEndColumn >= maxColumn) {
-					wordEndColumn = maxColumn;
+				if (nextWord) {
+					endColumn = nextWord.start + 1;
+				} else {
+					endColumn = cursor.model.getLineMaxColumn(validatedPosition.lineNumber);
 				}
 			}
 
-			var selectionStartRange = new Range(validatedPosition.lineNumber, wordStartColumn, validatedPosition.lineNumber, wordEndColumn);
-			var r1 = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, wordStartColumn);
-			var r2 = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, wordEndColumn);
+			let selectionStartRange = new Range(validatedPosition.lineNumber, startColumn, validatedPosition.lineNumber, endColumn);
+			let r1 = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, startColumn);
+			let r2 = cursor.convertModelPositionToViewPosition(validatedPosition.lineNumber, endColumn);
 			cursor.setSelectionStart(selectionStartRange, new Range(r1.lineNumber, r1.column, r2.lineNumber, r2.column));
 			lineNumber = selectionStartRange.endLineNumber;
 			column = selectionStartRange.endColumn;
 		} else {
-			wordStartColumn = word ? word.start + 1 : validatedPosition.column;
-			wordEndColumn = word ? word.end + 1 : validatedPosition.column;
+
+			let startColumn: number;
+			let endColumn: number;
+
+			if (isInPrevWord) {
+				startColumn = prevWord.start + 1;
+				endColumn = prevWord.end + 1;
+			} else if (isInNextWord) {
+				startColumn = nextWord.start + 1;
+				endColumn = nextWord.end + 1;
+			} else {
+				startColumn = validatedPosition.column;
+				endColumn = validatedPosition.column;
+			}
+
 			lineNumber = validatedPosition.lineNumber;
 			if (validatedPosition.isBeforeOrEqual(cursor.getSelectionStart().getStartPosition())) {
-				column = wordStartColumn;
+				column = startColumn;
+				let possiblePosition = new Position(lineNumber, column);
+				if (cursor.getSelectionStart().containsPosition(possiblePosition)) {
+					column = cursor.getSelectionStart().endColumn;
+				}
 			} else {
-				column = wordEndColumn;
+				column = endColumn;
+				let possiblePosition = new Position(lineNumber, column);
+				if (cursor.getSelectionStart().containsPosition(possiblePosition)) {
+					column = cursor.getSelectionStart().startColumn;
+				}
 			}
 		}
 
@@ -954,7 +1014,7 @@ export class OneCursorOp {
 		return this._enter(cursor, true, ctx);
 	}
 
-	private static _enter(cursor:OneCursor, keepPosition: boolean, ctx: IOneCursorOperationContext, position?: EditorCommon.IEditorPosition, range?: EditorCommon.IEditorRange): boolean {
+	private static _enter(cursor:OneCursor, keepPosition: boolean, ctx: IOneCursorOperationContext, position?: editorCommon.IEditorPosition, range?: editorCommon.IEditorRange): boolean {
 		if (typeof position === 'undefined') {
 			position = cursor.getPosition();
 		}
@@ -1065,7 +1125,7 @@ export class OneCursorOp {
 		try {
 			shouldAutoClosePair = richEditSupport.characterPair.shouldAutoClosePair(ch, lineContext, position.column - 1);
 		} catch(e) {
-			Errors.onUnexpectedError(e);
+			onUnexpectedError(e);
 		}
 
 		if (!shouldAutoClosePair) {
@@ -1151,7 +1211,7 @@ export class OneCursorOp {
 			try {
 				electricAction = richEditSupport.electricCharacter.onElectricCharacter(lineContext, position.column - 2);
 			} catch(e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 			}
 		}
 
@@ -1166,7 +1226,7 @@ export class OneCursorOp {
 				if (match) {
 					var matchLineNumber = match.startLineNumber;
 					var matchLine = cursor.model.getLineContent(matchLineNumber);
-					var matchLineIndentation = Strings.getLeadingWhitespace(matchLine);
+					var matchLineIndentation = strings.getLeadingWhitespace(matchLine);
 					var newIndentation = cursor.configuration.normalizeIndentation(matchLineIndentation);
 
 					var lineFirstNonBlankColumn = cursor.model.getLineFirstNonWhitespaceColumn(position.lineNumber) || position.column;
@@ -1192,7 +1252,7 @@ export class OneCursorOp {
 		}
 	}
 
-	public static actualType(cursor:OneCursor, text: string, keepPosition: boolean, ctx: IOneCursorOperationContext, range?: EditorCommon.IEditorRange): boolean {
+	public static actualType(cursor:OneCursor, text: string, keepPosition: boolean, ctx: IOneCursorOperationContext, range?: editorCommon.IEditorRange): boolean {
 		if (typeof range === 'undefined') {
 			range = cursor.getSelection();
 		}
@@ -1231,7 +1291,7 @@ export class OneCursorOp {
 
 	public static replacePreviousChar(cursor:OneCursor, txt: string, replaceCharCnt:number, ctx: IOneCursorOperationContext): boolean {
 		let pos = cursor.getPosition();
-		let range: EditorCommon.IEditorRange;
+		let range: editorCommon.IEditorRange;
 		let startColumn = Math.max(1, pos.column - replaceCharCnt);
 		range = new Range(pos.lineNumber, startColumn, pos.lineNumber, pos.column);
 		ctx.executeCommand = new ReplaceCommand(range, txt);
@@ -1243,7 +1303,7 @@ export class OneCursorOp {
 
 		for (lastLineNumber = lineNumber - 1; lastLineNumber >= 1; lastLineNumber--) {
 			var lineText = cursor.model.getLineContent(lastLineNumber);
-			var nonWhitespaceIdx = Strings.lastNonWhitespaceIndex(lineText);
+			var nonWhitespaceIdx = strings.lastNonWhitespaceIndex(lineText);
 			if (nonWhitespaceIdx >= 0) {
 				break;
 			}
@@ -1400,7 +1460,7 @@ export class OneCursorOp {
 			return true;
 		}
 
-		var deleteSelection: EditorCommon.IEditorRange = cursor.getSelection();
+		var deleteSelection: editorCommon.IEditorRange = cursor.getSelection();
 
 		if (deleteSelection.isEmpty()) {
 			var position = cursor.getPosition();
@@ -1426,38 +1486,61 @@ export class OneCursorOp {
 		return true;
 	}
 
+	private static _findLastNonWhitespaceChar(str:string, startIndex:number): number {
+		for (let chIndex = startIndex; chIndex >= 0; chIndex--) {
+			let ch = str.charAt(chIndex);
+			if (ch !== ' ' && ch !== '\t') {
+				return chIndex;
+			}
+		}
+		return -1;
+	}
+
+	private static deleteWordLeftWhitespace(cursor:OneCursor, ctx: IOneCursorOperationContext): boolean {
+		let position = cursor.getPosition();
+		let lineContent = cursor.getLineContent(position.lineNumber);
+		let startIndex = position.column - 2;
+		let lastNonWhitespace = this._findLastNonWhitespaceChar(lineContent, startIndex);
+		if (lastNonWhitespace + 1 < startIndex) {
+			// bingo
+			ctx.executeCommand = new ReplaceCommand(new Range(position.lineNumber, lastNonWhitespace + 2, position.lineNumber, position.column), '');
+			return true;
+		}
+		return false;
+	}
+
 	public static deleteWordLeft(cursor:OneCursor, ctx: IOneCursorOperationContext): boolean {
 		if (this._autoClosingPairDelete(cursor, ctx)) {
 			// This was a case for an auto-closing pair delete
 			return true;
 		}
 
-		var selection = cursor.getSelection();
+		let selection = cursor.getSelection();
 
 		if (selection.isEmpty()) {
 			let position = cursor.getPosition();
 
-			var lineNumber = position.lineNumber;
-			var column = position.column;
+			let lineNumber = position.lineNumber;
+			let column = position.column;
 
 			if (lineNumber === 1 && column === 1) {
 				// Ignore deleting at beginning of file
 				return true;
 			}
 
-			// extend selection to the left until start of word
-			var word = cursor.findWord(position, 'left', true);
-			if (word) {
-				if (word.end + 1 < column) {
-					column = word.end + 1;
-				} else {
-					column = word.start + 1;
-				}
+			if (this.deleteWordLeftWhitespace(cursor, ctx)) {
+				return true;
+			}
+
+			let prevWordOnLine = cursor.findPreviousWordOnLine(position);
+
+			if (prevWordOnLine) {
+				column = prevWordOnLine.start + 1;
 			} else {
 				column = 1;
 			}
 
-			var deleteSelection = new Range(lineNumber, column, lineNumber, position.column);
+			let deleteSelection = new Range(lineNumber, column, lineNumber, position.column);
 			if (!deleteSelection.isEmpty()) {
 				ctx.executeCommand = new ReplaceCommand(deleteSelection, '');
 				return true;
@@ -1469,7 +1552,7 @@ export class OneCursorOp {
 
 	public static deleteRight(cursor:OneCursor, ctx: IOneCursorOperationContext): boolean {
 
-		var deleteSelection: EditorCommon.IEditorRange = cursor.getSelection();
+		var deleteSelection: editorCommon.IEditorRange = cursor.getSelection();
 
 		if (deleteSelection.isEmpty()) {
 			let position = cursor.getPosition();
@@ -1495,6 +1578,30 @@ export class OneCursorOp {
 		return true;
 	}
 
+	private static _findFirstNonWhitespaceChar(str:string, startIndex:number): number {
+		let len = str.length;
+		for (let chIndex = startIndex; chIndex < len; chIndex++) {
+			let ch = str.charAt(chIndex);
+			if (ch !== ' ' && ch !== '\t') {
+				return chIndex;
+			}
+		}
+		return len;
+	}
+
+	private static deleteWordRightWhitespace(cursor:OneCursor, ctx: IOneCursorOperationContext): boolean {
+		let position = cursor.getPosition();
+		let lineContent = cursor.getLineContent(position.lineNumber);
+		let startIndex = position.column - 1;
+		let firstNonWhitespace = this._findFirstNonWhitespaceChar(lineContent, startIndex);
+		if (startIndex + 1 < firstNonWhitespace) {
+			// bingo
+			ctx.executeCommand = new ReplaceCommand(new Range(position.lineNumber, position.column, position.lineNumber, firstNonWhitespace + 1), '');
+			return true;
+		}
+		return false;
+	}
+
 	public static deleteWordRight(cursor:OneCursor, ctx: IOneCursorOperationContext): boolean {
 
 		var selection = cursor.getSelection();
@@ -1512,15 +1619,16 @@ export class OneCursorOp {
 				return true;
 			}
 
-			var word = cursor.findWord(new Position(lineNumber, column), 'right', true);
-			if (word) {
-				if (word.start + 1 > column) {
-					column = word.start + 1;
-				} else {
-					column = word.end + 1;
-				}
+			if (this.deleteWordRightWhitespace(cursor, ctx)) {
+				return true;
+			}
+
+			let nextWordOnLine = cursor.findNextWordOnLine(position);
+
+			if (nextWordOnLine) {
+				column = nextWordOnLine.end + 1;
 			} else {
-				column = maxColumn;
+				column = 1;
 			}
 
 			var deleteSelection = new Range(lineNumber, column, lineNumber, position.column);
@@ -1644,30 +1752,30 @@ export class OneCursorOp {
 }
 
 class CursorHelper {
-	private model:EditorCommon.IModel;
-	private configuration:EditorCommon.IConfiguration;
+	private model:editorCommon.IModel;
+	private configuration:editorCommon.IConfiguration;
 	private moveHelper:CursorMoveHelper;
 
-	constructor (model:EditorCommon.IModel, configuration:EditorCommon.IConfiguration) {
+	constructor (model:editorCommon.IModel, configuration:editorCommon.IConfiguration) {
 		this.model = model;
 		this.configuration = configuration;
 		this.moveHelper = new CursorMoveHelper(this.configuration);
 	}
 
-	public getLeftOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
+	public getLeftOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): editorCommon.IPosition {
 		return this.moveHelper.getLeftOfPosition(model, lineNumber, column);
 	}
 
-	public getRightOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): EditorCommon.IPosition {
+	public getRightOfPosition(model:ICursorMoveHelperModel, lineNumber:number, column:number): editorCommon.IPosition {
 		return this.moveHelper.getRightOfPosition(model, lineNumber, column);
 	}
 
-	public getPositionUp(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.moveHelper.getPositionUp(model, lineNumber, column, leftoverVisibleColumns, count);
+	public getPositionUp(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnFirstLine:boolean): IMoveResult {
+		return this.moveHelper.getPositionUp(model, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnFirstLine);
 	}
 
-	public getPositionDown(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number): IMoveResult {
-		return this.moveHelper.getPositionDown(model, lineNumber, column, leftoverVisibleColumns, count);
+	public getPositionDown(model:ICursorMoveHelperModel, lineNumber:number, column:number, leftoverVisibleColumns:number, count:number, allowMoveOnLastLine:boolean): IMoveResult {
+		return this.moveHelper.getPositionDown(model, lineNumber, column, leftoverVisibleColumns, count, allowMoveOnLastLine);
 	}
 
 	public getColumnAtBeginningOfLine(model:ICursorMoveHelperModel, lineNumber:number, column:number): number {
@@ -1692,57 +1800,220 @@ class CursorHelper {
 		return CursorMoveHelper.prevTabColumn(column, this.configuration.getIndentationOptions().tabSize);
 	}
 
-	public findWord(position:EditorCommon.IEditorPosition, preference:string, skipSyntaxTokens:boolean=false): EditorCommon.IWordRange {
-		var words = this.model.getWords(position.lineNumber);
-		var searchIndex:number, i:number, len:number;
-
-		if (skipSyntaxTokens) {
-			searchIndex = position.column - 1;
-			if (preference === 'left') {
-				for (i = words.length - 1; i >= 0; i--) {
-					if (words[i].start >= searchIndex) {
-						continue;
-					}
-					return words[i];
-				}
-			} else {
-				for (i = 0, len = words.length; i < len; i++) {
-					if (words[i].end <= searchIndex) {
-						continue;
-					}
-					return words[i];
+	// public findWord(position:editorCommon.IEditorPosition, preference:string, skipSyntaxTokens:boolean=false): editorCommon.IWordRange {
+	// 	var words = this.model.getWords(position.lineNumber);
+	// 	var searchIndex:number, i:number, len:number;
+
+	// 	if (skipSyntaxTokens) {
+	// 		searchIndex = position.column - 1;
+	// 		if (preference === 'left') {
+	// 			for (i = words.length - 1; i >= 0; i--) {
+	// 				if (words[i].start >= searchIndex) {
+	// 					continue;
+	// 				}
+	// 				return words[i];
+	// 			}
+	// 		} else {
+	// 			for (i = 0, len = words.length; i < len; i++) {
+	// 				if (words[i].end <= searchIndex) {
+	// 					continue;
+	// 				}
+	// 				return words[i];
+	// 			}
+	// 		}
+	// 	} else {
+	// 		searchIndex = position.column;
+	// 		if (preference === 'left') {
+	// 			if (searchIndex !== 1) {
+	// 				searchIndex = searchIndex - 0.1;
+	// 			}
+	// 		} else {
+	// 			if (searchIndex !== this.model.getLineMaxColumn(position.lineNumber)) {
+	// 				searchIndex = searchIndex + 0.1;
+	// 			}
+	// 		}
+	// 		searchIndex = searchIndex - 1;
+
+	// 		for (i = 0, len = words.length; i < len; i++) {
+	// 			if (words[i].start <= searchIndex && searchIndex <= words[i].end) {
+	// 				return words[i];
+	// 			}
+	// 		}
+	// 	}
+
+	// 	return null;
+	// }
+
+	private _createWord(lineContent: string, wordType:WordType, start: number, end: number): IFindWordResult {
+		// console.log('WORD ==> ' + start + ' => ' + end + ':::: <<<' + lineContent.substring(start, end) + '>>>');
+		return { start: start, end: end, wordType: wordType };
+	}
+
+	public findPreviousWordOnLine(_position:editorCommon.IEditorPosition): IFindWordResult {
+		let position = this.model.validatePosition(_position);
+		let wordSeparators = getMapForWordSeparators(this.configuration.editor.wordSeparators);
+		let lineContent = this.model.getLineContent(position.lineNumber);
+		let wordType = W_NONE;
+		for (let chIndex = position.column - 2; chIndex >= 0; chIndex--) {
+			let chCode = lineContent.charCodeAt(chIndex);
+			let chClass:CharacterClass = (wordSeparators[chCode] || CharacterClass.Regular);
+
+			if (chClass === CH_REGULAR) {
+				if (wordType === W_SEPARATOR) {
+					return this._createWord(lineContent, wordType, chIndex + 1, this._findEndOfWord(lineContent, wordSeparators, wordType, chIndex + 1));
 				}
-			}
-		} else {
-			searchIndex = position.column;
-			if (preference === 'left') {
-				if (searchIndex !== 1) {
-					searchIndex = searchIndex - 0.1;
+				wordType = W_REGULAR;
+			} else if (chClass === CH_WORD_SEPARATOR) {
+				if (wordType === W_REGULAR) {
+					return this._createWord(lineContent, wordType, chIndex + 1, this._findEndOfWord(lineContent, wordSeparators, wordType, chIndex + 1));
 				}
-			} else {
-				if (searchIndex !== this.model.getLineMaxColumn(position.lineNumber)) {
-					searchIndex = searchIndex + 0.1;
+				wordType = W_SEPARATOR;
+			} else if (chClass === CH_WHITESPACE) {
+				if (wordType !== W_NONE) {
+					return this._createWord(lineContent, wordType, chIndex + 1, this._findEndOfWord(lineContent, wordSeparators, wordType, chIndex + 1));
 				}
 			}
-			searchIndex = searchIndex - 1;
+		}
+
+		if (wordType !== W_NONE) {
+			return this._createWord(lineContent, wordType, 0, this._findEndOfWord(lineContent, wordSeparators, wordType, 0));
+		}
+
+		return null;
+	}
+
+	private _findEndOfWord(lineContent:string, wordSeparators:CharacterClass[], wordType:WordType, startIndex:number): number {
+		let len = lineContent.length;
+		for (let chIndex = startIndex; chIndex < len; chIndex++) {
+			let chCode = lineContent.charCodeAt(chIndex);
+			let chClass:CharacterClass = (wordSeparators[chCode] || CharacterClass.Regular);
+
+			if (chClass === CH_WHITESPACE) {
+				return chIndex;
+			}
+			if (wordType === W_REGULAR && chClass === CH_WORD_SEPARATOR) {
+				return chIndex;
+			}
+			if (wordType === W_SEPARATOR && chClass === CH_REGULAR) {
+				return chIndex;
+			}
+		}
+		return len;
+	}
+
+	public findNextWordOnLine(_position:editorCommon.IEditorPosition): IFindWordResult {
+		let position = this.model.validatePosition(_position);
+		let wordSeparators = getMapForWordSeparators(this.configuration.editor.wordSeparators);
+		let lineContent = this.model.getLineContent(position.lineNumber);
+		let wordType = W_NONE;
+		let len = lineContent.length;
 
-			for (i = 0, len = words.length; i < len; i++) {
-				if (words[i].start <= searchIndex && searchIndex <= words[i].end) {
-					return words[i];
+		for (let chIndex = position.column - 1; chIndex < len; chIndex++) {
+			let chCode = lineContent.charCodeAt(chIndex);
+			let chClass:CharacterClass = (wordSeparators[chCode] || CharacterClass.Regular);
+
+			if (chClass === CH_REGULAR) {
+				if (wordType === W_SEPARATOR) {
+					return this._createWord(lineContent, wordType, this._findStartOfWord(lineContent, wordSeparators, wordType, chIndex - 1), chIndex);
+				}
+				wordType = W_REGULAR;
+			} else if (chClass === CH_WORD_SEPARATOR) {
+				if (wordType === W_REGULAR) {
+					return this._createWord(lineContent, wordType, this._findStartOfWord(lineContent, wordSeparators, wordType, chIndex - 1), chIndex);
+				}
+				wordType = W_SEPARATOR;
+			} else if (chClass === CH_WHITESPACE) {
+				if (wordType !== W_NONE) {
+					return this._createWord(lineContent, wordType, this._findStartOfWord(lineContent, wordSeparators, wordType, chIndex - 1), chIndex);
 				}
 			}
 		}
 
+		if (wordType !== W_NONE) {
+			return this._createWord(lineContent, wordType, this._findStartOfWord(lineContent, wordSeparators, wordType, len - 1), len);
+		}
+
 		return null;
 	}
+
+	private _findStartOfWord(lineContent:string, wordSeparators:CharacterClass[], wordType:WordType, startIndex:number): number {
+		for (let chIndex = startIndex; chIndex >= 0; chIndex--) {
+			let chCode = lineContent.charCodeAt(chIndex);
+			let chClass:CharacterClass = (wordSeparators[chCode] || CharacterClass.Regular);
+
+			if (chClass === CH_WHITESPACE) {
+				return chIndex + 1;
+			}
+			if (wordType === W_REGULAR && chClass === CH_WORD_SEPARATOR) {
+				return chIndex + 1;
+			}
+			if (wordType === W_SEPARATOR && chClass === CH_REGULAR) {
+				return chIndex + 1;
+			}
+		}
+		return 0;
+	}
 }
 
+export enum WordType {
+	None = 0,
+	Regular = 1,
+	Separator = 2
+};
+
+enum CharacterClass {
+	Regular = 0,
+	Whitespace = 1,
+	WordSeparator = 2
+};
+
+const CH_REGULAR = CharacterClass.Regular;
+const CH_WHITESPACE = CharacterClass.Whitespace;
+const CH_WORD_SEPARATOR = CharacterClass.WordSeparator;
+
+const W_NONE = WordType.None;
+const W_REGULAR = WordType.Regular;
+const W_SEPARATOR = WordType.Separator;
+
+function once<T, R>(keyFn:(input:T)=>string, computeFn:(input:T)=>R):(input:T)=>R {
+	let cache: {[key:string]:R;} = {};
+	return (input:T):R => {
+		let key = keyFn(input);
+		if (!cache.hasOwnProperty(key)) {
+			cache[key] = computeFn(input);
+		}
+		return cache[key];
+	};
+}
+
+var getMapForWordSeparators = once<string,CharacterClass[]>(
+	(input) => input,
+	(input) => {
+
+		let r:CharacterClass[] = [];
+
+		// Make array fast for ASCII text
+		for (let chCode = 0; chCode < 256; chCode++) {
+			r[chCode] = CharacterClass.Regular;
+		}
+
+		for (let i = 0, len = input.length; i < len; i++) {
+			r[input.charCodeAt(i)] = CharacterClass.WordSeparator;
+		}
+
+		r[' '.charCodeAt(0)] = CharacterClass.Whitespace;
+		r['\t'.charCodeAt(0)] = CharacterClass.Whitespace;
+
+		return r;
+	}
+);
+
 class Utils {
 
 	/**
 	 * Range contains position (including edges)?
 	 */
-	static rangeContainsPosition(range:EditorCommon.IRange, position:EditorCommon.IPosition): boolean {
+	static rangeContainsPosition(range:editorCommon.IRange, position:editorCommon.IPosition): boolean {
 		if (position.lineNumber < range.startLineNumber || position.lineNumber > range.endLineNumber) {
 			return false;
 		}
@@ -1759,7 +2030,7 @@ class Utils {
 	 * Tests if position is contained inside range.
 	 * If position is either the starting or ending of a range, false is returned.
 	 */
-	static isPositionInsideRange(position:EditorCommon.IPosition, range:EditorCommon.IRange): boolean {
+	static isPositionInsideRange(position:editorCommon.IPosition, range:editorCommon.IRange): boolean {
 		if (position.lineNumber < range.startLineNumber) {
 			return false;
 		}
@@ -1775,7 +2046,7 @@ class Utils {
 		return true;
 	}
 
-	static isPositionAtRangeEdges(position:EditorCommon.IPosition, range:EditorCommon.IRange): boolean {
+	static isPositionAtRangeEdges(position:editorCommon.IPosition, range:editorCommon.IRange): boolean {
 		if (position.lineNumber === range.startLineNumber && position.column === range.startColumn) {
 			return true;
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/textAreaHandler.ts
code:
@@ -4,17 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IEditorRange, IEditorPosition, EndOfLinePreference} from 'vs/editor/common/editorCommon';
 import {RunOnceScheduler} from 'vs/base/common/async';
+import Event, {Emitter} from 'vs/base/common/event';
+import {CommonKeybindings} from 'vs/base/common/keyCodes';
 import {Disposable} from 'vs/base/common/lifecycle';
-import {Range} from 'vs/editor/common/core/range';
+import {IClipboardEvent, IKeyboardEventWrapper, ISimpleModel, ITextAreaWrapper, ITypeData, TextAreaState, TextAreaStrategy, createTextAreaState} from 'vs/editor/common/controller/textAreaState';
 import {Position} from 'vs/editor/common/core/position';
-import {CommonKeybindings} from 'vs/base/common/keyCodes';
-import {
-	IKeyboardEventWrapper, ITextAreaWrapper, IClipboardEvent, ISimpleModel,
-	TextAreaState, createTextAreaState, ITypeData, TextAreaStrategy
-} from 'vs/editor/common/controller/textAreaState';
-import Event, {Emitter} from 'vs/base/common/event';
+import {Range} from 'vs/editor/common/core/range';
+import {EndOfLinePreference, IEditorPosition, IEditorRange} from 'vs/editor/common/editorCommon';
 
 enum ReadFromTextArea {
 	Type,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/controller/textAreaState.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as EditorCommon from 'vs/editor/common/editorCommon';
-import {Range} from 'vs/editor/common/core/range';
 import Event from 'vs/base/common/event';
 import {commonPrefixLength, commonSuffixLength} from 'vs/base/common/strings';
+import {Range} from 'vs/editor/common/core/range';
+import {EndOfLinePreference, IEditorPosition, IEditorRange, IRange} from 'vs/editor/common/editorCommon';
 
 export interface IClipboardEvent {
 	canUseTextData(): boolean;
@@ -45,10 +45,10 @@ export interface ITextAreaWrapper {
 export interface ISimpleModel {
 	getLineMaxColumn(lineNumber:number): number;
 	getEOL(): string;
-	getValueInRange(range:EditorCommon.IRange, eol:EditorCommon.EndOfLinePreference): string;
+	getValueInRange(range:IRange, eol:EndOfLinePreference): string;
 	getModelLineContent(lineNumber:number): string;
 	getLineCount(): number;
-	convertViewPositionToModelPosition(viewLineNumber:number, viewColumn:number): EditorCommon.IEditorPosition;
+	convertViewPositionToModelPosition(viewLineNumber:number, viewColumn:number): IEditorPosition;
 }
 
 export interface ITypeData {
@@ -101,7 +101,7 @@ export abstract class TextAreaState {
 
 	public abstract fromTextArea(textArea:ITextAreaWrapper): TextAreaState;
 
-	public abstract fromEditorSelection(model:ISimpleModel, selection:EditorCommon.IEditorRange);
+	public abstract fromEditorSelection(model:ISimpleModel, selection:IEditorRange);
 
 	public abstract fromText(text:string): TextAreaState;
 
@@ -249,7 +249,7 @@ export class IENarratorTextAreaState extends TextAreaState {
 		return new IENarratorTextAreaState(this, textArea.getValue(), textArea.getSelectionStart(), textArea.getSelectionEnd(), textArea.isInOverwriteMode(), this.selectionToken);
 	}
 
-	public fromEditorSelection(model:ISimpleModel, selection:EditorCommon.IEditorRange): TextAreaState {
+	public fromEditorSelection(model:ISimpleModel, selection:IEditorRange): TextAreaState {
 		let LIMIT_CHARS = 100;
 		let PADDING_LINES_COUNT = 0;
 
@@ -269,9 +269,9 @@ export class IENarratorTextAreaState extends TextAreaState {
 		let pretext = '';
 		let startLineNumber = Math.max(1, selectionStartLineNumber - PADDING_LINES_COUNT);
 		if (startLineNumber < selectionStartLineNumber) {
-			pretext = model.getValueInRange(new Range(startLineNumber, 1, selectionStartLineNumber, 1), EditorCommon.EndOfLinePreference.LF);
+			pretext = model.getValueInRange(new Range(startLineNumber, 1, selectionStartLineNumber, 1), EndOfLinePreference.LF);
 		}
-		pretext += model.getValueInRange(new Range(selectionStartLineNumber, 1, selectionStartLineNumber, selectionStartColumn), EditorCommon.EndOfLinePreference.LF);
+		pretext += model.getValueInRange(new Range(selectionStartLineNumber, 1, selectionStartLineNumber, selectionStartColumn), EndOfLinePreference.LF);
 		if (pretext.length > LIMIT_CHARS) {
 			pretext = pretext.substring(pretext.length - LIMIT_CHARS, pretext.length);
 		}
@@ -280,17 +280,17 @@ export class IENarratorTextAreaState extends TextAreaState {
 		// `posttext` contains the text after the selection
 		let posttext = '';
 		let endLineNumber = Math.min(selectionEndLineNumber + PADDING_LINES_COUNT, model.getLineCount());
-		posttext += model.getValueInRange(new Range(selectionEndLineNumber, selectionEndColumn, selectionEndLineNumber, selectionEndLineNumberMaxColumn), EditorCommon.EndOfLinePreference.LF);
+		posttext += model.getValueInRange(new Range(selectionEndLineNumber, selectionEndColumn, selectionEndLineNumber, selectionEndLineNumberMaxColumn), EndOfLinePreference.LF);
 		if (endLineNumber > selectionEndLineNumber) {
-			posttext = '\n' + model.getValueInRange(new Range(selectionEndLineNumber + 1, 1, endLineNumber, model.getLineMaxColumn(endLineNumber)), EditorCommon.EndOfLinePreference.LF);
+			posttext = '\n' + model.getValueInRange(new Range(selectionEndLineNumber + 1, 1, endLineNumber, model.getLineMaxColumn(endLineNumber)), EndOfLinePreference.LF);
 		}
 		if (posttext.length > LIMIT_CHARS) {
 			posttext = posttext.substring(0, LIMIT_CHARS);
 		}
 
 
 		// `text` contains the text of the selection
-		let text = model.getValueInRange(new Range(selectionStartLineNumber, selectionStartColumn, selectionEndLineNumber, selectionEndColumn), EditorCommon.EndOfLinePreference.LF);
+		let text = model.getValueInRange(new Range(selectionStartLineNumber, selectionStartColumn, selectionEndLineNumber, selectionEndColumn), EndOfLinePreference.LF);
 		if (text.length > 2 * LIMIT_CHARS) {
 			text = text.substring(0, LIMIT_CHARS) + String.fromCharCode(8230) + text.substring(text.length - LIMIT_CHARS, text.length);
 		}
@@ -361,7 +361,7 @@ export class NVDAPagedTextAreaState extends TextAreaState {
 		return new Range(startLineNumber, 1, endLineNumber, Number.MAX_VALUE);
 	}
 
-	public fromEditorSelection(model:ISimpleModel, selection:EditorCommon.IEditorRange): TextAreaState {
+	public fromEditorSelection(model:ISimpleModel, selection:IEditorRange): TextAreaState {
 
 		let selectionStartPage = NVDAPagedTextAreaState._getPageOfLine(selection.startLineNumber);
 		let selectionStartPageRange = NVDAPagedTextAreaState._getRangeForPage(selectionStartPage);
@@ -370,24 +370,24 @@ export class NVDAPagedTextAreaState extends TextAreaState {
 		let selectionEndPageRange = NVDAPagedTextAreaState._getRangeForPage(selectionEndPage);
 
 		let pretextRange = selectionStartPageRange.intersectRanges(new Range(1, 1, selection.startLineNumber, selection.startColumn));
-		let pretext = model.getValueInRange(pretextRange, EditorCommon.EndOfLinePreference.LF);
+		let pretext = model.getValueInRange(pretextRange, EndOfLinePreference.LF);
 
 		let lastLine = model.getLineCount();
 		let lastLineMaxColumn = model.getLineMaxColumn(lastLine);
 		let posttextRange = selectionEndPageRange.intersectRanges(new Range(selection.endLineNumber, selection.endColumn, lastLine, lastLineMaxColumn));
-		let posttext = model.getValueInRange(posttextRange, EditorCommon.EndOfLinePreference.LF);
+		let posttext = model.getValueInRange(posttextRange, EndOfLinePreference.LF);
 
 		let text:string = null;
 		if (selectionStartPage <= selectionEndPage) {
 			// take full selection
-			text = model.getValueInRange(selection, EditorCommon.EndOfLinePreference.LF);
+			text = model.getValueInRange(selection, EndOfLinePreference.LF);
 		} else {
 			let selectionRange1 = selectionStartPageRange.intersectRanges(selection);
 			let selectionRange2 = selectionEndPageRange.intersectRanges(selection);
 			text = (
-				model.getValueInRange(selectionRange1, EditorCommon.EndOfLinePreference.LF)
+				model.getValueInRange(selectionRange1, EndOfLinePreference.LF)
 				+ String.fromCharCode(8230)
-				+ model.getValueInRange(selectionRange2, EditorCommon.EndOfLinePreference.LF)
+				+ model.getValueInRange(selectionRange2, EndOfLinePreference.LF)
 			);
 		}
 
@@ -446,12 +446,12 @@ export class NVDAFullTextAreaState extends TextAreaState {
 		return new NVDAFullTextAreaState(this, textArea.getValue(), textArea.getSelectionStart(), textArea.getSelectionEnd(), textArea.isInOverwriteMode());
 	}
 
-	public fromEditorSelection(model:ISimpleModel, selection:EditorCommon.IEditorRange): TextAreaState {
-		let pretext = model.getValueInRange(new Range(1, 1, selection.startLineNumber, selection.startColumn), EditorCommon.EndOfLinePreference.LF);
-		let text = model.getValueInRange(selection, EditorCommon.EndOfLinePreference.LF);
+	public fromEditorSelection(model:ISimpleModel, selection:IEditorRange): TextAreaState {
+		let pretext = model.getValueInRange(new Range(1, 1, selection.startLineNumber, selection.startColumn), EndOfLinePreference.LF);
+		let text = model.getValueInRange(selection, EndOfLinePreference.LF);
 		let lastLine = model.getLineCount();
 		let lastLineMaxColumn = model.getLineMaxColumn(lastLine);
-		let posttext = model.getValueInRange(new Range(selection.endLineNumber, selection.endColumn, lastLine, lastLineMaxColumn), EditorCommon.EndOfLinePreference.LF);
+		let posttext = model.getValueInRange(new Range(selection.endLineNumber, selection.endColumn, lastLine, lastLineMaxColumn), EndOfLinePreference.LF);
 
 		return new NVDAFullTextAreaState(this, pretext + text + posttext, pretext.length, pretext.length + text.length, false);
 	}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/core/editOperation.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {Range} from 'vs/editor/common/core/range';
+import {IEditorPosition, IEditorRange, IIdentifiedSingleEditOperation} from 'vs/editor/common/editorCommon';
 
 export class EditOperation {
 
-	public static insert(position:EditorCommon.IEditorPosition, text:string): EditorCommon.IIdentifiedSingleEditOperation {
+	public static insert(position:IEditorPosition, text:string): IIdentifiedSingleEditOperation {
 		return {
 			identifier: null,
 			range: new Range(position.lineNumber, position.column, position.lineNumber, position.column),
@@ -18,7 +18,7 @@ export class EditOperation {
 		};
 	}
 
-	public static delete(range:EditorCommon.IEditorRange): EditorCommon.IIdentifiedSingleEditOperation {
+	public static delete(range:IEditorRange): IIdentifiedSingleEditOperation {
 		return {
 			identifier: null,
 			range: range,
@@ -27,7 +27,7 @@ export class EditOperation {
 		};
 	}
 
-	public static replace(range:EditorCommon.IEditorRange, text:string): EditorCommon.IIdentifiedSingleEditOperation {
+	public static replace(range:IEditorRange, text:string): IIdentifiedSingleEditOperation {
 		return {
 			identifier: null,
 			range: range,
@@ -36,7 +36,7 @@ export class EditOperation {
 		};
 	}
 
-	public static replaceMove(range:EditorCommon.IEditorRange, text:string): EditorCommon.IIdentifiedSingleEditOperation {
+	public static replaceMove(range:IEditorRange, text:string): IIdentifiedSingleEditOperation {
 		return {
 			identifier: null,
 			range: range,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/core/editorState.ts
code:
@@ -4,35 +4,35 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Strings = require('vs/base/common/strings');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as strings from 'vs/base/common/strings';
+import {CodeEditorStateFlag, ICodeEditorState, ICommonCodeEditor, IEditorPosition, IEditorRange} from 'vs/editor/common/editorCommon';
 
-export class EditorState implements EditorCommon.ICodeEditorState {
+export class EditorState implements ICodeEditorState {
 
-	private flags:EditorCommon.CodeEditorStateFlag[];
+	private flags:CodeEditorStateFlag[];
 
-	private position:EditorCommon.IEditorPosition;
-	private selection:EditorCommon.IEditorRange;
+	private position:IEditorPosition;
+	private selection:IEditorRange;
 	private modelVersionId:string;
 	private scrollLeft:number;
 	private scrollTop:number;
 
-	constructor(editor:EditorCommon.ICommonCodeEditor, flags:EditorCommon.CodeEditorStateFlag[]) {
+	constructor(editor:ICommonCodeEditor, flags:CodeEditorStateFlag[]) {
 		this.flags = flags;
 
 		flags.forEach((flag) => {
 			switch(flag) {
-				case EditorCommon.CodeEditorStateFlag.Value:
+				case CodeEditorStateFlag.Value:
 					var model = editor.getModel();
-					this.modelVersionId = model ? Strings.format('{0}#{1}', model.getAssociatedResource().toString(), model.getVersionId()) : null;
+					this.modelVersionId = model ? strings.format('{0}#{1}', model.getAssociatedResource().toString(), model.getVersionId()) : null;
 					break;
-				case EditorCommon.CodeEditorStateFlag.Position:
+				case CodeEditorStateFlag.Position:
 					this.position = editor.getPosition();
 					break;
-				case EditorCommon.CodeEditorStateFlag.Selection:
+				case CodeEditorStateFlag.Selection:
 					this.selection = editor.getSelection();
 					break;
-				case EditorCommon.CodeEditorStateFlag.Scroll:
+				case CodeEditorStateFlag.Scroll:
 					this.scrollLeft = editor.getScrollLeft();
 					this.scrollTop = editor.getScrollTop();
 					break;
@@ -62,7 +62,7 @@ export class EditorState implements EditorCommon.ICodeEditorState {
 		return true;
 	}
 
-	public validate(editor:EditorCommon.ICommonCodeEditor):boolean {
+	public validate(editor:ICommonCodeEditor):boolean {
 		return this._equals(new EditorState(editor, this.flags));
 	}
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/core/position.ts
code:
@@ -4,9 +4,9 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IEditorPosition, IPosition, IRange} from 'vs/editor/common/editorCommon';
 
-export class Position implements EditorCommon.IEditorPosition {
+export class Position implements IEditorPosition {
 
 	public lineNumber: number;
 	public column: number;
@@ -16,11 +16,11 @@ export class Position implements EditorCommon.IEditorPosition {
 		this.column = column;
 	}
 
-	public equals(other:EditorCommon.IPosition): boolean {
+	public equals(other:IPosition): boolean {
 		return (!!other && this.lineNumber === other.lineNumber && this.column === other.column);
 	}
 
-	public isBefore(other:EditorCommon.IPosition): boolean {
+	public isBefore(other:IPosition): boolean {
 		if (this.lineNumber < other.lineNumber) {
 			return true;
 		}
@@ -30,7 +30,7 @@ export class Position implements EditorCommon.IEditorPosition {
 		return this.column < other.column;
 	}
 
-	public isBeforeOrEqual(other:EditorCommon.IPosition): boolean {
+	public isBeforeOrEqual(other:IPosition): boolean {
 		if (this.lineNumber < other.lineNumber) {
 			return true;
 		}
@@ -50,19 +50,19 @@ export class Position implements EditorCommon.IEditorPosition {
 
 	// ---
 
-	public static lift(pos:EditorCommon.IPosition): EditorCommon.IEditorPosition {
+	public static lift(pos:IPosition): IEditorPosition {
 		return new Position(pos.lineNumber, pos.column);
 	}
 
-	public static isIPosition(obj: any): obj is EditorCommon.IPosition {
+	public static isIPosition(obj: any): obj is IPosition {
 		return (
 			obj
 			&& (typeof obj.lineNumber === 'number')
 			&& (typeof obj.column === 'number')
 		);
 	}
 
-	public static asEmptyRange(position:EditorCommon.IPosition):EditorCommon.IRange {
+	public static asEmptyRange(position:IPosition):IRange {
 		return {
 			startLineNumber: position.lineNumber,
 			startColumn: position.column,
@@ -71,14 +71,14 @@ export class Position implements EditorCommon.IEditorPosition {
 		};
 	}
 
-	public static startPosition(range:EditorCommon.IRange):EditorCommon.IPosition {
+	public static startPosition(range:IRange):IPosition {
 		return {
 			lineNumber: range.startLineNumber,
 			column: range.startColumn
 		};
 	}
 
-	public static endPosition(range:EditorCommon.IRange):EditorCommon.IPosition {
+	public static endPosition(range:IRange):IPosition {
 		return {
 			lineNumber: range.endLineNumber,
 			column: range.endColumn

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/core/range.ts
code:
@@ -6,9 +6,9 @@
 'use strict';
 
 import {Position} from 'vs/editor/common/core/position';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IEditorPosition, IEditorRange, IPosition, IRange} from 'vs/editor/common/editorCommon';
 
-export class Range implements EditorCommon.IEditorRange {
+export class Range implements IEditorRange {
 
 	public startLineNumber:number;
 	public startColumn:number;
@@ -33,31 +33,31 @@ export class Range implements EditorCommon.IEditorRange {
 		return Range.isEmpty(this);
 	}
 
-	public containsPosition(position:EditorCommon.IPosition): boolean {
+	public containsPosition(position:IPosition): boolean {
 		return Range.containsPosition(this, position);
 	}
 
-	public containsRange(range:EditorCommon.IRange): boolean {
+	public containsRange(range:IRange): boolean {
 		return Range.containsRange(this, range);
 	}
 
-	public plusRange(range:EditorCommon.IRange): Range {
+	public plusRange(range:IRange): Range {
 		return Range.plusRange(this, range);
 	}
 
-	public intersectRanges(range:EditorCommon.IRange): Range {
+	public intersectRanges(range:IRange): Range {
 		return Range.intersectRanges(this, range);
 	}
 
-	public equalsRange(other:EditorCommon.IRange): boolean {
+	public equalsRange(other:IRange): boolean {
 		return Range.equalsRange(this, other);
 	}
 
-	public getEndPosition(): EditorCommon.IEditorPosition {
+	public getEndPosition(): IEditorPosition {
 		return new Position(this.endLineNumber, this.endColumn);
 	}
 
-	public getStartPosition(): EditorCommon.IEditorPosition {
+	public getStartPosition(): IEditorPosition {
 		return new Position(this.startLineNumber, this.startColumn);
 	}
 
@@ -69,11 +69,11 @@ export class Range implements EditorCommon.IEditorRange {
 		return '[' + this.startLineNumber + ',' + this.startColumn + ' -> ' + this.endLineNumber + ',' + this.endColumn + ']';
 	}
 
-	public setEndPosition(endLineNumber: number, endColumn: number): EditorCommon.IEditorRange {
+	public setEndPosition(endLineNumber: number, endColumn: number): IEditorRange {
 		return new Range(this.startLineNumber, this.startColumn, endLineNumber, endColumn);
 	}
 
-	public setStartPosition(startLineNumber: number, startColumn: number): EditorCommon.IEditorRange {
+	public setStartPosition(startLineNumber: number, startColumn: number): IEditorRange {
 		return new Range(startLineNumber, startColumn, this.endLineNumber, this.endColumn);
 	}
 
@@ -83,14 +83,14 @@ export class Range implements EditorCommon.IEditorRange {
 
 	// ---
 
-	public static lift(range:EditorCommon.IRange): EditorCommon.IEditorRange {
+	public static lift(range:IRange): IEditorRange {
 		if (!range) {
 			return null;
 		}
 		return new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn);
 	}
 
-	public static isIRange(obj: any): obj is EditorCommon.IRange {
+	public static isIRange(obj: any): obj is IRange {
 		return (
 			obj
 			&& (typeof obj.startLineNumber === 'number')
@@ -100,11 +100,11 @@ export class Range implements EditorCommon.IEditorRange {
 		);
 	}
 
-	public static isEmpty(range:EditorCommon.IRange): boolean {
+	public static isEmpty(range:IRange): boolean {
 		return (range.startLineNumber === range.endLineNumber && range.startColumn === range.endColumn);
 	}
 
-	public static containsPosition(range:EditorCommon.IRange, position:EditorCommon.IPosition): boolean {
+	public static containsPosition(range:IRange, position:IPosition): boolean {
 		if (position.lineNumber < range.startLineNumber || position.lineNumber > range.endLineNumber) {
 			return false;
 		}
@@ -117,7 +117,7 @@ export class Range implements EditorCommon.IEditorRange {
 		return true;
 	}
 
-	public static containsRange(range:EditorCommon.IRange, otherRange:EditorCommon.IRange): boolean {
+	public static containsRange(range:IRange, otherRange:IRange): boolean {
 		if (otherRange.startLineNumber < range.startLineNumber || otherRange.endLineNumber < range.startLineNumber) {
 			return false;
 		}
@@ -133,7 +133,7 @@ export class Range implements EditorCommon.IEditorRange {
 		return true;
 	}
 
-	public static areIntersectingOrTouching(a:EditorCommon.IRange, b:EditorCommon.IRange): boolean {
+	public static areIntersectingOrTouching(a:IRange, b:IRange): boolean {
 		// Check if `a` is before `b`
 		if (a.endLineNumber < b.startLineNumber || (a.endLineNumber === b.startLineNumber && a.endColumn < b.startColumn)) {
 			return false;
@@ -148,7 +148,7 @@ export class Range implements EditorCommon.IEditorRange {
 		return true;
 	}
 
-	public static intersectRanges(a:EditorCommon.IRange, b:EditorCommon.IRange): Range {
+	public static intersectRanges(a:IRange, b:IRange): Range {
 		var resultStartLineNumber = a.startLineNumber,
 			resultStartColumn = a.startColumn,
 			resultEndLineNumber = a.endLineNumber,
@@ -182,7 +182,7 @@ export class Range implements EditorCommon.IEditorRange {
 		return new Range(resultStartLineNumber, resultStartColumn, resultEndLineNumber, resultEndColumn);
 	}
 
-	public static plusRange(a:EditorCommon.IRange, b:EditorCommon.IRange): Range {
+	public static plusRange(a:IRange, b:IRange): Range {
 		var startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number;
 		if (b.startLineNumber < a.startLineNumber) {
 			startLineNumber = b.startLineNumber;
@@ -209,7 +209,7 @@ export class Range implements EditorCommon.IEditorRange {
 		return new Range(startLineNumber, startColumn, endLineNumber, endColumn);
 	}
 
-	public static equalsRange(a:EditorCommon.IRange, b:EditorCommon.IRange): boolean {
+	public static equalsRange(a:IRange, b:IRange): boolean {
 		return (
 			!!a &&
 			!!b &&
@@ -224,7 +224,7 @@ export class Range implements EditorCommon.IEditorRange {
 	 * A function that compares ranges, useful for sorting ranges
 	 * It will first compare ranges on the startPosition and then on the endPosition
 	 */
-	public static compareRangesUsingStarts(a:EditorCommon.IRange, b:EditorCommon.IRange): number {
+	public static compareRangesUsingStarts(a:IRange, b:IRange): number {
 		if (a.startLineNumber === b.startLineNumber) {
 			if (a.startColumn === b.startColumn) {
 				if (a.endLineNumber === b.endLineNumber) {
@@ -241,7 +241,7 @@ export class Range implements EditorCommon.IEditorRange {
 	 * A function that compares ranges, useful for sorting ranges
 	 * It will first compare ranges on the endPosition and then on the startPosition
 	 */
-	public static compareRangesUsingEnds(a:EditorCommon.IRange, b:EditorCommon.IRange): number {
+	public static compareRangesUsingEnds(a:IRange, b:IRange): number {
 		if (a.endLineNumber === b.endLineNumber) {
 			if (a.endColumn === b.endColumn) {
 				if (a.startLineNumber === b.startLineNumber) {
@@ -254,15 +254,15 @@ export class Range implements EditorCommon.IEditorRange {
 		return a.endLineNumber - b.endLineNumber;
 	}
 
-	public static spansMultipleLines(range:EditorCommon.IRange):boolean {
+	public static spansMultipleLines(range:IRange):boolean {
 		return range.endLineNumber > range.startLineNumber;
 	}
 
-	public static hashCode(range:EditorCommon.IRange):number {
+	public static hashCode(range:IRange):number {
 		return (range.startLineNumber * 17) + (range.startColumn * 23) + (range.endLineNumber * 29) + (range.endColumn * 37);
 	}
 
-	public static collapseToStart(range:EditorCommon.IRange):EditorCommon.IRange  {
+	public static collapseToStart(range:IRange):IRange  {
 		return {
 			startLineNumber: range.startLineNumber,
 			startColumn: range.startColumn,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/core/selection.ts
code:
@@ -5,9 +5,9 @@
 'use strict';
 
 import {Range} from 'vs/editor/common/core/range';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IEditorSelection, ISelection, SelectionDirection} from 'vs/editor/common/editorCommon';
 
-export class Selection extends Range implements EditorCommon.IEditorSelection {
+export class Selection extends Range implements IEditorSelection {
 	public selectionStartLineNumber: number;
 	public selectionStartColumn: number;
 	public positionLineNumber: number;
@@ -21,52 +21,52 @@ export class Selection extends Range implements EditorCommon.IEditorSelection {
 		super(selectionStartLineNumber, selectionStartColumn, positionLineNumber, positionColumn);
 	}
 
-	public clone(): EditorCommon.IEditorSelection {
+	public clone(): IEditorSelection {
 		return new Selection(this.selectionStartLineNumber, this.selectionStartColumn, this.positionLineNumber, this.positionColumn);
 	}
 
 	public toString(): string {
 		return '[' + this.selectionStartLineNumber + ',' + this.selectionStartColumn + ' -> ' + this.positionLineNumber + ',' + this.positionColumn + ']';
 	}
 
-	public equalsSelection(other: EditorCommon.ISelection): boolean {
+	public equalsSelection(other: ISelection): boolean {
 		return (
 			Selection.selectionsEqual(this, other)
 		);
 	}
 
-	public getDirection(): EditorCommon.SelectionDirection {
+	public getDirection(): SelectionDirection {
 		if (this.selectionStartLineNumber === this.startLineNumber && this.selectionStartColumn === this.startColumn) {
-			return EditorCommon.SelectionDirection.LTR;
+			return SelectionDirection.LTR;
 		}
-		return EditorCommon.SelectionDirection.RTL;
+		return SelectionDirection.RTL;
 	}
 
-	public setEndPosition(endLineNumber: number, endColumn: number): EditorCommon.IEditorSelection {
-		if (this.getDirection() === EditorCommon.SelectionDirection.LTR) {
+	public setEndPosition(endLineNumber: number, endColumn: number): IEditorSelection {
+		if (this.getDirection() === SelectionDirection.LTR) {
 			return new Selection(this.startLineNumber, this.startColumn, endLineNumber, endColumn);
 		}
 		return new Selection(endLineNumber, endColumn, this.startLineNumber, this.startColumn);
 	}
 
-	public setStartPosition(startLineNumber: number, startColumn: number): EditorCommon.IEditorSelection {
-		if (this.getDirection() === EditorCommon.SelectionDirection.LTR) {
+	public setStartPosition(startLineNumber: number, startColumn: number): IEditorSelection {
+		if (this.getDirection() === SelectionDirection.LTR) {
 			return new Selection(startLineNumber, startColumn, this.endLineNumber, this.endColumn);
 		}
 		return new Selection(this.endLineNumber, this.endColumn, startLineNumber, startColumn);
 	}
 
 	// ----
 
-	public static createSelection(selectionStartLineNumber: number, selectionStartColumn: number, positionLineNumber: number, positionColumn: number): EditorCommon.IEditorSelection {
+	public static createSelection(selectionStartLineNumber: number, selectionStartColumn: number, positionLineNumber: number, positionColumn: number): IEditorSelection {
 		return new Selection(selectionStartLineNumber, selectionStartColumn, positionLineNumber, positionColumn);
 	}
 
-	public static liftSelection(sel:EditorCommon.ISelection): EditorCommon.IEditorSelection {
+	public static liftSelection(sel:ISelection): IEditorSelection {
 		return new Selection(sel.selectionStartLineNumber, sel.selectionStartColumn, sel.positionLineNumber, sel.positionColumn);
 	}
 
-	public static selectionsEqual(a:EditorCommon.ISelection, b:EditorCommon.ISelection): boolean {
+	public static selectionsEqual(a:ISelection, b:ISelection): boolean {
 		return (
 			a.selectionStartLineNumber === b.selectionStartLineNumber &&
 			a.selectionStartColumn === b.selectionStartColumn &&
@@ -75,7 +75,7 @@ export class Selection extends Range implements EditorCommon.IEditorSelection {
 		);
 	}
 
-	public static selectionsArrEqual(a:EditorCommon.ISelection[], b:EditorCommon.ISelection[]): boolean {
+	public static selectionsArrEqual(a:ISelection[], b:ISelection[]): boolean {
 		if (a && !b || !a && b) {
 			return false;
 		}
@@ -103,9 +103,9 @@ export class Selection extends Range implements EditorCommon.IEditorSelection {
 		);
 	}
 
-	public static createWithDirection(startLineNumber: number, startColumn: number, endLineNumber: number, endColumn: number, direction:EditorCommon.SelectionDirection): EditorCommon.IEditorSelection {
+	public static createWithDirection(startLineNumber: number, startColumn: number, endLineNumber: number, endColumn: number, direction:SelectionDirection): IEditorSelection {
 
-		if (direction === EditorCommon.SelectionDirection.LTR) {
+		if (direction === SelectionDirection.LTR) {
 			return new Selection(startLineNumber, startColumn, endLineNumber, endColumn);
 		}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/diff/diffComputer.ts
code:
@@ -4,9 +4,9 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {ISequence, IDiffChange, LcsDiff} from 'vs/base/common/diff/diff';
-import Strings = require('vs/base/common/strings');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IDiffChange, ISequence, LcsDiff} from 'vs/base/common/diff/diff';
+import * as strings from 'vs/base/common/strings';
+import {ICharChange, ILineChange} from 'vs/editor/common/editorCommon';
 
 var MAXIMUM_RUN_TIME = 5000; // 5 seconds
 var MINIMUM_MATCHING_CHARACTER_LENGTH = 3;
@@ -118,15 +118,15 @@ class LineMarkerSequence extends MarkerSequence {
 	}
 
 	private _getFirstNonBlankColumn(txt:string, defaultValue:number): number {
-		var r = Strings.firstNonWhitespaceIndex(txt);
+		var r = strings.firstNonWhitespaceIndex(txt);
 		if (r === -1) {
 			return defaultValue;
 		}
 		return r + 1;
 	}
 
 	private _getLastNonBlankColumn(txt:string, defaultValue:number): number {
-		var r = Strings.lastNonWhitespaceIndex(txt);
+		var r = strings.lastNonWhitespaceIndex(txt);
 		if (r === -1) {
 			return defaultValue;
 		}
@@ -155,7 +155,7 @@ class LineMarkerSequence extends MarkerSequence {
 	}
 }
 
-class CharChange implements EditorCommon.ICharChange {
+class CharChange implements ICharChange {
 
 	public originalStartLineNumber:number;
 	public originalStartColumn:number;
@@ -224,7 +224,7 @@ function postProcessCharChanges(rawChanges:IDiffChange[]): IDiffChange[] {
 	return result;
 }
 
-class LineChange implements EditorCommon.ILineChange {
+class LineChange implements ILineChange {
 	public originalStartLineNumber:number;
 	public originalEndLineNumber:number;
 	public modifiedStartLineNumber:number;
@@ -297,12 +297,12 @@ export class DiffComputer {
 		}
 	}
 
-	public computeDiff():EditorCommon.ILineChange[] {
+	public computeDiff():ILineChange[] {
 		this.computationStartTime = (new Date()).getTime();
 
 		var rawChanges = computeDiff(this.original, this.modified, this._continueProcessingPredicate.bind(this));
 
-		var lineChanges: EditorCommon.ILineChange[] = [];
+		var lineChanges: ILineChange[] = [];
 		for (var i = 0, length = rawChanges.length; i < length; i++) {
 			lineChanges.push(new LineChange(rawChanges[i], this.original, this.modified, this._continueProcessingPredicate.bind(this), this.shouldPostProcessCharChanges));
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/diff/nullDiffComputer.ts
code:
@@ -4,14 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {ILineChange} from 'vs/editor/common/editorCommon';
 
 export class DiffComputer {
 
 	constructor(originalLines:string[], modifiedLines:string[], shouldPostProcessCharChanges:boolean, shouldIgnoreTrimWhitespace:boolean) {
 	}
 
-	public computeDiff(): EditorCommon.ILineChange[] {
+	public computeDiff(): ILineChange[] {
 		return [];
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/editorAction.ts
code:
@@ -5,32 +5,30 @@
 'use strict';
 
 import {Action} from 'vs/base/common/actions';
+import * as strings from 'vs/base/common/strings';
 import {TPromise} from 'vs/base/common/winjs.base';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Modes = require('vs/editor/common/modes');
-import Strings = require('vs/base/common/strings');
-import editorActionEnablement = require('vs/editor/common/editorActionEnablement');
 import {INullService} from 'vs/platform/instantiation/common/instantiation';
-
-export import Behaviour = editorActionEnablement.Behaviour;
+import {Behaviour, IEnablementState, createActionEnablement} from 'vs/editor/common/editorActionEnablement';
+import {IActionDescriptor, IActionEnablement, ICommonCodeEditor, IEditorActionDescriptorData, IEditorContribution} from 'vs/editor/common/editorCommon';
+import {ILineContext} from 'vs/editor/common/modes';
 
 var defaultBehaviour = Behaviour.TextFocus | Behaviour.Writeable | Behaviour.UpdateOnModelChange;
 
-export class EditorAction extends Action implements EditorCommon.IEditorContribution {
+export class EditorAction extends Action implements IEditorContribution {
 
-	public editor:EditorCommon.ICommonCodeEditor;
+	public editor:ICommonCodeEditor;
 
 	private _shouldShowInContextMenu:boolean;
 	private _supportsReadonly:boolean;
-	private _descriptor:EditorCommon.IEditorActionDescriptorData;
-	private _enablementState:editorActionEnablement.IEnablementState;
+	private _descriptor:IEditorActionDescriptorData;
+	private _enablementState:IEnablementState;
 
-	constructor(descriptor:EditorCommon.IEditorActionDescriptorData, editor:EditorCommon.ICommonCodeEditor, condition:Behaviour = defaultBehaviour) {
+	constructor(descriptor:IEditorActionDescriptorData, editor:ICommonCodeEditor, condition:Behaviour = defaultBehaviour) {
 		super(descriptor.id);
 		this.editor = editor;
 		this._descriptor = descriptor;
 		this.label = descriptor.label || '';
-		this._enablementState = editorActionEnablement.createActionEnablement(editor, condition, this);
+		this._enablementState = createActionEnablement(editor, condition, this);
 
 		this._shouldShowInContextMenu = !!(condition & Behaviour.ShowInContextMenu);
 
@@ -57,7 +55,7 @@ export class EditorAction extends Action implements EditorCommon.IEditorContribu
 		return this._shouldShowInContextMenu;
 	}
 
-	public getDescriptor(): EditorCommon.IEditorActionDescriptorData {
+	public getDescriptor(): IEditorActionDescriptorData {
 		return this._descriptor;
 	}
 
@@ -111,7 +109,7 @@ export class EditorAction extends Action implements EditorCommon.IEditorContribu
 export class HandlerEditorAction extends EditorAction {
 	private _handlerId: string;
 
-	constructor(descriptor:EditorCommon.IEditorActionDescriptorData, editor:EditorCommon.ICommonCodeEditor, handlerId: string) {
+	constructor(descriptor:IEditorActionDescriptorData, editor:ICommonCodeEditor, handlerId: string) {
 		super(descriptor, editor);
 		this._handlerId = handlerId;
 	}
@@ -124,7 +122,7 @@ export class HandlerEditorAction extends EditorAction {
 
 export class DynamicEditorAction extends EditorAction {
 
-	private static _transformBehaviour(behaviour:EditorCommon.IActionEnablement, contextMenuGroupId: string): Behaviour {
+	private static _transformBehaviour(behaviour:IActionEnablement, contextMenuGroupId: string): Behaviour {
 		var r = 0;
 		if (contextMenuGroupId) {
 			r |= Behaviour.ShowInContextMenu;
@@ -149,12 +147,12 @@ export class DynamicEditorAction extends EditorAction {
 	}
 
 	private _contextMenuGroupId: string;
-	private _run: (editor:EditorCommon.ICommonCodeEditor)=>void;
+	private _run: (editor:ICommonCodeEditor)=>void;
 	private _tokensAtPosition:string[];
 	private _wordAtPosition:boolean;
 
-	constructor(descriptor:EditorCommon.IActionDescriptor, editor:EditorCommon.ICommonCodeEditor, @INullService ns) {
-		var enablement: EditorCommon.IActionEnablement = descriptor.enablement || {};
+	constructor(descriptor:IActionDescriptor, editor:ICommonCodeEditor, @INullService ns) {
+		var enablement: IActionEnablement = descriptor.enablement || {};
 		super({
 			id: descriptor.id,
 			label: descriptor.label
@@ -205,7 +203,7 @@ export class DynamicEditorAction extends EditorAction {
 	}
 }
 
-function isToken(context:Modes.ILineContext, offset:number, types:string[]): boolean {
+function isToken(context:ILineContext, offset:number, types:string[]): boolean {
 
 	if (context.getLineContent().length <= offset) {
 		return false;
@@ -220,7 +218,7 @@ function isToken(context:Modes.ILineContext, offset:number, types:string[]): boo
 				return true;
 			}
 		} else {
-			if (Strings.startsWith(type, types[i])) {
+			if (strings.startsWith(type, types[i])) {
 				return true;
 			}
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/editorActionEnablement.ts
code:
@@ -4,8 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
+import {EventType, ICommonCodeEditor} from 'vs/editor/common/editorCommon';
 
 export enum Behaviour {
 	TextFocus = 1 << 0,
@@ -22,7 +22,7 @@ export interface IEditorAction {
 	getEnablementState(): boolean;
 }
 
-export function createActionEnablement(editor: EditorCommon.ICommonCodeEditor, condition:Behaviour, action:IEditorAction): IEnablementState {
+export function createActionEnablement(editor: ICommonCodeEditor, condition:Behaviour, action:IEditorAction): IEnablementState {
 	return new CompositeEnablementState([new InternalEnablementState(condition, editor), new DescentEnablementState(condition, editor, action)]);
 }
 
@@ -106,7 +106,7 @@ class InternalEnablementState extends CachingEnablementState {
 
 	private _callOnDispose:IDisposable[];
 
-	constructor(private _behaviour:Behaviour, private editor:EditorCommon.ICommonCodeEditor) {
+	constructor(private _behaviour:Behaviour, private editor:ICommonCodeEditor) {
 		super();
 
 		this.hasTextFocus = false;
@@ -115,15 +115,15 @@ class InternalEnablementState extends CachingEnablementState {
 
 		this._callOnDispose = [];
 		if (this._behaviour & Behaviour.TextFocus) {
-			this._callOnDispose.push(this.editor.addListener2(EditorCommon.EventType.EditorTextFocus, () => this._updateTextFocus(true)));
-			this._callOnDispose.push(this.editor.addListener2(EditorCommon.EventType.EditorTextBlur, () => this._updateTextFocus(false)));
+			this._callOnDispose.push(this.editor.addListener2(EventType.EditorTextFocus, () => this._updateTextFocus(true)));
+			this._callOnDispose.push(this.editor.addListener2(EventType.EditorTextBlur, () => this._updateTextFocus(false)));
 		}
 		if (this._behaviour & Behaviour.WidgetFocus) {
-			this._callOnDispose.push(this.editor.addListener2(EditorCommon.EventType.EditorFocus, () => this._updateWidgetFocus(true)));
-			this._callOnDispose.push(this.editor.addListener2(EditorCommon.EventType.EditorBlur, () => this._updateWidgetFocus(false)));
+			this._callOnDispose.push(this.editor.addListener2(EventType.EditorFocus, () => this._updateWidgetFocus(true)));
+			this._callOnDispose.push(this.editor.addListener2(EventType.EditorBlur, () => this._updateWidgetFocus(false)));
 		}
 		if (this._behaviour & Behaviour.Writeable) {
-			this._callOnDispose.push(this.editor.addListener2(EditorCommon.EventType.ConfigurationChanged, (e) => this._update()));
+			this._callOnDispose.push(this.editor.addListener2(EventType.ConfigurationChanged, (e) => this._update()));
 		}
 	}
 
@@ -170,16 +170,16 @@ class DescentEnablementState extends CachingEnablementState {
 
 	private _callOnDispose:Function[] = [];
 
-	constructor(behaviour:Behaviour, private editor:EditorCommon.ICommonCodeEditor, private _action:IEditorAction) {
+	constructor(behaviour:Behaviour, private editor:ICommonCodeEditor, private _action:IEditorAction) {
 		super();
 
 		if (behaviour & Behaviour.UpdateOnModelChange) {
-			this._callOnDispose.push(this.editor.addListener(EditorCommon.EventType.ModelChanged, () => this.reset()));
-			this._callOnDispose.push(this.editor.addListener(EditorCommon.EventType.ModelModeChanged, () => this.reset()));
-			this._callOnDispose.push(this.editor.addListener(EditorCommon.EventType.ModelModeSupportChanged, () => this.reset()));
+			this._callOnDispose.push(this.editor.addListener(EventType.ModelChanged, () => this.reset()));
+			this._callOnDispose.push(this.editor.addListener(EventType.ModelModeChanged, () => this.reset()));
+			this._callOnDispose.push(this.editor.addListener(EventType.ModelModeSupportChanged, () => this.reset()));
 		}
 		if (behaviour & Behaviour.UpdateOnCursorPositionChange) {
-			this._callOnDispose.push(this.editor.addListener(EditorCommon.EventType.CursorPositionChanged, () => this.reset()));
+			this._callOnDispose.push(this.editor.addListener(EventType.CursorPositionChanged, () => this.reset()));
 		}
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/editorCommon.ts
code:
@@ -4,17 +4,17 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IEventEmitter, ListenerUnbind} from 'vs/base/common/eventEmitter';
-import Modes = require('vs/editor/common/modes');
-import TokensBinaryEncoding = require('vs/editor/common/model/tokensBinaryEncoding');
-import {IInstantiationService, INewConstructorSignature1, INewConstructorSignature2} from 'vs/platform/instantiation/common/instantiation';
 import {IAction} from 'vs/base/common/actions';
-import {IHTMLContentElement} from 'vs/base/common/htmlContent';
-import URI from 'vs/base/common/uri';
 import Event from 'vs/base/common/event';
+import {IEventEmitter, ListenerUnbind} from 'vs/base/common/eventEmitter';
+import {IHTMLContentElement} from 'vs/base/common/htmlContent';
+import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
 import {IDisposable} from 'vs/base/common/lifecycle';
+import URI from 'vs/base/common/uri';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {KeyCode, KeyMod} from 'vs/base/common/keyCodes';
+import {IInstantiationService, IConstructorSignature1, IConstructorSignature2} from 'vs/platform/instantiation/common/instantiation';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
+import {ILineContext, IMode, IModeTransition, IToken} from 'vs/editor/common/modes';
 
 export type KeyCode = KeyCode;
 export type KeyMod = KeyMod;
@@ -279,6 +279,11 @@ export interface IEditorOptions {
 	 * Defaults to empty array.
 	 */
 	rulers?: number[];
+	/**
+	 * A string containing the word separators used when doing word navigation.
+	 * Defaults to `~!@#$%^&*()-=+[{]}\\|;:\'",.<>/?
+	 */
+	wordSeparators?: string;
 	/**
 	 * Control the rendering of line numbers.
 	 * If it is a function, it will be invoked when rendering a line number and the return value will be rendered.
@@ -591,6 +596,7 @@ export interface IEditorWrappingInfo {
 export interface IInternalEditorOptions {
 	experimentalScreenReader: boolean;
 	rulers: number[];
+	wordSeparators: string;
 	ariaLabel: string;
 
 	// ---- Options that are transparent - get no massaging
@@ -679,6 +685,7 @@ export interface IInternalEditorOptions {
 export interface IConfigurationChangedEvent {
 	experimentalScreenReader: boolean;
 	rulers: boolean;
+	wordSeparators: boolean;
 	ariaLabel: boolean;
 
 	// ---- Options that are transparent - get no massaging
@@ -962,7 +969,7 @@ export interface IWordRange {
 }
 
 export interface ITokenInfo {
-	token: Modes.IToken;
+	token: IToken;
 	lineNumber: number;
 	startColumn: number;
 	endColumn: number;
@@ -1175,13 +1182,13 @@ export interface ILineTokensBinaryEncoding {
 	START_INDEX_OFFSET: number;
 	TYPE_OFFSET: number;
 
-	deflateArr(map:ITokensInflatorMap, tokens:Modes.IToken[]): number[];
-	inflate(map:ITokensInflatorMap, binaryEncodedToken:number): Modes.IToken;
+	deflateArr(map:ITokensInflatorMap, tokens:IToken[]): number[];
+	inflate(map:ITokensInflatorMap, binaryEncodedToken:number): IToken;
 	getStartIndex(binaryEncodedToken:number): number;
 	getType(map:ITokensInflatorMap, binaryEncodedToken:number): string;
-	inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): Modes.IToken[];
+	inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): IToken[];
 	findIndexOfOffset(binaryEncodedTokens:number[], offset:number): number;
-	sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): Modes.IToken[];
+	sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): IToken[];
 }
 export var LineTokensBinaryEncoding:ILineTokensBinaryEncoding = TokensBinaryEncoding;
 
@@ -1417,9 +1424,9 @@ export interface ITokenizedModel extends ITextModel {
 	/**
 	 * Tokenize if necessary and get the tokenization result for the line `lineNumber`, as returned by the language mode.
 	 */
-	getLineContext(lineNumber:number): Modes.ILineContext;
+	getLineContext(lineNumber:number): ILineContext;
 
-	/*package*/_getLineModeTransitions(lineNumber:number): Modes.IModeTransition[];
+	/*package*/_getLineModeTransitions(lineNumber:number): IModeTransition[];
 
 	/**
 	 * Replace the entire text buffer value contained in this model.
@@ -1430,30 +1437,30 @@ export interface ITokenizedModel extends ITextModel {
 	 * unbinds the mirror model from the previous mode to the new
 	 * one if the mode has changed.
 	 */
-	setValue(newValue:string, newMode?:Modes.IMode): void;
+	setValue(newValue:string, newMode?:IMode): void;
 
 	/**
 	 * Get the current language mode associated with the model.
 	 */
-	getMode(): Modes.IMode;
+	getMode(): IMode;
 
 	/**
 	 * Set the current language mode associated with the model.
 	 */
-	setMode(newMode:Modes.IMode): void;
-	setMode(newModePromise:TPromise<Modes.IMode>): void;
+	setMode(newMode:IMode): void;
+	setMode(newModePromise:TPromise<IMode>): void;
 	/**
 	 * A mode can be currently pending loading if a promise is used when constructing a model or calling setMode().
 	 *
 	 * If there is no currently pending loading mode, then the result promise will complete immediately.
 	 * Otherwise, the result will complete once the currently pending loading mode is loaded.
 	 */
-	whenModeIsReady(): TPromise<Modes.IMode>;
+	whenModeIsReady(): TPromise<IMode>;
 
 	/**
 	 * Returns the true (inner-most) language mode at a given position.
 	 */
-	getModeAtPosition(lineNumber:number, column:number): Modes.IMode;
+	getModeAtPosition(lineNumber:number, column:number): IMode;
 
 	/**
 	 * Get the word under or besides `position`.
@@ -1813,8 +1820,8 @@ export interface IModel extends IEditableTextModel, ITextModelWithMarkers, IToke
 	 * unbinds the mirror model from the previous mode to the new
 	 * one if the mode has changed.
 	 */
-	setValue(newValue:string, newMode?:Modes.IMode): void;
-	setValue(newValue:string, newModePromise:TPromise<Modes.IMode>): void;
+	setValue(newValue:string, newMode?:IMode): void;
+	setValue(newValue:string, newModePromise:TPromise<IMode>): void;
 
 	onBeforeAttached(): void;
 
@@ -1856,11 +1863,11 @@ export interface IModelModeChangedEvent {
 	/**
 	 * Previous mode
 	 */
-	oldMode:Modes.IMode;
+	oldMode:IMode;
 	/**
 	 * New mode
 	 */
-	newMode:Modes.IMode;
+	newMode:IMode;
 }
 
 /**
@@ -2748,9 +2755,9 @@ export interface IEditorActionDescriptorData {
 	label:string;
 }
 
-export type IEditorActionContributionCtor = INewConstructorSignature2<IEditorActionDescriptorData, ICommonCodeEditor, IEditorContribution>;
+export type IEditorActionContributionCtor = IConstructorSignature2<IEditorActionDescriptorData, ICommonCodeEditor, IEditorContribution>;
 
-export type ICommonEditorContributionCtor = INewConstructorSignature1<ICommonCodeEditor, IEditorContribution>;
+export type ICommonEditorContributionCtor = IConstructorSignature1<ICommonCodeEditor, IEditorContribution>;
 
 /**
  * An editor contribution descriptor that will be used to construct editor contributions
@@ -3071,6 +3078,11 @@ export interface ICommonCodeEditor extends IEditor {
 	 */
 	getIndentationOptions(): IInternalIndentationOptions;
 
+	/**
+	 * Sets the indentation options of the editor.
+	 */
+	setIndentationOptions(IInternalIndentationOptions): void;
+
 	/**
 	 * Normalize whitespace using the editor's whitespace specific settings
 	 */

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/editorCommonExtensions.ts
code:
@@ -4,19 +4,19 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {onUnexpectedError, illegalArgument} from 'vs/base/common/errors';
+import {illegalArgument, onUnexpectedError} from 'vs/base/common/errors';
 import URI from 'vs/base/common/uri';
-import {Position} from 'vs/editor/common/core/position';
+import {SyncDescriptor1, createSyncDescriptor} from 'vs/platform/instantiation/common/descriptors';
 import {ServicesAccessor} from 'vs/platform/instantiation/common/instantiation';
+import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {ICommandHandler, IKeybindings, KbExpr} from 'vs/platform/keybinding/common/keybindingService';
+import {ICommandDescriptor, KeybindingsRegistry} from 'vs/platform/keybinding/common/keybindingsRegistry';
+import {Registry} from 'vs/platform/platform';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {findFocusedEditor, getActiveEditor, withCodeEditorFromCommandHandler} from 'vs/editor/common/config/config';
+import {Position} from 'vs/editor/common/core/position';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {IModelService} from 'vs/editor/common/services/modelService';
-import {Registry} from 'vs/platform/platform';
-import {KeybindingsRegistry,ICommandDescriptor} from 'vs/platform/keybinding/common/keybindingsRegistry';
-import config = require('vs/editor/common/config/config');
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {SyncDescriptor1, createSyncDescriptor} from 'vs/platform/instantiation/common/descriptors';
-import {KbExpr, ICommandHandler, IKeybindings} from 'vs/platform/keybinding/common/keybindingService';
 
 // --- Keybinding extensions to make it more concise to express keybindings conditions
 export enum ContextKey {
@@ -36,13 +36,13 @@ export interface IEditorCommandKeybindingOptions extends IKeybindings {
 // --- Editor Actions
 export class EditorActionDescriptor {
 
-	public ctor:EditorCommon.IEditorActionContributionCtor;
+	public ctor:editorCommon.IEditorActionContributionCtor;
 	public id:string;
 	public label:string;
 
 	public kbOpts:IEditorActionKeybindingOptions;
 
-	constructor(ctor:EditorCommon.IEditorActionContributionCtor, id:string, label:string, kbOpts: IEditorActionKeybindingOptions = defaultEditorActionKeybindingOptions) {
+	constructor(ctor:editorCommon.IEditorActionContributionCtor, id:string, label:string, kbOpts: IEditorActionKeybindingOptions = defaultEditorActionKeybindingOptions) {
 		this.ctor = ctor;
 		this.id = id;
 		this.label = label;
@@ -51,7 +51,7 @@ export class EditorActionDescriptor {
 }
 
 export interface IEditorCommandHandler {
-	(accessor:ServicesAccessor, editor: EditorCommon.ICommonCodeEditor, args: any): void;
+	(accessor:ServicesAccessor, editor: editorCommon.ICommonCodeEditor, args: any): void;
 }
 
 export module CommonEditorRegistry {
@@ -61,10 +61,10 @@ export module CommonEditorRegistry {
 	}
 
 	// --- Editor Contributions
-	export function registerEditorContribution(ctor:EditorCommon.ICommonEditorContributionCtor): void {
+	export function registerEditorContribution(ctor:editorCommon.ICommonEditorContributionCtor): void {
 		(<EditorContributionRegistry>Registry.as(Extensions.EditorCommonContributions)).registerEditorContribution2(ctor);
 	}
-	export function getEditorContributions(): EditorCommon.ICommonEditorContributionDescriptor[] {
+	export function getEditorContributions(): editorCommon.ICommonEditorContributionDescriptor[] {
 		return (<EditorContributionRegistry>Registry.as(Extensions.EditorCommonContributions)).getEditorContributions2();
 	}
 
@@ -104,7 +104,7 @@ export module CommonEditorRegistry {
 		});
 	}
 
-	export function registerDefaultLanguageCommand(id: string, handler: (model: EditorCommon.IModel, position: EditorCommon.IPosition, args: { [n: string]: any }) => any) {
+	export function registerDefaultLanguageCommand(id: string, handler: (model: editorCommon.IModel, position: editorCommon.IPosition, args: { [n: string]: any }) => any) {
 		registerLanguageCommand(id, function(accessor, args) {
 
 			const {resource, position} = args;
@@ -122,30 +122,30 @@ export module CommonEditorRegistry {
 	}
 }
 
-class SimpleEditorContributionDescriptor implements EditorCommon.ICommonEditorContributionDescriptor {
-	private _ctor:EditorCommon.ICommonEditorContributionCtor;
+class SimpleEditorContributionDescriptor implements editorCommon.ICommonEditorContributionDescriptor {
+	private _ctor:editorCommon.ICommonEditorContributionCtor;
 
-	constructor(ctor:EditorCommon.ICommonEditorContributionCtor) {
+	constructor(ctor:editorCommon.ICommonEditorContributionCtor) {
 		this._ctor = ctor;
 	}
 
-	public createInstance(instantiationService: IInstantiationService, editor:EditorCommon.ICommonCodeEditor): EditorCommon.IEditorContribution {
+	public createInstance(instantiationService: IInstantiationService, editor:editorCommon.ICommonCodeEditor): editorCommon.IEditorContribution {
 		return instantiationService.createInstance(this._ctor, editor);
 	}
 }
 
-class InternalEditorActionDescriptor implements EditorCommon.ICommonEditorContributionDescriptor {
+class InternalEditorActionDescriptor implements editorCommon.ICommonEditorContributionDescriptor {
 
-	private _descriptor: SyncDescriptor1<EditorCommon.ICommonCodeEditor, EditorCommon.IEditorContribution>;
+	private _descriptor: SyncDescriptor1<editorCommon.ICommonCodeEditor, editorCommon.IEditorContribution>;
 
-	constructor(ctor:EditorCommon.IEditorActionContributionCtor, id:string, label:string) {
+	constructor(ctor:editorCommon.IEditorActionContributionCtor, id:string, label:string) {
 		this._descriptor = createSyncDescriptor(ctor, {
 			id: id,
 			label: label
 		});
 	}
 
-	public createInstance(instService:IInstantiationService, editor:EditorCommon.ICommonCodeEditor): EditorCommon.IEditorContribution {
+	public createInstance(instService:IInstantiationService, editor:editorCommon.ICommonCodeEditor): editorCommon.IEditorContribution {
 		return instService.createInstance(this._descriptor, editor);
 	}
 }
@@ -157,13 +157,13 @@ var Extensions = {
 
 class EditorContributionRegistry {
 
-	private editorContributions: EditorCommon.ICommonEditorContributionDescriptor[];
+	private editorContributions: editorCommon.ICommonEditorContributionDescriptor[];
 
 	constructor() {
 		this.editorContributions = [];
 	}
 
-	public registerEditorContribution2(ctor:EditorCommon.ICommonEditorContributionCtor): void {
+	public registerEditorContribution2(ctor:editorCommon.ICommonEditorContributionCtor): void {
 		this.editorContributions.push(new SimpleEditorContributionDescriptor(ctor));
 	}
 
@@ -180,9 +180,9 @@ class EditorContributionRegistry {
 		var context: KbExpr = null;
 		if (typeof desc.kbOpts.kbExpr === 'undefined') {
 			if (desc.kbOpts.context === ContextKey.EditorTextFocus) {
-				context = KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS);
+				context = KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS);
 			} else if (desc.kbOpts.context === ContextKey.EditorFocus) {
-				context = KbExpr.has(EditorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS);
+				context = KbExpr.has(editorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS);
 			}
 		} else {
 			context = desc.kbOpts.kbExpr;
@@ -204,27 +204,27 @@ class EditorContributionRegistry {
 		this.editorContributions.push(new InternalEditorActionDescriptor(desc.ctor, desc.id, desc.label));
 	}
 
-	public getEditorContributions2(): EditorCommon.ICommonEditorContributionDescriptor[] {
+	public getEditorContributions2(): editorCommon.ICommonEditorContributionDescriptor[] {
 		return this.editorContributions.slice(0);
 	}
 }
 Registry.add(Extensions.EditorCommonContributions, new EditorContributionRegistry());
 
 function triggerEditorAction(actionId: string, accessor: ServicesAccessor, args: any): void {
-	config.withCodeEditorFromCommandHandler(actionId, accessor, args,(editor) => {
+	withCodeEditorFromCommandHandler(actionId, accessor, args,(editor) => {
 		editor.trigger('keyboard', actionId, args);
 	});
 }
 
 function triggerEditorActionGlobal(actionId: string, accessor: ServicesAccessor, args: any): void {
 	// TODO: this is not necessarily keyboard
-	var focusedEditor = config.findFocusedEditor(actionId, accessor, args, false);
+	var focusedEditor = findFocusedEditor(actionId, accessor, args, false);
 	if (focusedEditor) {
 		focusedEditor.trigger('keyboard', actionId, args);
 		return;
 	}
 
-	var activeEditor = config.getActiveEditor(accessor);
+	var activeEditor = getActiveEditor(accessor);
 	if (activeEditor) {
 		var action = activeEditor.getAction(actionId);
 		if (action) {
@@ -239,7 +239,7 @@ var defaultEditorActionKeybindingOptions:IEditorActionKeybindingOptions = { prim
 
 function contextRule(needsTextFocus: boolean, needsKey: string): KbExpr {
 
-	let base = KbExpr.has(needsTextFocus ? EditorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS : EditorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS);
+	let base = KbExpr.has(needsTextFocus ? editorCommon.KEYBINDING_CONTEXT_EDITOR_TEXT_FOCUS : editorCommon.KEYBINDING_CONTEXT_EDITOR_FOCUS);
 
 	if (needsKey) {
 		return KbExpr.and(base, KbExpr.has(needsKey));
@@ -250,7 +250,7 @@ function contextRule(needsTextFocus: boolean, needsKey: string): KbExpr {
 
 function createCommandHandler(commandId: string, handler: IEditorCommandHandler): ICommandHandler {
 	return (accessor, args) => {
-		config.withCodeEditorFromCommandHandler(commandId, accessor, args, (editor) => {
+		withCodeEditorFromCommandHandler(commandId, accessor, args, (editor) => {
 			handler(accessor, editor, args);
 		});
 	};

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/languages.common.js
code:
@@ -1,57 +0,0 @@
-/*---------------------------------------------------------------------------------------------
- *  Copyright (c) Microsoft Corporation. All rights reserved.
- *  Licensed under the MIT License. See License.txt in the project root for license information.
- *--------------------------------------------------------------------------------------------*/
-require.config({
-	ignoreDuplicateModules: [
-		// Both TypeScript and JavaScript are referencing and including these
-		'vs/languages/typescript/common/features/tokenization',
-
-		'vs/languages/typescript/common/features/quickFixMainActions',
-		'vs/nls!vs/languages/typescript/common/features/quickFixMainActions',
-
-		'vs/languages/typescript/common/typescript',
-
-		'vs/languages/typescript/common/typescriptMode',
-		'vs/nls!vs/languages/typescript/common/typescriptMode',
-
-		'vs/languages/javascript/common/javascript.extensions',
-
-		// Both markdown and html are referencing and including:
-		'vs/languages/html/common/htmlTokenTypes',
-	]
-});
-define([
-	// base common
-	'vs/base/common/json',
-	'vs/base/common/uri',
-	'vs/base/common/network',
-	'vs/base/common/arrays',
-	'vs/base/common/collections',
-	'vs/base/common/lifecycle',
-	'vs/base/common/async',
-	'vs/base/common/glob',
-	'vs/base/common/events',
-
-	// platform common
-	'vs/platform/configuration/common/configurationRegistry',
-	'vs/platform/files/common/files',
-	'vs/platform/search/common/search',
-	'vs/platform/request/common/request',
-	'vs/platform/workspace/common/workspace',
-	'vs/platform/telemetry/common/telemetry',
-
-	// Editor common
-	'vs/editor/common/editorCommon',
-	'vs/editor/common/modes/modesRegistry',
-	'vs/editor/common/modes/monarch/monarch',
-	'vs/editor/common/modes/monarch/monarchCompile',
-	'vs/editor/common/modes/textToHtmlTokenizer',
-	'vs/editor/common/services/modeService',
-	'vs/editor/common/services/modelService',
-
-	// Load plain/text in all environments because markdown & html (at least) expect it to be defined
-	'vs/languages/plaintext/common/plaintext'
-], function() {
-	'use strict';
-});
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/languages.common.ts
code:
@@ -0,0 +1,55 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+'use strict';
+
+// base common
+import 'vs/base/common/json';
+import 'vs/base/common/uri';
+import 'vs/base/common/network';
+import 'vs/base/common/arrays';
+import 'vs/base/common/collections';
+import 'vs/base/common/lifecycle';
+import 'vs/base/common/async';
+import 'vs/base/common/glob';
+import 'vs/base/common/events';
+
+// platform common
+import 'vs/platform/configuration/common/configurationRegistry';
+import 'vs/platform/files/common/files';
+import 'vs/platform/search/common/search';
+import 'vs/platform/request/common/request';
+import 'vs/platform/workspace/common/workspace';
+import 'vs/platform/telemetry/common/telemetry';
+
+// Editor common
+import 'vs/editor/common/editorCommon';
+import 'vs/editor/common/modes/modesRegistry';
+import 'vs/editor/common/modes/monarch/monarch';
+import 'vs/editor/common/modes/monarch/monarchCompile';
+import 'vs/editor/common/modes/textToHtmlTokenizer';
+import 'vs/editor/common/services/modeService';
+import 'vs/editor/common/services/modelService';
+
+// Modules duplicated in different language bundles
+this.require.config({
+	ignoreDuplicateModules: [
+		// Both TypeScript and JavaScript are referencing and including these
+		'vs/languages/typescript/common/features/tokenization',
+
+		'vs/languages/typescript/common/features/quickFixMainActions',
+		'vs/nls!vs/languages/typescript/common/features/quickFixMainActions',
+
+		'vs/languages/typescript/common/typescript',
+
+		'vs/languages/typescript/common/typescriptMode',
+		'vs/nls!vs/languages/typescript/common/typescriptMode',
+
+		'vs/languages/javascript/common/javascript.extensions',
+
+		// Both markdown and html are referencing and including:
+		'vs/languages/html/common/htmlTokenTypes',
+	]
+});

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/editStack.ts
code:
@@ -4,36 +4,36 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
+import {onUnexpectedError} from 'vs/base/common/errors';
+import {ICursorStateComputer, IEditableTextModel, IEditorSelection, IIdentifiedSingleEditOperation} from 'vs/editor/common/editorCommon';
 
 interface IEditOperation {
-	operations: EditorCommon.IIdentifiedSingleEditOperation[];
+	operations: IIdentifiedSingleEditOperation[];
 }
 
 interface IStackElement {
 	beforeVersionId: number;
-	beforeCursorState: EditorCommon.IEditorSelection[];
+	beforeCursorState: IEditorSelection[];
 
 	editOperations: IEditOperation[];
 
-	afterCursorState: EditorCommon.IEditorSelection[];
+	afterCursorState: IEditorSelection[];
 	afterVersionId: number;
 }
 
 export interface IUndoRedoResult {
-	selections: EditorCommon.IEditorSelection[];
+	selections: IEditorSelection[];
 	recordedVersionId: number;
 }
 
 export class EditStack {
 
-	private model:EditorCommon.IEditableTextModel;
+	private model:IEditableTextModel;
 	private currentOpenStackElement:IStackElement;
 	private past:IStackElement[];
 	private future:IStackElement[];
 
-	constructor(model:EditorCommon.IEditableTextModel) {
+	constructor(model:IEditableTextModel) {
 		this.model = model;
 		this.currentOpenStackElement = null;
 		this.past = [];
@@ -53,7 +53,7 @@ export class EditStack {
 		this.future = [];
 	}
 
-	public pushEditOperation(beforeCursorState: EditorCommon.IEditorSelection[], editOperations:EditorCommon.IIdentifiedSingleEditOperation[], cursorStateComputer:EditorCommon.ICursorStateComputer): EditorCommon.IEditorSelection[] {
+	public pushEditOperation(beforeCursorState: IEditorSelection[], editOperations:IIdentifiedSingleEditOperation[], cursorStateComputer:ICursorStateComputer): IEditorSelection[] {
 		// No support for parallel universes :(
 		this.future = [];
 
@@ -75,7 +75,7 @@ export class EditStack {
 		try {
 			this.currentOpenStackElement.afterCursorState = cursorStateComputer ? cursorStateComputer(inverseEditOperation.operations) : null;
 		} catch (e) {
-			Errors.onUnexpectedError(e);
+			onUnexpectedError(e);
 			this.currentOpenStackElement.afterCursorState = null;
 		}
 		this.currentOpenStackElement.afterVersionId = this.model.getVersionId();

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/editableTextModel.ts
code:
@@ -6,11 +6,11 @@
 
 import {TPromise} from 'vs/base/common/winjs.base';
 import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {EditStack} from 'vs/editor/common/model/editStack';
-import {ModelLine, ILineEdit, ILineMarker} from 'vs/editor/common/model/modelLine';
-import {TextModelWithDecorations, DeferredEventsBuilder} from 'vs/editor/common/model/textModelWithDecorations';
+import {ILineEdit, ILineMarker, ModelLine} from 'vs/editor/common/model/modelLine';
+import {DeferredEventsBuilder, TextModelWithDecorations} from 'vs/editor/common/model/textModelWithDecorations';
 import {IMode} from 'vs/editor/common/modes';
-import EditorCommon = require('vs/editor/common/editorCommon');
 
 export interface IDeltaSingleEditOperation {
 	original: IValidatedEditOperation;
@@ -21,8 +21,8 @@ export interface IDeltaSingleEditOperation {
 }
 
 export interface IValidatedEditOperation {
-	identifier: EditorCommon.ISingleEditOperationIdentifier;
-	range: EditorCommon.IEditorRange;
+	identifier: editorCommon.ISingleEditOperationIdentifier;
+	range: editorCommon.IEditorRange;
 	rangeLength: number;
 	lines: string[];
 	forceMoveMarkers: boolean;
@@ -32,7 +32,7 @@ interface IIdentifiedLineEdit extends ILineEdit{
 	lineNumber: number;
 }
 
-export class EditableTextModel extends TextModelWithDecorations implements EditorCommon.IEditableTextModel {
+export class EditableTextModel extends TextModelWithDecorations implements editorCommon.IEditableTextModel {
 
 	private _commandManager:EditStack;
 
@@ -44,9 +44,9 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 	private _hasEditableRange:boolean;
 	private _editableRangeId:string;
 
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
-		allowedEventTypes.push(EditorCommon.EventType.ModelContentChanged);
-		allowedEventTypes.push(EditorCommon.EventType.ModelContentChanged2);
+	constructor(allowedEventTypes:string[], rawText:editorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
+		allowedEventTypes.push(editorCommon.EventType.ModelContentChanged);
+		allowedEventTypes.push(editorCommon.EventType.ModelContentChanged2);
 		super(allowedEventTypes, rawText, modeOrPromise);
 
 		this._commandManager = new EditStack(this);
@@ -63,7 +63,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		super.dispose();
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:editorCommon.IModelContentChangedFlushEvent, newValue:string): void {
 		super._resetValue(e, newValue);
 
 		// Destroy my edit history and settings
@@ -80,7 +80,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		this._commandManager.pushStackElement();
 	}
 
-	public pushEditOperations(beforeCursorState:EditorCommon.IEditorSelection[], editOperations:EditorCommon.IIdentifiedSingleEditOperation[], cursorStateComputer:EditorCommon.ICursorStateComputer): EditorCommon.IEditorSelection[] {
+	public pushEditOperations(beforeCursorState:editorCommon.IEditorSelection[], editOperations:editorCommon.IIdentifiedSingleEditOperation[], cursorStateComputer:editorCommon.ICursorStateComputer): editorCommon.IEditorSelection[] {
 		if (this._isDisposed) {
 			throw new Error('EditableTextModel.pushEditOperations: Model is disposed');
 		}
@@ -161,7 +161,10 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		};
 	}
 
-	public applyEdits(rawOperations:EditorCommon.IIdentifiedSingleEditOperation[]): EditorCommon.IIdentifiedSingleEditOperation[] {
+	public applyEdits(rawOperations:editorCommon.IIdentifiedSingleEditOperation[]): editorCommon.IIdentifiedSingleEditOperation[] {
+		if (rawOperations.length === 0) {
+			return [];
+		}
 
 		let operations:IValidatedEditOperation[] = [];
 		for (let i = 0; i < rawOperations.length; i++) {
@@ -205,7 +208,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		// Delta encode operations
 		let deltaOperations = EditableTextModel._toDeltaOperations(operations);
 		let reverseRanges = EditableTextModel._getInverseEditRanges(deltaOperations);
-		let reverseOperations: EditorCommon.IIdentifiedSingleEditOperation[] = [];
+		let reverseOperations: editorCommon.IIdentifiedSingleEditOperation[] = [];
 		for (let i = 0; i < operations.length; i++) {
 			reverseOperations[i] = {
 				identifier: operations[i].identifier,
@@ -238,17 +241,17 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 	/**
 	 * Assumes `operations` are validated and sorted ascending
 	 */
-	public static _getInverseEditRanges(operations:IDeltaSingleEditOperation[]): EditorCommon.IEditorRange[] {
+	public static _getInverseEditRanges(operations:IDeltaSingleEditOperation[]): editorCommon.IEditorRange[] {
 		let lineNumber = 0,
 			column = 0,
-			result:EditorCommon.IEditorRange[] = [];
+			result:editorCommon.IEditorRange[] = [];
 
 		for (let i = 0, len = operations.length; i < len; i++) {
 			let op = operations[i];
 
 			let startLineNumber = op.deltaStartLineNumber + lineNumber;
 			let startColumn = op.deltaStartColumn + (op.deltaStartLineNumber === 0 ? column : 0);
-			let resultRange: EditorCommon.IEditorRange;
+			let resultRange: editorCommon.IEditorRange;
 
 			if (op.original.lines && op.original.lines.length > 0) {
 				// There is something to insert
@@ -279,8 +282,8 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		operations = operations.sort((a, b) => -Range.compareRangesUsingEnds(a.range, b.range));
 
 		this._withDeferredEvents((deferredEventsBuilder:DeferredEventsBuilder) => {
-			let contentChangedEvents: EditorCommon.IModelContentChangedEvent[] = [];
-			let contentChanged2Events: EditorCommon.IModelContentChangedEvent2[] = [];
+			let contentChangedEvents: editorCommon.IModelContentChangedEvent[] = [];
+			let contentChanged2Events: editorCommon.IModelContentChangedEvent2[] = [];
 			let lineEditsQueue: IIdentifiedLineEdit[] = [];
 
 			let queueLineEdit = (lineEdit:IIdentifiedLineEdit) => {
@@ -473,10 +476,10 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 				}
 
 				for (let i = 0, len = contentChangedEvents.length; i < len; i++) {
-					this.emit(EditorCommon.EventType.ModelContentChanged, contentChangedEvents[i]);
+					this.emit(editorCommon.EventType.ModelContentChanged, contentChangedEvents[i]);
 				}
 				for (let i = 0, len = contentChanged2Events.length; i < len; i++) {
-					this.emit(EditorCommon.EventType.ModelContentChanged2, contentChanged2Events[i]);
+					this.emit(editorCommon.EventType.ModelContentChanged2, contentChanged2Events[i]);
 				}
 			}
 
@@ -519,7 +522,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		return result;
 	}
 
-	public undo(): EditorCommon.IEditorSelection[] {
+	public undo(): editorCommon.IEditorSelection[] {
 		if (this._isDisposed) {
 			throw new Error('EditableTextModel.undo: Model is disposed');
 		}
@@ -539,7 +542,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		});
 	}
 
-	public redo(): EditorCommon.IEditorSelection[] {
+	public redo(): editorCommon.IEditorSelection[] {
 		if (this._isDisposed) {
 			throw new Error('EditableTextModel.redo: Model is disposed');
 		}
@@ -559,7 +562,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		});
 	}
 
-	public setEditableRange(range:EditorCommon.IRange): void {
+	public setEditableRange(range:editorCommon.IRange): void {
 		if (this._isDisposed) {
 			throw new Error('EditableTextModel.setEditableRange: Model is disposed');
 		}
@@ -573,7 +576,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 
 		if (range) {
 			this._hasEditableRange = true;
-			this._editableRangeId = this.addTrackedRange(range, EditorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges);
+			this._editableRangeId = this.addTrackedRange(range, editorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges);
 		}
 	}
 
@@ -585,7 +588,7 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		return this._hasEditableRange;
 	}
 
-	public getEditableRange(): EditorCommon.IEditorRange {
+	public getEditableRange(): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('EditableTextModel.getEditableRange: Model is disposed');
 		}
@@ -597,9 +600,9 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		}
 	}
 
-	private _createLineChangedEvent(lineNumber: number): EditorCommon.IModelContentChangedLineChangedEvent {
+	private _createLineChangedEvent(lineNumber: number): editorCommon.IModelContentChangedLineChangedEvent {
 		return {
-			changeType: EditorCommon.EventType.ModelContentChangedLineChanged,
+			changeType: editorCommon.EventType.ModelContentChangedLineChanged,
 			lineNumber: lineNumber,
 			detail: this._lines[lineNumber - 1].text,
 			versionId: -1,
@@ -608,9 +611,9 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		};
 	}
 
-	private _createLinesDeletedEvent(fromLineNumber: number, toLineNumber: number): EditorCommon.IModelContentChangedLinesDeletedEvent {
+	private _createLinesDeletedEvent(fromLineNumber: number, toLineNumber: number): editorCommon.IModelContentChangedLinesDeletedEvent {
 		return {
-			changeType: EditorCommon.EventType.ModelContentChangedLinesDeleted,
+			changeType: editorCommon.EventType.ModelContentChangedLinesDeleted,
 			fromLineNumber: fromLineNumber,
 			toLineNumber: toLineNumber,
 			versionId: -1,
@@ -619,9 +622,9 @@ export class EditableTextModel extends TextModelWithDecorations implements Edito
 		};
 	}
 
-	private _createLinesInsertedEvent(fromLineNumber: number, toLineNumber: number, newLinesContent: string): EditorCommon.IModelContentChangedLinesInsertedEvent {
+	private _createLinesInsertedEvent(fromLineNumber: number, toLineNumber: number, newLinesContent: string): editorCommon.IModelContentChangedLinesInsertedEvent {
 		return {
-			changeType: EditorCommon.EventType.ModelContentChangedLinesInserted,
+			changeType: editorCommon.EventType.ModelContentChangedLinesInserted,
 			fromLineNumber: fromLineNumber,
 			toLineNumber: toLineNumber,
 			detail: newLinesContent,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/mirrorModel.ts
code:
@@ -4,28 +4,28 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {disposeAll} from 'vs/base/common/lifecycle';
+import URI from 'vs/base/common/uri';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {PrefixSumComputer, IPrefixSumIndexOfResult} from 'vs/editor/common/viewModel/prefixSumComputer';
-import {IMode} from 'vs/editor/common/modes';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ModelLine} from 'vs/editor/common/model/modelLine';
 import {TextModel} from 'vs/editor/common/model/textModel';
 import {TextModelWithTokens} from 'vs/editor/common/model/textModelWithTokens';
-import {ModelLine} from 'vs/editor/common/model/modelLine';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {IMode} from 'vs/editor/common/modes';
 import {IResourceService} from 'vs/editor/common/services/resourceService';
-import URI from 'vs/base/common/uri';
-import {disposeAll} from 'vs/base/common/lifecycle';
+import {IPrefixSumIndexOfResult, PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
 
 export interface IMirrorModelEvents {
-	contentChanged: EditorCommon.IModelContentChangedEvent[];
+	contentChanged: editorCommon.IModelContentChangedEvent[];
 }
 
-export class AbstractMirrorModel extends TextModelWithTokens implements EditorCommon.IMirrorModel {
+export class AbstractMirrorModel extends TextModelWithTokens implements editorCommon.IMirrorModel {
 
 	_lineStarts:PrefixSumComputer;
 	_associatedResource:URI;
 
-	constructor(allowedEventTypes:string[], versionId:number, value:EditorCommon.IRawText, mode:IMode|TPromise<IMode>, associatedResource?:URI) {
-		super(allowedEventTypes.concat([EditorCommon.EventType.ModelDispose]), value, false, mode);
+	constructor(allowedEventTypes:string[], versionId:number, value:editorCommon.IRawText, mode:IMode|TPromise<IMode>, associatedResource?:URI) {
+		super(allowedEventTypes.concat([editorCommon.EventType.ModelDispose]), value, false, mode);
 
 		this._setVersionId(versionId);
 		this._associatedResource = associatedResource;
@@ -39,15 +39,15 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		return this.getMode().getId();
 	}
 
-	public getEmbeddedAtPosition(position:EditorCommon.IPosition):EditorCommon.IMirrorModel {
+	public getEmbeddedAtPosition(position:editorCommon.IPosition):editorCommon.IMirrorModel {
 		return null;
 	}
 
-	public getAllEmbedded():EditorCommon.IMirrorModel[] {
+	public getAllEmbedded():editorCommon.IMirrorModel[] {
 		return [];
 	}
 
-	public _constructLines(rawText:EditorCommon.IRawText):void {
+	public _constructLines(rawText:editorCommon.IRawText):void {
 		super._constructLines(rawText);
 		// Force EOL to be \n
 		this._EOL = '\n';
@@ -58,7 +58,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 	}
 
 	public dispose(): void {
-		this.emit(EditorCommon.EventType.ModelDispose);
+		this.emit(editorCommon.EventType.ModelDispose);
 		super.dispose();
 	}
 
@@ -81,7 +81,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		}
 	}
 
-	public getRangeFromOffsetAndLength(offset:number, length:number):EditorCommon.IRange {
+	public getRangeFromOffsetAndLength(offset:number, length:number):editorCommon.IRange {
 		if (this._isDisposed) {
 			throw new Error('AbstractMirrorModel.getRangeFromOffsetAndLength: Model is disposed');
 		}
@@ -96,7 +96,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		};
 	}
 
-	public getOffsetAndLengthFromRange(range:EditorCommon.IRange):{offset:number; length:number;} {
+	public getOffsetAndLengthFromRange(range:editorCommon.IRange):{offset:number; length:number;} {
 		if (this._isDisposed) {
 			throw new Error('AbstractMirrorModel.getOffsetAndLengthFromRange: Model is disposed');
 		}
@@ -109,7 +109,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		};
 	}
 
-	public getPositionFromOffset(offset:number):EditorCommon.IPosition {
+	public getPositionFromOffset(offset:number):editorCommon.IPosition {
 		if (this._isDisposed) {
 			throw new Error('AbstractMirrorModel.getPositionFromOffset: Model is disposed');
 		}
@@ -126,7 +126,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		};
 	}
 
-	public getOffsetFromPosition(position:EditorCommon.IPosition): number {
+	public getOffsetFromPosition(position:editorCommon.IPosition): number {
 		if (this._isDisposed) {
 			throw new Error('AbstractMirrorModel.getOffsetFromPosition: Model is disposed');
 		}
@@ -145,7 +145,7 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 		return this._lineStarts.getAccumulatedValue(lineIndex - 1);
 	}
 
-	public getAllWordsWithRange(): EditorCommon.IRangeWithText[] {
+	public getAllWordsWithRange(): editorCommon.IRangeWithText[] {
 		if (this._isDisposed) {
 			throw new Error('AbstractMirrorModel.getAllWordsWithRange: Model is disposed');
 		}
@@ -154,10 +154,10 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 			return [];
 		}
 
-		var result:EditorCommon.IRangeWithText[] = [],
+		var result:editorCommon.IRangeWithText[] = [],
 			i:number;
 
-		var toTextRange = function (info: EditorCommon.IWordRange) {
+		var toTextRange = function (info: editorCommon.IWordRange) {
 			var s = line.text.substring(info.start, info.end);
 			var r = { startLineNumber: i + 1, startColumn: info.start + 1, endLineNumber: i + 1, endColumn: info.end + 1 };
 			result.push({ text: s, range: r});
@@ -206,8 +206,8 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 	}
 
 //	// TODO@Joh, TODO@Alex - remove these and make sure the super-things work
-	private wordenize(content:string): EditorCommon.IWordRange[] {
-		var result:EditorCommon.IWordRange[] = [];
+	private wordenize(content:string): editorCommon.IWordRange[] {
+		var result:editorCommon.IWordRange[] = [];
 		var match:RegExpExecArray;
 		var wordsRegexp = this._getWordDefinition();
 		while (match = wordsRegexp.exec(content)) {
@@ -217,16 +217,16 @@ export class AbstractMirrorModel extends TextModelWithTokens implements EditorCo
 	}
 }
 
-export class MirrorModelEmbedded extends AbstractMirrorModel implements EditorCommon.IMirrorModel {
+export class MirrorModelEmbedded extends AbstractMirrorModel implements editorCommon.IMirrorModel {
 
 	private _actualModel:MirrorModel;
 
-	constructor(actualModel:MirrorModel, includeRanges:EditorCommon.IRange[], mode:IMode, url:URI) {
+	constructor(actualModel:MirrorModel, includeRanges:editorCommon.IRange[], mode:IMode, url:URI) {
 		super(['changed'], actualModel.getVersionId(), MirrorModelEmbedded._getMirrorValueWithinRanges(actualModel, includeRanges), mode, url);
 		this._actualModel = actualModel;
 	}
 
-	private static _getMirrorValueWithinRanges(actualModel:MirrorModel, includeRanges:EditorCommon.IRange[]): EditorCommon.IRawText {
+	private static _getMirrorValueWithinRanges(actualModel:MirrorModel, includeRanges:editorCommon.IRange[]): editorCommon.IRawText {
 
 		var	resultingText = '',
 			prevLineAdded = 1,
@@ -262,7 +262,7 @@ export class MirrorModelEmbedded extends AbstractMirrorModel implements EditorCo
 		return TextModel.toRawText(resultingText);
 	}
 
-	public setIncludedRanges(newIncludedRanges:EditorCommon.IRange[]): void {
+	public setIncludedRanges(newIncludedRanges:editorCommon.IRange[]): void {
 		var prevVersionId = this.getVersionId();
 
 		// Force recreating of line starts (when used)
@@ -279,7 +279,7 @@ export class MirrorModelEmbedded extends AbstractMirrorModel implements EditorCo
 
 class EmbeddedModeRange {
 	public mode: IMode;
-	public ranges: EditorCommon.IRange[];
+	public ranges: editorCommon.IRange[];
 
 	public constructor(mode: IMode) {
 		this.mode = mode;
@@ -291,20 +291,20 @@ export function createMirrorModelFromString(resourceService:IResourceService, ve
 	return new MirrorModel(resourceService, versionId, TextModel.toRawText(value), mode, associatedResource);
 }
 
-export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMirrorModel {
+export class MirrorModel extends AbstractMirrorModel implements editorCommon.IMirrorModel {
 
 	private _resourceService: IResourceService;
 	private _embeddedModels: {[modeId:string]:MirrorModelEmbedded;};
 
-	constructor(resourceService:IResourceService, versionId:number, value:EditorCommon.IRawText, mode:IMode|TPromise<IMode>, associatedResource?:URI) {
+	constructor(resourceService:IResourceService, versionId:number, value:editorCommon.IRawText, mode:IMode|TPromise<IMode>, associatedResource?:URI) {
 		super(['changed'], versionId, value, mode, associatedResource);
 
 		this._resourceService = resourceService;
 		this._embeddedModels = {};
 		this._updateEmbeddedModels();
 	}
 
-	public getEmbeddedAtPosition(position:EditorCommon.IPosition):EditorCommon.IMirrorModel {
+	public getEmbeddedAtPosition(position:editorCommon.IPosition):editorCommon.IMirrorModel {
 		if (this._isDisposed) {
 			throw new Error('MirrorModel.getEmbeddedAtPosition: Model is disposed');
 		}
@@ -316,7 +316,7 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 		return null;
 	}
 
-	public getAllEmbedded():EditorCommon.IMirrorModel[] {
+	public getAllEmbedded():editorCommon.IMirrorModel[] {
 		if (this._isDisposed) {
 			throw new Error('MirrorModel.getAllEmbedded: Model is disposed');
 		}
@@ -339,7 +339,7 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 		this._updateEmbeddedModels();
 	}
 
-	private static _getModesRanges(model: EditorCommon.IMirrorModel): {[modeId:string]:EmbeddedModeRange} {
+	private static _getModesRanges(model: editorCommon.IMirrorModel): {[modeId:string]:EmbeddedModeRange} {
 		var encounteredModesRanges:{[modeId:string]:EmbeddedModeRange} = {};
 
 		var getOrCreateEmbeddedModeRange = (modeId:string, mode:IMode) => {
@@ -444,23 +444,23 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 
 			this._setVersionId(contentChangedEvent.versionId);
 			switch (contentChangedEvent.changeType) {
-				case EditorCommon.EventType.ModelContentChangedFlush:
-					this._onLinesFlushed(<EditorCommon.IModelContentChangedFlushEvent>contentChangedEvent);
+				case editorCommon.EventType.ModelContentChangedFlush:
+					this._onLinesFlushed(<editorCommon.IModelContentChangedFlushEvent>contentChangedEvent);
 					changed = true;
 					break;
 
-				case EditorCommon.EventType.ModelContentChangedLinesDeleted:
-					this._onLinesDeleted(<EditorCommon.IModelContentChangedLinesDeletedEvent>contentChangedEvent);
+				case editorCommon.EventType.ModelContentChangedLinesDeleted:
+					this._onLinesDeleted(<editorCommon.IModelContentChangedLinesDeletedEvent>contentChangedEvent);
 					changed = true;
 					break;
 
-				case EditorCommon.EventType.ModelContentChangedLinesInserted:
-					this._onLinesInserted(<EditorCommon.IModelContentChangedLinesInsertedEvent>contentChangedEvent);
+				case editorCommon.EventType.ModelContentChangedLinesInserted:
+					this._onLinesInserted(<editorCommon.IModelContentChangedLinesInsertedEvent>contentChangedEvent);
 					changed = true;
 					break;
 
-				case EditorCommon.EventType.ModelContentChangedLineChanged:
-					this._onLineChanged(<EditorCommon.IModelContentChangedLineChangedEvent>contentChangedEvent);
+				case editorCommon.EventType.ModelContentChangedLineChanged:
+					this._onLineChanged(<editorCommon.IModelContentChangedLineChangedEvent>contentChangedEvent);
 					changed = true;
 					break;
 			}
@@ -474,13 +474,13 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 		return shouldFlushMarkers;
 	}
 
-	private _onLinesFlushed(e:EditorCommon.IModelContentChangedFlushEvent): void {
+	private _onLinesFlushed(e:editorCommon.IModelContentChangedFlushEvent): void {
 		// Flush my lines
 		this._constructLines(e.detail);
 		this._resetTokenizationState();
 	}
 
-	private _onLineChanged(e:EditorCommon.IModelContentChangedLineChangedEvent) : void {
+	private _onLineChanged(e:editorCommon.IModelContentChangedLineChangedEvent) : void {
 		this._lines[e.lineNumber - 1].applyEdits({}, [{
 			startColumn: 1,
 			endColumn: Number.MAX_VALUE,
@@ -491,7 +491,7 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 		this._invalidateLine(e.lineNumber - 1);
 	}
 
-	private _onLinesDeleted(e:EditorCommon.IModelContentChangedLinesDeletedEvent) : void {
+	private _onLinesDeleted(e:editorCommon.IModelContentChangedLinesDeletedEvent) : void {
 		var fromLineIndex = e.fromLineNumber - 1,
 			toLineIndex = e.toLineNumber - 1;
 
@@ -511,7 +511,7 @@ export class MirrorModel extends AbstractMirrorModel implements EditorCommon.IMi
 		}
 	}
 
-	private _onLinesInserted(e:EditorCommon.IModelContentChangedLinesInsertedEvent) : void {
+	private _onLinesInserted(e:editorCommon.IModelContentChangedLinesInsertedEvent) : void {
 		var lineIndex:number,
 			i:number,
 			splitLines = e.detail.split('\n');

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/mirrorModel2.ts
code:
@@ -5,7 +5,7 @@
 'use strict';
 
 import URI from 'vs/base/common/uri';
-import {IModelContentChangedEvent2, IRange, IPosition} from 'vs/editor/common/editorCommon';
+import {IModelContentChangedEvent2, IPosition, IRange} from 'vs/editor/common/editorCommon';
 import {PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
 
 export class MirrorModel2 {

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/model.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import URI from 'vs/base/common/uri';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {IMode} from 'vs/editor/common/modes';
-import {TextModel} from 'vs/editor/common/model/textModel';
+import {EventType, IModel} from 'vs/editor/common/editorCommon';
 import {EditableTextModel} from 'vs/editor/common/model/editableTextModel';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import URI from 'vs/base/common/uri';
+import {TextModel} from 'vs/editor/common/model/textModel';
+import {IMode} from 'vs/editor/common/modes';
 
 // The hierarchy is:
 // Model -> EditableTextModel -> TextModelWithDecorations -> TextModelWithTrackedRanges -> TextModelWithMarkers -> TextModelWithTokens -> TextModel
@@ -29,7 +29,7 @@ var aliveModels:{[modelId:string]:boolean;} = {};
 // 	LAST_CNT = cnt;
 // }, 100);
 
-export class Model extends EditableTextModel implements EditorCommon.IModel {
+export class Model extends EditableTextModel implements IModel {
 
 	public id:string;
 
@@ -51,7 +51,7 @@ export class Model extends EditableTextModel implements EditorCommon.IModel {
 	 */
 	constructor(rawText:string, modeOrPromise:IMode|TPromise<IMode>, associatedResource:URI=null) {
 		super([
-			EditorCommon.EventType.ModelDispose
+			EventType.ModelDispose
 		], TextModel.toRawText(rawText), modeOrPromise);
 
 		// Generate a new unique model id
@@ -86,7 +86,7 @@ export class Model extends EditableTextModel implements EditorCommon.IModel {
 	public dispose(): void {
 		this._isDisposing = true;
 		delete aliveModels[String(this._associatedResource)];
-		this.emit(EditorCommon.EventType.ModelDispose);
+		this.emit(EventType.ModelDispose);
 		super.dispose();
 		this._isDisposing = false;
 		// console.log('ALIVE MODELS: ' + Object.keys(aliveModels).join('\n'));

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/modelLine.ts
code:
@@ -4,9 +4,9 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Strings = require('vs/base/common/strings');
-import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as strings from 'vs/base/common/strings';
+import {ILineTokens, IReadOnlyLineMarker, ITokensInflatorMap, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {IMode, IModeTransition, IState, IToken} from 'vs/editor/common/modes';
 
 export interface ILineEdit {
 	startColumn: number;
@@ -15,7 +15,7 @@ export interface ILineEdit {
 	forceMoveMarkers: boolean;
 }
 
-export interface ILineMarker extends EditorCommon.IReadOnlyLineMarker {
+export interface ILineMarker extends IReadOnlyLineMarker {
 	id:string;
 	column:number;
 	stickToPreviousCharacter:boolean;
@@ -31,7 +31,7 @@ export interface IChangedMarkers {
 }
 
 export interface IModeTransitions {
-	toArray(topLevelMode: Modes.IMode): Modes.IModeTransition[];
+	toArray(topLevelMode: IMode): IModeTransition[];
 }
 
 export interface ITextWithMarkers {
@@ -63,9 +63,9 @@ export class ModelLine {
 	public text:string;
 	public isInvalid:boolean;
 
-	private _state:Modes.IState;
+	private _state:IState;
 	private _modeTransitions:IModeTransitions;
-	private _lineTokens:EditorCommon.ILineTokens;
+	private _lineTokens:ILineTokens;
 	private _markers:ILineMarker[];
 
 	constructor(lineNumber:number, text:string) {
@@ -76,19 +76,19 @@ export class ModelLine {
 
 	// --- BEGIN STATE
 
-	public setState(state: Modes.IState): void {
+	public setState(state: IState): void {
 		this._state = state;
 	}
 
-	public getState(): Modes.IState {
+	public getState(): IState {
 		return this._state || null;
 	}
 
 	// --- END STATE
 
 	// --- BEGIN MODE TRANSITIONS
 
-	private _setModeTransitions(topLevelMode:Modes.IMode, modeTransitions:Modes.IModeTransition[]): void {
+	private _setModeTransitions(topLevelMode:IMode, modeTransitions:IModeTransition[]): void {
 		let desired = toModeTransitions(topLevelMode, modeTransitions);
 
 		if (desired === null) {
@@ -114,12 +114,12 @@ export class ModelLine {
 
 	// --- BEGIN TOKENS
 
-	public setTokens(map: EditorCommon.ITokensInflatorMap, tokens: Modes.IToken[], topLevelMode:Modes.IMode, modeTransitions:Modes.IModeTransition[]): void {
+	public setTokens(map: ITokensInflatorMap, tokens: IToken[], topLevelMode:IMode, modeTransitions:IModeTransition[]): void {
 		this._setLineTokens(map, tokens);
 		this._setModeTransitions(topLevelMode, modeTransitions);
 	}
 
-	private _setLineTokens(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]|number[]): void {
+	private _setLineTokens(map:ITokensInflatorMap, tokens:IToken[]|number[]): void {
 		let desired = toLineTokens(map, tokens, this.text.length);
 
 		if (desired === null) {
@@ -134,7 +134,7 @@ export class ModelLine {
 		this._lineTokens = desired;
 	}
 
-	public getTokens(): EditorCommon.ILineTokens {
+	public getTokens(): ILineTokens {
 		if (this._lineTokens) {
 			return this._lineTokens;
 		}
@@ -154,7 +154,7 @@ export class ModelLine {
 
 		var lineTokens = this._lineTokens;
 
-		let BIN = EditorCommon.LineTokensBinaryEncoding;
+		let BIN = LineTokensBinaryEncoding;
 		let tokens = lineTokens.getBinaryEncodedTokens();
 		let tokensLength = tokens.length;
 		let tokensIndex = 0;
@@ -214,7 +214,7 @@ export class ModelLine {
 		this.text = text;
 
 		if (this._lineTokens) {
-			let BIN = EditorCommon.LineTokensBinaryEncoding,
+			let BIN = LineTokensBinaryEncoding,
 				map = this._lineTokens.getBinaryEncodedTokensMap(),
 				tokens = this._lineTokens.getBinaryEncodedTokens(),
 				lineTextLength = this.text.length;
@@ -431,7 +431,7 @@ export class ModelLine {
 
 			// Adjust other tokens
 			if (thisTextLength > 0) {
-				let BIN = EditorCommon.LineTokensBinaryEncoding;
+				let BIN = LineTokensBinaryEncoding;
 
 				for (let i = 0, len = otherTokens.length; i < len; i++) {
 					let token = otherTokens[i];
@@ -599,11 +599,11 @@ export class ModelLine {
 	}
 }
 
-function areDeflatedTokens(tokens:Modes.IToken[]|number[]): tokens is number[] {
+function areDeflatedTokens(tokens:IToken[]|number[]): tokens is number[] {
 	return (typeof tokens[0] === 'number');
 }
 
-function toLineTokens(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]|number[], textLength:number): EditorCommon.ILineTokens {
+function toLineTokens(map:ITokensInflatorMap, tokens:IToken[]|number[], textLength:number): ILineTokens {
 	if (textLength === 0) {
 		return null;
 	}
@@ -624,29 +624,29 @@ function toLineTokens(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]
 	return new LineTokens(map, tokens);
 }
 
-var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;
-var getType = EditorCommon.LineTokensBinaryEncoding.getType;
-var findIndexOfOffset = EditorCommon.LineTokensBinaryEncoding.findIndexOfOffset;
+var getStartIndex = LineTokensBinaryEncoding.getStartIndex;
+var getType = LineTokensBinaryEncoding.getType;
+var findIndexOfOffset = LineTokensBinaryEncoding.findIndexOfOffset;
 
-export class LineTokens implements EditorCommon.ILineTokens {
+export class LineTokens implements ILineTokens {
 
-	private map:EditorCommon.ITokensInflatorMap;
+	private map:ITokensInflatorMap;
 	private _tokens:number[];
 
-	constructor(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]|number[]) {
+	constructor(map:ITokensInflatorMap, tokens:IToken[]|number[]) {
 		this.map = map;
 		if (areDeflatedTokens(tokens)) {
 			this._tokens = tokens;
 		} else {
-			this._tokens = EditorCommon.LineTokensBinaryEncoding.deflateArr(map, tokens);
+			this._tokens = LineTokensBinaryEncoding.deflateArr(map, tokens);
 		}
 	}
 
 	public toString(): string {
-		return EditorCommon.LineTokensBinaryEncoding.inflateArr(this.map, this._tokens).toString();
+		return LineTokensBinaryEncoding.inflateArr(this.map, this._tokens).toString();
 	}
 
-	public getBinaryEncodedTokensMap(): EditorCommon.ITokensInflatorMap {
+	public getBinaryEncodedTokensMap(): ITokensInflatorMap {
 		return this.map;
 	}
 
@@ -673,7 +673,7 @@ export class LineTokens implements EditorCommon.ILineTokens {
 		return textLength;
 	}
 
-	public equals(other:EditorCommon.ILineTokens): boolean {
+	public equals(other:ILineTokens): boolean {
 		return this === other;
 	}
 
@@ -682,7 +682,7 @@ export class LineTokens implements EditorCommon.ILineTokens {
 	}
 }
 
-class EmptyLineTokens implements EditorCommon.ILineTokens {
+class EmptyLineTokens implements ILineTokens {
 
 	public static INSTANCE = new EmptyLineTokens();
 	private static TOKENS = <number[]>[];
@@ -691,7 +691,7 @@ class EmptyLineTokens implements EditorCommon.ILineTokens {
 		return EmptyLineTokens.TOKENS;
 	}
 
-	public getBinaryEncodedTokensMap(): EditorCommon.ITokensInflatorMap {
+	public getBinaryEncodedTokensMap(): ITokensInflatorMap {
 		return null;
 	}
 
@@ -704,14 +704,14 @@ class EmptyLineTokens implements EditorCommon.ILineTokens {
 	}
 
 	public getTokenType(tokenIndex:number): string {
-		return Strings.empty;
+		return strings.empty;
 	}
 
 	public getTokenEndIndex(tokenIndex:number, textLength:number): number {
 		return 0;
 	}
 
-	public equals(other:EditorCommon.ILineTokens): boolean {
+	public equals(other:ILineTokens): boolean {
 		return other === this;
 	}
 
@@ -720,12 +720,12 @@ class EmptyLineTokens implements EditorCommon.ILineTokens {
 	}
 }
 
-export class DefaultLineTokens implements EditorCommon.ILineTokens {
+export class DefaultLineTokens implements ILineTokens {
 
 	public static INSTANCE = new DefaultLineTokens();
 	private static TOKENS = <number[]> [0];
 
-	public getBinaryEncodedTokensMap(): EditorCommon.ITokensInflatorMap {
+	public getBinaryEncodedTokensMap(): ITokensInflatorMap {
 		return null;
 	}
 
@@ -742,14 +742,14 @@ export class DefaultLineTokens implements EditorCommon.ILineTokens {
 	}
 
 	public getTokenType(tokenIndex:number): string {
-		return Strings.empty;
+		return strings.empty;
 	}
 
 	public getTokenEndIndex(tokenIndex:number, textLength:number): number {
 		return textLength;
 	}
 
-	public equals(other:EditorCommon.ILineTokens): boolean {
+	public equals(other:ILineTokens): boolean {
 		return this === other;
 	}
 
@@ -759,7 +759,7 @@ export class DefaultLineTokens implements EditorCommon.ILineTokens {
 
 }
 
-function toModeTransitions(topLevelMode:Modes.IMode, modeTransitions:Modes.IModeTransition[]): IModeTransitions {
+function toModeTransitions(topLevelMode:IMode, modeTransitions:IModeTransition[]): IModeTransitions {
 
 	if (!modeTransitions || modeTransitions.length === 0) {
 		return null;
@@ -777,7 +777,7 @@ function toModeTransitions(topLevelMode:Modes.IMode, modeTransitions:Modes.IMode
 class DefaultModeTransitions implements IModeTransitions {
 	public static INSTANCE = new DefaultModeTransitions();
 
-	public toArray(topLevelMode:Modes.IMode): Modes.IModeTransition[] {
+	public toArray(topLevelMode:IMode): IModeTransition[] {
 		return [{
 			startIndex: 0,
 			mode: topLevelMode
@@ -787,13 +787,13 @@ class DefaultModeTransitions implements IModeTransitions {
 
 class SingleModeTransition implements IModeTransitions {
 
-	private _mode: Modes.IMode;
+	private _mode: IMode;
 
-	constructor(mode:Modes.IMode) {
+	constructor(mode:IMode) {
 		this._mode = mode;
 	}
 
-	public toArray(topLevelMode:Modes.IMode): Modes.IModeTransition[] {
+	public toArray(topLevelMode:IMode): IModeTransition[] {
 		return [{
 			startIndex: 0,
 			mode: this._mode
@@ -803,13 +803,13 @@ class SingleModeTransition implements IModeTransitions {
 
 class ModeTransitions implements IModeTransitions {
 
-	private _modeTransitions: Modes.IModeTransition[];
+	private _modeTransitions: IModeTransition[];
 
-	constructor(modeTransitions:Modes.IModeTransition[]) {
+	constructor(modeTransitions:IModeTransition[]) {
 		this._modeTransitions = modeTransitions;
 	}
 
-	public toArray(topLevelMode:Modes.IMode): Modes.IModeTransition[] {
+	public toArray(topLevelMode:IMode): IModeTransition[] {
 		return this._modeTransitions.slice(0);
 	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModel.ts
code:
@@ -5,17 +5,17 @@
 'use strict';
 
 import {OrderGuaranteeEventEmitter} from 'vs/base/common/eventEmitter';
-import Strings = require('vs/base/common/strings');
+import * as platform from 'vs/base/common/platform';
+import * as strings from 'vs/base/common/strings';
 import {Position} from 'vs/editor/common/core/position';
 import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ModelLine} from 'vs/editor/common/model/modelLine';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Platform = require('vs/base/common/platform');
 
 var __space = ' '.charCodeAt(0);
 var __tab = '\t'.charCodeAt(0);
 var LIMIT_FIND_COUNT = 999;
-var DEFAULT_PLATFORM_EOL = (Platform.isLinux || Platform.isMacintosh) ? '\n' : '\r\n';
+var DEFAULT_PLATFORM_EOL = (platform.isLinux || platform.isMacintosh) ? '\n' : '\r\n';
 
 export interface IIndentationFactors {
 	/**
@@ -32,7 +32,7 @@ export interface IIndentationFactors {
 	absoluteSpaceCounts:number[];
 }
 
-export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommon.ITextModel {
+export class TextModel extends OrderGuaranteeEventEmitter implements editorCommon.ITextModel {
 
 	_lines:ModelLine[];
 	_EOL:string;
@@ -46,8 +46,8 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 	private _alternativeVersionId: number;
 	private _BOM:string;
 
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText) {
-		allowedEventTypes.push(EditorCommon.EventType.ModelContentChanged);
+	constructor(allowedEventTypes:string[], rawText:editorCommon.IRawText) {
+		allowedEventTypes.push(editorCommon.EventType.ModelContentChanged);
 		super(allowedEventTypes);
 
 		this._constructLines(rawText);
@@ -103,9 +103,9 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		super.dispose();
 	}
 
-	_createContentChangedFlushEvent(): EditorCommon.IModelContentChangedFlushEvent {
+	_createContentChangedFlushEvent(): editorCommon.IModelContentChangedFlushEvent {
 		return {
-			changeType: EditorCommon.EventType.ModelContentChangedFlush,
+			changeType: editorCommon.EventType.ModelContentChangedFlush,
 			detail: null,
 			// TODO@Alex -> remove these fields from here
 			versionId: -1,
@@ -115,7 +115,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 	}
 
 	protected _emitContentChanged2(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, rangeLength:number, text:string, isUndoing:boolean, isRedoing:boolean): void {
-		var e:EditorCommon.IModelContentChangedEvent2 = {
+		var e:editorCommon.IModelContentChangedEvent2 = {
 			range: new Range(startLineNumber, startColumn, endLineNumber, endColumn),
 			rangeLength: rangeLength,
 			text: text,
@@ -125,19 +125,19 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			isRedoing: isRedoing
 		};
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelContentChanged2, e);
+			this.emit(editorCommon.EventType.ModelContentChanged2, e);
 		}
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:editorCommon.IModelContentChangedFlushEvent, newValue:string): void {
 		this._constructLines(TextModel.toRawText(newValue));
 		this._increaseVersionId();
 
 		e.detail = this.toRawText();
 		e.versionId = this._versionId;
 	}
 
-	public toRawText(): EditorCommon.IRawText {
+	public toRawText(): editorCommon.IRawText {
 		return {
 			BOM: this._BOM,
 			EOL: this._EOL,
@@ -165,7 +165,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		this._emitContentChanged2(1, 1, endLineNumber, endColumn, oldModelValueLength, this.getValue(), false, false);
 	}
 
-	public getValue(eol?:EditorCommon.EndOfLinePreference, preserveBOM:boolean=false): string {
+	public getValue(eol?:editorCommon.EndOfLinePreference, preserveBOM:boolean=false): string {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getValue: Model is disposed');
 		}
@@ -180,7 +180,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return fullModelValue;
 	}
 
-	public getValueLength(eol?: EditorCommon.EndOfLinePreference, preserveBOM: boolean = false): number {
+	public getValueLength(eol?: editorCommon.EndOfLinePreference, preserveBOM: boolean = false): number {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getValueLength: Model is disposed');
 		}
@@ -195,7 +195,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return fullModelValue;
 	}
 
-	public getEmptiedValueInRange(rawRange:EditorCommon.IRange, fillCharacter: string = '', eol:EditorCommon.EndOfLinePreference=EditorCommon.EndOfLinePreference.TextDefined): string {
+	public getEmptiedValueInRange(rawRange:editorCommon.IRange, fillCharacter: string = '', eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): string {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getEmptiedValueInRange: Model is disposed');
 		}
@@ -232,7 +232,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return r;
 	}
 
-	public getValueInRange(rawRange:EditorCommon.IRange, eol:EditorCommon.EndOfLinePreference=EditorCommon.EndOfLinePreference.TextDefined): string {
+	public getValueInRange(rawRange:editorCommon.IRange, eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): string {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getValueInRange: Model is disposed');
 		}
@@ -261,7 +261,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return resultLines.join(lineEnding);
 	}
 
-	public getValueLengthInRange(rawRange:EditorCommon.IRange, eol:EditorCommon.EndOfLinePreference=EditorCommon.EndOfLinePreference.TextDefined): number {
+	public getValueLengthInRange(rawRange:editorCommon.IRange, eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): number {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getValueInRange: Model is disposed');
 		}
@@ -457,7 +457,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		};
 	}
 
-	public guessIndentation(defaultTabSize:number): EditorCommon.IGuessedIndentation {
+	public guessIndentation(defaultTabSize:number): editorCommon.IGuessedIndentation {
 		if (this._isDisposed) {
 			throw new Error('TextModel.guessIndentation: Model is disposed');
 		}
@@ -572,8 +572,8 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return this._EOL;
 	}
 
-	public setEOL(eol: EditorCommon.EndOfLineSequence): void {
-		var newEOL = (eol === EditorCommon.EndOfLineSequence.CRLF ? '\r\n' : '\n');
+	public setEOL(eol: editorCommon.EndOfLineSequence): void {
+		var newEOL = (eol === editorCommon.EndOfLineSequence.CRLF ? '\r\n' : '\n');
 		if (this._EOL === newEOL) {
 			// Nothing to do
 			return;
@@ -618,7 +618,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
 
-		var result = Strings.firstNonWhitespaceIndex(this._lines[lineNumber - 1].text);
+		var result = strings.firstNonWhitespaceIndex(this._lines[lineNumber - 1].text);
 		if (result === -1) {
 			return 0;
 		}
@@ -633,7 +633,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
 
-		var result = Strings.lastNonWhitespaceIndex(this._lines[lineNumber - 1].text);
+		var result = strings.lastNonWhitespaceIndex(this._lines[lineNumber - 1].text);
 		if (result === -1) {
 			return 0;
 		}
@@ -654,7 +654,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return lineNumber;
 	}
 
-	public validatePosition(position:EditorCommon.IPosition): EditorCommon.IEditorPosition {
+	public validatePosition(position:editorCommon.IPosition): editorCommon.IEditorPosition {
 		if (this._isDisposed) {
 			throw new Error('TextModel.validatePosition: Model is disposed');
 		}
@@ -680,7 +680,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return new Position(lineNumber, column);
 	}
 
-	public validateRange(range:EditorCommon.IRange): EditorCommon.IEditorRange {
+	public validateRange(range:editorCommon.IRange): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModel.validateRange: Model is disposed');
 		}
@@ -690,7 +690,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return new Range(start.lineNumber, start.column, end.lineNumber, end.column);
 	}
 
-	public modifyPosition(rawPosition: EditorCommon.IPosition, offset: number) : EditorCommon.IEditorPosition {
+	public modifyPosition(rawPosition: editorCommon.IPosition, offset: number) : editorCommon.IEditorPosition {
 		if (this._isDisposed) {
 			throw new Error('TextModel.modifyPosition: Model is disposed');
 		}
@@ -757,7 +757,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return position;
 	}
 
-	public getFullModelRange(): EditorCommon.IEditorRange {
+	public getFullModelRange(): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModel.getFullModelRange: Model is disposed');
 		}
@@ -766,13 +766,13 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return new Range(1, 1, lineCount, this.getLineMaxColumn(lineCount));
 	}
 
-	_emitModelContentChangedFlushEvent(e:EditorCommon.IModelContentChangedFlushEvent): void {
+	_emitModelContentChangedFlushEvent(e:editorCommon.IModelContentChangedFlushEvent): void {
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelContentChanged, e);
+			this.emit(editorCommon.EventType.ModelContentChanged, e);
 		}
 	}
 
-	public static toRawText(rawText:string): EditorCommon.IRawText {
+	public static toRawText(rawText:string): editorCommon.IRawText {
 		// Count the number of lines that end with \r\n
 		var carriageReturnCnt = 0,
 			lastCarriageReturnIndex = -1;
@@ -785,8 +785,8 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 
 		// Remove the BOM (if present)
 		var BOM = '';
-		if (Strings.startsWithUTF8BOM(lines[0])) {
-			BOM = Strings.UTF8_BOM_CHARACTER;
+		if (strings.startsWithUTF8BOM(lines[0])) {
+			BOM = strings.UTF8_BOM_CHARACTER;
 			lines[0] = lines[0].substr(1);
 		}
 
@@ -811,7 +811,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		};
 	}
 
-	_constructLines(rawText:EditorCommon.IRawText): void {
+	_constructLines(rawText:editorCommon.IRawText): void {
 		var rawLines = rawText.lines,
 			modelLines: ModelLine[] = [],
 			i: number,
@@ -825,29 +825,29 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		this._lines = modelLines;
 	}
 
-	private _getEndOfLine(eol:EditorCommon.EndOfLinePreference): string {
+	private _getEndOfLine(eol:editorCommon.EndOfLinePreference): string {
 		switch (eol) {
-			case EditorCommon.EndOfLinePreference.LF:
+			case editorCommon.EndOfLinePreference.LF:
 				return '\n';
-			case EditorCommon.EndOfLinePreference.CRLF:
+			case editorCommon.EndOfLinePreference.CRLF:
 				return '\r\n';
-			case EditorCommon.EndOfLinePreference.TextDefined:
+			case editorCommon.EndOfLinePreference.TextDefined:
 				return this.getEOL();
 		}
 		throw new Error('Unknown EOL preference');
 	}
 
-	public findMatches(searchString:string, rawSearchScope:any, isRegex:boolean, matchCase:boolean, wholeWord:boolean, limitResultCount:number = LIMIT_FIND_COUNT): EditorCommon.IEditorRange[] {
+	public findMatches(searchString:string, rawSearchScope:any, isRegex:boolean, matchCase:boolean, wholeWord:boolean, limitResultCount:number = LIMIT_FIND_COUNT): editorCommon.IEditorRange[] {
 		if (this._isDisposed) {
 			throw new Error('Model.findMatches: Model is disposed');
 		}
 
-		var regex = Strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
+		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return [];
 		}
 
-		var searchRange:EditorCommon.IEditorRange;
+		var searchRange:editorCommon.IEditorRange;
 		if (Range.isIRange(rawSearchScope)) {
 			searchRange = rawSearchScope;
 		} else {
@@ -857,12 +857,12 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return this._doFindMatches(searchRange, regex, limitResultCount);
 	}
 
-	public findNextMatch(searchString:string, rawSearchStart:EditorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): EditorCommon.IEditorRange {
+	public findNextMatch(searchString:string, rawSearchStart:editorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('Model.findNextMatch: Model is disposed');
 		}
 
-		var regex = Strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
+		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return null;
 		}
@@ -871,7 +871,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			lineCount = this.getLineCount(),
 			startLineNumber = searchStart.lineNumber,
 			text: string,
-			r: EditorCommon.IEditorRange;
+			r: editorCommon.IEditorRange;
 
 		// Look in first line
 		text = this._lines[startLineNumber - 1].text.substring(searchStart.column - 1);
@@ -880,7 +880,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			return r;
 		}
 
-		for (var i = 1; i < lineCount; i++) {
+		for (var i = 1; i <= lineCount; i++) {
 			var lineIndex = (startLineNumber + i - 1) % lineCount;
 			text = this._lines[lineIndex].text;
 			r = this._findMatchInLine(regex, text, lineIndex + 1, 0);
@@ -892,12 +892,12 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return null;
 	}
 
-	public findPreviousMatch(searchString:string, rawSearchStart:EditorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): EditorCommon.IEditorRange {
+	public findPreviousMatch(searchString:string, rawSearchStart:editorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('Model.findPreviousMatch: Model is disposed');
 		}
 
-		var regex = Strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
+		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return null;
 		}
@@ -906,7 +906,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			lineCount = this.getLineCount(),
 			startLineNumber = searchStart.lineNumber,
 			text: string,
-			r: EditorCommon.IEditorRange;
+			r: editorCommon.IEditorRange;
 
 		// Look in first line
 		text = this._lines[startLineNumber - 1].text.substring(0, searchStart.column - 1);
@@ -915,7 +915,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 			return r;
 		}
 
-		for (var i = 1; i < lineCount; i++) {
+		for (var i = 1; i <= lineCount; i++) {
 			var lineIndex = (lineCount + startLineNumber - i - 1) % lineCount;
 			text = this._lines[lineIndex].text;
 			r = this._findLastMatchInLine(regex, text, lineIndex + 1);
@@ -927,8 +927,8 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return null;
 	}
 
-	private _doFindMatches(searchRange:EditorCommon.IEditorRange, searchRegex:RegExp, limitResultCount:number): EditorCommon.IEditorRange[] {
-		var result:EditorCommon.IEditorRange[] = [],
+	private _doFindMatches(searchRange:editorCommon.IEditorRange, searchRegex:RegExp, limitResultCount:number): editorCommon.IEditorRange[] {
+		var result:editorCommon.IEditorRange[] = [],
 			text: string,
 			counter = 0;
 
@@ -957,16 +957,16 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return result;
 	}
 
-	private _findMatchInLine(searchRegex:RegExp, text:string, lineNumber:number, deltaOffset:number): EditorCommon.IEditorRange {
+	private _findMatchInLine(searchRegex:RegExp, text:string, lineNumber:number, deltaOffset:number): editorCommon.IEditorRange {
 		var m = searchRegex.exec(text);
 		if (!m) {
 			return null;
 		}
 		return new Range(lineNumber, m.index + 1 + deltaOffset, lineNumber, m.index + 1 + m[0].length + deltaOffset);
 	}
 
-	private _findLastMatchInLine(searchRegex:RegExp, text:string, lineNumber:number): EditorCommon.IEditorRange {
-		let bestResult: EditorCommon.IEditorRange = null;
+	private _findLastMatchInLine(searchRegex:RegExp, text:string, lineNumber:number): editorCommon.IEditorRange {
+		let bestResult: editorCommon.IEditorRange = null;
 		let m:RegExpExecArray;
 		while ((m = searchRegex.exec(text))) {
 			let result = new Range(lineNumber, m.index + 1, lineNumber, m.index + 1 + m[0].length);
@@ -978,7 +978,7 @@ export class TextModel extends OrderGuaranteeEventEmitter implements EditorCommo
 		return bestResult;
 	}
 
-	private _findMatchesInLine(searchRegex:RegExp, text:string, lineNumber:number, deltaOffset:number, counter:number, result:EditorCommon.IEditorRange[], limitResultCount:number): number {
+	private _findMatchesInLine(searchRegex:RegExp, text:string, lineNumber:number, deltaOffset:number, counter:number, result:editorCommon.IEditorRange[], limitResultCount:number): number {
 		var m:RegExpExecArray;
 		// Reset regex to search from the beginning
 		searchRegex.lastIndex = 0;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithDecorations.ts
code:
@@ -4,22 +4,22 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {TPromise} from 'vs/base/common/winjs.base';
-import Strings = require('vs/base/common/strings');
-import {IMode} from 'vs/editor/common/modes';
-import {TextModelWithTrackedRanges} from 'vs/editor/common/model/textModelWithTrackedRanges';
-import EditorCommon = require('vs/editor/common/editorCommon');
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {IHTMLContentElement} from 'vs/base/common/htmlContent';
-import Errors = require('vs/base/common/errors');
+import * as strings from 'vs/base/common/strings';
+import {TPromise} from 'vs/base/common/winjs.base';
 import {IdGenerator} from 'vs/editor/common/core/idGenerator';
 import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {TextModelWithTrackedRanges} from 'vs/editor/common/model/textModelWithTrackedRanges';
+import {IMode} from 'vs/editor/common/modes';
 
 export class DeferredEventsBuilder {
 
 	public changedMarkers:{[markerId:string]:boolean;};
 
-	public oldDecorationRange:{[decorationId:string]:EditorCommon.IRange;};
-	public oldDecorationOptions:{[decorationId:string]:EditorCommon.IModelDecorationOptions;};
+	public oldDecorationRange:{[decorationId:string]:editorCommon.IRange;};
+	public oldDecorationOptions:{[decorationId:string]:editorCommon.IModelDecorationOptions;};
 
 	public newOrChangedDecorations:{[decorationId:string]:boolean;};
 	public removedDecorations:{[decorationId:string]:boolean;};
@@ -38,7 +38,7 @@ export class DeferredEventsBuilder {
 		this.newOrChangedDecorations[id] = true;
 	}
 
-	public addRemovedDecoration(id:string, ownerId:number, range:EditorCommon.IRange, options:EditorCommon.IModelDecorationOptions): void {
+	public addRemovedDecoration(id:string, ownerId:number, range:editorCommon.IRange, options:editorCommon.IModelDecorationOptions): void {
 		if (this.newOrChangedDecorations.hasOwnProperty(id)) {
 			delete this.newOrChangedDecorations[id];
 		}
@@ -51,14 +51,14 @@ export class DeferredEventsBuilder {
 		this.removedDecorations[id] = true;
 	}
 
-	public addMovedDecoration(id:string, oldRange:EditorCommon.IRange): void {
+	public addMovedDecoration(id:string, oldRange:editorCommon.IRange): void {
 		if (!this.oldDecorationRange.hasOwnProperty(id)) {
 			this.oldDecorationRange[id] = oldRange;
 		}
 		this.newOrChangedDecorations[id] = true;
 	}
 
-	public addUpdatedDecoration(id:string, oldOptions:EditorCommon.IModelDecorationOptions): void {
+	public addUpdatedDecoration(id:string, oldOptions:editorCommon.IModelDecorationOptions): void {
 		if (!this.oldDecorationOptions.hasOwnProperty(id)) {
 			this.oldDecorationOptions[id] = oldOptions;
 		}
@@ -82,22 +82,22 @@ interface IRangeIdToDecorationIdMap {
 }
 
 interface IOldDecoration {
-	range: EditorCommon.IEditorRange;
+	range: editorCommon.IEditorRange;
 	options: ModelDecorationOptions;
 	id: string;
 }
 
 var _INSTANCE_COUNT = 0;
 
-export class TextModelWithDecorations extends TextModelWithTrackedRanges implements EditorCommon.ITextModelWithDecorations {
+export class TextModelWithDecorations extends TextModelWithTrackedRanges implements editorCommon.ITextModelWithDecorations {
 
 	private _currentDeferredEvents:DeferredEventsBuilder;
 	private _decorationIdGenerator: IdGenerator;
 	private decorations:IInternalDecorationsMap;
 	private rangeIdToDecorationId:IRangeIdToDecorationIdMap;
 
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
-		allowedEventTypes.push(EditorCommon.EventType.ModelDecorationsChanged);
+	constructor(allowedEventTypes:string[], rawText:editorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
+		allowedEventTypes.push(editorCommon.EventType.ModelDecorationsChanged);
 		super(allowedEventTypes, rawText, modeOrPromise);
 
 		// Initialize decorations
@@ -113,42 +113,42 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		super.dispose();
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:editorCommon.IModelContentChangedFlushEvent, newValue:string): void {
 		super._resetValue(e, newValue);
 
 		// Destroy all my decorations
 		this.decorations = {};
 		this.rangeIdToDecorationId = {};
 	}
 
-	public changeDecorations(callback: (changeAccessor:EditorCommon.IModelDecorationsChangeAccessor)=>any, ownerId:number=0): any {
+	public changeDecorations(callback: (changeAccessor:editorCommon.IModelDecorationsChangeAccessor)=>any, ownerId:number=0): any {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.changeDecorations: Model is disposed');
 		}
 
 		return this._withDeferredEvents((deferredEventsBuilder:DeferredEventsBuilder) => {
-			var changeAccessor:EditorCommon.IModelDecorationsChangeAccessor = {
-				addDecoration: (range:EditorCommon.IRange, options:EditorCommon.IModelDecorationOptions): string => {
+			var changeAccessor:editorCommon.IModelDecorationsChangeAccessor = {
+				addDecoration: (range:editorCommon.IRange, options:editorCommon.IModelDecorationOptions): string => {
 					return this._addDecorationImpl(deferredEventsBuilder, ownerId, this.validateRange(range), _normalizeOptions(options));
 				},
-				changeDecoration: (id:string, newRange:EditorCommon.IRange): void => {
+				changeDecoration: (id:string, newRange:editorCommon.IRange): void => {
 					this._changeDecorationImpl(deferredEventsBuilder, id, this.validateRange(newRange));
 				},
-				changeDecorationOptions: (id: string, options:EditorCommon.IModelDecorationOptions) => {
+				changeDecorationOptions: (id: string, options:editorCommon.IModelDecorationOptions) => {
 					this._changeDecorationOptionsImpl(deferredEventsBuilder, id, _normalizeOptions(options));
 				},
 				removeDecoration: (id:string): void => {
 					this._removeDecorationImpl(deferredEventsBuilder, id);
 				},
-				deltaDecorations: (oldDecorations:string[], newDecorations:EditorCommon.IModelDeltaDecoration[]): string[] => {
+				deltaDecorations: (oldDecorations:string[], newDecorations:editorCommon.IModelDeltaDecoration[]): string[] => {
 					return this._deltaDecorationsImpl(deferredEventsBuilder, ownerId, oldDecorations, this._normalizeDeltaDecorations(newDecorations));
 				}
 			};
 			var result: any = null;
 			try {
 				result = callback(changeAccessor);
 			} catch (e) {
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 			}
 			// Invalidate change accessor
 			changeAccessor.addDecoration = null;
@@ -159,7 +159,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		});
 	}
 
-	public deltaDecorations(oldDecorations:string[], newDecorations:EditorCommon.IModelDeltaDecoration[], ownerId:number=0): string[] {
+	public deltaDecorations(oldDecorations:string[], newDecorations:editorCommon.IModelDeltaDecoration[], ownerId:number=0): string[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.deltaDecorations: Model is disposed');
 		}
@@ -194,7 +194,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		this._removeDecorationsImpl(null, toRemove);
 	}
 
-	public getDecorationOptions(decorationId:string): EditorCommon.IModelDecorationOptions {
+	public getDecorationOptions(decorationId:string): editorCommon.IModelDecorationOptions {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getDecorationOptions: Model is disposed');
 		}
@@ -205,7 +205,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return null;
 	}
 
-	public getDecorationRange(decorationId:string): EditorCommon.IEditorRange {
+	public getDecorationRange(decorationId:string): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getDecorationRange: Model is disposed');
 		}
@@ -217,7 +217,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return null;
 	}
 
-	public getLineDecorations(lineNumber:number, ownerId:number=0, filterOutValidation:boolean=false): EditorCommon.IModelDecoration[] {
+	public getLineDecorations(lineNumber:number, ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getLineDecorations: Model is disposed');
 		}
@@ -228,12 +228,12 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return this.getLinesDecorations(lineNumber, lineNumber, ownerId, filterOutValidation);
 	}
 
-	private _getDecorationsInRange(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, ownerId:number, filterOutValidation:boolean): EditorCommon.IModelDecoration[] {
-		var result:EditorCommon.IModelDecoration[] = [],
+	private _getDecorationsInRange(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, ownerId:number, filterOutValidation:boolean): editorCommon.IModelDecoration[] {
+		var result:editorCommon.IModelDecoration[] = [],
 			decoration:IInternalDecoration,
 			lineRanges = this.getLinesTrackedRanges(startLineNumber, endLineNumber),
 			i:number,
-			lineRange: EditorCommon.IModelTrackedRange,
+			lineRange: editorCommon.IModelTrackedRange,
 			len:number;
 
 		for (i = 0, len = lineRanges.length; i < len; i++) {
@@ -248,7 +248,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 				}
 
 				if (filterOutValidation) {
-					if (decoration.options.className === EditorCommon.ClassName.EditorErrorDecoration || decoration.options.className === EditorCommon.ClassName.EditorWarningDecoration) {
+					if (decoration.options.className === editorCommon.ClassName.EditorErrorDecoration || decoration.options.className === editorCommon.ClassName.EditorWarningDecoration) {
 						continue;
 					}
 				}
@@ -273,7 +273,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return result;
 	}
 
-	public getLinesDecorations(startLineNumber: number, endLineNumber: number, ownerId:number=0, filterOutValidation:boolean=false): EditorCommon.IModelDecoration[] {
+	public getLinesDecorations(startLineNumber: number, endLineNumber: number, ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getLinesDecorations: Model is disposed');
 		}
@@ -284,7 +284,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return this._getDecorationsInRange(startLineNumber, 1, endLineNumber, Number.MAX_VALUE, ownerId, filterOutValidation);
 	}
 
-	public getDecorationsInRange(range: EditorCommon.IRange, ownerId?: number, filterOutValidation?: boolean): EditorCommon.IModelDecoration[] {
+	public getDecorationsInRange(range: editorCommon.IRange, ownerId?: number, filterOutValidation?: boolean): editorCommon.IModelDecoration[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getDecorationsInRange: Model is disposed');
 		}
@@ -293,12 +293,12 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return this._getDecorationsInRange(validatedRange.startLineNumber, validatedRange.startColumn, validatedRange.endLineNumber, validatedRange.endColumn, ownerId, filterOutValidation);
 	}
 
-	public getAllDecorations(ownerId:number=0, filterOutValidation:boolean=false): EditorCommon.IModelDecoration[] {
+	public getAllDecorations(ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithDecorations.getAllDecorations: Model is disposed');
 		}
 
-		var result:EditorCommon.IModelDecoration[] = [];
+		var result:editorCommon.IModelDecoration[] = [];
 		var decorationId:string;
 		var decoration:IInternalDecoration;
 
@@ -311,7 +311,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 				}
 
 				if (filterOutValidation) {
-					if (decoration.options.className === EditorCommon.ClassName.EditorErrorDecoration || decoration.options.className === EditorCommon.ClassName.EditorWarningDecoration) {
+					if (decoration.options.className === editorCommon.ClassName.EditorErrorDecoration || decoration.options.className === editorCommon.ClassName.EditorWarningDecoration) {
 						continue;
 					}
 				}
@@ -369,7 +369,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		}
 	}
 
-	private _onChangedRanges(eventBuilder:DeferredEventsBuilder, changedRanges:EditorCommon.IChangedTrackedRanges): void {
+	private _onChangedRanges(eventBuilder:DeferredEventsBuilder, changedRanges:editorCommon.IChangedTrackedRanges): void {
 		var rangeId:string;
 		var decorationId:string;
 
@@ -384,17 +384,17 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 
 	private _handleCollectedDecorationsEvents(b:DeferredEventsBuilder): void {
 		var decorationId:string,
-			addedOrChangedDecorations:EditorCommon.IModelDecorationsChangedEventDecorationData[] = [],
+			addedOrChangedDecorations:editorCommon.IModelDecorationsChangedEventDecorationData[] = [],
 			removedDecorations:string[] = [],
 			decorationIds:string[] = [],
-			decorationData:EditorCommon.IModelDecorationsChangedEventDecorationData,
-			oldRange:EditorCommon.IRange;
+			decorationData:editorCommon.IModelDecorationsChangedEventDecorationData,
+			oldRange:editorCommon.IRange;
 
 		for (decorationId in b.newOrChangedDecorations) {
 			if (b.newOrChangedDecorations.hasOwnProperty(decorationId)) {
 				decorationIds.push(decorationId);
 				decorationData = this._getDecorationData(decorationId);
-				decorationData.isForValidation = (decorationData.options.className === EditorCommon.ClassName.EditorErrorDecoration || decorationData.options.className === EditorCommon.ClassName.EditorWarningDecoration);
+				decorationData.isForValidation = (decorationData.options.className === editorCommon.ClassName.EditorErrorDecoration || decorationData.options.className === editorCommon.ClassName.EditorWarningDecoration);
 				addedOrChangedDecorations.push(decorationData);
 				if (b.oldDecorationRange.hasOwnProperty(decorationId)) {
 					oldRange = b.oldDecorationRange[decorationId];
@@ -414,7 +414,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		}
 
 		if (decorationIds.length > 0) {
-			var e:EditorCommon.IModelDecorationsChangedEvent = {
+			var e:editorCommon.IModelDecorationsChangedEvent = {
 				ids: decorationIds,
 				addedOrChangedDecorations: addedOrChangedDecorations,
 				removedDecorations: removedDecorations,
@@ -425,7 +425,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		}
 	}
 
-	private _getDecorationData(decorationId:string): EditorCommon.IModelDecorationsChangedEventDecorationData {
+	private _getDecorationData(decorationId:string): editorCommon.IModelDecorationsChangedEventDecorationData {
 		var decoration = this.decorations[decorationId];
 		return {
 			id: decoration.id,
@@ -436,13 +436,13 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		};
 	}
 
-	private emitModelDecorationsChangedEvent(e:EditorCommon.IModelDecorationsChangedEvent): void {
+	private emitModelDecorationsChangedEvent(e:editorCommon.IModelDecorationsChangedEvent): void {
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelDecorationsChanged, e);
+			this.emit(editorCommon.EventType.ModelDecorationsChanged, e);
 		}
 	}
 
-	private _normalizeDeltaDecorations(deltaDecorations:EditorCommon.IModelDeltaDecoration[]): ModelDeltaDecoration[] {
+	private _normalizeDeltaDecorations(deltaDecorations:editorCommon.IModelDeltaDecoration[]): ModelDeltaDecoration[] {
 		let result:ModelDeltaDecoration[] = [];
 		for (let i = 0, len = deltaDecorations.length; i < len; i++) {
 			let deltaDecoration = deltaDecorations[i];
@@ -451,7 +451,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return result;
 	}
 
-	private _addDecorationImpl(eventBuilder:DeferredEventsBuilder, ownerId:number, range:EditorCommon.IEditorRange, options:ModelDecorationOptions): string {
+	private _addDecorationImpl(eventBuilder:DeferredEventsBuilder, ownerId:number, range:editorCommon.IEditorRange, options:ModelDecorationOptions): string {
 		var rangeId = this.addTrackedRange(range, options.stickiness);
 
 		var decoration = new ModelInternalDecoration(this._decorationIdGenerator.generate(), ownerId, rangeId, options);
@@ -484,7 +484,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 		return result;
 	}
 
-	private _changeDecorationImpl(eventBuilder:DeferredEventsBuilder, id:string, newRange:EditorCommon.IEditorRange): void {
+	private _changeDecorationImpl(eventBuilder:DeferredEventsBuilder, id:string, newRange:editorCommon.IEditorRange): void {
 		if (this.decorations.hasOwnProperty(id)) {
 			var decoration = this.decorations[id];
 			var oldRange = this.getTrackedRange(decoration.rangeId);
@@ -513,7 +513,7 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	private _removeDecorationImpl(eventBuilder:DeferredEventsBuilder, id:string): void {
 		if (this.decorations.hasOwnProperty(id)) {
 			var decoration = this.decorations[id];
-			var oldRange:EditorCommon.IEditorRange = null;
+			var oldRange:editorCommon.IEditorRange = null;
 			if (eventBuilder) {
 				oldRange = this.getTrackedRange(decoration.rangeId);
 			}
@@ -681,29 +681,29 @@ class ModelInternalDecoration implements IInternalDecoration {
 	}
 }
 
-class ModelDecorationOptions implements EditorCommon.IModelDecorationOptions {
+class ModelDecorationOptions implements editorCommon.IModelDecorationOptions {
 
-	stickiness:EditorCommon.TrackedRangeStickiness;
+	stickiness:editorCommon.TrackedRangeStickiness;
 	className:string;
 	hoverMessage:string;
 	htmlMessage:IHTMLContentElement[];
 	isWholeLine:boolean;
 	showInOverviewRuler:string;
-	overviewRuler:EditorCommon.IModelDecorationOverviewRulerOptions;
+	overviewRuler:editorCommon.IModelDecorationOverviewRulerOptions;
 	glyphMarginClassName:string;
 	linesDecorationsClassName:string;
 	inlineClassName:string;
 
-	constructor(options:EditorCommon.IModelDecorationOptions) {
-		this.stickiness = options.stickiness||EditorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges;
-		this.className = cleanClassName(options.className||Strings.empty);
-		this.hoverMessage = options.hoverMessage||Strings.empty;
+	constructor(options:editorCommon.IModelDecorationOptions) {
+		this.stickiness = options.stickiness||editorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges;
+		this.className = cleanClassName(options.className||strings.empty);
+		this.hoverMessage = options.hoverMessage||strings.empty;
 		this.htmlMessage = options.htmlMessage||[];
 		this.isWholeLine = options.isWholeLine||false;
 		this.overviewRuler = _normalizeOverviewRulerOptions(options.overviewRuler, options.showInOverviewRuler);
-		this.glyphMarginClassName = cleanClassName(options.glyphMarginClassName||Strings.empty);
-		this.linesDecorationsClassName = cleanClassName(options.linesDecorationsClassName||Strings.empty);
-		this.inlineClassName = cleanClassName(options.inlineClassName||Strings.empty);
+		this.glyphMarginClassName = cleanClassName(options.glyphMarginClassName||strings.empty);
+		this.linesDecorationsClassName = cleanClassName(options.linesDecorationsClassName||strings.empty);
+		this.inlineClassName = cleanClassName(options.inlineClassName||strings.empty);
 	}
 
 	private static _htmlContentEquals(a:IHTMLContentElement, b:IHTMLContentElement): boolean {
@@ -743,7 +743,7 @@ class ModelDecorationOptions implements EditorCommon.IModelDecorationOptions {
 		return true;
 	}
 
-	private static _overviewRulerEquals(a:EditorCommon.IModelDecorationOverviewRulerOptions, b:EditorCommon.IModelDecorationOverviewRulerOptions): boolean {
+	private static _overviewRulerEquals(a:editorCommon.IModelDecorationOverviewRulerOptions, b:editorCommon.IModelDecorationOverviewRulerOptions): boolean {
 		return (
 			a.color === b.color
 			&& a.position === b.position
@@ -767,32 +767,32 @@ class ModelDecorationOptions implements EditorCommon.IModelDecorationOptions {
 	}
 }
 
-class ModelDeltaDecoration implements EditorCommon.IModelDeltaDecoration {
+class ModelDeltaDecoration implements editorCommon.IModelDeltaDecoration {
 
 	index: number;
-	range: EditorCommon.IEditorRange;
+	range: editorCommon.IEditorRange;
 	options: ModelDecorationOptions;
 
-	constructor(index: number, range: EditorCommon.IEditorRange, options: ModelDecorationOptions) {
+	constructor(index: number, range: editorCommon.IEditorRange, options: ModelDecorationOptions) {
 		this.index = index;
 		this.range = range;
 		this.options = options;
 	}
 }
 
-function _normalizeOptions(options:EditorCommon.IModelDecorationOptions): ModelDecorationOptions {
+function _normalizeOptions(options:editorCommon.IModelDecorationOptions): ModelDecorationOptions {
 	return new ModelDecorationOptions(options);
 }
 
-class ModelDecorationOverviewRulerOptions implements EditorCommon.IModelDecorationOverviewRulerOptions {
+class ModelDecorationOverviewRulerOptions implements editorCommon.IModelDecorationOverviewRulerOptions {
 	color: string;
 	darkColor: string;
-	position: EditorCommon.OverviewRulerLane;
+	position: editorCommon.OverviewRulerLane;
 
-	constructor(options:EditorCommon.IModelDecorationOverviewRulerOptions, legacyShowInOverviewRuler:string) {
-		this.color = Strings.empty;
-		this.darkColor = Strings.empty;
-		this.position = EditorCommon.OverviewRulerLane.Center;
+	constructor(options:editorCommon.IModelDecorationOverviewRulerOptions, legacyShowInOverviewRuler:string) {
+		this.color = strings.empty;
+		this.darkColor = strings.empty;
+		this.position = editorCommon.OverviewRulerLane.Center;
 
 		if (legacyShowInOverviewRuler) {
 			this.color = legacyShowInOverviewRuler;
@@ -809,6 +809,6 @@ class ModelDecorationOverviewRulerOptions implements EditorCommon.IModelDecorati
 	}
 }
 
-function _normalizeOverviewRulerOptions(options:EditorCommon.IModelDecorationOverviewRulerOptions, legacyShowInOverviewRuler: string = null): EditorCommon.IModelDecorationOverviewRulerOptions {
+function _normalizeOverviewRulerOptions(options:editorCommon.IModelDecorationOverviewRulerOptions, legacyShowInOverviewRuler: string = null): editorCommon.IModelDecorationOverviewRulerOptions {
 	return new ModelDecorationOverviewRulerOptions(options, legacyShowInOverviewRuler);
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithMarkers.ts
code:
@@ -5,12 +5,12 @@
 'use strict';
 
 import {TPromise} from 'vs/base/common/winjs.base';
-import {IMode} from 'vs/editor/common/modes';
+import {IdGenerator} from 'vs/editor/common/core/idGenerator';
 import {Position} from 'vs/editor/common/core/position';
+import {IEditorPosition, IModelContentChangedFlushEvent, IRawText, IReadOnlyLineMarker, ITextModelWithMarkers} from 'vs/editor/common/editorCommon';
+import {ILineMarker, ModelLine} from 'vs/editor/common/model/modelLine';
 import {TextModelWithTokens} from 'vs/editor/common/model/textModelWithTokens';
-import {ModelLine, ILineMarker} from 'vs/editor/common/model/modelLine';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {IdGenerator} from 'vs/editor/common/core/idGenerator';
+import {IMode} from 'vs/editor/common/modes';
 
 export interface IMarkerIdToMarkerMap {
 	[key:string]:ILineMarker;
@@ -47,11 +47,11 @@ export class LineMarker implements ILineMarker {
 
 var _INSTANCE_COUNT = 0;
 
-export class TextModelWithMarkers extends TextModelWithTokens implements EditorCommon.ITextModelWithMarkers {
+export class TextModelWithMarkers extends TextModelWithTokens implements ITextModelWithMarkers {
 
 	private _markerIdGenerator: IdGenerator;
 	protected _markerIdToMarker: IMarkerIdToMarkerMap;
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
+	constructor(allowedEventTypes:string[], rawText:IRawText, modeOrPromise:IMode|TPromise<IMode>) {
 		super(allowedEventTypes, rawText, true, modeOrPromise);
 		this._markerIdGenerator = new IdGenerator((++_INSTANCE_COUNT) + ';');
 		this._markerIdToMarker = {};
@@ -62,7 +62,7 @@ export class TextModelWithMarkers extends TextModelWithTokens implements EditorC
 		super.dispose();
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:IModelContentChangedFlushEvent, newValue:string): void {
 		super._resetValue(e, newValue);
 
 		// Destroy all my markers
@@ -147,7 +147,7 @@ export class TextModelWithMarkers extends TextModelWithTokens implements EditorC
 		}
 	}
 
-	_getMarker(id:string): EditorCommon.IEditorPosition {
+	_getMarker(id:string): IEditorPosition {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithMarkers._getMarker: Model is disposed');
 		}
@@ -163,7 +163,7 @@ export class TextModelWithMarkers extends TextModelWithTokens implements EditorC
 		return Object.keys(this._markerIdToMarker).length;
 	}
 
-	_getLineMarkers(lineNumber: number): EditorCommon.IReadOnlyLineMarker[] {
+	_getLineMarkers(lineNumber: number): IReadOnlyLineMarker[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithMarkers._getLineMarkers: Model is disposed');
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithTokens.ts
code:
@@ -4,28 +4,27 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import nls = require('vs/nls');
-
-import Timer = require('vs/base/common/timer');
-import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
-import {WordHelper} from 'vs/editor/common/model/textModelWithTokensHelpers';
-import {TokenIterator} from 'vs/editor/common/model/tokenIterator';
-import {ModelLine} from 'vs/editor/common/model/modelLine';
-import {TextModel} from 'vs/editor/common/model/textModel';
-import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
-import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as nls from 'vs/nls';
 import {RunOnceScheduler} from 'vs/base/common/async';
-import {Arrays} from 'vs/editor/common/core/arrays';
-import Errors = require('vs/base/common/errors');
+import {onUnexpectedError} from 'vs/base/common/errors';
 import {IDisposable, disposeAll} from 'vs/base/common/lifecycle';
 import {StopWatch} from 'vs/base/common/stopwatch';
+import * as timer from 'vs/base/common/timer';
 import {TPromise} from 'vs/base/common/winjs.base';
+import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
+import {Arrays} from 'vs/editor/common/core/arrays';
 import {Range} from 'vs/editor/common/core/range';
+import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ModelLine} from 'vs/editor/common/model/modelLine';
+import {TextModel} from 'vs/editor/common/model/textModel';
+import {WordHelper} from 'vs/editor/common/model/textModelWithTokensHelpers';
+import {TokenIterator} from 'vs/editor/common/model/tokenIterator';
+import {ILineContext, ILineTokens, IMode, IModeTransition, IState} from 'vs/editor/common/modes';
+import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
 import {ignoreBracketsInToken} from 'vs/editor/common/modes/supports';
-import {BracketsUtils} from 'vs/editor/common/modes/supports/electricCharacter';
+import {BracketsUtils} from 'vs/editor/common/modes/supports/richEditBrackets';
 
-export class TokensInflatorMap implements EditorCommon.ITokensInflatorMap {
+export class TokensInflatorMap implements editorCommon.ITokensInflatorMap {
 
 	public _inflate:string[];
 
@@ -41,14 +40,14 @@ export class TokensInflatorMap implements EditorCommon.ITokensInflatorMap {
 
 class ModeToModelBinder implements IDisposable {
 
-	private _modePromise:TPromise<Modes.IMode>;
+	private _modePromise:TPromise<IMode>;
 	private _externalModePromise:TPromise<boolean>;
 	private _externalModePromise_c:(value:boolean)=>void;
 	private _externalModePromise_e:(err:any)=>void;
 	private _model:TextModelWithTokens;
 	private _isDisposed:boolean;
 
-	constructor(modePromise:TPromise<Modes.IMode>, model:TextModelWithTokens) {
+	constructor(modePromise:TPromise<IMode>, model:TextModelWithTokens) {
 		this._modePromise = modePromise;
 		// Create an external mode promise that fires after the mode is set to the model
 		this._externalModePromise = new TPromise<boolean>((c, e, p) => {
@@ -63,7 +62,7 @@ class ModeToModelBinder implements IDisposable {
 		// Ensure asynchronicity
 		TPromise.timeout(0).then(() => {
 			return this._modePromise;
-		}).then((mode:Modes.IMode) => {
+		}).then((mode:IMode) => {
 			if (this._isDisposed) {
 				this._externalModePromise_c(false);
 				return;
@@ -75,7 +74,7 @@ class ModeToModelBinder implements IDisposable {
 			this._externalModePromise_c(true);
 		}).done(null, (err) => {
 			this._externalModePromise_e(err);
-			Errors.onUnexpectedError(err);
+			onUnexpectedError(err);
 		});
 	}
 
@@ -97,7 +96,7 @@ export interface IRetokenizeRequest extends IDisposable {
 	/**
 	 * If null, the entire model will be retokenzied, use null with caution
 	 */
-	getRange(): EditorCommon.IRange;
+	getRange(): editorCommon.IRange;
 }
 
 export class FullModelRetokenizer implements IRetokenizeRequest {
@@ -123,10 +122,10 @@ export class FullModelRetokenizer implements IRetokenizeRequest {
 			}
 			this.isFulfilled = true;
 			this._model.onRetokenizerFulfilled();
-		}).done(null, Errors.onUnexpectedError);
+		}).done(null, onUnexpectedError);
 	}
 
-	public getRange(): EditorCommon.IRange {
+	public getRange(): editorCommon.IRange {
 		return null;
 	}
 
@@ -137,13 +136,13 @@ export class FullModelRetokenizer implements IRetokenizeRequest {
 	}
 }
 
-class LineContext implements Modes.ILineContext {
+class LineContext implements ILineContext {
 
-	public modeTransitions:Modes.IModeTransition[];
+	public modeTransitions:IModeTransition[];
 	private _text:string;
-	private _lineTokens:EditorCommon.ILineTokens;
+	private _lineTokens:editorCommon.ILineTokens;
 
-	constructor (topLevelMode:Modes.IMode, line:ModelLine) {
+	constructor (topLevelMode:IMode, line:ModelLine) {
 		this.modeTransitions = line.getModeTransitions().toArray(topLevelMode);
 		this._text = line.text;
 		this._lineTokens = line.getTokens();
@@ -180,21 +179,21 @@ class LineContext implements Modes.ILineContext {
 	}
 }
 
-export class TextModelWithTokens extends TextModel implements EditorCommon.ITokenizedModel {
+export class TextModelWithTokens extends TextModel implements editorCommon.ITokenizedModel {
 
 	private static MODE_TOKENIZATION_FAILED_MSG = nls.localize('mode.tokenizationSupportFailed', "The mode has failed while tokenizing the input.");
 	private static MODEL_SYNC_LIMIT = 5 * 1024 * 1024; // 5 MB
 	private static MODEL_TOKENIZATION_LIMIT = 20 * 1024 * 1024; // 20 MB
 
 	private _shouldAutoTokenize:boolean;
-	private _mode: Modes.IMode;
+	private _mode: IMode;
 	private _modeListener: IDisposable;
 	private _modeToModelBinder:ModeToModelBinder;
-	private _tokensInflatorMap:EditorCommon.ITokensInflatorMap;
+	private _tokensInflatorMap:editorCommon.ITokensInflatorMap;
 	private _stopLineTokenizationAfter:number;
 
 	private _invalidLineStartIndex:number;
-	private _lastState:Modes.IState;
+	private _lastState:IState;
 
 	private _revalidateTokensTimeout:number;
 	private _scheduleRetokenizeNow: RunOnceScheduler;
@@ -206,10 +205,10 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 	private _shouldSimplifyMode: boolean;
 	private _shouldDenyMode: boolean;
 
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText, shouldAutoTokenize:boolean, modeOrPromise:Modes.IMode|TPromise<Modes.IMode>) {
-		allowedEventTypes.push(EditorCommon.EventType.ModelTokensChanged);
-		allowedEventTypes.push(EditorCommon.EventType.ModelModeChanged);
-		allowedEventTypes.push(EditorCommon.EventType.ModelModeSupportChanged);
+	constructor(allowedEventTypes:string[], rawText:editorCommon.IRawText, shouldAutoTokenize:boolean, modeOrPromise:IMode|TPromise<IMode>) {
+		allowedEventTypes.push(editorCommon.EventType.ModelTokensChanged);
+		allowedEventTypes.push(editorCommon.EventType.ModelModeChanged);
+		allowedEventTypes.push(editorCommon.EventType.ModelModeSupportChanged);
 		super(allowedEventTypes, rawText);
 
 		this._shouldAutoTokenize = shouldAutoTokenize;
@@ -222,19 +221,19 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 			this._mode = new NullMode();
 		} else if (TPromise.is(modeOrPromise)) {
 			// TODO@Alex: To avoid mode id changes, we check if this promise is resolved
-			let promiseValue = <Modes.IMode>(<any>modeOrPromise)._value;
+			let promiseValue = <IMode>(<any>modeOrPromise)._value;
 
 			if (promiseValue && typeof promiseValue.getId === 'function') {
 				// The promise is already resolved
 				this._mode = this._massageMode(promiseValue);
 				this._resetModeListener(this._mode);
 			} else {
-				var modePromise = <TPromise<Modes.IMode>>modeOrPromise;
+				var modePromise = <TPromise<IMode>>modeOrPromise;
 				this._modeToModelBinder = new ModeToModelBinder(modePromise, this);
 				this._mode = new NullMode();
 			}
 		} else {
-			this._mode = this._massageMode(<Modes.IMode>modeOrPromise);
+			this._mode = this._massageMode(<IMode>modeOrPromise);
 			this._resetModeListener(this._mode);
 		}
 
@@ -269,7 +268,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return this._shouldSimplifyMode;
 	}
 
-	private _massageMode(mode: Modes.IMode): Modes.IMode {
+	private _massageMode(mode: IMode): IMode {
 		if (this.isTooLargeForHavingAMode()) {
 			return new NullMode();
 		}
@@ -279,7 +278,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return mode;
 	}
 
-	public whenModeIsReady(): TPromise<Modes.IMode> {
+	public whenModeIsReady(): TPromise<IMode> {
 		if (this._modeToModelBinder) {
 			// Still waiting for some mode to load
 			return this._modeToModelBinder.getModePromise().then(() => this._mode);
@@ -336,13 +335,13 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return new FullModelRetokenizer(retokenizePromise, this);
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:editorCommon.IModelContentChangedFlushEvent, newValue:string): void {
 		super._resetValue(e, newValue);
 		// Cancel tokenization, clear all tokens and begin tokenizing
 		this._resetTokenizationState();
 	}
 
-	_resetMode(e:EditorCommon.IModelModeChangedEvent, newMode:Modes.IMode): void {
+	_resetMode(e:editorCommon.IModelModeChangedEvent, newMode:IMode): void {
 		// Cancel tokenization, clear all tokens and begin tokenizing
 		this._mode = newMode;
 		this._resetModeListener(newMode);
@@ -351,7 +350,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		this.emitModelTokensChangedEvent(1, this.getLineCount());
 	}
 
-	private _resetModeListener(newMode: Modes.IMode): void {
+	private _resetModeListener(newMode: IMode): void {
 		if (this._modeListener) {
 			this._modeListener.dispose();
 			this._modeListener = null;
@@ -361,7 +360,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		}
 	}
 
-	private _onModeSupportChanged(e: EditorCommon.IModeSupportChangedEvent): void {
+	private _onModeSupportChanged(e: editorCommon.IModeSupportChangedEvent): void {
 		this._emitModelModeSupportChangedEvent(e);
 		if (e.tokenizationSupport) {
 			this._resetTokenizationState();
@@ -390,13 +389,13 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 
 	private _initializeTokenizationState(): void {
 		// Initialize tokenization states
-		var initialState:Modes.IState = null;
+		var initialState:IState = null;
 		if (this._mode.tokenizationSupport) {
 			try {
 				initialState = this._mode.tokenizationSupport.getInitialState();
 			} catch (e) {
 				e.friendlyMessage = TextModelWithTokens.MODE_TOKENIZATION_FAILED_MSG;
-				Errors.onUnexpectedError(e);
+				onUnexpectedError(e);
 				this._mode = new NullMode();
 			}
 		}
@@ -419,7 +418,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		this._stopLineTokenizationAfter = stopLineTokenizationAfter;
 	}
 
-	public getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean = false): EditorCommon.ILineTokens {
+	public getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean = false): editorCommon.ILineTokens {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getLineTokens: Model is disposed');
 		}
@@ -433,7 +432,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return this._lines[lineNumber - 1].getTokens();
 	}
 
-	public getLineContext(lineNumber:number): Modes.ILineContext {
+	public getLineContext(lineNumber:number): ILineContext {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getLineContext: Model is disposed');
 		}
@@ -446,13 +445,13 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return new LineContext(this._mode, this._lines[lineNumber - 1]);
 	}
 
-	_getInternalTokens(lineNumber:number): EditorCommon.ILineTokens {
+	_getInternalTokens(lineNumber:number): editorCommon.ILineTokens {
 		this._updateTokensUntilLine(lineNumber, true);
 		return this._lines[lineNumber - 1].getTokens();
 	}
 
-	public setValue(value:string, newMode?:Modes.IMode): void;
-	public setValue(value:string, newModePromise?:TPromise<Modes.IMode>): void;
+	public setValue(value:string, newMode?:IMode): void;
+	public setValue(value:string, newModePromise?:TPromise<IMode>): void;
 	public setValue(value:string, newModeOrPromise:any=null): void {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.setValue: Model is disposed');
@@ -468,11 +467,11 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 				this._modeToModelBinder = null;
 			}
 			if (TPromise.is(newModeOrPromise)) {
-				this._modeToModelBinder = new ModeToModelBinder(<TPromise<Modes.IMode>>newModeOrPromise, this);
+				this._modeToModelBinder = new ModeToModelBinder(<TPromise<IMode>>newModeOrPromise, this);
 			} else {
-				var actualNewMode = this._massageMode(<Modes.IMode>newModeOrPromise);
+				var actualNewMode = this._massageMode(<IMode>newModeOrPromise);
 				if (this._mode !== actualNewMode) {
-					var e2:EditorCommon.IModelModeChangedEvent = {
+					var e2:editorCommon.IModelModeChangedEvent = {
 						oldMode: this._mode,
 						newMode: actualNewMode
 					};
@@ -483,16 +482,16 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		}
 	}
 
-	public getMode(): Modes.IMode {
+	public getMode(): IMode {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getMode: Model is disposed');
 		}
 
 		return this._mode;
 	}
 
-	public setMode(newMode:Modes.IMode): void;
-	public setMode(newModePromise:TPromise<Modes.IMode>): void;
+	public setMode(newMode:IMode): void;
+	public setMode(newModePromise:TPromise<IMode>): void;
 	public setMode(newModeOrPromise:any): void {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.setMode: Model is disposed');
@@ -505,7 +504,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		this.setValue(null, newModeOrPromise);
 	}
 
-	public getModeAtPosition(_lineNumber:number, _column:number): Modes.IMode {
+	public getModeAtPosition(_lineNumber:number, _column:number): IMode {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getModeAtPosition: Model is disposed');
 		}
@@ -540,7 +539,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		}
 	}
 
-	_updateLineTokens(lineIndex:number, map:EditorCommon.ITokensInflatorMap, topLevelMode:Modes.IMode, r:Modes.ILineTokens): void {
+	_updateLineTokens(lineIndex:number, map:editorCommon.ITokensInflatorMap, topLevelMode:IMode, r:ILineTokens): void {
 		this._lines[lineIndex].setTokens(map, r.tokens, topLevelMode, r.modeTransitions);
 	}
 
@@ -574,7 +573,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 
 	private _revalidateTokensNow(toLineNumber:number = this._invalidLineStartIndex + 1000000): void {
 
-		var timer = Timer.start(Timer.Topic.EDITOR, 'backgroundTokenization');
+		var t1 = timer.start(timer.Topic.EDITOR, 'backgroundTokenization');
 		toLineNumber = Math.min(this._lines.length, toLineNumber);
 
 		var MAX_ALLOWED_TIME = 20,
@@ -622,7 +621,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 //		console.log('TOKENIZED LOCAL (' + this._mode.getId() + ') ' + tokenizedChars + '\t in \t' + elapsedTime + '\t speed \t' + tokenizedChars/elapsedTime);
 //		console.log('TOKENIZED GLOBAL(' + this._mode.getId() + ') ' + this._tokenizationTotalCharacters + '\t in*\t' + this._tokenizationElapsedTime + '\t speed*\t' + this._tokenizationTotalCharacters/this._tokenizationElapsedTime);
 
-		var t2 = Timer.start(Timer.Topic.EDITOR, '**speed: ' + this._tokenizationTotalCharacters / this._tokenizationElapsedTime);
+		var t2 = timer.start(timer.Topic.EDITOR, '**speed: ' + this._tokenizationTotalCharacters / this._tokenizationElapsedTime);
 		t2.stop();
 
 		if (fromLineNumber <= toLineNumber) {
@@ -633,20 +632,20 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 			this._beginBackgroundTokenization();
 		}
 
-		timer.stop();
+		t1.stop();
 	}
 
-	private getStateBeforeLine(lineNumber:number): Modes.IState {
+	private getStateBeforeLine(lineNumber:number): IState {
 		this._updateTokensUntilLine(lineNumber - 1, true);
 		return this._lines[lineNumber - 1].getState();
 	}
 
-	private getStateAfterLine(lineNumber:number): Modes.IState {
+	private getStateAfterLine(lineNumber:number): IState {
 		this._updateTokensUntilLine(lineNumber, true);
 		return lineNumber < this._lines.length ? this._lines[lineNumber].getState() : this._lastState;
 	}
 
-	_getLineModeTransitions(lineNumber:number): Modes.IModeTransition[] {
+	_getLineModeTransitions(lineNumber:number): IModeTransition[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens._getLineModeTransitions: Model is disposed');
 		}
@@ -673,7 +672,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		// Validate all states up to and including endLineIndex
 		for (var lineIndex = this._invalidLineStartIndex; lineIndex <= endLineIndex; lineIndex++) {
 			var endStateIndex = lineIndex + 1;
-			var r:Modes.ILineTokens = null;
+			var r:ILineTokens = null;
 			var text = this._lines[lineIndex].text;
 			if (this._mode.tokenizationSupport) {
 
@@ -683,7 +682,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 					tokenizedCharacters = r ? r.actualStopOffset : this._lines[lineIndex].text.length;
 				} catch (e) {
 					e.friendlyMessage = TextModelWithTokens.MODE_TOKENIZATION_FAILED_MSG;
-					Errors.onUnexpectedError(e);
+					onUnexpectedError(e);
 				}
 
 				if (r && r.retokenize) {
@@ -766,24 +765,24 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 	}
 
 	private emitModelTokensChangedEvent(fromLineNumber:number, toLineNumber:number): void {
-		var e:EditorCommon.IModelTokensChangedEvent = {
+		var e:editorCommon.IModelTokensChangedEvent = {
 			fromLineNumber: fromLineNumber,
 			toLineNumber: toLineNumber
 		};
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelTokensChanged, e);
+			this.emit(editorCommon.EventType.ModelTokensChanged, e);
 		}
 	}
 
-	private _emitModelModeChangedEvent(e:EditorCommon.IModelModeChangedEvent): void {
+	private _emitModelModeChangedEvent(e:editorCommon.IModelModeChangedEvent): void {
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelModeChanged, e);
+			this.emit(editorCommon.EventType.ModelModeChanged, e);
 		}
 	}
 
-	private _emitModelModeSupportChangedEvent(e:EditorCommon.IModeSupportChangedEvent): void {
+	private _emitModelModeSupportChangedEvent(e:editorCommon.IModeSupportChangedEvent): void {
 		if (!this._isDisposing) {
-			this.emit(EditorCommon.EventType.ModelModeSupportChanged, e);
+			this.emit(editorCommon.EventType.ModelModeSupportChanged, e);
 		}
 	}
 
@@ -797,15 +796,15 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return WordHelper.massageWordDefinitionOf(this._mode);
 	}
 
-	public getWordAtPosition(position:EditorCommon.IPosition): EditorCommon.IWordAtPosition {
+	public getWordAtPosition(position:editorCommon.IPosition): editorCommon.IWordAtPosition {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getWordAtPosition: Model is disposed');
 		}
 
 		return WordHelper.getWordAtPosition(this, this.validatePosition(position));
 	}
 
-	public getWordUntilPosition(position: EditorCommon.IPosition): EditorCommon.IWordAtPosition {
+	public getWordUntilPosition(position: editorCommon.IPosition): editorCommon.IWordAtPosition {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getWordUntilPosition: Model is disposed');
 		}
@@ -825,7 +824,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		};
 	}
 
-	public getWords(lineNumber:number): EditorCommon.IWordRange[] {
+	public getWords(lineNumber:number): editorCommon.IWordRange[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.getWords: Model is disposed');
 		}
@@ -836,7 +835,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return WordHelper.getWords(this, this.validateLineNumber(lineNumber));
 	}
 
-	public tokenIterator(position:EditorCommon.IPosition, callback:(it:TokenIterator)=>any): any {
+	public tokenIterator(position:editorCommon.IPosition, callback:(it:TokenIterator)=>any): any {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.tokenIterator: Model is disposed');
 		}
@@ -847,7 +846,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return result;
 	}
 
-	public findMatchingBracketUp(bracket:string, _position:EditorCommon.IPosition): EditorCommon.IEditorRange {
+	public findMatchingBracketUp(bracket:string, _position:editorCommon.IPosition): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.findMatchingBracketUp: Model is disposed');
 		}
@@ -871,15 +870,15 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return this._findMatchingBracketUp(data, position);
 	}
 
-	public matchBracket(position:EditorCommon.IPosition, inaccurateResultAcceptable:boolean = false): EditorCommon.IMatchBracketResult {
+	public matchBracket(position:editorCommon.IPosition, inaccurateResultAcceptable:boolean = false): editorCommon.IMatchBracketResult {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.matchBracket: Model is disposed');
 		}
 
 		return this._matchBracket(this.validatePosition(position));
 	}
 
-	private _matchBracket(position:EditorCommon.IEditorPosition): EditorCommon.IMatchBracketResult {
+	private _matchBracket(position:editorCommon.IEditorPosition): editorCommon.IMatchBracketResult {
 		let tokensMap = this._tokensInflatorMap;
 		let lineNumber = position.lineNumber;
 		let lineText = this._lines[lineNumber - 1].text;
@@ -972,7 +971,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		};
 	}
 
-	private _matchFoundBracket(foundBracket:Range, data:EditorCommon.IRichEditBracket, isOpen:boolean): EditorCommon.IMatchBracketResult {
+	private _matchFoundBracket(foundBracket:Range, data:editorCommon.IRichEditBracket, isOpen:boolean): editorCommon.IMatchBracketResult {
 		if (isOpen) {
 			let matched = this._findMatchingBracketDown(data, foundBracket.getEndPosition());
 			if (matched) {
@@ -994,7 +993,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return null;
 	}
 
-	private _findMatchingBracketUp(bracket:EditorCommon.IRichEditBracket, position:EditorCommon.IEditorPosition): Range {
+	private _findMatchingBracketUp(bracket:editorCommon.IRichEditBracket, position:editorCommon.IEditorPosition): Range {
 		// console.log('_findMatchingBracketUp: ', 'bracket: ', JSON.stringify(bracket), 'startPosition: ', String(position));
 
 		let modeId = bracket.modeId;
@@ -1064,7 +1063,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return null;
 	}
 
-	private _findMatchingBracketDown(bracket:EditorCommon.IRichEditBracket, position:EditorCommon.IEditorPosition): Range {
+	private _findMatchingBracketDown(bracket:editorCommon.IRichEditBracket, position:editorCommon.IEditorPosition): Range {
 		// console.log('_findMatchingBracketDown: ', 'bracket: ', JSON.stringify(bracket), 'startPosition: ', String(position));
 
 		let modeId = bracket.modeId;
@@ -1133,7 +1132,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return null;
 	}
 
-	public findPrevBracket(_position:EditorCommon.IPosition): EditorCommon.IFoundBracket {
+	public findPrevBracket(_position:editorCommon.IPosition): editorCommon.IFoundBracket {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.findPrevBracket: Model is disposed');
 		}
@@ -1173,7 +1172,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return null;
 	}
 
-	public findNextBracket(_position:EditorCommon.IPosition): EditorCommon.IFoundBracket {
+	public findNextBracket(_position:editorCommon.IPosition): editorCommon.IFoundBracket {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTokens.findNextBracket: Model is disposed');
 		}
@@ -1213,7 +1212,7 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 		return null;
 	}
 
-	private _toFoundBracket(r:Range): EditorCommon.IFoundBracket {
+	private _toFoundBracket(r:Range): editorCommon.IFoundBracket {
 		if (!r) {
 			return null;
 		}
@@ -1233,5 +1232,5 @@ export class TextModelWithTokens extends TextModel implements EditorCommon.IToke
 	}
 }
 
-var getType = EditorCommon.LineTokensBinaryEncoding.getType;
-var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;
+var getType = editorCommon.LineTokensBinaryEncoding.getType;
+var getStartIndex = editorCommon.LineTokensBinaryEncoding.getStartIndex;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithTokensHelpers.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {NullMode} from 'vs/editor/common/modes/nullMode';
-import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {Arrays} from 'vs/editor/common/core/arrays';
+import {ILineTokens, IPosition, IWordAtPosition, IWordRange} from 'vs/editor/common/editorCommon';
+import {IMode, IModeTransition} from 'vs/editor/common/modes';
+import {NullMode} from 'vs/editor/common/modes/nullMode';
 
 export interface ITextSource {
 
@@ -17,13 +17,13 @@ export interface ITextSource {
 
 	getLineCount(): number;
 
-	getMode(): Modes.IMode;
+	getMode(): IMode;
 
-	getModeAtPosition(lineNumber:number, column:number): Modes.IMode;
+	getModeAtPosition(lineNumber:number, column:number): IMode;
 
-	_getLineModeTransitions(lineNumber:number): Modes.IModeTransition[];
+	_getLineModeTransitions(lineNumber:number): IModeTransition[];
 
-	getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean): EditorCommon.ILineTokens;
+	getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean): ILineTokens;
 }
 
 export interface INonWordTokenMap {
@@ -32,7 +32,7 @@ export interface INonWordTokenMap {
 
 export class WordHelper {
 
-	private static _safeGetWordDefinition(mode:Modes.IMode): RegExp {
+	private static _safeGetWordDefinition(mode:IMode): RegExp {
 		return (mode.richEditSupport ? mode.richEditSupport.wordDefinition : null);
 	}
 
@@ -59,16 +59,16 @@ export class WordHelper {
 		return result;
 	}
 
-	public static massageWordDefinitionOf(mode:Modes.IMode): RegExp {
+	public static massageWordDefinitionOf(mode:IMode): RegExp {
 		return WordHelper.ensureValidWordDefinition(WordHelper._safeGetWordDefinition(mode));
 	}
 
-	public static getWords(textSource:ITextSource, lineNumber:number): EditorCommon.IWordRange[] {
+	public static getWords(textSource:ITextSource, lineNumber:number): IWordRange[] {
 		if (!textSource._lineIsTokenized(lineNumber)) {
 			return WordHelper._getWordsInText(textSource.getLineContent(lineNumber), WordHelper.massageWordDefinitionOf(textSource.getMode()));
 		}
 
-		var r: EditorCommon.IWordRange[] = [],
+		var r: IWordRange[] = [],
 			txt = textSource.getLineContent(lineNumber);
 
 		if (txt.length > 0) {
@@ -118,15 +118,15 @@ export class WordHelper {
 		return r;
 	}
 
-	static _getWordsInText(text:string, wordDefinition:RegExp): EditorCommon.IWordRange[] {
+	static _getWordsInText(text:string, wordDefinition:RegExp): IWordRange[] {
 		var words = text.match(wordDefinition) || [],
 			k:number,
 			startWord:number,
 			endWord:number,
 			startColumn:number,
 			endColumn:number,
 			word:string,
-			r: EditorCommon.IWordRange[] = [];
+			r: IWordRange[] = [];
 
 		for (k = 0; k < words.length; k++) {
 			word = words[k].trim();
@@ -147,7 +147,7 @@ export class WordHelper {
 		return r;
 	}
 
-	private static _getWordAtColumn(txt:string, column:number, modeIndex: number, modeTransitions:Modes.IModeTransition[]): EditorCommon.IWordAtPosition {
+	private static _getWordAtColumn(txt:string, column:number, modeIndex: number, modeTransitions:IModeTransition[]): IWordAtPosition {
 		var modeStartIndex = modeTransitions[modeIndex].startIndex,
 			modeEndIndex = (modeIndex + 1 < modeTransitions.length ? modeTransitions[modeIndex + 1].startIndex : txt.length),
 			mode = modeTransitions[modeIndex].mode;
@@ -158,13 +158,13 @@ export class WordHelper {
 		);
 	}
 
-	public static getWordAtPosition(textSource:ITextSource, position:EditorCommon.IPosition): EditorCommon.IWordAtPosition {
+	public static getWordAtPosition(textSource:ITextSource, position:IPosition): IWordAtPosition {
 
 		if (!textSource._lineIsTokenized(position.lineNumber)) {
 			return WordHelper._getWordAtText(position.column, WordHelper.massageWordDefinitionOf(textSource.getMode()), textSource.getLineContent(position.lineNumber), 0);
 		}
 
-		var result: EditorCommon.IWordAtPosition = null;
+		var result: IWordAtPosition = null;
 		var txt = textSource.getLineContent(position.lineNumber),
 			modeTransitions = textSource._getLineModeTransitions(position.lineNumber),
 			columnIndex = position.column - 1,
@@ -180,7 +180,7 @@ export class WordHelper {
 		return result;
 	}
 
-	static _getWordAtText(column:number, wordDefinition:RegExp, text:string, textOffset:number): EditorCommon.IWordAtPosition {
+	static _getWordAtText(column:number, wordDefinition:RegExp, text:string, textOffset:number): IWordAtPosition {
 
 		// console.log('_getWordAtText: ', column, text, textOffset);
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/textModelWithTrackedRanges.ts
code:
@@ -5,13 +5,13 @@
 'use strict';
 
 import {TPromise} from 'vs/base/common/winjs.base';
-import {IMode} from 'vs/editor/common/modes';
+import {IdGenerator} from 'vs/editor/common/core/idGenerator';
 import {Range} from 'vs/editor/common/core/range';
-import {TextModelWithMarkers, INewMarker} from 'vs/editor/common/model/textModelWithMarkers';
-import {FullModelRetokenizer, IRetokenizeRequest} from 'vs/editor/common/model/textModelWithTokens';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ILineMarker} from 'vs/editor/common/model/modelLine';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import {IdGenerator} from 'vs/editor/common/core/idGenerator';
+import {INewMarker, TextModelWithMarkers} from 'vs/editor/common/model/textModelWithMarkers';
+import {FullModelRetokenizer, IRetokenizeRequest} from 'vs/editor/common/model/textModelWithTokens';
+import {IMode} from 'vs/editor/common/modes';
 
 interface ITrackedRange {
 	id:string;
@@ -38,10 +38,10 @@ class TrackedRangeModelRetokenizer extends FullModelRetokenizer {
 			startColumn : 1,
 			endLineNumber: lineNumber,
 			endColumn: model.getLineMaxColumn(lineNumber)
-		}, EditorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges);
+		}, editorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges);
 	}
 
-	public getRange(): EditorCommon.IRange {
+	public getRange(): editorCommon.IRange {
 		return (<TextModelWithTrackedRanges>this._model).getTrackedRange(this.trackedRangeId);
 	}
 
@@ -69,14 +69,14 @@ class TrackedRange implements ITrackedRange {
 
 var _INSTANCE_COUNT = 0;
 
-export class TextModelWithTrackedRanges extends TextModelWithMarkers implements EditorCommon.ITextModelWithTrackedRanges {
+export class TextModelWithTrackedRanges extends TextModelWithMarkers implements editorCommon.ITextModelWithTrackedRanges {
 
 	private _rangeIdGenerator: IdGenerator;
 	private _ranges:ITrackedRangesMap;
 	private _markerIdToRangeId:IMarkerIdToRangeIdMap;
 	private _multiLineTrackedRanges: { [key:string]: boolean; };
 
-	constructor(allowedEventTypes:string[], rawText:EditorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
+	constructor(allowedEventTypes:string[], rawText:editorCommon.IRawText, modeOrPromise:IMode|TPromise<IMode>) {
 		super(allowedEventTypes, rawText, modeOrPromise);
 		this._rangeIdGenerator = new IdGenerator((++_INSTANCE_COUNT) + ';');
 		this._ranges = {};
@@ -95,7 +95,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		super.dispose();
 	}
 
-	_resetValue(e:EditorCommon.IModelContentChangedFlushEvent, newValue:string): void {
+	_resetValue(e:editorCommon.IModelContentChangedFlushEvent, newValue:string): void {
 		super._resetValue(e, newValue);
 
 		// Destroy all my tracked ranges
@@ -113,15 +113,15 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		}
 	}
 
-	private _shouldStartMarkerSticksToPreviousCharacter(stickiness:EditorCommon.TrackedRangeStickiness): boolean {
-		if (stickiness === EditorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges || stickiness === EditorCommon.TrackedRangeStickiness.GrowsOnlyWhenTypingBefore) {
+	private _shouldStartMarkerSticksToPreviousCharacter(stickiness:editorCommon.TrackedRangeStickiness): boolean {
+		if (stickiness === editorCommon.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges || stickiness === editorCommon.TrackedRangeStickiness.GrowsOnlyWhenTypingBefore) {
 			return true;
 		}
 		return false;
 	}
 
-	private _shouldEndMarkerSticksToPreviousCharacter(stickiness:EditorCommon.TrackedRangeStickiness): boolean {
-		if (stickiness === EditorCommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges || stickiness === EditorCommon.TrackedRangeStickiness.GrowsOnlyWhenTypingBefore) {
+	private _shouldEndMarkerSticksToPreviousCharacter(stickiness:editorCommon.TrackedRangeStickiness): boolean {
+		if (stickiness === editorCommon.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges || stickiness === editorCommon.TrackedRangeStickiness.GrowsOnlyWhenTypingBefore) {
 			return true;
 		}
 		return false;
@@ -131,7 +131,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return Object.keys(this._ranges).length;
 	}
 
-	public addTrackedRange(textRange:EditorCommon.IRange, stickiness:EditorCommon.TrackedRangeStickiness): string {
+	public addTrackedRange(textRange:editorCommon.IRange, stickiness:editorCommon.TrackedRangeStickiness): string {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTrackedRanges.addTrackedRange: Model is disposed');
 		}
@@ -154,7 +154,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return range.id;
 	}
 
-	protected _addTrackedRanges(textRanges:EditorCommon.IRange[], stickinessArr:EditorCommon.TrackedRangeStickiness[]): string[] {
+	protected _addTrackedRanges(textRanges:editorCommon.IRange[], stickinessArr:editorCommon.TrackedRangeStickiness[]): string[] {
 		let addMarkers: INewMarker[] = [];
 		for (let i = 0, len = textRanges.length; i < len; i++) {
 			let textRange = textRanges[i];
@@ -193,7 +193,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return result;
 	}
 
-	public changeTrackedRange(rangeId:string, newTextRange:EditorCommon.IRange): void {
+	public changeTrackedRange(rangeId:string, newTextRange:editorCommon.IRange): void {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTrackedRanges.changeTrackedRange: Model is disposed');
 		}
@@ -209,7 +209,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		}
 	}
 
-	public changeTrackedRangeStickiness(rangeId:string, newStickiness:EditorCommon.TrackedRangeStickiness): void {
+	public changeTrackedRangeStickiness(rangeId:string, newStickiness:editorCommon.TrackedRangeStickiness): void {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTrackedRanges.changeTrackedRangeStickiness: Model is disposed');
 		}
@@ -272,7 +272,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		}
 	}
 
-	private _newEditorRange(startPosition: EditorCommon.IEditorPosition, endPosition: EditorCommon.IEditorPosition): EditorCommon.IEditorRange {
+	private _newEditorRange(startPosition: editorCommon.IEditorPosition, endPosition: editorCommon.IEditorPosition): editorCommon.IEditorRange {
 		if (endPosition.isBefore(startPosition)) {
 			// This tracked range has turned in on itself (end marker before start marker)
 			// This can happen in extreme editing conditions where lots of text is removed and lots is added
@@ -283,7 +283,7 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return new Range(startPosition.lineNumber, startPosition.column, endPosition.lineNumber, endPosition.column);
 	}
 
-	public getTrackedRange(rangeId:string): EditorCommon.IEditorRange {
+	public getTrackedRange(rangeId:string): editorCommon.IEditorRange {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTrackedRanges.getTrackedRange: Model is disposed');
 		}
@@ -298,12 +298,12 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	/**
 	 * Fetch only multi-line ranges that intersect with the given line number range
 	 */
-	private _getMultiLineTrackedRanges(filterStartLineNumber: number, filterEndLineNumber: number): EditorCommon.IModelTrackedRange[] {
-		var result: EditorCommon.IModelTrackedRange[] = [],
+	private _getMultiLineTrackedRanges(filterStartLineNumber: number, filterEndLineNumber: number): editorCommon.IModelTrackedRange[] {
+		var result: editorCommon.IModelTrackedRange[] = [],
 			rangeId: string,
 			range: ITrackedRange,
-			startMarker: EditorCommon.IEditorPosition,
-			endMarker: EditorCommon.IEditorPosition;
+			startMarker: editorCommon.IEditorPosition,
+			endMarker: editorCommon.IEditorPosition;
 
 		for (rangeId in this._multiLineTrackedRanges) {
 			if (this._multiLineTrackedRanges.hasOwnProperty(rangeId)) {
@@ -329,21 +329,21 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return result;
 	}
 
-	public getLinesTrackedRanges(startLineNumber:number, endLineNumber:number): EditorCommon.IModelTrackedRange[] {
+	public getLinesTrackedRanges(startLineNumber:number, endLineNumber:number): editorCommon.IModelTrackedRange[] {
 		if (this._isDisposed) {
 			throw new Error('TextModelWithTrackedRanges.getLinesTrackedRanges: Model is disposed');
 		}
 
 		var result = this._getMultiLineTrackedRanges(startLineNumber, endLineNumber),
 			resultMap: { [rangeId:string]: boolean; } = {},
-			lineMarkers: EditorCommon.IReadOnlyLineMarker[],
-			lineMarker: EditorCommon.IReadOnlyLineMarker,
+			lineMarkers: editorCommon.IReadOnlyLineMarker[],
+			lineMarker: editorCommon.IReadOnlyLineMarker,
 			rangeId: string,
 			i: number,
 			len: number,
 			lineNumber: number,
-			startMarker: EditorCommon.IEditorPosition,
-			endMarker: EditorCommon.IEditorPosition;
+			startMarker: editorCommon.IEditorPosition,
+			endMarker: editorCommon.IEditorPosition;
 
 		for (i = 0, len = result.length; i < len; i++) {
 			resultMap[result[i].id] = true;
@@ -373,9 +373,9 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 		return result;
 	}
 
-	_onChangedMarkers(changedMarkers:ILineMarker[]): EditorCommon.IChangedTrackedRanges {
-		var changedRanges:EditorCommon.IChangedTrackedRanges = {},
-			changedRange:EditorCommon.IRange,
+	_onChangedMarkers(changedMarkers:ILineMarker[]): editorCommon.IChangedTrackedRanges {
+		var changedRanges:editorCommon.IChangedTrackedRanges = {},
+			changedRange:editorCommon.IRange,
 			range:ITrackedRange,
 			rangeId:string,
 			marker:ILineMarker,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/tokenIterator.ts
code:
@@ -4,23 +4,23 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import EditorCommon = require('vs/editor/common/editorCommon');
+import * as editorCommon from 'vs/editor/common/editorCommon';
 
-var getStartIndex = EditorCommon.LineTokensBinaryEncoding.getStartIndex;
-var inflate = EditorCommon.LineTokensBinaryEncoding.inflate;
+var getStartIndex = editorCommon.LineTokensBinaryEncoding.getStartIndex;
+var inflate = editorCommon.LineTokensBinaryEncoding.inflate;
 
-export class TokenIterator implements EditorCommon.ITokenIterator {
+export class TokenIterator implements editorCommon.ITokenIterator {
 
-	private _model:EditorCommon.ITokenizedModel;
+	private _model:editorCommon.ITokenizedModel;
 	private _currentLineNumber:number;
 	private _currentTokenIndex:number;
-	private _currentLineTokens:EditorCommon.ILineTokens;
+	private _currentLineTokens:editorCommon.ILineTokens;
 	private _currentTokens:number[];
-	private _map:EditorCommon.ITokensInflatorMap;
-	private _next:EditorCommon.ITokenInfo;
-	private _prev:EditorCommon.ITokenInfo;
+	private _map:editorCommon.ITokensInflatorMap;
+	private _next:editorCommon.ITokenInfo;
+	private _prev:editorCommon.ITokenInfo;
 
-	constructor(model:EditorCommon.ITokenizedModel, position:EditorCommon.IPosition) {
+	constructor(model:editorCommon.ITokenizedModel, position:editorCommon.IPosition) {
 		this._model = model;
 		this._currentLineNumber = position.lineNumber;
 		this._currentTokenIndex = 0;
@@ -99,7 +99,7 @@ export class TokenIterator implements EditorCommon.ITokenIterator {
 		}
 	}
 
-	private _current(): EditorCommon.ITokenInfo {
+	private _current(): editorCommon.ITokenInfo {
 		return {
 			token: inflate(this._map, this._currentTokens[this._currentTokenIndex]),
 			lineNumber: this._currentLineNumber,
@@ -112,7 +112,7 @@ export class TokenIterator implements EditorCommon.ITokenIterator {
 		return this._next !== null;
 	}
 
-	public next(): EditorCommon.ITokenInfo {
+	public next(): editorCommon.ITokenInfo {
 		var result = this._next;
 		this._advanceNext();
 		return result;
@@ -122,7 +122,7 @@ export class TokenIterator implements EditorCommon.ITokenIterator {
 		return this._prev !== null;
 	}
 
-	public prev(): EditorCommon.ITokenInfo {
+	public prev(): editorCommon.ITokenInfo {
 		var result = this._prev;
 		this._advancePrev();
 		return result;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/model/tokensBinaryEncoding.ts
code:
@@ -4,12 +4,12 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Strings = require('vs/base/common/strings');
-import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Errors = require('vs/base/common/errors');
+import {onUnexpectedError} from 'vs/base/common/errors';
+import * as strings from 'vs/base/common/strings';
+import {ITokensInflatorMap} from 'vs/editor/common/editorCommon';
+import {IToken} from 'vs/editor/common/modes';
 
-class InflatedToken implements Modes.IToken {
+class InflatedToken implements IToken {
 	startIndex:number;
 	type:string;
 
@@ -32,12 +32,12 @@ var DEFAULT_TOKEN = {
 	startIndex: 0,
 	type: ''
 };
-var INFLATED_TOKENS_EMPTY_TEXT = <Modes.IToken[]>[];
+var INFLATED_TOKENS_EMPTY_TEXT = <IToken[]>[];
 var DEFLATED_TOKENS_EMPTY_TEXT = <number[]>[];
-var INFLATED_TOKENS_NON_EMPTY_TEXT = <Modes.IToken[]>[DEFAULT_TOKEN];
+var INFLATED_TOKENS_NON_EMPTY_TEXT = <IToken[]>[DEFAULT_TOKEN];
 var DEFLATED_TOKENS_NON_EMPTY_TEXT = <number[]>[0];
 
-export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.IToken[]): number[] {
+export function deflateArr(map:ITokensInflatorMap, tokens:IToken[]): number[] {
 	if (tokens.length === 0) {
 		return DEFLATED_TOKENS_EMPTY_TEXT;
 	}
@@ -49,7 +49,7 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 		len:number,
 		deflatedToken:number,
 		deflated:number,
-		token:Modes.IToken,
+		token:IToken,
 		inflateMap = map._inflate,
 		deflateMap = map._deflate,
 		prevStartIndex:number = -1,
@@ -60,7 +60,7 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 
 		if (token.startIndex <= prevStartIndex) {
 			token.startIndex = prevStartIndex + 1;
-			Errors.onUnexpectedError({
+			onUnexpectedError({
 				message: 'Invalid tokens detected',
 				tokens: tokens
 			});
@@ -97,7 +97,7 @@ export function deflateArr(map:EditorCommon.ITokensInflatorMap, tokens:Modes.ITo
 	return result;
 }
 
-export function inflate(map:EditorCommon.ITokensInflatorMap, binaryEncodedToken:number): Modes.IToken {
+export function inflate(map:ITokensInflatorMap, binaryEncodedToken:number): IToken {
 	if (binaryEncodedToken === 0) {
 		return DEFAULT_TOKEN;
 	}
@@ -112,23 +112,23 @@ export function getStartIndex(binaryEncodedToken:number): number {
 	return (binaryEncodedToken / START_INDEX_OFFSET) & START_INDEX_MASK;
 }
 
-export function getType(map:EditorCommon.ITokensInflatorMap, binaryEncodedToken:number): string {
+export function getType(map:ITokensInflatorMap, binaryEncodedToken:number): string {
 	var deflatedType = (binaryEncodedToken / TYPE_OFFSET) & TYPE_MASK;
 	if (deflatedType === 0) {
-		return Strings.empty;
+		return strings.empty;
 	}
 	return map._inflate[deflatedType];
 }
 
-export function inflateArr(map:EditorCommon.ITokensInflatorMap, binaryEncodedTokens:number[]): Modes.IToken[] {
+export function inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): IToken[] {
 	if (binaryEncodedTokens.length === 0) {
 		return INFLATED_TOKENS_EMPTY_TEXT;
 	}
 	if (binaryEncodedTokens.length === 1 && binaryEncodedTokens[0] === 0) {
 		return INFLATED_TOKENS_NON_EMPTY_TEXT;
 	}
 
-	var result: Modes.IToken[] = new Array(binaryEncodedTokens.length),
+	var result: IToken[] = new Array(binaryEncodedTokens.length),
 		i:number,
 		len:number,
 		deflated:number,
@@ -152,7 +152,7 @@ export function findIndexOfOffset(binaryEncodedTokens:number[], offset:number):
 	return findIndexInSegmentsArray(binaryEncodedTokens, offset);
 }
 
-export function sliceAndInflate(map:EditorCommon.ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): Modes.IToken[] {
+export function sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): IToken[] {
 	if (binaryEncodedTokens.length === 0) {
 		return INFLATED_TOKENS_EMPTY_TEXT;
 	}
@@ -167,7 +167,7 @@ export function sliceAndInflate(map:EditorCommon.ITokensInflatorMap, binaryEncod
 		originalStartIndex:number,
 		newStartIndex:number,
 		deflatedType:number,
-		result: Modes.IToken[] = [],
+		result: IToken[] = [],
 		inflateMap = map._inflate;
 
 	originalToken = binaryEncodedTokens[startIndex];

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes.ts
code:
@@ -4,14 +4,14 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {TPromise} from 'vs/base/common/winjs.base';
 import {IMatch} from 'vs/base/common/filters';
-import {IMarker} from 'vs/platform/markers/common/markers';
-import EditorCommon = require('vs/editor/common/editorCommon');
 import {IHTMLContentElement} from 'vs/base/common/htmlContent';
-import URI from 'vs/base/common/uri';
 import {IDisposable} from 'vs/base/common/lifecycle';
+import URI from 'vs/base/common/uri';
+import {TPromise} from 'vs/base/common/winjs.base';
 import {AsyncDescriptor0} from 'vs/platform/instantiation/common/descriptors';
+import {IMarker} from 'vs/platform/markers/common/markers';
+import * as editorCommon from 'vs/editor/common/editorCommon';
 
 export interface IWorkerParticipantDescriptor {
 	modeId: string;
@@ -190,7 +190,7 @@ export interface IMode {
 	 */
 	toSimplifiedMode(): IMode;
 
-	addSupportChangedListener?(callback: (e: EditorCommon.IModeSupportChangedEvent) => void): IDisposable;
+	addSupportChangedListener?(callback: (e: editorCommon.IModeSupportChangedEvent) => void): IDisposable;
 
 	/**
 	 * Register a support by name. Only optional.
@@ -335,13 +335,13 @@ export interface ITokenizationSupport {
  * Interface used to get extra info for a symbol
  */
 export interface IComputeExtraInfoResult {
-	range: EditorCommon.IRange;
+	range: editorCommon.IRange;
 	value?: string;
 	htmlContent?: IHTMLContentElement[];
 	className?: string;
 }
 export interface IExtraInfoSupport {
-	computeInfo(resource:URI, position:EditorCommon.IPosition):TPromise<IComputeExtraInfoResult>;
+	computeInfo(resource:URI, position:editorCommon.IPosition):TPromise<IComputeExtraInfoResult>;
 }
 
 
@@ -377,12 +377,12 @@ export interface ISuggestSupport {
 	/**
 	 * Compute all completions for the given resource at the given position.
 	 */
-	suggest(resource: URI, position: EditorCommon.IPosition, triggerCharacter?: string): TPromise<ISuggestResult[]>;
+	suggest(resource: URI, position: editorCommon.IPosition, triggerCharacter?: string): TPromise<ISuggestResult[]>;
 
 	/**
 	 * Compute more details for the given suggestion.
 	 */
-	getSuggestionDetails?: (resource: URI, position: EditorCommon.IPosition, suggestion: ISuggestion) => TPromise<ISuggestion>;
+	getSuggestionDetails?: (resource: URI, position: editorCommon.IPosition, suggestion: ISuggestion) => TPromise<ISuggestion>;
 
 	getFilter(): ISuggestionFilter;
 	getTriggerCharacters(): string[];
@@ -404,9 +404,9 @@ export interface IQuickFixResult {
 }
 
 export interface IQuickFixSupport {
-	getQuickFixes(resource: URI, range: IMarker | EditorCommon.IRange): TPromise<IQuickFix[]>;
+	getQuickFixes(resource: URI, range: IMarker | editorCommon.IRange): TPromise<IQuickFix[]>;
 	//TODO@joh this should be removed in the furture such that we can trust the command and it's args
-	runQuickFixAction(resource: URI, range: EditorCommon.IRange, quickFix: IQuickFix):TPromise<IQuickFixResult>;
+	runQuickFixAction(resource: URI, range: editorCommon.IRange, quickFix: IQuickFix):TPromise<IQuickFixResult>;
 }
 
 export interface IParameter {
@@ -434,20 +434,20 @@ export interface IParameterHints {
 export interface IParameterHintsSupport {
 	getParameterHintsTriggerCharacters(): string[];
 	shouldTriggerParameterHints(context: ILineContext, offset: number): boolean;
-	getParameterHints(resource: URI, position: EditorCommon.IPosition, triggerCharacter?: string): TPromise<IParameterHints>;
+	getParameterHints(resource: URI, position: editorCommon.IPosition, triggerCharacter?: string): TPromise<IParameterHints>;
 }
 
 
 export interface IOccurence {
 	kind?:string;
-	range:EditorCommon.IRange;
+	range:editorCommon.IRange;
 }
 
 /**
  * Interface used to find occurrences of a symbol
  */
 export interface IOccurrencesSupport {
-	findOccurrences(resource:URI, position:EditorCommon.IPosition, strict?:boolean):TPromise<IOccurence[]>;
+	findOccurrences(resource:URI, position:editorCommon.IPosition, strict?:boolean):TPromise<IOccurence[]>;
 }
 
 
@@ -456,7 +456,7 @@ export interface IOccurrencesSupport {
  */
 export interface IReference {
 	resource: URI;
-	range: EditorCommon.IRange;
+	range: editorCommon.IRange;
 }
 
 /**
@@ -474,20 +474,20 @@ export interface IReferenceSupport {
 	 * @returns a list of reference of the symbol at the position in the
 	 * 	given resource.
 	 */
-	findReferences(resource:URI, position:EditorCommon.IPosition, includeDeclaration:boolean):TPromise<IReference[]>;
+	findReferences(resource:URI, position:editorCommon.IPosition, includeDeclaration:boolean):TPromise<IReference[]>;
 }
 
 /**
  * Interface used to find declarations on a symbol
  */
 export interface IDeclarationSupport {
 	canFindDeclaration(context:ILineContext, offset:number):boolean;
-	findDeclaration(resource:URI, position:EditorCommon.IPosition):TPromise<IReference|IReference[]>;
+	findDeclaration(resource:URI, position:editorCommon.IPosition):TPromise<IReference|IReference[]>;
 }
 
 export interface ITypeDeclarationSupport {
 	canFindTypeDeclaration(context:ILineContext, offset:number):boolean;
-	findTypeDeclaration(resource:URI, position:EditorCommon.IPosition):TPromise<IReference>;
+	findTypeDeclaration(resource:URI, position:editorCommon.IPosition):TPromise<IReference>;
 }
 
 /**
@@ -498,7 +498,7 @@ export interface IOutlineEntry {
 	containerLabel?: string;
 	type: string;
 	icon?: string; // icon class or null to use the default images based on the type
-	range: EditorCommon.IRange;
+	range: editorCommon.IRange;
 	children?: IOutlineEntry[];
 }
 
@@ -512,10 +512,10 @@ export interface IOutlineSupport {
  */
 export interface ILogicalSelectionEntry {
 	type:string;
-	range:EditorCommon.IRange;
+	range:editorCommon.IRange;
 }
 export interface ILogicalSelectionSupport {
-	getRangesToPosition(resource:URI, position:EditorCommon.IPosition):TPromise<ILogicalSelectionEntry[]>;
+	getRangesToPosition(resource:URI, position:editorCommon.IPosition):TPromise<ILogicalSelectionEntry[]>;
 }
 
 /**
@@ -535,25 +535,25 @@ export interface IFormattingOptions {
  */
 export interface IFormattingSupport {
 
-	formatDocument?: (resource: URI, options: IFormattingOptions) => TPromise<EditorCommon.ISingleEditOperation[]>;
+	formatDocument?: (resource: URI, options: IFormattingOptions) => TPromise<editorCommon.ISingleEditOperation[]>;
 
-	formatRange?: (resource: URI, range: EditorCommon.IRange, options: IFormattingOptions) => TPromise<EditorCommon.ISingleEditOperation[]>;
+	formatRange?: (resource: URI, range: editorCommon.IRange, options: IFormattingOptions) => TPromise<editorCommon.ISingleEditOperation[]>;
 
 	autoFormatTriggerCharacters?: string[];
 
-	formatAfterKeystroke?: (resource: URI, position: EditorCommon.IPosition, ch: string, options: IFormattingOptions) => TPromise<EditorCommon.ISingleEditOperation[]>;
+	formatAfterKeystroke?: (resource: URI, position: editorCommon.IPosition, ch: string, options: IFormattingOptions) => TPromise<editorCommon.ISingleEditOperation[]>;
 }
 
 export interface IInplaceReplaceSupportResult {
 	value: string;
-	range:EditorCommon.IRange;
+	range:editorCommon.IRange;
 }
 
 /**
  * Interface used to navigate with a value-set.
  */
 export interface IInplaceReplaceSupport {
-	navigateValueSet(resource:URI, range:EditorCommon.IRange, up:boolean):TPromise<IInplaceReplaceSupportResult>;
+	navigateValueSet(resource:URI, range:editorCommon.IRange, up:boolean):TPromise<IInplaceReplaceSupportResult>;
 }
 
 /**
@@ -573,7 +573,7 @@ export interface IEmitOutput {
  */
 export interface ILink {
 
-	range: EditorCommon.IRange;
+	range: editorCommon.IRange;
 
 	/**
 	 * The url of the link.
@@ -592,12 +592,12 @@ export interface ILinkSupport {
  * Interface used to define a configurable editor mode.
  */
 export interface IConfigurationSupport {
-	configure(options:any):TPromise<boolean>;
+	configure(options:any):TPromise<void>;
 }
 
 export interface IResourceEdit {
 	resource: URI;
-	range?: EditorCommon.IRange;
+	range?: editorCommon.IRange;
 	newText: string;
 }
 
@@ -614,7 +614,7 @@ export interface IRenameSupport {
 
 	filter?: string[];
 
-	rename(resource: URI, position: EditorCommon.IPosition, newName: string): TPromise<IRenameResult>;
+	rename(resource: URI, position: editorCommon.IPosition, newName: string): TPromise<IRenameResult>;
 }
 
 export interface ICommand {
@@ -624,7 +624,7 @@ export interface ICommand {
 }
 
 export interface ICodeLensSymbol {
-	range: EditorCommon.IRange;
+	range: editorCommon.IRange;
 	id?: string;
 	command?: ICommand;
 }
@@ -649,15 +649,7 @@ export interface ITaskSupport {
 	clean?():TPromise<void>;
 }
 
-/**
- * Standard brackets used for auto indentation
- */
-export interface IBracketPair {
-	tokenType:string;
-	open:string;
-	close:string;
-	isElectric:boolean;
-}
+export type CharacterPair = [string, string];
 
 export interface IAutoClosingPairConditional extends IAutoClosingPair {
 	notIn?: string[];
@@ -703,7 +695,7 @@ export interface IRichEditElectricCharacter {
 }
 
 export interface IRichEditOnEnter {
-	onEnter(model:EditorCommon.ITokenizedModel, position: EditorCommon.IPosition): IEnterAction;
+	onEnter(model:editorCommon.ITokenizedModel, position: editorCommon.IPosition): IEnterAction;
 }
 
 /**
@@ -732,8 +724,8 @@ export interface IRichEditBrackets {
 	maxBracketLength: number;
 	forwardRegex: RegExp;
 	reversedRegex: RegExp;
-	brackets: EditorCommon.IRichEditBracket[];
-	textIsBracket: {[text:string]:EditorCommon.IRichEditBracket;};
+	brackets: editorCommon.IRichEditBracket[];
+	textIsBracket: {[text:string]:editorCommon.IRichEditBracket;};
 	textIsOpenBracket: {[text:string]:boolean;};
 }
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/TMState.ts
code:
@@ -4,9 +4,8 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import {IMode, IState, ITokenizationResult} from 'vs/editor/common/modes';
 import {AbstractState} from 'vs/editor/common/modes/abstractState';
-import Modes = require('vs/editor/common/modes');
-
 import {StackElement} from 'vscode-textmate';
 
 function stackElementEquals(a:StackElement, b:StackElement): boolean {
@@ -25,13 +24,13 @@ function stackElementEquals(a:StackElement, b:StackElement): boolean {
 	);
 }
 
-export class TMState implements Modes.IState {
+export class TMState implements IState {
 
-	private _mode: Modes.IMode;
-	private _parentEmbedderState: Modes.IState;
+	private _mode: IMode;
+	private _parentEmbedderState: IState;
 	private _ruleStack: StackElement[];
 
-	constructor(mode: Modes.IMode, parentEmbedderState: Modes.IState, ruleStack: StackElement[]) {
+	constructor(mode: IMode, parentEmbedderState: IState, ruleStack: StackElement[]) {
 		this._mode = mode;
 		this._parentEmbedderState = parentEmbedderState;
 		this._ruleStack = ruleStack;
@@ -43,7 +42,7 @@ export class TMState implements Modes.IState {
 		return new TMState(this._mode, parentEmbedderStateClone, ruleStackClone);
 	}
 
-	public equals(other:Modes.IState):boolean {
+	public equals(other:IState):boolean {
 		if (!other || !(other instanceof TMState)) {
 			return false;
 		}
@@ -73,19 +72,19 @@ export class TMState implements Modes.IState {
 		return true;
 	}
 
-	public getMode():Modes.IMode {
+	public getMode():IMode {
 		return this._mode;
 	}
 
-	public tokenize(stream:any):Modes.ITokenizationResult {
+	public tokenize(stream:any):ITokenizationResult {
 		throw new Error();
 	}
 
-	public getStateData():Modes.IState {
+	public getStateData():IState {
 		return this._parentEmbedderState;
 	}
 
-	public setStateData(state:Modes.IState):void {
+	public setStateData(state:IState):void {
 		this._parentEmbedderState = state;
 	}
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/abstractMode.ts
code:
@@ -5,93 +5,66 @@
 'use strict';
 
 import {EventEmitter} from 'vs/base/common/eventEmitter';
-import {NullMode} from 'vs/editor/common/modes/nullMode';
-import {TextualSuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
-import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
-import Modes = require('vs/editor/common/modes');
-import EditorCommon = require('vs/editor/common/editorCommon');
-import URI from 'vs/base/common/uri';
 import {IDisposable} from 'vs/base/common/lifecycle';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IThreadService, ThreadAffinity} from 'vs/platform/thread/common/thread';
-import {OneWorkerAttr, AllWorkersAttr} from 'vs/platform/thread/common/threadService';
 import {AsyncDescriptor2, createAsyncDescriptor2} from 'vs/platform/instantiation/common/descriptors';
+import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
+import {IModeSupportChangedEvent} from 'vs/editor/common/editorCommon';
+import * as modes from 'vs/editor/common/modes';
+import {NullMode} from 'vs/editor/common/modes/nullMode';
+import {TextualSuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
 
 export function createWordRegExp(allowInWords:string = ''): RegExp {
 	return NullMode.createWordRegExp(allowInWords);
 }
 
-export abstract class AbstractMode<W extends AbstractModeWorker> implements Modes.IMode {
-
-	_instantiationService:IInstantiationService;
-	_threadService:IThreadService;
-	private _descriptor:Modes.IModeDescriptor;
+export class ModeWorkerManager<W> {
 
+	private _descriptor: modes.IModeDescriptor;
+	private _workerDescriptor: AsyncDescriptor2<string, modes.IWorkerParticipant[], W>;
+	private _superWorkerModuleId: string;
+	private _instantiationService: IInstantiationService;
 	private _workerPiecePromise:TPromise<W>;
 
-	_options:any;
-
-	// adapters start
-	public autoValidateDelay:number;
-	public inplaceReplaceSupport:Modes.IInplaceReplaceSupport;
-	public configSupport:Modes.IConfigurationSupport;
-	// adapters end
-
-	private _eventEmitter = new EventEmitter();
-	private _simplifiedMode: Modes.IMode;
-
 	constructor(
-		descriptor:Modes.IModeDescriptor,
-		instantiationService: IInstantiationService,
-		threadService: IThreadService
+		descriptor:modes.IModeDescriptor,
+		workerModuleId:string,
+		workerClassName:string,
+		superWorkerModuleId:string,
+		instantiationService: IInstantiationService
 	) {
-		this._instantiationService = instantiationService;
-		this._threadService = threadService;
 		this._descriptor = descriptor;
-
-		this._options = null;
-
-		this.autoValidateDelay = 500;
-
-		this.inplaceReplaceSupport = this;
-		this.configSupport = this;
-
+		this._workerDescriptor = createAsyncDescriptor2(workerModuleId, workerClassName);
+		this._superWorkerModuleId = superWorkerModuleId;
+		this._instantiationService = instantiationService;
 		this._workerPiecePromise = null;
-		this._simplifiedMode = null;
 	}
 
-	public getId(): string {
-		return this._descriptor.id;
-	}
-
-	public creationDone(): void {
-		if (this._threadService.isInMainThread) {
-			// Pick a worker to do validation
-			this._pickAWorkerToValidate();
-		}
-	}
-
-	public toSimplifiedMode(): Modes.IMode {
-		if (!this._simplifiedMode) {
-			this._simplifiedMode = new SimplifiedMode(this);
-		}
-		return this._simplifiedMode;
+	public worker<T>(runner:(worker:W)=>TPromise<T>): TPromise<T>
+	public worker<T>(runner:(worker:W)=>T): TPromise<T> {
+		return this._getOrCreateWorker().then(runner);
 	}
 
 	private _getOrCreateWorker(): TPromise<W> {
 		if (!this._workerPiecePromise) {
-			var workerDescriptor: AsyncDescriptor2<Modes.IMode, Modes.IWorkerParticipant[], W> = this._getWorkerDescriptor();
-			// First, load the code of the worker (without instantiating it)
-			this._workerPiecePromise = AbstractMode._loadModule(workerDescriptor.moduleName).then(() => {
+			// TODO@Alex: workaround for missing `bundles` config
+
+			// First, load the code of the worker super class
+			let superWorkerCodePromise = (this._superWorkerModuleId ? ModeWorkerManager._loadModule(this._superWorkerModuleId) : TPromise.as(null));
+
+			this._workerPiecePromise = superWorkerCodePromise.then(() => {
+				// Second, load the code of the worker (without instantiating it)
+				return ModeWorkerManager._loadModule(this._workerDescriptor.moduleName);
+			}).then(() => {
 				// Then, load & instantiate all the participants
 				var participants = this._descriptor.workerParticipants;
-				return TPromise.join<Modes.IWorkerParticipant>(participants.map((participant) => {
+				return TPromise.join<modes.IWorkerParticipant>(participants.map((participant) => {
 					return this._instantiationService.createInstance(participant);
 				}));
-			}).then((participants:Modes.IWorkerParticipant[]) => {
-				return this._instantiationService.createInstance<Modes.IMode, Modes.IWorkerParticipant[], W>(workerDescriptor, this, participants);
+			}).then((participants:modes.IWorkerParticipant[]) => {
+				// Finally, create the mode worker instance
+				return this._instantiationService.createInstance<string, modes.IWorkerParticipant[], W>(this._workerDescriptor, this._descriptor.id, participants);
 			});
 		}
 
@@ -105,29 +78,36 @@ export abstract class AbstractMode<W extends AbstractModeWorker> implements Mode
 			// Cannot cancel loading code
 		});
 	}
+}
 
-	protected _getWorkerDescriptor(): AsyncDescriptor2<Modes.IMode, Modes.IWorkerParticipant[], W> {
-		return createAsyncDescriptor2('vs/editor/common/modes/nullWorker', 'NullWorker');
-	}
+export abstract class AbstractMode implements modes.IMode {
 
-	_worker<T>(runner:(worker:W)=>TPromise<T>): TPromise<T>;
-	_worker<T>(runner:(worker:W)=>T): TPromise<T>;
-	_worker<T>(runner:(worker:W)=>any): TPromise<T> {
-		return this._getOrCreateWorker().then(runner);
+	private _modeId: string;
+	private _eventEmitter: EventEmitter;
+	private _simplifiedMode: modes.IMode;
+
+	constructor(modeId:string) {
+		this._modeId = modeId;
+		this._eventEmitter = new EventEmitter();
+		this._simplifiedMode = null;
 	}
 
-	// START mics interface implementations
+	public getId(): string {
+		return this._modeId;
+	}
 
-	static $_pickAWorkerToValidate = OneWorkerAttr(AbstractMode, AbstractMode.prototype._pickAWorkerToValidate, ThreadAffinity.Group1);
-	public _pickAWorkerToValidate(): TPromise<void> {
-		return this._worker((w) => w.enableValidator());
+	public toSimplifiedMode(): modes.IMode {
+		if (!this._simplifiedMode) {
+			this._simplifiedMode = new SimplifiedMode(this);
+		}
+		return this._simplifiedMode;
 	}
 
-	public addSupportChangedListener(callback: (e: EditorCommon.IModeSupportChangedEvent) => void) : IDisposable {
+	public addSupportChangedListener(callback: (e: IModeSupportChangedEvent) => void) : IDisposable {
 		return this._eventEmitter.addListener2('modeSupportChanged', callback);
 	}
 
-	public registerSupport<T>(support:string, callback:(mode:Modes.IMode) => T) : IDisposable {
+	public registerSupport<T>(support:string, callback:(mode:modes.IMode) => T) : IDisposable {
 		var supportImpl = callback(this);
 		this[support] = supportImpl;
 		this._eventEmitter.emit('modeSupportChanged', _createModeSupportChangedEvent(support));
@@ -141,45 +121,18 @@ export abstract class AbstractMode<W extends AbstractModeWorker> implements Mode
 			}
 		};
 	}
-
-	static $suggest = OneWorkerAttr(AbstractMode, AbstractMode.prototype.suggest);
-	public suggest(resource:URI, position:EditorCommon.IPosition):TPromise<Modes.ISuggestResult[]> {
-		return this._worker((w) => w.suggest(resource, position));
-	}
-
-	static $navigateValueSet = OneWorkerAttr(AbstractMode, AbstractMode.prototype.navigateValueSet);
-	public navigateValueSet(resource:URI, position:EditorCommon.IRange, up:boolean):TPromise<Modes.IInplaceReplaceSupportResult> {
-		return this._worker((w) => w.inplaceReplaceSupport.navigateValueSet(resource, position, up));
-	}
-
-	public configure(options:any): TPromise<boolean> {
-		this._options = options;
-
-		if (this._threadService.isInMainThread) {
-			return this._configureWorkers(options);
-		} else {
-			return this._worker((w) => w.configure(options));
-		}
-	}
-
-	static $_configureWorkers = AllWorkersAttr(AbstractMode, AbstractMode.prototype._configureWorkers);
-	private _configureWorkers(options:any): TPromise<boolean> {
-		return this._worker((w) => w.configure(options));
-	}
-
-	// END
 }
 
-class SimplifiedMode implements Modes.IMode {
+class SimplifiedMode implements modes.IMode {
 
-	tokenizationSupport: Modes.ITokenizationSupport;
-	richEditSupport: Modes.IRichEditSupport;
+	tokenizationSupport: modes.ITokenizationSupport;
+	richEditSupport: modes.IRichEditSupport;
 
-	private _sourceMode: Modes.IMode;
+	private _sourceMode: modes.IMode;
 	private _eventEmitter: EventEmitter;
 	private _id: string;
 
-	constructor(sourceMode: Modes.IMode) {
+	constructor(sourceMode: modes.IMode) {
 		this._sourceMode = sourceMode;
 		this._eventEmitter = new EventEmitter();
 		this._id = 'vs.editor.modes.simplifiedMode:' + sourceMode.getId();
@@ -200,7 +153,7 @@ class SimplifiedMode implements Modes.IMode {
 		return this._id;
 	}
 
-	public toSimplifiedMode(): Modes.IMode {
+	public toSimplifiedMode(): modes.IMode {
 		return this;
 	}
 
@@ -209,8 +162,8 @@ class SimplifiedMode implements Modes.IMode {
 		this.richEditSupport = this._sourceMode.richEditSupport;
 	}
 
-	private static _createModeSupportChangedEvent(originalModeEvent:EditorCommon.IModeSupportChangedEvent): EditorCommon.IModeSupportChangedEvent {
-		var event:EditorCommon.IModeSupportChangedEvent = {
+	private static _createModeSupportChangedEvent(originalModeEvent:IModeSupportChangedEvent): IModeSupportChangedEvent {
+		var event:IModeSupportChangedEvent = {
 			codeLensSupport: false,
 			tokenizationSupport: originalModeEvent.tokenizationSupport,
 			occurrencesSupport:false,
@@ -299,24 +252,22 @@ export var isDigit:(character:string, base:number)=>boolean = (function () {
 	};
 })();
 
-export class FrankensteinMode extends AbstractMode<AbstractModeWorker> {
+export class FrankensteinMode extends AbstractMode {
 
-	public suggestSupport:Modes.ISuggestSupport;
+	public suggestSupport:modes.ISuggestSupport;
 
 	constructor(
-		descriptor:Modes.IModeDescriptor,
-		@IInstantiationService instantiationService: IInstantiationService,
-		@IThreadService threadService: IThreadService,
+		descriptor:modes.IModeDescriptor,
 		@IEditorWorkerService editorWorkerService: IEditorWorkerService
 	) {
-		super(descriptor, instantiationService, threadService);
+		super(descriptor.id);
 
 		this.suggestSupport = new TextualSuggestSupport(this.getId(), editorWorkerService);
 	}
 }
 
-function _createModeSupportChangedEvent(...changedSupports: string[]): EditorCommon.IModeSupportChangedEvent {
-	var event:EditorCommon.IModeSupportChangedEvent = {
+function _createModeSupportChangedEvent(...changedSupports: string[]): IModeSupportChangedEvent {
+	var event:IModeSupportChangedEvent = {
 		codeLensSupport: false,
 		tokenizationSupport:false,
 		occurrencesSupport:false,

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/abstractModeWorker.ts
code:
@@ -1,196 +0,0 @@
-/*---------------------------------------------------------------------------------------------
- *  Copyright (c) Microsoft Corporation. All rights reserved.
- *  Licensed under the MIT License. See License.txt in the project root for license information.
- *--------------------------------------------------------------------------------------------*/
-'use strict';
-
-import URI from 'vs/base/common/uri';
-import {IMarkerService} from 'vs/platform/markers/common/markers';
-import {IResourceService} from 'vs/editor/common/services/resourceService';
-import {DefaultFilter} from 'vs/editor/common/modes/modesFilters';
-import {ValidationHelper} from 'vs/editor/common/worker/validationHelper';
-import EditorCommon = require('vs/editor/common/editorCommon');
-import Modes = require('vs/editor/common/modes');
-import {TPromise} from 'vs/base/common/winjs.base';
-import {WorkerInplaceReplaceSupport} from 'vs/editor/common/modes/supports/inplaceReplaceSupport';
-
-export class AbstractModeWorker {
-
-	static filter: Modes.ISuggestionFilter = DefaultFilter;
-
-	private _participants:Modes.IWorkerParticipant[] = [];
-
-	public resourceService:IResourceService;
-	public markerService: IMarkerService;
-
-	public inplaceReplaceSupport: Modes.IInplaceReplaceSupport;
-
-	private _mode:Modes.IMode;
-
-	_validationHelper: ValidationHelper;
-
-	constructor(mode: Modes.IMode, participants: Modes.IWorkerParticipant[], @IResourceService resourceService: IResourceService,
-		@IMarkerService markerService: IMarkerService) {
-
-		this._mode = mode;
-		this._participants = participants;
-		this.resourceService = resourceService;
-		this.markerService = markerService;
-
-		this._validationHelper = new ValidationHelper(
-			this.resourceService,
-			(changed, notChanged, dueToConfigurationChange) => this._newValidate(changed, notChanged, dueToConfigurationChange),
-			(resource) => this._shouldIncludeModelInValidation(resource),
-			500
-		);
-
-		this.inplaceReplaceSupport = this._createInPlaceReplaceSupport();
-	}
-
-	protected _createInPlaceReplaceSupport(): Modes.IInplaceReplaceSupport {
-		return new WorkerInplaceReplaceSupport(this.resourceService);
-	}
-
-	_getMode():Modes.IMode {
-		return this._mode;
-	}
-
-	_getWorkerParticipants<T extends Modes.IWorkerParticipant>(select:(p:Modes.IWorkerParticipant)=>boolean):T[] {
-		return <T[]> this._participants.filter(select);
-	}
-
-	// ---- validation -----------------------------------------
-
-	_shouldIncludeModelInValidation(resource:EditorCommon.IMirrorModel): boolean {
-		return resource.getMode().getId() === this._mode.getId();
-	}
-
-	public enableValidator(): TPromise<void> {
-		this._validationHelper.enable();
-		return TPromise.as(null);
-	}
-
-	private _newValidate(changed:URI[], notChanged:URI[], dueToConfigurationChange:boolean): void {
-		this.doValidateOnChange(changed, notChanged, dueToConfigurationChange);
-	}
-
-	public _getContextForValidationParticipants(resource:URI):any {
-		return null;
-	}
-
-	public doValidateOnChange(changed:URI[], notChanged:URI[], dueToConfigurationChange:boolean): void {
-		if (dueToConfigurationChange) {
-			for (var i = 0; i < changed.length; i++) {
-				this.doValidate(changed[i]);
-			}
-			for (var i = 0; i < notChanged.length; i++) {
-				this.doValidate(notChanged[i]);
-			}
-		} else {
-			for (var i = 0; i < changed.length; i++) {
-				this.doValidate(changed[i]);
-			}
-		}
-	}
-
-	public doValidate(resource:URI): void {
-		return null;
-	}
-
-	// ---- suggestion ---------------------------------------------------------------------------------------
-
-	public suggest(resource: URI, position: EditorCommon.IPosition): TPromise<Modes.ISuggestResult[]> {
-
-		return this.doSuggest(resource, position).then(value => {
-
-			if (!value) {
-				return;
-			}
-			// filter suggestions
-			var accept = this.getSuggestionFilter(),
-				result: Modes.ISuggestResult[] = [];
-
-			result.push(<Modes.ISuggestResult>{
-				currentWord: value.currentWord,
-				suggestions: value.suggestions.filter((element) => !!accept(value.currentWord, element)),
-				incomplete: value.incomplete
-			});
-			return result;
-
-		}, (error) => {
-			return <Modes.ISuggestResult[]>[{
-				currentWord: '',
-				suggestions: []
-			}];
-		});
-	}
-
-	public _getSuggestContext(resource:URI):TPromise<any> {
-		return TPromise.as(undefined);
-	}
-
-	public doSuggest(resource:URI, position:EditorCommon.IPosition):TPromise<Modes.ISuggestResult> {
-
-		var model = this.resourceService.get(resource),
-			currentWord = model.getWordUntilPosition(position).word;
-
-		var result:Modes.ISuggestResult = {
-			currentWord: currentWord,
-			suggestions: []
-		};
-
-		result.suggestions.push.apply(result.suggestions, this.suggestWords(resource, position, false));
-		result.suggestions.push.apply(result.suggestions, this.suggestSnippets(resource, position));
-		return TPromise.as(result);
-	}
-
-	public suggestWords(resource:URI, position:EditorCommon.IPosition, mustHaveCurrentWord:boolean):Modes.ISuggestion[] {
-		var modelMirror = this.resourceService.get(resource);
-		var currentWord = modelMirror.getWordUntilPosition(position).word;
-		var allWords = modelMirror.getAllUniqueWords(currentWord);
-
-		if (mustHaveCurrentWord && !currentWord) {
-			return [];
-		}
-
-		return allWords.filter((word) => {
-			return !(/^-?\d*\.?\d/.test(word)); // filter out numbers
-		}).map((word) => {
-			return <Modes.ISuggestion> {
-				type: 'text',
-				label: word,
-				codeSnippet: word,
-				noAutoAccept: true
-			};
-		});
-	}
-
-	public suggestSnippets(resource:URI, position:EditorCommon.IPosition):Modes.ISuggestion[] {
-		return [];
-	}
-
-	public getSuggestionFilter():Modes.ISuggestionFilter {
-		return AbstractModeWorker.filter;
-	}
-
-
-	public configure(options:any): TPromise<boolean> {
-		var p = this._doConfigure(options);
-		if (p) {
-			return p.then(shouldRevalidate => {
-				if (shouldRevalidate) {
-					this._validationHelper.triggerDueToConfigurationChange();
-				}
-				return true;
-			});
-		}
-	}
-
-	/**
-	 * @return true if you want to revalidate your models
-	 */
-	_doConfigure(options:any): TPromise<boolean> {
-		return TPromise.as(true);
-	}
-}
-

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/abstractState.ts
code:
@@ -4,23 +4,23 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Modes = require('vs/editor/common/modes');
+import {IMode, IState, IStream, ITokenizationResult} from 'vs/editor/common/modes';
 
-export class AbstractState implements Modes.IState {
+export class AbstractState implements IState {
 
-	private mode:Modes.IMode;
-	private stateData:Modes.IState;
+	private mode:IMode;
+	private stateData:IState;
 
-	constructor(mode:Modes.IMode, stateData:Modes.IState = null) {
+	constructor(mode:IMode, stateData:IState = null) {
 		this.mode = mode;
 		this.stateData = stateData;
 	}
 
-	public getMode():Modes.IMode {
+	public getMode():IMode {
 		return this.mode;
 	}
 
-	public clone():Modes.IState {
+	public clone():IState {
 		var result:AbstractState = this.makeClone();
 		result.initializeFrom(this);
 		return result;
@@ -34,15 +34,15 @@ export class AbstractState implements Modes.IState {
 		this.stateData = other.stateData !== null ? other.stateData.clone() : null;
 	}
 
-	public getStateData(): Modes.IState {
+	public getStateData(): IState {
 		return this.stateData;
 	}
 
-	public setStateData(state:Modes.IState):void {
+	public setStateData(state:IState):void {
 		this.stateData = state;
 	}
 
-	public equals(other:Modes.IState):boolean {
+	public equals(other:IState):boolean {
 		if (other === null || this.mode !== other.getMode()) {
 			return false;
 		}
@@ -52,11 +52,11 @@ export class AbstractState implements Modes.IState {
 		return false;
 	}
 
-	public tokenize(stream:Modes.IStream):Modes.ITokenizationResult {
+	public tokenize(stream:IStream):ITokenizationResult {
 		throw new Error('Abstract Method');
 	}
 
-	public static safeEquals(a: Modes.IState, b: Modes.IState): boolean {
+	public static safeEquals(a: IState, b: IState): boolean {
 		if (a === null && b === null) {
 			return true;
 		}
@@ -66,7 +66,7 @@ export class AbstractState implements Modes.IState {
 		return a.equals(b);
 	}
 
-	public static safeClone(state: Modes.IState): Modes.IState {
+	public static safeClone(state: IState): IState {
 		if (state) {
 			return state.clone();
 		}

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/languageFeatureRegistry.ts
code:
@@ -5,9 +5,9 @@
 
 'use strict';
 
+import {binarySearch} from 'vs/base/common/arrays';
 import Event, {Emitter} from 'vs/base/common/event';
 import {IDisposable} from 'vs/base/common/lifecycle';
-import {binarySearch} from 'vs/base/common/arrays';
 import {IModel} from 'vs/editor/common/editorCommon';
 import {LanguageSelector, score} from 'vs/editor/common/modes/languageSelector';
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/languageSelector.ts
code:
@@ -6,7 +6,7 @@
 'use strict';
 
 import URI from 'vs/base/common/uri';
-import {match as matchGlobPattern} from 'vs/base/common/glob';
+import {match as matchGlobPattern} from 'vs/base/common/glob'; // TODO@Alex
 
 export interface LanguageFilter {
 	language?: string;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/linkComputer.ts
code:
@@ -29,7 +29,7 @@ enum CharacterClass {
 }
 
 var getCharacterClasses = (function() {
-	var FORCE_TERMINATION_CHARACTERS = ' \t<>)]}\'\"';
+	var FORCE_TERMINATION_CHARACTERS = ' \t<>\'\"';
 	var CANNOT_END_WITH_CHARACTERS = '.,;';
 	var _cachedResult: CharacterClass[] = null;
 
@@ -70,6 +70,13 @@ var getCharacterClasses = (function() {
 	};
 })();
 
+let _openParens = '('.charCodeAt(0);
+let _closeParens = ')'.charCodeAt(0);
+let _openSquareBracket = '['.charCodeAt(0);
+let _closeSquareBracket = ']'.charCodeAt(0);
+let _openCurlyBracket = '{'.charCodeAt(0);
+let _closeCurlyBracket = '}'.charCodeAt(0);
+
 class LinkComputer {
 
 	private static _createLink(line:string, lineNumber:number, linkBeginIndex:number, linkEndIndex:number):ILink {
@@ -101,22 +108,53 @@ class LinkComputer {
 			ch:string,
 			chCode:number,
 			chClass:CharacterClass,
-			resetStateMachine:boolean;
+			resetStateMachine:boolean,
+			hasOpenParens:boolean,
+			hasOpenSquareBracket:boolean,
+			hasOpenCurlyBracket:boolean;
 
 		for (i = 1, lineCount = model.getLineCount(); i <= lineCount; i++) {
 			line = model.getLineContent(i);
 			j = 0;
 			len = line.length;
 			linkBeginIndex = 0;
 			state = START_STATE;
+			hasOpenParens = false;
+			hasOpenSquareBracket = false;
+			hasOpenCurlyBracket = false;
 
 			while (j < len) {
 				ch = line.charAt(j);
 				chCode = line.charCodeAt(j);
 				resetStateMachine = false;
 
 				if (state === ACCEPT_STATE) {
-					chClass = (chCode < characterClassesLength ? characterClasses[chCode] : CharacterClass.None);
+
+					switch (chCode) {
+						case _openParens:
+							hasOpenParens = true;
+							chClass = CharacterClass.None;
+							break;
+						case _closeParens:
+							chClass = (hasOpenParens ? CharacterClass.None : CharacterClass.ForceTermination);
+							break;
+						case _openSquareBracket:
+							hasOpenSquareBracket = true;
+							chClass = CharacterClass.None;
+							break;
+						case _closeSquareBracket:
+							chClass = (hasOpenSquareBracket ? CharacterClass.None : CharacterClass.ForceTermination);
+							break;
+						case _openCurlyBracket:
+							hasOpenCurlyBracket = true;
+							chClass = CharacterClass.None;
+							break;
+						case _closeCurlyBracket:
+							chClass = (hasOpenCurlyBracket ? CharacterClass.None : CharacterClass.ForceTermination);
+							break;
+						default:
+							chClass = (chCode < characterClassesLength ? characterClasses[chCode] : CharacterClass.None);
+					}
 
 					// Check if character terminates link
 					if (chClass === CharacterClass.ForceTermination) {
@@ -154,6 +192,9 @@ class LinkComputer {
 
 				if (resetStateMachine) {
 					state = START_STATE;
+					hasOpenParens = false;
+					hasOpenSquareBracket = false;
+					hasOpenCurlyBracket = false;
 
 					// Record where the link started
 					linkBeginIndex = j + 1;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/modesFilters.ts
code:
@@ -4,23 +4,23 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {ISuggestionFilter, ISuggestion} from 'vs/editor/common/modes';
-import * as Filters from 'vs/base/common/filters';
 import {isFalsyOrEmpty} from 'vs/base/common/arrays';
+import * as filters from 'vs/base/common/filters';
+import {ISuggestion, ISuggestionFilter} from 'vs/editor/common/modes';
 
-export type IMatch = Filters.IMatch;
+export type IMatch = filters.IMatch;
 
-function wrapBaseFilter(filter: Filters.IFilter): ISuggestionFilter {
-	return (word: string, suggestion: ISuggestion): Filters.IMatch[] => {
+function wrapBaseFilter(filter: filters.IFilter): ISuggestionFilter {
+	return (word: string, suggestion: ISuggestion): filters.IMatch[] => {
 		const result = filter(word, suggestion.filterText || suggestion.label);
 		return isFalsyOrEmpty(result) ? undefined : result;
 	};
 }
 
-export var StrictPrefix: ISuggestionFilter = wrapBaseFilter(Filters.matchesStrictPrefix);
-export var Prefix: ISuggestionFilter = wrapBaseFilter(Filters.matchesPrefix);
-export var CamelCase: ISuggestionFilter = wrapBaseFilter(Filters.matchesCamelCase);
-export var ContiguousSubString: ISuggestionFilter = wrapBaseFilter(Filters.matchesContiguousSubString);
+export var StrictPrefix: ISuggestionFilter = wrapBaseFilter(filters.matchesStrictPrefix);
+export var Prefix: ISuggestionFilter = wrapBaseFilter(filters.matchesPrefix);
+export var CamelCase: ISuggestionFilter = wrapBaseFilter(filters.matchesCamelCase);
+export var ContiguousSubString: ISuggestionFilter = wrapBaseFilter(filters.matchesContiguousSubString);
 
 // Combined Filters
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/modesRegistry.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Modes = require('vs/editor/common/modes');
+import Event, {Emitter} from 'vs/base/common/event';
 import {Registry} from 'vs/platform/platform';
+import {IWorkerParticipantDescriptor} from 'vs/editor/common/modes';
 import {ILanguageExtensionPoint} from 'vs/editor/common/services/modeService';
-import Event, {Emitter} from 'vs/base/common/event';
 
 export interface ILegacyLanguageDefinition {
 	id: string;
@@ -27,7 +27,7 @@ export var Extensions = {
 
 export class EditorModesRegistry {
 
-	private _workerParticipants: Modes.IWorkerParticipantDescriptor[];
+	private _workerParticipants: IWorkerParticipantDescriptor[];
 	private _compatModes: ILegacyLanguageDefinition[];
 	private _languages: ILanguageExtensionPoint[];
 
@@ -45,7 +45,7 @@ export class EditorModesRegistry {
 
 	// --- worker participants
 
-	public registerWorkerParticipants(participants:Modes.IWorkerParticipantDescriptor[]): void {
+	public registerWorkerParticipants(participants:IWorkerParticipantDescriptor[]): void {
 		this._workerParticipants = participants;
 	}
 	public registerWorkerParticipant(modeId:string, moduleId:string, ctorName?:string):void {
@@ -55,10 +55,10 @@ export class EditorModesRegistry {
 			ctorName: ctorName
 		});
 	}
-	public getWorkerParticipantsForMode(modeId:string):Modes.IWorkerParticipantDescriptor[] {
+	public getWorkerParticipantsForMode(modeId:string):IWorkerParticipantDescriptor[] {
 		return this._workerParticipants.filter(p => p.modeId === modeId);
 	}
-	public getWorkerParticipants(): Modes.IWorkerParticipantDescriptor[] {
+	public getWorkerParticipants(): IWorkerParticipantDescriptor[] {
 		return this._workerParticipants;
 	}
 
@@ -94,3 +94,10 @@ export class EditorModesRegistry {
 
 export var ModesRegistry = new EditorModesRegistry();
 Registry.add(Extensions.ModesRegistry, ModesRegistry);
+
+ModesRegistry.registerLanguage({
+	id: 'plaintext',
+	extensions: ['.txt', '.gitignore'],
+	aliases: ['Plain Text', 'text'],
+	mimetypes: ['text/plain']
+});

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarch.ts
code:
@@ -9,43 +9,38 @@
  * using regular expressions.
  */
 
+import {IRichEditSupport, ISuggestSupport, ITokenizationSupport} from 'vs/editor/common/modes';
 import {AbstractMode} from 'vs/editor/common/modes/abstractMode';
-import {AbstractModeWorker} from 'vs/editor/common/modes/abstractModeWorker';
 import {ILexer} from 'vs/editor/common/modes/monarch/monarchCommon';
-import Modes = require('vs/editor/common/modes');
-import MonarchDefinition = require('vs/editor/common/modes/monarch/monarchDefinition');
+import {createRichEditSupport, createSuggestSupport} from 'vs/editor/common/modes/monarch/monarchDefinition';
 import {createTokenizationSupport} from 'vs/editor/common/modes/monarch/monarchLexer';
-import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IThreadService} from 'vs/platform/thread/common/thread';
-import {IModeService} from 'vs/editor/common/services/modeService';
-import {IModelService} from 'vs/editor/common/services/modelService';
 import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
+import {IModeService} from 'vs/editor/common/services/modeService';
+import {IModelService} from 'vs/editor/common/services/modelService';
 
 /**
  * The MonarchMode creates a Monaco language mode given a certain language description
  */
-export class MonarchMode<W extends AbstractModeWorker> extends AbstractMode<W> {
+export abstract class MonarchMode extends AbstractMode {
 
-	public suggestSupport:Modes.ISuggestSupport;
-	public tokenizationSupport: Modes.ITokenizationSupport;
-	public richEditSupport: Modes.IRichEditSupport;
+	public suggestSupport:ISuggestSupport;
+	public tokenizationSupport: ITokenizationSupport;
+	public richEditSupport: IRichEditSupport;
 
 	constructor(
-		descriptor:Modes.IModeDescriptor,
+		modeId:string,
 		lexer: ILexer,
-		instantiationService: IInstantiationService,
-		threadService: IThreadService,
 		modeService: IModeService,
 		modelService: IModelService,
 		editorWorkerService: IEditorWorkerService
 	) {
-		super(descriptor, instantiationService, threadService);
+		super(modeId);
 
 		this.tokenizationSupport = createTokenizationSupport(modeService, this, lexer);
 
-		this.richEditSupport = new RichEditSupport(this.getId(), MonarchDefinition.createRichEditSupport(lexer));
+		this.richEditSupport = new RichEditSupport(this.getId(), null, createRichEditSupport(lexer));
 
-		this.suggestSupport = MonarchDefinition.createSuggestSupport(modelService, editorWorkerService, this.getId(), lexer);
+		this.suggestSupport = createSuggestSupport(modelService, editorWorkerService, this.getId(), lexer);
 	}
 }

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchCommon.ts
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import Modes = require('vs/editor/common/modes');
+import {CharacterPair, Bracket, IAutoClosingPairConditional, ISuggestion} from 'vs/editor/common/modes';
 
 /*
  * This module exports common types and functionality shared between
@@ -39,16 +39,16 @@ export interface ILexer extends ILexerMin {
 		textualCompletions: boolean;
 		disableAutoTrigger: boolean;
 		triggerCharacters: string[];
-		snippets: Modes.ISuggestion[];
+		snippets: ISuggestion[];
 	};
 
 	tokenizer: IRule[][];
 	brackets: IBracket[];
 	wordDefinition: RegExp;
-	autoClosingPairs: Modes.IAutoClosingPairConditional[];
+	autoClosingPairs: IAutoClosingPairConditional[];
 
-	standardBrackets: Modes.IBracketPair[];
-	// enhancedBrackets: Modes.IRegexBracketPair[];
+	standardBrackets: CharacterPair[];
+	// enhancedBrackets: IRegexBracketPair[];
 	outdentTriggers: string;
 }
 
@@ -88,7 +88,7 @@ export interface IAction {
 	tokenSubst?: boolean;
 	next?: string;
 	nextEmbedded?: string;
-	bracket?: Modes.Bracket;
+	bracket?: Bracket;
 	log?: string;
 	switchTo?: string;
 	goBack?: number;

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchCompile.ts
code:
@@ -9,10 +9,10 @@
  * into a typed and checked ILexer definition.
  */
 
-import MonarchTypes = require('vs/editor/common/modes/monarch/monarchTypes');
-import MonarchCommonTypes = require('vs/editor/common/modes/monarch/monarchCommon');
-import Modes = require('vs/editor/common/modes');
-import Objects = require('vs/base/common/objects');
+import * as objects from 'vs/base/common/objects';
+import {Bracket, IAutoClosingPairConditional, CharacterPair} from 'vs/editor/common/modes';
+import * as monarchCommon from 'vs/editor/common/modes/monarch/monarchCommon';
+import {ILanguage, ILanguageBracket} from 'vs/editor/common/modes/monarch/monarchTypes';
 
 /*
  * Type helpers
@@ -68,7 +68,7 @@ function string(prop: any, def?: string, onerr?: () => void ): string {
  * Compiles a regular expression string, adding the 'i' flag if 'ignoreCase' is set.
  * Also replaces @\w+ or sequences with the content of the specified attribute
  */
-function compileRegExp(lexer: MonarchCommonTypes.ILexerMin, str: string): RegExp {
+function compileRegExp(lexer: monarchCommon.ILexerMin, str: string): RegExp {
 	if (typeof (str) !== 'string') {
 		return null;
 	}
@@ -84,12 +84,12 @@ function compileRegExp(lexer: MonarchCommonTypes.ILexerMin, str: string): RegExp
 				sub = lexer[attr].source;
 			} else {
 				if (lexer[attr] === undefined) {
-					MonarchCommonTypes.throwError(lexer, 'language definition does not contain attribute \'' + attr + '\', used at: ' + str);
+					monarchCommon.throwError(lexer, 'language definition does not contain attribute \'' + attr + '\', used at: ' + str);
 				} else {
-					MonarchCommonTypes.throwError(lexer, 'attribute reference \'' + attr + '\' must be a string, used at: ' + str);
+					monarchCommon.throwError(lexer, 'attribute reference \'' + attr + '\' must be a string, used at: ' + str);
 				}
 			}
-			return (MonarchCommonTypes.empty(sub) ? '' : '(?:' + sub + ')');
+			return (monarchCommon.empty(sub) ? '' : '(?:' + sub + ')');
 		});
 	}
 
@@ -119,7 +119,7 @@ function selectScrutinee(id: string, matches: string[], state: string, num: numb
 	return null;
 }
 
-function createGuard(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, tkey: string, val: MonarchCommonTypes.IAction): MonarchCommonTypes.IBranch {
+function createGuard(lexer: monarchCommon.ILexerMin, ruleName: string, tkey: string, val: monarchCommon.IAction): monarchCommon.IBranch {
 	// get the scrutinee and pattern
 	var scrut = -1; // -1: $!, 0-99: $n, 100+n: $Sn
 	var oppat = tkey;
@@ -156,18 +156,18 @@ function createGuard(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, tkey
 
 	// special case a regexp that matches just words
 	if ((op === '~' || op === '!~') && /^(\w|\|)*$/.test(pat)) {
-		var inWords = Objects.createKeywordMatcher(pat.split('|'), lexer.ignoreCase);
+		var inWords = objects.createKeywordMatcher(pat.split('|'), lexer.ignoreCase);
 		tester = function(s) { return (op === '~' ? inWords(s) : !inWords(s)); };
 	}
 	else if (op === '@' || op === '!@') {
 		var words = lexer[pat];
 		if (!words) {
-			MonarchCommonTypes.throwError(lexer, 'the @ match target \'' + pat + '\' is not defined, in rule: ' + ruleName);
+			monarchCommon.throwError(lexer, 'the @ match target \'' + pat + '\' is not defined, in rule: ' + ruleName);
 		}
 		if (!(isArrayOf(function(elem) { return (typeof (elem) === 'string'); }, words))) {
-			MonarchCommonTypes.throwError(lexer, 'the @ match target \'' + pat + '\' must be an array of strings, in rule: ' + ruleName);
+			monarchCommon.throwError(lexer, 'the @ match target \'' + pat + '\' must be an array of strings, in rule: ' + ruleName);
 		}
-		var inWords = Objects.createKeywordMatcher(words, lexer.ignoreCase);
+		var inWords = objects.createKeywordMatcher(words, lexer.ignoreCase);
 		tester = function(s) { return (op === '@' ? inWords(s) : !inWords(s)); };
 	}
 	else if (op === '~' || op === '!~') {
@@ -178,20 +178,20 @@ function createGuard(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, tkey
 		}
 		else {
 			tester = function(s, id, matches, state) {
-				var re = compileRegExp(lexer, '^' + MonarchCommonTypes.substituteMatches(lexer, pat, id, matches, state) + '$');
+				var re = compileRegExp(lexer, '^' + monarchCommon.substituteMatches(lexer, pat, id, matches, state) + '$');
 				return re.test(s);
 			};
 		}
 	}
 	else { // if (op==='==' || op==='!=') {
 		if (pat.indexOf('$') < 0) {
-			var patx = MonarchCommonTypes.fixCase(lexer, pat);
+			var patx = monarchCommon.fixCase(lexer, pat);
 			tester = function(s) { return (op === '==' ? s === patx : s !== patx); };
 		}
 		else {
-			var patx = MonarchCommonTypes.fixCase(lexer, pat);
+			var patx = monarchCommon.fixCase(lexer, pat);
 			tester = function(s, id, matches, state, eos) {
-				var patexp = MonarchCommonTypes.substituteMatches(lexer, patx, id, matches, state);
+				var patexp = monarchCommon.substituteMatches(lexer, patx, id, matches, state);
 				return (op === '==' ? s === patexp : s !== patexp);
 			};
 		}
@@ -223,7 +223,7 @@ function createGuard(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, tkey
  * contains user functions as actions (which is usually not allowed), then this
  * may be called during lexing. It is important therefore to compile common cases efficiently
  */
-function compileAction(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, action: any): MonarchCommonTypes.IAction {
+function compileAction(lexer: monarchCommon.ILexerMin, ruleName: string, action: any): monarchCommon.IAction {
 	if (!action) {
 		return { token: '' };
 	}
@@ -232,27 +232,27 @@ function compileAction(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, ac
 	}
 	else if (action.token || action.token === '') {
 		if (typeof (action.token) !== 'string') {
-			MonarchCommonTypes.throwError(lexer, 'a \'token\' attribute must be of type string, in rule: ' + ruleName);
+			monarchCommon.throwError(lexer, 'a \'token\' attribute must be of type string, in rule: ' + ruleName);
 			return { token: '' };
 		}
 		else {
 			// only copy specific typed fields (only happens once during compile Lexer)
-			var newAction: MonarchCommonTypes.IAction = { token: action.token };
+			var newAction: monarchCommon.IAction = { token: action.token };
 			if (action.token.indexOf('$') >= 0) {
 				newAction.tokenSubst = true;
 			}
 			if (typeof (action.bracket) === 'string') {
 				if (action.bracket === '@open') {
-					newAction.bracket = Modes.Bracket.Open;
+					newAction.bracket = Bracket.Open;
 				} else if (action.bracket === '@close') {
-					newAction.bracket = Modes.Bracket.Close;
+					newAction.bracket = Bracket.Close;
 				} else {
-					MonarchCommonTypes.throwError(lexer, 'a \'bracket\' attribute must be either \'@open\' or \'@close\', in rule: ' + ruleName);
+					monarchCommon.throwError(lexer, 'a \'bracket\' attribute must be either \'@open\' or \'@close\', in rule: ' + ruleName);
 				}
 			}
 			if (action.next) {
 				if (typeof (action.next) !== 'string') {
-					MonarchCommonTypes.throwError(lexer, 'the next state must be a string value in rule: ' + ruleName);
+					monarchCommon.throwError(lexer, 'the next state must be a string value in rule: ' + ruleName);
 				}
 				else {
 					var next: string = action.next;
@@ -261,8 +261,8 @@ function compileAction(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, ac
 							next = next.substr(1); // peel off starting @ sign
 						}
 						if (next.indexOf('$') < 0) {  // no dollar substitution, we can check if the state exists
-							if (!MonarchCommonTypes.stateExists(lexer, MonarchCommonTypes.substituteMatches(lexer, next, '', [], ''))) {
-								MonarchCommonTypes.throwError(lexer, 'the next state \'' + action.next + '\' is not defined in rule: ' + ruleName);
+							if (!monarchCommon.stateExists(lexer, monarchCommon.substituteMatches(lexer, next, '', [], ''))) {
+								monarchCommon.throwError(lexer, 'the next state \'' + action.next + '\' is not defined in rule: ' + ruleName);
 							}
 						}
 					}
@@ -297,7 +297,7 @@ function compileAction(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, ac
 	}
 	else if (action.cases) {
 		// build an array of test cases
-		var cases: MonarchCommonTypes.IBranch[] = [];
+		var cases: monarchCommon.IBranch[] = [];
 
 		// for each case, push a test function and result value
 		var tkey: string;
@@ -336,27 +336,27 @@ function compileAction(lexer: MonarchCommonTypes.ILexerMin, ruleName: string, ac
 		};
 	}
 	else {
-		MonarchCommonTypes.throwError(lexer, 'an action must be a string, an object with a \'token\' or \'cases\' attribute, or an array of actions; in rule: ' + ruleName);
+		monarchCommon.throwError(lexer, 'an action must be a string, an object with a \'token\' or \'cases\' attribute, or an array of actions; in rule: ' + ruleName);
 		return '';
 	}
 }
 
 /**
  * Helper class for creating matching rules
  */
-class Rule implements MonarchCommonTypes.IRule {
+class Rule implements monarchCommon.IRule {
 	public regex: RegExp = new RegExp('');
-	public action: MonarchCommonTypes.IAction = { token: '' };
+	public action: monarchCommon.IAction = { token: '' };
 	public matchOnlyAtLineStart: boolean = false;
 	public name: string = '';
 
 	constructor(name: string) {
 		this.name = name;
 	}
 
-	public setRegex(lexer: MonarchCommonTypes.ILexerMin, re: string);
-	public setRegex(lexer: MonarchCommonTypes.ILexerMin, re: RegExp);
-	public setRegex(lexer: MonarchCommonTypes.ILexerMin, re: any) {
+	public setRegex(lexer: monarchCommon.ILexerMin, re: string);
+	public setRegex(lexer: monarchCommon.ILexerMin, re: RegExp);
+	public setRegex(lexer: monarchCommon.ILexerMin, re: any) {
 		var sregex: string;
 		if (typeof (re) === 'string') {
 			sregex = re;
@@ -365,15 +365,15 @@ class Rule implements MonarchCommonTypes.IRule {
 			sregex = (<RegExp>re).source;
 		}
 		else {
-			MonarchCommonTypes.throwError(lexer, 'rules must start with a match string or regular expression: ' + this.name);
+			monarchCommon.throwError(lexer, 'rules must start with a match string or regular expression: ' + this.name);
 		}
 
 		this.matchOnlyAtLineStart = (sregex.length > 0 && sregex[0] === '^');
 		this.name = this.name + ': ' + sregex;
 		this.regex = compileRegExp(lexer, '^(?:' + (this.matchOnlyAtLineStart ? sregex.substr(1) : sregex) + ')');
 	}
 
-	public setAction(lexer: MonarchCommonTypes.ILexerMin, act: MonarchCommonTypes.IAction) {
+	public setAction(lexer: monarchCommon.ILexerMin, act: monarchCommon.IAction) {
 		this.action = compileAction(lexer, this.name, act);
 	}
 }
@@ -387,7 +387,7 @@ class Rule implements MonarchCommonTypes.IRule {
  * (Currently we have no samples that need this so perhaps we should always have
  * jsonStrict to true).
  */
-export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer {
+export function compile(json: ILanguage): monarchCommon.ILexer {
 	if (!json || typeof (json) !== 'object') {
 		throw new Error('Monarch: expecting a language definition object');
 	}
@@ -398,7 +398,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	}
 
 	// Create our lexer
-	var lexer: MonarchCommonTypes.ILexer = <MonarchCommonTypes.ILexer>{};
+	var lexer: monarchCommon.ILexer = <monarchCommon.ILexer>{};
 	lexer.name = json.name;
 	lexer.displayName = string(json.displayName, lexer.name);
 	lexer.noThrow = false; // raise exceptions during compilation
@@ -412,7 +412,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	lexer.blockCommentStart = string(json.blockCommentStart, '/*');
 	lexer.blockCommentEnd = string(json.blockCommentEnd, '*/');
 	lexer.tokenPostfix = string(json.tokenPostfix, '.' + lexer.name);
-	lexer.defaultToken = string(json.defaultToken, 'source', function () { MonarchCommonTypes.throwError(lexer, 'the \'defaultToken\' must be a string'); });
+	lexer.defaultToken = string(json.defaultToken, 'source', function () { monarchCommon.throwError(lexer, 'the \'defaultToken\' must be a string'); });
 
 	lexer.usesEmbedded = false; // becomes true if we find a nextEmbedded action
 	lexer.wordDefinition = json.wordDefinition || undefined;
@@ -465,7 +465,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	}
 
 	// For calling compileAction later on
-	var lexerMin: MonarchCommonTypes.ILexerMin = <any>json;
+	var lexerMin: monarchCommon.ILexerMin = <any>json;
 	lexerMin.name = lexer.name;
 	lexerMin.displayName = lexer.displayName;
 	lexerMin.ignoreCase = lexer.ignoreCase;
@@ -476,21 +476,21 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 
 
 	// Compile an array of rules into newrules where RegExp objects are created.
-	function addRules(state: string, newrules: MonarchCommonTypes.IRule[], rules: any[]) {
+	function addRules(state: string, newrules: monarchCommon.IRule[], rules: any[]) {
 		var idx: string;
 		for (idx in rules) {
 			if (rules.hasOwnProperty(idx)) {
 				var rule = rules[idx];
 				var include = rule.include;
 				if (include) {
 					if (typeof (include) !== 'string') {
-						MonarchCommonTypes.throwError(lexer, 'an \'include\' attribute must be a string at: ' + state);
+						monarchCommon.throwError(lexer, 'an \'include\' attribute must be a string at: ' + state);
 					}
 					if (include[0] === '@') {
 						include = include.substr(1); // peel off starting @
 					}
 					if (!json.tokenizer[include]) {
-						MonarchCommonTypes.throwError(lexer, 'include target \'' + include + '\' is not defined at: ' + state);
+						monarchCommon.throwError(lexer, 'include target \'' + include + '\' is not defined at: ' + state);
 					}
 					addRules(state + '.' + include, newrules, json.tokenizer[include]);
 				}
@@ -511,7 +511,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 								newrule.setAction(lexerMin, rule1);
 							}
 							else {
-								MonarchCommonTypes.throwError(lexer, 'a next state as the last element of a rule can only be given if the action is either an object or a string, at: ' + state);
+								monarchCommon.throwError(lexer, 'a next state as the last element of a rule can only be given if the action is either an object or a string, at: ' + state);
 							}
 						}
 						else {
@@ -520,7 +520,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 					}
 					else {
 						if (!rule.regex) {
-							MonarchCommonTypes.throwError(lexer, 'a rule must either be an array, or an object with a \'regex\' or \'include\' field at: ' + state);
+							monarchCommon.throwError(lexer, 'a rule must either be an array, or an object with a \'regex\' or \'include\' field at: ' + state);
 						}
 						if (rule.name) {
 							newrule.name = string(rule.name);
@@ -540,7 +540,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 
 	// compile the tokenizer rules
 	if (!json.tokenizer || typeof (json.tokenizer) !== 'object') {
-		MonarchCommonTypes.throwError(lexer, 'a language definition must define the \'tokenizer\' attribute as an object');
+		monarchCommon.throwError(lexer, 'a language definition must define the \'tokenizer\' attribute as an object');
 	}
 
 	lexer.tokenizer = [];
@@ -561,7 +561,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	// Set simple brackets
 	if (json.brackets) {
 		if (!(Array.isArray(<any>json.brackets))) {
-			MonarchCommonTypes.throwError(lexer, 'the \'brackets\' attribute must be defined as an array');
+			monarchCommon.throwError(lexer, 'the \'brackets\' attribute must be defined as an array');
 		}
 	}
 	else {
@@ -571,26 +571,26 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 			{ open: '(', close: ')', token: 'delimiter.parenthesis' },
 			{ open: '<', close: '>', token: 'delimiter.angle' }];
 	}
-	var brackets : MonarchTypes.ILanguageBracket[] = [];
+	var brackets : ILanguageBracket[] = [];
 	for (var bracketIdx in json.brackets) {
 		if (json.brackets.hasOwnProperty(bracketIdx)) {
 			var desc = <any> json.brackets[bracketIdx];
 			if (desc && Array.isArray(desc) && desc.length === 3) {
 				desc = { token: desc[2], open: desc[0], close: desc[1] };
 			}
 			if (desc.open === desc.close) {
-				MonarchCommonTypes.throwError(lexer, 'open and close brackets in a \'brackets\' attribute must be different: ' + desc.open +
+				monarchCommon.throwError(lexer, 'open and close brackets in a \'brackets\' attribute must be different: ' + desc.open +
 					'\n hint: use the \'bracket\' attribute if matching on equal brackets is required.');
 			}
 			if (typeof (desc.open) === 'string' && typeof (desc.token) === 'string') {
 				brackets.push({
 					token: string(desc.token) + lexer.tokenPostfix
-					, open: MonarchCommonTypes.fixCase(lexer, string(desc.open))
-					, close: MonarchCommonTypes.fixCase(lexer, string(desc.close))
+					, open: monarchCommon.fixCase(lexer, string(desc.open))
+					, close: monarchCommon.fixCase(lexer, string(desc.close))
 				});
 			}
 			else {
-				MonarchCommonTypes.throwError(lexer, 'every element in the \'brackets\' array must be a \'{open,close,token}\' object or array');
+				monarchCommon.throwError(lexer, 'every element in the \'brackets\' array must be a \'{open,close,token}\' object or array');
 			}
 		}
 	}
@@ -600,7 +600,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	var autoClosingPairs: any/*string[][]*/;
 	if (json.autoClosingPairs) {
 		if (!(Array.isArray(<any>json.autoClosingPairs))) {
-			MonarchCommonTypes.throwError(lexer, 'the \'autoClosingPairs\' attribute must be an array of string pairs (as arrays)');
+			monarchCommon.throwError(lexer, 'the \'autoClosingPairs\' attribute must be an array of string pairs (as arrays)');
 		}
 		autoClosingPairs = json.autoClosingPairs.slice(0);
 	}
@@ -614,7 +614,7 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 		for (var autoClosingPairIdx in autoClosingPairs) {
 			if (autoClosingPairs.hasOwnProperty(autoClosingPairIdx)) {
 				var pair = autoClosingPairs[autoClosingPairIdx];
-				var openClose: Modes.IAutoClosingPairConditional;
+				var openClose: IAutoClosingPairConditional;
 				if (pair === '@brackets' || pair[0] === '@brackets') {
 					var bidx: string;
 					for (bidx in brackets) {
@@ -630,52 +630,52 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 				else if (Array.isArray(pair) && pair.length === 2 &&
 					typeof (pair[0]) === 'string' && pair[0].length === 1 &&
 					typeof (pair[1]) === 'string' && pair[1].length === 1) {
-					openClose = { open: MonarchCommonTypes.fixCase(lexer, pair[0]), close: MonarchCommonTypes.fixCase(lexer, pair[1]), notIn:['string', 'comment'] };
+					openClose = { open: monarchCommon.fixCase(lexer, pair[0]), close: monarchCommon.fixCase(lexer, pair[1]), notIn:['string', 'comment'] };
 					lexer.autoClosingPairs.push(openClose);
 				}
 				else if (typeof (pair.open) === 'string' && pair.open.length === 1 &&
 					typeof (pair.close) === 'string' && pair.close.length === 1) {
-					openClose = { open: MonarchCommonTypes.fixCase(lexer, pair.open[0]), close: MonarchCommonTypes.fixCase(lexer, pair.close[0]), notIn:['string', 'comment'] };
+					openClose = { open: monarchCommon.fixCase(lexer, pair.open[0]), close: monarchCommon.fixCase(lexer, pair.close[0]), notIn:['string', 'comment'] };
 					lexer.autoClosingPairs.push(openClose);
 				}
 				else {
-					MonarchCommonTypes.throwError(lexer, 'every element in an \'autoClosingPairs\' array must be a pair of 1 character strings, or a \'@brackets\' directive');
+					monarchCommon.throwError(lexer, 'every element in an \'autoClosingPairs\' array must be a pair of 1 character strings, or a \'@brackets\' directive');
 				}
 			}
 		}
 	}
 
 	// Set enhanced brackets
-	// var enhancedBrackets : Modes.IRegexBracketPair[] = [];
+	// var enhancedBrackets : IRegexBracketPair[] = [];
 	// if (json.enhancedBrackets) {
 	// 	if (!(Array.isArray(<any>json.enhancedBrackets))) {
-	// 		MonarchCommonTypes.throwError(lexer, 'the \'enhancedBrackets\' attribute must be defined as an array');
+	// 		monarchCommon.throwError(lexer, 'the \'enhancedBrackets\' attribute must be defined as an array');
 	// 	}
 
 	// 	for (var bracketIdx in json.enhancedBrackets) {
 	// 		if (json.enhancedBrackets.hasOwnProperty(bracketIdx)) {
 	// 			var desc = <any> json.enhancedBrackets[bracketIdx];
 	// 			if (desc.hasOwnProperty('openTrigger') && typeof (desc.openTrigger) !== 'string') {
-	// 				MonarchCommonTypes.throwError(lexer, 'openTrigger in the \'enhancedBrackets\' array must be a string');
+	// 				monarchCommon.throwError(lexer, 'openTrigger in the \'enhancedBrackets\' array must be a string');
 	// 			}
 	// 			if (desc.hasOwnProperty('open') && !(desc.open instanceof RegExp)) {
-	// 				MonarchCommonTypes.throwError(lexer, 'open in the \'enhancedBrackets\' array must be a regex');
+	// 				monarchCommon.throwError(lexer, 'open in the \'enhancedBrackets\' array must be a regex');
 	// 			}
 	// 			if (desc.hasOwnProperty('closeComplete') && typeof (desc.closeComplete) !== 'string') {
-	// 				MonarchCommonTypes.throwError(lexer, 'closeComplete in the \'enhancedBrackets\' array must be a string');
+	// 				monarchCommon.throwError(lexer, 'closeComplete in the \'enhancedBrackets\' array must be a string');
 	// 			}
 	// 			if (desc.hasOwnProperty('matchCase') && typeof (desc.matchCase) !== 'boolean') {
-	// 				MonarchCommonTypes.throwError(lexer, 'matchCase in the \'enhancedBrackets\' array must be a boolean');
+	// 				monarchCommon.throwError(lexer, 'matchCase in the \'enhancedBrackets\' array must be a boolean');
 	// 			}
 	// 			if (desc.hasOwnProperty('closeTrigger') && typeof (desc.closeTrigger) !== 'string') {
-	// 				MonarchCommonTypes.throwError(lexer, 'closeTrigger in the \'enhancedBrackets\' array must be a string');
+	// 				monarchCommon.throwError(lexer, 'closeTrigger in the \'enhancedBrackets\' array must be a string');
 	// 			}
 	// 			if (desc.hasOwnProperty('close') && !(desc.close instanceof RegExp)) {
-	// 				MonarchCommonTypes.throwError(lexer, 'close in the \'enhancedBrackets\' array must be a regex');
+	// 				monarchCommon.throwError(lexer, 'close in the \'enhancedBrackets\' array must be a regex');
 	// 			}
 	// 			if (desc.hasOwnProperty('tokenType')) {
 	// 				if (typeof (desc.tokenType) !== 'string') {
-	// 					MonarchCommonTypes.throwError(lexer, 'tokenType in the \'enhancedBrackets\' array must be a string');
+	// 					monarchCommon.throwError(lexer, 'tokenType in the \'enhancedBrackets\' array must be a string');
 	// 				}
 	// 				else {
 	// 					desc.tokenType += lexer.tokenPostfix;
@@ -687,14 +687,9 @@ export function compile(json: MonarchTypes.ILanguage): MonarchCommonTypes.ILexer
 	// }
 	// lexer.enhancedBrackets = enhancedBrackets;
 
-	var standardBrackets: Modes.IBracketPair[] = [];
+	var standardBrackets: CharacterPair[] = [];
 	for (var i = 0; i < brackets.length; ++i) {
-		standardBrackets.push({
-			tokenType: brackets[i].token,
-			open: brackets[i].open,
-			close:brackets[i].close,
-			isElectric: true
-		});
+		standardBrackets.push([brackets[i].open, brackets[i].close]);
 	}
 	lexer.standardBrackets = standardBrackets;
 

author:bgashler1
date:2016-02-23T07:37:18Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/common/modes/monarch/monarchDefinition.ts
code:
@@ -9,22 +9,14 @@
  * using regular expressions.
  */
 
-import MonarchCommonTypes = require('vs/editor/common/modes/monarch/monarchCommon');
-import {IModelService} from 'vs/editor/common/services/modelService';
-import Modes = require('vs/editor/common/modes');
-import {CharacterPair, IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
-import {TextualAndPredefinedResultSuggestSupport, PredefinedResultSuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
+import {ISuggestSupport} from 'vs/editor/common/modes';
+import {ILexer} from 'vs/editor/common/modes/monarch/monarchCommon';
+import {IRichEditConfiguration} from 'vs/editor/common/modes/supports/richEditSupport';
+import {PredefinedResultSuggestSupport, TextualAndPredefinedResultSuggestSupport} from 'vs/editor/common/modes/supports/suggestSupport';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
+import {IModelService} from 'vs/editor/common/services/modelService';
 
-export function createRichEditSupport(lexer: MonarchCommonTypes.ILexer): IRichEditConfiguration {
-
-	function toBracket(input:Modes.IBracketPair): CharacterPair {
-		return [input.open, input.close];
-	}
-
-	function toBrackets(input:Modes.IBracketPair[]): CharacterPair[] {
-		return input.map(toBracket);
-	}
+export function createRichEditSupport(lexer: ILexer): IRichEditConfiguration {
 
 	return {
 
@@ -35,10 +27,9 @@ export function createRichEditSupport(lexer: MonarchCommonTypes.ILexer): IRichEd
 			blockComment: [lexer.blockCommentStart, lexer.blockCommentEnd]
 		},
 
-		brackets: toBrackets(lexer.standardBrackets),
+		brackets: lexer.standardBrackets,
 
 		__electricCharacterSupport: {
-			brackets: lexer.standardBrackets,
 			// regexBrackets: lexer.enhancedBrackets,
 			caseInsensitive: lexer.ignoreCase,
 			embeddedElectricCharacters: lexer.outdentTriggers.split('')
@@ -50,7 +41,7 @@ export function createRichEditSupport(lexer: MonarchCommonTypes.ILexer): IRichEd
 	};
 }
 
-export function createSuggestSupport(modelService: IModelService, editorWorkerService: IEditorWorkerService, modeId:string, lexer:MonarchCommonTypes.ILexer): Modes.ISuggestSupport {
+export function createSuggestSupport(modelService: IModelService, editorWorkerService: IEditorWorkerService, modeId:string, lexer:ILexer): ISuggestSupport {
 	if (lexer.suggestSupport.textualCompletions) {
 		return new TextualAndPredefinedResultSuggestSupport(
 			modeId,

author:bgashler1
date:2016-02-24T06:13:50Z
title:Fixes #3291 add color to git diff in hc-black theme
filename:src/vs/editor/css/hc-black-theme.css
code:
@@ -176,13 +176,13 @@
 .monaco-editor.hc-black .line-delete,
 .monaco-editor.hc-black .char-delete {
 	background: none;
-	border: 1px dotted white;
+	border: 1px dashed #FF008F;
 }
 
 .monaco-editor.hc-black .line-insert,
 .monaco-editor.hc-black .char-insert {
 	background: none;
-	border: 1px dashed white;
+	border: 1px dashed rgb(51, 255, 46);
 }
 
 .monaco-editor.hc-black .diagonal-fill {

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-collapse-dark.svg
code:
@@ -3,22 +3,22 @@
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
 	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
-	.st0{opacity:9.000000e-002;fill:#FFFFFF;}
+	.st0{opacity:0.1;fill:#FFFFFF;}
 	.st1{fill:#5A5A5A;}
 	.st2{fill:none;stroke:#C5C5C5;stroke-miterlimit:10;}
 </style>
-<rect x="2" y="2" class="st0" width="11" height="11"/>
-<g id="iconBg">
-	<g>
-		<path class="st1" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
-	</g>
-</g>
+<rect x="3" y="3" class="st0" width="9" height="9"/>
 <g>
 	<g>
-		<line class="st2" x1="11" y1="7.5" x2="4" y2="7.5"/>
+		<path class="st1" d="M11,4v7H4V4H11 M12,3H3v9h9V3L12,3z"/>
 	</g>
 	<g>
-		<line class="st2" x1="7.5" y1="4" x2="7.5" y2="11"/>
+		<g>
+			<line class="st2" x1="10" y1="7.5" x2="5" y2="7.5"/>
+		</g>
+		<g>
+			<line class="st2" x1="7.5" y1="5" x2="7.5" y2="10"/>
+		</g>
 	</g>
 </g>
 </svg>

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-collapse.svg
code:
@@ -4,17 +4,23 @@
 	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
 	.st0{fill:#E8E8E8;}
-	.st1{fill:none;stroke:#6B6B6B;stroke-miterlimit:10;}
-	.st2{fill:#B6B6B6;}
+	.st1{fill:#B6B6B6;}
+	.st2{fill:none;stroke:#6B6B6B;stroke-miterlimit:10;}
 </style>
-<rect x="2" y="2" class="st0" width="11" height="11"/>
+<rect x="3" y="3" class="st0" width="9" height="9"/>
 <g>
-	<line class="st1" x1="7.5" y1="4" x2="7.5" y2="11"/>
-	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
-</g>
-<g id="iconBg">
 	<g>
-		<path class="st2" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+		<path class="st1" d="M11,4v7H4V4H11 M12,3H3v9h9V3L12,3z"/>
+	</g>
+	<g>
+		<g>
+			<line class="st2" x1="10" y1="7.5" x2="5" y2="7.5"/>
+		</g>
+	</g>
+	<g>
+		<g>
+			<line class="st2" x1="7.5" y1="5" x2="7.5" y2="10"/>
+		</g>
 	</g>
 </g>
 </svg>

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-expand-dark.svg
code:
@@ -6,12 +6,16 @@
 	.st0{fill:#5A5A5A;}
 	.st1{fill:none;stroke:#C5C5C5;stroke-miterlimit:10;}
 </style>
-<g id="iconBg">
+<g>
 	<g>
-		<path class="st0" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+		<g>
+			<path class="st0" d="M11,4v7H4V4H11 M12,3H3v9h9V3L12,3z"/>
+		</g>
+		<g>
+			<g>
+				<line class="st1" x1="10" y1="7.5" x2="5" y2="7.5"/>
+			</g>
+		</g>
 	</g>
 </g>
-<g>
-	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
-</g>
 </svg>

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-expand.svg
code:
@@ -6,12 +6,14 @@
 	.st0{fill:#B6B6B6;}
 	.st1{fill:none;stroke:#6B6B6B;stroke-miterlimit:10;}
 </style>
-<g id="iconBg">
+<g>
 	<g>
-		<path class="st0" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+		<path class="st0" d="M11,4v7H4V4H11 M12,3H3v9h9V3L12,3z"/>
+	</g>
+	<g>
+		<g>
+			<line class="st1" x1="10" y1="7.5" x2="5" y2="7.5"/>
+		</g>
 	</g>
-</g>
-<g>
-	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
 </g>
 </svg>

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/browser/parts/media/compositePart.css
code:
@@ -19,3 +19,7 @@
 .monaco-workbench.vs-dark > .part > .composite.title > .title-label span  {
 	color: #bbbbbb;
 }
+
+.monaco-workbench.hc-black > .part > .composite.title > .title-label span  {
+	color: #fff;
+}

author:bgashler1
date:2016-02-24T01:08:27Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/search/browser/media/searchviewlet.css
code:
@@ -42,6 +42,10 @@
 	height: 13px;
 }
 
+.monaco-workbench.hc-black .search-viewlet .query-details .more {
+	background: url('ellipsis-inverse.svg') top center no-repeat;
+}
+
 .monaco-workbench.vs-dark .search-viewlet .query-details .more {
 	background: url('ellipsis-inverse.svg') top center no-repeat;
 }

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -294,14 +294,9 @@ function prepareDebPackage(arch) {
 function buildDebPackage(arch) {
 	var debArch = getDebPackageArch(arch);
 	return shell.task([
-		'fakeroot dpkg-deb -b vscode-' + debArch,
-		'dpkg-scanpackages . /dev/null > Packages'
-	], { cwd: '.build/linux/' + debArch});
-}
-
-function buildDebPackageCatalog(arch) {
-	var debArch = getDebPackageArch(arch);
-	return shell.task([], { cwd: '.build/linux/' + debArch});
+		'fakeroot dpkg-deb -b ' + debArch + '/vscode-' + debArch,
+		'dpkg-scanpackages ' + debArch + ' /dev/null > ' + debArch + '/Packages'
+	], { cwd: '.build/linux'});
 }
 
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
@@ -328,8 +323,6 @@ gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vsco
 gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb', 'vscode-linux-x64-min'], prepareDebPackage('x64'));
 gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
 gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
-gulp.task('vscode-linux-ia32-build-deb-catalog', ['vscode-linux-ia32-build-deb'], buildDebPackageCatalog('ia32'));
-gulp.task('vscode-linux-x64-build-deb-catalog', ['vscode-linux-x64-build-deb'], buildDebPackageCatalog('x64'));
 
 // Sourcemaps
 

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/list/listWidget.ts
code:
@@ -7,7 +7,7 @@ import 'vs/css!./list';
 import { IDisposable, dispose, disposeAll } from 'vs/base/common/lifecycle';
 import { isNumber } from 'vs/base/common/types';
 import * as DOM from 'vs/base/browser/dom';
-import Event, { Emitter, mapEvent } from 'vs/base/common/event';
+import Event, { Emitter, mapEvent, EventDelayer } from 'vs/base/common/event';
 import { IDelegate, IRenderer, IListMouseEvent, IFocusChangeEvent, ISelectionChangeEvent } from './list';
 import { ListView } from './listView';
 
@@ -89,36 +89,10 @@ class Trait implements IDisposable {
 		return this.indexes;
 	}
 
-	add(index: number): void {
-		if (this.contains(index)) {
-			return;
-		}
-
-		this.indexes.push(index);
-		this._onChange.fire({ indexes: this.indexes });
-	}
-
-	remove(index: number): void {
-		this.indexes = this.indexes.filter(i => i === index);
-		this._onChange.fire({ indexes: this.indexes });
-	}
-
 	contains(index: number): boolean {
 		return this.indexes.some(i => i === index);
 	}
 
-	next(n: number): void {
-		let index = this.indexes.length ? this.indexes[0] : 0;
-		index = Math.min(index + n, this.indexes.length);
-		this.set(index);
-	}
-
-	previous(n: number): void {
-		let index = this.indexes.length ? this.indexes[0] : this.indexes.length - 1;
-		index = Math.max(index - n, 0);
-		this.set(index);
-	}
-
 	wrapRenderer<T, D>(renderer: IRenderer<T, D>): IRenderer<T, ITraitTemplateData<D>> {
 		return new TraitRenderer<T, D>(this, renderer);
 	}
@@ -154,21 +128,16 @@ export class List<T> implements IDisposable {
 
 	private focus: Trait;
 	private selection: Trait;
+	private eventDelayer: EventDelayer;
 	private view: ListView<T>;
 	private controller: Controller<T>;
 
 	get onFocusChange(): Event<IFocusChangeEvent<T>> {
-		return mapEvent(this.focus.onChange, e => ({
-			elements: e.indexes.map(i => this.view.element(i)),
-			indexes: e.indexes
-		}));
+		return this.eventDelayer.delay(mapEvent(this.focus.onChange, e => this.toListEvent(e)));
 	}
 
 	get onSelectionChange(): Event<ISelectionChangeEvent<T>> {
-		return mapEvent(this.selection.onChange, e => ({
-			elements: e.indexes.map(i => this.view.element(i)),
-			indexes: e.indexes
-		}));
+		return this.eventDelayer.delay(mapEvent(this.selection.onChange, e => this.toListEvent(e)));
 	}
 
 	constructor(
@@ -178,6 +147,7 @@ export class List<T> implements IDisposable {
 	) {
 		this.focus = new Trait('focused');
 		this.selection = new Trait('selected');
+		this.eventDelayer = new EventDelayer();
 
 		renderers = renderers.map(r => {
 			r = this.focus.wrapRenderer(r);
@@ -190,9 +160,11 @@ export class List<T> implements IDisposable {
 	}
 
 	splice(start: number, deleteCount: number, ...elements: T[]): void {
-		this.focus.splice(start, deleteCount, elements.length);
-		this.selection.splice(start, deleteCount, elements.length);
-		this.view.splice(start, deleteCount, ...elements);
+		this.eventDelayer.wrap(() => {
+			this.focus.splice(start, deleteCount, elements.length);
+			this.selection.splice(start, deleteCount, elements.length);
+			this.view.splice(start, deleteCount, ...elements);
+		});
 	}
 
 	get length(): number {
@@ -208,8 +180,10 @@ export class List<T> implements IDisposable {
 	}
 
 	setSelection(...indexes: number[]): void {
-		indexes = indexes.concat(this.selection.set(...indexes));
-		indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		this.eventDelayer.wrap(() => {
+			indexes = indexes.concat(this.selection.set(...indexes));
+			indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		});
 	}
 
 	selectNext(n = 1, loop = false): void {
@@ -230,8 +204,10 @@ export class List<T> implements IDisposable {
 	}
 
 	setFocus(...indexes: number[]): void {
-		indexes = indexes.concat(this.focus.set(...indexes));
-		indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		this.eventDelayer.wrap(() => {
+			indexes = indexes.concat(this.focus.set(...indexes));
+			indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		});
 	}
 
 	focusNext(n = 1, loop = false): void {
@@ -322,6 +298,10 @@ export class List<T> implements IDisposable {
 		}
 	}
 
+	private toListEvent<T>({ indexes }: ITraitChangeEvent) {
+		return { indexes, elements: indexes.map(i => this.view.element(i)) };
+	}
+
 	dispose(): void {
 		this.view = dispose(this.view);
 		this.focus = dispose(this.focus);

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/event.ts
code:
@@ -154,4 +154,55 @@ export function fromEventEmitter<T>(emitter: EventEmitter, eventType: string): E
 export function mapEvent<I,O>(event: Event<I>, map: (i:I)=>O): Event<O> {
 	return (listener, thisArgs?, disposables?) =>
 		event(i => listener(map(i)), thisArgs, disposables);
+}
+
+enum EventDelayerState {
+	Idle,
+	Running
+}
+
+/**
+ * The EventDelayer is useful in situations in which you want
+ * to delay firing your events during some code.
+ * You can wrap that code and be sure that the event will not
+ * be fired during that wrap.
+ *
+ * ```
+ * const emitter: Emitter;
+ * const delayer = new EventDelayer();
+ * const delayedEvent = delayer.delay(emitter.event);
+ *
+ * delayedEvent(console.log);
+ *
+ * delayer.wrap(() => {
+ *   emitter.fire(); // event will not be fired yet
+ * });
+ *
+ * // event will only be fired at this point
+ * ```
+ */
+export class EventDelayer {
+
+	private state = EventDelayerState.Idle;
+	private buffer: Function[] = [];
+
+	delay<T>(event: Event<T>): Event<T> {
+		return (listener, thisArgs?, disposables?) => {
+			return event(i => {
+				if (this.state === EventDelayerState.Idle) {
+					listener(i);
+				} else {
+					this.buffer.push(() => listener(i));
+				}
+			}, thisArgs, disposables);
+		};
+	}
+
+	wrap(fn: () => void): void {
+		this.state = EventDelayerState.Running;
+		fn();
+		this.buffer.forEach(flush => flush());
+		this.buffer = [];
+		this.state = EventDelayerState.Idle;
+	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-collapse-dark.svg
code:
@@ -1,10 +1,24 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
-	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
+	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
-	.st0{fill:#FFFFFF;}
+	.st0{opacity:9.000000e-002;fill:#FFFFFF;}
+	.st1{fill:#5A5A5A;}
+	.st2{fill:none;stroke:#C5C5C5;stroke-miterlimit:10;}
 </style>
-<path class="st0" d="M2,2v12h12V2H2z M13,13H3V3h10V13z"/>
-<path id="XMLID_5_" class="st0" d="M12,9H9v3H7V9H4V7h3V4h2v3h3V9z"/>
+<rect x="2" y="2" class="st0" width="11" height="11"/>
+<g id="iconBg">
+	<g>
+		<path class="st1" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+	</g>
+</g>
+<g>
+	<g>
+		<line class="st2" x1="11" y1="7.5" x2="4" y2="7.5"/>
+	</g>
+	<g>
+		<line class="st2" x1="7.5" y1="4" x2="7.5" y2="11"/>
+	</g>
+</g>
 </svg>

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-collapse.svg
code:
@@ -1,10 +1,20 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
-	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
+	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
-	.icon_x002D_vso_x002D_bg{fill:#656565;}
+	.st0{fill:#E8E8E8;}
+	.st1{fill:none;stroke:#6B6B6B;stroke-miterlimit:10;}
+	.st2{fill:#B6B6B6;}
 </style>
-<path class="icon_x002D_vso_x002D_bg" d="M2,2v12h12V2H2z M13,13H3V3h10V13z"/>
-<path id="XMLID_5_" d="M12,9H9v3H7V9H4V7h3V4h2v3h3V9z"/>
+<rect x="2" y="2" class="st0" width="11" height="11"/>
+<g>
+	<line class="st1" x1="7.5" y1="4" x2="7.5" y2="11"/>
+	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
+</g>
+<g id="iconBg">
+	<g>
+		<path class="st2" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+	</g>
+</g>
 </svg>

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-expand-dark.svg
code:
@@ -1,10 +1,17 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
-	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
+	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
-	.st0{fill:#FFFFFF;}
+	.st0{fill:#5A5A5A;}
+	.st1{fill:none;stroke:#C5C5C5;stroke-miterlimit:10;}
 </style>
-<path class="st0" d="M2,2v12h12V2H2z M13,13H3V3h10V13z"/>
-<path id="XMLID_5_" class="st0" d="M12,9H4V7h8V9z"/>
+<g id="iconBg">
+	<g>
+		<path class="st0" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+	</g>
+</g>
+<g>
+	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
+</g>
 </svg>

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/arrow-expand.svg
code:
@@ -1,10 +1,17 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!-- Generator: Adobe Illustrator 19.2.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
 <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
-	 viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">
+	 viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve">
 <style type="text/css">
-	.icon_x002D_vso_x002D_bg{fill:#656565;}
+	.st0{fill:#B6B6B6;}
+	.st1{fill:none;stroke:#6B6B6B;stroke-miterlimit:10;}
 </style>
-<path class="icon_x002D_vso_x002D_bg" d="M2,2v12h12V2H2z M13,13H3V3h10V13z"/>
-<path id="XMLID_5_" d="M12,9H4V7h8V9z"/>
+<g id="iconBg">
+	<g>
+		<path class="st0" d="M12,3v9H3V3H12 M13,2H2v11h11V2L13,2z"/>
+	</g>
+</g>
+<g>
+	<line class="st1" x1="11" y1="7.5" x2="4" y2="7.5"/>
+</g>
 </svg>

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/editor/contrib/folding/browser/folding.css
code:
@@ -6,7 +6,7 @@
 .monaco-editor .margin-view-overlays .folding {
 	background-repeat: no-repeat;
 	background-position-y: center;
-	background-size: 1em 1em;
+	background-size: 15px;
 	border-left: 3px solid transparent; /* copy of what the Git decorator does */
 	margin-left: 5px;
 	cursor: pointer;

author:bgashler1
date:2016-02-23T23:46:39Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/cli.ts
code:
@@ -24,16 +24,16 @@ class ArgParser {
 
 	help(): string {
 		const executable = 'code' + (os.platform() === 'win32' ? '.exe' : '');
-
+		const indent = '  ';
 		return `Visual Studio Code v${ packageJson.version }
 
 Usage: ${ executable } [arguments] [paths...]
 
 Options:
-	-h, --help     Print usage.
-	--locale       Use a specific locale.
-	-n             Force a new instance of Code.
-	-v, --version  Print version.`;
+${ indent }-h, --help     Print usage.
+${ indent }--locale       Use a specific locale.
+${ indent }-n             Force a new instance of Code.
+${ indent }-v, --version  Print version.`;
 	}
 }
 

author:bgashler1
date:2016-02-23T23:26:57Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.vscode.js
code:
@@ -294,14 +294,9 @@ function prepareDebPackage(arch) {
 function buildDebPackage(arch) {
 	var debArch = getDebPackageArch(arch);
 	return shell.task([
-		'fakeroot dpkg-deb -b vscode-' + debArch,
-		'dpkg-scanpackages . /dev/null > Packages'
-	], { cwd: '.build/linux/' + debArch});
-}
-
-function buildDebPackageCatalog(arch) {
-	var debArch = getDebPackageArch(arch);
-	return shell.task([], { cwd: '.build/linux/' + debArch});
+		'fakeroot dpkg-deb -b ' + debArch + '/vscode-' + debArch,
+		'dpkg-scanpackages ' + debArch + ' /dev/null > ' + debArch + '/Packages'
+	], { cwd: '.build/linux'});
 }
 
 gulp.task('clean-vscode-win32', util.rimraf(path.join(path.dirname(root), 'VSCode-win32')));
@@ -328,8 +323,6 @@ gulp.task('vscode-linux-ia32-prepare-deb', ['clean-vscode-linux-ia32-deb', 'vsco
 gulp.task('vscode-linux-x64-prepare-deb', ['clean-vscode-linux-x64-deb', 'vscode-linux-x64-min'], prepareDebPackage('x64'));
 gulp.task('vscode-linux-ia32-build-deb', ['vscode-linux-ia32-prepare-deb'], buildDebPackage('ia32'));
 gulp.task('vscode-linux-x64-build-deb', ['vscode-linux-x64-prepare-deb'], buildDebPackage('x64'));
-gulp.task('vscode-linux-ia32-build-deb-catalog', ['vscode-linux-ia32-build-deb'], buildDebPackageCatalog('ia32'));
-gulp.task('vscode-linux-x64-build-deb-catalog', ['vscode-linux-x64-build-deb'], buildDebPackageCatalog('x64'));
 
 // Sourcemaps
 

author:bgashler1
date:2016-02-23T23:26:57Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/list/listWidget.ts
code:
@@ -7,7 +7,7 @@ import 'vs/css!./list';
 import { IDisposable, dispose, disposeAll } from 'vs/base/common/lifecycle';
 import { isNumber } from 'vs/base/common/types';
 import * as DOM from 'vs/base/browser/dom';
-import Event, { Emitter, mapEvent } from 'vs/base/common/event';
+import Event, { Emitter, mapEvent, EventDelayer } from 'vs/base/common/event';
 import { IDelegate, IRenderer, IListMouseEvent, IFocusChangeEvent, ISelectionChangeEvent } from './list';
 import { ListView } from './listView';
 
@@ -89,36 +89,10 @@ class Trait implements IDisposable {
 		return this.indexes;
 	}
 
-	add(index: number): void {
-		if (this.contains(index)) {
-			return;
-		}
-
-		this.indexes.push(index);
-		this._onChange.fire({ indexes: this.indexes });
-	}
-
-	remove(index: number): void {
-		this.indexes = this.indexes.filter(i => i === index);
-		this._onChange.fire({ indexes: this.indexes });
-	}
-
 	contains(index: number): boolean {
 		return this.indexes.some(i => i === index);
 	}
 
-	next(n: number): void {
-		let index = this.indexes.length ? this.indexes[0] : 0;
-		index = Math.min(index + n, this.indexes.length);
-		this.set(index);
-	}
-
-	previous(n: number): void {
-		let index = this.indexes.length ? this.indexes[0] : this.indexes.length - 1;
-		index = Math.max(index - n, 0);
-		this.set(index);
-	}
-
 	wrapRenderer<T, D>(renderer: IRenderer<T, D>): IRenderer<T, ITraitTemplateData<D>> {
 		return new TraitRenderer<T, D>(this, renderer);
 	}
@@ -154,21 +128,16 @@ export class List<T> implements IDisposable {
 
 	private focus: Trait;
 	private selection: Trait;
+	private eventDelayer: EventDelayer;
 	private view: ListView<T>;
 	private controller: Controller<T>;
 
 	get onFocusChange(): Event<IFocusChangeEvent<T>> {
-		return mapEvent(this.focus.onChange, e => ({
-			elements: e.indexes.map(i => this.view.element(i)),
-			indexes: e.indexes
-		}));
+		return this.eventDelayer.delay(mapEvent(this.focus.onChange, e => this.toListEvent(e)));
 	}
 
 	get onSelectionChange(): Event<ISelectionChangeEvent<T>> {
-		return mapEvent(this.selection.onChange, e => ({
-			elements: e.indexes.map(i => this.view.element(i)),
-			indexes: e.indexes
-		}));
+		return this.eventDelayer.delay(mapEvent(this.selection.onChange, e => this.toListEvent(e)));
 	}
 
 	constructor(
@@ -178,6 +147,7 @@ export class List<T> implements IDisposable {
 	) {
 		this.focus = new Trait('focused');
 		this.selection = new Trait('selected');
+		this.eventDelayer = new EventDelayer();
 
 		renderers = renderers.map(r => {
 			r = this.focus.wrapRenderer(r);
@@ -190,9 +160,11 @@ export class List<T> implements IDisposable {
 	}
 
 	splice(start: number, deleteCount: number, ...elements: T[]): void {
-		this.focus.splice(start, deleteCount, elements.length);
-		this.selection.splice(start, deleteCount, elements.length);
-		this.view.splice(start, deleteCount, ...elements);
+		this.eventDelayer.wrap(() => {
+			this.focus.splice(start, deleteCount, elements.length);
+			this.selection.splice(start, deleteCount, elements.length);
+			this.view.splice(start, deleteCount, ...elements);
+		});
 	}
 
 	get length(): number {
@@ -208,8 +180,10 @@ export class List<T> implements IDisposable {
 	}
 
 	setSelection(...indexes: number[]): void {
-		indexes = indexes.concat(this.selection.set(...indexes));
-		indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		this.eventDelayer.wrap(() => {
+			indexes = indexes.concat(this.selection.set(...indexes));
+			indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		});
 	}
 
 	selectNext(n = 1, loop = false): void {
@@ -230,8 +204,10 @@ export class List<T> implements IDisposable {
 	}
 
 	setFocus(...indexes: number[]): void {
-		indexes = indexes.concat(this.focus.set(...indexes));
-		indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		this.eventDelayer.wrap(() => {
+			indexes = indexes.concat(this.focus.set(...indexes));
+			indexes.forEach(i => this.view.splice(i, 1, this.view.element(i)));
+		});
 	}
 
 	focusNext(n = 1, loop = false): void {
@@ -322,6 +298,10 @@ export class List<T> implements IDisposable {
 		}
 	}
 
+	private toListEvent<T>({ indexes }: ITraitChangeEvent) {
+		return { indexes, elements: indexes.map(i => this.view.element(i)) };
+	}
+
 	dispose(): void {
 		this.view = dispose(this.view);
 		this.focus = dispose(this.focus);

author:bgashler1
date:2016-02-23T23:26:57Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/common/event.ts
code:
@@ -154,4 +154,55 @@ export function fromEventEmitter<T>(emitter: EventEmitter, eventType: string): E
 export function mapEvent<I,O>(event: Event<I>, map: (i:I)=>O): Event<O> {
 	return (listener, thisArgs?, disposables?) =>
 		event(i => listener(map(i)), thisArgs, disposables);
+}
+
+enum EventDelayerState {
+	Idle,
+	Running
+}
+
+/**
+ * The EventDelayer is useful in situations in which you want
+ * to delay firing your events during some code.
+ * You can wrap that code and be sure that the event will not
+ * be fired during that wrap.
+ *
+ * ```
+ * const emitter: Emitter;
+ * const delayer = new EventDelayer();
+ * const delayedEvent = delayer.delay(emitter.event);
+ *
+ * delayedEvent(console.log);
+ *
+ * delayer.wrap(() => {
+ *   emitter.fire(); // event will not be fired yet
+ * });
+ *
+ * // event will only be fired at this point
+ * ```
+ */
+export class EventDelayer {
+
+	private state = EventDelayerState.Idle;
+	private buffer: Function[] = [];
+
+	delay<T>(event: Event<T>): Event<T> {
+		return (listener, thisArgs?, disposables?) => {
+			return event(i => {
+				if (this.state === EventDelayerState.Idle) {
+					listener(i);
+				} else {
+					this.buffer.push(() => listener(i));
+				}
+			}, thisArgs, disposables);
+		};
+	}
+
+	wrap(fn: () => void): void {
+		this.state = EventDelayerState.Running;
+		fn();
+		this.buffer.forEach(flush => flush());
+		this.buffer = [];
+		this.state = EventDelayerState.Idle;
+	}
 }
\ No newline at end of file

author:bgashler1
date:2016-02-23T23:26:57Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/electron-main/cli.ts
code:
@@ -24,16 +24,16 @@ class ArgParser {
 
 	help(): string {
 		const executable = 'code' + (os.platform() === 'win32' ? '.exe' : '');
-
+		const indent = '  ';
 		return `Visual Studio Code v${ packageJson.version }
 
 Usage: ${ executable } [arguments] [paths...]
 
 Options:
-	-h, --help     Print usage.
-	--locale       Use a specific locale.
-	-n             Force a new instance of Code.
-	-v, --version  Print version.`;
+${ indent }-h, --help     Print usage.
+${ indent }--locale       Use a specific locale.
+${ indent }-n             Force a new instance of Code.
+${ indent }-v, --version  Print version.`;
 	}
 }
 

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:ThirdPartyNotices.txt
code:
@@ -50,7 +50,7 @@ This project incorporates components from the projects listed below. The origina
 42.	textmate/xml.tmbundle (https://github.com/textmate/xml.tmbundle)
 43.	textmate/yaml.tmbundle (https://github.com/textmate/yaml.tmbundle)
 44.	typescript version 1.5 (https://github.com/Microsoft/TypeScript)
-45.	typescript version 1.7.5 (https://github.com/Microsoft/TypeScript)
+45.	typescript version 1.8.2 (https://github.com/Microsoft/TypeScript)
 46.	typescript-sublime-plugin version 0.1.8 (https://github.com/Microsoft/TypeScript-TmLanguage)
 47.	unity-shader-files version 0.1.0 (https://github.com/nashella/unity-shader-files)
 48.	vscode-swift version 0.0.1 (https://github.com/owensd/vscode-swift)

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/gulpfile.plugins.js
code:
@@ -114,7 +114,7 @@ var tasks = readAllPlugins()
 					.pipe(tsFilter)
 					.pipe(compilation())
 					.pipe(tsFilter.restore)
-					.pipe(quiet ? es.through() : reporter());
+					.pipe(quiet ? es.through() : reporter.end());
 
 				return es.duplex(input, output);
 			};

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:build/lib/reporter.js
code:
@@ -18,25 +18,31 @@ function onEnd() {
 	}
 
 	var errors = _.flatten(allErrors);
-	errors.map(function (err) { console.log('*** Error:', err); });
+	errors.map(function (err) { console.error('*** Error:', err); });
 	console.log('*** Finished with', errors.length, 'errors.');
 }
 
 module.exports = function () {
 	var errors = [];
 	allErrors.push(errors);
 
-	return function (err) {
-		if (err) {
-			errors.push(err);
-			return;
-		}
+	var result = function (err) {
+		errors.push(err);
+	};
 
+	result.end = function (emitError) {
 		errors.length = 0;
 		onStart();
 		return es.through(null, function () {
 			onEnd();
-			this.emit('end');
+
+			if (emitError && errors.length > 0) {
+				this.emit('error', 'Errors occurred.');
+			} else {
+				this.emit('end');
+			}
 		});
 	};
+
+	return result;
 };
\ No newline at end of file

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/javascript/schemas/jsconfig.schema.json
code:
@@ -29,27 +29,31 @@
 					"format": "uri"
 				},
 				"module": {
-					"description": "Module code generation to resolve against: 'commonjs', 'amd', 'system', or 'umd'.",
+					"description": "Specify module code generation: 'CommonJS', 'Amd', 'System', 'UMD', 'es6', or 'es2015'.",
 					"enum": [
 						"commonjs",
 						"amd",
+						"umd",
 						"system",
-						"umd"
+						"es6",
+						"es2015"
 					]
 				},
+
 				"noLib": {
 					"description": "Do not include the default library file (lib.d.ts).",
 					"type": "boolean"
 				},
 				"target": {
-					"description": "Specify ECMAScript target version:  'ES3', 'ES5', or 'ES6' (default).",
+					"description": "Specify ECMAScript target version.",
 					"enum": [
 						"ES3",
 						"ES5",
 						"ES6",
 						"es3",
 						"es5",
-						"es6"
+						"es6",
+						"es2015"
 					],
 					"default": "ES6"
 				},

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/json/server/src/jsonParser.ts
code:
@@ -417,9 +417,9 @@ export class StringASTNode extends ASTNode {
 	public value: string;
 
 	constructor(parent: ASTNode, name: string, isKey: boolean, start: number, end?: number) {
+		super(parent, 'string', name, start, end);
 		this.isKey = isKey;
 		this.value = '';
-		super(parent, 'string', name, start, end);
 	}
 
 	public getValue(): any {

author:bgashler1
date:2016-02-23T17:54:43Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/typescript/OSSREADME.json
code:
@@ -192,7 +192,7 @@
 },
 {
 	"name": "typescript",
-	"version": "1.8.0",
+	"version": "1.8.2",
 	"license": "Apache2",
 	"repositoryURL": "https://github.com/Microsoft/TypeScript",
 	"description": "The contents of the folder lib is from the TypeScript project https://github.com/Microsoft/TypeScript.",

author:aeschli
date:2016-02-25T20:23:48Z
title:fixes #3383 [folding] icon hides git gutter colouring
filename:src/vs/editor/contrib/folding/browser/folding.css
code:
@@ -5,9 +5,9 @@
 
 .monaco-editor .margin-view-overlays .folding {
 	background-repeat: no-repeat;
-	background-position-y: center;
+	background-origin: border-box;
+	background-position: 3px center;
 	background-size: 15px;
-	border-left: 3px solid transparent; /* copy of what the Git decorator does */
 	margin-left: 5px;
 	cursor: pointer;
 }

author:bgashler1
date:2016-03-03T22:10:55Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/common/debug.ts
code:
@@ -327,7 +327,7 @@ export function formatPII(value:string, excludePII: boolean, args: {[key: string
 			return match;
 		}
 
-		return args.hasOwnProperty(group) ?
+		return args && args.hasOwnProperty(group) ?
 			args[group] :
 			match;
 	});

author:bgashler1
date:2016-03-03T22:10:55Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debugService.ts
code:
@@ -638,9 +638,7 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 
 			if (filteredTasks[0].isWatching) {
 				return new TPromise((c, e) => {
-					this.taskService.addOneTimeListener(TaskServiceEvents.Inactive, () => {
-						c(null);
-					});
+					this.taskService.addOneTimeListener(TaskServiceEvents.Inactive, () => c(taskPromise));
 				});
 			}
 

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/base/browser/ui/aria/aria.css
code:
@@ -5,6 +5,5 @@
 
 .aria-container {
 	position: absolute; /* try to hide from workbench but not from screen readers */
-	width: 0;
-	height: 0;
+	left:-999em;
 }
\ No newline at end of file

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/common/debug.ts
code:
@@ -163,7 +163,8 @@ export enum State {
 	Inactive,
 	Initializing,
 	Stopped,
-	Running
+	Running,
+	RunningNoDebug
 }
 
 // service interfaces
@@ -192,6 +193,7 @@ export interface IConfig {
 	preLaunchTask?: string;
 	externalConsole?: boolean;
 	debugServer?: number;
+	noDebug?: boolean;
 }
 
 export interface IRawEnvAdapter {
@@ -277,7 +279,7 @@ export interface IDebugService extends ee.IEventEmitter {
 	/**
 	 * Creates a new debug session. Depending on the configuration will either 'launch' or 'attach'.
 	 */
-	createSession(): TPromise<any>;
+	createSession(noDebug: boolean): TPromise<any>;
 
 	/**
 	 * Restarts an active debug session or creates a new one if there is no active session.

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debug.contribution.ts
code:
@@ -104,6 +104,7 @@ registry.registerWorkbenchAction(new SyncActionDescriptor(dbgactions.ConfigureAc
 registry.registerWorkbenchAction(new SyncActionDescriptor(dbgactions.ToggleReplAction, dbgactions.ToggleReplAction.ID, dbgactions.ToggleReplAction.LABEL, { primary: KeyMod.CtrlCmd | KeyMod.Shift | KeyCode.KEY_Y,}), debugCategory);
 registry.registerWorkbenchAction(new SyncActionDescriptor(dbgactions.AddFunctionBreakpointAction, dbgactions.AddFunctionBreakpointAction.ID, dbgactions.AddFunctionBreakpointAction.LABEL), debugCategory);
 registry.registerWorkbenchAction(new SyncActionDescriptor(dbgactions.ReapplyBreakpointsAction, dbgactions.ReapplyBreakpointsAction.ID, dbgactions.ReapplyBreakpointsAction.LABEL), debugCategory);
+registry.registerWorkbenchAction(new SyncActionDescriptor(dbgactions.RunAction, dbgactions.RunAction.ID, dbgactions.RunAction.LABEL, { primary: KeyMod.CtrlCmd | KeyCode.F5 }, KbExpr.not(debug.CONTEXT_IN_DEBUG_MODE)));
 
 // register service
 registerSingleton(IDebugService, service.DebugService);

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debugActions.ts
code:
@@ -115,7 +115,7 @@ export class StartDebugAction extends AbstractDebugAction {
 	}
 
 	public run(): TPromise<any> {
-		return this.debugService.createSession();
+		return this.debugService.createSession(false);
 	}
 
 	protected isEnabled(): boolean {
@@ -745,3 +745,20 @@ export class ToggleReplAction extends AbstractDebugAction {
 		return panel && panel.getId() === debug.REPL_ID;
 	}
 }
+
+export class RunAction extends AbstractDebugAction {
+	static ID = 'workbench.action.debug.run';
+	static LABEL = nls.localize('run', "Run");
+
+	constructor(id: string, label: string, @IDebugService debugService: IDebugService, @IKeybindingService keybindingService: IKeybindingService) {
+		super(id, label, null, debugService, keybindingService);
+	}
+
+	public run(): TPromise<any> {
+		return this.debugService.createSession(true);
+	}
+
+	protected isEnabled(): boolean {
+		return super.isEnabled() && this.debugService.getState() === debug.State.Inactive;
+	}
+}

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/electron-browser/debugService.ts
code:
@@ -258,7 +258,7 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 			aria.alert(nls.localize('debuggingContinued', "Debugging continued."));
 			this.model.clearThreads(false);
 			this.setFocusedStackFrameAndEvaluate(null);
-			this.setStateAndEmit(debug.State.Running);
+			this.setStateAndEmit(this.configurationManager.getConfiguration().noDebug ? debug.State.RunningNoDebug : debug.State.Running);
 		}));
 
 		this.toDispose.push(this.session.addListener2(debug.SessionEvents.THREAD, (event: DebugProtocol.ThreadEvent) => {
@@ -506,16 +506,17 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		this.model.clearWatchExpressions(id);
 	}
 
-	public createSession(changeViewState = !this.partService.isSideBarHidden()): TPromise<any> {
+	public createSession(noDebug: boolean, changeViewState = !this.partService.isSideBarHidden() && !noDebug): TPromise<any> {
 		this.clearReplExpressions();
 
 		return this.textFileService.saveAll().then(() => this.extensionService.onReady()).then(() => this.configurationManager.setConfiguration(this.configurationManager.getConfigurationName())).then(() => {
 
 			const configuration = this.configurationManager.getConfiguration();
+			configuration.noDebug = noDebug;
 			if (!configuration) {
 				return this.configurationManager.openConfigFile(false).then(openend => {
 					if (openend) {
-						this.messageService.show(severity.Info, nls.localize('NewLaunchConfig', "Please set up the launch configuration file to debug your application."));
+						this.messageService.show(severity.Info, nls.localize('NewLaunchConfig', "Please set up the launch configuration file for your application."));
 					}
 				});
 			}
@@ -671,10 +672,10 @@ export class DebugService extends ee.EventEmitter implements debug.IDebugService
 		return this.session ? this.session.disconnect(true).then(() =>
 			new TPromise<void>((c, e) => {
 				setTimeout(() => {
-					this.createSession(false).then(() => c(null), err => e(err));
+					this.createSession(false, false).then(() => c(null), err => e(err));
 				}, 300);
 			})
-		) : this.createSession(false);
+		) : this.createSession(false, false);
 	}
 
 	public getActiveSession(): debug.IRawDebugSession {

author:bgashler1
date:2016-03-03T19:50:37Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/debug/node/debugConfigurationManager.ts
code:
@@ -277,7 +277,7 @@ export class ConfigurationManager {
 	}
 
 	private getInitialConfigFileContent(): TPromise<string> {
-		return this.quickOpenService.pick(this.adapters, { placeHolder: nls.localize('selectDebug', "Select Debug Environment") })
+		return this.quickOpenService.pick(this.adapters, { placeHolder: nls.localize('selectDebug', "Select Environment") })
 		.then(adapter => {
 			if (!adapter) {
 				return null;

author:lukehoban
date:2016-03-04T19:05:42Z
title:[go syntax] Don't treat multiline `var` specially

Fixes https://github.com/Microsoft/vscode-go/issues/223.
filename:extensions/go/syntaxes/go.json
code:
@@ -226,29 +226,6 @@
         }
       }
     },
-    {
-      "comment": "Multiline variable declarations/assignments",
-      "begin": "(\\bvar\\b)\\s+(\\()",
-      "beginCaptures": {
-        "1": {
-          "name": "keyword.var.go"
-        },
-        "2": {
-          "name": "punctuation.other.bracket.round.go"
-        }
-      },
-      "end": "\\)",
-      "endCaptures": {
-        "0": {
-          "name": "punctuation.other.bracket.round.go"
-        }
-      },
-      "patterns": [
-        {
-          "include": "#variables"
-        }
-      ]
-    },
     {
       "comment": "Terminators",
       "match": ";",

author:Tyriar
date:2016-03-08T17:43:25Z
title:Implement -w/--wait command line arg

This enables git integrations by waiting until the window is closed before
terminating the process. To set code as the default git editor run:

    git config --global core.editor "code --wait"

Fixes #744
filename:src/vs/workbench/electron-main/cli.ts
code:
@@ -38,8 +38,9 @@ ${ indent }--locale=LOCALE       Use a specific locale, "pseudo" can be used to
 ${ indent }                      localization.
 ${ indent }-n, --new-window      Force a new instance of Code.
 ${ indent }-r, --reuse-window    Force opening a file or folder in the last active
-${ indent }                      window.
-${ indent }-v, --version         Print version.`;
+${ indent }                      window.2
+${ indent }-v, --version         Print version.
+${ indent }-w, --wait            Wait for the window to be closed before returning.`;
 	}
 }
 
@@ -52,7 +53,11 @@ export function main(argv: string[]) {
 		console.log(packageJson.version);
 	} else {
 		delete process.env['ATOM_SHELL_INTERNAL_RUN_AS_NODE'];
-		spawn(process.execPath, process.argv.slice(2), { detached: true, stdio: 'ignore' });
+		if (argParser.hasFlag('wait', 'w')) {
+			spawn(process.execPath, process.argv.slice(2), { stdio: 'ignore' });
+		} else {
+			spawn(process.execPath, process.argv.slice(2), { detached: true, stdio: 'ignore' });
+		}
 	}
 
 	process.exit(0);

author:bpasero
date:2016-03-11T10:58:30Z
title:gitconfig => ini mode
filename:extensions/ini/package.json
code:
@@ -7,7 +7,7 @@
 		"languages": [{
 			"id": "ini",
 			"extensions": [ ".ini", ".properties", ".gitconfig" ],
-			"filenames": ["config", ".gitattributes", ".gitconfig", ".editorconfig"],
+			"filenames": ["config", ".gitattributes", ".gitconfig", "gitconfig", ".editorconfig"],
 			"aliases": [ "Ini", "ini" ],
 			"configuration": "./ini.configuration.json"
 		}],

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/OSSREADME.json
code:
@@ -0,0 +1,29 @@
+// ATTENTION - THIS DIRECTORY CONTAINS THIRD PARTY OPEN SOURCE MATERIALS:
+[{
+	"name": "textmate/git.tmbundle",
+	"version": "0.0.0",
+	"license": "MIT",
+	"repositoryURL": "https://github.com/textmate/git.tmbundle",
+	"licenseDetail": [
+		"Copyright (c) 2008 Tim Harper",
+		"",
+		"Permission is hereby granted, free of charge, to any person obtaining",
+		"a copy of this software and associated documentation files (the\"",
+		"Software\"), to deal in the Software without restriction, including",
+		"without limitation the rights to use, copy, modify, merge, publish,",
+		"distribute, sublicense, and/or sell copies of the Software, and to",
+		"permit persons to whom the Software is furnished to do so, subject to",
+		"the following conditions:",
+		"",
+		"The above copyright notice and this permission notice shall be",
+		"included in all copies or substantial portions of the Software.",
+		"",
+		"THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,",
+		"EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF",
+		"MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND",
+		"NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE",
+		"LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION",
+		"OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION",
+		"WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."
+	]
+}]
\ No newline at end of file

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/git-commit.configuration.json
code:
@@ -0,0 +1,11 @@
+{
+	"comments": {
+		"lineComment": "//",
+		"blockComment": [ "/*", "*/" ]
+	},
+	"brackets": [
+		["{", "}"],
+		["[", "]"],
+		["(", ")"]
+	]
+}
\ No newline at end of file

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/git-rebase.configuration.json
code:
@@ -0,0 +1,11 @@
+{
+	"comments": {
+		"lineComment": "//",
+		"blockComment": [ "/*", "*/" ]
+	},
+	"brackets": [
+		["{", "}"],
+		["[", "]"],
+		["(", ")"]
+	]
+}
\ No newline at end of file

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/package.json
code:
@@ -0,0 +1,34 @@
+{
+    "name": "gitmode",
+    "version": "0.1.0",
+	"publisher": "vscode",
+	"engines": { "vscode": "*" },
+    "contributes": {
+        "languages": [
+            {
+                "id": "git-commit",
+                "aliases": ["Git Commit Message", "git-commit"],
+                "filenames": ["COMMIT_EDITMSG", "MERGE_MSG"],
+                "configuration": "./git-commit.configuration.json"
+            },
+            {
+                "id": "git-rebase",
+                "aliases": ["Git Rebase Message", "git-rebase"],
+                "filenames": ["git-rebase-todo"],
+                "configuration": "./git-rebase.configuration.json"
+            }
+        ],
+        "grammars": [
+            {
+                "language": "git-commit",
+                "scopeName": "text.git-commit",
+                "path": "./syntaxes/git-commit.tmLanguage"
+            },
+            {
+                "language": "git-rebase",
+                "scopeName": "text.git-rebase",
+                "path": "./syntaxes/git-rebase.tmLanguage"
+            }
+        ]
+    }
+}
\ No newline at end of file

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/syntaxes/git-commit.tmLanguage
code:
@@ -0,0 +1,221 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+<plist version="1.0">
+<dict>
+	<key>fileTypes</key>
+	<array>
+		<string>COMMIT_EDITMSG</string>
+		<string>MERGE_MSG</string>
+	</array>
+	<key>foldingStartMarker</key>
+	<string>^\+\+\+</string>
+	<key>foldingStopMarker</key>
+	<string>^---</string>
+	<key>name</key>
+	<string>Git Commit Message</string>
+	<key>patterns</key>
+	<array>
+		<dict>
+			<key>begin</key>
+			<string>\A(?!# Please enter the commit message)</string>
+			<key>end</key>
+			<string>^(?=# Please enter the commit message)</string>
+			<key>name</key>
+			<string>meta.scope.message.git-commit</string>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>begin</key>
+					<string>\A(?=#)</string>
+					<key>end</key>
+					<string>^(?!#)</string>
+					<key>patterns</key>
+					<array>
+						<dict>
+							<key>include</key>
+							<string>#comment</string>
+						</dict>
+					</array>
+				</dict>
+				<dict>
+					<key>begin</key>
+					<string>^(?!# Please enter the commit message)</string>
+					<key>end</key>
+					<string>^(?=# Please enter the commit message)</string>
+					<key>patterns</key>
+					<array>
+						<dict>
+							<key>begin</key>
+							<string>\G</string>
+							<key>end</key>
+							<string>^(?!\G)</string>
+							<key>name</key>
+							<string>meta.scope.subject.git-commit</string>
+							<key>patterns</key>
+							<array>
+								<dict>
+									<key>captures</key>
+									<dict>
+										<key>1</key>
+										<dict>
+											<key>name</key>
+											<string>keyword.other.$2.git-commit</string>
+										</dict>
+									</dict>
+									<key>match</key>
+									<string>\G((fixup|squash)!)\s*</string>
+								</dict>
+								<dict>
+									<key>match</key>
+									<string>.{66,}$</string>
+									<key>name</key>
+									<string>invalid.illegal.line-too-long.git-commit</string>
+								</dict>
+								<dict>
+									<key>match</key>
+									<string>.{51,}$</string>
+									<key>name</key>
+									<string>invalid.deprecated.line-too-long.git-commit</string>
+								</dict>
+							</array>
+						</dict>
+						<dict>
+							<key>begin</key>
+							<string>^(?!# Please enter the commit message)</string>
+							<key>end</key>
+							<string>^(?=# Please enter the commit message)</string>
+							<key>patterns</key>
+							<array>
+								<dict>
+									<key>include</key>
+									<string>#comment</string>
+								</dict>
+							</array>
+						</dict>
+					</array>
+				</dict>
+			</array>
+		</dict>
+		<dict>
+			<key>begin</key>
+			<string>^(?=# Please enter the commit message)</string>
+			<key>end</key>
+			<string>\z</string>
+			<key>name</key>
+			<string>meta.scope.metadata.git-commit</string>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>include</key>
+					<string>#metadata</string>
+				</dict>
+			</array>
+		</dict>
+	</array>
+	<key>repository</key>
+	<dict>
+		<key>comment</key>
+		<dict>
+			<key>begin</key>
+			<string>^(#)</string>
+			<key>captures</key>
+			<dict>
+				<key>1</key>
+				<dict>
+					<key>name</key>
+					<string>punctuation.definition.comment.git-commit</string>
+				</dict>
+			</dict>
+			<key>end</key>
+			<string>\n</string>
+			<key>name</key>
+			<string>comment.line.number-sign.git-commit</string>
+		</dict>
+		<key>metadata</key>
+		<dict>
+			<key>patterns</key>
+			<array>
+				<dict>
+					<key>begin</key>
+					<string>(?=^# Changes to be committed:)</string>
+					<key>end</key>
+					<string>(?!\G)((?=^# \w)|(?!^#))</string>
+					<key>patterns</key>
+					<array>
+						<dict>
+							<key>begin</key>
+							<string>(^[ \t]+)?(?=#)</string>
+							<key>beginCaptures</key>
+							<dict>
+								<key>1</key>
+								<dict>
+									<key>name</key>
+									<string>punctuation.whitespace.comment.leading.git-commit</string>
+								</dict>
+							</dict>
+							<key>contentName</key>
+							<string>comment.line.number-sign.git-commit</string>
+							<key>end</key>
+							<string>(?!\G)^</string>
+							<key>patterns</key>
+							<array>
+								<dict>
+									<key>match</key>
+									<string>\G#</string>
+									<key>name</key>
+									<string>punctuation.definition.comment.git-commit</string>
+								</dict>
+								<dict>
+									<key>match</key>
+									<string>((modified|renamed):.*)$\n?</string>
+									<key>name</key>
+									<string>markup.changed.git-commit</string>
+								</dict>
+								<dict>
+									<key>match</key>
+									<string>(new file:.*)$\n?</string>
+									<key>name</key>
+									<string>markup.inserted.git-commit</string>
+								</dict>
+								<dict>
+									<key>match</key>
+									<string>(deleted:.*)$\n?</string>
+									<key>name</key>
+									<string>markup.deleted.git-commit</string>
+								</dict>
+							</array>
+						</dict>
+					</array>
+				</dict>
+				<dict>
+					<key>include</key>
+					<string>#comment</string>
+				</dict>
+				<dict>
+					<key>begin</key>
+					<string>(?=diff\ \-\-git)</string>
+					<key>comment</key>
+					<string>diff presented at the end of the commit message when using commit -v.</string>
+					<key>contentName</key>
+					<string>source.diff</string>
+					<key>end</key>
+					<string>\z</string>
+					<key>name</key>
+					<string>meta.embedded.diff.git-commit</string>
+					<key>patterns</key>
+					<array>
+						<dict>
+							<key>include</key>
+							<string>source.diff</string>
+						</dict>
+					</array>
+				</dict>
+			</array>
+		</dict>
+	</dict>
+	<key>scopeName</key>
+	<string>text.git-commit</string>
+	<key>uuid</key>
+	<string>BFE83C06-8508-44BE-A975-95A57BF619A7</string>
+</dict>
+</plist>

author:bpasero
date:2016-03-11T15:30:05Z
title:Support git commit message syntax highlighting (fixes #3876)
filename:extensions/git/syntaxes/git-rebase.tmLanguage
code:
@@ -0,0 +1,57 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+<plist version="1.0">
+<dict>
+	<key>fileTypes</key>
+	<array>
+		<string>git-rebase-todo</string>
+	</array>
+	<key>name</key>
+	<string>Git Rebase Message</string>
+	<key>patterns</key>
+	<array>
+		<dict>
+			<key>captures</key>
+			<dict>
+				<key>1</key>
+				<dict>
+					<key>name</key>
+					<string>punctuation.definition.comment.git-rebase</string>
+				</dict>
+			</dict>
+			<key>match</key>
+			<string>^\s*(#).*$\n?</string>
+			<key>name</key>
+			<string>comment.line.number-sign.git-rebase</string>
+		</dict>
+		<dict>
+			<key>captures</key>
+			<dict>
+				<key>1</key>
+				<dict>
+					<key>name</key>
+					<string>support.function.git-rebase</string>
+				</dict>
+				<key>2</key>
+				<dict>
+					<key>name</key>
+					<string>constant.sha.git-rebase</string>
+				</dict>
+				<key>3</key>
+				<dict>
+					<key>name</key>
+					<string>meta.commit-message.git-rebase</string>
+				</dict>
+			</dict>
+			<key>match</key>
+			<string>^\s*(pick|p|reword|r|edit|e|squash|s|fixup|f)\s+([0-9a-f]+)\s+(.*)$</string>
+			<key>name</key>
+			<string>meta.commit-command.git-rebase</string>
+		</dict>
+	</array>
+	<key>scopeName</key>
+	<string>text.git-rebase</string>
+	<key>uuid</key>
+	<string>7F1CC209-5F6D-486A-8180-09FA282381A1</string>
+</dict>
+</plist>

author:bpasero
date:2016-03-15T14:11:21Z
title:[theme] Dark+ and Light+ should support git commit message scopes (fixes #3991)
filename:extensions/theme-defaults/themes/dark_vs.json
code:
@@ -116,6 +116,24 @@
 				"fontStyle": "italic"
 			}
 		},
+		{
+			"scope": "markup.inserted",
+			"settings": {
+				"foreground": "#b5cea8"
+			}
+		},
+		{
+			"scope": "markup.deleted",
+			"settings": {
+				"foreground": "#ce9178"
+			}
+		},
+		{
+			"scope": "markup.changed",
+			"settings": {
+				"foreground": "#569cd6"
+			}
+		},
 		{
 			"scope": "meta.selector",
 			"settings": {

author:bpasero
date:2016-03-15T14:11:21Z
title:[theme] Dark+ and Light+ should support git commit message scopes (fixes #3991)
filename:extensions/theme-defaults/themes/hc_black.json
code:
@@ -104,6 +104,24 @@
 				"fontStyle": "italic"
 			}
 		},
+		{
+			"scope": "markup.inserted",
+			"settings": {
+				"foreground": "#b5cea8"
+			}
+		},
+		{
+			"scope": "markup.deleted",
+			"settings": {
+				"foreground": "#ce9178"
+			}
+		},
+		{
+			"scope": "markup.changed",
+			"settings": {
+				"foreground": "#569cd6"
+			}
+		},
 		{
 			"scope": "meta.selector",
 			"settings": {

author:bpasero
date:2016-03-15T14:11:21Z
title:[theme] Dark+ and Light+ should support git commit message scopes (fixes #3991)
filename:extensions/theme-defaults/themes/light_vs.json
code:
@@ -106,6 +106,24 @@
 				"fontStyle": "italic"
 			}
 		},
+		{
+			"scope": "markup.inserted",
+			"settings": {
+				"foreground": "#09885a"
+			}
+		},
+		{
+			"scope": "markup.deleted",
+			"settings": {
+				"foreground": "#a31515"
+			}
+		},
+		{
+			"scope": "markup.changed",
+			"settings": {
+				"foreground": "#0451a5"
+			}
+		},
 		{
 			"scope": "meta.selector",
 			"settings": {

author:bpasero
date:2016-03-15T13:49:54Z
title:Missing colors in some git-rebase-todo tokens (fixes #4140)
filename:extensions/theme-defaults/themes/dark_vs.json
code:
@@ -241,6 +241,18 @@
 			"settings": {
 				"foreground": "#569cd6"
 			}
+		},
+		{
+			"scope": "support.function.git-rebase",
+			"settings": {
+				"foreground": "#9cdcfe"
+			}
+		},
+		{
+			"scope": "constant.sha.git-rebase",
+			"settings": {
+				"foreground": "#b5cea8"
+			}
 		}
 	]
 }
\ No newline at end of file

author:bpasero
date:2016-03-15T13:49:54Z
title:Missing colors in some git-rebase-todo tokens (fixes #4140)
filename:extensions/theme-defaults/themes/hc_black.json
code:
@@ -223,6 +223,18 @@
 			"settings": {
 				"foreground": "#b5cea8"
 			}
+		},
+		{
+			"scope": "support.function.git-rebase",
+			"settings": {
+				"foreground": "#d4d4d4"
+			}
+		},
+		{
+			"scope": "constant.sha.git-rebase",
+			"settings": {
+				"foreground": "#b5cea8"
+			}
 		}
 	]
 }
\ No newline at end of file

author:bpasero
date:2016-03-15T13:49:54Z
title:Missing colors in some git-rebase-todo tokens (fixes #4140)
filename:extensions/theme-defaults/themes/light_vs.json
code:
@@ -243,6 +243,18 @@
 			"settings": {
 				"foreground": "#800000"
 			}
+		},
+		{
+			"scope": "support.function.git-rebase",
+			"settings": {
+				"foreground": "#0451a5"
+			}
+		},
+		{
+			"scope": "constant.sha.git-rebase",
+			"settings": {
+				"foreground": "#09885a"
+			}
 		}
 	]
 }
\ No newline at end of file

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -29,10 +29,12 @@ import {IWorkbenchEditorService} from 'vs/workbench/services/editor/common/edito
 import {IConfigurationService, ConfigurationServiceEventTypes} from 'vs/platform/configuration/common/configuration';
 import {IEventService} from 'vs/platform/event/common/event';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
-import {IMessageService} from 'vs/platform/message/common/message';
+import {IMessageService, CancelAction} from 'vs/platform/message/common/message';
 import {IWorkspaceContextService} from 'vs/platform/workspace/common/workspace';
 import {ILifecycleService} from 'vs/platform/lifecycle/common/lifecycle';
 import URI from 'vs/base/common/uri';
+import * as semver from 'semver';
+import { shell } from 'electron';
 
 function toReadablePath(path: string): string {
 	if (!platform.isWindows) {
@@ -427,6 +429,23 @@ export class GitService extends ee.EventEmitter
 		this.inputCache = this.instantiationService.createInstance(EditorInputCache, this);
 
 		this.triggerStatus(true); // trigger initial status
+
+		this.raw.getVersion().done(version => {
+			version = semver.valid(version);
+
+			if (version && semver.satisfies(version, '<2.0.0')) {
+				messageService.show(severity.Warning, {
+					message: nls.localize('updateGit', "You seem to have git {0} installed. Code works best with git >=2.0.0.", version),
+					actions: [
+						CancelAction,
+						new actions.Action('downloadLatest', nls.localize('download', "Download"), '', true, () => {
+							shell.openExternal('https://git-scm.com/');
+							return null;
+						})
+					]
+				});
+			}
+		});
 	}
 
 	private registerListeners():void {

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -258,6 +258,7 @@ export interface IPushOptions {
 }
 
 export interface IRawGitService {
+	getVersion(): WinJS.TPromise<string>;
 	serviceState(): WinJS.TPromise<RawServiceState>;
 	status(): WinJS.TPromise<IRawStatus>;
 	init(): WinJS.TPromise<IRawStatus>;

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -5,7 +5,7 @@
 'use strict';
 
 import git = require('vs/workbench/parts/git/common/git');
-import winjs = require('vs/base/common/winjs.base');
+import { Promise, TPromise } from 'vs/base/common/winjs.base';
 
 export class NoOpGitService implements git.IRawGitService {
 	private static STATUS:git.IRawStatus = {
@@ -18,79 +18,83 @@ export class NoOpGitService implements git.IRawGitService {
 		remotes: []
 	};
 
-	public serviceState(): winjs.TPromise<git.RawServiceState> {
-		return winjs.TPromise.as(git.RawServiceState.OK);
+	getVersion(): TPromise<string> {
+		return TPromise.as(null);
 	}
 
-	public status(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public serviceState(): TPromise<git.RawServiceState> {
+		return TPromise.as(git.RawServiceState.OK);
 	}
 
-	public init(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public status(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public add(filesPaths?: string[]): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public init(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public stage(filePath: string, content: string): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public add(filesPaths?: string[]): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public branch(name: string, checkout?: boolean): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public stage(filePath: string, content: string): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public checkout(treeish?: string, filePaths?: string[]): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public branch(name: string, checkout?: boolean): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public clean(filePaths: string[]): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public checkout(treeish?: string, filePaths?: string[]): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public undo(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public clean(filePaths: string[]): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public reset(treeish: string, hard?: boolean): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public undo(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public revertFiles(treeish: string, filePaths?: string[]): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public reset(treeish: string, hard?: boolean): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public fetch(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public revertFiles(treeish: string, filePaths?: string[]): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public pull(rebase?: boolean): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public fetch(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public push(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public pull(rebase?: boolean): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public sync(): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public push(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public commit(message: string, amend?: boolean, stage?: boolean): winjs.TPromise<git.IRawStatus> {
-		return winjs.TPromise.as(NoOpGitService.STATUS);
+	public sync(): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public detectMimetypes(path: string, treeish?: string): winjs.TPromise<string[]> {
-		return winjs.TPromise.as([]);
+	public commit(message: string, amend?: boolean, stage?: boolean): TPromise<git.IRawStatus> {
+		return TPromise.as(NoOpGitService.STATUS);
 	}
 
-	public show(path: string, treeish?: string): winjs.TPromise<string> {
-		return winjs.TPromise.as(null);
+	public detectMimetypes(path: string, treeish?: string): TPromise<string[]> {
+		return TPromise.as([]);
 	}
 
-	public onOutput(): winjs.Promise {
-		return winjs.TPromise.as(()=><any>null);
+	public show(path: string, treeish?: string): TPromise<string> {
+		return TPromise.as(null);
+	}
+
+	public onOutput(): Promise {
+		return TPromise.as(() => null);
 	}
 }
\ No newline at end of file

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { Promise, TPromise } from 'vs/base/common/winjs.base';
+import { TPromise } from 'vs/base/common/winjs.base';
 import { RawServiceState } from 'vs/workbench/parts/git/common/git';
 import { NoOpGitService } from 'vs/workbench/parts/git/common/noopGitService';
 import { GitService } from 'vs/workbench/parts/git/browser/gitServices';
@@ -22,25 +22,47 @@ import { spawn, exec } from 'child_process';
 import { join } from 'path';
 import { remote } from 'electron';
 
-function findSpecificGit(gitPath: string): Promise {
-	return new Promise((c, e) => {
-		var child = spawn(gitPath, ['--version']);
+interface IGit {
+	path: string;
+	version: string;
+}
+
+function parseVersion(raw: string): string {
+	return raw.replace(/^git version /, '');
+}
+
+function findSpecificGit(path: string): TPromise<IGit> {
+	return new TPromise<IGit>((c, e) => {
+		const buffers: Buffer[] = [];
+		const child = spawn(path, ['--version']);
+		child.stdout.on('data', b => buffers.push(b));
 		child.on('error', e);
-		child.on('exit', (code: number) => code ? e(new Error('Not found')) : c(gitPath));
+		child.on('exit', code => code ? e(new Error('Not found')) : c({ path, version: parseVersion(Buffer.concat(buffers).toString('utf8').trim()) }));
 	});
 }
 
-function findGitDarwin(): Promise {
-	return new Promise((c, e) => {
+function findGitDarwin(): TPromise<IGit> {
+	return new TPromise<IGit>((c, e) => {
 		exec('which git', (err, gitPathBuffer) => {
 			if (err) {
 				return e('git not found');
 			}
 
-			let gitPath = gitPathBuffer.toString().replace(/^\s+|\s+$/g, '');
+			const path = gitPathBuffer.toString().replace(/^\s+|\s+$/g, '');
+
+			function getVersion(path: string) {
+				// make sure git executes
+				exec('git --version', (err, stdout) => {
+					if (err) {
+						return e('git not found');
+					}
+
+					return c({ path, version: parseVersion(stdout.toString('utf8').trim()) });
+				});
+			}
 
-			if (gitPath !== '/usr/bin/git')	{
-				return c(gitPath);
+			if (path !== '/usr/bin/git')	{
+				return getVersion(path);
 			}
 
 			// must check if XCode is installed
@@ -52,36 +74,29 @@ function findGitDarwin(): Promise {
 					return e('git not found');
 				}
 
-				// make sure git executes
-				exec('git --version', err => {
-					if (err) {
-						return e('git not found');
-					}
-
-					return c(gitPath);
-				});
+				getVersion(path);
 			});
 		});
 	});
 }
 
-function findSystemGitWin32(base: string): Promise {
+function findSystemGitWin32(base: string): TPromise<IGit> {
 	if (!base) {
-		return Promise.wrapError('Not found');
+		return TPromise.wrapError('Not found');
 	}
 
 	return findSpecificGit(join(base, 'Git', 'cmd', 'git.exe'));
 }
 
-function findGitWin32(): Promise {
+function findGitWin32(): TPromise<IGit> {
 	return findSystemGitWin32(process.env['ProgramW6432'])
 		.then(null, () => findSystemGitWin32(process.env['ProgramFiles(x86)']))
 		.then(null, () => findSystemGitWin32(process.env['ProgramFiles']))
 		.then(null, () => findSpecificGit('git'));
 }
 
-function findGit(hint: string): Promise {
-	var first = hint ? findSpecificGit(hint) : Promise.wrapError(null);
+function findGit(hint: string): TPromise<IGit> {
+	var first = hint ? findSpecificGit(hint) : TPromise.wrapError(null);
 
 	return first.then(null, () => {
 		switch (process.platform) {
@@ -108,14 +123,14 @@ class DisabledRawGitService extends RawGitService {
 	}
 }
 
-export function createNativeRawGitService(workspaceRoot: string, gitPath: string, defaultEncoding: string): Promise {
-	return findGit(gitPath).then(gitPath => {
+function createNativeRawGitService(workspaceRoot: string, path: string, defaultEncoding: string): TPromise<RawGitService> {
+	return findGit(path).then(({ path, version }) => {
 		const client = new Client(
 			URI.parse(require.toUrl('bootstrap')).fsPath,
 			{
 				serverName: 'Git',
 				timeout: 1000 * 60,
-				args: [gitPath, workspaceRoot, defaultEncoding, remote.process.execPath],
+				args: [path, workspaceRoot, defaultEncoding, remote.process.execPath, version],
 				env: {
 					ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
 					AMD_ENTRYPOINT: 'vs/workbench/parts/git/electron-browser/gitApp'

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -17,7 +17,7 @@ import { realpath } from 'vs/base/node/pfs';
 
 class IPCRawGitService extends DelayedRawGitService {
 
-	constructor(gitPath: string, workspaceRoot: string, defaultEncoding: string, exePath: string) {
+	constructor(gitPath: string, workspaceRoot: string, defaultEncoding: string, exePath: string, version: string) {
 		if (!gitPath) {
 			super(TPromise.as(new RawGitService(null)));
 		} else {
@@ -33,7 +33,7 @@ class IPCRawGitService extends DelayedRawGitService {
 			});
 
 			const git = new gitlib.Git({
-				gitPath: gitPath,
+				gitPath, version,
 				tmpPath: tmpdir(),
 				defaultEncoding: defaultEncoding,
 				env: env
@@ -58,4 +58,4 @@ class IPCRawGitService extends DelayedRawGitService {
 }
 
 const server = new Server();
-server.registerService('GitService', new IPCRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5]));
\ No newline at end of file
+server.registerService('GitService', new IPCRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5], process.argv[6]));
\ No newline at end of file

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -117,6 +117,7 @@ export class GitError {
 
 export interface IGitOptions {
 	gitPath:string;
+	version: string;
 	tmpPath:string;
 	defaultEncoding?: string;
 	env?:any;
@@ -125,13 +126,15 @@ export interface IGitOptions {
 export class Git {
 
 	public gitPath: string;
+	public version: string;
 	public env: any;
 	private tmpPath: string;
 	private defaultEncoding: string;
 	private outputListeners: { (output: string): void; }[];
 
 	constructor(options: IGitOptions) {
 		this.gitPath = options.gitPath;
+		this.version = options.version;
 		this.tmpPath = options.tmpPath;
 
 		const encoding = options.defaultEncoding || 'utf8';
@@ -268,6 +271,10 @@ export class Repository {
 		this.env = env;
 	}
 
+	public get version(): string {
+		return this.git.version;
+	}
+
 	public get path(): string {
 		return this.repository;
 	}

author:joaomoreno
date:2016-03-16T17:11:28Z
title:warn users about git <2.0.0

fixes #4214
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -20,6 +20,10 @@ export class RawGitService implements IRawGitService {
 		this.repo = repo;
 	}
 
+	getVersion(): TPromise<string> {
+		return TPromise.as(this.repo.version);
+	}
+
 	private getRepositoryRoot(): TPromise<string> {
 		return this._repositoryRoot || (this._repositoryRoot = pfs.realpath(this.repo.path));
 	}
@@ -179,6 +183,10 @@ export class DelayedRawGitService implements IRawGitService {
 
 	constructor(private raw: TPromise<IRawGitService>) { }
 
+	getVersion(): TPromise<string> {
+		return this.raw.then(raw => raw.getVersion());
+	}
+
 	public serviceState(): TPromise<RawServiceState> {
 		return this.raw.then(raw => raw.serviceState());
 	}

author:joaomoreno
date:2016-03-29T12:32:45Z
title:git version might not be semver

fixes #4214
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -431,6 +431,8 @@ export class GitService extends ee.EventEmitter
 		this.triggerStatus(true); // trigger initial status
 
 		this.raw.getVersion().done(version => {
+			version = version || '';
+			version = version.replace(/^(\d+\.\d+\.\d+).*$/, '$1');
 			version = semver.valid(version);
 
 			if (version && semver.satisfies(version, '<2.0.0')) {

author:dbaeumer
date:2016-03-30T11:07:59Z
title:Locking ghooks version due to https://github.com/gtramontina/ghooks/issues/63
filename:package.json
code:
@@ -43,7 +43,7 @@
     "documentdb": "^1.5.1",
     "event-stream": "^3.1.7",
     "express": "^4.13.1",
-    "ghooks": "^1.0.1",
+    "ghooks": "1.0.3",
     "glob": "^5.0.13",
     "gulp": "^3.8.9",
     "gulp-atom-electron": "^1.5.2",

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/styleMutator.ts
code:
@@ -4,6 +4,205 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
+import * as dom from 'vs/base/browser/dom';
+
+export abstract class FastDomNode {
+
+	private _domNode: HTMLElement;
+	private _maxWidth: number;
+	private _width: number;
+	private _height: number;
+	private _top: number;
+	private _left: number;
+	private _bottom: number;
+	private _right: number;
+	private _fontSize: number;
+	private _lineHeight: number;
+	private _className: string;
+	private _display: string;
+	private _position: string;
+	private _visibility: string;
+	private _transform: string;
+	private _lineNumber: string;
+
+	public get domNode(): HTMLElement {
+		return this._domNode;
+	}
+
+	constructor(domNode: HTMLElement) {
+		this._domNode = domNode;
+		this._maxWidth = -1;
+		this._width = -1;
+		this._height = -1;
+		this._top = -1;
+		this._left = -1;
+		this._bottom = -1;
+		this._right = -1;
+		this._fontSize = -1;
+		this._lineHeight = -1;
+		this._className = '';
+		this._display = '';
+		this._position = '';
+		this._visibility = '';
+		this._transform = '';
+		this._lineNumber = '';
+	}
+
+	public setMaxWidth(maxWidth: number): void {
+		if (this._maxWidth === maxWidth) {
+			return;
+		}
+		this._maxWidth = maxWidth;
+		this._domNode.style.maxWidth = this._maxWidth + 'px';
+	}
+
+	public setWidth(width: number): void {
+		if (this._width === width) {
+			return;
+		}
+		this._width = width;
+		this._domNode.style.width = this._width + 'px';
+	}
+
+	public setHeight(height: number): void {
+		if (this._height === height) {
+			return;
+		}
+		this._height = height;
+		this._domNode.style.height = this._height + 'px';
+	}
+
+	public setTop(top: number): void {
+		if (this._top === top) {
+			return;
+		}
+		this._top = top;
+		this._domNode.style.top = this._top + 'px';
+	}
+
+	public setLeft(left: number): void {
+		if (this._left === left) {
+			return;
+		}
+		this._left = left;
+		this._domNode.style.left = this._left + 'px';
+	}
+
+	public setBottom(bottom: number): void {
+		if (this._bottom === bottom) {
+			return;
+		}
+		this._bottom = bottom;
+		this._domNode.style.bottom = this._bottom + 'px';
+	}
+
+	public setRight(right: number): void {
+		if (this._right === right) {
+			return;
+		}
+		this._right = right;
+		this._domNode.style.right = this._right + 'px';
+	}
+
+	public setFontSize(fontSize: number): void {
+		if (this._fontSize === fontSize) {
+			return;
+		}
+		this._fontSize = fontSize;
+		this._domNode.style.fontSize = this._fontSize + 'px';
+	}
+
+	public setLineHeight(lineHeight: number): void {
+		if (this._lineHeight === lineHeight) {
+			return;
+		}
+		this._lineHeight = lineHeight;
+		this._domNode.style.lineHeight = this._lineHeight + 'px';
+	}
+
+	public setClassName(className: string): void {
+		if (this._className === className) {
+			return;
+		}
+		this._className = className;
+		this._domNode.className = this._className;
+	}
+
+	public toggleClassName(className: string, shouldHaveIt?: boolean): void {
+		dom.toggleClass(this._domNode, className, shouldHaveIt);
+		this._className = this._domNode.className;
+	}
+
+	public setDisplay(display: string): void {
+		if (this._display === display) {
+			return;
+		}
+		this._display = display;
+		this._domNode.style.display = this._display;
+	}
+
+	public setPosition(position: string): void {
+		if (this._position === position) {
+			return;
+		}
+		this._position = position;
+		this._domNode.style.position = this._position;
+	}
+
+	public setVisibility(visibility: string): void {
+		if (this._visibility === visibility) {
+			return;
+		}
+		this._visibility = visibility;
+		this._domNode.style.visibility = this._visibility;
+	}
+
+	public setTransform(transform:string): void {
+		if (this._transform === transform) {
+			return;
+		}
+		this._transform = transform;
+		this._setTransform(this._domNode, this._transform);
+	}
+
+	protected abstract _setTransform(domNode:HTMLElement, transform:string): void;
+
+	public setLineNumber(lineNumber:string): void {
+		if (this._lineNumber === lineNumber) {
+			return;
+		}
+		this._lineNumber = lineNumber;
+		this._domNode.setAttribute('lineNumber', this._lineNumber);
+	}
+}
+
+class WebKitFastDomNode extends FastDomNode {
+	protected _setTransform(domNode:HTMLElement, transform:string): void {
+		(<any>domNode.style).webkitTransform = transform;
+	}
+}
+
+class StandardFastDomNode extends FastDomNode {
+	protected _setTransform(domNode:HTMLElement, transform:string): void {
+		domNode.style.transform = transform;
+	}
+}
+
+let useWebKitFastDomNode = false;
+(function() {
+	let testDomNode = document.createElement('div');
+	if (typeof (<any>testDomNode.style).webkitTransform !== 'undefined') {
+		useWebKitFastDomNode = true;
+	}
+})();
+export function createFastDomNode(domNode: HTMLElement): FastDomNode {
+	if (useWebKitFastDomNode) {
+		return new WebKitFastDomNode(domNode);
+	} else {
+		return new StandardFastDomNode(domNode);
+	}
+}
+
 export const StyleMutator = {
 	setMaxWidth: (domNode: HTMLElement, maxWidth: number) => {
 		let desiredValue = maxWidth + 'px';
@@ -27,13 +226,17 @@ export const StyleMutator = {
 		let desiredValue = top + 'px';
 		if (domNode.style.top !== desiredValue) {
 			domNode.style.top = desiredValue;
+			return true;
 		}
+		return false;
 	},
 	setLeft: (domNode: HTMLElement, left: number) => {
 		let desiredValue = left + 'px';
 		if (domNode.style.left !== desiredValue) {
 			domNode.style.left = desiredValue;
+			return true;
 		}
+		return false;
 	},
 	setBottom: (domNode: HTMLElement, bottom: number) => {
 		let desiredValue = bottom + 'px';
@@ -73,17 +276,21 @@ export const StyleMutator = {
 };
 
 // Define setTransform
-function setWebkitTransform(domNode: HTMLElement, desiredValue: string): void {
+function setWebkitTransform(domNode: HTMLElement, desiredValue: string): boolean {
 	if (domNode.getAttribute('data-transform') !== desiredValue) {
 		domNode.setAttribute('data-transform', desiredValue);
 		(<any>domNode.style).webkitTransform = desiredValue;
+		return true;
 	}
+	return false;
 }
-function setTransform(domNode: HTMLElement, desiredValue: string): void {
+function setTransform(domNode: HTMLElement, desiredValue: string): boolean {
 	if (domNode.getAttribute('data-transform') !== desiredValue) {
 		domNode.setAttribute('data-transform', desiredValue);
 		domNode.style.transform = desiredValue;
+		return true;
 	}
+	return false;
 }
 (function() {
 	let testDomNode = document.createElement('div');

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/list/listView.ts
code:
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { IScrollable } from 'vs/base/common/scrollable';
+import { IScrollable, ScrollEvent } from 'vs/base/common/scrollable';
 import { Emitter } from 'vs/base/common/event';
 import { toObject, assign } from 'vs/base/common/objects';
 import { IDisposable, dispose } from 'vs/base/common/lifecycle';
@@ -16,11 +16,6 @@ import { IDelegate, IRenderer } from './list';
 import { RowCache, IRow } from './rowCache';
 import { LcsDiff, ISequence } from 'vs/base/common/diff/diff';
 
-interface IScrollEvent {
-	vertical: boolean;
-	horizontal: boolean;
-}
-
 interface IItemRange<T> {
 	item: IItem<T>;
 	index: number;
@@ -68,7 +63,7 @@ export class ListView<T> implements IScrollable, IDisposable {
 	private rowsContainer: HTMLElement;
 	private scrollableElement: IScrollableElement;
 
-	private _onScroll = new Emitter<IScrollEvent>();
+	private _onScroll = new Emitter<ScrollEvent>();
 
 	private toDispose: IDisposable[];
 
@@ -94,9 +89,8 @@ export class ListView<T> implements IScrollable, IDisposable {
 		this.rowsContainer.className = 'monaco-list-rows';
 		this.gesture = new Gesture(this.rowsContainer);
 
-		this.scrollableElement = new ScrollableElement(this.rowsContainer, {
+		this.scrollableElement = new ScrollableElement(this.rowsContainer, this, {
 			forbidTranslate3dUse: true,
-			scrollable: this,
 			horizontal: 'hidden',
 			vertical: 'auto',
 			useShadows: false,
@@ -144,7 +138,7 @@ export class ListView<T> implements IScrollable, IDisposable {
 
 		this.rowsContainer.style.height = `${ this.rangeMap.size }px`;
 		this.setScrollTop(this.renderTop);
-		this.scrollableElement.onElementInternalDimensions();
+		this._emitScrollEvent(false, false);
 
 		return deleted.map(i => i.element);
 	}
@@ -181,7 +175,7 @@ export class ListView<T> implements IScrollable, IDisposable {
 		this.setRenderHeight(height || DOM.getContentHeight(this._domNode));
 		this.setScrollTop(this.renderTop);
 		this.scrollableElement.onElementDimensions();
-		this.scrollableElement.onElementInternalDimensions();
+		this._emitScrollEvent(false, false);
 	}
 
 	// Render
@@ -292,10 +286,21 @@ export class ListView<T> implements IScrollable, IDisposable {
 		this.render(scrollTop, this._renderHeight);
 		this.renderTop = scrollTop;
 
-		this._onScroll.fire({ vertical: true, horizontal: false });
+		this._emitScrollEvent(true, false);
+	}
+
+	private _emitScrollEvent(vertical:boolean, horizontal:boolean): void {
+		this._onScroll.fire(new ScrollEvent(
+			this.getScrollTop(),
+			this.getScrollLeft(),
+			this.getScrollWidth(),
+			this.getScrollHeight(),
+			vertical,
+			horizontal
+		));
 	}
 
-	addScrollListener(callback: ()=>void): IDisposable {
+	addScrollListener(callback: (v:ScrollEvent)=>void): IDisposable {
 		return this._onScroll.event(callback);
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/resourceviewer/resourceViewer.ts
code:
@@ -12,7 +12,7 @@ import URI from 'vs/base/common/uri';
 import paths = require('vs/base/common/paths');
 import {Builder, $} from 'vs/base/browser/builder';
 import DOM = require('vs/base/browser/dom');
-import {IScrollableElement} from 'vs/base/browser/ui/scrollbar/scrollableElement';
+import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 
 // Known media mimes that we can handle
 const mapExtToMediaMimes = {
@@ -69,7 +69,7 @@ const mapExtToMediaMimes = {
  */
 export class ResourceViewer {
 
-	public static show(name: string, resource: URI, container: Builder, scrollbar?: IScrollableElement): void {
+	public static show(name: string, resource: URI, container: Builder, scrollable?: DomNodeScrollable): void {
 
 		// Ensure CSS class
 		$(container).addClass('monaco-resource-viewer');
@@ -93,8 +93,8 @@ export class ResourceViewer {
 				.img({
 					src: resource.toString() + '?' + new Date().getTime() // We really want to avoid the browser from caching this resource, so we add a fake query param that is unique
 				}).on(DOM.EventType.LOAD, () => {
-					if (scrollbar) {
-						scrollbar.onElementInternalDimensions();
+					if (scrollable) {
+						scrollable.onContentsDimensions();
 					}
 				});
 		}
@@ -124,8 +124,8 @@ export class ResourceViewer {
 					text: nls.localize('missingAudioSupport', "Sorry but playback of audio files is not supported."),
 					controls: 'controls'
 				}).on(DOM.EventType.LOAD, () => {
-					if (scrollbar) {
-						scrollbar.onElementInternalDimensions();
+					if (scrollable) {
+						scrollable.onContentsDimensions();
 					}
 				});
 		}
@@ -141,8 +141,8 @@ export class ResourceViewer {
 					text: nls.localize('missingVideoSupport', "Sorry but playback of video files is not supported."),
 					controls: 'controls'
 				}).on(DOM.EventType.LOAD, () => {
-					if (scrollbar) {
-						scrollbar.onElementInternalDimensions();
+					if (scrollable) {
+						scrollable.onContentsDimensions();
 					}
 				});
 		}
@@ -156,8 +156,8 @@ export class ResourceViewer {
 					text: nls.localize('nativeBinaryError', "The file cannot be displayed in the editor because it is either binary, very large or uses an unsupported text encoding.")
 				});
 
-			if (scrollbar) {
-				scrollbar.onElementInternalDimensions();
+			if (scrollable) {
+				scrollable.onContentsDimensions();
 			}
 		}
 	}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/abstractScrollbar.ts
code:
@@ -13,6 +13,7 @@ import {Disposable} from 'vs/base/common/lifecycle';
 import {GlobalMouseMoveMonitor, IStandardMouseMoveEventData, standardMouseMoveMerger} from 'vs/base/browser/globalMouseMoveMonitor';
 import {Widget} from 'vs/base/browser/ui/widget';
 import {TimeoutTimer, IntervalTimer} from 'vs/base/common/async';
+import {FastDomNode, createFastDomNode} from 'vs/base/browser/styleMutator';
 
 /**
  * The arrow image size.
@@ -72,76 +73,104 @@ export class ScrollbarState {
 	private _computedSliderPosition: number;
 
 	constructor(arrowSize: number, scrollbarSize: number, oppositeScrollbarSize: number) {
+		this._scrollbarSize = Math.round(scrollbarSize);
+		this._oppositeScrollbarSize = Math.round(oppositeScrollbarSize);
+		this._arrowSize = Math.round(arrowSize);
+
 		this._visibleSize = 0;
 		this._scrollSize = 0;
 		this._scrollPosition = 0;
-		this._scrollbarSize = scrollbarSize;
-		this._oppositeScrollbarSize = oppositeScrollbarSize;
-		this._arrowSize = arrowSize;
+
+		this._computedAvailableSize = 0;
+		this._computedRepresentableSize = 0;
+		this._computedRatio = 0.1;
+		this._computedIsNeeded = false;
+		this._computedSliderSize = 0;
+		this._computedSliderPosition = 0;
+
 		this._refreshComputedValues();
 	}
 
 	public setVisibleSize(visibleSize: number): boolean {
-		if (this._visibleSize !== visibleSize) {
-			this._visibleSize = visibleSize;
+		let iVisibleSize = Math.round(visibleSize);
+		if (this._visibleSize !== iVisibleSize) {
+			this._visibleSize = iVisibleSize;
 			this._refreshComputedValues();
 			return true;
 		}
 		return false;
 	}
 
 	public setScrollSize(scrollSize: number): boolean {
-		if (this._scrollSize !== scrollSize) {
-			this._scrollSize = scrollSize;
+		let iScrollSize = Math.round(scrollSize);
+		if (this._scrollSize !== iScrollSize) {
+			this._scrollSize = iScrollSize;
 			this._refreshComputedValues();
 			return true;
 		}
 		return false;
 	}
 
 	public setScrollPosition(scrollPosition: number): boolean {
-		if (this._scrollPosition !== scrollPosition) {
-			this._scrollPosition = scrollPosition;
+		let iScrollPosition = Math.round(scrollPosition);
+		if (this._scrollPosition !== iScrollPosition) {
+			this._scrollPosition = iScrollPosition;
 			this._refreshComputedValues();
 			return true;
 		}
 		return false;
 	}
 
 	private _refreshComputedValues(): void {
-		this._computedAvailableSize = Math.max(0, this._visibleSize - this._oppositeScrollbarSize);
-		this._computedRepresentableSize = Math.max(0, this._computedAvailableSize - 2 * this._arrowSize);
-		this._computedRatio = this._scrollSize > 0 ? (this._computedRepresentableSize / this._scrollSize) : 0;
-		this._computedIsNeeded = (this._scrollSize > this._visibleSize);
-
-		if (!this._computedIsNeeded) {
-			this._computedSliderSize = this._computedRepresentableSize;
-			this._computedSliderPosition = 0;
+		const oppositeScrollbarSize = this._oppositeScrollbarSize;
+		const arrowSize = this._arrowSize;
+		const visibleSize = this._visibleSize;
+		const scrollSize = this._scrollSize;
+		const scrollPosition = this._scrollPosition;
+
+		let computedAvailableSize = Math.max(0, visibleSize - oppositeScrollbarSize);
+		let computedRepresentableSize = Math.max(0, computedAvailableSize - 2 * arrowSize);
+		let computedRatio = scrollSize > 0 ? (computedRepresentableSize / scrollSize) : 0;
+		let computedIsNeeded = (scrollSize > visibleSize);
+
+		let computedSliderSize: number;
+		let computedSliderPosition: number;
+
+		if (!computedIsNeeded) {
+			computedSliderSize = computedRepresentableSize;
+			computedSliderPosition = 0;
 		} else {
-			this._computedSliderSize = Math.floor(this._visibleSize * this._computedRatio);
-			this._computedSliderPosition = Math.floor(this._scrollPosition * this._computedRatio);
+			computedSliderSize = Math.floor(visibleSize * computedRatio);
+			computedSliderPosition = Math.floor(scrollPosition * computedRatio);
 
-			if (this._computedSliderSize < MINIMUM_SLIDER_SIZE) {
+			if (computedSliderSize < MINIMUM_SLIDER_SIZE) {
 				// We must artificially increase the size of the slider, since the slider would be too small otherwise
 				// The effort is to keep the slider centered around the original position, but we must take into
 				// account the cases when the slider is too close to the top or too close to the bottom
 
-				let sliderArtificialOffset = (MINIMUM_SLIDER_SIZE - this._computedSliderSize) / 2;
-				this._computedSliderSize = MINIMUM_SLIDER_SIZE;
+				let sliderArtificialOffset = (MINIMUM_SLIDER_SIZE - computedSliderSize) / 2;
+				computedSliderSize = MINIMUM_SLIDER_SIZE;
 
-				this._computedSliderPosition -= sliderArtificialOffset;
+				computedSliderPosition -= sliderArtificialOffset;
 
-				if (this._computedSliderPosition + this._computedSliderSize > this._computedRepresentableSize) {
+				if (computedSliderPosition + computedSliderSize > computedRepresentableSize) {
 					// Slider is too close to the bottom, so we glue it to the bottom
-					this._computedSliderPosition = this._computedRepresentableSize - this._computedSliderSize;
+					computedSliderPosition = computedRepresentableSize - computedSliderSize;
 				}
 
-				if (this._computedSliderPosition < 0) {
+				if (computedSliderPosition < 0) {
 					// Slider is too close to the top, so we glue it to the top
-					this._computedSliderPosition = 0;
+					computedSliderPosition = 0;
 				}
 			}
 		}
+
+		this._computedAvailableSize = Math.round(computedAvailableSize);
+		this._computedRepresentableSize = Math.round(computedRepresentableSize);
+		this._computedRatio = computedRatio;
+		this._computedIsNeeded = computedIsNeeded;
+		this._computedSliderSize = Math.round(computedSliderSize);
+		this._computedSliderPosition = Math.round(computedSliderPosition);
 	}
 
 	public getArrowSize(): number {
@@ -247,7 +276,7 @@ class VisibilityController extends Disposable {
 	private _visibility: Visibility;
 	private _visibleClassName: string;
 	private _invisibleClassName: string;
-	private _domNode: HTMLElement;
+	private _domNode: FastDomNode;
 	private _shouldBeVisible: boolean;
 	private _isNeeded: boolean;
 	private _isVisible: boolean;
@@ -293,9 +322,9 @@ class VisibilityController extends Disposable {
 		}
 	}
 
-	public setDomNode(domNode: HTMLElement): void {
+	public setDomNode(domNode: FastDomNode): void {
 		this._domNode = domNode;
-		this._domNode.className = this._invisibleClassName;
+		this._domNode.setClassName(this._invisibleClassName);
 
 		// Now that the flags & the dom node are in a consistent state, ensure the Hidden/Visible configuration
 		this.setShouldBeVisible(false);
@@ -325,7 +354,7 @@ class VisibilityController extends Disposable {
 
 		// The CSS animation doesn't play otherwise
 		this._revealTimer.setIfNotSet(() => {
-			this._domNode.className = this._visibleClassName;
+			this._domNode.setClassName(this._visibleClassName);
 		}, 0);
 	}
 
@@ -335,7 +364,7 @@ class VisibilityController extends Disposable {
 			return;
 		}
 		this._isVisible = false;
-		this._domNode.className = this._invisibleClassName + (withFadeAway ? ' fade' : '');
+		this._domNode.setClassName(this._invisibleClassName + (withFadeAway ? ' fade' : ''));
 	}
 }
 
@@ -348,21 +377,26 @@ export interface IMouseMoveEventData {
 export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 
 	protected _forbidTranslate3dUse: boolean;
+	private _lazyRender: boolean;
 	private _parent: IParent;
 	private _scrollbarState: ScrollbarState;
 	private _visibilityController: VisibilityController;
 	private _mouseMoveMonitor: GlobalMouseMoveMonitor<IStandardMouseMoveEventData>;
 
-	public domNode: HTMLElement;
-	public slider: HTMLElement;
+	public domNode: FastDomNode;
+	public slider: FastDomNode;
 
-	constructor(forbidTranslate3dUse: boolean, parent: IParent, scrollbarState: ScrollbarState, visibility: Visibility, extraScrollbarClassName: string) {
+	protected _shouldRender: boolean;
+
+	constructor(forbidTranslate3dUse: boolean, lazyRender:boolean, parent: IParent, scrollbarState: ScrollbarState, visibility: Visibility, extraScrollbarClassName: string) {
 		super();
 		this._forbidTranslate3dUse = forbidTranslate3dUse;
+		this._lazyRender = lazyRender;
 		this._parent = parent;
 		this._scrollbarState = scrollbarState;
 		this._visibilityController = this._register(new VisibilityController(visibility, 'visible scrollbar ' + extraScrollbarClassName, 'invisible scrollbar ' + extraScrollbarClassName));
 		this._mouseMoveMonitor = this._register(new GlobalMouseMoveMonitor<IStandardMouseMoveEventData>());
+		this._shouldRender = true;
 	}
 
 	// ----------------- initialize & clean-up
@@ -371,63 +405,77 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 	 * Creates the container dom node for the scrollbar & hooks up the events
 	 */
 	protected _createDomNode(): void {
-		this.domNode = document.createElement('div');
+		this.domNode = createFastDomNode(document.createElement('div'));
 		if (!this._forbidTranslate3dUse && Browser.canUseTranslate3d) {
-			// Put the worker reporter in its own layer
-			this.domNode.style.transform = 'translate3d(0px, 0px, 0px)';
+			// Put the scrollbar in its own layer
+			this.domNode.setTransform('translate3d(0px, 0px, 0px)');
 		}
 
 		this._visibilityController.setDomNode(this.domNode);
-		this.domNode.style.position = 'absolute';
+		this.domNode.setPosition('absolute');
 
-		this.onmousedown(this.domNode, (e) => this._domNodeMouseDown(e));
+		this.onmousedown(this.domNode.domNode, (e) => this._domNodeMouseDown(e));
 	}
 
 	/**
 	 * Creates the dom node for an arrow & adds it to the container
 	 */
 	protected _createArrow(className: string, top: number, left: number, bottom: number, right: number, bgWidth: number, bgHeight: number, mouseWheelEventFactory: IMouseWheelEventFactory): void {
 		let arrow = this._register(new ScrollbarArrow(className, top, left, bottom, right, bgWidth, bgHeight, mouseWheelEventFactory, this._parent));
-		this.domNode.appendChild(arrow.bgDomNode);
-		this.domNode.appendChild(arrow.domNode);
+		this.domNode.domNode.appendChild(arrow.bgDomNode);
+		this.domNode.domNode.appendChild(arrow.domNode);
 	}
 
 	/**
 	 * Creates the slider dom node, adds it to the container & hooks up the events
 	 */
 	protected _createSlider(top: number, left: number, width: number, height: number): void {
-		this.slider = document.createElement('div');
-		this.slider.className = 'slider';
-		this.slider.style.position = 'absolute';
-		setPosition(this.slider, top, left, null, null);
-		setSize(this.slider, width, height);
-		this.domNode.appendChild(this.slider);
+		this.slider = createFastDomNode(document.createElement('div'));
+		this.slider.setClassName('slider');
+		this.slider.setPosition('absolute');
+		this.slider.setTop(top);
+		this.slider.setLeft(left);
+		this.slider.setWidth(width);
+		this.slider.setHeight(height);
 
-		this.onmousedown(this.slider, (e) => this._sliderMouseDown(e));
+		this.domNode.domNode.appendChild(this.slider.domNode);
+
+		this.onmousedown(this.slider.domNode, (e) => this._sliderMouseDown(e));
 	}
 
 	// ----------------- Update state
 
-	public onElementSize(visibleSize: number) {
+	public onElementSize(visibleSize: number): boolean {
 		if (this._scrollbarState.setVisibleSize(visibleSize)) {
-			this._renderDomNode(this._scrollbarState.getRectangleLargeSize(), this._scrollbarState.getRectangleSmallSize());
-			this._renderSlider();
 			this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded());
+			this._shouldRender = true;
+			if (!this._lazyRender) {
+				this.render();
+			}
 		}
+		return this._shouldRender;
 	}
 
-	public onElementScrollSize(elementScrollSize: number): void {
+	public onElementScrollSize(elementScrollSize: number): boolean {
 		if (this._scrollbarState.setScrollSize(elementScrollSize)) {
-			this._renderSlider();
 			this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded());
+			this._shouldRender = true;
+			if (!this._lazyRender) {
+				this.render();
+			}
 		}
+		return this._shouldRender;
 	}
 
-	public onElementScrollPosition(elementScrollPosition: number): void {
+	public onElementScrollPosition(elementScrollPosition: number): boolean {
 		if (this._scrollbarState.setScrollPosition(elementScrollPosition)) {
-			this._renderSlider();
 			this._visibilityController.setIsNeeded(this._scrollbarState.isNeeded());
+			this._shouldRender = true;
+			if (!this._lazyRender) {
+				this.render();
+			}
 		}
+		return this._shouldRender;
 	}
 
 	// ----------------- rendering
@@ -440,22 +488,27 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 		this._visibilityController.setShouldBeVisible(false);
 	}
 
-	private _renderSlider(): void {
+	public render(): void {
+		if (!this._shouldRender) {
+			return;
+		}
+		this._shouldRender = false;
+
+		this._renderDomNode(this._scrollbarState.getRectangleLargeSize(), this._scrollbarState.getRectangleSmallSize());
 		this._updateSlider(this._scrollbarState.getSliderSize(), this._scrollbarState.getArrowSize() + this._scrollbarState.getSliderPosition());
 	}
-
 	// ----------------- DOM events
 
 	private _domNodeMouseDown(e: IMouseEvent): void {
-		if (e.target !== this.domNode) {
+		if (e.target !== this.domNode.domNode) {
 			return;
 		}
 		this._onMouseDown(e);
 	}
 
 	public delegateMouseDown(browserEvent: MouseEvent): void {
 		let e = new StandardMouseEvent(browserEvent);
-		let domTop = this.domNode.getClientRects()[0].top;
+		let domTop = this.domNode.domNode.getClientRects()[0].top;
 		let sliderStart = domTop + this._scrollbarState.getSliderPosition();
 		let sliderStop = domTop + this._scrollbarState.getSliderPosition() + this._scrollbarState.getSliderSize();
 		let mousePos = this._sliderMousePosition(e);
@@ -469,7 +522,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 	}
 
 	private _onMouseDown(e: IMouseEvent): void {
-		let domNodePosition = DomUtils.getDomNodePosition(this.domNode);
+		let domNodePosition = DomUtils.getDomNodePosition(this.domNode.domNode);
 		let desiredSliderPosition = this._mouseDownRelativePosition(e, domNodePosition) - this._scrollbarState.getArrowSize() - this._scrollbarState.getSliderSize() / 2;
 		this.setDesiredScrollPosition(this._scrollbarState.convertSliderPositionToScrollPosition(desiredSliderPosition));
 		this._sliderMouseDown(e);
@@ -480,7 +533,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 			let initialMouseOrthogonalPosition = this._sliderOrthogonalMousePosition(e);
 			let initialScrollPosition = this._getScrollPosition();
 			let draggingDelta = this._sliderMousePosition(e) - this._scrollbarState.getSliderPosition();
-			DomUtils.toggleClass(this.slider, 'active', true);
+			this.slider.toggleClassName('active', true);
 
 			this._mouseMoveMonitor.startMonitoring(
 				standardMouseMoveMerger,
@@ -497,7 +550,7 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 					}
 				},
 				() => {
-					DomUtils.toggleClass(this.slider, 'active', false);
+					this.slider.toggleClassName('active', false);
 					this._parent.onDragEnd();
 				}
 			);
@@ -511,12 +564,18 @@ export abstract class AbstractScrollbar extends Widget implements IScrollbar {
 		return this._scrollbarState.validateScrollPosition(desiredScrollPosition);
 	}
 
-	public setDesiredScrollPosition(desiredScrollPosition: number): void {
+	public setDesiredScrollPosition(desiredScrollPosition: number): boolean {
 		desiredScrollPosition = this.validateScrollPosition(desiredScrollPosition);
 
+		let oldScrollPosition = this._getScrollPosition();
 		this._setScrollPosition(desiredScrollPosition);
-		this.onElementScrollPosition(desiredScrollPosition);
-		this._renderSlider();
+		let newScrollPosition = this._getScrollPosition();
+
+		if (oldScrollPosition !== newScrollPosition) {
+			this.onElementScrollPosition(this._getScrollPosition());
+			return true;
+		}
+		return false;
 	}
 
 	// ----------------- Overwrite these

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/domNodeScrollable.ts
code:
@@ -7,20 +7,50 @@
 import * as DomUtils from 'vs/base/browser/dom';
 import {Gesture} from 'vs/base/browser/touch';
 import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
-import {IScrollable} from 'vs/base/common/scrollable';
+import {IScrollable, ScrollEvent} from 'vs/base/common/scrollable';
 import {Emitter} from 'vs/base/common/event';
 
 export class DomNodeScrollable extends Disposable implements IScrollable {
 
 	private _domNode: HTMLElement;
 	private _gestureHandler: Gesture;
-	private _onScroll = this._register(new Emitter<void>());
+	private _onScroll = this._register(new Emitter<ScrollEvent>());
+
+	private _lastScrollTop:number;
+	private _lastScrollLeft:number;
 
 	constructor(domNode: HTMLElement) {
 		super();
 		this._domNode = domNode;
 		this._gestureHandler = this._register(new Gesture(this._domNode));
-		this._register(DomUtils.addDisposableListener(this._domNode, 'scroll', (e) => this._onScroll.fire(void 0)));
+
+		this._lastScrollTop = this.getScrollTop();
+		this._lastScrollLeft = this.getScrollLeft();
+
+		this._register(DomUtils.addDisposableListener(this._domNode, 'scroll', (e) => {
+			this._emitScrollEvent();
+		}));
+	}
+
+	public onContentsDimensions(): void {
+		this._emitScrollEvent();
+	}
+
+	private _emitScrollEvent(): void {
+		let vertical = (this._lastScrollTop !== this.getScrollTop());
+		this._lastScrollTop = this.getScrollTop();
+
+		let horizontal = (this._lastScrollLeft !== this.getScrollLeft());
+		this._lastScrollLeft = this.getScrollLeft();
+
+		this._onScroll.fire(new ScrollEvent(
+			this.getScrollTop(),
+			this.getScrollLeft(),
+			this.getScrollWidth(),
+			this.getScrollHeight(),
+			vertical,
+			horizontal
+		));
 	}
 
 	public dispose() {
@@ -52,7 +82,7 @@ export class DomNodeScrollable extends Disposable implements IScrollable {
 		this._domNode.scrollTop = scrollTop;
 	}
 
-	public addScrollListener(callback: () => void): IDisposable {
+	public addScrollListener(callback: (v:ScrollEvent) => void): IDisposable {
 		return this._onScroll.event(callback);
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
code:
@@ -9,20 +9,19 @@ import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData}
 import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
-import {IScrollable} from 'vs/base/common/scrollable';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {DelegateScrollable} from 'vs/base/common/scrollable';
 
 export class HorizontalScrollbar extends AbstractScrollbar {
 
-	private _scrollable: IScrollable;
+	private _scrollable: DelegateScrollable;
 
-	constructor(scrollable: IScrollable, parent: IParent, options: IScrollableElementOptions) {
+	constructor(scrollable: DelegateScrollable, parent: IParent, options: IScrollableElementOptions) {
 		let s = new ScrollbarState(
 			(options.horizontalHasArrows ? options.arrowSize : 0),
 			(options.horizontal === Visibility.Hidden ? 0 : options.horizontalScrollbarSize),
 			(options.vertical === Visibility.Hidden ? 0 : options.verticalScrollbarSize)
 		);
-		super(options.forbidTranslate3dUse, parent, s, options.horizontal, 'horizontal');
+		super(options.forbidTranslate3dUse, options.lazyRender, parent, s, options.horizontal, 'horizontal');
 		this._scrollable = scrollable;
 
 		this._createDomNode();
@@ -42,19 +41,19 @@ export class HorizontalScrollbar extends AbstractScrollbar {
 	}
 
 	protected _updateSlider(sliderSize: number, sliderPosition: number): void {
-		StyleMutator.setWidth(this.slider, sliderSize);
+		this.slider.setWidth(sliderSize);
 		if (!this._forbidTranslate3dUse && Browser.canUseTranslate3d) {
-			StyleMutator.setTransform(this.slider, 'translate3d(' + sliderPosition + 'px, 0px, 0px)');
+			this.slider.setTransform('translate3d(' + sliderPosition + 'px, 0px, 0px)');
 		} else {
-			StyleMutator.setLeft(this.slider, sliderPosition);
+			this.slider.setLeft(sliderPosition);
 		}
 	}
 
 	protected _renderDomNode(largeSize: number, smallSize: number): void {
-		StyleMutator.setWidth(this.domNode, largeSize);
-		StyleMutator.setHeight(this.domNode, smallSize);
-		StyleMutator.setLeft(this.domNode, 0);
-		StyleMutator.setBottom(this.domNode, 0);
+		this.domNode.setWidth(largeSize);
+		this.domNode.setHeight(smallSize);
+		this.domNode.setLeft(0);
+		this.domNode.setBottom(0);
 	}
 
 	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/scrollableElement.ts
code:
@@ -4,14 +4,20 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IScrollable} from 'vs/base/common/scrollable';
+import {FastDomNode} from 'vs/base/browser/styleMutator';
 
 export interface IScrollableElementCreationOptions {
 	/**
 	 * Prevent the scrollbar rendering from using translate3d. Defaults to false.
 	 */
 	forbidTranslate3dUse?: boolean;
 
+	/**
+	 * The scrollable element should not do any DOM mutations until renderNow() is called.
+	 * Defaults to false.
+	 */
+	lazyRender?: boolean;
+
 	/**
 	 * CSS Class name for the scrollable element.
 	 */
@@ -47,12 +53,6 @@ export interface IScrollableElementCreationOptions {
 	 */
 	arrowSize?: number;
 
-	/**
-	 * The scrollable that will react to all the scrolling logic.
-	 * If no scrollable is provided, a dom node scrollable will be created automatically.
-	 */
-	scrollable?: IScrollable;
-
 	/**
 	 * The dom node events should be bound to.
 	 * If no listenOnDomNode is provided, the dom node passed to the constructor will be used for event listening.
@@ -145,14 +145,15 @@ export interface IScrollableElement {
 	onElementDimensions(dimensions?: IDimensions): void;
 
 	/**
-	 * Let the scrollable element know that the contained dom node's width / height might have changed.
+	 * Dispose.
 	 */
-	onElementInternalDimensions(): void;
+	dispose(): void;
 
 	/**
-	 * Dispose.
+	 * Render / mutate the DOM now.
+	 * Should be used together with the ctor option `lazyRender`.
 	 */
-	dispose(): void;
+	renderNow(): void;
 
 	/**
 	 * Update the class name of the scrollable element.
@@ -185,17 +186,18 @@ export interface IMouseWheelEvent {
 }
 
 export interface IScrollbar {
-	domNode: HTMLElement;
+	domNode: FastDomNode;
 	dispose(): void;
-	slider: HTMLElement;
-	onElementSize(size: number): void;
-	onElementScrollSize(scrollSize: number): void;
-	onElementScrollPosition(scrollPosition: number): void;
+	onElementSize(size: number): boolean;
+	onElementScrollSize(scrollSize: number): boolean;
+	onElementScrollPosition(scrollPosition: number): boolean;
 	beginReveal(): void;
 	beginHide(): void;
 	delegateMouseDown(browserEvent: MouseEvent): void;
 	validateScrollPosition(scrollPosition: number): number;
-	setDesiredScrollPosition(scrollPosition: number): void;
+	setDesiredScrollPosition(scrollPosition: number): boolean;
+
+	render(): void;
 }
 
 export interface IParent {
@@ -223,13 +225,13 @@ export function visibilityFromString(visibility: string): Visibility {
 
 export interface IScrollableElementOptions {
 	forbidTranslate3dUse: boolean;
+	lazyRender: boolean;
 	className: string;
 	useShadows: boolean;
 	handleMouseWheel: boolean;
 	flipAxes: boolean;
 	mouseWheelScrollSensitivity: number;
 	arrowSize: number;
-	scrollable: IScrollable;
 	listenOnDomNode: HTMLElement;
 	horizontal: Visibility;
 	horizontalScrollbarSize: number;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/scrollableElementImpl.ts
code:
@@ -9,58 +9,52 @@ import 'vs/css!./media/scrollbars';
 import * as DomUtils from 'vs/base/browser/dom';
 import * as Platform from 'vs/base/common/platform';
 import {StandardMouseWheelEvent, IMouseEvent} from 'vs/base/browser/mouseEvent';
-import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 import {HorizontalScrollbar} from 'vs/base/browser/ui/scrollbar/horizontalScrollbar';
 import {VerticalScrollbar} from 'vs/base/browser/ui/scrollbar/verticalScrollbar';
 import {
 		IScrollableElementOptions, IScrollbar, IDimensions, IMouseWheelEvent, visibilityFromString,
 		IScrollableElement, IScrollableElementCreationOptions, IOverviewRulerLayoutInfo
 	} from 'vs/base/browser/ui/scrollbar/scrollableElement';
 import {IDisposable, dispose} from 'vs/base/common/lifecycle';
-import {IScrollable} from 'vs/base/common/scrollable';
+import {IScrollable, DelegateScrollable} from 'vs/base/common/scrollable';
 import {Widget} from 'vs/base/browser/ui/widget';
 import {TimeoutTimer} from 'vs/base/common/async';
+import {FastDomNode, createFastDomNode} from 'vs/base/browser/styleMutator';
 
 const HIDE_TIMEOUT = 500;
 const SCROLL_WHEEL_SENSITIVITY = 50;
 
 export class ScrollableElement extends Widget implements IScrollableElement {
 
-	private _originalElement: HTMLElement;
 	private _options: IScrollableElementOptions;
-	private _scrollable: IScrollable;
+	private _scrollable: DelegateScrollable;
 	public verticalScrollbarWidth: number;
 	public horizontalScrollbarHeight: number;
 	private _verticalScrollbar: IScrollbar;
 	private _horizontalScrollbar: IScrollbar;
 	private _domNode: HTMLElement;
 
-	private _leftShadowDomNode: HTMLElement;
-	private _topShadowDomNode: HTMLElement;
-	private _topLeftShadowDomNode: HTMLElement;
+	private _leftShadowDomNode: FastDomNode;
+	private _topShadowDomNode: FastDomNode;
+	private _topLeftShadowDomNode: FastDomNode;
+
 	private _listenOnDomNode: HTMLElement;
 
 	private _mouseWheelToDispose: IDisposable[];
 
 	private _onElementDimensionsTimeout: TimeoutTimer;
-	private _onElementInternalDimensionsTimeout: TimeoutTimer;
 	private _isDragging: boolean;
 	private _mouseIsOver: boolean;
 
-	private _dimensions: IDimensions;
 	private _hideTimeout: TimeoutTimer;
+	private _shouldRender: boolean;
 
-	constructor(element: HTMLElement, options: IScrollableElementCreationOptions, dimensions: IDimensions = null) {
+	constructor(element: HTMLElement, scrollable:IScrollable, options: IScrollableElementCreationOptions, dimensions: IDimensions = null) {
 		super();
-		this._originalElement = element;
-		this._originalElement.style.overflow = 'hidden';
+		element.style.overflow = 'hidden';
 		this._options = this._createOptions(options);
 
-		if (this._options.scrollable) {
-			this._scrollable = this._options.scrollable;
-		} else {
-			this._scrollable = this._register(new DomNodeScrollable(this._originalElement));
-		}
+		this._scrollable = this._register(new DelegateScrollable(scrollable, () => this._onScroll()));
 
 		this.verticalScrollbarWidth = this._options.verticalScrollbarSize;
 		this.horizontalScrollbarHeight = this._options.horizontalScrollbarSize;
@@ -73,45 +67,42 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 		this._domNode.setAttribute('role', 'presentation');
 		this._domNode.style.position = 'relative';
 		this._domNode.style.overflow = 'hidden';
-		this._domNode.appendChild(this._originalElement);
-		this._domNode.appendChild(this._horizontalScrollbar.domNode);
-		this._domNode.appendChild(this._verticalScrollbar.domNode);
+		this._domNode.appendChild(element);
+		this._domNode.appendChild(this._horizontalScrollbar.domNode.domNode);
+		this._domNode.appendChild(this._verticalScrollbar.domNode.domNode);
 
 		if (this._options.useShadows) {
-			this._leftShadowDomNode = document.createElement('div');
-			this._leftShadowDomNode.className = 'shadow';
-			this._domNode.appendChild(this._leftShadowDomNode);
-		}
+			this._leftShadowDomNode = createFastDomNode(document.createElement('div'));
+			this._leftShadowDomNode.setClassName('shadow');
+			this._domNode.appendChild(this._leftShadowDomNode.domNode);
 
-		if (this._options.useShadows) {
-			this._topShadowDomNode = document.createElement('div');
-			this._topShadowDomNode.className = 'shadow';
-			this._domNode.appendChild(this._topShadowDomNode);
+			this._topShadowDomNode = createFastDomNode(document.createElement('div'));
+			this._topShadowDomNode.setClassName('shadow');
+			this._domNode.appendChild(this._topShadowDomNode.domNode);
 
-			this._topLeftShadowDomNode = document.createElement('div');
-			this._topLeftShadowDomNode.className = 'shadow top-left-corner';
-			this._domNode.appendChild(this._topLeftShadowDomNode);
+			this._topLeftShadowDomNode = createFastDomNode(document.createElement('div'));
+			this._topLeftShadowDomNode.setClassName('shadow top-left-corner');
+			this._domNode.appendChild(this._topLeftShadowDomNode.domNode);
 		}
 
 		this._listenOnDomNode = this._options.listenOnDomNode || this._domNode;
 
-
-		this._register(this._scrollable.addScrollListener(() => this._onScroll()));
-
 		this._mouseWheelToDispose = [];
 		this._setListeningToMouseWheel(this._options.handleMouseWheel);
 
 		this.onmouseover(this._listenOnDomNode, (e) => this._onMouseOver(e));
 		this.onnonbubblingmouseout(this._listenOnDomNode, (e) => this._onMouseOut(e));
 
 		this._onElementDimensionsTimeout = this._register(new TimeoutTimer());
-		this._onElementInternalDimensionsTimeout = this._register(new TimeoutTimer());
 		this._hideTimeout = this._register(new TimeoutTimer());
 		this._isDragging = false;
 		this._mouseIsOver = false;
 
 		this.onElementDimensions(dimensions, true);
-		this.onElementInternalDimensions(true);
+
+		this._shouldRender = true;
+		this._shouldRender = this._horizontalScrollbar.onElementScrollSize(this._scrollable.getScrollWidth()) || this._shouldRender;
+		this._shouldRender = this._verticalScrollbar.onElementScrollSize(this._scrollable.getScrollHeight()) || this._shouldRender;
 	}
 
 	public dispose(): void {
@@ -126,7 +117,7 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 	public getOverviewRulerLayoutInfo(): IOverviewRulerLayoutInfo {
 		return {
 			parent: this._domNode,
-			insertBefore: this._verticalScrollbar.domNode,
+			insertBefore: this._verticalScrollbar.domNode.domNode,
 		};
 	}
 
@@ -150,23 +141,10 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 				height: this._domNode.clientHeight
 			};
 		}
-		this._dimensions = this._computeDimensions(dimensions.width, dimensions.height);
-		this._verticalScrollbar.onElementSize(this._dimensions.height);
-		this._horizontalScrollbar.onElementSize(this._dimensions.width);
-	}
-
-	public onElementInternalDimensions(synchronous: boolean = false): void {
-		if (synchronous) {
-			this._actualElementInternalDimensions();
-			this._onElementInternalDimensionsTimeout.cancel();
-		} else {
-			this._onElementInternalDimensionsTimeout.setIfNotSet(() => this._actualElementInternalDimensions(), 0);
-		}
-	}
-
-	private _actualElementInternalDimensions(): void {
-		this._horizontalScrollbar.onElementScrollSize(this._scrollable.getScrollWidth());
-		this._verticalScrollbar.onElementScrollSize(this._scrollable.getScrollHeight());
+		let width = Math.round(dimensions.width);
+		let height = Math.round(dimensions.height);
+		this._shouldRender = this._verticalScrollbar.onElementSize(height) || this._shouldRender;
+		this._shouldRender = this._horizontalScrollbar.onElementSize(width) || this._shouldRender;
 	}
 
 	public updateClassName(newClassName: string): void {
@@ -262,11 +240,11 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 
 			if (desiredScrollTop !== -1 || desiredScrollLeft !== -1) {
 				if (desiredScrollTop !== -1) {
-					this._verticalScrollbar.setDesiredScrollPosition(desiredScrollTop);
+					this._shouldRender = this._verticalScrollbar.setDesiredScrollPosition(desiredScrollTop) || this._shouldRender;
 					desiredScrollTop = -1;
 				}
 				if (desiredScrollLeft !== -1) {
-					this._horizontalScrollbar.setDesiredScrollPosition(desiredScrollLeft);
+					this._shouldRender = this._horizontalScrollbar.setDesiredScrollPosition(desiredScrollLeft) || this._shouldRender;
 					desiredScrollLeft = -1;
 				}
 			}
@@ -282,31 +260,48 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 		let scrollWidth = this._scrollable.getScrollWidth();
 		let scrollLeft = this._scrollable.getScrollLeft();
 
-		this._verticalScrollbar.onElementScrollPosition(scrollTop);
-		this._horizontalScrollbar.onElementScrollPosition(scrollLeft);
+		this._shouldRender = this._horizontalScrollbar.onElementScrollSize(scrollWidth) || this._shouldRender;
+		this._shouldRender = this._verticalScrollbar.onElementScrollSize(scrollHeight) || this._shouldRender;
+		this._shouldRender = this._verticalScrollbar.onElementScrollPosition(scrollTop) || this._shouldRender;
+		this._shouldRender = this._horizontalScrollbar.onElementScrollPosition(scrollLeft) || this._shouldRender;
 
 		if (this._options.useShadows) {
-			let enableTop = scrollHeight > 0 && scrollTop > 0;
-			let enableLeft = this._options.useShadows && scrollWidth > 0 && scrollLeft > 0;
+			this._shouldRender = true;
+		}
 
-			if (this._topShadowDomNode) {
-				DomUtils.toggleClass(this._topShadowDomNode, 'top', enableTop);
-			}
+		this._reveal();
 
-			if (this._topLeftShadowDomNode) {
-				DomUtils.toggleClass(this._topLeftShadowDomNode, 'top', enableTop);
-			}
+		if (!this._options.lazyRender) {
+			this._render();
+		}
+	}
 
-			if (this._leftShadowDomNode) {
-				DomUtils.toggleClass(this._leftShadowDomNode, 'left', enableLeft);
-			}
+	public renderNow(): void {
+		if (!this._options.lazyRender) {
+			throw new Error('Please use `lazyRender` together with `renderNow`!');
+		}
 
-			if (this._topLeftShadowDomNode) {
-				DomUtils.toggleClass(this._topLeftShadowDomNode, 'left', enableLeft);
-			}
+		this._render();
+	}
+
+	private _render(): void {
+		if (!this._shouldRender) {
+			return;
 		}
 
-		this._reveal();
+		this._shouldRender = false;
+
+		this._horizontalScrollbar.render();
+		this._verticalScrollbar.render();
+
+		if (this._options.useShadows) {
+			let enableTop = this._scrollable.getScrollTop() > 0;
+			let enableLeft = this._scrollable.getScrollLeft() > 0;
+
+			this._leftShadowDomNode.setClassName('shadow' + (enableLeft ? ' left' : ''));
+			this._topShadowDomNode.setClassName('shadow' + (enableTop ? ' top' : ''));
+			this._topLeftShadowDomNode.setClassName('shadow top-left-corner' + (enableTop ? ' top' : '') + (enableLeft ? ' left' : ''));
+		}
 	}
 
 	// -------------------- fade in / fade out --------------------
@@ -350,16 +345,6 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 
 	// -------------------- size & layout --------------------
 
-	private _computeDimensions(clientWidth: number, clientHeight: number): IDimensions {
-		let width = clientWidth;
-		let height = clientHeight;
-
-		return {
-			width: width,
-			height: height
-		};
-	}
-
 	private _createOptions(options: IScrollableElementCreationOptions): IScrollableElementOptions {
 
 		function ensureValue<V>(source: any, prop: string, value: V) {
@@ -371,14 +356,14 @@ export class ScrollableElement extends Widget implements IScrollableElement {
 
 		let result: IScrollableElementOptions = {
 			forbidTranslate3dUse: ensureValue(options, 'forbidTranslate3dUse', false),
+			lazyRender: ensureValue(options, 'lazyRender', false),
 			className: ensureValue(options, 'className', ''),
 			useShadows: ensureValue(options, 'useShadows', true),
 			handleMouseWheel: ensureValue(options, 'handleMouseWheel', true),
 			flipAxes: ensureValue(options, 'flipAxes', false),
 			mouseWheelScrollSensitivity: ensureValue(options, 'mouseWheelScrollSensitivity', 1),
 			arrowSize: ensureValue(options, 'arrowSize', 11),
 
-			scrollable: ensureValue<IScrollable>(options, 'scrollable', null),
 			listenOnDomNode: ensureValue<HTMLElement>(options, 'listenOnDomNode', null),
 
 			horizontal: visibilityFromString(ensureValue(options, 'horizontal', 'auto')),

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/browser/ui/scrollbar/verticalScrollbar.ts
code:
@@ -9,21 +9,20 @@ import {ARROW_IMG_SIZE, AbstractScrollbar, ScrollbarState, IMouseMoveEventData}
 import {IMouseEvent, StandardMouseWheelEvent} from 'vs/base/browser/mouseEvent';
 import {IDomNodePosition} from 'vs/base/browser/dom';
 import {IParent, IScrollableElementOptions, Visibility} from 'vs/base/browser/ui/scrollbar/scrollableElement';
-import {IScrollable} from 'vs/base/common/scrollable';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {DelegateScrollable} from 'vs/base/common/scrollable';
 
 export class VerticalScrollbar extends AbstractScrollbar {
 
-	private _scrollable: IScrollable;
+	private _scrollable: DelegateScrollable;
 
-	constructor(scrollable: IScrollable, parent: IParent, options: IScrollableElementOptions) {
+	constructor(scrollable: DelegateScrollable, parent: IParent, options: IScrollableElementOptions) {
 		let s = new ScrollbarState(
 			(options.verticalHasArrows ? options.arrowSize : 0),
 			(options.vertical === Visibility.Hidden ? 0 : options.verticalScrollbarSize),
 			// give priority to vertical scroll bar over horizontal and let it scroll all the way to the bottom
 			0
 		);
-		super(options.forbidTranslate3dUse, parent, s, options.vertical, 'vertical');
+		super(options.forbidTranslate3dUse, options.lazyRender, parent, s, options.vertical, 'vertical');
 		this._scrollable = scrollable;
 
 		this._createDomNode();
@@ -43,19 +42,19 @@ export class VerticalScrollbar extends AbstractScrollbar {
 	}
 
 	protected _updateSlider(sliderSize: number, sliderPosition: number): void {
-		StyleMutator.setHeight(this.slider, sliderSize);
+		this.slider.setHeight(sliderSize);
 		if (!this._forbidTranslate3dUse && Browser.canUseTranslate3d) {
-			StyleMutator.setTransform(this.slider, 'translate3d(0px, ' + sliderPosition + 'px, 0px)');
+			this.slider.setTransform('translate3d(0px, ' + sliderPosition + 'px, 0px)');
 		} else {
-			StyleMutator.setTop(this.slider, sliderPosition);
+			this.slider.setTop(sliderPosition);
 		}
 	}
 
 	protected _renderDomNode(largeSize: number, smallSize: number): void {
-		StyleMutator.setWidth(this.domNode, smallSize);
-		StyleMutator.setHeight(this.domNode, largeSize);
-		StyleMutator.setRight(this.domNode, 0);
-		StyleMutator.setTop(this.domNode, 0);
+		this.domNode.setWidth(smallSize);
+		this.domNode.setHeight(largeSize);
+		this.domNode.setRight(0);
+		this.domNode.setTop(0);
 	}
 
 	protected _mouseDownRelativePosition(e: IMouseEvent, domNodePosition: IDomNodePosition): number {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/common/eventEmitter.ts
code:
@@ -18,7 +18,7 @@ export class EmitterEvent implements IEmitterEvent {
 	private _data:any;
 	private _emitterType:string;
 
-	constructor(eventType:string, data:any, emitterType:string=null) {
+	constructor(eventType:string=null, data:any=null, emitterType:string=null) {
 		this._type = eventType;
 		this._data = data;
 		this._emitterType = emitterType;
@@ -237,23 +237,15 @@ export class EventEmitter implements IEventEmitter {
 		if (this._listeners.hasOwnProperty(eventType)) {
 			var listeners = this._listeners[eventType].slice(0);
 			for (var i = 0, len = listeners.length; i < len; i++) {
-				try {
-					listeners[i](data);
-				} catch(e) {
-					Errors.onUnexpectedError(e);
-				}
+				safeInvoke1Arg(listeners[i], data);
 			}
 		}
 	}
 
 	protected _emitToBulkListeners(events:EmitterEvent[]): void {
 		var bulkListeners = this._bulkListeners.slice(0);
 		for (var i = 0, len = bulkListeners.length; i < len; i++) {
-			try {
-				bulkListeners[i](events);
-			} catch(e) {
-				Errors.onUnexpectedError(e);
-			}
+			safeInvoke1Arg(bulkListeners[i], events);
 		}
 	}
 
@@ -291,12 +283,7 @@ export class EventEmitter implements IEventEmitter {
 
 	public deferredEmit(callback:()=>any):any {
 		this._deferredCnt = this._deferredCnt + 1;
-		var result: any = null;
-		try {
-			result = callback();
-		} catch (e) {
-			Errors.onUnexpectedError(e);
-		}
+		var result: any = safeInvokeNoArg(callback);
 		this._deferredCnt = this._deferredCnt - 1;
 
 		if (this._deferredCnt === 0) {
@@ -359,11 +346,23 @@ export class OrderGuaranteeEventEmitter extends EventEmitter {
 
 		while (this._emitQueue.length > 0) {
 			let queueElement = this._emitQueue.shift();
-			try {
-				queueElement.target(queueElement.arg);
-			} catch(e) {
-				Errors.onUnexpectedError(e);
-			}
+			safeInvoke1Arg(queueElement.target, queueElement.arg);
 		}
 	}
 }
+
+function safeInvokeNoArg(func:Function): any {
+	try {
+		return func();
+	} catch(e) {
+		Errors.onUnexpectedError(e);
+	}
+}
+
+function safeInvoke1Arg(func:Function, arg1:any): any {
+	try {
+		return func(arg1);
+	} catch(e) {
+		Errors.onUnexpectedError(e);
+	}
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/common/filters.ts
code:
@@ -302,6 +302,9 @@ const fuzzySeparateFilter = or(matchesPrefix, matchesCamelCase, matchesSubString
 const fuzzyRegExpCache: { [key: string]: RegExp; } = {};
 
 export function matchesFuzzy(word: string, wordToMatchAgainst: string, enableSeparateSubstringMatching = false): IMatch[] {
+	if (typeof word !== 'string' || typeof wordToMatchAgainst !== 'string') {
+		return null; // return early for invalid input
+	}
 
 	// Form RegExp for wildcard matches
 	let regexp = fuzzyRegExpCache[word];

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/common/scrollable.ts
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IDisposable} from 'vs/base/common/lifecycle';
+import {Disposable, IDisposable} from 'vs/base/common/lifecycle';
 
 export interface IScrollable {
 	getScrollHeight():number;
@@ -13,5 +13,94 @@ export interface IScrollable {
 	setScrollLeft(scrollLeft:number);
 	getScrollTop():number;
 	setScrollTop(scrollTop:number);
-	addScrollListener(callback:()=>void): IDisposable;
+	addScrollListener(callback:(newValues:ScrollEvent)=>void): IDisposable;
+}
+
+export class ScrollEvent {
+	_scrollEventTrait: void;
+
+	scrollTop: number;
+	scrollLeft: number;
+	scrollWidth: number;
+	scrollHeight: number;
+	vertical: boolean;
+	horizontal: boolean;
+
+	constructor(scrollTop:number, scrollLeft:number, scrollWidth:number, scrollHeight:number, vertical:boolean, horizontal:boolean) {
+		this.scrollTop = Math.round(scrollTop);
+		this.scrollLeft = Math.round(scrollLeft);
+		this.scrollWidth = Math.round(scrollWidth);
+		this.scrollHeight = Math.round(scrollHeight);
+		this.vertical = Boolean(vertical);
+		this.horizontal = Boolean(horizontal);
+	}
+}
+
+export class ScrollableValues {
+	_scrollableValuesTrait: void;
+
+	scrollTop: number;
+	scrollLeft: number;
+	scrollWidth: number;
+	scrollHeight: number;
+
+	constructor(scrollTop:number, scrollLeft:number, scrollWidth:number, scrollHeight:number) {
+		this.scrollTop = Math.round(scrollTop);
+		this.scrollLeft = Math.round(scrollLeft);
+		this.scrollWidth = Math.round(scrollWidth);
+		this.scrollHeight = Math.round(scrollHeight);
+	}
+
+	public equals(other:ScrollEvent): boolean {
+		return (
+			this.scrollTop === other.scrollTop
+			&& this.scrollLeft === other.scrollLeft
+			&& this.scrollWidth === other.scrollWidth
+			&& this.scrollHeight === other.scrollHeight
+		);
+	}
+}
+
+export class DelegateScrollable extends Disposable {
+
+	private _actual:IScrollable;
+	private _onChange:()=>void;
+
+	private _values: ScrollableValues;
+
+	constructor(actual:IScrollable, onChange:()=>void) {
+		super();
+		this._actual = actual;
+		this._onChange = onChange;
+
+		this._values = new ScrollableValues(this._actual.getScrollTop(), this._actual.getScrollLeft(), this._actual.getScrollWidth(), this._actual.getScrollHeight());
+		this._register(this._actual.addScrollListener((newValues) => this._update(newValues)));
+	}
+
+	public dispose(): void {
+		super.dispose();
+	}
+
+	private _update(e:ScrollEvent): void {
+		if (this._values.equals(e)) {
+			return;
+		}
+
+		this._values = new ScrollableValues(e.scrollTop, e.scrollLeft, e.scrollWidth, e.scrollHeight);
+
+		this._onChange();
+	}
+
+	public getScrollTop():number { return this._values.scrollTop; }
+	public getScrollLeft():number { return this._values.scrollLeft; }
+	public getScrollWidth():number { return this._values.scrollWidth; }
+	public getScrollHeight():number { return this._values.scrollHeight; }
+
+	public setScrollTop(scrollTop:number): void {
+		this._actual.setScrollTop(scrollTop);
+	}
+
+	public setScrollLeft(scrollLeft:number): void {
+		this._actual.setScrollLeft(scrollLeft);
+	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/common/strings.ts
code:
@@ -455,6 +455,7 @@ export function isFullWidthCharacter(charCode:number): boolean {
 	//               of which FF01 - FF5E fullwidth ASCII of 21 to 7E
 	// [IGNORE]    and FF65 - FFDC halfwidth of Katakana and Hangul
 	// [IGNORE] FFF0  FFFF   Specials
+	charCode = +charCode; // @perf
 	return (
 		(charCode >= 0x2E80 && charCode <= 0xD7AF)
 		|| (charCode >= 0xF900 && charCode <= 0xFAFF)

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/common/uri.ts
code:
@@ -6,11 +6,21 @@
 
 import platform = require('vs/base/common/platform');
 
+
+function _encode(ch: string): string {
+	return '%' + ch.charCodeAt(0).toString(16).toUpperCase();
+}
+
 // see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
-function fixedEncodeURIComponent(str: string): string {
-	return encodeURIComponent(str).replace(/[!'()*]/g, c => '%' + c.charCodeAt(0).toString(16).toUpperCase());
+function encodeURIComponent2(str: string): string {
+	return encodeURIComponent(str).replace(/[!'()*]/g, _encode);
+}
+
+function encodeNoop(str: string): string {
+	return str;
 }
 
+
 /**
  * Uniform Resource Identifier (URI) http://tools.ietf.org/html/rfc3986.
  * This class is a simple parser which creates the basic component paths
@@ -33,7 +43,7 @@ export default class URI {
 	private static _slash = '/';
 	private static _regexp = /^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;
 	private static _driveLetterPath = /^\/[a-zA-z]:/;
-	private static _driveLetter = /^[a-zA-z]:/;
+	private static _upperCaseDrive = /^(\/)?([A-Z]:)/;
 
 	private _scheme: string;
 	private _authority: string;
@@ -243,70 +253,74 @@ export default class URI {
 
 	// ---- printing/externalize ---------------------------
 
-	public toString(): string {
+	/**
+	 *
+	 * @param encode Encode the result, default is `true`.
+	 */
+	public toString(encode: boolean = true): string {
+		if (!encode) {
+			return URI._asFormatted(this, false);
+		}
 		if (!this._formatted) {
-			var parts: string[] = [];
+			this._formatted = URI._asFormatted(this, true);
+		}
+		return this._formatted;
+	}
+
+	private static _asFormatted(uri: URI, encode: boolean): string {
+
+		const encoder = encode
+			? encodeURIComponent2
+			: encodeNoop;
+
+		const parts: string[] = [];
 
-			if (this._scheme) {
-				parts.push(this._scheme);
-				parts.push(':');
+		let {scheme, authority, path, query, fragment} = uri;
+		if (scheme) {
+			parts.push(scheme, ':');
+		}
+		if (authority || scheme === 'file') {
+			parts.push('//');
+		}
+		if (authority) {
+			authority = authority.toLowerCase();
+			let idx = authority.indexOf(':');
+			if (idx === -1) {
+				parts.push(encoder(authority));
+			} else {
+				parts.push(encoder(authority.substr(0, idx)), authority.substr(idx));
 			}
-			if (this._authority || this._scheme === 'file') {
-				parts.push('//');
+		}
+		if (path) {
+			// lower-case windown drive letters in /C:/fff
+			const m = URI._upperCaseDrive.exec(path);
+			if (m) {
+				path = m[1] + m[2].toLowerCase() + path.substr(m[1].length + m[2].length);
 			}
-			if (this._authority) {
-				var authority = this._authority,
-					idx: number;
 
-				authority = authority.toLowerCase();
-				idx = authority.indexOf(':');
+			// encode every segement but not slashes
+			// make sure that # and ? are always encoded
+			// when occurring in paths - otherwise the result
+			// cannot be parsed back again
+			let lastIdx = 0;
+			while(true) {
+				let idx = path.indexOf(URI._slash, lastIdx);
 				if (idx === -1) {
-					parts.push(fixedEncodeURIComponent(authority));
-				} else {
-					parts.push(fixedEncodeURIComponent(authority.substr(0, idx)));
-					parts.push(authority.substr(idx));
-				}
-			}
-			if (this._path) {
-				// encode every segment of the path
-				var path = this._path,
-					segments: string[];
-
-				// lower-case win drive letters in /C:/fff
-				if (URI._driveLetterPath.test(path)) {
-					path = '/' + path[1].toLowerCase() + path.substr(2);
-				} else if (URI._driveLetter.test(path)) {
-					path = path[0].toLowerCase() + path.substr(1);
-				}
-				segments = path.split('/');
-				for (var i = 0, len = segments.length; i < len; i++) {
-					segments[i] = fixedEncodeURIComponent(segments[i]);
+					parts.push(encoder(path.substring(lastIdx)).replace(/[#?]/, _encode));
+					break;
 				}
-				parts.push(segments.join('/'));
-			}
-			if (this._query) {
-				// in http(s) querys often use 'key=value'-pairs and
-				// ampersand characters for multiple pairs
-				var encoder = /https?/i.test(this.scheme)
-					? encodeURI
-					: fixedEncodeURIComponent;
-
-				parts.push('?');
-				parts.push(encoder(this._query));
-			}
-			if (this._fragment) {
-				// in http(s) querys often use 'key=value'-pairs and
-				// ampersand characters for multiple pairs
-				var encoder = /https?/i.test(this.scheme)
-					? encodeURI
-					: fixedEncodeURIComponent;
-
-				parts.push('#');
-				parts.push(encoder(this._fragment));
-			}
-			this._formatted = parts.join('');
+				parts.push(encoder(path.substring(lastIdx, idx)).replace(/[#?]/, _encode), URI._slash);
+				lastIdx = idx + 1;
+			};
 		}
-		return this._formatted;
+		if (query) {
+			parts.push('?', encoder(query));
+		}
+		if (fragment) {
+			parts.push('#', encoder(fragment));
+		}
+
+		return parts.join(URI._empty);
 	}
 
 	public toJSON(): any {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/parts/tree/browser/treeView.ts
code:
@@ -21,7 +21,7 @@ import ScrollableElementImpl = require('vs/base/browser/ui/scrollbar/scrollableE
 import { HeightMap } from 'vs/base/parts/tree/browser/treeViewModel';
 import _ = require('vs/base/parts/tree/browser/tree');
 import { IViewItem } from 'vs/base/parts/tree/browser/treeViewModel';
-import {IScrollable} from 'vs/base/common/scrollable';
+import {IScrollable, ScrollEvent} from 'vs/base/common/scrollable';
 import {KeyCode} from 'vs/base/common/keyCodes';
 
 export interface IRow {
@@ -489,9 +489,8 @@ export class TreeView extends HeightMap implements IScrollable {
 
 		this.wrapper = document.createElement('div');
 		this.wrapper.className = 'monaco-tree-wrapper';
-		this.scrollableElement = new ScrollableElementImpl.ScrollableElement(this.wrapper, {
+		this.scrollableElement = new ScrollableElementImpl.ScrollableElement(this.wrapper, this, {
 			forbidTranslate3dUse: true,
-			scrollable: this,
 			horizontal: 'hidden',
 			vertical: context.options.verticalScrollMode || 'auto',
 			useShadows: context.options.useShadows,
@@ -597,7 +596,7 @@ export class TreeView extends HeightMap implements IScrollable {
 		this.scrollTop = this.onHiddenScrollTop;
 		this.onHiddenScrollTop = null;
 		this.scrollableElement.onElementDimensions();
-		this.scrollableElement.onElementInternalDimensions();
+		this._emitScrollEvent(false, false);
 		this.setupMSGesture();
 	}
 
@@ -625,7 +624,7 @@ export class TreeView extends HeightMap implements IScrollable {
 		this.scrollTop = this.scrollTop; // render
 
 		this.scrollableElement.onElementDimensions();
-		this.scrollableElement.onElementInternalDimensions();
+		this._emitScrollEvent(false, false);
 	}
 
 	private render(scrollTop: number, viewHeight: number): void {
@@ -750,7 +749,7 @@ export class TreeView extends HeightMap implements IScrollable {
 		}
 
 		this.scrollTop = scrollTop;
-		this.scrollableElement.onElementInternalDimensions();
+		this._emitScrollEvent(false, false);
 	}
 
 	public focusNextPage(eventPayload?:any): void {
@@ -849,10 +848,21 @@ export class TreeView extends HeightMap implements IScrollable {
 		this.render(scrollTop, this.viewHeight);
 		this._scrollTop = scrollTop;
 
-		this.emit('scroll', { vertical: true, horizontal: false });
+		this._emitScrollEvent(true, false);
 	}
 
-	public addScrollListener(callback:()=>void): Lifecycle.IDisposable {
+	private _emitScrollEvent(vertical:boolean, horizontal:boolean): void {
+		this.emit('scroll', new ScrollEvent(
+			this.getScrollTop(),
+			this.getScrollLeft(),
+			this.getScrollWidth(),
+			this.getScrollHeight(),
+			vertical,
+			horizontal
+		));
+	}
+
+	public addScrollListener(callback:(v:ScrollEvent)=>void): Lifecycle.IDisposable {
 		return this.addListener2('scroll', callback);
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/base/test/common/uri.test.ts
code:
@@ -38,16 +38,36 @@ suite('URI', () => {
 		assert.equal(URI.create('', '', 'my/path').toString(), 'my/path');
 		assert.equal(URI.create('', '', '/my/path').toString(), '/my/path');
 		//http://a-test-site.com/#test=true
-		assert.equal(URI.create('http', 'a-test-site.com', '/', 'test=true').toString(), 'http://a-test-site.com/?test=true');
-		assert.equal(URI.create('http', 'a-test-site.com', '/', '', 'test=true').toString(), 'http://a-test-site.com/#test=true');
+		assert.equal(URI.create('http', 'a-test-site.com', '/', 'test=true').toString(), 'http://a-test-site.com/?test%3Dtrue');
+		assert.equal(URI.create('http', 'a-test-site.com', '/', '', 'test=true').toString(), 'http://a-test-site.com/#test%3Dtrue');
+	});
+
+	test('http#toString, encode=FALSE', () => {
+		assert.equal(URI.create('http', 'a-test-site.com', '/', 'test=true').toString(false), 'http://a-test-site.com/?test=true');
+		assert.equal(URI.create('http', 'a-test-site.com', '/', '', 'test=true').toString(false), 'http://a-test-site.com/#test=true');
+		assert.equal(URI.create().withScheme('http').withPath('/api/files/test.me').withQuery('t=1234').toString(false), 'http:/api/files/test.me?t=1234');
+
+		var value = URI.parse('file://shares/prjects/c%23/#l12');
+		assert.equal(value.authority, 'shares');
+		assert.equal(value.path, '/prjects/c#/');
+		assert.equal(value.fragment, 'l12');
+		assert.equal(value.toString(), 'file://shares/pr%C3%B6jects/c%23/#l12');
+		assert.equal(value.toString(false), 'file://shares/prjects/c%23/#l12');
+
+		var uri2 = URI.parse(value.toString(false));
+		var uri3 = URI.parse(value.toString(true));
+		assert.equal(uri2.authority, uri3.authority);
+		assert.equal(uri2.path, uri3.path);
+		assert.equal(uri2.query, uri3.query);
+		assert.equal(uri2.fragment, uri3.fragment);
 	});
 
 	test('with', () => {
-		assert.equal(URI.create().withScheme('http').withPath('/api/files/test.me').withQuery('t=1234').toString(), 'http:/api/files/test.me?t=1234');
-		assert.equal(URI.create().with('http', '', '/api/files/test.me', 't=1234', '').toString(), 'http:/api/files/test.me?t=1234');
-		assert.equal(URI.create().with('https', '', '/api/files/test.me', 't=1234', '').toString(), 'https:/api/files/test.me?t=1234');
-		assert.equal(URI.create().with('HTTP', '', '/api/files/test.me', 't=1234', '').toString(), 'HTTP:/api/files/test.me?t=1234');
-		assert.equal(URI.create().with('HTTPS', '', '/api/files/test.me', 't=1234', '').toString(), 'HTTPS:/api/files/test.me?t=1234');
+		assert.equal(URI.create().withScheme('http').withPath('/api/files/test.me').withQuery('t=1234').toString(), 'http:/api/files/test.me?t%3D1234');
+		assert.equal(URI.create().with('http', '', '/api/files/test.me', 't=1234', '').toString(), 'http:/api/files/test.me?t%3D1234');
+		assert.equal(URI.create().with('https', '', '/api/files/test.me', 't=1234', '').toString(), 'https:/api/files/test.me?t%3D1234');
+		assert.equal(URI.create().with('HTTP', '', '/api/files/test.me', 't=1234', '').toString(), 'HTTP:/api/files/test.me?t%3D1234');
+		assert.equal(URI.create().with('HTTPS', '', '/api/files/test.me', 't=1234', '').toString(), 'HTTPS:/api/files/test.me?t%3D1234');
 		assert.equal(URI.create().with('boo', '', '/api/files/test.me', 't=1234', '').toString(), 'boo:/api/files/test.me?t%3D1234');
 	});
 
@@ -333,14 +353,20 @@ suite('URI', () => {
 
 		let uri = URI.parse('http://go.microsoft.com/fwlink/?LinkId=518008');
 		assert.equal(uri.query, 'LinkId=518008');
-		assert.equal(uri.toString(), 'http://go.microsoft.com/fwlink/?LinkId=518008');
+		assert.equal(uri.toString(false), 'http://go.microsoft.com/fwlink/?LinkId=518008');
+		assert.equal(uri.toString(), 'http://go.microsoft.com/fwlink/?LinkId%3D518008');
 
 		let uri2 = URI.parse(uri.toString());
 		assert.equal(uri2.query, 'LinkId=518008');
 		assert.equal(uri2.query, uri.query);
 
 		uri = URI.parse('http://go.microsoft.com/fwlink/?LinkId=518008&fo&k=');
 		assert.equal(uri.query, 'LinkId=518008&fo&k=');
-		assert.equal(uri.toString(), 'http://go.microsoft.com/fwlink/?LinkId=518008&fo%C3%B6&k%C3%A9%C2%A5=%C3%BC%C3%BC');
+		assert.equal(uri.toString(false), 'http://go.microsoft.com/fwlink/?LinkId=518008&fo&k=');
+		assert.equal(uri.toString(), 'http://go.microsoft.com/fwlink/?LinkId%3D518008%26fo%C3%B6%26k%C3%A9%C2%A5%3D%C3%BC%C3%BC');
+
+		uri2 = URI.parse(uri.toString());
+		assert.equal(uri2.query, 'LinkId=518008&fo&k=');
+		assert.equal(uri2.query, uri.query);
 	});
 });
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/config/configuration.ts
code:
@@ -54,7 +54,8 @@ class CSSBasedConfiguration extends Disposable {
 
 	private static _HALF_WIDTH_TYPICAL = 'n';
 	private static _FULL_WIDTH_TYPICAL = '\uff4d';
-	private static _USUAL_CHARS = '0123456789' + CSSBasedConfiguration._HALF_WIDTH_TYPICAL + CSSBasedConfiguration._FULL_WIDTH_TYPICAL;
+	private static _SPACE = ' ';
+	private static _USUAL_CHARS = '0123456789' + CSSBasedConfiguration._HALF_WIDTH_TYPICAL + CSSBasedConfiguration._FULL_WIDTH_TYPICAL + CSSBasedConfiguration._SPACE;
 
 	private _cache: CSSBasedConfigurationCache;
 	private _changeMonitorTimeout: number = -1;
@@ -86,12 +87,13 @@ class CSSBasedConfiguration extends Disposable {
 		if (!this._cache.has(styling)) {
 			let readConfig = CSSBasedConfiguration._actualReadConfiguration(styling);
 
-			if (readConfig.lineHeight <= 2 || readConfig.typicalHalfwidthCharacterWidth <= 2 || readConfig.typicalFullwidthCharacterWidth <= 2 || readConfig.maxDigitWidth <= 2) {
+			if (readConfig.lineHeight <= 2 || readConfig.typicalHalfwidthCharacterWidth <= 2 || readConfig.typicalFullwidthCharacterWidth <= 2 || readConfig.spaceWidth <= 2 || readConfig.maxDigitWidth <= 2) {
 				// Hey, it's Bug 14341 ... we couldn't read
-				readConfig.lineHeight = Math.max(readConfig.lineHeight, readConfig.fontSize, 5);
-				readConfig.typicalHalfwidthCharacterWidth = Math.max(readConfig.typicalHalfwidthCharacterWidth, readConfig.fontSize, 5);
-				readConfig.typicalFullwidthCharacterWidth = Math.max(readConfig.typicalFullwidthCharacterWidth, readConfig.fontSize, 5);
-				readConfig.maxDigitWidth = Math.max(readConfig.maxDigitWidth, readConfig.fontSize, 5);
+				readConfig.lineHeight = Math.max(readConfig.lineHeight, 5);
+				readConfig.typicalHalfwidthCharacterWidth = Math.max(readConfig.typicalHalfwidthCharacterWidth, 5);
+				readConfig.typicalFullwidthCharacterWidth = Math.max(readConfig.typicalFullwidthCharacterWidth, 5);
+				readConfig.spaceWidth = Math.max(readConfig.spaceWidth, 5);
+				readConfig.maxDigitWidth = Math.max(readConfig.maxDigitWidth, 5);
 				this._installChangeMonitor();
 			}
 
@@ -138,14 +140,22 @@ class CSSBasedConfiguration extends Disposable {
 		let r = document.createElement('span');
 		r.id = this._testElementId(index);
 
-		let testString = (character === ' ' ? '&nbsp;' : character);
-
-		// Repeat character 256 (2^8) times
-		for (let i = 0; i < 8; i++) {
-			testString += testString;
+		if (character === ' ') {
+			let htmlString = '&nbsp;';
+			// Repeat character 256 (2^8) times
+			for (let i = 0; i < 8; i++) {
+				htmlString += htmlString;
+			}
+			r.innerHTML = htmlString;
+		} else {
+			let testString = character;
+			// Repeat character 256 (2^8) times
+			for (let i = 0; i < 8; i++) {
+				testString += testString;
+			}
+			r.textContent = testString;
 		}
 
-		r.textContent = testString;
 		return r;
 	}
 
@@ -204,9 +214,10 @@ class CSSBasedConfiguration extends Disposable {
 		document.body.removeChild(testContainer);
 
 		// Find maximum digit width and thinnest character width
-		let maxDigitWidth = 0,
-			typicalHalfwidthCharacterWidth = 0,
-			typicalFullwidthCharacterWidth = 0;
+		let maxDigitWidth = 0;
+		let typicalHalfwidthCharacterWidth = 0;
+		let typicalFullwidthCharacterWidth = 0;
+		let spaceWidth = 0;
 
 		for (let i = 0, len = CSSBasedConfiguration._USUAL_CHARS.length; i < len; i++) {
 			let character = CSSBasedConfiguration._USUAL_CHARS.charAt(i);
@@ -218,12 +229,15 @@ class CSSBasedConfiguration extends Disposable {
 				typicalHalfwidthCharacterWidth = usualCharsWidths[i];
 			} else if (character === CSSBasedConfiguration._FULL_WIDTH_TYPICAL) {
 				typicalFullwidthCharacterWidth = usualCharsWidths[i];
+			} else if (character === CSSBasedConfiguration._SPACE) {
+				spaceWidth = usualCharsWidths[i];
 			}
 		}
 
 		return {
 			typicalHalfwidthCharacterWidth: typicalHalfwidthCharacterWidth,
 			typicalFullwidthCharacterWidth: typicalFullwidthCharacterWidth,
+			spaceWidth: spaceWidth,
 			maxDigitWidth: maxDigitWidth,
 			lineHeight: result_lineHeight,
 			font: result_font,

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/controller/keyboardHandler.ts
code:
@@ -160,7 +160,15 @@ class TextAreaWrapper extends Disposable implements ITextAreaWrapper {
 	}
 
 	public setSelectionRange(selectionStart:number, selectionEnd:number): void {
-		// console.log('setSelectionRange: ' + selectionStart + ', ' + selectionEnd);
+		let activeElement = document.activeElement;
+		if (activeElement === this._textArea) {
+			this._textArea.setSelectionRange(selectionStart, selectionEnd);
+		} else {
+			this._setSelectionRangeJumpy(selectionStart, selectionEnd);
+		}
+	}
+
+	private _setSelectionRangeJumpy(selectionStart:number, selectionEnd:number): void {
 		try {
 			let scrollState = dom.saveParentsScrollTop(this._textArea);
 			this._textArea.focus();
@@ -304,8 +312,9 @@ export class KeyboardHandler extends ViewEventHandler implements IDisposable {
 		return false;
 	}
 
+	private _lastCursorSelectionChanged:editorCommon.IViewCursorSelectionChangedEvent = null;
 	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
-		this.textAreaHandler.setCursorSelections(e.selection, e.secondarySelections);
+		this._lastCursorSelectionChanged = e;
 		return false;
 	}
 
@@ -320,4 +329,12 @@ export class KeyboardHandler extends ViewEventHandler implements IDisposable {
 		return false;
 	}
 
+	public writeToTextArea(): void {
+		if (this._lastCursorSelectionChanged) {
+			let e = this._lastCursorSelectionChanged;
+			this._lastCursorSelectionChanged = null;
+			this.textAreaHandler.setCursorSelections(e.selection, e.secondarySelections);
+		}
+	}
+
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/editorBrowser.ts
code:
@@ -11,11 +11,6 @@ import {IMouseEvent} from 'vs/base/browser/mouseEvent';
 import {IInstantiationService, IConstructorSignature1} from 'vs/platform/instantiation/common/instantiation';
 import * as editorCommon from 'vs/editor/common/editorCommon';
 
-export interface IDynamicViewOverlay extends IDisposable {
-	shouldCallRender2(ctx:IRenderingContext): boolean;
-	render2(lineNumber:number): string[];
-}
-
 export interface IContentWidgetData {
 	widget: IContentWidget;
 	position: IContentWidgetPosition;
@@ -167,7 +162,7 @@ export var ClassNames = {
 };
 
 export interface IRestrictedRenderingContext {
-	linesViewportData:editorCommon.IViewLinesViewportData;
+	linesViewportData:editorCommon.ViewLinesViewportData;
 
 	scrollWidth:number;
 	scrollHeight:number;
@@ -206,12 +201,6 @@ export interface IViewportInfo {
 	deltaLeft:number;
 }
 
-export interface IViewPart extends IDisposable {
-	onBeforeForcedLayout(): void;
-	onReadAfterForcedLayout(ctx:IRenderingContext): void;
-	onWriteAfterForcedLayout(): void;
-}
-
 // --- end View Event Handlers & Parts
 
 export interface IViewContext {
@@ -230,7 +219,7 @@ export interface ILayoutProvider extends IVerticalLayoutProvider, IScrollingProv
 
 	getCenteredViewLineNumberInViewport(): number;
 
-	getCurrentViewport(): editorCommon.IViewport;
+	getCurrentViewport(): editorCommon.Viewport;
 
 	onMaxLineWidthChanged(width:number): void;
 
@@ -280,7 +269,7 @@ export interface IVerticalLayoutProvider {
 	/**
 	 * Compute the lines that need to be rendered in the current viewport position.
 	 */
-	getLinesViewportData(): editorCommon.IViewLinesViewportData;
+	getLinesViewportData(): editorCommon.ViewLinesViewportData;
 }
 
 /**
@@ -501,24 +490,108 @@ export interface IEditorContributionDescriptor {
 	createInstance(instantiationService:IInstantiationService, editor:ICodeEditor): editorCommon.IEditorContribution;
 }
 
+export class ColorZone {
+	_colorZoneTrait: void;
+
+	from: number;
+	to: number;
+	colorId: number;
+	position: editorCommon.OverviewRulerLane;
+
+	constructor(from:number, to:number, colorId:number, position: editorCommon.OverviewRulerLane) {
+		this.from = from|0;
+		this.to = to|0;
+		this.colorId = colorId|0;
+		this.position = position|0;
+	}
+}
+
 /**
  * A zone in the overview ruler
  */
-export interface IOverviewRulerZone {
+export class OverviewRulerZone {
+	_overviewRulerZoneTrait: void;
+
 	startLineNumber: number;
 	endLineNumber: number;
-	forceHeight?: number;
-	color: string;
-	darkColor: string;
 	position: editorCommon.OverviewRulerLane;
+	forceHeight: number;
+
+	private _color: string;
+	private _darkColor: string;
+
+	private _colorZones: ColorZone[];
+
+	constructor(
+		startLineNumber: number, endLineNumber: number,
+		position: editorCommon.OverviewRulerLane,
+		forceHeight: number,
+		color: string, darkColor: string
+	) {
+		this.startLineNumber = startLineNumber;
+		this.endLineNumber = endLineNumber;
+		this.position = position;
+		this.forceHeight = forceHeight;
+		this._color = color;
+		this._darkColor = darkColor;
+		this._colorZones = null;
+	}
+
+	public getColor(useDarkColor:boolean): string {
+		if (useDarkColor) {
+			return this._darkColor;
+		}
+		return this._color;
+	}
+
+	public equals(other:OverviewRulerZone): boolean {
+		return (
+			this.startLineNumber === other.startLineNumber
+			&& this.endLineNumber === other.endLineNumber
+			&& this.position === other.position
+			&& this.forceHeight === other.forceHeight
+			&& this._color === other._color
+			&& this._darkColor === other._darkColor
+		);
+	}
+
+	public compareTo(other:OverviewRulerZone): number {
+		if (this.startLineNumber === other.startLineNumber) {
+			if (this.endLineNumber === other.endLineNumber) {
+				if (this.forceHeight === other.forceHeight) {
+					if (this.position === other.position) {
+						if (this._darkColor === other._darkColor) {
+							if (this._color === other._color) {
+								return 0;
+							}
+							return this._color < other._color ? -1 : 1;
+						}
+						return this._darkColor < other._darkColor ? -1 : 1;
+					}
+					return this.position - other.position;
+				}
+				return this.forceHeight - other.forceHeight;
+			}
+			return this.endLineNumber - other.endLineNumber;
+		}
+		return this.startLineNumber - other.startLineNumber;
+	}
+
+	public setColorZones(colorZones:ColorZone[]): void {
+		this._colorZones = colorZones;
+	}
+
+	public getColorZones(): ColorZone[] {
+		return this._colorZones;
+	}
 }
 /**
  * An overview ruler
  */
 export interface IOverviewRuler {
 	getDomNode(): HTMLElement;
 	dispose(): void;
-	setZones(zones:IOverviewRulerZone[]): void;
+	setZones(zones:OverviewRulerZone[]): void;
 	setLayout(position:editorCommon.IOverviewRulerPosition): void;
 }
 /**

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/standalone/colorizer.ts
code:
@@ -6,10 +6,11 @@
 
 import {RunOnceScheduler} from 'vs/base/common/async';
 import {TPromise} from 'vs/base/common/winjs.base';
-import {ILineToken, IModel, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {LineToken, IModel} from 'vs/editor/common/editorCommon';
 import {ILineTokens, IMode} from 'vs/editor/common/modes';
 import {IModeService} from 'vs/editor/common/services/modeService';
-import {IRenderLineOutput, renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import {IRenderLineOutput, renderLine, RenderLineInput} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
 export interface IColorizerOptions {
 	tabSize?: number;
@@ -91,21 +92,22 @@ export class Colorizer {
 		return result;
 	}
 
-	public static colorizeLine(line:string, tokens:ILineToken[], tabSize:number = 4): string {
-		var renderResult = renderLine({
-			lineContent: line,
-			parts: tokens,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			tabSize: tabSize
-		});
-		return renderResult.output.join('');
+	public static colorizeLine(line:string, tokens:LineToken[], tabSize:number = 4): string {
+		var renderResult = renderLine(new RenderLineInput(
+			line,
+			tabSize,
+			0,
+			-1,
+			false,
+			tokens
+		));
+		return renderResult.output;
 	}
 
 	public static colorizeModelLine(model:IModel, lineNumber:number, tabSize:number = 4): string {
 		var content = model.getLineContent(lineNumber);
 		var tokens = model.getLineTokens(lineNumber, false);
-		var inflatedTokens = LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
+		var inflatedTokens = TokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
 		return this.colorizeLine(content, inflatedTokens, tabSize);
 	}
 }
@@ -135,13 +137,14 @@ function actualColorize(lines:string[], mode:IMode, tabSize:number): IActualColo
 			retokenize.push(tokenizeResult.retokenize);
 		}
 
-		renderResult = renderLine({
-			lineContent: line,
-			parts: tokenizeResult.tokens,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			tabSize: tabSize
-		});
+		renderResult = renderLine(new RenderLineInput(
+			line,
+			tabSize,
+			0,
+			-1,
+			false,
+			tokenizeResult.tokens.map(t => new LineToken(t.startIndex, t.type))
+		));
 
 		html = html.concat(renderResult.output);
 		html.push('<br/>');

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/standalone/standaloneCodeEditor.ts
code:
@@ -293,12 +293,12 @@ var startup = (function() {
 })();
 
 function shallowClone<T>(obj:T): T {
-	var r:T = <any>{};
+	let r:T = <any>{};
 	if (obj) {
-		for (var key in obj) {
-			if (obj.hasOwnProperty(key)) {
-				r[key] = obj[key];
-			}
+		let keys = Object.keys(obj);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let key = keys[i];
+			r[key] = obj[key];
 		}
 	}
 	return r;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/standalone/standaloneEditor.ts
code:
@@ -12,6 +12,7 @@ import {ClassNames, ContentWidgetPositionPreference, OverlayWidgetPositionPrefer
 import {Colorizer} from 'vs/editor/browser/standalone/colorizer';
 import * as standaloneCodeEditor from 'vs/editor/browser/standalone/standaloneCodeEditor';
 import {ILanguageDef} from 'vs/editor/standalone-languages/types';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
 var global:any = self;
 if (!global.Monaco) {
@@ -40,7 +41,7 @@ Monaco.Editor.wrappingIndentFromString = editorCommon.wrappingIndentFromString;
 Monaco.Editor.OverviewRulerLane = editorCommon.OverviewRulerLane;
 Monaco.Editor.EndOfLinePreference = editorCommon.EndOfLinePreference;
 Monaco.Editor.EndOfLineSequence = editorCommon.EndOfLineSequence;
-Monaco.Editor.LineTokensBinaryEncoding = editorCommon.LineTokensBinaryEncoding;
+Monaco.Editor.LineTokensBinaryEncoding = TokensBinaryEncoding;
 Monaco.Editor.TrackedRangeStickiness = editorCommon.TrackedRangeStickiness;
 Monaco.Editor.VerticalRevealType = editorCommon.VerticalRevealType;
 Monaco.Editor.MouseTargetType = editorCommon.MouseTargetType;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/standalone/standaloneServices.ts
code:
@@ -90,12 +90,12 @@ export interface IStaticServices {
 }
 
 function shallowClone<T>(obj:T): T {
-	var r:T = <any>{};
+	let r:T = <any>{};
 	if (obj) {
-		for (var key in obj) {
-			if (obj.hasOwnProperty(key)) {
-				r[key] = obj[key];
-			}
+		let keys = Object.keys(obj);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let key = keys[i];
+			r[key] = obj[key];
 		}
 	}
 	return r;
@@ -106,11 +106,11 @@ export function ensureStaticPlatformServices(services: IEditorOverrideServices):
 
 	var statics = getOrCreateStaticServices(services);
 
-	for (var serviceId in statics) {
-		if (statics.hasOwnProperty(serviceId)) {
-			if (!services.hasOwnProperty(serviceId)) {
-				services[serviceId] = statics[serviceId];
-			}
+	let keys = Object.keys(statics);
+	for (let i = 0, len = keys.length; i < len; i++) {
+		let serviceId = keys[i];
+		if (!services.hasOwnProperty(serviceId)) {
+			services[serviceId] = statics[serviceId];
 		}
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/dynamicViewOverlay.ts
code:
@@ -0,0 +1,19 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+'use strict';
+
+import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
+import {IRenderingContext} from 'vs/editor/browser/editorBrowser';
+
+export abstract class DynamicViewOverlay extends ViewEventHandler {
+
+	public abstract dispose(): void;
+
+	public abstract prepareRender(ctx:IRenderingContext): void;
+
+	public abstract render(startLineNumber:number, lineNumber:number): string;
+
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/viewEventDispatcher.ts
code:
@@ -10,76 +10,87 @@ import {IViewEventHandler} from 'vs/editor/browser/editorBrowser';
 
 export class ViewEventDispatcher implements IViewEventBus {
 
-	private eventHandlerGateKeeper:(callback:()=>void)=>void;
-	private eventHandlers:IViewEventHandler[];
-	private eventQueue:IEmitterEvent[];
-	private isConsumingQueue:boolean;
+	private _eventHandlerGateKeeper:(callback:()=>void)=>void;
+	private _eventHandlers:IViewEventHandler[];
+	private _eventQueue:IEmitterEvent[];
+	private _isConsumingQueue:boolean;
 
 	constructor(eventHandlerGateKeeper:(callback:()=>void)=>void) {
-		this.eventHandlerGateKeeper = eventHandlerGateKeeper;
-		this.eventHandlers = [];
-		this.eventQueue = [];
-		this.isConsumingQueue = false;
+		this._eventHandlerGateKeeper = eventHandlerGateKeeper;
+		this._eventHandlers = [];
+		this._eventQueue = null;
+		this._isConsumingQueue = false;
 	}
 
 	public addEventHandler(eventHandler: IViewEventHandler): void {
-		for (var i = 0, len = this.eventHandlers.length; i < len; i++) {
-			if (this.eventHandlers[i] === eventHandler) {
+		for (let i = 0, len = this._eventHandlers.length; i < len; i++) {
+			if (this._eventHandlers[i] === eventHandler) {
 				console.warn('Detected duplicate listener in ViewEventDispatcher', eventHandler);
 			}
 		}
-		this.eventHandlers.push(eventHandler);
+		this._eventHandlers.push(eventHandler);
 	}
 
 	public removeEventHandler(eventHandler:IViewEventHandler): void {
-		for (var i = 0; i < this.eventHandlers.length; i++) {
-			if (this.eventHandlers[i] === eventHandler) {
-				this.eventHandlers.splice(i, 1);
+		for (let i = 0; i < this._eventHandlers.length; i++) {
+			if (this._eventHandlers[i] === eventHandler) {
+				this._eventHandlers.splice(i, 1);
 				break;
 			}
 		}
 	}
 
 	public emit(eventType:string, data?:any): void {
-		this.eventQueue.push(new EmitterEvent(eventType, data));
-		if (!this.isConsumingQueue) {
+		let event = new EmitterEvent(eventType, data);
+
+		if (this._eventQueue) {
+			this._eventQueue.push(event);
+		} else {
+			this._eventQueue = [event];
+		}
+
+		if (!this._isConsumingQueue) {
 			this.consumeQueue();
 		}
 	}
 
 	public emitMany(events:IEmitterEvent[]): void {
-		this.eventQueue = this.eventQueue.concat(events);
-		if (!this.isConsumingQueue) {
+		if (this._eventQueue) {
+			this._eventQueue = this._eventQueue.concat(events);
+		} else {
+			this._eventQueue = events;
+		}
+
+		if (!this._isConsumingQueue) {
 			this.consumeQueue();
 		}
 	}
 
 	private consumeQueue(): void {
-		this.eventHandlerGateKeeper(() => {
+		this._eventHandlerGateKeeper(() => {
 			try {
-				this.isConsumingQueue = true;
-
-				var i:number,
-					len:number,
-					eventHandlers:IViewEventHandler[],
-					events:IEmitterEvent[];
+				this._isConsumingQueue = true;
 
-				while (this.eventQueue.length > 0) {
-					// Empty event queue, as events might come in while sending these off
-					events = this.eventQueue;
-					this.eventQueue = [];
-
-					// Use a clone of the event handlers list, as they might remove themselves
-					eventHandlers = this.eventHandlers.slice(0);
-					for (i = 0, len = eventHandlers.length; i < len; i++) {
-						eventHandlers[i].handleEvents(events);
-					}
-				}
+				this._doConsumeQueue();
 
 			} finally {
-				this.isConsumingQueue = false;
+				this._isConsumingQueue = false;
 			}
 		});
 	}
 
+	private _doConsumeQueue(): void {
+		while (this._eventQueue) {
+			// Empty event queue, as events might come in while sending these off
+			let events = this._eventQueue;
+			this._eventQueue = null;
+
+			// Use a clone of the event handlers list, as they might remove themselves
+			let eventHandlers = this._eventHandlers.slice(0);
+			for (let i = 0, len = eventHandlers.length; i < len; i++) {
+				eventHandlers[i].handleEvents(events);
+			}
+		}
+	}
+
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/viewImpl.ts
code:
@@ -38,6 +38,7 @@ import {ScrollDecorationViewPart} from 'vs/editor/browser/viewParts/scrollDecora
 import {SelectionsOverlay} from 'vs/editor/browser/viewParts/selections/selections';
 import {ViewCursors} from 'vs/editor/browser/viewParts/viewCursors/viewCursors';
 import {ViewZones} from 'vs/editor/browser/viewParts/viewZones/viewZones';
+import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export class View extends ViewEventHandler implements editorBrowser.IView, IDisposable {
 
@@ -56,7 +57,7 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 	private viewZones: ViewZones;
 	private contentWidgets: ViewContentWidgets;
 	private overlayWidgets: ViewOverlayWidgets;
-	private viewParts: editorBrowser.IViewPart[];
+	private viewParts: ViewPart[];
 
 	private keyboardHandler: KeyboardHandler;
 	private pointerHandler: PointerHandler;
@@ -264,7 +265,7 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 		this.linesContent.appendChild(contentViewOverlays.getDomNode());
 		this.linesContent.appendChild(rulers.domNode);
 		this.linesContent.appendChild(this.viewZones.domNode);
-		this.linesContent.appendChild(this.viewLines.domNode);
+		this.linesContent.appendChild(this.viewLines.getDomNode());
 		this.linesContent.appendChild(this.contentWidgets.domNode);
 		this.linesContent.appendChild(viewCursors.getDomNode());
 		this.overflowGuardContainer.appendChild(marginViewOverlays.getDomNode());
@@ -682,12 +683,7 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 				}
 			};
 
-			var r: any = null;
-			try {
-				r = callback(changeAccessor);
-			} catch (e) {
-				onUnexpectedError(e);
-			}
+			var r: any = safeInvoke1Arg(callback, changeAccessor);
 
 			// Invalidate changeAccessor
 			changeAccessor.addZone = null;
@@ -798,12 +794,8 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 			throw new Error('ViewImpl._renderOnce: View is disposed');
 		}
 		return this.outgoingEventBus.deferredEmit(() => {
-			try {
-				var r = callback ? callback() : null;
-			} finally {
-				this._scheduleRender();
-			}
-
+			let r = safeInvokeNoArg(callback);
+			this._scheduleRender();
 			return r;
 		});
 	}
@@ -823,13 +815,10 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 	}
 
 	private _renderNow(): void {
-		if (this._isDisposed) {
-			throw new Error('ViewImpl._renderNow: View is disposed');
-		}
-		this.actualRender();
+		safeInvokeNoArg(() => this._actualRender());
 	}
 
-	private createRenderingContext(linesViewportData:editorCommon.IViewLinesViewportData): editorBrowser.IRenderingContext {
+	private createRenderingContext(linesViewportData:editorCommon.ViewLinesViewportData): editorBrowser.IRenderingContext {
 
 		var vInfo = this.layoutProvider.getCurrentViewport();
 
@@ -879,41 +868,63 @@ export class View extends ViewEventHandler implements editorBrowser.IView, IDisp
 		return r;
 	}
 
-	private actualRender(): void {
-		if (this._isDisposed) {
-			throw new Error('ViewImpl.actualRender: View is disposed');
+	private _getViewPartsToRender(): ViewPart[] {
+		let result:ViewPart[] = [];
+		for (let i = 0, len = this.viewParts.length; i < len; i++) {
+			let viewPart = this.viewParts[i];
+			if (viewPart.shouldRender()) {
+				result.push(viewPart);
+			}
 		}
+		return result;
+	}
+
+	private _actualRender(): void {
 		if (!dom.isInDOM(this.domNode)) {
 			return;
 		}
+		let t = timer.start(timer.Topic.EDITOR, 'View.render');
 
-		var t = timer.start(timer.Topic.EDITOR, 'View.render');
+		let viewPartsToRender = this._getViewPartsToRender();
 
-		var i:number,
-			len:number;
+		if (!this.viewLines.shouldRender() && viewPartsToRender.length === 0) {
+			// Nothing to render
+			this.keyboardHandler.writeToTextArea();
+			t.stop();
+			return;
+		}
 
-		try {
+		let linesViewportData = this.layoutProvider.getLinesViewportData();
 
-			for (i = 0, len = this.viewParts.length; i < len; i++) {
-				this.viewParts[i].onBeforeForcedLayout();
-			}
+		if (this.viewLines.shouldRender()) {
+			this.viewLines.renderText(linesViewportData, () => {
+				this.keyboardHandler.writeToTextArea();
+			});
+			this.viewLines.onDidRender();
 
-			var linesViewportData = this.viewLines.render();
+			// Rendering of viewLines might cause scroll events to occur, so collect view parts to render again
+			viewPartsToRender = this._getViewPartsToRender();
+		} else {
+			this.keyboardHandler.writeToTextArea();
+		}
 
-			var renderingContext = this.createRenderingContext(linesViewportData);
+		let renderingContext = this.createRenderingContext(linesViewportData);
 
-			// Render the rest of the parts
-			for (i = 0, len = this.viewParts.length; i < len; i++) {
-				this.viewParts[i].onReadAfterForcedLayout(renderingContext);
-			}
+		// Render the rest of the parts
+		for (let i = 0, len = viewPartsToRender.length; i < len; i++) {
+			let viewPart = viewPartsToRender[i];
+			viewPart.prepareRender(renderingContext);
+		}
 
-			for (i = 0, len = this.viewParts.length; i < len; i++) {
-				this.viewParts[i].onWriteAfterForcedLayout();
-			}
-		} catch (err) {
-			onUnexpectedError(err);
+		for (let i = 0, len = viewPartsToRender.length; i < len; i++) {
+			let viewPart = viewPartsToRender[i];
+			viewPart.render(renderingContext);
+			viewPart.onDidRender();
 		}
 
+		// Render the scrollbar
+		this.layoutProvider.renderScrollbar();
+
 		t.stop();
 	}
 
@@ -950,4 +961,20 @@ class ViewContext implements editorBrowser.IViewContext {
 		this.addEventHandler = addEventHandler;
 		this.removeEventHandler = removeEventHandler;
 	}
-}
\ No newline at end of file
+}
+
+function safeInvokeNoArg(func:Function): any {
+	try {
+		return func();
+	} catch(e) {
+		onUnexpectedError(e);
+	}
+}
+
+function safeInvoke1Arg(func:Function, arg1:any): any {
+	try {
+		return func(arg1);
+	} catch(e) {
+		onUnexpectedError(e);
+	}
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/viewLayer.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import * as dom from 'vs/base/browser/dom';
 import * as editorCommon from 'vs/editor/common/editorCommon';
 import {IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
+import {FastDomNode, createFastDomNode} from 'vs/base/browser/styleMutator';
 
 export interface IVisibleLineData {
 	getDomNode(): HTMLElement;
@@ -23,7 +23,7 @@ export interface IVisibleLineData {
 	getLineOuterHTML(out:string[], lineNumber: number, deltaTop: number): void;
 	getLineInnerHTML(lineNumber: number): string;
 
-	shouldUpdateHTML(lineNumber:number, inlineDecorations:editorCommon.IModelDecoration[]): boolean;
+	shouldUpdateHTML(startLineNumber:number, lineNumber:number, inlineDecorations:editorCommon.IModelDecoration[]): boolean;
 	layoutLine(lineNumber: number, deltaTop:number): void;
 }
 
@@ -39,14 +39,16 @@ interface IRendererContext {
 	scrollDomNodeIsAbove: boolean;
 }
 
-export class ViewLayer extends ViewPart {
+export abstract class ViewLayer extends ViewPart {
 
-	public domNode: HTMLElement;
+	protected domNode: FastDomNode;
 
-	_lines:IVisibleLineData[];
-	_rendLineNumberStart:number;
+	protected _lines:IVisibleLineData[];
+	protected _rendLineNumberStart:number;
 
 	private _renderer: ViewLayerRenderer;
+	private _scrollDomNode: HTMLElement;
+	private _scrollDomNodeIsAbove: boolean;
 
 	constructor(context:IViewContext) {
 		super(context);
@@ -56,6 +58,9 @@ export class ViewLayer extends ViewPart {
 		this._lines = [];
 		this._rendLineNumberStart = 1;
 
+		this._scrollDomNode = null;
+		this._scrollDomNodeIsAbove = false;
+
 		this._renderer = new ViewLayerRenderer(
 			() => this._createLine(),
 			() => this._extraDomNodeHTML()
@@ -95,7 +100,8 @@ export class ViewLayer extends ViewPart {
 	public onModelFlushed(): boolean {
 		this._lines = [];
 		this._rendLineNumberStart = 1;
-		dom.clearNode(this.domNode);
+		this._scrollDomNode = null;
+		// No need to clear the dom node because a full .innerHTML will occur in ViewLayerRenderer._render
 		return true;
 	}
 
@@ -123,7 +129,7 @@ export class ViewLayer extends ViewPart {
 			for (i = from; i <= to; i++) {
 				var lineDomNode = this._lines[i].getDomNode();
 				if (lineDomNode) {
-					this.domNode.removeChild(lineDomNode);
+					this.domNode.domNode.removeChild(lineDomNode);
 				}
 			}
 			// Remove from array
@@ -197,7 +203,7 @@ export class ViewLayer extends ViewPart {
 				// Remove from DOM
 				var lineDomNode = lastLine.getDomNode();
 				if (lineDomNode) {
-					this.domNode.removeChild(lineDomNode);
+					this.domNode.domNode.removeChild(lineDomNode);
 				}
 			}
 		}
@@ -233,12 +239,10 @@ export class ViewLayer extends ViewPart {
 
 
 	// ---- end view event handlers
-	private _scrollDomNode: HTMLElement = null;
-	private _scrollDomNodeIsAbove: boolean = false;
-	public _renderLines(linesViewportData:editorCommon.IViewLinesViewportData): void {
+	public _renderLines(linesViewportData:editorCommon.ViewLinesViewportData): void {
 
 		var ctx: IRendererContext = {
-			domNode: this.domNode,
+			domNode: this.domNode.domNode,
 			rendLineNumberStart: this._rendLineNumberStart,
 			lines: this._lines,
 			linesLength: this._lines.length,
@@ -258,12 +262,12 @@ export class ViewLayer extends ViewPart {
 		this._scrollDomNodeIsAbove = resCtx.scrollDomNodeIsAbove;
 	}
 
-	public _createDomNode(): HTMLElement {
-		var domNode = document.createElement('div');
-		domNode.className = 'view-layer';
-		domNode.style.position = 'absolute';
-		domNode.setAttribute('role', 'presentation');
-		domNode.setAttribute('aria-hidden', 'true');
+	public _createDomNode(): FastDomNode {
+		let domNode = createFastDomNode(document.createElement('div'));
+		domNode.setClassName('view-layer');
+		domNode.setPosition('absolute');
+		domNode.domNode.setAttribute('role', 'presentation');
+		domNode.domNode.setAttribute('aria-hidden', 'true');
 		return domNode;
 	}
 
@@ -492,8 +496,55 @@ class ViewLayerRenderer {
 		ctx.lines.splice(removeIndex, removeCount);
 	}
 
+	private static _resolveInlineDecorations(ctx: IRendererContext): editorCommon.IModelDecoration[][] {
+		let result: editorCommon.IModelDecoration[][] = [];
+		for (let i = 0, len = ctx.linesLength; i < len; i++) {
+			let lineNumber = i + ctx.rendLineNumberStart;
+			result[i] = ctx.getInlineDecorationsForLineInViewport(lineNumber);
+		}
+		return result;
+	}
+
+	private _finishRenderingNewLines(ctx: IRendererContext, domNodeIsEmpty:boolean, newLinesHTML: string[], wasNew: boolean[]): void {
+		var lastChild = <HTMLElement>ctx.domNode.lastChild;
+		if (domNodeIsEmpty || !lastChild) {
+			ctx.domNode.innerHTML = this._extraDomNodeHTML() + newLinesHTML.join('');
+		} else {
+			lastChild.insertAdjacentHTML('afterend', newLinesHTML.join(''));
+		}
+
+		var currChild = <HTMLElement>ctx.domNode.lastChild;
+		for (let i = ctx.linesLength - 1; i >= 0; i--) {
+			let line = ctx.lines[i];
+			if (wasNew[i]) {
+				line.setDomNode(currChild);
+				currChild = <HTMLElement>currChild.previousSibling;
+			}
+		}
+	}
+
+	private _finishRenderingInvalidLines(ctx: IRendererContext, invalidLinesHTML: string[], wasInvalid: boolean[]): void {
+		var hugeDomNode = document.createElement('div');
+
+		hugeDomNode.innerHTML = invalidLinesHTML.join('');
+
+		var lineDomNode:HTMLElement,
+			source:HTMLElement;
+		for (let i = 0; i < ctx.linesLength; i++) {
+			let line = ctx.lines[i];
+			if (wasInvalid[i]) {
+				source = <HTMLElement>hugeDomNode.firstChild;
+				lineDomNode = line.getDomNode();
+				lineDomNode.parentNode.replaceChild(source, lineDomNode);
+				line.setDomNode(source);
+			}
+		}
+	}
+
 	private _finishRendering(ctx: IRendererContext, domNodeIsEmpty:boolean, deltaTop:number[]): void {
 
+		let inlineDecorations = ViewLayerRenderer._resolveInlineDecorations(ctx);
+
 		var i: number,
 			len: number,
 			line: IVisibleLineData,
@@ -509,7 +560,7 @@ class ViewLayerRenderer {
 			line = ctx.lines[i];
 			lineNumber = i + ctx.rendLineNumberStart;
 
-			if (line.shouldUpdateHTML(lineNumber, ctx.getInlineDecorationsForLineInViewport(lineNumber))) {
+			if (line.shouldUpdateHTML(ctx.rendLineNumberStart, lineNumber, inlineDecorations[i])) {
 				var lineDomNode = line.getDomNode();
 				if (!lineDomNode) {
 					// Line is new
@@ -527,40 +578,11 @@ class ViewLayerRenderer {
 		}
 
 		if (hadNewLine) {
-			var lastChild = <HTMLElement>ctx.domNode.lastChild;
-			if (domNodeIsEmpty || !lastChild) {
-				ctx.domNode.innerHTML = this._extraDomNodeHTML() + newLinesHTML.join('');
-			} else {
-				lastChild.insertAdjacentHTML('afterend', newLinesHTML.join(''));
-			}
-
-			var currChild = <HTMLElement>ctx.domNode.lastChild;
-			for (i = ctx.linesLength - 1; i >= 0; i--) {
-				line = ctx.lines[i];
-				if (wasNew[i]) {
-					line.setDomNode(currChild);
-					currChild = <HTMLElement>currChild.previousSibling;
-				}
-			}
+			this._finishRenderingNewLines(ctx, domNodeIsEmpty, newLinesHTML, wasNew);
 		}
 
 		if (hadInvalidLine) {
-
-			var hugeDomNode = document.createElement('div');
-
-			hugeDomNode.innerHTML = invalidLinesHTML.join('');
-
-			var lineDomNode:HTMLElement,
-				source:HTMLElement;
-			for (i = 0; i < ctx.linesLength; i++) {
-				line = ctx.lines[i];
-				if (wasInvalid[i]) {
-					source = <HTMLElement>hugeDomNode.firstChild;
-					lineDomNode = line.getDomNode();
-					lineDomNode.parentNode.replaceChild(source, lineDomNode);
-					line.setDomNode(source);
-				}
-			}
+			this._finishRenderingInvalidLines(ctx, invalidLinesHTML, wasInvalid);
 		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/viewOverlays.ts
code:
@@ -5,52 +5,67 @@
 'use strict';
 
 import * as browser from 'vs/base/browser/browser';
-import * as dom from 'vs/base/browser/dom';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
-import {IConfigurationChangedEvent, IEditorLayoutInfo, IModelDecoration, IScrollEvent} from 'vs/editor/common/editorCommon';
+import {StyleMutator, FastDomNode, createFastDomNode} from 'vs/base/browser/styleMutator';
+import {IConfigurationChangedEvent, IEditorLayoutInfo, IModelDecoration} from 'vs/editor/common/editorCommon';
 import * as editorBrowser from 'vs/editor/browser/editorBrowser';
 import {IVisibleLineData, ViewLayer} from 'vs/editor/browser/view/viewLayer';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
 
 export class ViewOverlays extends ViewLayer {
-	private _dynamicOverlays:editorBrowser.IDynamicViewOverlay[];
 
+	private _dynamicOverlays:DynamicViewOverlay[];
+	private _isFocused:boolean;
 	_layoutProvider:editorBrowser.ILayoutProvider;
 
 	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context);
 
-		this._layoutProvider = layoutProvider;
 		this._dynamicOverlays = [];
+		this._isFocused = false;
+		this._layoutProvider = layoutProvider;
+
+		this.domNode.setClassName('view-overlays');
+	}
 
-		this.domNode.className = 'view-overlays';
+	public shouldRender(): boolean {
+		if (super.shouldRender()) {
+			return true;
+		}
 
+		for (let i = 0, len = this._dynamicOverlays.length; i < len; i++) {
+			let dynamicOverlay = this._dynamicOverlays[i];
+			if (dynamicOverlay.shouldRender()) {
+				return true;
+			}
+		}
+
+		return false;
 	}
 
 	public dispose(): void {
 		super.dispose();
 		this._layoutProvider = null;
 
-		for(var i = 0; i < this._dynamicOverlays.length; i++) {
-			this._dynamicOverlays[i].dispose();
+		for (let i = 0, len = this._dynamicOverlays.length; i < len; i++) {
+			let dynamicOverlay = this._dynamicOverlays[i];
+			dynamicOverlay.dispose();
 		}
 		this._dynamicOverlays = null;
 	}
 
 	public getDomNode(): HTMLElement {
-		return this.domNode;
+		return this.domNode.domNode;
 	}
 
-	public addDynamicOverlay(overlay:editorBrowser.IDynamicViewOverlay): void {
+	public addDynamicOverlay(overlay:DynamicViewOverlay): void {
 		this._dynamicOverlays.push(overlay);
 	}
 
 	// ----- event handlers
 
 	public onViewFocusChanged(isFocused:boolean): boolean {
-		this._requestModificationFrame(() => {
-			dom.toggleClass(this.domNode, 'focused', isFocused);
-		});
-		return false;
+		this._isFocused = isFocused;
+		return true;
 	}
 
 	// ----- end event handlers
@@ -61,49 +76,55 @@ export class ViewOverlays extends ViewLayer {
 	}
 
 
-	public onReadAfterForcedLayout(ctx:editorBrowser.IRenderingContext): void {
-		// Overwriting to bypass `shouldRender` flag
-		for (var i = 0; i < this._dynamicOverlays.length; i++) {
-			this._dynamicOverlays[i].shouldCallRender2(ctx);
-		}
+	public prepareRender(ctx:editorBrowser.IRenderingContext): void {
+		let toRender = this._dynamicOverlays.filter(overlay => overlay.shouldRender());
 
-		this._requestModificationFrame(() => {
-			this._viewOverlaysRender(ctx);
-		});
+		for (let i = 0, len = toRender.length; i < len; i++) {
+			let dynamicOverlay = toRender[i];
+			dynamicOverlay.prepareRender(ctx);
+			dynamicOverlay.onDidRender();
+		}
 
 		return null;
 	}
 
-	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
-		super._renderLines(ctx.linesViewportData);
+	public render(ctx:editorBrowser.IRestrictedRenderingContext): void {
+		// Overwriting to bypass `shouldRender` flag
+		this._viewOverlaysRender(ctx);
+
+		this.domNode.toggleClassName('focused', this._isFocused);
 	}
 
-	public onWriteAfterForcedLayout(): void {
-		// Overwriting to bypass `shouldRender` flag
-		this._executeModificationRunners();
+	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
+		super._renderLines(ctx.linesViewportData);
 	}
 }
 
 class ViewOverlayLine implements IVisibleLineData {
 
 	private _context:editorBrowser.IViewContext;
-	private _dynamicOverlays:editorBrowser.IDynamicViewOverlay[];
-	private _domNode: HTMLElement;
-	private _renderPieces: string[];
+	private _dynamicOverlays:DynamicViewOverlay[];
+	private _domNode: FastDomNode;
+	private _renderPieces: string;
+	private _lineHeight: number;
 
-	constructor(context:editorBrowser.IViewContext, dynamicOverlays:editorBrowser.IDynamicViewOverlay[]) {
+	constructor(context:editorBrowser.IViewContext, dynamicOverlays:DynamicViewOverlay[]) {
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
 		this._dynamicOverlays = dynamicOverlays;
 
 		this._domNode = null;
 		this._renderPieces = null;
 	}
 
 	public getDomNode(): HTMLElement {
-		return this._domNode;
+		if (!this._domNode) {
+			return null;
+		}
+		return this._domNode.domNode;
 	}
 	public setDomNode(domNode:HTMLElement): void {
-		this._domNode = domNode;
+		this._domNode = createFastDomNode(domNode);
 	}
 
 	onContentChanged(): void {
@@ -122,31 +143,20 @@ class ViewOverlayLine implements IVisibleLineData {
 		// Nothing
 	}
 	onConfigurationChanged(e:IConfigurationChangedEvent): void {
-		// Nothing
-	}
-
-	private _piecesEqual(newPieces: string[]): boolean {
-		if (!this._renderPieces || this._renderPieces.length !== newPieces.length) {
-			return false;
-		}
-		for (var i = 0, len = newPieces.length; i < len; i++) {
-			if (this._renderPieces[i] !== newPieces[i]) {
-				return false;
-			}
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
 		}
-		return true;
 	}
 
-	shouldUpdateHTML(lineNumber:number, inlineDecorations:IModelDecoration[]): boolean {
-		var newPieces: string[] = [];
-		for (var i = 0; i < this._dynamicOverlays.length; i++) {
-			var pieces = this._dynamicOverlays[i].render2(lineNumber);
-			if (pieces && pieces.length > 0) {
-				newPieces = newPieces.concat(pieces);
-			}
+	shouldUpdateHTML(startLineNumber:number, lineNumber:number, inlineDecorations:IModelDecoration[]): boolean {
+		let newPieces = '';
+		for (let i = 0, len = this._dynamicOverlays.length; i < len; i++) {
+			let dynamicOverlay = this._dynamicOverlays[i];
+			newPieces += dynamicOverlay.render(startLineNumber, lineNumber);
 		}
 
-		var piecesEqual = this._piecesEqual(newPieces);
+		let piecesEqual = (this._renderPieces === newPieces);
+
 		if (!piecesEqual) {
 			this._renderPieces = newPieces;
 		}
@@ -160,7 +170,7 @@ class ViewOverlayLine implements IVisibleLineData {
 		out.push('" style="top:');
 		out.push(deltaTop.toString());
 		out.push('px;height:');
-		out.push(this._context.configuration.editor.lineHeight.toString());
+		out.push(this._lineHeight.toString());
 		out.push('px;" class="');
 		out.push(editorBrowser.ClassNames.VIEW_LINE);
 		out.push('">');
@@ -169,36 +179,38 @@ class ViewOverlayLine implements IVisibleLineData {
 	}
 
 	getLineInnerHTML(lineNumber: number): string {
-		return this._renderPieces.join('');
+		return this._renderPieces;
 	}
 
 	layoutLine(lineNumber: number, deltaTop:number): void {
-		var currentLineNumber = this._domNode.getAttribute('lineNumber');
-		if (currentLineNumber !== lineNumber.toString()) {
-			this._domNode.setAttribute('lineNumber', lineNumber.toString());
-		}
-		StyleMutator.setTop(this._domNode, deltaTop);
-		StyleMutator.setHeight(this._domNode, this._context.configuration.editor.lineHeight);
+		this._domNode.setLineNumber(String(lineNumber));
+		this._domNode.setTop(deltaTop);
+		this._domNode.setHeight(this._lineHeight);
 	}
 }
 
 export class ContentViewOverlays extends ViewOverlays {
 
+	private _scrollWidth: number;
+
 	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context, layoutProvider);
 
-		StyleMutator.setWidth(this.domNode, 0);
-		StyleMutator.setHeight(this.domNode, 0);
+		this._scrollWidth = this._layoutProvider.getScrollWidth();
+
+		this.domNode.setWidth(this._scrollWidth);
+		this.domNode.setHeight(0);
 	}
 
 	public onScrollWidthChanged(scrollWidth:number): boolean {
+		this._scrollWidth = this._layoutProvider.getScrollWidth();
 		return true;
 	}
 
 	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
 		super._viewOverlaysRender(ctx);
 
-		StyleMutator.setWidth(this.domNode, this._layoutProvider.getScrollWidth());
+		this.domNode.setWidth(this._scrollWidth);
 	}
 }
 
@@ -207,17 +219,18 @@ export class MarginViewOverlays extends ViewOverlays {
 	private _glyphMarginLeft:number;
 	private _glyphMarginWidth:number;
 	private _scrollHeight:number;
+	private _contentLeft: number;
 
 	constructor(context:editorBrowser.IViewContext, layoutProvider:editorBrowser.ILayoutProvider) {
 		super(context, layoutProvider);
 
-		this._glyphMarginLeft = 0;
-		this._glyphMarginWidth = 0;
+		this._glyphMarginLeft = context.configuration.editor.layoutInfo.glyphMarginLeft;
+		this._glyphMarginWidth = context.configuration.editor.layoutInfo.glyphMarginWidth;
 		this._scrollHeight = layoutProvider.getScrollHeight();
+		this._contentLeft = context.configuration.editor.layoutInfo.contentLeft;
 
-		this.domNode.className = editorBrowser.ClassNames.MARGIN_VIEW_OVERLAYS + ' monaco-editor-background';
-		StyleMutator.setWidth(this.domNode, 1);
-		this._hasVerticalScroll = true;
+		this.domNode.setClassName(editorBrowser.ClassNames.MARGIN_VIEW_OVERLAYS + ' monaco-editor-background');
+		this.domNode.setWidth(1);
 	}
 
 	protected _extraDomNodeHTML(): string {
@@ -235,57 +248,39 @@ export class MarginViewOverlays extends ViewOverlays {
 	}
 
 	private _getGlyphMarginDomNode(): HTMLElement {
-		return <HTMLElement>this.domNode.children[0];
+		return <HTMLElement>this.domNode.domNode.children[0];
 	}
 
 	public onScrollHeightChanged(scrollHeight:number): boolean {
 		this._scrollHeight = scrollHeight;
-		this._requestModificationFrame(() => {
-			var glyphMargin = this._getGlyphMarginDomNode();
-			if (glyphMargin) {
-				StyleMutator.setHeight(glyphMargin, this._scrollHeight);
-			}
-		});
 		return super.onScrollHeightChanged(scrollHeight) || true;
 	}
 
 	public onLayoutChanged(layoutInfo:IEditorLayoutInfo): boolean {
 		this._glyphMarginLeft = layoutInfo.glyphMarginLeft;
 		this._glyphMarginWidth = layoutInfo.glyphMarginWidth;
 		this._scrollHeight = this._layoutProvider.getScrollHeight();
-
-		this._requestModificationFrame(() => {
-			StyleMutator.setWidth(this.domNode, layoutInfo.contentLeft);
-
-			var glyphMargin = this._getGlyphMarginDomNode();
-			if (glyphMargin) {
-				StyleMutator.setLeft(glyphMargin, layoutInfo.glyphMarginLeft);
-				StyleMutator.setWidth(glyphMargin, layoutInfo.glyphMarginWidth);
-			}
-		});
+		this._contentLeft = layoutInfo.contentLeft;
 		return super.onLayoutChanged(layoutInfo) || true;
 	}
 
-	private _hasVerticalScroll = false;
-	public onScrollChanged(e:IScrollEvent): boolean {
-		this._hasVerticalScroll = this._hasVerticalScroll || e.vertical;
-		return super.onScrollChanged(e);
-	}
-
 	_viewOverlaysRender(ctx:editorBrowser.IRestrictedRenderingContext): void {
 		super._viewOverlaysRender(ctx);
-		if (this._hasVerticalScroll) {
-			if (browser.canUseTranslate3d) {
-				var transform = 'translate3d(0px, ' + ctx.linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
-				StyleMutator.setTransform(this.domNode, transform);
-			} else {
-				if (this._hasVerticalScroll) {
-					StyleMutator.setTop(this.domNode, ctx.linesViewportData.visibleRangesDeltaTop);
-				}
-			}
-			this._hasVerticalScroll = false;
+		if (browser.canUseTranslate3d) {
+			var transform = 'translate3d(0px, ' + ctx.linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
+			this.domNode.setTransform(transform);
+		} else {
+			this.domNode.setTop(ctx.linesViewportData.visibleRangesDeltaTop);
 		}
 		var height = Math.min(this._layoutProvider.getTotalHeight(), 1000000);
-		StyleMutator.setHeight(this.domNode, height);
+		this.domNode.setHeight(height);
+		this.domNode.setWidth(this._contentLeft);
+
+		var glyphMargin = this._getGlyphMarginDomNode();
+		if (glyphMargin) {
+			StyleMutator.setHeight(glyphMargin, this._scrollHeight);
+			StyleMutator.setLeft(glyphMargin, this._glyphMarginLeft);
+			StyleMutator.setWidth(glyphMargin, this._glyphMarginWidth);
+		}
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/view/viewPart.ts
code:
@@ -5,82 +5,23 @@
 'use strict';
 
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IRenderingContext, IViewContext, IViewPart} from 'vs/editor/browser/editorBrowser';
+import {IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-export interface IRunner {
-	(): void;
-}
-
-export class ViewPart extends ViewEventHandler implements IViewPart {
+export abstract class ViewPart extends ViewEventHandler {
 
 	_context:IViewContext;
-	private _modificationBeforeRenderingRunners:IRunner[];
-	private _modificationRunners:IRunner[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
 		this._context.addEventHandler(this);
-		this._modificationBeforeRenderingRunners = [];
-		this._modificationRunners = [];
 	}
 
 	public dispose(): void {
 		this._context.removeEventHandler(this);
 		this._context = null;
-		this._modificationBeforeRenderingRunners = [];
-		this._modificationRunners = [];
 	}
 
-	/**
-	 * Modify the DOM right before when the orchestrated rendering occurs.
-	 */
-	_requestModificationFrameBeforeRendering(runner:IRunner): void {
-		this._modificationBeforeRenderingRunners.push(runner);
-	}
-
-	/**
-	 * Modify the DOM when the orchestrated rendering occurs.
-	 */
-	_requestModificationFrame(runner:IRunner): void {
-		this._modificationRunners.push(runner);
-	}
-
-	public onBeforeForcedLayout(): void {
-		if (this._modificationBeforeRenderingRunners.length > 0) {
-			for (var i = 0; i < this._modificationBeforeRenderingRunners.length; i++) {
-				this._modificationBeforeRenderingRunners[i]();
-			}
-			this._modificationBeforeRenderingRunners = [];
-		}
-	}
-
-	public onReadAfterForcedLayout(ctx:IRenderingContext): void {
-		if (!this.shouldRender) {
-			return;
-		}
-		this._render(ctx);
-	}
-
-	public onWriteAfterForcedLayout(): void {
-		if (!this.shouldRender) {
-			return;
-		}
-		this.shouldRender = false;
-
-		this._executeModificationRunners();
-	}
-
-	_executeModificationRunners(): void {
-		if (this._modificationRunners.length > 0) {
-			for (var i = 0; i < this._modificationRunners.length; i++) {
-				this._modificationRunners[i]();
-			}
-			this._modificationRunners = [];
-		}
-	}
-
-	_render(ctx:IRenderingContext): void {
-		throw new Error('Implement me!');
-	}
-}
\ No newline at end of file
+	public abstract prepareRender(ctx:IRenderingContext): void;
+	public abstract render(ctx:IRestrictedRenderingContext): void;
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewLayout/layoutProvider.ts
code:
@@ -80,6 +80,7 @@ export class LayoutProvider extends ViewEventHandler implements IDisposable, ILa
 	}
 
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		this.linesLayout.onConfigurationChanged(e);
 		if (e.layoutInfo) {
 			this.scrollable.setWidth(this.configuration.editor.layoutInfo.contentWidth);
 			this.scrollable.setHeight(this.configuration.editor.layoutInfo.contentHeight);
@@ -103,13 +104,13 @@ export class LayoutProvider extends ViewEventHandler implements IDisposable, ILa
 
 	// ---- Layouting logic
 
-	public getCurrentViewport(): editorCommon.IViewport {
-		return {
-			top: this.scrollable.getScrollTop(),
-			left: this.scrollable.getScrollLeft(),
-			width: this.configuration.editor.layoutInfo.contentWidth,
-			height: this.configuration.editor.layoutInfo.contentHeight
-		};
+	public getCurrentViewport(): editorCommon.Viewport {
+		return new editorCommon.Viewport(
+			this.scrollable.getScrollTop(),
+			this.scrollable.getScrollLeft(),
+			this.scrollable.getWidth(),
+			this.scrollable.getHeight()
+		);
 	}
 
 	public getCenteredViewLineNumberInViewport(): number {
@@ -202,7 +203,7 @@ export class LayoutProvider extends ViewEventHandler implements IDisposable, ILa
 	public getWhitespaceAtVerticalOffset(verticalOffset:number): editorCommon.IViewWhitespaceViewportData {
 		return this.linesLayout.getWhitespaceAtVerticalOffset(verticalOffset);
 	}
-	public getLinesViewportData(): editorCommon.IViewLinesViewportData {
+	public getLinesViewportData(): editorCommon.ViewLinesViewportData {
 		return this.linesLayout.getLinesViewportData(this.getCurrentViewport());
 	}
 	public getWhitespaceViewportData(): editorCommon.IViewWhitespaceViewportData[] {
@@ -248,4 +249,8 @@ export class LayoutProvider extends ViewEventHandler implements IDisposable, ILa
 	public getScrolledTopFromAbsoluteTop(top:number): number {
 		return top - this.scrollable.getScrollTop();
 	}
+
+	public renderScrollbar(): void {
+		this.scrollManager.renderScrollbar();
+	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewLayout/scrollManager.ts
code:
@@ -42,12 +42,12 @@ export class ScrollManager implements IDisposable {
 		var configScrollbarOpts = this.configuration.editor.scrollbar;
 
 		var scrollbarOptions:IScrollableElementCreationOptions = {
-			scrollable: this.scrollable,
 			listenOnDomNode: viewDomNode,
 			vertical: configScrollbarOpts.vertical,
 			horizontal: configScrollbarOpts.horizontal,
 			className: ClassNames.SCROLLABLE_ELEMENT + ' ' + this.configuration.editor.theme,
 			useShadows: false,
+			lazyRender: true,
 			saveLastScrollTimeOnClassName: ClassNames.VIEW_LINE
 		};
 		addPropertyIfPresent(configScrollbarOpts, scrollbarOptions, 'verticalHasArrows');
@@ -61,15 +61,12 @@ export class ScrollManager implements IDisposable {
 		addPropertyIfPresent(configScrollbarOpts, scrollbarOptions, 'mouseWheelScrollSensitivity');
 
 
-		this.scrollbar = new ScrollableElement(linesContent, scrollbarOptions, {
+		this.scrollbar = new ScrollableElement(linesContent, this.scrollable, scrollbarOptions, {
 			width: this.configuration.editor.layoutInfo.contentWidth,
 			height: this.configuration.editor.layoutInfo.contentHeight,
 		});
 		this.toDispose.push(this.scrollbar);
 
-		this.toDispose.push(this.scrollable.addInternalSizeChangeListener(() => {
-			this.scrollbar.onElementInternalDimensions();
-		}));
 		this.toDispose.push(this.configuration.onDidChange((e:IConfigurationChangedEvent) => {
 			this.scrollbar.updateClassName(this.configuration.editor.theme);
 			if (e.scrollbar) {
@@ -109,6 +106,10 @@ export class ScrollManager implements IDisposable {
 		this.toDispose = dispose(this.toDispose);
 	}
 
+	public renderScrollbar(): void {
+		this.scrollbar.renderNow();
+	}
+
 	public onSizeProviderLayoutChanged(): void {
 		if (this.scrollbar) {
 			this.scrollbar.onElementDimensions({

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts
code:
@@ -9,7 +9,7 @@ import 'vs/css!./contentWidgets';
 import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ClassNames, ContentWidgetPositionPreference, IContentWidget, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ClassNames, ContentWidgetPositionPreference, IContentWidget, IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 interface IWidgetData {
@@ -46,6 +46,8 @@ export class ViewContentWidgets extends ViewPart {
 	private _widgets:IWidgetMap;
 	private _contentWidth:number;
 	private _contentLeft: number;
+	private _lineHeight: number;
+	private _renderData:IMyRenderData;
 
 	public domNode:HTMLElement;
 	public overflowingContentWidgetsDomNode:HTMLElement;
@@ -58,6 +60,8 @@ export class ViewContentWidgets extends ViewPart {
 		this._widgets = {};
 		this._contentWidth = 0;
 		this._contentLeft = 0;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._renderData = {};
 
 		this.domNode = document.createElement('div');
 		this.domNode.className = ClassNames.CONTENT_WIDGETS;
@@ -100,22 +104,24 @@ export class ViewContentWidgets extends ViewPart {
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
-		this._contentWidth = layoutInfo.contentWidth;
 		this._contentLeft = layoutInfo.contentLeft;
 
-		this._requestModificationFrameBeforeRendering(() => {
+		if (this._contentWidth !== layoutInfo.contentWidth) {
+			this._contentWidth = layoutInfo.contentWidth;
 			// update the maxWidth on widgets nodes, such that `onReadAfterForcedLayout`
 			// below can read out the adjusted width/height of widgets
-			let widgetId:string;
-			for (widgetId in this._widgets) {
-				if (this._widgets.hasOwnProperty(widgetId)) {
-					StyleMutator.setMaxWidth(this._widgets[widgetId].widget.getDomNode(), this._contentWidth);
-				}
+			let keys = Object.keys(this._widgets);
+			for (let i = 0, len = keys.length; i < len; i++) {
+				let widgetId = keys[i];
+				StyleMutator.setMaxWidth(this._widgets[widgetId].widget.getDomNode(), this._contentWidth);
 			}
-		});
+		}
 
 		return true;
 	}
@@ -156,7 +162,7 @@ export class ViewContentWidgets extends ViewPart {
 			this.domNode.appendChild(domNode);
 		}
 
-		this.shouldRender = true;
+		this.setShouldRender();
 	}
 
 	public setWidgetPosition(widget: IContentWidget, position: editorCommon.IPosition, preference:ContentWidgetPositionPreference[]): void {
@@ -165,7 +171,7 @@ export class ViewContentWidgets extends ViewPart {
 		widgetData.position = position;
 		widgetData.preference = preference;
 
-		this.shouldRender = true;
+		this.setShouldRender();
 	}
 
 	public removeWidget(widget: IContentWidget): void {
@@ -178,7 +184,7 @@ export class ViewContentWidgets extends ViewPart {
 			domNode.parentNode.removeChild(domNode);
 			domNode.removeAttribute('monaco-visible-content-widget');
 
-			this.shouldRender = true;
+			this.setShouldRender();
 		}
 	}
 
@@ -200,7 +206,7 @@ export class ViewContentWidgets extends ViewPart {
 		let heightAboveLine = aboveLineTop;
 
 		// b) the box under the line
-		let underLineTop = visibleRange.top + this._context.configuration.editor.lineHeight;
+		let underLineTop = visibleRange.top + this._lineHeight;
 		let heightUnderLine = ctx.viewportHeight - underLineTop;
 
 		let aboveTop = aboveLineTop - height;
@@ -243,7 +249,7 @@ export class ViewContentWidgets extends ViewPart {
 		}
 
 		let aboveTop = visibleRange.top - height,
-			belowTop = visibleRange.top + this._context.configuration.editor.lineHeight,
+			belowTop = visibleRange.top + this._lineHeight,
 			left = left0 + this._contentLeft;
 
 		let domNodePosition = dom.getDomNodePosition(this._viewDomNode);
@@ -357,52 +363,54 @@ export class ViewContentWidgets extends ViewPart {
 		}
 	}
 
-	_render(ctx:IRenderingContext): void {
-		let data:IMyRenderData = {},
-			renderData: IMyWidgetRenderData,
-			widgetId: string;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+
+		let data:IMyRenderData = {};
 
-		for (widgetId in this._widgets) {
-			if (this._widgets.hasOwnProperty(widgetId)) {
-				renderData = this._prepareRenderWidget(this._widgets[widgetId], ctx);
-				if (renderData) {
-					data[widgetId] = renderData;
-				}
+		let keys = Object.keys(this._widgets);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let widgetId = keys[i];
+			let renderData = this._prepareRenderWidget(this._widgets[widgetId], ctx);
+			if (renderData) {
+				data[widgetId] = renderData;
 			}
 		}
 
-		this._requestModificationFrame(() => {
-			let widgetId:string,
-				widget:IWidgetData,
-				domNode: HTMLElement;
-
-			for (widgetId in this._widgets) {
-				if (this._widgets.hasOwnProperty(widgetId)) {
-					widget = this._widgets[widgetId];
-					domNode = this._widgets[widgetId].widget.getDomNode();
-
-					if (data.hasOwnProperty(widgetId)) {
-						if (widget.allowEditorOverflow) {
-							StyleMutator.setTop(domNode, data[widgetId].top);
-							StyleMutator.setLeft(domNode, data[widgetId].left);
-						} else {
-							StyleMutator.setTop(domNode, data[widgetId].top + ctx.viewportTop - ctx.bigNumbersDelta);
-							StyleMutator.setLeft(domNode, data[widgetId].left);
-						}
-						if (!widget.isVisible) {
-							StyleMutator.setVisibility(domNode, 'inherit');
-							domNode.setAttribute('monaco-visible-content-widget', 'true');
-							widget.isVisible = true;
-						}
-					} else {
-						if (widget.isVisible) {
-							domNode.removeAttribute('monaco-visible-content-widget');
-							widget.isVisible = false;
-							StyleMutator.setVisibility(domNode, 'hidden');
-						}
-					}
+		this._renderData = data;
+	}
+
+	public render(ctx:IRestrictedRenderingContext): void {
+		let data = this._renderData;
+
+		let keys = Object.keys(this._widgets);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let widgetId = keys[i];
+			let widget = this._widgets[widgetId];
+			let domNode = this._widgets[widgetId].widget.getDomNode();
+
+			if (data.hasOwnProperty(widgetId)) {
+				if (widget.allowEditorOverflow) {
+					StyleMutator.setTop(domNode, data[widgetId].top);
+					StyleMutator.setLeft(domNode, data[widgetId].left);
+				} else {
+					StyleMutator.setTop(domNode, data[widgetId].top + ctx.viewportTop - ctx.bigNumbersDelta);
+					StyleMutator.setLeft(domNode, data[widgetId].left);
+				}
+				if (!widget.isVisible) {
+					StyleMutator.setVisibility(domNode, 'inherit');
+					domNode.setAttribute('monaco-visible-content-widget', 'true');
+					widget.isVisible = true;
+				}
+			} else {
+				if (widget.isVisible) {
+					domNode.removeAttribute('monaco-visible-content-widget');
+					widget.isVisible = false;
+					StyleMutator.setVisibility(domNode, 'hidden');
 				}
 			}
-		});
+		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/currentLineHighlight/currentLineHighlight.ts
code:
@@ -7,11 +7,13 @@
 
 import 'vs/css!./currentLineHighlight';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IDynamicViewOverlay, ILayoutProvider, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ILayoutProvider, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
 
-export class CurrentLineHighlightOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class CurrentLineHighlightOverlay extends DynamicViewOverlay {
 	private _context:IViewContext;
+	private _lineHeight:number;
+	private _readOnly:boolean;
 	private _layoutProvider:ILayoutProvider;
 	private _selectionIsEmpty:boolean;
 	private _primaryCursorIsInEditableRange:boolean;
@@ -21,6 +23,9 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements IDy
 	constructor(context:IViewContext, layoutProvider:ILayoutProvider) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._readOnly = this._context.configuration.editor.readOnly;
+
 		this._layoutProvider = layoutProvider;
 
 		this._selectionIsEmpty = true;
@@ -72,6 +77,12 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements IDy
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.readOnly) {
+			this._readOnly = this._context.configuration.editor.readOnly;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -92,33 +103,31 @@ export class CurrentLineHighlightOverlay extends ViewEventHandler implements IDy
 	}
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
-		this.shouldRender = false;
 		this._scrollWidth = ctx.scrollWidth;
-		return true;
 	}
 
-	public render2(lineNumber:number): string[] {
+	public render(startLineNumber:number, lineNumber:number): string {
 		if (lineNumber === this._primaryCursorLineNumber) {
 			if (this._shouldShowCurrentLine()) {
-				return [
-					'<div class="current-line" style="width:',
-					String(this._scrollWidth),
-					'px; height:',
-					String(this._context.configuration.editor.lineHeight),
-					'px;"></div>'
-				];
+				return (
+					'<div class="current-line" style="width:'
+					+ String(this._scrollWidth)
+					+ 'px; height:'
+					+ String(this._lineHeight)
+					+ 'px;"></div>'
+				);
 			} else {
-				return null;
+				return '';
 			}
 		}
-		return null;
+		return '';
 	}
 
 	private _shouldShowCurrentLine(): boolean {
-		return this._selectionIsEmpty && this._primaryCursorIsInEditableRange && !this._context.configuration.editor.readOnly;
+		return this._selectionIsEmpty && this._primaryCursorIsInEditableRange && !this._readOnly;
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/decorations/decorations.ts
code:
@@ -7,21 +7,19 @@
 
 import 'vs/css!./decorations';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
+import {IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-interface IRenderResult {
-	[lineNumber:string]:string[];
-}
-
-export class DecorationsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class DecorationsOverlay extends DynamicViewOverlay {
 
 	private _context:IViewContext;
-	private _renderResult:IRenderResult;
+	private _lineHeight: number;
+	private _renderResult: string[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
 		this._renderResult = null;
 
 		this._context.addEventHandler(this);
@@ -60,6 +58,9 @@ export class DecorationsOverlay extends ViewEventHandler implements IDynamicView
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -80,11 +81,10 @@ export class DecorationsOverlay extends ViewEventHandler implements IDynamicView
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
-		this.shouldRender = false;
 
 		let decorations = ctx.getDecorationsInViewport();
 
@@ -112,17 +112,24 @@ export class DecorationsOverlay extends ViewEventHandler implements IDynamicView
 			return a.range.startLineNumber - b.range.startLineNumber;
 		});
 
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
+		let output: string[] = [];
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
+			output[lineIndex] = '';
+		}
+
 		// Render first whole line decorations and then regular decorations
-		let output: IRenderResult = {};
 		this._renderWholeLineDecorations(ctx, decorations, output);
 		this._renderNormalDecorations(ctx, decorations, output);
 		this._renderResult = output;
-
-		return true;
 	}
 
-	private _renderWholeLineDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: IRenderResult): void {
-		let lineHeight = String(this._context.configuration.editor.lineHeight);
+	private _renderWholeLineDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: string[]): void {
+		let lineHeight = String(this._lineHeight);
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
 
 		for (let i = 0, lenI = decorations.length; i < lenI; i++) {
 			let d = decorations[i];
@@ -131,33 +138,26 @@ export class DecorationsOverlay extends ViewEventHandler implements IDynamicView
 				continue;
 			}
 
-			let decorationOutput = [
-				'<div class="cdr ',
-				d.options.className,
-				'" style="left:0;width:100%;height:',
-				lineHeight,
-				'px;"></div>'
-			].join('');
+			let decorationOutput = (
+				'<div class="cdr '
+				+ d.options.className
+				+ '" style="left:0;width:100%;height:'
+				+ lineHeight
+				+ 'px;"></div>'
+			);
 
-			let startLineNumber = d.range.startLineNumber;
-			let endLineNumber = d.range.endLineNumber;
+			let startLineNumber = Math.max(d.range.startLineNumber, visibleStartLineNumber);
+			let endLineNumber = Math.min(d.range.endLineNumber, visibleEndLineNumber);
 			for (let j = startLineNumber; j <= endLineNumber; j++) {
-				if (!ctx.lineIsVisible(j)) {
-					continue;
-				}
-
-				let strLineNumber = String(j);
-				if (output.hasOwnProperty(strLineNumber)) {
-					output[strLineNumber].push(decorationOutput);
-				} else {
-					output[strLineNumber] = [decorationOutput];
-				}
+				let lineIndex = j - visibleStartLineNumber;
+				output[lineIndex] += decorationOutput;
 			}
 		}
 	}
 
-	private _renderNormalDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: IRenderResult): void {
-		let lineHeight = String(this._context.configuration.editor.lineHeight);
+	private _renderNormalDecorations(ctx:IRenderingContext, decorations:editorCommon.IModelDecoration[], output: string[]): void {
+		let lineHeight = String(this._lineHeight);
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
 
 		for (let i = 0, lenI = decorations.length; i < lenI; i++) {
 			let d = decorations[i];
@@ -173,37 +173,35 @@ export class DecorationsOverlay extends ViewEventHandler implements IDynamicView
 			let className = d.options.className;
 			for (let j = 0, lenJ = linesVisibleRanges.length; j < lenJ; j++) {
 				let lineVisibleRanges = linesVisibleRanges[j];
-
-				let strLineNumber = String(lineVisibleRanges.lineNumber);
-				let lineOutput: string[];
-				if (output.hasOwnProperty(strLineNumber)) {
-					lineOutput = output[strLineNumber];
-				} else {
-					lineOutput = [];
-					output[strLineNumber] = lineOutput;
-				}
+				let lineIndex = lineVisibleRanges.lineNumber - visibleStartLineNumber;
 
 				for (let k = 0, lenK = lineVisibleRanges.ranges.length; k < lenK; k++) {
 					let visibleRange = lineVisibleRanges.ranges[k];
-
-					lineOutput.push('<div class="cdr ');
-					lineOutput.push(className);
-					lineOutput.push('" style="left:');
-					lineOutput.push(String(visibleRange.left));
-					lineOutput.push('px;width:');
-					lineOutput.push(String(visibleRange.width));
-					lineOutput.push('px;height:');
-					lineOutput.push(lineHeight);
-					lineOutput.push('px;"></div>');
+					let decorationOutput = (
+						'<div class="cdr '
+						+ className
+						+ '" style="left:'
+						+ String(visibleRange.left)
+						+ 'px;width:'
+						+ String(visibleRange.width)
+						+ 'px;height:'
+						+ lineHeight
+						+ 'px;"></div>'
+					);
+					output[lineIndex] += decorationOutput;
 				}
 			}
 		}
 	}
 
-	public render2(lineNumber:number): string[] {
-		if (this._renderResult && this._renderResult.hasOwnProperty(lineNumber.toString())) {
-			return this._renderResult[lineNumber.toString()];
+	public render(startLineNumber:number, lineNumber:number): string {
+		if (!this._renderResult) {
+			return '';
+		}
+		let lineIndex = lineNumber - startLineNumber;
+		if (lineIndex < 0 || lineIndex >= this._renderResult.length) {
+			throw new Error('Unexpected render request');
 		}
-		return null;
+		return this._renderResult[lineIndex];
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/glyphMargin/glyphMargin.ts
code:
@@ -7,23 +7,86 @@
 
 import 'vs/css!./glyphMargin';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
+import {IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-interface IRenderResult {
-	[lineNumber:string]:string[];
+export class DecorationToRender {
+	public _decorationToRenderTrait:void;
+
+	public startLineNumber:number;
+	public endLineNumber:number;
+	public className:string;
+
+	constructor(startLineNumber:number, endLineNumber:number, className:string) {
+		this.startLineNumber = +startLineNumber;
+		this.endLineNumber = +endLineNumber;
+		this.className = String(className);
+	}
+}
+
+export abstract class DedupOverlay extends DynamicViewOverlay {
+
+	protected _render(visibleStartLineNumber:number, visibleEndLineNumber:number, decorations:DecorationToRender[]): string[] {
+
+		let output: string[] = [];
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
+			output[lineIndex] = '';
+		}
+
+		if (decorations.length === 0) {
+			return output;
+		}
+
+		decorations.sort((a, b) => {
+			if (a.className === b.className) {
+				if (a.startLineNumber === b.startLineNumber) {
+					return a.endLineNumber - b.endLineNumber;
+				}
+				return a.startLineNumber - b.startLineNumber;
+			}
+			return (a.className < b.className ? -1 : 1);
+		});
+
+		let prevClassName:string = null;
+		let prevEndLineIndex = 0;
+		for (let i = 0, len = decorations.length; i < len; i++) {
+			let d = decorations[i];
+			let className = d.className;
+			let startLineIndex = Math.max(d.startLineNumber, visibleStartLineNumber) - visibleStartLineNumber;
+			let endLineIndex = Math.min(d.endLineNumber, visibleEndLineNumber) - visibleStartLineNumber;
+
+			if (prevClassName === className) {
+				startLineIndex = Math.max(prevEndLineIndex + 1, startLineIndex);
+				prevEndLineIndex = Math.max(prevEndLineIndex, endLineIndex);
+			} else {
+				prevClassName = className;
+				prevEndLineIndex = endLineIndex;
+			}
+
+			for (let i = startLineIndex; i <= prevEndLineIndex; i++) {
+				output[i] += ' ' + prevClassName;
+			}
+		}
+
+		return output;
+	}
 }
 
-export class GlyphMarginOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class GlyphMarginOverlay extends DedupOverlay {
 
 	private _context:IViewContext;
+	private _lineHeight:number;
+	private _glyphMargin:boolean;
 	private _glyphMarginLeft:number;
 	private _glyphMarginWidth:number;
-	private _renderResult:IRenderResult;
+	private _renderResult: string[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._glyphMargin = this._context.configuration.editor.glyphMargin;
 		this._glyphMarginLeft = 0;
 		this._glyphMarginWidth = 0;
 		this._renderResult = null;
@@ -63,6 +126,12 @@ export class GlyphMarginOverlay extends ViewEventHandler implements IDynamicView
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.glyphMargin) {
+			this._glyphMargin = this._context.configuration.editor.glyphMargin;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -85,81 +154,64 @@ export class GlyphMarginOverlay extends ViewEventHandler implements IDynamicView
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
+	protected _getDecorations(ctx:IRenderingContext): DecorationToRender[] {
+		let decorations = ctx.getDecorationsInViewport();
+		let r:DecorationToRender[] = [];
+		for (let i = 0, len = decorations.length; i < len; i++) {
+			let d = decorations[i];
+			if (d.options.glyphMarginClassName) {
+				r.push(new DecorationToRender(d.range.startLineNumber, d.range.endLineNumber, d.options.glyphMarginClassName));
+			}
 		}
-		this.shouldRender = false;
+		return r;
+	}
 
-		if (!this._context.configuration.editor.glyphMargin) {
-			this._renderResult = null;
-			return false;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
 
-		var output: IRenderResult = {};
-		var count = 0;
-
-		var decorations = ctx.getDecorationsInViewport(),
-			lineHeight = this._context.configuration.editor.lineHeight.toString(),
-			d:editorCommon.IModelDecoration,
-			rng:editorCommon.IRange,
-			i:number, lenI:number,
-			classNames:{[lineNumber:string]:{[className:string]:boolean;};} = {},
-			lineClassNames:{[className:string]:boolean;},
-			className:string,
-			lineOutput:string[],
-			lineNumber: number,
-			lineNumberStr: string;
-
-		for (i = 0, lenI = decorations.length; i < lenI; i++) {
-			d = decorations[i];
-			if (!d.options.glyphMarginClassName) {
-				continue;
-			}
-
-			rng = d.range;
-			for (lineNumber = rng.startLineNumber; lineNumber <= rng.endLineNumber; lineNumber++) {
-				if (!ctx.lineIsVisible(lineNumber)) {
-					continue;
-				}
-
-				lineNumberStr = lineNumber.toString();
-
-				if (!classNames.hasOwnProperty(lineNumberStr)) {
-					classNames[lineNumberStr] = {};
-				}
-				classNames[lineNumberStr][d.options.glyphMarginClassName] = true;
-			}
+		if (!this._glyphMargin) {
+			this._renderResult = null;
+			return;
 		}
 
-		var left = this._glyphMarginLeft.toString(),
-			width = this._glyphMarginWidth.toString();
-
-		var common = '" style="left:' + left + 'px;width:' + width + 'px' + ';height:' + lineHeight + 'px;"></div>';
-
-		for (lineNumberStr in classNames) {
-			lineClassNames = classNames[lineNumberStr];
-			lineOutput = [];
-			lineOutput.push('<div class="cgmr');
-			for (className in lineClassNames) {
-				// Count one more glyph
-				count++;
-				lineOutput.push(' ');
-				lineOutput.push(className);
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
+		let toRender = this._render(visibleStartLineNumber, visibleEndLineNumber, this._getDecorations(ctx));
+
+		let lineHeight = this._lineHeight.toString();
+		let left = this._glyphMarginLeft.toString();
+		let width = this._glyphMarginWidth.toString();
+		let common = '" style="left:' + left + 'px;width:' + width + 'px' + ';height:' + lineHeight + 'px;"></div>';
+
+		let output: string[] = [];
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
+			let classNames = toRender[lineIndex];
+
+			if (classNames.length === 0) {
+				output[lineIndex] = '';
+			} else {
+				output[lineIndex] = (
+					'<div class="cgmr'
+					+ classNames
+					+ common
+				);
 			}
-			lineOutput.push(common);
-			output[lineNumberStr] = lineOutput;
 		}
 
 		this._renderResult = output;
-
-		return true;
 	}
 
-	public render2(lineNumber:number): string[] {
-		if (this._renderResult && this._renderResult.hasOwnProperty(lineNumber.toString())) {
-			return this._renderResult[lineNumber.toString()];
+	public render(startLineNumber:number, lineNumber:number): string {
+		if (!this._renderResult) {
+			return '';
+		}
+		let lineIndex = lineNumber - startLineNumber;
+		if (lineIndex < 0 || lineIndex >= this._renderResult.length) {
+			throw new Error('Unexpected render request');
 		}
-		return null;
+		return this._renderResult[lineIndex];
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/lineNumbers/lineNumbers.ts
code:
@@ -8,23 +8,23 @@
 import 'vs/css!./lineNumbers';
 import * as platform from 'vs/base/common/platform';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {ClassNames, IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
+import {ClassNames, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
-interface IRenderResult {
-	[lineNumber:string]:string[];
-}
-
-export class LineNumbersOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class LineNumbersOverlay extends DynamicViewOverlay {
 
 	private _context:IViewContext;
+	private _lineHeight:number;
+	private _lineNumbers:any;
 	private _lineNumbersLeft:number;
 	private _lineNumbersWidth:number;
-	private _renderResult:IRenderResult;
+	private _renderResult:string[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._lineNumbers = this._context.configuration.editor.lineNumbers;
 		this._lineNumbersLeft = 0;
 		this._lineNumbersWidth = 0;
 		this._renderResult = null;
@@ -64,6 +64,12 @@ export class LineNumbersOverlay extends ViewEventHandler implements IDynamicView
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.lineNumbers) {
+			this._lineNumbers = this._context.configuration.editor.lineNumbers;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -86,49 +92,49 @@ export class LineNumbersOverlay extends ViewEventHandler implements IDynamicView
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
-		this.shouldRender = false;
 
-		if (!this._context.configuration.editor.lineNumbers) {
+		if (!this._lineNumbers) {
 			this._renderResult = null;
-			return false;
+			return;
 		}
 
-		var output: IRenderResult = {};
-
-		var lineHeightClassName = (platform.isLinux ? (this._context.configuration.editor.lineHeight % 2 === 0 ? ' lh-even': ' lh-odd') : '');
-		var lineHeight = this._context.configuration.editor.lineHeight.toString(),
-			lineNumber:number,
-			renderLineNumber:string;
-
-		var common = '<div class="' + ClassNames.LINE_NUMBERS + lineHeightClassName + '" style="left:' + this._lineNumbersLeft.toString() + 'px;width:' + this._lineNumbersWidth.toString() + 'px;height:' + lineHeight + 'px;">';
+		let lineHeightClassName = (platform.isLinux ? (this._lineHeight % 2 === 0 ? ' lh-even': ' lh-odd') : '');
+		let lineHeight = this._lineHeight.toString();
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
+		let common = '<div class="' + ClassNames.LINE_NUMBERS + lineHeightClassName + '" style="left:' + this._lineNumbersLeft.toString() + 'px;width:' + this._lineNumbersWidth.toString() + 'px;height:' + lineHeight + 'px;">';
 
-		for (lineNumber = ctx.visibleRange.startLineNumber; lineNumber <= ctx.visibleRange.endLineNumber; lineNumber++) {
-			renderLineNumber = this._context.model.getLineRenderLineNumber(lineNumber);
+		let output: string[] = [];
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
 
+			let renderLineNumber = this._context.model.getLineRenderLineNumber(lineNumber);
 			if (renderLineNumber) {
-				var lineOutput:string[] = [
-					common,
-					this._context.model.getLineRenderLineNumber(lineNumber),
-					'</div>'
-				];
-
-				output[lineNumber.toString()] = lineOutput;
+				output[lineIndex] = (
+					common
+					+ renderLineNumber
+					+ '</div>'
+				);
+			} else {
+				output[lineIndex] = '';
 			}
 		}
 
 		this._renderResult = output;
-
-		return true;
 	}
 
-	public render2(lineNumber:number): string[] {
-		if (this._renderResult && this._renderResult.hasOwnProperty(lineNumber.toString())) {
-			return this._renderResult[lineNumber.toString()];
+	public render(startLineNumber:number, lineNumber:number): string {
+		if (!this._renderResult) {
+			return '';
+		}
+		let lineIndex = lineNumber - startLineNumber;
+		if (lineIndex < 0 || lineIndex >= this._renderResult.length) {
+			throw new Error('Unexpected render request');
 		}
-		return null;
+		return this._renderResult[lineIndex];
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/lines/viewLine.ts
code:
@@ -5,17 +5,23 @@
 'use strict';
 
 import * as browser from 'vs/base/browser/browser';
-import {StyleMutator} from 'vs/base/browser/styleMutator';
+import {FastDomNode, createFastDomNode} from 'vs/base/browser/styleMutator';
 import {HorizontalRange, IConfigurationChangedEvent, IModelDecoration} from 'vs/editor/common/editorCommon';
 import {ILineParts, createLineParts} from 'vs/editor/common/viewLayout/viewLineParts';
-import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import {renderLine, RenderLineInput} from 'vs/editor/common/viewLayout/viewLineRenderer';
 import {ClassNames, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {IVisibleLineData} from 'vs/editor/browser/view/viewLayer';
 
 export class ViewLine implements IVisibleLineData {
 
 	protected _context:IViewContext;
-	private _domNode: HTMLElement;
+	private _renderWhitespace: boolean;
+	private _spaceWidth: number;
+	private _lineHeight: number;
+	private _stopRenderingLineAfter: number;
+	protected _fontLigatures: boolean;
+
+	private _domNode: FastDomNode;
 
 	private _lineParts: ILineParts;
 
@@ -28,6 +34,12 @@ export class ViewLine implements IVisibleLineData {
 
 	constructor(context:IViewContext) {
 		this._context = context;
+		this._renderWhitespace = this._context.configuration.editor.renderWhitespace;
+		this._spaceWidth = this._context.configuration.editor.spaceWidth;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._stopRenderingLineAfter = this._context.configuration.editor.stopRenderingLineAfter;
+		this._fontLigatures = this._context.configuration.editor.fontLigatures;
+
 		this._domNode = null;
 		this._isInvalid = true;
 		this._isMaybeInvalid = false;
@@ -39,10 +51,13 @@ export class ViewLine implements IVisibleLineData {
 	// --- begin IVisibleLineData
 
 	public getDomNode(): HTMLElement {
-		return this._domNode;
+		if (!this._domNode) {
+			return null;
+		}
+		return this._domNode.domNode;
 	}
 	public setDomNode(domNode:HTMLElement): void {
-		this._domNode = domNode;
+		this._domNode = createFastDomNode(domNode);
 	}
 
 	public onContentChanged(): void {
@@ -64,10 +79,25 @@ export class ViewLine implements IVisibleLineData {
 		this._isMaybeInvalid = true;
 	}
 	public onConfigurationChanged(e:IConfigurationChangedEvent): void {
+		if (e.renderWhitespace) {
+			this._renderWhitespace = this._context.configuration.editor.renderWhitespace;
+		}
+		if (e.spaceWidth) {
+			this._spaceWidth = this._context.configuration.editor.spaceWidth;
+		}
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.stopRenderingLineAfter) {
+			this._stopRenderingLineAfter = this._context.configuration.editor.stopRenderingLineAfter;
+		}
+		if (e.fontLigatures) {
+			this._fontLigatures = this._context.configuration.editor.fontLigatures;
+		}
 		this._isInvalid = true;
 	}
 
-	public shouldUpdateHTML(lineNumber:number, inlineDecorations:IModelDecoration[]): boolean {
+	public shouldUpdateHTML(startLineNumber:number, lineNumber:number, inlineDecorations:IModelDecoration[]): boolean {
 		let newLineParts:ILineParts = null;
 
 		if (this._isMaybeInvalid || this._isInvalid) {
@@ -76,9 +106,10 @@ export class ViewLine implements IVisibleLineData {
 				lineNumber,
 				this._context.model.getLineMinColumn(lineNumber),
 				this._context.model.getLineContent(lineNumber),
+				this._context.model.getTabSize(),
 				this._context.model.getLineTokens(lineNumber),
 				inlineDecorations,
-				this._context.configuration.editor.renderWhitespace
+				this._renderWhitespace
 			);
 		}
 
@@ -105,7 +136,7 @@ export class ViewLine implements IVisibleLineData {
 		out.push('" style="top:');
 		out.push(deltaTop.toString());
 		out.push('px;height:');
-		out.push(this._context.configuration.editor.lineHeight.toString());
+		out.push(this._lineHeight.toString());
 		out.push('px;" class="');
 		out.push(ClassNames.VIEW_LINE);
 		out.push('">');
@@ -115,32 +146,29 @@ export class ViewLine implements IVisibleLineData {
 
 	public getLineInnerHTML(lineNumber: number): string {
 		this._isInvalid = false;
-		return this._render(lineNumber, this._lineParts).join('');
+		return this._render(lineNumber, this._lineParts);
 	}
 
 	public layoutLine(lineNumber:number, deltaTop:number): void {
-		let desiredLineNumber = String(lineNumber);
-		let currentLineNumber = this._domNode.getAttribute('lineNumber');
-		if (currentLineNumber !== desiredLineNumber) {
-			this._domNode.setAttribute('lineNumber', desiredLineNumber);
-		}
-		StyleMutator.setTop(this._domNode, deltaTop);
-		StyleMutator.setHeight(this._domNode, this._context.configuration.editor.lineHeight);
+		this._domNode.setLineNumber(String(lineNumber));
+		this._domNode.setTop(deltaTop);
+		this._domNode.setHeight(this._lineHeight);
 	}
 
 	// --- end IVisibleLineData
 
-	private _render(lineNumber:number, lineParts:ILineParts): string[] {
+	private _render(lineNumber:number, lineParts:ILineParts): string {
 
 		this._cachedWidth = -1;
 
-		let r = renderLine({
-			lineContent: this._context.model.getLineContent(lineNumber),
-			tabSize: this._context.model.getTabSize(),
-			stopRenderingLineAfter: this._context.configuration.editor.stopRenderingLineAfter,
-			renderWhitespace: this._context.configuration.editor.renderWhitespace,
-			parts: lineParts.getParts()
-		});
+		let r = renderLine(new RenderLineInput(
+			this._context.model.getLineContent(lineNumber),
+			this._context.model.getTabSize(),
+			this._spaceWidth,
+			this._stopRenderingLineAfter,
+			this._renderWhitespace,
+			lineParts.getParts()
+		));
 
 		this._charOffsetInPart = r.charOffsetInPart;
 		this._lastRenderedPartIndex = r.lastRenderedPartIndex;
@@ -151,7 +179,7 @@ export class ViewLine implements IVisibleLineData {
 	// --- Reading from the DOM methods
 
 	protected _getReadingTarget(): HTMLElement {
-		return <HTMLSpanElement>this._domNode.firstChild;
+		return <HTMLSpanElement>this._domNode.domNode.firstChild;
 	}
 
 	/**
@@ -168,7 +196,10 @@ export class ViewLine implements IVisibleLineData {
 	 * Visible ranges for a model range
 	 */
 	public getVisibleRangesForRange(startColumn:number, endColumn:number, clientRectDeltaLeft:number, endNode:HTMLElement): HorizontalRange[] {
-		let stopRenderingLineAfter = this._context.configuration.editor.stopRenderingLineAfter;
+		startColumn = +startColumn; // @perf
+		endColumn = +endColumn; // @perf
+		clientRectDeltaLeft = +clientRectDeltaLeft; // @perf
+		let stopRenderingLineAfter = +this._stopRenderingLineAfter; // @perf
 
 		if (stopRenderingLineAfter !== -1 && startColumn > stopRenderingLineAfter && endColumn > stopRenderingLineAfter) {
 			// This range is obviously not visible
@@ -323,7 +354,7 @@ export class ViewLine implements IVisibleLineData {
 		let lineParts = this._lineParts.getParts();
 
 		if (spanIndex >= lineParts.length) {
-			return this._context.configuration.editor.stopRenderingLineAfter;
+			return this._stopRenderingLineAfter;
 		}
 
 		if (offset === 0) {
@@ -346,8 +377,8 @@ export class ViewLine implements IVisibleLineData {
 		let min = originalMin;
 		let max = originalMax;
 
-		if (this._context.configuration.editor.stopRenderingLineAfter !== -1) {
-			max = Math.min(this._context.configuration.editor.stopRenderingLineAfter - 1, originalMax);
+		if (this._stopRenderingLineAfter !== -1) {
+			max = Math.min(this._stopRenderingLineAfter - 1, originalMax);
 		}
 
 		let nextStartOffset:number;
@@ -427,7 +458,7 @@ class WebKitViewLine extends ViewLine {
 	protected _readVisibleRangesForRange(startColumn:number, endColumn:number, clientRectDeltaLeft:number, endNode:HTMLElement): HorizontalRange[] {
 		let output = super._readVisibleRangesForRange(startColumn, endColumn, clientRectDeltaLeft, endNode);
 
-		if (this._context.configuration.editor.fontLigatures && output.length === 1 && endColumn > 1 && endColumn === this._charOffsetInPart.length) {
+		if (this._fontLigatures && output.length === 1 && endColumn > 1 && endColumn === this._charOffsetInPart.length) {
 			let lastSpanBoundingClientRect = (<HTMLElement>this._getReadingTarget().lastChild).getBoundingClientRect();
 			let lastSpanBoundingClientRectRight = lastSpanBoundingClientRect.right - clientRectDeltaLeft;
 			if (startColumn === endColumn) {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/lines/viewLines.ts
code:
@@ -13,52 +13,97 @@ import {ClassNames, ILayoutProvider, IViewContext} from 'vs/editor/browser/edito
 import {IVisibleLineData, ViewLayer} from 'vs/editor/browser/view/viewLayer';
 import {ViewLine, createLine} from 'vs/editor/browser/viewParts/lines/viewLine';
 
-export class ViewLines extends ViewLayer {
+class LastRenderedData {
+
+	private _currentVisibleRange: Range;
+	private _bigNumbersDelta: number;
+
+	private _domNodeClientRectLeft: number;
+	private _domNodeClientRectLeftIsValid: boolean;
+
+	constructor() {
+		this._currentVisibleRange = new Range(1, 1, 1, 1);
+		this._bigNumbersDelta = 0;
+		this._domNodeClientRectLeft = 0;
+		this._domNodeClientRectLeftIsValid = false;
+	}
+
+	public getCurrentVisibleRange(): Range {
+		return this._currentVisibleRange;
+	}
+
+	public setCurrentVisibleRange(currentVisibleRange:Range): void {
+		this._currentVisibleRange = currentVisibleRange;
+	}
+
+	public getBigNumbersDelta(): number {
+		return this._bigNumbersDelta;
+	}
+
+	public setBigNumbersDelta(bigNumbersDelta:number): void {
+		this._bigNumbersDelta = bigNumbersDelta;
+	}
+
+	public getDomNodeClientRectLeft(domNode:HTMLElement): number {
+		if (!this._domNodeClientRectLeftIsValid) {
+			let boundingClientRect = domNode.getBoundingClientRect();
+			this._domNodeClientRectLeft = boundingClientRect.left;
+			this._domNodeClientRectLeftIsValid = true;
+		}
+		return this._domNodeClientRectLeft;
+	}
+
+	public resetDomNodeClientRectLeft(): void {
+		this._domNodeClientRectLeftIsValid = false;
+	}
+}
 
+export class ViewLines extends ViewLayer {
 	/**
 	 * Width to extends a line to render the line feed at the end of the line
 	 */
 	private static LINE_FEED_WIDTH = 10;
-
 	/**
 	 * Adds this ammount of pixels to the right of lines (no-one wants to type near the edge of the viewport)
 	 */
 	private static HORIZONTAL_EXTRA_PX = 30;
 
+
 	private _layoutProvider:ILayoutProvider;
 	_lines:ViewLine[];
+	private _textRangeRestingSpot:HTMLElement;
 
-	public textRangeRestingSpot:HTMLElement;
+	// --- config
+	private _lineHeight: number;
+	private _isViewportWrapping: boolean;
+	private _revealHorizontalRightPadding: number;
 
 	// --- width
 	private _maxLineWidth: number;
 	private _asyncUpdateLineWidths: RunOnceScheduler;
 
-	private _currentVisibleRange: editorCommon.IEditorRange;
-
 	private _lastCursorRevealRangeHorizontallyEvent:editorCommon.IViewRevealRangeEvent;
-	private _bigNumbersDelta: number;
+	private _lastRenderedData: LastRenderedData;
 
 	constructor(context:IViewContext, layoutProvider:ILayoutProvider) {
 		super(context);
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._isViewportWrapping = this._context.configuration.editor.wrappingInfo.isViewportWrapping;
+		this._revealHorizontalRightPadding = this._context.configuration.editor.revealHorizontalRightPadding;
 		this._layoutProvider = layoutProvider;
-		this.domNode.className = ClassNames.VIEW_LINES;
+		this.domNode.setClassName(ClassNames.VIEW_LINES);
 
 		// --- width & height
 		this._maxLineWidth = 0;
 		this._asyncUpdateLineWidths = new RunOnceScheduler(() => {
 			this._updateLineWidths();
 		}, 200);
 
-		this._currentVisibleRange = new Range(1, 1, 1, 1);
-		this._bigNumbersDelta = 0;
+		this._lastRenderedData = new LastRenderedData();
 
 		this._lastCursorRevealRangeHorizontallyEvent = null;
-		this.textRangeRestingSpot = document.createElement('div');
-		this.textRangeRestingSpot.className = 'textRangeRestingSpot';
-
-		this._hasVerticalScroll = true;
-		this._hasHorizontalScroll = true;
+		this._textRangeRestingSpot = document.createElement('div');
+		this._textRangeRestingSpot.className = 'textRangeRestingSpot';
 	}
 
 	public dispose(): void {
@@ -67,19 +112,35 @@ export class ViewLines extends ViewLayer {
 		super.dispose();
 	}
 
+	public getDomNode(): HTMLElement {
+		return this.domNode.domNode;
+	}
+
 	// ---- begin view event handlers
 
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 		var shouldRender = super.onConfigurationChanged(e);
 		if (e.wrappingInfo) {
 			this._maxLineWidth = 0;
 		}
+
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.wrappingInfo) {
+			this._isViewportWrapping = this._context.configuration.editor.wrappingInfo.isViewportWrapping;
+		}
+		if (e.revealHorizontalRightPadding) {
+			this._revealHorizontalRightPadding = this._context.configuration.editor.revealHorizontalRightPadding;
+		}
+
 		return shouldRender;
 	}
 
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
 		var shouldRender = super.onLayoutChanged(layoutInfo);
 		this._maxLineWidth = 0;
+		this._lastRenderedData.resetDomNodeClientRectLeft();
 		return shouldRender;
 	}
 
@@ -90,7 +151,7 @@ export class ViewLines extends ViewLayer {
 	}
 
 	public onScrollWidthChanged(scrollWidth:number): boolean {
-		StyleMutator.setWidth(this.domNode, scrollWidth);
+		this.domNode.setWidth(scrollWidth);
 		return false;
 	}
 
@@ -116,17 +177,13 @@ export class ViewLines extends ViewLayer {
 
 	public onCursorScrollRequest(e:editorCommon.IViewScrollRequestEvent): boolean {
 		let currentScrollTop = this._layoutProvider.getScrollTop();
-		let newScrollTop = currentScrollTop + e.deltaLines * this._context.configuration.editor.lineHeight;
+		let newScrollTop = currentScrollTop + e.deltaLines * this._lineHeight;
 		this._layoutProvider.setScrollTop(newScrollTop);
 		return true;
 	}
 
-	private _hasVerticalScroll = false;
-	private _hasHorizontalScroll = false;
 	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
-		this._hasVerticalScroll = this._hasVerticalScroll || e.vertical;
-		this._hasHorizontalScroll = this._hasHorizontalScroll || e.horizontal;
-		return super.onScrollChanged(e);
+		return super.onScrollChanged(e) || true;
 	}
 
 	// ---- end view event handlers
@@ -191,52 +248,43 @@ export class ViewLines extends ViewLayer {
 	}
 
 	public linesVisibleRangesForRange(range:editorCommon.IRange, includeNewLines:boolean): editorCommon.LineVisibleRanges[] {
-		if (this.shouldRender) {
+		if (this.shouldRender()) {
 			// Cannot read from the DOM because it is dirty
 			// i.e. the model & the dom are out of sync, so I'd be reading something stale
 			return null;
 		}
 
-		var originalEndLineNumber = range.endLineNumber;
-		range = Range.intersectRanges(range, this._currentVisibleRange);
+		let originalEndLineNumber = range.endLineNumber;
+		range = Range.intersectRanges(range, this._lastRenderedData.getCurrentVisibleRange());
 		if (!range) {
 			return null;
 		}
 
-		var visibleRangesForLine:editorCommon.HorizontalRange[],
-			visibleRanges:editorCommon.LineVisibleRanges[] = [],
-			lineNumber:number,
-			lineIndex:number,
-			startColumn:number,
-			endColumn:number;
-
-		var boundingClientRect = this.domNode.getBoundingClientRect();
-		var clientRectDeltaLeft = boundingClientRect.left;
-
-		var currentLineModelLineNumber:number,
-			nextLineModelLineNumber:number;
+		let visibleRanges:editorCommon.LineVisibleRanges[] = [];
+		let clientRectDeltaLeft = this._lastRenderedData.getDomNodeClientRectLeft(this.domNode.domNode);
 
+		let nextLineModelLineNumber:number;
 		if (includeNewLines) {
 			nextLineModelLineNumber = this._context.model.convertViewPositionToModelPosition(range.startLineNumber, 1).lineNumber;
 		}
 
-		for (lineNumber = range.startLineNumber; lineNumber <= range.endLineNumber; lineNumber++) {
-			lineIndex = lineNumber - this._rendLineNumberStart;
+		for (let lineNumber = range.startLineNumber; lineNumber <= range.endLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - this._rendLineNumberStart;
 
 			if (lineIndex < 0 || lineIndex >= this._lines.length) {
 				continue;
 			}
 
-			startColumn = lineNumber === range.startLineNumber ? range.startColumn : 1;
-			endColumn = lineNumber === range.endLineNumber ? range.endColumn : this._context.model.getLineMaxColumn(lineNumber);
-			visibleRangesForLine = this._lines[lineIndex].getVisibleRangesForRange(startColumn, endColumn, clientRectDeltaLeft, this.textRangeRestingSpot);
+			let startColumn = lineNumber === range.startLineNumber ? range.startColumn : 1;
+			let endColumn = lineNumber === range.endLineNumber ? range.endColumn : this._context.model.getLineMaxColumn(lineNumber);
+			let visibleRangesForLine = this._lines[lineIndex].getVisibleRangesForRange(startColumn, endColumn, clientRectDeltaLeft, this._textRangeRestingSpot);
 
 			if (!visibleRangesForLine || visibleRangesForLine.length === 0) {
 				continue;
 			}
 
 			if (includeNewLines && lineNumber < originalEndLineNumber) {
-				currentLineModelLineNumber = nextLineModelLineNumber;
+				let currentLineModelLineNumber = nextLineModelLineNumber;
 				nextLineModelLineNumber = this._context.model.convertViewPositionToModelPosition(lineNumber + 1, 1).lineNumber;
 
 				if (currentLineModelLineNumber !== nextLineModelLineNumber) {
@@ -256,20 +304,20 @@ export class ViewLines extends ViewLayer {
 
 	public visibleRangesForRange2(range:editorCommon.IRange, deltaTop:number): editorCommon.VisibleRange[] {
 
-		if (this.shouldRender) {
+		if (this.shouldRender()) {
 			// Cannot read from the DOM because it is dirty
 			// i.e. the model & the dom are out of sync, so I'd be reading something stale
 			return null;
 		}
 
-		range = Range.intersectRanges(range, this._currentVisibleRange);
+		range = Range.intersectRanges(range, this._lastRenderedData.getCurrentVisibleRange());
 		if (!range) {
 			return null;
 		}
 
 		let result:editorCommon.VisibleRange[] = [];
-		let boundingClientRect = this.domNode.getBoundingClientRect();
-		let clientRectDeltaLeft = boundingClientRect.left;
+		let clientRectDeltaLeft = this._lastRenderedData.getDomNodeClientRectLeft(this.domNode.domNode);
+		let bigNumbersDelta = this._lastRenderedData.getBigNumbersDelta();
 
 		for (let lineNumber = range.startLineNumber; lineNumber <= range.endLineNumber; lineNumber++) {
 			let lineIndex = lineNumber - this._rendLineNumberStart;
@@ -280,13 +328,13 @@ export class ViewLines extends ViewLayer {
 
 			let startColumn = lineNumber === range.startLineNumber ? range.startColumn : 1;
 			let endColumn = lineNumber === range.endLineNumber ? range.endColumn : this._context.model.getLineMaxColumn(lineNumber);
-			let visibleRangesForLine = this._lines[lineIndex].getVisibleRangesForRange(startColumn, endColumn, clientRectDeltaLeft, this.textRangeRestingSpot);
+			let visibleRangesForLine = this._lines[lineIndex].getVisibleRangesForRange(startColumn, endColumn, clientRectDeltaLeft, this._textRangeRestingSpot);
 
 			if (!visibleRangesForLine || visibleRangesForLine.length === 0) {
 				continue;
 			}
 
-			let adjustedLineNumberVerticalOffset = this._layoutProvider.getVerticalOffsetForLineNumber(lineNumber) - this._bigNumbersDelta + deltaTop;
+			let adjustedLineNumberVerticalOffset = this._layoutProvider.getVerticalOffsetForLineNumber(lineNumber) - bigNumbersDelta + deltaTop;
 			for (let i = 0, len = visibleRangesForLine.length; i < len; i++) {
 				result.push(new editorCommon.VisibleRange(adjustedLineNumberVerticalOffset, visibleRangesForLine[i].left, visibleRangesForLine[i].width));
 			}
@@ -305,31 +353,6 @@ export class ViewLines extends ViewLayer {
 		return createLine(this._context);
 	}
 
-	private _renderAndUpdateLineHeights(linesViewportData: editorCommon.IViewLinesViewportData): void {
-		super._renderLines(linesViewportData);
-
-		// Update internal current visible range
-		this._currentVisibleRange = new Range(
-			0 + this._rendLineNumberStart,
-			1,
-			this._lines.length - 1 + this._rendLineNumberStart,
-			this._context.model.getLineMaxColumn(this._lines.length - 1 + this._rendLineNumberStart)
-		);
-
-
-		if (this._lastCursorRevealRangeHorizontallyEvent) {
-			var newScrollLeft = this._computeScrollLeftToRevealRange(this._lastCursorRevealRangeHorizontallyEvent.range);
-			this._lastCursorRevealRangeHorizontallyEvent = null;
-
-			var isViewportWrapping = this._context.configuration.editor.wrappingInfo.isViewportWrapping;
-			if (!isViewportWrapping) {
-				this._ensureMaxLineWidth(newScrollLeft.maxHorizontalOffset);
-			}
-
-			this._layoutProvider.setScrollLeft(newScrollLeft.scrollLeft);
-		}
-	}
-
 	private _updateLineWidths(): void {
 		var i:number,
 			localMaxLineWidth = 1,
@@ -344,54 +367,82 @@ export class ViewLines extends ViewLayer {
 		this._ensureMaxLineWidth(localMaxLineWidth);
 	}
 
-	public render(): editorCommon.IViewLinesViewportData {
+	public prepareRender(): void {
+		throw new Error('Not supported');
+	}
+
+	public render(): void {
+		throw new Error('Not supported');
+	}
 
-		var linesViewportData = this._layoutProvider.getLinesViewportData();
-		this._bigNumbersDelta = linesViewportData.bigNumbersDelta;
+	public renderText(linesViewportData:editorCommon.ViewLinesViewportData, onAfterLinesRendered:()=>void): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
 
-		if (this.shouldRender) {
-			this.shouldRender = false;
+		// (1) render lines - ensures lines are in the DOM
+		super._renderLines(linesViewportData);
+		this._lastRenderedData.setBigNumbersDelta(linesViewportData.bigNumbersDelta);
+		this._lastRenderedData.setCurrentVisibleRange(linesViewportData.visibleRange);
+		this.domNode.setWidth(this._layoutProvider.getScrollWidth());
+		this.domNode.setHeight(Math.min(this._layoutProvider.getTotalHeight(), 1000000));
 
-			this._renderAndUpdateLineHeights(linesViewportData);
+		// (2) execute DOM writing that forces sync layout (e.g. textArea manipulation)
+		onAfterLinesRendered();
 
-			// Update max line width (not so important, it is just so the horizontal scrollbar doesn't get too small)
-			this._asyncUpdateLineWidths.schedule();
-		}
+		// (3) compute horizontal scroll position:
+		//  - this must happen after the lines are in the DOM since it might need a line that rendered just now
+		//  - it might change `scrollWidth` and `scrollLeft`
+		if (this._lastCursorRevealRangeHorizontallyEvent) {
+			let revealHorizontalRange = this._lastCursorRevealRangeHorizontallyEvent.range;
+			this._lastCursorRevealRangeHorizontallyEvent = null;
 
-		if (this._hasVerticalScroll || this._hasHorizontalScroll) {
-			if (browser.canUseTranslate3d) {
-				var transform = 'translate3d(' + -this._layoutProvider.getScrollLeft() + 'px, ' + linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
-				StyleMutator.setTransform(<HTMLElement>this.domNode.parentNode, transform);
-			} else {
-				if (this._hasVerticalScroll) {
-					StyleMutator.setTop(<HTMLElement>this.domNode.parentNode, linesViewportData.visibleRangesDeltaTop);
-				}
-				if (this._hasHorizontalScroll) {
-					StyleMutator.setLeft(<HTMLElement>this.domNode.parentNode, -this._layoutProvider.getScrollLeft());
-				}
+			// allow `visibleRangesForRange2` to work
+			this.onDidRender();
+
+			// compute new scroll position
+			var newScrollLeft = this._computeScrollLeftToRevealRange(revealHorizontalRange);
+
+			var isViewportWrapping = this._isViewportWrapping;
+			if (!isViewportWrapping) {
+				// ensure `scrollWidth` is large enough
+				this._ensureMaxLineWidth(newScrollLeft.maxHorizontalOffset);
 			}
-			this._hasVerticalScroll = false;
-			this._hasHorizontalScroll = false;
+
+			// set `scrollLeft`
+			this._layoutProvider.setScrollLeft(newScrollLeft.scrollLeft);
 		}
 
-		StyleMutator.setWidth(this.domNode, this._layoutProvider.getScrollWidth());
-		StyleMutator.setHeight(this.domNode, Math.min(this._layoutProvider.getTotalHeight(), 1000000));
+		// (4) handle scrolling
+		let somethingChanged = false;
+		if (browser.canUseTranslate3d) {
+			var transform = 'translate3d(' + -this._layoutProvider.getScrollLeft() + 'px, ' + linesViewportData.visibleRangesDeltaTop + 'px, 0px)';
+			somethingChanged = StyleMutator.setTransform(<HTMLElement>this.domNode.domNode.parentNode, transform) || somethingChanged; // TODO@Alex
+		} else {
+			somethingChanged = StyleMutator.setTop(<HTMLElement>this.domNode.domNode.parentNode, linesViewportData.visibleRangesDeltaTop) || somethingChanged; // TODO@Alex
+			somethingChanged = StyleMutator.setLeft(<HTMLElement>this.domNode.domNode.parentNode, -this._layoutProvider.getScrollLeft()) || somethingChanged; // TODO@Alex
+		}
 
-		linesViewportData.visibleRange = this._currentVisibleRange;
+		// (5) reset cached client rect left if scrolling changed something
+		if (somethingChanged) {
+			this._lastRenderedData.resetDomNodeClientRectLeft();
+		}
 
-		return linesViewportData;
+		// Update max line width (not so important, it is just so the horizontal scrollbar doesn't get too small)
+		this._asyncUpdateLineWidths.schedule();
 	}
 
 	// --- width
 
 	private _ensureMaxLineWidth(lineWidth: number): void {
-		if (this._maxLineWidth < lineWidth) {
-			this._maxLineWidth = lineWidth;
+		let iLineWidth = Math.ceil(lineWidth);
+		if (this._maxLineWidth < iLineWidth) {
+			this._maxLineWidth = iLineWidth;
 			this._layoutProvider.onMaxLineWidthChanged(this._maxLineWidth);
 		}
 	}
 
-	private _computeScrollTopToRevealRange(viewport:editorCommon.IViewport, range: editorCommon.IEditorRange, verticalType: editorCommon.VerticalRevealType): number {
+	private _computeScrollTopToRevealRange(viewport:editorCommon.Viewport, range: editorCommon.IEditorRange, verticalType: editorCommon.VerticalRevealType): number {
 		var viewportStartY = viewport.top,
 			viewportHeight = viewport.height,
 			viewportEndY = viewportStartY + viewportHeight,
@@ -403,7 +454,7 @@ export class ViewLines extends ViewLayer {
 		boxEndY = this._layoutProvider.getVerticalOffsetForLineNumber(range.endLineNumber) + this._layoutProvider.heightInPxForLine(range.endLineNumber);
 		if (verticalType === editorCommon.VerticalRevealType.Simple) {
 			// Reveal one line more for the arrow down case, when the last line would be covered by the scrollbar
-			boxEndY += this._context.configuration.editor.lineHeight;
+			boxEndY += this._lineHeight;
 		}
 
 		var newScrollTop: number;
@@ -468,7 +519,7 @@ export class ViewLines extends ViewLayer {
 		maxHorizontalOffset = boxEndX;
 
 		boxStartX = Math.max(0, boxStartX - ViewLines.HORIZONTAL_EXTRA_PX);
-		boxEndX += this._context.configuration.editor.revealHorizontalRightPadding;
+		boxEndX += this._revealHorizontalRightPadding;
 
 		var newScrollLeft = this._computeMinimumScrolling(viewportStartX, viewportEndX, boxStartX, boxEndX);
 		return {
@@ -478,8 +529,13 @@ export class ViewLines extends ViewLayer {
 	}
 
 	private _computeMinimumScrolling(viewportStart: number, viewportEnd: number, boxStart: number, boxEnd: number): number {
-		var viewportLength = viewportEnd - viewportStart,
-			boxLength = boxEnd - boxStart;
+		viewportStart = viewportStart|0;
+		viewportEnd = viewportEnd|0;
+		boxStart = boxStart|0;
+		boxEnd = boxEnd|0;
+
+		let viewportLength = viewportEnd - viewportStart;
+		let boxLength = boxEnd - boxStart;
 
 		if (boxLength < viewportLength) {
 			// The box would fit in the viewport

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/linesDecorations/linesDecorations.ts
code:
@@ -7,24 +7,22 @@
 
 import 'vs/css!./linesDecorations';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DecorationToRender, DedupOverlay} from 'vs/editor/browser/viewParts/glyphMargin/glyphMargin';
 
-interface IRenderResult {
-	[lineNumber:string]:string[];
-}
-
-export class LinesDecorationsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class LinesDecorationsOverlay extends DedupOverlay {
 
 	private _context:IViewContext;
+	private _lineHeight: number;
 
 	private _decorationsLeft:number;
 	private _decorationsWidth:number;
-	private _renderResult:IRenderResult;
+	private _renderResult:string[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
 		this._decorationsLeft = 0;
 		this._decorationsWidth = 0;
 		this._renderResult = null;
@@ -64,6 +62,9 @@ export class LinesDecorationsOverlay extends ViewEventHandler implements IDynami
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -86,78 +87,59 @@ export class LinesDecorationsOverlay extends ViewEventHandler implements IDynami
 
 	// --- end event handlers
 
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
-		}
-		this.shouldRender = false;
-
-		var output: IRenderResult = {};
-		var renderedCount = 0;
-
-		var decorations = ctx.getDecorationsInViewport(),
-			lineHeight = this._context.configuration.editor.lineHeight.toString(),
-			d:editorCommon.IModelDecoration,
-			rng:editorCommon.IRange,
-			i:number, lenI:number,
-			classNames:{[top:string]:{[className:string]:boolean;};} = {},
-			lineClassNames:{[className:string]:boolean;},
-			className:string,
-			lineOutput:string[],
-			lineNumber: number,
-			lineNumberStr: string;
-
-		for (i = 0, lenI = decorations.length; i < lenI; i++) {
-			d = decorations[i];
-			if (!d.options.linesDecorationsClassName) {
-				continue;
+	protected _getDecorations(ctx:IRenderingContext): DecorationToRender[] {
+		let decorations = ctx.getDecorationsInViewport();
+		let r:DecorationToRender[] = [];
+		for (let i = 0, len = decorations.length; i < len; i++) {
+			let d = decorations[i];
+			if (d.options.linesDecorationsClassName) {
+				r.push(new DecorationToRender(d.range.startLineNumber, d.range.endLineNumber, d.options.linesDecorationsClassName));
 			}
+		}
+		return r;
+	}
 
-			rng = d.range;
-
-			for (lineNumber = rng.startLineNumber; lineNumber <= rng.endLineNumber; lineNumber++) {
-				if (!ctx.lineIsVisible(lineNumber)) {
-					continue;
-				}
-
-				lineNumberStr = lineNumber.toString();
-
-//					oldTop = ctx.getViewportVerticalOffsetForLineNumber(j);
-
-				if (!classNames.hasOwnProperty(lineNumberStr)) {
-					classNames[lineNumberStr] = {};
-				}
-				classNames[lineNumberStr][d.options.linesDecorationsClassName] = true;
-			}
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
 
-		var left = this._decorationsLeft.toString(),
-			width = this._decorationsWidth.toString();
-
-		var common = '" style="left:' + left + 'px;width:' + width + 'px' + ';height:' + lineHeight + 'px;"></div>';
-		for (lineNumberStr in classNames) {
-			lineClassNames = classNames[lineNumberStr];
-			lineOutput = [];
-			lineOutput.push('<div class="cldr');
-			for (className in lineClassNames) {
-				// Count one more glyph
-				renderedCount++;
-				lineOutput.push(' ');
-				lineOutput.push(className);
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
+		let toRender = this._render(visibleStartLineNumber, visibleEndLineNumber, this._getDecorations(ctx));
+
+		let lineHeight = this._lineHeight.toString();
+		let left = this._decorationsLeft.toString();
+		let width = this._decorationsWidth.toString();
+		let common = '" style="left:' + left + 'px;width:' + width + 'px' + ';height:' + lineHeight + 'px;"></div>';
+
+		let output: string[] = [];
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
+			let classNames = toRender[lineIndex];
+
+			if (classNames.length === 0) {
+				output[lineIndex] = '';
+			} else {
+				output[lineIndex] = (
+					'<div class="cldr'
+					+ classNames
+					+ common
+				);
 			}
-			lineOutput.push(common);
-			output[lineNumberStr] = lineOutput;
 		}
 
 		this._renderResult = output;
-
-		return true;
 	}
 
-	public render2(lineNumber:number): string[] {
-		if (this._renderResult && this._renderResult.hasOwnProperty(lineNumber.toString())) {
-			return this._renderResult[lineNumber.toString()];
+	public render(startLineNumber:number, lineNumber:number): string {
+		if (!this._renderResult) {
+			return '';
+		}
+		let lineIndex = lineNumber - startLineNumber;
+		if (lineIndex < 0 || lineIndex >= this._renderResult.length) {
+			throw new Error('Unexpected render request');
 		}
-		return null;
+		return this._renderResult[lineIndex];
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/overlayWidgets/overlayWidgets.ts
code:
@@ -8,7 +8,7 @@
 import 'vs/css!./overlayWidgets';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import {IEditorLayoutInfo} from 'vs/editor/common/editorCommon';
-import {ClassNames, IOverlayWidget, IRenderingContext, IViewContext, OverlayWidgetPositionPreference} from 'vs/editor/browser/editorBrowser';
+import {ClassNames, IOverlayWidget, IRenderingContext, IRestrictedRenderingContext, IViewContext, OverlayWidgetPositionPreference} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 interface IWidgetData {
@@ -28,6 +28,7 @@ export class ViewOverlayWidgets extends ViewPart {
 	private _verticalScrollbarWidth: number;
 	private _horizontalScrollbarHeight:number;
 	private _editorHeight:number;
+	private _editorWidth:number;
 
 	constructor(context:IViewContext) {
 		super(context);
@@ -36,6 +37,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		this._verticalScrollbarWidth = 0;
 		this._horizontalScrollbarHeight = 0;
 		this._editorHeight = 0;
+		this._editorWidth = 0;
 
 		this.domNode = document.createElement('div');
 		this.domNode.className = ClassNames.OVERLAY_WIDGETS;
@@ -52,10 +54,7 @@ export class ViewOverlayWidgets extends ViewPart {
 		this._verticalScrollbarWidth = layoutInfo.verticalScrollbarWidth;
 		this._horizontalScrollbarHeight = layoutInfo.horizontalScrollbarHeight;
 		this._editorHeight = layoutInfo.height;
-
-		this._requestModificationFrame(() => {
-			StyleMutator.setWidth(this.domNode, layoutInfo.width);
-		});
+		this._editorWidth = layoutInfo.width;
 		return true;
 	}
 
@@ -72,6 +71,8 @@ export class ViewOverlayWidgets extends ViewPart {
 		domNode.style.position = 'absolute';
 		domNode.setAttribute('widgetId', widget.getId());
 		this.domNode.appendChild(domNode);
+
+		this.setShouldRender();
 	}
 
 	public setWidgetPosition(widget: IOverlayWidget, preference:OverlayWidgetPositionPreference): boolean {
@@ -81,11 +82,8 @@ export class ViewOverlayWidgets extends ViewPart {
 		}
 
 		widgetData.preference = preference;
-		this._requestModificationFrame(() => {
-			if(this._widgets.hasOwnProperty(widget.getId())) {
-				this._renderWidget(widgetData);
-			}
-		});
+		this.setShouldRender();
+
 		return true;
 	}
 
@@ -97,6 +95,7 @@ export class ViewOverlayWidgets extends ViewPart {
 			delete this._widgets[widgetId];
 
 			domNode.parentNode.removeChild(domNode);
+			this.setShouldRender();
 		}
 	}
 
@@ -135,26 +134,20 @@ export class ViewOverlayWidgets extends ViewPart {
 		}
 	}
 
-	_render(ctx:IRenderingContext): void {
-		var widgetId:string;
-
-		this._requestModificationFrame(() => {
-			for (widgetId in this._widgets) {
-				if (this._widgets.hasOwnProperty(widgetId)) {
-					this._renderWidget(this._widgets[widgetId]);
-				}
-			}
-		});
+	public prepareRender(ctx:IRenderingContext): void {
+		// Nothing to read
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
 	}
 
-	public onReadAfterForcedLayout(ctx:IRenderingContext): void {
-		// Overwriting to bypass `shouldRender` flag
-		this._render(ctx);
-		return null;
-	}
+	public render(ctx:IRestrictedRenderingContext): void {
+		StyleMutator.setWidth(this.domNode, this._editorWidth);
 
-	public onWriteAfterForcedLayout(): void {
-		// Overwriting to bypass `shouldRender` flag
-		this._executeModificationRunners();
+		let keys = Object.keys(this._widgets);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let widgetId = keys[i];
+			this._renderWidget(this._widgets[widgetId]);
+		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/overviewRuler/decorationsOverviewRuler.ts
code:
@@ -6,7 +6,7 @@
 
 import * as themes from 'vs/platform/theme/common/themes';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {IOverviewRulerZone, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {OverviewRulerZone, IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
 
@@ -21,18 +21,24 @@ export class DecorationsOverviewRuler extends ViewPart {
 
 	private _shouldUpdateDecorations:boolean;
 	private _shouldUpdateCursorPosition:boolean;
-	private _shouldForceRender:boolean;
-	private _hideCursor:boolean;
-
-	private _zonesFromDecorations: IOverviewRulerZone[];
-	private _zonesFromCursors: IOverviewRulerZone[];
 
+	private _hideCursor:boolean;
 	private _cursorPositions: editorCommon.IEditorPosition[];
 
+	private _zonesFromDecorations: OverviewRulerZone[];
+	private _zonesFromCursors: OverviewRulerZone[];
+
 	constructor(context:IViewContext, scrollHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
 		super(context);
-		this._overviewRuler = new OverviewRulerImpl(1, 'decorationsOverviewRuler', scrollHeight, this._context.configuration.editor.lineHeight,
-					DecorationsOverviewRuler.DECORATION_HEIGHT, DecorationsOverviewRuler.DECORATION_HEIGHT, getVerticalOffsetForLine);
+		this._overviewRuler = new OverviewRulerImpl(
+			1,
+			'decorationsOverviewRuler',
+			scrollHeight,
+			this._context.configuration.editor.lineHeight,
+			DecorationsOverviewRuler.DECORATION_HEIGHT,
+			DecorationsOverviewRuler.DECORATION_HEIGHT,
+			getVerticalOffsetForLine
+		);
 		this._overviewRuler.setLanesCount(this._context.configuration.editor.overviewRulerLanes, false);
 		let theme = this._context.configuration.editor.theme;
 		this._overviewRuler.setUseDarkColor(!themes.isLightTheme(theme), false);
@@ -43,8 +49,6 @@ export class DecorationsOverviewRuler extends ViewPart {
 		this._shouldUpdateCursorPosition = true;
 		this._hideCursor = this._context.configuration.editor.hideCursorInOverviewRuler;
 
-		this._shouldForceRender = false;
-
 		this._zonesFromCursors = [];
 		this._cursorPositions = [];
 	}
@@ -71,13 +75,11 @@ export class DecorationsOverviewRuler extends ViewPart {
 
 		if (e.lineHeight) {
 			this._overviewRuler.setLineHeight(this._context.configuration.editor.lineHeight, false);
-			this._shouldForceRender = true;
 			shouldRender = true;
 		}
 
 		if (prevLanesCount !== newLanesCount) {
 			this._overviewRuler.setLanesCount(newLanesCount, false);
-			this._shouldForceRender = true;
 			shouldRender = true;
 		}
 
@@ -90,18 +92,14 @@ export class DecorationsOverviewRuler extends ViewPart {
 		if (e.theme) {
 			let theme = this._context.configuration.editor.theme;
 			this._overviewRuler.setUseDarkColor(!themes.isLightTheme(theme), false);
-			this._shouldForceRender = true;
 			shouldRender = true;
 		}
 
 		return shouldRender;
 	}
 
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
-		this._shouldForceRender = true;
-		this._requestModificationFrame(() => {
-			this._overviewRuler.setLayout(layoutInfo.overviewRuler, false);
-		});
+		this._overviewRuler.setLayout(layoutInfo.overviewRuler, false);
 		return true;
 	}
 
@@ -122,7 +120,6 @@ export class DecorationsOverviewRuler extends ViewPart {
 
 	public onScrollHeightChanged(scrollHeight:number): boolean {
 		this._overviewRuler.setScrollHeight(scrollHeight, false);
-		this._shouldForceRender = true;
 		return true;
 	}
 
@@ -132,58 +129,54 @@ export class DecorationsOverviewRuler extends ViewPart {
 		return this._overviewRuler.getDomNode();
 	}
 
-	private _createZonesFromDecorations(): IOverviewRulerZone[] {
-		var decorations = this._context.model.getAllDecorations(),
-			zones:IOverviewRulerZone[] = [],
-			i:number,
-			len:number,
-			dec:editorCommon.IModelDecoration;
+	private _createZonesFromDecorations(): OverviewRulerZone[] {
+		let decorations = this._context.model.getAllDecorations();
+		let zones:OverviewRulerZone[] = [];
 
-		for (i = 0, len = decorations.length; i < len; i++) {
-			dec = decorations[i];
+		for (let i = 0, len = decorations.length; i < len; i++) {
+			let dec = decorations[i];
 			if (dec.options.overviewRuler.color) {
-				zones.push({
-					startLineNumber: dec.range.startLineNumber,
-					endLineNumber: dec.range.endLineNumber,
-					color: dec.options.overviewRuler.color,
-					darkColor: dec.options.overviewRuler.darkColor,
-					position: dec.options.overviewRuler.position
-				});
+				zones.push(new OverviewRulerZone(
+					dec.range.startLineNumber,
+					dec.range.endLineNumber,
+					dec.options.overviewRuler.position,
+					0,
+					dec.options.overviewRuler.color,
+					dec.options.overviewRuler.darkColor
+				));
 			}
 		}
 
 		return zones;
 	}
 
-	private _createZonesFromCursors(): IOverviewRulerZone[] {
-		var zones:IOverviewRulerZone[] = [],
-			i:number,
-			len:number,
-			cursor:editorCommon.IEditorPosition;
-
-		for (i = 0, len = this._cursorPositions.length; i < len; i++) {
-			cursor = this._cursorPositions[i];
-
-			zones.push({
-				forceHeight: 2,
-				startLineNumber: cursor.lineNumber,
-				endLineNumber: cursor.lineNumber,
-				color: DecorationsOverviewRuler._CURSOR_COLOR,
-				darkColor: DecorationsOverviewRuler._CURSOR_COLOR_DARK,
-				position: editorCommon.OverviewRulerLane.Full
-			});
+	private _createZonesFromCursors(): OverviewRulerZone[] {
+		let zones:OverviewRulerZone[] = [];
+
+		for (let i = 0, len = this._cursorPositions.length; i < len; i++) {
+			let cursor = this._cursorPositions[i];
+
+			zones.push(new OverviewRulerZone(
+					cursor.lineNumber,
+					cursor.lineNumber,
+					editorCommon.OverviewRulerLane.Full,
+					2,
+					DecorationsOverviewRuler._CURSOR_COLOR,
+					DecorationsOverviewRuler._CURSOR_COLOR_DARK
+			));
 		}
 
 		return zones;
 	}
 
-	_render(ctx:IRenderingContext): void {
-
-		var shouldForceRender = this._shouldForceRender;
-		this._shouldForceRender = false;
+	public prepareRender(ctx:IRenderingContext): void {
+		// Nothing to read
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+	}
 
-		// Update decorations if necessary
-		var shouldRender = false;
+	public render(ctx:IRestrictedRenderingContext): void {
 		if (this._shouldUpdateDecorations || this._shouldUpdateCursorPosition) {
 
 			if (this._shouldUpdateDecorations) {
@@ -200,33 +193,27 @@ export class DecorationsOverviewRuler extends ViewPart {
 				}
 			}
 
-			var allZones:IOverviewRulerZone[] = [];
+			var allZones:OverviewRulerZone[] = [];
 			allZones = allZones.concat(this._zonesFromCursors);
 			allZones = allZones.concat(this._zonesFromDecorations);
 
 			this._overviewRuler.setZones(allZones, false);
-
-			shouldRender = true;
 		}
 
-		if (shouldRender || shouldForceRender) {
-			this._requestModificationFrame(() => {
-				var hasRendered = this._overviewRuler.render(shouldForceRender);
-
-				if (hasRendered && OverviewRulerImpl.hasCanvas && this._overviewRuler.getLanesCount() > 0 && (this._zonesFromDecorations.length > 0 || this._zonesFromCursors.length > 0)) {
-					var ctx2 = this._overviewRuler.getDomNode().getContext('2d');
-					ctx2.beginPath();
-					ctx2.lineWidth = 1;
-					ctx2.strokeStyle = 'rgba(197,197,197,0.8)';
-					ctx2.moveTo(0, 0);
-					ctx2.lineTo(0, this._overviewRuler.getHeight());
-					ctx2.stroke();
-
-					ctx2.moveTo(0, 0);
-					ctx2.lineTo(this._overviewRuler.getWidth(), 0);
-					ctx2.stroke();
-				}
-			});
+		var hasRendered = this._overviewRuler.render(false);
+
+		if (hasRendered && OverviewRulerImpl.hasCanvas && this._overviewRuler.getLanesCount() > 0 && (this._zonesFromDecorations.length > 0 || this._zonesFromCursors.length > 0)) {
+			var ctx2 = this._overviewRuler.getDomNode().getContext('2d');
+			ctx2.beginPath();
+			ctx2.lineWidth = 1;
+			ctx2.strokeStyle = 'rgba(197,197,197,0.8)';
+			ctx2.moveTo(0, 0);
+			ctx2.lineTo(0, this._overviewRuler.getHeight());
+			ctx2.stroke();
+
+			ctx2.moveTo(0, 0);
+			ctx2.lineTo(this._overviewRuler.getWidth(), 0);
+			ctx2.stroke();
 		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/overviewRuler/overviewRuler.ts
code:
@@ -6,7 +6,7 @@
 
 import {IConfigurationChangedEvent, IOverviewRulerPosition} from 'vs/editor/common/editorCommon';
 import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IOverviewRuler, IOverviewRulerZone, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {IOverviewRuler, OverviewRulerZone, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {OverviewRulerImpl} from 'vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl';
 
 export class OverviewRuler extends ViewEventHandler implements IOverviewRuler {
@@ -61,7 +61,7 @@ export class OverviewRuler extends ViewEventHandler implements IOverviewRuler {
 		this._overviewRuler.setLayout(position, true);
 	}
 
-	public setZones(zones:IOverviewRulerZone[]): void {
+	public setZones(zones:OverviewRulerZone[]): void {
 		this._overviewRuler.setZones(zones, true);
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/overviewRuler/overviewRulerImpl.ts
code:
@@ -7,71 +7,280 @@
 import * as browser from 'vs/base/browser/browser';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import {IOverviewRulerPosition, OverviewRulerLane} from 'vs/editor/common/editorCommon';
-import {IOverviewRulerZone} from 'vs/editor/browser/editorBrowser';
+import {OverviewRulerZone, ColorZone} from 'vs/editor/browser/editorBrowser';
 
-interface IColorZone {
-	from: number;
-	to: number;
-}
+class ZoneManager {
 
-interface IColorZoneMap {
-	[color:string]:IColorZone[];
-}
+	private _getVerticalOffsetForLine:(lineNumber:number)=>number;
+	private _zones: OverviewRulerZone[];
+	private _colorZonesInvalid: boolean;
+	private _lineHeight: number;
+	private _width: number;
+	private _height: number;
+	private _outerHeight: number;
+	private _maximumHeight: number;
+	private _minimumHeight: number;
+	private _useDarkColor: boolean;
 
-function zoneEquals(a:IOverviewRulerZone, b:IOverviewRulerZone): boolean {
-	return (
-		a.startLineNumber === b.startLineNumber
-		&& a.endLineNumber === b.endLineNumber
-		&& a.forceHeight === b.forceHeight
-		&& a.color === b.color
-		&& a.position === b.position
-	);
-}
+	private _lastAssignedId;
+	private _color2Id: { [color:string]: number; };
+	private _id2Color: string[];
+
+	constructor(getVerticalOffsetForLine:(lineNumber:number)=>number) {
+		this._getVerticalOffsetForLine = getVerticalOffsetForLine;
+		this._zones = [];
+		this._colorZonesInvalid = false;
+		this._lineHeight = 0;
+		this._width = 0;
+		this._height = 0;
+		this._outerHeight = 0;
+		this._maximumHeight = 0;
+		this._minimumHeight = 0;
+		this._useDarkColor = false;
+
+		this._lastAssignedId = 0;
+		this._color2Id = Object.create(null);
+		this._id2Color = [];
+	}
+
+	public getId2Color(): string[] {
+		return this._id2Color;
+	}
+
+	public setZones(newZones: OverviewRulerZone[]): void {
+		newZones.sort((a, b) => a.compareTo(b));
+
+		let oldZones = this._zones;
+		let oldIndex = 0;
+		let oldLength = this._zones.length;
+		let newIndex = 0;
+		let newLength = newZones.length;
+
+		let result: OverviewRulerZone[] = [];
+		while (newIndex < newLength) {
+			let newZone = newZones[newIndex];
+
+			if (oldIndex >= oldLength) {
+				result.push(newZone);
+				newIndex++;
+			} else {
+				let oldZone = oldZones[oldIndex];
+				let cmp = oldZone.compareTo(newZone);
+				if (cmp < 0) {
+					oldIndex++;
+				} else if (cmp > 0) {
+					result.push(newZone);
+					newIndex++;
+				} else {
+					// cmp === 0
+					result.push(oldZone);
+					oldIndex++;
+					newIndex++;
+				}
+			}
+		}
+
+		this._zones = result;
+	}
+
+	public setLineHeight(lineHeight:number): boolean {
+		if (this._lineHeight === lineHeight) {
+			return false;
+		}
+		this._lineHeight = lineHeight;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public getWidth(): number {
+		return this._width;
+	}
+
+	public setWidth(width:number): boolean {
+		if (this._width === width) {
+			return false;
+		}
+		this._width = width;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public getHeight(): number {
+		return this._height;
+	}
 
-function zonesEqual(a:IOverviewRulerZone[], b:IOverviewRulerZone[]): boolean {
-	if (a === b) {
+	public setHeight(height:number): boolean {
+		if (this._height === height) {
+			return false;
+		}
+		this._height = height;
+		this._colorZonesInvalid = true;
 		return true;
 	}
-	if (a.length !== b.length) {
-		return false;
+
+	public getOuterHeight(): number {
+		return this._outerHeight;
 	}
-	for (var i = 0, len = a.length; i < len; i++) {
-		if (!zoneEquals(a[i], b[i])) {
+
+	public setOuterHeight(outerHeight:number): boolean {
+		if (this._outerHeight === outerHeight) {
 			return false;
 		}
+		this._outerHeight = outerHeight;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public setMaximumHeight(maximumHeight:number): boolean {
+		if (this._maximumHeight === maximumHeight) {
+			return false;
+		}
+		this._maximumHeight = maximumHeight;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public setMinimumHeight(minimumHeight:number): boolean {
+		if (this._minimumHeight === minimumHeight) {
+			return false;
+		}
+		this._minimumHeight = minimumHeight;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public setUseDarkColor(useDarkColor:boolean): boolean {
+		if (this._useDarkColor === useDarkColor) {
+			return false;
+		}
+		this._useDarkColor = useDarkColor;
+		this._colorZonesInvalid = true;
+		return true;
+	}
+
+	public resolveColorZones(): ColorZone[] {
+		const colorZonesInvalid = this._colorZonesInvalid;
+		const lineHeight = Math.floor(this._lineHeight); // @perf
+		const totalHeight = Math.floor(this._height); // @perf
+		const maximumHeight = Math.floor(this._maximumHeight); // @perf
+		const minimumHeight = Math.floor(this._minimumHeight); // @perf
+		const useDarkColor = this._useDarkColor; // @perf
+		const outerHeight = Math.floor(this._outerHeight); // @perf
+		const heightRatio = totalHeight / outerHeight;
+
+		let allColorZones: ColorZone[] = [];
+		for (let i = 0, len = this._zones.length; i < len; i++) {
+			let zone = this._zones[i];
+
+			if (!colorZonesInvalid) {
+				let colorZones = zone.getColorZones();
+				if (colorZones) {
+					for (let j = 0, lenJ = colorZones.length; j < lenJ; j++) {
+						allColorZones.push(colorZones[j]);
+					}
+					continue;
+				}
+			}
+
+			let y1 = Math.floor(this._getVerticalOffsetForLine(zone.startLineNumber));
+			let y2 = Math.floor(this._getVerticalOffsetForLine(zone.endLineNumber)) + lineHeight;
+
+			y1 = Math.floor(y1 * heightRatio);
+			y2 = Math.floor(y2 * heightRatio);
+
+			let colorZones: ColorZone[] = [];
+			if (zone.forceHeight) {
+				y2 = y1 + zone.forceHeight;
+				colorZones.push(this.createZone(totalHeight, y1, y2, zone.forceHeight, zone.forceHeight, zone.getColor(useDarkColor), zone.position));
+			} else {
+				// Figure out if we can render this in one continuous zone
+				let zoneLineNumbers = zone.endLineNumber - zone.startLineNumber + 1;
+				let zoneMaximumHeight = zoneLineNumbers * maximumHeight;
+
+				if (y2 - y1 > zoneMaximumHeight) {
+					// We need to draw one zone per line
+					for (let lineNumber = zone.startLineNumber; lineNumber <= zone.endLineNumber; lineNumber++) {
+						y1 = Math.floor(this._getVerticalOffsetForLine(lineNumber));
+						y2 = y1 + lineHeight;
+
+						y1 = Math.floor(y1 * heightRatio);
+						y2 = Math.floor(y2 * heightRatio);
+
+						colorZones.push(this.createZone(totalHeight, y1, y2, minimumHeight, maximumHeight, zone.getColor(useDarkColor), zone.position));
+					}
+				} else {
+					colorZones.push(this.createZone(totalHeight, y1, y2, minimumHeight, zoneMaximumHeight, zone.getColor(useDarkColor), zone.position));
+				}
+			}
+
+			zone.setColorZones(colorZones);
+			for (let j = 0, lenJ = colorZones.length; j < lenJ; j++) {
+				allColorZones.push(colorZones[j]);
+			}
+		}
+
+		this._colorZonesInvalid = false;
+
+		let sortFunc = (a:ColorZone, b:ColorZone) => {
+			if (a.colorId === b.colorId) {
+				if (a.from === b.from) {
+					return a.to - b.to;
+				}
+				return a.from - b.from;
+			}
+			return a.colorId - b.colorId;
+		};
+
+		allColorZones.sort(sortFunc);
+		return allColorZones;
+	}
+
+	public createZone(totalHeight:number, y1:number, y2:number, minimumHeight:number, maximumHeight:number, color:string, position:OverviewRulerLane): ColorZone {
+		totalHeight = Math.floor(totalHeight); // @perf
+		y1 = Math.floor(y1); // @perf
+		y2 = Math.floor(y2); // @perf
+		minimumHeight = Math.floor(minimumHeight); // @perf
+		maximumHeight = Math.floor(maximumHeight); // @perf
+
+		let ycenter = Math.floor((y1 + y2) / 2);
+		let halfHeight = (y2 - ycenter);
+
+
+		if (halfHeight > maximumHeight / 2) {
+			halfHeight = maximumHeight / 2;
+		}
+		if (halfHeight < minimumHeight / 2) {
+			halfHeight = minimumHeight / 2;
+		}
+
+		if (ycenter - halfHeight < 0) {
+			ycenter = halfHeight;
+		}
+		if (ycenter + halfHeight > totalHeight) {
+			ycenter = totalHeight - halfHeight;
+		}
+
+		let colorId = this._color2Id[color];
+		if (!colorId) {
+			colorId = (++this._lastAssignedId);
+			this._color2Id[color] = colorId;
+			this._id2Color[colorId] = color;
+		}
+		return new ColorZone(ycenter - halfHeight, ycenter + halfHeight, colorId, position);
 	}
-	return true;
 }
 
 export class OverviewRulerImpl {
 
 	public static hasCanvas = (window.navigator.userAgent.indexOf('MSIE 8') === -1);
 
-	// Protected
-	private _minimumHeight: number;
-	private _maximumHeight: number;
-	private _getVerticalOffsetForLine:(lineNumber:number)=>number;
-	private _zones:IOverviewRulerZone[];
-	private _renderedZones:IOverviewRulerZone[];
 	private _canvasLeftOffset: number;
-
 	private _domNode: HTMLCanvasElement;
-	private _width:number;
-	private _height:number;
-	private _outerHeight:number;
-	private _lineHeight:number;
 	private _lanesCount:number;
-	private _useDarkColor:boolean;
+	private _zoneManager: ZoneManager;
 
 	constructor(canvasLeftOffset:number, cssClassName:string, scrollHeight:number, lineHeight:number, minimumHeight:number, maximumHeight:number, getVerticalOffsetForLine:(lineNumber:number)=>number) {
 		this._canvasLeftOffset = canvasLeftOffset;
-		this._minimumHeight = minimumHeight;
-		this._maximumHeight = maximumHeight;
-		this._getVerticalOffsetForLine = getVerticalOffsetForLine;
-		this._zones = [];
-		this._renderedZones = [];
-		this._useDarkColor = false;
-
 
 		this._domNode = <HTMLCanvasElement>document.createElement('canvas');
 		this._domNode.className = cssClassName;
@@ -80,26 +289,33 @@ export class OverviewRulerImpl {
 			this._domNode.style.transform = 'translate3d(0px, 0px, 0px)';
 		}
 
-		this._width = 0;
-		this._height = 0;
-		this._outerHeight = scrollHeight;
-		this._lineHeight = lineHeight;
 		this._lanesCount = 3;
+
+		this._zoneManager = new ZoneManager(getVerticalOffsetForLine);
+		this._zoneManager.setMinimumHeight(minimumHeight);
+		this._zoneManager.setMaximumHeight(maximumHeight);
+		this._zoneManager.setUseDarkColor(false);
+		this._zoneManager.setWidth(0);
+		this._zoneManager.setHeight(0);
+		this._zoneManager.setOuterHeight(scrollHeight);
+		this._zoneManager.setLineHeight(lineHeight);
 	}
 
 	public dispose(): void {
-		this._zones = [];
+		this._zoneManager = null;
 	}
 
 	public setLayout(position:IOverviewRulerPosition, render:boolean): void {
 		StyleMutator.setTop(this._domNode, position.top);
 		StyleMutator.setRight(this._domNode, position.right);
 
-		if (this._width !== position.width || this._height !== position.height) {
-			this._width = position.width;
-			this._height = position.height;
-			this._domNode.width = this._width;
-			this._domNode.height = this._height;
+		let hasChanged = false;
+		hasChanged = this._zoneManager.setWidth(position.width) || hasChanged;
+		hasChanged = this._zoneManager.setHeight(position.height) || hasChanged;
+
+		if (hasChanged) {
+			this._domNode.width = this._zoneManager.getWidth();
+			this._domNode.height = this._zoneManager.getHeight();
 
 			if (render) {
 				this.render(true);
@@ -120,7 +336,7 @@ export class OverviewRulerImpl {
 	}
 
 	public setUseDarkColor(useDarkColor:boolean, render:boolean): void {
-		this._useDarkColor = useDarkColor;
+		this._zoneManager.setUseDarkColor(useDarkColor);
 
 		if (render) {
 			this.render(true);
@@ -132,194 +348,133 @@ export class OverviewRulerImpl {
 	}
 
 	public getWidth(): number {
-		return this._width;
+		return this._zoneManager.getWidth();
 	}
 
 	public getHeight(): number {
-		return this._height;
+		return this._zoneManager.getHeight();
 	}
 
 	public setScrollHeight(scrollHeight:number, render:boolean): void {
-		this._outerHeight = scrollHeight;
+		this._zoneManager.setOuterHeight(scrollHeight);
 		if (render) {
 			this.render(true);
 		}
 	}
 
 	public setLineHeight(lineHeight:number, render:boolean): void {
-		this._lineHeight = lineHeight;
+		this._zoneManager.setLineHeight(lineHeight);
 		if (render) {
 			this.render(true);
 		}
 	}
 
-	public setZones(zones:IOverviewRulerZone[], render:boolean): void {
-		this._zones = zones;
+	public setZones(zones:OverviewRulerZone[], render:boolean): void {
+		this._zoneManager.setZones(zones);
 		if (render) {
 			this.render(false);
 		}
 	}
 
-	private _insertZone(colorsZones:IColorZoneMap, y1:number, y2:number, minimumHeight:number, maximumHeight:number, color:string): void {
-		var ycenter = Math.floor((y1 + y2) / 2);
-		var halfHeight = (y2 - ycenter);
-
-
-		if (halfHeight > maximumHeight / 2) {
-			halfHeight = maximumHeight / 2;
+	public render(forceRender:boolean): boolean {
+		if (!OverviewRulerImpl.hasCanvas) {
+			return false;
 		}
-		if (halfHeight < minimumHeight / 2) {
-			halfHeight = minimumHeight / 2;
+		if (this._zoneManager.getOuterHeight() === 0) {
+			return false;
 		}
 
-		if (ycenter - halfHeight < 0) {
-			ycenter = halfHeight;
-		}
-		if (ycenter + halfHeight > this._height) {
-			ycenter = this._height - halfHeight;
-		}
+		const width = this._zoneManager.getWidth();
+		const height = this._zoneManager.getHeight();
 
-		colorsZones[color] = colorsZones[color] || [];
-		colorsZones[color].push({
-			from: ycenter - halfHeight,
-			to: ycenter + halfHeight
-		});
-	}
+		let colorZones = this._zoneManager.resolveColorZones();
+		let id2Color = this._zoneManager.getId2Color();
 
-	private _getColorForZone(zone:IOverviewRulerZone): string {
-		if (this._useDarkColor) {
-			return zone.darkColor;
-		}
-		return zone.color;
-	}
+		let ctx = this._domNode.getContext('2d');
+		ctx.clearRect (0, 0, width, height);
 
-	private _renderVerticalPatch(ctx:CanvasRenderingContext2D, heightRatio:number, laneMask:number, xpos:number, width:number): void {
-		var colorsZones:IColorZoneMap = {};
-		var i:number, len:number, zone:IOverviewRulerZone, y1:number, y2:number, zoneLineNumbers:number, zoneMaximumHeight:number;
-		for (i = 0, len = this._zones.length; i < len; i++) {
-			zone = this._zones[i];
+		if (colorZones.length > 0) {
+			let remainingWidth = width - this._canvasLeftOffset;
 
-			if (!(zone.position & laneMask)) {
-				continue;
+			if (this._lanesCount >= 3) {
+				this._renderThreeLanes(ctx, colorZones, id2Color, remainingWidth);
+			} else if (this._lanesCount === 2) {
+				this._renderTwoLanes(ctx, colorZones, id2Color, remainingWidth);
+			} else if (this._lanesCount === 1) {
+				this._renderOneLane(ctx, colorZones, id2Color, remainingWidth);
 			}
+		}
 
-			y1 = this._getVerticalOffsetForLine(zone.startLineNumber);
-			y2 = this._getVerticalOffsetForLine(zone.endLineNumber) + this._lineHeight;
-
-			y1 *= heightRatio;
-			y2 *= heightRatio;
-
-			if (zone.forceHeight) {
-				y2 = y1 + zone.forceHeight;
-				this._insertZone(colorsZones, y1, y2, zone.forceHeight, zone.forceHeight, this._getColorForZone(zone));
-			} else {
-				// Figure out if we can render this in one continuous zone
-				zoneLineNumbers = zone.endLineNumber - zone.startLineNumber + 1;
-				zoneMaximumHeight = zoneLineNumbers * this._maximumHeight;
+		return true;
+	}
 
-				if (y2 - y1 > zoneMaximumHeight) {
-					// We need to draw one zone per line
-					for (var lineNumber = zone.startLineNumber; lineNumber <= zone.endLineNumber; lineNumber++) {
-						y1 = this._getVerticalOffsetForLine(lineNumber);
-						y2 = y1 + this._lineHeight;
+	private _renderOneLane(ctx:CanvasRenderingContext2D, colorZones:ColorZone[], id2Color:string[], w:number): void {
 
-						y1 *= heightRatio;
-						y2 *= heightRatio;
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Left | OverviewRulerLane.Center | OverviewRulerLane.Right, this._canvasLeftOffset, w);
 
-						this._insertZone(colorsZones, y1, y2, this._minimumHeight, this._maximumHeight, this._getColorForZone(zone));
-					}
-				} else {
-					this._insertZone(colorsZones, y1, y2, this._minimumHeight, zoneMaximumHeight, this._getColorForZone(zone));
-				}
-			}
+	}
 
-		}
+	private _renderTwoLanes(ctx:CanvasRenderingContext2D, colorZones:ColorZone[], id2Color:string[], w:number): void {
 
-		var sorter = (a:IColorZone, b:IColorZone) => {
-			return a.from - b.from;
-		};
+		let leftWidth = Math.floor(w / 2);
+		let rightWidth = w - leftWidth;
+		let leftOffset = this._canvasLeftOffset;
+		let rightOffset = this._canvasLeftOffset + leftWidth;
 
-		// Merge color zones
-		var colorName:string, colorZones:IColorZone[], currentFrom:number, currentTo:number;
-		for (colorName in colorsZones) {
-			if (colorsZones.hasOwnProperty(colorName)) {
-				colorZones = colorsZones[colorName];
-
-				// Merge & Render zones
-				colorZones.sort(sorter);
-				currentFrom = colorZones[0].from;
-				currentTo = colorZones[0].to;
-				ctx.fillStyle = colorName;
-				for (i = 1, len = colorZones.length; i < len; i++) {
-					if (currentTo >= colorZones[i].from) {
-						currentTo = Math.max(currentTo, colorZones[i].to);
-					} else {
-						ctx.fillRect (xpos, currentFrom, width, currentTo - currentFrom);
-						currentFrom = colorZones[i].from;
-						currentTo = colorZones[i].to;
-					}
-				}
-				ctx.fillRect (xpos, currentFrom, width, currentTo - currentFrom);
-			}
-		}
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Left | OverviewRulerLane.Center, leftOffset, leftWidth);
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Right, rightOffset, rightWidth);
 	}
 
-	public render(forceRender:boolean): boolean {
-		if (this._outerHeight === 0) {
-			return false;
-		}
-		if (!OverviewRulerImpl.hasCanvas) {
-			return false;
-		}
-		var shouldRender = forceRender || !zonesEqual(this._renderedZones, this._zones);
-		if (shouldRender) {
-			var heightRatio = this._height / this._outerHeight;
-
-			var ctx = this._domNode.getContext('2d');
-			ctx.clearRect (0, 0, this._width, this._height);
+	private _renderThreeLanes(ctx:CanvasRenderingContext2D, colorZones:ColorZone[], id2Color:string[], w:number): void {
 
-			var remainingWidth = this._width - this._canvasLeftOffset;
+		let leftWidth = Math.floor(w / 3);
+		let rightWidth = Math.floor(w / 3);
+		let centerWidth = w - leftWidth - rightWidth;
+		let leftOffset = this._canvasLeftOffset;
+		let centerOffset = this._canvasLeftOffset + leftWidth;
+		let rightOffset = this._canvasLeftOffset + leftWidth + centerWidth;
 
-			if (this._lanesCount >= 3) {
-				this._renderThreeLanes(ctx, heightRatio, remainingWidth);
-			} else if (this._lanesCount === 2) {
-				this._renderTwoLanes(ctx, heightRatio, remainingWidth);
-			} else if (this._lanesCount === 1) {
-				this._renderOneLane(ctx, heightRatio, remainingWidth);
-			}
-		}
-		this._renderedZones = this._zones;
-		return shouldRender;
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Left, leftOffset, leftWidth);
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Center, centerOffset, centerWidth);
+		this._renderVerticalPatch(ctx, colorZones, id2Color, OverviewRulerLane.Right, rightOffset, rightWidth);
 	}
 
-	private _renderOneLane(ctx:CanvasRenderingContext2D, heightRatio:number, w:number): void {
+	private _renderVerticalPatch(ctx:CanvasRenderingContext2D, colorZones:ColorZone[], id2Color:string[], laneMask:number, xpos:number, width:number): void {
 
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left | OverviewRulerLane.Center | OverviewRulerLane.Right, this._canvasLeftOffset, w);
+		let currentColorId = 0;
+		let currentFrom = 0;
+		let currentTo = 0;
 
-	}
+		for (let i = 0, len = colorZones.length; i < len; i++) {
+			let zone = colorZones[i];
 
-	private _renderTwoLanes(ctx:CanvasRenderingContext2D, heightRatio:number, w:number): void {
+			if (!(zone.position & laneMask)) {
+				continue;
+			}
 
-		var leftWidth = Math.floor(w / 2),
-			rightWidth = w - leftWidth,
-			leftOffset = this._canvasLeftOffset,
-			rightOffset = this._canvasLeftOffset + leftWidth;
+			let zoneColorId = zone.colorId;
+			let zoneFrom = zone.from;
+			let zoneTo = zone.to;
 
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left | OverviewRulerLane.Center, leftOffset, leftWidth);
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Right, rightOffset, rightWidth);
-	}
+			if (zoneColorId !== currentColorId) {
+				ctx.fillRect (xpos, currentFrom, width, currentTo - currentFrom);
 
-	private _renderThreeLanes(ctx:CanvasRenderingContext2D, heightRatio:number, w:number): void {
+				currentColorId = zoneColorId;
+				ctx.fillStyle = id2Color[currentColorId];
+				currentFrom = zoneFrom;
+				currentTo = zoneTo;
+			} else {
+				if (currentTo >= zoneFrom) {
+					currentTo = Math.max(currentTo, zoneTo);
+				} else {
+					ctx.fillRect (xpos, currentFrom, width, currentTo - currentFrom);
+					currentFrom = zoneFrom;
+					currentTo = zoneTo;
+				}
+			}
+		}
 
-		var leftWidth = Math.floor(w / 3),
-			rightWidth = Math.floor(w / 3),
-			centerWidth = w - leftWidth - rightWidth,
-			leftOffset = this._canvasLeftOffset,
-			centerOffset = this._canvasLeftOffset + leftWidth,
-			rightOffset = this._canvasLeftOffset + leftWidth + centerWidth;
+		ctx.fillRect (xpos, currentFrom, width, currentTo - currentFrom);
 
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Left, leftOffset, leftWidth);
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Center, centerOffset, centerWidth);
-		this._renderVerticalPatch(ctx, heightRatio, OverviewRulerLane.Right, rightOffset, rightWidth);
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/rulers/rulers.ts
code:
@@ -8,7 +8,7 @@
 import 'vs/css!./rulers';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ILayoutProvider, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ILayoutProvider, IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export class Rulers extends ViewPart {
@@ -50,30 +50,35 @@ export class Rulers extends ViewPart {
 
 	// --- end event handlers
 
-	_render(ctx: IRenderingContext): void {
-		this._requestModificationFrame(() => {
-			let existingRulersLength = this.domNode.children.length;
-			let max = Math.max(existingRulersLength, this._rulers.length);
+	public prepareRender(ctx:IRenderingContext): void {
+		// Nothing to read
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+	}
 
-			for (let i = 0; i < max; i++) {
+	public render(ctx:IRestrictedRenderingContext): void {
+		let existingRulersLength = this.domNode.children.length;
+		let max = Math.max(existingRulersLength, this._rulers.length);
 
-				if (i >= this._rulers.length) {
-					this.domNode.removeChild(this.domNode.lastChild);
-					continue;
-				}
+		for (let i = 0; i < max; i++) {
 
-				let node: HTMLElement;
-				if (i < existingRulersLength) {
-					node = <HTMLElement>this.domNode.children[i];
-				} else {
-					node = document.createElement('div');
-					node.className = 'view-ruler';
-					this.domNode.appendChild(node);
-				}
+			if (i >= this._rulers.length) {
+				this.domNode.removeChild(this.domNode.lastChild);
+				continue;
+			}
 
-				StyleMutator.setHeight(node, Math.min(this._layoutProvider.getTotalHeight(), 1000000));
-				StyleMutator.setLeft(node, this._rulers[i] * this._typicalHalfwidthCharacterWidth);
+			let node: HTMLElement;
+			if (i < existingRulersLength) {
+				node = <HTMLElement>this.domNode.children[i];
+			} else {
+				node = document.createElement('div');
+				node.className = 'view-ruler';
+				this.domNode.appendChild(node);
 			}
-		});
+
+			StyleMutator.setHeight(node, Math.min(this._layoutProvider.getTotalHeight(), 1000000));
+			StyleMutator.setLeft(node, this._rulers[i] * this._typicalHalfwidthCharacterWidth);
+		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/scrollDecoration/scrollDecoration.ts
code:
@@ -9,7 +9,7 @@ import 'vs/css!./scrollDecoration';
 import * as dom from 'vs/base/browser/dom';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import {IConfigurationChangedEvent, IEditorLayoutInfo, IScrollEvent} from 'vs/editor/common/editorCommon';
-import {ClassNames, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ClassNames, IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export class ScrollDecorationViewPart extends ViewPart {
@@ -18,18 +18,20 @@ export class ScrollDecorationViewPart extends ViewPart {
 	private _scrollTop: number;
 	private _width: number;
 	private _shouldShow: boolean;
+	private _useShadows: boolean;
 
 	constructor(context: IViewContext) {
 		super(context);
 
 		this._scrollTop = 0;
 		this._width = 0;
 		this._shouldShow = false;
+		this._useShadows = this._context.configuration.editor.scrollbar.useShadows;
 		this._domNode = document.createElement('div');
 	}
 
 	private _updateShouldShow(): boolean {
-		var newShouldShow = (this._context.configuration.editor.scrollbar.useShadows && this._scrollTop > 0);
+		var newShouldShow = (this._useShadows && this._scrollTop > 0);
 		if (this._shouldShow !== newShouldShow) {
 			this._shouldShow = newShouldShow;
 			return true;
@@ -44,6 +46,9 @@ export class ScrollDecorationViewPart extends ViewPart {
 	// --- begin event handlers
 
 	public onConfigurationChanged(e: IConfigurationChangedEvent): boolean {
+		if (e.scrollbar) {
+			this._useShadows = this._context.configuration.editor.scrollbar.useShadows;
+		}
 		return this._updateShouldShow();
 	}
 	public onLayoutChanged(layoutInfo: IEditorLayoutInfo): boolean {
@@ -60,10 +65,15 @@ export class ScrollDecorationViewPart extends ViewPart {
 
 	// --- end event handlers
 
-	_render(ctx: IRenderingContext): void {
-		this._requestModificationFrame(() => {
-			StyleMutator.setWidth(this._domNode, this._width);
-			dom.toggleClass(this._domNode, ClassNames.SCROLL_DECORATION, this._shouldShow);
-		});
+	public prepareRender(ctx:IRenderingContext): void {
+		// Nothing to read
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+	}
+
+	public render(ctx:IRestrictedRenderingContext): void {
+		StyleMutator.setWidth(this._domNode, this._width);
+		dom.toggleClass(this._domNode, ClassNames.SCROLL_DECORATION, this._shouldShow);
 	}
-}
\ No newline at end of file
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/selections/selections.ts
code:
@@ -7,16 +7,12 @@
 
 import 'vs/css!./selections';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ViewEventHandler} from 'vs/editor/common/viewModel/viewEventHandler';
-import {IDynamicViewOverlay, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {DynamicViewOverlay} from 'vs/editor/browser/view/dynamicViewOverlay';
+import {IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 
 type HorizontalRange = editorCommon.HorizontalRange;
 type LineVisibleRanges = editorCommon.LineVisibleRanges;
 
-interface IRenderResult {
-	[lineNumber:string]:string[];
-}
-
 enum CornerStyle {
 	EXTERN,
 	INTERN,
@@ -69,7 +65,7 @@ const isIEWithZoomingIssuesNearRoundedBorders = (
 );
 
 
-export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewOverlay {
+export class SelectionsOverlay extends DynamicViewOverlay {
 
 	private static SELECTION_CLASS_NAME = 'selected-text';
 	private static SELECTION_TOP_LEFT = 'top-left-radius';
@@ -81,12 +77,16 @@ export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewO
 	private static ROUNDED_PIECE_WIDTH = 10;
 
 	private _context:IViewContext;
+	private _lineHeight:number;
+	private _roundedSelection:boolean;
 	private _selections:editorCommon.IEditorRange[];
-	private _renderResult:IRenderResult;
+	private _renderResult:string[];
 
 	constructor(context:IViewContext) {
 		super();
 		this._context = context;
+		this._lineHeight = this._context.configuration.editor.lineHeight;
+		this._roundedSelection = this._context.configuration.editor.roundedSelection;
 		this._selections = [];
 		this._renderResult = null;
 		this._context.addEventHandler(this);
@@ -129,6 +129,12 @@ export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewO
 		return false;
 	}
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
+		}
+		if (e.roundedSelection) {
+			this._roundedSelection = this._context.configuration.editor.roundedSelection;
+		}
 		return true;
 	}
 	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
@@ -277,100 +283,87 @@ export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewO
 		let linesVisibleRanges = _linesVisibleRanges.map(toStyled);
 		let visibleRangesHaveGaps = this._visibleRangesHaveGaps(linesVisibleRanges);
 
-		if (!isIEWithZoomingIssuesNearRoundedBorders && !visibleRangesHaveGaps && this._context.configuration.editor.roundedSelection) {
+		if (!isIEWithZoomingIssuesNearRoundedBorders && !visibleRangesHaveGaps && this._roundedSelection) {
 			this._enrichVisibleRangesWithStyle(linesVisibleRanges, previousFrame);
 		}
 
 		// The visible ranges are sorted TOP-BOTTOM and LEFT-RIGHT
 		return linesVisibleRanges;
 	}
 
-	private _createSelectionPiece(lineOutput:string[], top:number, height:string, className:string, left:number, width:number): void {
-		lineOutput.push('<div class="cslr ');
-		lineOutput.push(className);
-		lineOutput.push('" style="top:');
-		lineOutput.push(top.toString());
-		lineOutput.push('px;left:');
-		lineOutput.push(left.toString());
-		lineOutput.push('px;width:');
-		lineOutput.push(width.toString());
-		lineOutput.push('px;height:');
-		lineOutput.push(height);
-		lineOutput.push('px;"></div>');
+	private _createSelectionPiece(top:number, height:string, className:string, left:number, width:number): string {
+		return (
+			'<div class="cslr '
+			+ className
+			+ '" style="top:'
+			+ top.toString()
+			+ 'px;left:'
+			+ left.toString()
+			+ 'px;width:'
+			+ width.toString()
+			+ 'px;height:'
+			+ height
+			+ 'px;"></div>'
+		);
 	}
 
-	private _actualRenderOneSelection(output:IRenderResult, hasMultipleSelections:boolean, visibleRanges:LineVisibleRangesWithStyle[]): number {
-		var visibleRangesHaveStyle = (visibleRanges.length > 0 && visibleRanges[0].ranges[0].startStyle),
-			lineVisibleRanges:LineVisibleRangesWithStyle,
-			lineOutput: string[],
-			className:string,
-			fullLineHeight = (this._context.configuration.editor.lineHeight).toString(),
-			reducedLineHeight = (this._context.configuration.editor.lineHeight - 1).toString(),
-			i:number, len:number,
-			j:number, lenJ:number,
-			piecesCount = 0,
-			visibleRange:HorizontalRangeWithStyle;
+	private _actualRenderOneSelection(output2:string[], visibleStartLineNumber:number, hasMultipleSelections:boolean, visibleRanges:LineVisibleRangesWithStyle[]): void {
+		let visibleRangesHaveStyle = (visibleRanges.length > 0 && visibleRanges[0].ranges[0].startStyle);
+		let fullLineHeight = (this._lineHeight).toString();
+		let reducedLineHeight = (this._lineHeight - 1).toString();
 
 		let firstLineNumber = (visibleRanges.length > 0 ? visibleRanges[0].lineNumber : 0);
 		let lastLineNumber = (visibleRanges.length > 0 ? visibleRanges[visibleRanges.length - 1].lineNumber : 0);
 
-		for (i = 0, len = visibleRanges.length; i < len; i++) {
-			lineVisibleRanges = visibleRanges[i];
+		for (let i = 0, len = visibleRanges.length; i < len; i++) {
+			let lineVisibleRanges = visibleRanges[i];
 			let lineNumber = lineVisibleRanges.lineNumber;
+			let lineIndex = lineNumber - visibleStartLineNumber;
 
 			let lineHeight = hasMultipleSelections ? (lineNumber === lastLineNumber || lineNumber === firstLineNumber ? reducedLineHeight : fullLineHeight) : fullLineHeight;
 			let top = hasMultipleSelections ? (lineNumber === firstLineNumber ? 1 : 0) : 0;
 
-			if (output.hasOwnProperty(lineNumber.toString())) {
-				lineOutput = output[lineNumber.toString()];
-			} else {
-				lineOutput = [];
-				output[lineNumber.toString()] = lineOutput;
-			}
+			let lineOutput = '';
 
-			for (j = 0, lenJ = lineVisibleRanges.ranges.length; j < lenJ; j++) {
-				visibleRange = lineVisibleRanges.ranges[j];
+			for (let j = 0, lenJ = lineVisibleRanges.ranges.length; j < lenJ; j++) {
+				let visibleRange = lineVisibleRanges.ranges[j];
 
 				if (visibleRangesHaveStyle) {
 					if (visibleRange.startStyle.top === CornerStyle.INTERN || visibleRange.startStyle.bottom === CornerStyle.INTERN) {
 						// Reverse rounded corner to the left
 
 						// First comes the selection (blue layer)
-						piecesCount++;
-						this._createSelectionPiece(lineOutput, top, lineHeight, SelectionsOverlay.SELECTION_CLASS_NAME, visibleRange.left - SelectionsOverlay.ROUNDED_PIECE_WIDTH, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
+						lineOutput += this._createSelectionPiece(top, lineHeight, SelectionsOverlay.SELECTION_CLASS_NAME, visibleRange.left - SelectionsOverlay.ROUNDED_PIECE_WIDTH, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
 
 						// Second comes the background (white layer) with inverse border radius
-						className = SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;
+						let className = SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;
 						if (visibleRange.startStyle.top === CornerStyle.INTERN) {
 							className += ' ' + SelectionsOverlay.SELECTION_TOP_RIGHT;
 						}
 						if (visibleRange.startStyle.bottom === CornerStyle.INTERN) {
 							className += ' ' + SelectionsOverlay.SELECTION_BOTTOM_RIGHT;
 						}
-						piecesCount++;
-						this._createSelectionPiece(lineOutput, top, lineHeight, className, visibleRange.left - SelectionsOverlay.ROUNDED_PIECE_WIDTH, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
+						lineOutput += this._createSelectionPiece(top, lineHeight, className, visibleRange.left - SelectionsOverlay.ROUNDED_PIECE_WIDTH, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
 					}
 					if (visibleRange.endStyle.top === CornerStyle.INTERN || visibleRange.endStyle.bottom === CornerStyle.INTERN) {
 						// Reverse rounded corner to the right
 
 						// First comes the selection (blue layer)
-						piecesCount++;
-						this._createSelectionPiece(lineOutput, top, lineHeight, SelectionsOverlay.SELECTION_CLASS_NAME, visibleRange.left + visibleRange.width, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
+						lineOutput += this._createSelectionPiece(top, lineHeight, SelectionsOverlay.SELECTION_CLASS_NAME, visibleRange.left + visibleRange.width, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
 
 						// Second comes the background (white layer) with inverse border radius
-						className = SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;
+						let className = SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;
 						if (visibleRange.endStyle.top === CornerStyle.INTERN) {
 							className += ' ' + SelectionsOverlay.SELECTION_TOP_LEFT;
 						}
 						if (visibleRange.endStyle.bottom === CornerStyle.INTERN) {
 							className += ' ' + SelectionsOverlay.SELECTION_BOTTOM_LEFT;
 						}
-						piecesCount++;
-						this._createSelectionPiece(lineOutput, top, lineHeight, className, visibleRange.left + visibleRange.width, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
+						lineOutput += this._createSelectionPiece(top, lineHeight, className, visibleRange.left + visibleRange.width, SelectionsOverlay.ROUNDED_PIECE_WIDTH);
 					}
 				}
 
-				className = SelectionsOverlay.SELECTION_CLASS_NAME;
+				let className = SelectionsOverlay.SELECTION_CLASS_NAME;
 				if (visibleRangesHaveStyle) {
 					if (visibleRange.startStyle.top === CornerStyle.EXTERN) {
 						className += ' ' + SelectionsOverlay.SELECTION_TOP_LEFT;
@@ -385,50 +378,52 @@ export class SelectionsOverlay extends ViewEventHandler implements IDynamicViewO
 						className += ' ' + SelectionsOverlay.SELECTION_BOTTOM_RIGHT;
 					}
 				}
-				piecesCount++;
-				this._createSelectionPiece(lineOutput, top, lineHeight, className, visibleRange.left, visibleRange.width);
+				lineOutput += this._createSelectionPiece(top, lineHeight, className, visibleRange.left, visibleRange.width);
 			}
-		}
 
-		return piecesCount;
+			output2[lineIndex] += lineOutput;
+		}
 	}
 
 	private _previousFrameVisibleRangesWithStyle: LineVisibleRangesWithStyle[][] = [];
-	public shouldCallRender2(ctx:IRenderingContext): boolean {
-		if (!this.shouldRender) {
-			return false;
+	public prepareRender(ctx:IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
 		}
-		this.shouldRender = false;
 
-		var output: IRenderResult = {},
-			selection:editorCommon.IEditorRange,
-			visibleRangesWithStyle:LineVisibleRangesWithStyle[],
-			piecesCount = 0,
-			i:number,
-			thisFrameVisibleRangesWithStyle: LineVisibleRangesWithStyle[][] = [];
+		let output: string[] = [];
+		let visibleStartLineNumber = ctx.visibleRange.startLineNumber;
+		let visibleEndLineNumber = ctx.visibleRange.endLineNumber;
+		for (let lineNumber = visibleStartLineNumber; lineNumber <= visibleEndLineNumber; lineNumber++) {
+			let lineIndex = lineNumber - visibleStartLineNumber;
+			output[lineIndex] = '';
+		}
 
-		for (i = 0; i < this._selections.length; i++) {
-			selection = this._selections[i];
+		let thisFrameVisibleRangesWithStyle: LineVisibleRangesWithStyle[][] = [];
+		for (let i = 0, len = this._selections.length; i < len; i++) {
+			let selection = this._selections[i];
 			if (selection.isEmpty()) {
 				thisFrameVisibleRangesWithStyle.push(null);
 				continue;
 			}
 
-			visibleRangesWithStyle = this._getVisibleRangesWithStyle(selection, ctx, this._previousFrameVisibleRangesWithStyle[i]);
+			let visibleRangesWithStyle = this._getVisibleRangesWithStyle(selection, ctx, this._previousFrameVisibleRangesWithStyle[i]);
 			thisFrameVisibleRangesWithStyle.push(visibleRangesWithStyle);
-			piecesCount += this._actualRenderOneSelection(output, this._selections.length > 1, visibleRangesWithStyle);
+			this._actualRenderOneSelection(output, visibleStartLineNumber, this._selections.length > 1, visibleRangesWithStyle);
 		}
 
 		this._previousFrameVisibleRangesWithStyle = thisFrameVisibleRangesWithStyle;
 		this._renderResult = output;
-
-		return true;
 	}
 
-	public render2(lineNumber:number): string[] {
-		if (this._renderResult && this._renderResult.hasOwnProperty(lineNumber.toString())) {
-			return this._renderResult[lineNumber.toString()];
+	public render(startLineNumber:number, lineNumber:number): string {
+		if (!this._renderResult) {
+			return '';
+		}
+		let lineIndex = lineNumber - startLineNumber;
+		if (lineIndex < 0 || lineIndex >= this._renderResult.length) {
+			throw new Error('Unexpected render request');
 		}
-		return null;
+		return this._renderResult[lineIndex];
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/viewCursors/viewCursors.ts
code:
@@ -8,7 +8,7 @@
 import 'vs/css!./viewCursors';
 import * as browser from 'vs/base/browser/browser';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ClassNames, IRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
+import {ClassNames, IRenderingContext, IRestrictedRenderingContext, IViewContext} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 import {ViewCursor} from 'vs/editor/browser/viewParts/viewCursors/viewCursor';
 
@@ -22,20 +22,28 @@ export class ViewCursors extends ViewPart {
 
 	static BLINK_INTERVAL = 500;
 
-	private _isVisible:boolean;
+	private _readOnly: boolean;
+	private _cursorBlinking: string;
+	private _cursorStyle: editorCommon.TextEditorCursorStyle;
 
-	private _domNode:HTMLElement;
+	private _isVisible: boolean;
 
-	private _blinkTimer:number;
+	private _domNode: HTMLElement;
 
-	private _editorHasFocus:boolean;
+	private _blinkTimer: number;
+
+	private _editorHasFocus: boolean;
 
 	private _primaryCursor: ViewCursor;
 	private _secondaryCursors: ViewCursor[];
 
-	constructor(context:IViewContext) {
+	constructor(context: IViewContext) {
 		super(context);
 
+		this._readOnly = this._context.configuration.editor.readOnly;
+		this._cursorBlinking = this._context.configuration.editor.cursorBlinking;
+		this._cursorStyle = this._context.configuration.editor.cursorStyle;
+
 		this._primaryCursor = new ViewCursor(this._context, false);
 		this._secondaryCursors = [];
 
@@ -76,21 +84,21 @@ export class ViewCursors extends ViewPart {
 		this._secondaryCursors = [];
 		return true;
 	}
-	public onModelDecorationsChanged(e:editorCommon.IViewDecorationsChangedEvent): boolean {
+	public onModelDecorationsChanged(e: editorCommon.IViewDecorationsChangedEvent): boolean {
 		// true for inline decorations that can end up relayouting text
 		return e.inlineDecorationsChanged;
 	}
-	public onModelLinesDeleted(e:editorCommon.IViewLinesDeletedEvent): boolean {
+	public onModelLinesDeleted(e: editorCommon.IViewLinesDeletedEvent): boolean {
 		return true;
 	}
-	public onModelLineChanged(e:editorCommon.IViewLineChangedEvent): boolean {
+	public onModelLineChanged(e: editorCommon.IViewLineChangedEvent): boolean {
 		return true;
 	}
-	public onModelLinesInserted(e:editorCommon.IViewLinesInsertedEvent): boolean {
+	public onModelLinesInserted(e: editorCommon.IViewLinesInsertedEvent): boolean {
 		return true;
 	}
-	public onModelTokensChanged(e:editorCommon.IViewTokensChangedEvent): boolean {
-		var shouldRender = (position:editorCommon.IPosition) => {
+	public onModelTokensChanged(e: editorCommon.IViewTokensChangedEvent): boolean {
+		var shouldRender = (position: editorCommon.IPosition) => {
 			return e.fromLineNumber <= position.lineNumber && position.lineNumber <= e.toLineNumber;
 		};
 		if (shouldRender(this._primaryCursor.getPosition())) {
@@ -103,7 +111,7 @@ export class ViewCursors extends ViewPart {
 		}
 		return false;
 	}
-	public onCursorPositionChanged(e:editorCommon.IViewCursorPositionChangedEvent): boolean {
+	public onCursorPositionChanged(e: editorCommon.IViewCursorPositionChangedEvent): boolean {
 		this._primaryCursor.onCursorPositionChanged(e.position, e.isInEditableRange);
 		this._updateBlinking();
 
@@ -130,10 +138,21 @@ export class ViewCursors extends ViewPart {
 
 		return true;
 	}
-	public onCursorSelectionChanged(e:editorCommon.IViewCursorSelectionChangedEvent): boolean {
+	public onCursorSelectionChanged(e: editorCommon.IViewCursorSelectionChangedEvent): boolean {
 		return false;
 	}
-	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
+	public onConfigurationChanged(e: editorCommon.IConfigurationChangedEvent): boolean {
+
+		if (e.readOnly) {
+			this._readOnly = this._context.configuration.editor.readOnly;
+		}
+		if (e.cursorBlinking) {
+			this._cursorBlinking = this._context.configuration.editor.cursorBlinking;
+		}
+		if (e.cursorStyle) {
+			this._cursorStyle = this._context.configuration.editor.cursorStyle;
+		}
+
 		this._primaryCursor.onConfigurationChanged(e);
 		this._updateBlinking();
 		if (e.cursorStyle) {
@@ -144,22 +163,22 @@ export class ViewCursors extends ViewPart {
 		}
 		return true;
 	}
-	public onLayoutChanged(layoutInfo:editorCommon.IEditorLayoutInfo): boolean {
+	public onLayoutChanged(layoutInfo: editorCommon.IEditorLayoutInfo): boolean {
 		return true;
 	}
-	public onScrollChanged(e:editorCommon.IScrollEvent): boolean {
+	public onScrollChanged(e: editorCommon.IScrollEvent): boolean {
 		return true;
 	}
 	public onZonesChanged(): boolean {
 		return true;
 	}
-	public onScrollWidthChanged(scrollWidth:number): boolean {
+	public onScrollWidthChanged(scrollWidth: number): boolean {
 		return true;
 	}
-	public onScrollHeightChanged(scrollHeight:number): boolean {
+	public onScrollHeightChanged(scrollHeight: number): boolean {
 		return false;
 	}
-	public onViewFocusChanged(isFocused:boolean): boolean {
+	public onViewFocusChanged(isFocused: boolean): boolean {
 		this._editorHasFocus = isFocused;
 		this._updateBlinking();
 		return false;
@@ -170,12 +189,12 @@ export class ViewCursors extends ViewPart {
 		return this._primaryCursor.getPosition();
 	}
 
-// ---- blinking logic
+	// ---- blinking logic
 
 	private _getRenderType(): RenderType {
 		if (this._editorHasFocus) {
-			if (this._primaryCursor.getIsInEditableRange() && !this._context.configuration.editor.readOnly) {
-				switch (this._context.configuration.editor.cursorBlinking) {
+			if (this._primaryCursor.getIsInEditableRange() && !this._readOnly) {
+				switch (this._cursorBlinking) {
 					case 'blink':
 						return RenderType.Blink;
 					case 'visible':
@@ -209,7 +228,7 @@ export class ViewCursors extends ViewPart {
 			this._blinkTimer = window.setInterval(() => this._blink(), ViewCursors.BLINK_INTERVAL);
 		}
 	}
-// --- end blinking logic
+	// --- end blinking logic
 
 	private _updateDomClassName(): void {
 		this._domNode.className = this._getClassName();
@@ -218,7 +237,7 @@ export class ViewCursors extends ViewPart {
 	private _getClassName(): string {
 		let result = ClassNames.VIEW_CURSORS_LAYER;
 		let extraClassName: string;
-		switch (this._context.configuration.editor.cursorStyle) {
+		switch (this._cursorStyle) {
 			case editorCommon.TextEditorCursorStyle.Line:
 				extraClassName = 'cursor-line-style';
 				break;
@@ -260,17 +279,21 @@ export class ViewCursors extends ViewPart {
 
 	// ---- IViewPart implementation
 
-	_render(ctx:IRenderingContext): void {
+	public prepareRender(ctx: IRenderingContext): void {
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+
 		this._primaryCursor.prepareRender(ctx);
 		for (var i = 0, len = this._secondaryCursors.length; i < len; i++) {
 			this._secondaryCursors[i].prepareRender(ctx);
 		}
+	}
 
-		this._requestModificationFrame(() => {
-			this._primaryCursor.render(ctx);
-			for (var i = 0, len = this._secondaryCursors.length; i < len; i++) {
-				this._secondaryCursors[i].render(ctx);
-			}
-		});
+	public render(ctx: IRestrictedRenderingContext): void {
+		this._primaryCursor.render(ctx);
+		for (var i = 0, len = this._secondaryCursors.length; i < len; i++) {
+			this._secondaryCursors[i].render(ctx);
+		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/viewParts/viewZones/viewZones.ts
code:
@@ -7,7 +7,7 @@
 import {onUnexpectedError} from 'vs/base/common/errors';
 import {StyleMutator} from 'vs/base/browser/styleMutator';
 import * as editorCommon from 'vs/editor/common/editorCommon';
-import {ClassNames, IRenderingContext, IViewContext, IViewZone} from 'vs/editor/browser/editorBrowser';
+import {ClassNames, IRenderingContext, IRestrictedRenderingContext, IViewContext, IViewZone} from 'vs/editor/browser/editorBrowser';
 import {ViewPart} from 'vs/editor/browser/view/viewPart';
 
 export interface IMyViewZone {
@@ -29,11 +29,13 @@ export class ViewZones extends ViewPart {
 
 	private _whitespaceManager:editorCommon.IWhitespaceManager;
 	private _zones: { [id:string]:IMyViewZone; };
+	private _lineHeight:number;
 
 	public domNode: HTMLElement;
 
 	constructor(context:IViewContext, whitespaceManager:editorCommon.IWhitespaceManager) {
 		super(context);
+		this._lineHeight = this._context.configuration.editor.lineHeight;
 		this._whitespaceManager = whitespaceManager;
 		this.domNode = document.createElement('div');
 		this.domNode.className = ClassNames.VIEW_ZONES;
@@ -52,41 +54,26 @@ export class ViewZones extends ViewPart {
 	// ---- begin view event handlers
 
 	private _recomputeWhitespacesProps(): boolean {
-		let id:string;
-		let zone2Height:{[id:string]:number;} = {};
 		let hadAChange = false;
 
-		for (id in this._zones) {
-			if (this._zones.hasOwnProperty(id)) {
-				let zone = this._zones[id];
-				let props = this._computeWhitespaceProps(zone.delegate);
-				if (this._whitespaceManager.changeWhitespace(parseInt(id, 10), props.afterViewLineNumber, props.heightInPx)) {
-					this._safeCallOnComputedHeight(zone.delegate, props.heightInPx);
-					zone2Height[id] = props.heightInPx;
-					hadAChange = true;
-				}
+		let keys = Object.keys(this._zones);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let id = keys[i];
+			let zone = this._zones[id];
+			let props = this._computeWhitespaceProps(zone.delegate);
+			if (this._whitespaceManager.changeWhitespace(parseInt(id, 10), props.afterViewLineNumber, props.heightInPx)) {
+				this._safeCallOnComputedHeight(zone.delegate, props.heightInPx);
+				hadAChange = true;
 			}
 		}
 
-		if (hadAChange) {
-			this._requestModificationFrame(() => {
-				for (id in this._zones) {
-					if (this._zones.hasOwnProperty(id)) {
-						if (zone2Height.hasOwnProperty(id)) {
-							// TODO@Alex - edit dom node properties only in render()
-							StyleMutator.setHeight(this._zones[id].delegate.domNode, zone2Height[id]);
-						}
-					}
-				}
-			});
-		}
-
 		return hadAChange;
 	}
 
 	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): boolean {
 
 		if (e.lineHeight) {
+			this._lineHeight = this._context.configuration.editor.lineHeight;
 			return this._recomputeWhitespacesProps();
 		}
 
@@ -192,22 +179,17 @@ export class ViewZones extends ViewPart {
 
 		this._safeCallOnComputedHeight(myZone.delegate, props.heightInPx);
 
-		this._requestModificationFrame(() => {
-			if (!myZone.delegate.domNode.hasAttribute('monaco-view-zone')) {
-				// Do not position zone if it was removed in the meantime
-				return;
-			}
-			myZone.delegate.domNode.style.position = 'absolute';
-			StyleMutator.setHeight(myZone.delegate.domNode, props.heightInPx);
-			myZone.delegate.domNode.style.width = '100%';
-			StyleMutator.setDisplay(myZone.delegate.domNode, 'none');
-		});
+		myZone.delegate.domNode.style.position = 'absolute';
+		myZone.delegate.domNode.style.width = '100%';
+		StyleMutator.setDisplay(myZone.delegate.domNode, 'none');
 
 		this._zones[myZone.whitespaceId.toString()] = myZone;
 
 		myZone.delegate.domNode.setAttribute('monaco-view-zone', myZone.whitespaceId.toString());
 		this.domNode.appendChild(myZone.delegate.domNode);
 
+		this.setShouldRender();
+
 		return myZone.whitespaceId;
 	}
 
@@ -219,16 +201,10 @@ export class ViewZones extends ViewPart {
 
 			zone.delegate.domNode.removeAttribute('monaco-visible-view-zone');
 			zone.delegate.domNode.removeAttribute('monaco-view-zone');
+			zone.delegate.domNode.parentNode.removeChild(zone.delegate.domNode);
+
+			this.setShouldRender();
 
-			this._requestModificationFrame(() => {
-				if (zone.delegate.domNode.hasAttribute('monaco-view-zone')) {
-					// This dom node was added again as a view zone, so no need to mutate the DOM here
-					return;
-				}
-				if (zone.delegate.domNode.parentNode) {
-					zone.delegate.domNode.parentNode.removeChild(zone.delegate.domNode);
-				}
-			});
 			return true;
 		}
 		return false;
@@ -242,6 +218,10 @@ export class ViewZones extends ViewPart {
 			// let newOrdinal = this._getZoneOrdinal(zone.delegate);
 			changed = this._whitespaceManager.changeWhitespace(zone.whitespaceId, props.afterViewLineNumber, props.heightInPx) || changed;
 			// TODO@Alex: change `newOrdinal` too
+
+			if (changed) {
+				this.setShouldRender();
+			}
 		}
 		return changed;
 	}
@@ -259,9 +239,9 @@ export class ViewZones extends ViewPart {
 			return zone.heightInPx;
 		}
 		if (typeof zone.heightInLines === 'number') {
-			return this._context.configuration.editor.lineHeight * zone.heightInLines;
+			return this._lineHeight * zone.heightInLines;
 		}
-		return this._context.configuration.editor.lineHeight;
+		return this._lineHeight;
 	}
 
 	private _safeCallOnComputedHeight(zone: IViewZone, height: number): void {
@@ -284,51 +264,50 @@ export class ViewZones extends ViewPart {
 		}
 	}
 
-	_render(ctx:IRenderingContext): void {
-		var visibleWhitespaces = this._whitespaceManager.getWhitespaceViewportData();
+	public prepareRender(ctx:IRenderingContext): void {
+		// Nothing to read
+		if (!this.shouldRender()) {
+			throw new Error('I did not ask to render!');
+		}
+	}
 
-		this._requestModificationFrame(() => {
-			var visibleZones:{[id:string]:editorCommon.IViewWhitespaceViewportData;} = {},
-				i:number,
-				len:number,
-				hasVisibleZone = false;
+	public render(ctx:IRestrictedRenderingContext): void {
+		let visibleWhitespaces = this._whitespaceManager.getWhitespaceViewportData();
+		let visibleZones:{[id:string]:editorCommon.IViewWhitespaceViewportData;} = {};
 
-			for (i = 0, len = visibleWhitespaces.length; i < len; i++) {
-				visibleZones[visibleWhitespaces[i].id.toString()] = visibleWhitespaces[i];
-				hasVisibleZone = true;
-			}
+		let hasVisibleZone = false;
+		for (let i = 0, len = visibleWhitespaces.length; i < len; i++) {
+			visibleZones[visibleWhitespaces[i].id.toString()] = visibleWhitespaces[i];
+			hasVisibleZone = true;
+		}
 
-			var id:string,
-				zone:IMyViewZone;
-
-			for (id in this._zones) {
-				if (this._zones.hasOwnProperty(id)) {
-					zone = this._zones[id];
-
-					if (visibleZones.hasOwnProperty(id)) {
-						// zone is visible
-						StyleMutator.setTop(zone.delegate.domNode, (visibleZones[id].verticalOffset - ctx.bigNumbersDelta));
-						StyleMutator.setHeight(zone.delegate.domNode, visibleZones[id].height);
-						if (!zone.isVisible) {
-							StyleMutator.setDisplay(zone.delegate.domNode, 'block');
-							zone.delegate.domNode.setAttribute('monaco-visible-view-zone', 'true');
-							zone.isVisible = true;
-						}
-						this._safeCallOnDomNodeTop(zone.delegate, ctx.getScrolledTopFromAbsoluteTop(visibleZones[id].verticalOffset));
-					} else {
-						if (zone.isVisible) {
-							StyleMutator.setDisplay(zone.delegate.domNode, 'none');
-							zone.delegate.domNode.removeAttribute('monaco-visible-view-zone');
-							zone.isVisible = false;
-						}
-						this._safeCallOnDomNodeTop(zone.delegate, ctx.getScrolledTopFromAbsoluteTop(-1000000));
-					}
+		let keys = Object.keys(this._zones);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let id = keys[i];
+			let zone = this._zones[id];
+
+			if (visibleZones.hasOwnProperty(id)) {
+				// zone is visible
+				StyleMutator.setTop(zone.delegate.domNode, (visibleZones[id].verticalOffset - ctx.bigNumbersDelta));
+				StyleMutator.setHeight(zone.delegate.domNode, visibleZones[id].height);
+				if (!zone.isVisible) {
+					StyleMutator.setDisplay(zone.delegate.domNode, 'block');
+					zone.delegate.domNode.setAttribute('monaco-visible-view-zone', 'true');
+					zone.isVisible = true;
+				}
+				this._safeCallOnDomNodeTop(zone.delegate, ctx.getScrolledTopFromAbsoluteTop(visibleZones[id].verticalOffset));
+			} else {
+				if (zone.isVisible) {
+					StyleMutator.setDisplay(zone.delegate.domNode, 'none');
+					zone.delegate.domNode.removeAttribute('monaco-visible-view-zone');
+					zone.isVisible = false;
 				}
+				this._safeCallOnDomNodeTop(zone.delegate, ctx.getScrolledTopFromAbsoluteTop(-1000000));
 			}
+		}
 
-			if (hasVisibleZone) {
-				StyleMutator.setWidth(this.domNode, ctx.scrollWidth);
-			}
-		});
+		if (hasVisibleZone) {
+			StyleMutator.setWidth(this.domNode, ctx.scrollWidth);
+		}
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/widget/codeEditorWidget.ts
code:
@@ -26,6 +26,7 @@ import * as editorBrowser from 'vs/editor/browser/editorBrowser';
 import {EditorBrowserRegistry} from 'vs/editor/browser/editorBrowserExtensions';
 import {Colorizer} from 'vs/editor/browser/standalone/colorizer';
 import {View} from 'vs/editor/browser/view/viewImpl';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
 export class CodeEditorWidget extends CommonCodeEditor implements editorBrowser.ICodeEditor {
 
@@ -97,7 +98,7 @@ export class CodeEditorWidget extends CommonCodeEditor implements editorBrowser.
 		}
 		var content = model.getLineContent(lineNumber);
 		var tokens = model.getLineTokens(lineNumber, false);
-		var inflatedTokens = editorCommon.LineTokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
+		var inflatedTokens = TokensBinaryEncoding.inflateArr(tokens.getBinaryEncodedTokensMap(), tokens.getBinaryEncodedTokens());
 		var tabSize = model.getOptions().tabSize;
 		return Colorizer.colorizeLine(content, inflatedTokens, tabSize);
 	}
@@ -403,17 +404,16 @@ export class CodeEditorWidget extends CommonCodeEditor implements editorBrowser.
 
 			this._view.renderOnce(() => {
 
-				var widgetId:string;
-				for (widgetId in this.contentWidgets) {
-					if (this.contentWidgets.hasOwnProperty(widgetId)) {
-						this._view.addContentWidget(this.contentWidgets[widgetId]);
-					}
+				let keys = Object.keys(this.contentWidgets);
+				for (let i = 0, len = keys.length; i < len; i++) {
+					let widgetId = keys[i];
+					this._view.addContentWidget(this.contentWidgets[widgetId]);
 				}
 
-				for (widgetId in this.overlayWidgets) {
-					if (this.overlayWidgets.hasOwnProperty(widgetId)) {
-						this._view.addOverlayWidget(this.overlayWidgets[widgetId]);
-					}
+				keys = Object.keys(this.overlayWidgets);
+				for (let i = 0, len = keys.length; i < len; i++) {
+					let widgetId = keys[i];
+					this._view.addOverlayWidget(this.overlayWidgets[widgetId]);
 				}
 
 				this._view.render(false, true);
@@ -488,13 +488,27 @@ export enum EditCursorState {
 	EndOfLastEditOperation = 0
 }
 
+class SingleEditOperation {
+
+	range: editorCommon.IEditorRange;
+	text: string;
+	forceMoveMarkers: boolean;
+
+	constructor(source:editorCommon.ISingleEditOperation) {
+		this.range = new Range(source.range.startLineNumber, source.range.startColumn, source.range.endLineNumber, source.range.endColumn);
+		this.text = source.text;
+		this.forceMoveMarkers = source.forceMoveMarkers || false;
+	}
+
+}
+
 export class CommandRunner implements editorCommon.ICommand {
 
-	private _ops: editorCommon.ISingleEditOperation[];
+	private _ops: SingleEditOperation[];
 	private _editCursorState: EditCursorState;
 
 	constructor(ops: editorCommon.ISingleEditOperation[], editCursorState: EditCursorState) {
-		this._ops = ops;
+		this._ops = ops.map(op => new SingleEditOperation(op));
 		this._editCursorState = editCursorState;
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/widget/diffEditorWidget.ts
code:
@@ -20,7 +20,7 @@ import {Range} from 'vs/editor/common/core/range';
 import * as editorCommon from 'vs/editor/common/editorCommon';
 import {IEditorWorkerService} from 'vs/editor/common/services/editorWorkerService';
 import {ILineParts, createLineParts} from 'vs/editor/common/viewLayout/viewLineParts';
-import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import {renderLine, RenderLineInput} from 'vs/editor/common/viewLayout/viewLineRenderer';
 import * as editorBrowser from 'vs/editor/browser/editorBrowser';
 import {CodeEditorWidget} from 'vs/editor/browser/widget/codeEditorWidget';
 
@@ -31,7 +31,7 @@ interface IEditorScrollEvent {
 
 interface IEditorDiffDecorations {
 	decorations:editorCommon.IModelDeltaDecoration[];
-	overviewZones:editorBrowser.IOverviewRulerZone[];
+	overviewZones:editorBrowser.OverviewRulerZone[];
 }
 
 interface IEditorDiffDecorationsWithZones extends IEditorDiffDecorations {
@@ -1440,13 +1440,14 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 					result.decorations.push(createDecoration(lineChange.originalStartLineNumber, 1, lineChange.originalEndLineNumber, Number.MAX_VALUE, 'char-delete', true));
 				}
 
-				result.overviewZones.push({
-					startLineNumber: lineChange.originalStartLineNumber,
-					endLineNumber: lineChange.originalEndLineNumber,
-					color: 'rgba(255, 0, 0, 0.4)',
-					darkColor: 'rgba(255, 0, 0, 0.4)',
-					position: editorCommon.OverviewRulerLane.Full
-				});
+				result.overviewZones.push(new editorBrowser.OverviewRulerZone(
+					lineChange.originalStartLineNumber,
+					lineChange.originalEndLineNumber,
+					editorCommon.OverviewRulerLane.Full,
+					0,
+					'rgba(255, 0, 0, 0.4)',
+					'rgba(255, 0, 0, 0.4)'
+				));
 
 				if (lineChange.charChanges) {
 					for (j = 0, lengthJ = lineChange.charChanges.length; j < lengthJ; j++) {
@@ -1504,13 +1505,14 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 				if (!isChangeOrDelete(lineChange) || !lineChange.charChanges) {
 					result.decorations.push(createDecoration(lineChange.modifiedStartLineNumber, 1, lineChange.modifiedEndLineNumber, Number.MAX_VALUE, 'char-insert', true));
 				}
-				result.overviewZones.push({
-					startLineNumber: lineChange.modifiedStartLineNumber,
-					endLineNumber: lineChange.modifiedEndLineNumber,
-					color: 'rgba(155, 185, 85, 0.4)',
-					darkColor: 'rgba(155, 185, 85, 0.4)',
-					position: editorCommon.OverviewRulerLane.Full
-				});
+				result.overviewZones.push(new editorBrowser.OverviewRulerZone(
+					lineChange.modifiedStartLineNumber,
+					lineChange.modifiedEndLineNumber,
+					editorCommon.OverviewRulerLane.Full,
+					0,
+					'rgba(155, 185, 85, 0.4)',
+					'rgba(155, 185, 85, 0.4)'
+				));
 
 				if (lineChange.charChanges) {
 					for (j = 0, lengthJ = lineChange.charChanges.length; j < lengthJ; j++) {
@@ -1618,13 +1620,14 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 
 			// Add overview zones in the overview ruler
 			if (isChangeOrDelete(lineChange)) {
-				result.overviewZones.push({
-					startLineNumber: lineChange.originalStartLineNumber,
-					endLineNumber: lineChange.originalEndLineNumber,
-					color: 'rgba(255, 0, 0, 0.4)',
-					darkColor: 'rgba(255, 0, 0, 0.4)',
-					position: editorCommon.OverviewRulerLane.Full
-				});
+				result.overviewZones.push(new editorBrowser.OverviewRulerZone(
+					lineChange.originalStartLineNumber,
+					lineChange.originalEndLineNumber,
+					editorCommon.OverviewRulerLane.Full,
+					0,
+					'rgba(255, 0, 0, 0.4)',
+					'rgba(255, 0, 0, 0.4)'
+				));
 			}
 		}
 
@@ -1655,13 +1658,14 @@ class DiffEdtorWidgetInline extends DiffEditorWidgetStyle implements IDiffEditor
 			if (isChangeOrInsert(lineChange)) {
 				result.decorations.push(createDecoration(lineChange.modifiedStartLineNumber, 1, lineChange.modifiedEndLineNumber, Number.MAX_VALUE, 'line-insert', true));
 
-				result.overviewZones.push({
-					startLineNumber: lineChange.modifiedStartLineNumber,
-					endLineNumber: lineChange.modifiedEndLineNumber,
-					color: 'rgba(155, 185, 85, 0.4)',
-					darkColor: 'rgba(155, 185, 85, 0.4)',
-					position: editorCommon.OverviewRulerLane.Full
-				});
+				result.overviewZones.push(new editorBrowser.OverviewRulerZone(
+					lineChange.modifiedStartLineNumber,
+					lineChange.modifiedEndLineNumber,
+					editorCommon.OverviewRulerLane.Full,
+					0,
+					'rgba(155, 185, 85, 0.4)',
+					'rgba(155, 185, 85, 0.4)'
+				));
 
 				if (lineChange.charChanges) {
 					for (j = 0, lengthJ = lineChange.charChanges.length; j < lengthJ; j++) {
@@ -1766,7 +1770,7 @@ class InlineViewZonesComputer extends ViewZonesComputer {
 
 		lineTokens = {
 			getTokens: () => {
-				return [{ startIndex: 0, type: '' }];
+				return [new editorCommon.LineToken(0, '')];
 			},
 			getFauxIndentLength: () => {
 				return 0;
@@ -1782,15 +1786,16 @@ class InlineViewZonesComputer extends ViewZonesComputer {
 			}
 		};
 
-		parts = createLineParts(lineNumber, 1, lineContent, lineTokens, decorations, config.renderWhitespace);
+		parts = createLineParts(lineNumber, 1, lineContent, tabSize, lineTokens, decorations, config.renderWhitespace);
 
-		var r = renderLine({
-			lineContent: lineContent,
-			tabSize: tabSize,
-			stopRenderingLineAfter: config.stopRenderingLineAfter,
-			renderWhitespace: config.renderWhitespace,
-			parts: parts.getParts()
-		});
+		var r = renderLine(new RenderLineInput(
+			lineContent,
+			tabSize,
+			config.spaceWidth,
+			config.stopRenderingLineAfter,
+			config.renderWhitespace,
+			parts.getParts()
+		));
 
 		var myResult:string[] = [];
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/browser/widget/media/editor.css
code:
@@ -13,6 +13,9 @@
 	-webkit-text-size-adjust: 100%;
 }
 
+.monaco-editor .token.whitespace { display:inline-block; }
+/*.monaco-editor .token.leading.whitespace { border-left:1px solid lightgrey; }*/
+
 .monaco-editor.enable-ligatures {
 	-webkit-font-feature-settings: "liga" on, "calt" on;
 	font-feature-settings: "liga" on, "calt" on;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/commonCodeEditor.ts
code:
@@ -147,12 +147,12 @@ export abstract class CommonCodeEditor extends EventEmitter implements IActionPr
 		this._codeEditorService.removeCodeEditor(this);
 		this._lifetimeDispose = dispose(this._lifetimeDispose);
 
-		var contributionId:string;
-		for (contributionId in this.contributions) {
-			if (this.contributions.hasOwnProperty(contributionId)) {
-				this.contributions[contributionId].dispose();
-			}
+		let keys = Object.keys(this.contributions);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let contributionId = keys[i];
+			this.contributions[contributionId].dispose();
 		}
+
 		this.contributions = {};
 
 		this._postDetachModelCleanup(this._detachModel());
@@ -524,17 +524,18 @@ export abstract class CommonCodeEditor extends EventEmitter implements IActionPr
 	}
 
 	public getActions(): IAction[] {
-		var result: IAction[] = [];
-		var id: string;
-		for (id in this.contributions) {
-			if (this.contributions.hasOwnProperty(id)) {
-				var contribution = <any>this.contributions[id];
-				// contribution instanceof IAction
-				if (isAction(contribution)) {
-					result.push(<IAction>contribution);
-				}
+		let result: IAction[] = [];
+
+		let keys = Object.keys(this.contributions);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let id = keys[i];
+			let contribution = <any>this.contributions[id];
+			// contribution instanceof IAction
+			if (isAction(contribution)) {
+				result.push(<IAction>contribution);
 			}
 		}
+
 		return result;
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/config/commonEditorConfig.ts
code:
@@ -62,105 +62,162 @@ export class ConfigurationWithDefaults {
 	}
 }
 
-function cloneInternalEditorOptions(opts: editorCommon.IInternalEditorOptions): editorCommon.IInternalEditorOptions {
-	return {
-		experimentalScreenReader: opts.experimentalScreenReader,
-		rulers: opts.rulers.slice(0),
-		wordSeparators: opts.wordSeparators,
-		selectionClipboard: opts.selectionClipboard,
-		ariaLabel: opts.ariaLabel,
-		lineNumbers: opts.lineNumbers,
-		selectOnLineNumbers: opts.selectOnLineNumbers,
-		glyphMargin: opts.glyphMargin,
-		revealHorizontalRightPadding: opts.revealHorizontalRightPadding,
-		roundedSelection: opts.roundedSelection,
-		theme: opts.theme,
-		readOnly: opts.readOnly,
-		scrollbar: {
-			arrowSize: opts.scrollbar.arrowSize,
-			vertical: opts.scrollbar.vertical,
-			horizontal: opts.scrollbar.horizontal,
-			useShadows: opts.scrollbar.useShadows,
-			verticalHasArrows: opts.scrollbar.verticalHasArrows,
-			horizontalHasArrows: opts.scrollbar.horizontalHasArrows,
-			handleMouseWheel: opts.scrollbar.handleMouseWheel,
-			horizontalScrollbarSize: opts.scrollbar.horizontalScrollbarSize,
-			horizontalSliderSize: opts.scrollbar.horizontalSliderSize,
-			verticalScrollbarSize: opts.scrollbar.verticalScrollbarSize,
-			verticalSliderSize: opts.scrollbar.verticalSliderSize,
-			mouseWheelScrollSensitivity: opts.scrollbar.mouseWheelScrollSensitivity,
-		},
-		overviewRulerLanes: opts.overviewRulerLanes,
-		cursorBlinking: opts.cursorBlinking,
-		cursorStyle: opts.cursorStyle,
-		fontLigatures: opts.fontLigatures,
-		hideCursorInOverviewRuler: opts.hideCursorInOverviewRuler,
-		scrollBeyondLastLine: opts.scrollBeyondLastLine,
-		wrappingIndent: opts.wrappingIndent,
-		wordWrapBreakBeforeCharacters: opts.wordWrapBreakBeforeCharacters,
-		wordWrapBreakAfterCharacters: opts.wordWrapBreakAfterCharacters,
-		wordWrapBreakObtrusiveCharacters: opts.wordWrapBreakObtrusiveCharacters,
-		tabFocusMode: opts.tabFocusMode,
-		stopLineTokenizationAfter: opts.stopLineTokenizationAfter,
-		stopRenderingLineAfter: opts.stopRenderingLineAfter,
-		longLineBoundary: opts.longLineBoundary,
-		forcedTokenizationBoundary: opts.forcedTokenizationBoundary,
-		hover: opts.hover,
-		contextmenu: opts.contextmenu,
-		quickSuggestions: opts.quickSuggestions,
-		quickSuggestionsDelay: opts.quickSuggestionsDelay,
-		iconsInSuggestions: opts.iconsInSuggestions,
-		autoClosingBrackets: opts.autoClosingBrackets,
-		formatOnType: opts.formatOnType,
-		suggestOnTriggerCharacters: opts.suggestOnTriggerCharacters,
-		acceptSuggestionOnEnter: opts.acceptSuggestionOnEnter,
-		selectionHighlight: opts.selectionHighlight,
-		outlineMarkers: opts.outlineMarkers,
-		referenceInfos: opts.referenceInfos,
-		folding: opts.folding,
-		renderWhitespace: opts.renderWhitespace,
-		layoutInfo: {
-			width: opts.layoutInfo.width,
-			height: opts.layoutInfo.height,
-			glyphMarginLeft: opts.layoutInfo.glyphMarginLeft,
-			glyphMarginWidth: opts.layoutInfo.glyphMarginWidth,
-			glyphMarginHeight: opts.layoutInfo.glyphMarginHeight,
-			lineNumbersLeft: opts.layoutInfo.lineNumbersLeft,
-			lineNumbersWidth: opts.layoutInfo.lineNumbersWidth,
-			lineNumbersHeight: opts.layoutInfo.lineNumbersHeight,
-			decorationsLeft: opts.layoutInfo.decorationsLeft,
-			decorationsWidth: opts.layoutInfo.decorationsWidth,
-			decorationsHeight: opts.layoutInfo.decorationsHeight,
-			contentLeft: opts.layoutInfo.contentLeft,
-			contentWidth: opts.layoutInfo.contentWidth,
-			contentHeight: opts.layoutInfo.contentHeight,
-			verticalScrollbarWidth: opts.layoutInfo.verticalScrollbarWidth,
-			horizontalScrollbarHeight: opts.layoutInfo.horizontalScrollbarHeight,
+export class InternalEditorOptions implements editorCommon.IInternalEditorOptions {
+	public _internalEditorOptionsTrait: void;
+
+	experimentalScreenReader: boolean;
+	rulers: number[];
+	wordSeparators: string;
+	selectionClipboard: boolean;
+	ariaLabel: string;
+	lineNumbers:any;
+	selectOnLineNumbers:boolean;
+	glyphMargin:boolean;
+	revealHorizontalRightPadding:number;
+	roundedSelection:boolean;
+	theme:string;
+	readOnly:boolean;
+	scrollbar:editorCommon.IInternalEditorScrollbarOptions;
+	overviewRulerLanes:number;
+	cursorBlinking:string;
+	cursorStyle:editorCommon.TextEditorCursorStyle;
+	fontLigatures:boolean;
+	hideCursorInOverviewRuler:boolean;
+	scrollBeyondLastLine:boolean;
+	wrappingIndent: string;
+	wordWrapBreakBeforeCharacters: string;
+	wordWrapBreakAfterCharacters: string;
+	wordWrapBreakObtrusiveCharacters: string;
+	tabFocusMode:boolean;
+	stopLineTokenizationAfter:number;
+	stopRenderingLineAfter: number;
+	longLineBoundary:number;
+	forcedTokenizationBoundary:number;
+	hover:boolean;
+	contextmenu:boolean;
+	quickSuggestions:boolean;
+	quickSuggestionsDelay:number;
+	iconsInSuggestions:boolean;
+	autoClosingBrackets:boolean;
+	formatOnType:boolean;
+	suggestOnTriggerCharacters: boolean;
+	acceptSuggestionOnEnter: boolean;
+	selectionHighlight:boolean;
+	outlineMarkers: boolean;
+	referenceInfos: boolean;
+	folding: boolean;
+	renderWhitespace: boolean;
+	layoutInfo: editorCommon.IEditorLayoutInfo;
+	stylingInfo: editorCommon.IEditorStyling;
+	wrappingInfo: editorCommon.IEditorWrappingInfo;
+	observedOuterWidth:number;
+	observedOuterHeight:number;
+	lineHeight:number;
+	pageSize:number;
+	typicalHalfwidthCharacterWidth:number;
+	typicalFullwidthCharacterWidth:number;
+	spaceWidth:number;
+	fontSize:number;
+
+	constructor(input:editorCommon.IInternalEditorOptions) {
+		this.experimentalScreenReader = Boolean(input.experimentalScreenReader);
+		this.rulers = Array.prototype.slice.call(input.rulers, 0);
+		this.wordSeparators = String(input.wordSeparators);
+		this.selectionClipboard = Boolean(input.selectionClipboard);
+		this.ariaLabel = String(input.ariaLabel);
+		this.lineNumbers = input.lineNumbers || false;
+		this.selectOnLineNumbers = Boolean(input.selectOnLineNumbers);
+		this.glyphMargin = Boolean(input.glyphMargin);
+		this.revealHorizontalRightPadding = Number(input.revealHorizontalRightPadding)|0;
+		this.roundedSelection = Boolean(input.roundedSelection);
+		this.theme = String(input.theme);
+		this.readOnly = Boolean(input.readOnly);
+		this.scrollbar = {
+			arrowSize: Number(input.scrollbar.arrowSize)|0,
+			vertical: String(input.scrollbar.vertical),
+			horizontal: String(input.scrollbar.horizontal),
+			useShadows: Boolean(input.scrollbar.useShadows),
+			verticalHasArrows: Boolean(input.scrollbar.verticalHasArrows),
+			horizontalHasArrows: Boolean(input.scrollbar.horizontalHasArrows),
+			handleMouseWheel: Boolean(input.scrollbar.handleMouseWheel),
+			horizontalScrollbarSize: Number(input.scrollbar.horizontalScrollbarSize)|0,
+			horizontalSliderSize: Number(input.scrollbar.horizontalSliderSize)|0,
+			verticalScrollbarSize: Number(input.scrollbar.verticalScrollbarSize)|0,
+			verticalSliderSize: Number(input.scrollbar.verticalSliderSize)|0,
+			mouseWheelScrollSensitivity: Number(input.scrollbar.mouseWheelScrollSensitivity)|0,
+		};
+		this.overviewRulerLanes = Number(input.overviewRulerLanes)|0;
+		this.cursorBlinking = String(input.cursorBlinking);
+		this.cursorStyle = Number(input.cursorStyle)|0;
+		this.fontLigatures = Boolean(input.fontLigatures);
+		this.hideCursorInOverviewRuler = Boolean(input.hideCursorInOverviewRuler);
+		this.scrollBeyondLastLine = Boolean(input.scrollBeyondLastLine);
+		this.wrappingIndent = String(input.wrappingIndent);
+		this.wordWrapBreakBeforeCharacters = String(input.wordWrapBreakBeforeCharacters);
+		this.wordWrapBreakAfterCharacters = String(input.wordWrapBreakAfterCharacters);
+		this.wordWrapBreakObtrusiveCharacters = String(input.wordWrapBreakObtrusiveCharacters);
+		this.tabFocusMode = Boolean(input.tabFocusMode);
+		this.stopLineTokenizationAfter = Number(input.stopLineTokenizationAfter)|0;
+		this.stopRenderingLineAfter = Number(input.stopRenderingLineAfter)|0;
+		this.longLineBoundary = Number(input.longLineBoundary)|0;
+		this.forcedTokenizationBoundary = Number(input.forcedTokenizationBoundary)|0;
+		this.hover = Boolean(input.hover);
+		this.contextmenu = Boolean(input.contextmenu);
+		this.quickSuggestions = Boolean(input.quickSuggestions);
+		this.quickSuggestionsDelay = Number(input.quickSuggestionsDelay)|0;
+		this.iconsInSuggestions = Boolean(input.iconsInSuggestions);
+		this.autoClosingBrackets = Boolean(input.autoClosingBrackets);
+		this.formatOnType = Boolean(input.formatOnType);
+		this.suggestOnTriggerCharacters = Boolean(input.suggestOnTriggerCharacters);
+		this.acceptSuggestionOnEnter = Boolean(input.acceptSuggestionOnEnter);
+		this.selectionHighlight = Boolean(input.selectionHighlight);
+		this.outlineMarkers = Boolean(input.outlineMarkers);
+		this.referenceInfos = Boolean(input.referenceInfos);
+		this.folding = Boolean(input.folding);
+		this.renderWhitespace = Boolean(input.renderWhitespace);
+		this.layoutInfo = {
+			width: Number(input.layoutInfo.width)|0,
+			height: Number(input.layoutInfo.height)|0,
+			glyphMarginLeft: Number(input.layoutInfo.glyphMarginLeft)|0,
+			glyphMarginWidth: Number(input.layoutInfo.glyphMarginWidth)|0,
+			glyphMarginHeight: Number(input.layoutInfo.glyphMarginHeight)|0,
+			lineNumbersLeft: Number(input.layoutInfo.lineNumbersLeft)|0,
+			lineNumbersWidth: Number(input.layoutInfo.lineNumbersWidth)|0,
+			lineNumbersHeight: Number(input.layoutInfo.lineNumbersHeight)|0,
+			decorationsLeft: Number(input.layoutInfo.decorationsLeft)|0,
+			decorationsWidth: Number(input.layoutInfo.decorationsWidth)|0,
+			decorationsHeight: Number(input.layoutInfo.decorationsHeight)|0,
+			contentLeft: Number(input.layoutInfo.contentLeft)|0,
+			contentWidth: Number(input.layoutInfo.contentWidth)|0,
+			contentHeight: Number(input.layoutInfo.contentHeight)|0,
+			verticalScrollbarWidth: Number(input.layoutInfo.verticalScrollbarWidth)|0,
+			horizontalScrollbarHeight: Number(input.layoutInfo.horizontalScrollbarHeight)|0,
 			overviewRuler:{
-				width: opts.layoutInfo.overviewRuler.width,
-				height: opts.layoutInfo.overviewRuler.height,
-				top: opts.layoutInfo.overviewRuler.top,
-				right: opts.layoutInfo.overviewRuler.right,
+				width: Number(input.layoutInfo.overviewRuler.width)|0,
+				height: Number(input.layoutInfo.overviewRuler.height)|0,
+				top: Number(input.layoutInfo.overviewRuler.top)|0,
+				right: Number(input.layoutInfo.overviewRuler.right)|0,
 			}
-		},
-		stylingInfo: {
-			editorClassName: opts.stylingInfo.editorClassName,
-			fontFamily: opts.stylingInfo.fontFamily,
-			fontSize: opts.stylingInfo.fontSize,
-			lineHeight: opts.stylingInfo.lineHeight,
-		},
-		wrappingInfo: {
-			isViewportWrapping: opts.wrappingInfo.isViewportWrapping,
-			wrappingColumn: opts.wrappingInfo.wrappingColumn,
-		},
-		observedOuterWidth: opts.observedOuterWidth,
-		observedOuterHeight: opts.observedOuterHeight,
-		lineHeight: opts.lineHeight,
-		pageSize: opts.pageSize,
-		typicalHalfwidthCharacterWidth: opts.typicalHalfwidthCharacterWidth,
-		typicalFullwidthCharacterWidth: opts.typicalFullwidthCharacterWidth,
-		fontSize: opts.fontSize,
-	};
+		};
+		this.stylingInfo = {
+			editorClassName: String(input.stylingInfo.editorClassName),
+			fontFamily: String(input.stylingInfo.fontFamily),
+			fontSize: Number(input.stylingInfo.fontSize)|0,
+			lineHeight: Number(input.stylingInfo.lineHeight)|0,
+		};
+		this.wrappingInfo = {
+			isViewportWrapping: Boolean(input.wrappingInfo.isViewportWrapping),
+			wrappingColumn: Number(input.wrappingInfo.wrappingColumn)|0,
+		};
+		this.observedOuterWidth = Number(input.observedOuterWidth)|0;
+		this.observedOuterHeight = Number(input.observedOuterHeight)|0;
+		this.lineHeight = Number(input.lineHeight)|0;
+		this.pageSize = Number(input.pageSize)|0;
+		this.typicalHalfwidthCharacterWidth = Number(input.typicalHalfwidthCharacterWidth);
+		this.typicalFullwidthCharacterWidth = Number(input.typicalFullwidthCharacterWidth);
+		this.spaceWidth = Number(input.spaceWidth);
+		this.fontSize = Number(input.fontSize)|0;
+	}
 }
 
 class InternalEditorOptionsHelper {
@@ -327,6 +384,7 @@ class InternalEditorOptionsHelper {
 
 			typicalHalfwidthCharacterWidth: themeOpts.typicalHalfwidthCharacterWidth,
 			typicalFullwidthCharacterWidth: themeOpts.typicalFullwidthCharacterWidth,
+			spaceWidth: themeOpts.spaceWidth,
 
 			fontSize: themeOpts.fontSize,
 		};
@@ -411,6 +469,7 @@ class InternalEditorOptionsHelper {
 			pageSize:						(prevOpts.pageSize !== newOpts.pageSize),
 			typicalHalfwidthCharacterWidth:	(prevOpts.typicalHalfwidthCharacterWidth !== newOpts.typicalHalfwidthCharacterWidth),
 			typicalFullwidthCharacterWidth:	(prevOpts.typicalFullwidthCharacterWidth !== newOpts.typicalFullwidthCharacterWidth),
+			spaceWidth:						(prevOpts.spaceWidth !== newOpts.spaceWidth),
 			fontSize:						(prevOpts.fontSize !== newOpts.fontSize)
 		};
 	}
@@ -464,6 +523,7 @@ class InternalEditorOptionsHelper {
 export interface ICSSConfig {
 	typicalHalfwidthCharacterWidth:number;
 	typicalFullwidthCharacterWidth:number;
+	spaceWidth:number;
 	maxDigitWidth: number;
 	lineHeight:number;
 	font:string;
@@ -548,8 +608,8 @@ export interface IElementSizeObserver {
 export abstract class CommonEditorConfiguration extends Disposable implements editorCommon.IConfiguration {
 
 	public handlerDispatcher:editorCommon.IHandlerDispatcher;
-	public editor:editorCommon.IInternalEditorOptions;
-	public editorClone:editorCommon.IInternalEditorOptions;
+	public editor:InternalEditorOptions;
+	public editorClone:InternalEditorOptions;
 
 	protected _configWithDefaults:ConfigurationWithDefaults;
 	protected _elementSizeObserver: IElementSizeObserver;
@@ -569,7 +629,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements ed
 		this.handlerDispatcher = new HandlerDispatcher();
 
 		this.editor = this._computeInternalOptions();
-		this.editorClone = cloneInternalEditorOptions(this.editor);
+		this.editorClone = new InternalEditorOptions(this.editor);
 	}
 
 	public dispose(): void {
@@ -579,17 +639,17 @@ export abstract class CommonEditorConfiguration extends Disposable implements ed
 	protected _recomputeOptions(): void {
 		let oldOpts = this.editor;
 		this.editor = this._computeInternalOptions();
-		this.editorClone = cloneInternalEditorOptions(this.editor);
+		this.editorClone = new InternalEditorOptions(this.editor);
 
 		let changeEvent = InternalEditorOptionsHelper.createConfigurationChangedEvent(oldOpts, this.editor);
 
 		let hasChanged = false;
-		for (let key in changeEvent) {
-			if (changeEvent.hasOwnProperty(key)) {
-				if (changeEvent[key]) {
-					hasChanged = true;
-					break;
-				}
+		let keys = Object.keys(changeEvent);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let key = keys[i];
+			if (changeEvent[key]) {
+				hasChanged = true;
+				break;
 			}
 		}
 
@@ -602,7 +662,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements ed
 		return this._configWithDefaults.getEditorOptions();
 	}
 
-	private _computeInternalOptions(): editorCommon.IInternalEditorOptions {
+	private _computeInternalOptions(): InternalEditorOptions {
 		let opts = this._configWithDefaults.getEditorOptions();
 
 		let editorClassName = this._getEditorClassName(opts.theme, toBoolean(opts.fontLigatures));
@@ -615,7 +675,7 @@ export abstract class CommonEditorConfiguration extends Disposable implements ed
 			adjustedLineHeight = Math.round(1.3 * requestedFontSize);
 		}
 
-		return InternalEditorOptionsHelper.createInternalEditorOptions(
+		let result = InternalEditorOptionsHelper.createInternalEditorOptions(
 			this.getOuterWidth(),
 			this.getOuterHeight(),
 			opts,
@@ -628,6 +688,8 @@ export abstract class CommonEditorConfiguration extends Disposable implements ed
 			this._isDominatedByLongLines,
 			this._lineCount
 		);
+
+		return new InternalEditorOptions(result);
 	}
 
 	public updateOptions(newOptions:editorCommon.IEditorOptions): void {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/controller/cursor.ts
code:
@@ -921,8 +921,8 @@ export class Cursor extends EventEmitter {
 	// ----- handlers beyond this point
 
 	private _registerHandlers(): void {
-		var H = editorCommon.Handler;
-		var handlersMap:{
+		let H = editorCommon.Handler;
+		let handlersMap:{
 			[key:string]:(ctx:IMultipleCursorOperationContext)=>boolean;
 		} = {};
 
@@ -1041,15 +1041,14 @@ export class Cursor extends EventEmitter {
 		handlersMap[H.ExecuteCommand] =				(ctx:IMultipleCursorOperationContext) => this._externalExecuteCommand(ctx);
 		handlersMap[H.ExecuteCommands] =			(ctx:IMultipleCursorOperationContext) => this._externalExecuteCommands(ctx);
 
-		var createHandler = (handlerId:string, handlerExec:(ctx:IMultipleCursorOperationContext)=>boolean) => {
+		let createHandler = (handlerId:string, handlerExec:(ctx:IMultipleCursorOperationContext)=>boolean) => {
 			return (e:editorCommon.IDispatcherEvent) => this._onHandler(handlerId, handlerExec, e);
 		};
 
-		var handler:string;
-		for (handler in handlersMap) {
-			if (handlersMap.hasOwnProperty(handler)) {
-				this.configuration.handlerDispatcher.setHandler(handler, createHandler(handler, handlersMap[handler]));
-			}
+		let keys = Object.keys(handlersMap);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let handler = keys[i];
+			this.configuration.handlerDispatcher.setHandler(handler, createHandler(handler, handlersMap[handler]));
 		}
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/core/arrays.ts
code:
@@ -19,13 +19,16 @@ export namespace Arrays {
 	 */
 	export function findIndexInSegmentsArray(arr: { startIndex: number; }[], desiredIndex: number): number {
 
-		var low = 0,
-			high = arr.length - 1,
-			mid: number;
+		let low = 0;
+		let high = arr.length - 1;
+
+		if (high <= 0) {
+			return 0;
+		}
 
 		while (low < high) {
 
-			mid = low + Math.ceil((high - low) / 2);
+			let mid = low + Math.ceil((high - low) / 2);
 
 			if (arr[mid].startIndex > desiredIndex) {
 				high = mid - 1;
@@ -37,4 +40,4 @@ export namespace Arrays {
 		return low;
 	}
 
-}
\ No newline at end of file
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/core/modeTransition.ts
code:
@@ -0,0 +1,33 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+'use strict';
+
+import {IMode, IModeTransition} from 'vs/editor/common/modes';
+import {Arrays} from 'vs/editor/common/core/arrays';
+
+export class ModeTransition {
+	_modeTransitionTrait: void;
+
+	public startIndex:number;
+	public mode:IMode;
+
+	constructor(startIndex:number, mode:IMode) {
+		this.startIndex = startIndex|0;
+		this.mode = mode;
+	}
+
+	public static findIndexInSegmentsArray(arr:ModeTransition[], desiredIndex: number): number {
+		return Arrays.findIndexInSegmentsArray(arr, desiredIndex);
+	}
+
+	public static create(modeTransitions:IModeTransition[]): ModeTransition[] {
+		let result:ModeTransition[] = [];
+		for (let i = 0, len = modeTransitions.length; i < len; i++) {
+			let modeTransition = modeTransitions[i];
+			result.push(new ModeTransition(modeTransition.startIndex, modeTransition.mode));
+		}
+		return result;
+	}
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/core/position.ts
code:
@@ -12,8 +12,8 @@ export class Position implements IEditorPosition {
 	public column: number;
 
 	constructor(lineNumber: number, column: number) {
-		this.lineNumber = lineNumber;
-		this.column = column;
+		this.lineNumber = lineNumber|0;
+		this.column = column|0;
 	}
 
 	public equals(other:IPosition): boolean {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/core/range.ts
code:
@@ -224,17 +224,26 @@ export class Range implements IEditorRange {
 	 * A function that compares ranges, useful for sorting ranges
 	 * It will first compare ranges on the startPosition and then on the endPosition
 	 */
-	public static compareRangesUsingStarts(a:IRange, b:IRange): number {
-		if (a.startLineNumber === b.startLineNumber) {
-			if (a.startColumn === b.startColumn) {
-				if (a.endLineNumber === b.endLineNumber) {
-					return a.endColumn - b.endColumn;
+	public static compareRangesUsingStarts(a:IEditorRange, b:IEditorRange): number {
+		let aStartLineNumber = a.startLineNumber|0;
+		let bStartLineNumber = b.startLineNumber|0;
+		let aStartColumn = a.startColumn|0;
+		let bStartColumn = b.startColumn|0;
+		let aEndLineNumber = a.endLineNumber|0;
+		let bEndLineNumber = b.endLineNumber|0;
+		let aEndColumn = a.endColumn|0;
+		let bEndColumn = b.endColumn|0;
+
+		if (aStartLineNumber === bStartLineNumber) {
+			if (aStartColumn === bStartColumn) {
+				if (aEndLineNumber === bEndLineNumber) {
+					return aEndColumn - bEndColumn;
 				}
-				return a.endLineNumber - b.endLineNumber;
+				return aEndLineNumber - bEndLineNumber;
 			}
-			return a.startColumn - b.startColumn;
+			return aStartColumn - bStartColumn;
 		}
-		return a.startLineNumber - b.startLineNumber;
+		return aStartLineNumber - bStartLineNumber;
 	}
 
 	/**

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/editorCommon.ts
code:
@@ -13,7 +13,6 @@ import {IDisposable} from 'vs/base/common/lifecycle';
 import URI from 'vs/base/common/uri';
 import {TPromise} from 'vs/base/common/winjs.base';
 import {IInstantiationService, IConstructorSignature1, IConstructorSignature2} from 'vs/platform/instantiation/common/instantiation';
-import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 import {ILineContext, IMode, IModeTransition, IToken} from 'vs/editor/common/modes';
 
 export type KeyCode = KeyCode;
@@ -676,6 +675,10 @@ export interface IInternalEditorOptions {
 	 * Computed width of fullwidth 'm' (U+FF4D)
 	 */
 	typicalFullwidthCharacterWidth:number;
+	/**
+	 * Computed width of non breaking space &nbsp;
+	 */
+	spaceWidth:number;
 	/**
 	 * Computed font size.
 	 */
@@ -742,6 +745,7 @@ export interface IConfigurationChangedEvent {
 	pageSize: boolean;
 	typicalHalfwidthCharacterWidth: boolean;
 	typicalFullwidthCharacterWidth: boolean;
+	spaceWidth: boolean;
 	fontSize: boolean;
 }
 
@@ -874,7 +878,7 @@ export interface IModelTrackedRange {
 	/**
 	 * Range that this tracked range covers
 	 */
-	range: IRange;
+	range: IEditorRange;
 }
 
 /**
@@ -892,7 +896,7 @@ export interface IModelDecoration {
 	/**
 	 * Range that this decoration covers.
 	 */
-	range: IRange;
+	range: IEditorRange;
 	/**
 	 * Options associated with this decoration.
 	 */
@@ -1183,9 +1187,16 @@ export interface ICursorStateComputer {
 /**
  * A token on a line.
  */
-export interface ILineToken {
-	startIndex: number;
-	type: string;
+export class LineToken {
+	public _lineTokenTrait: void;
+
+	public startIndex:number;
+	public type:string;
+
+	constructor(startIndex:number, type:string) {
+		this.startIndex = +startIndex;// @perf
+		this.type = type.replace(/[^a-z0-9\-]/gi, ' ');
+	}
 }
 
 export interface ITokensInflatorMap {
@@ -1207,7 +1218,6 @@ export interface ILineTokensBinaryEncoding {
 	findIndexOfOffset(binaryEncodedTokens:number[], offset:number): number;
 	sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): IToken[];
 }
-export var LineTokensBinaryEncoding:ILineTokensBinaryEncoding = TokensBinaryEncoding;
 
 /**
  * A list of tokens on a line.
@@ -2509,16 +2519,16 @@ export interface IConfiguration {
 // --- view
 
 export interface IViewLineTokens {
-	getTokens(): ILineToken[];
+	getTokens(): LineToken[];
 	getFauxIndentLength(): number;
 	getTextLength(): number;
 	equals(other:IViewLineTokens): boolean;
 	findIndexOfOffset(offset:number): number;
 }
 
-export interface IViewModelDecorationsResolver {
-	getDecorations(): IModelDecoration[];
-	getInlineDecorations(lineNumber: number): IModelDecoration[];
+export interface IDecorationsViewportData {
+	decorations: IModelDecoration[];
+	inlineDecorations: IModelDecoration[][];
 }
 
 export interface IViewEventBus {
@@ -2563,7 +2573,7 @@ export interface IViewModel extends IEventEmitter, IDisposable {
 	getLineFirstNonWhitespaceColumn(lineNumber:number): number;
 	getLineLastNonWhitespaceColumn(lineNumber:number): number;
 	getLineTokens(lineNumber:number): IViewLineTokens;
-	getDecorationsResolver(startLineNumber:number, endLineNumber:number): IViewModelDecorationsResolver;
+	getDecorationsViewportData(startLineNumber:number, endLineNumber:number): IDecorationsViewportData;
 	getLineRenderLineNumber(lineNumber:number): string;
 	getAllDecorations(): IModelDecoration[];
 	getEOL(): string;
@@ -2714,40 +2724,81 @@ export interface IViewWhitespaceViewportData {
 	height:number;
 }
 
-export interface IViewLinesViewportData {
+export interface IPartialViewLinesViewportData {
 	viewportTop: number;
 	viewportHeight: number;
-
 	bigNumbersDelta: number;
+	visibleRangesDeltaTop: number;
+	startLineNumber: number;
+	endLineNumber: number;
+	relativeVerticalOffset: number[];
+}
+
+export class ViewLinesViewportData {
+	_viewLinesViewportDataTrait: void;
 
-	visibleRangesDeltaTop:number;
+	viewportTop: number;
+	viewportHeight: number;
+	bigNumbersDelta: number;
+	visibleRangesDeltaTop: number;
 	/**
 	 * The line number at which to start rendering (inclusive).
 	 */
-	startLineNumber:number;
+	startLineNumber: number;
 	/**
 	 * The line number at which to end rendering (inclusive).
 	 */
-	endLineNumber:number;
+	endLineNumber: number;
 	/**
 	 * relativeVerticalOffset[i] is the gap that must be left between line at
 	 * i - 1 + `startLineNumber` and i + `startLineNumber`.
 	 */
-	relativeVerticalOffset:number[];
+	relativeVerticalOffset: number[];
 	/**
 	 * The viewport as a range (`startLineNumber`,1) -> (`endLineNumber`,maxColumn(`endLineNumber`)).
 	 */
 	visibleRange:IEditorRange;
 
-	getInlineDecorationsForLineInViewport(lineNumber:number): IModelDecoration[];
-	getDecorationsInViewport(): IModelDecoration[];
+	private _decorations: IModelDecoration[];
+	private _inlineDecorations: IModelDecoration[][];
+
+	constructor(partialData:IPartialViewLinesViewportData, visibleRange:IEditorRange, decorationsData:IDecorationsViewportData) {
+		this.viewportTop = partialData.viewportTop|0;
+		this.viewportHeight = partialData.viewportHeight|0;
+		this.bigNumbersDelta = partialData.bigNumbersDelta|0;
+		this.visibleRangesDeltaTop = partialData.visibleRangesDeltaTop|0;
+		this.startLineNumber = partialData.startLineNumber|0;
+		this.endLineNumber = partialData.endLineNumber|0;
+		this.relativeVerticalOffset = partialData.relativeVerticalOffset;
+		this.visibleRange = visibleRange;
+		this._decorations = decorationsData.decorations;
+		this._inlineDecorations = decorationsData.inlineDecorations;
+	}
+
+	public getDecorationsInViewport(): IModelDecoration[] {
+		return this._decorations;
+	}
+
+	public getInlineDecorationsForLineInViewport(lineNumber:number): IModelDecoration[] {
+		lineNumber = lineNumber|0;
+		return this._inlineDecorations[lineNumber - this.startLineNumber];
+	}
 }
 
-export interface IViewport {
+export class Viewport {
+	_viewportTrait: void;
+
 	top: number;
 	left: number;
 	width: number;
 	height: number;
+
+	constructor(top:number, left:number, width:number, height:number) {
+		this.top = top|0;
+		this.left = left|0;
+		this.width = width|0;
+		this.height = height|0;
+	}
 }
 
 /**
@@ -3414,7 +3465,6 @@ export var Handler = {
 	DeleteAllLeft:				'deleteAllLeft',
 	DeleteAllRight:				'deleteAllRight',
 
-	Enter: 						'enter',
 	RemoveSecondaryCursors: 	'removeSecondaryCursors',
 	CancelSelection:			'cancelSelection',
 
@@ -3451,9 +3501,9 @@ export class VisibleRange {
 	public width:number;
 
 	constructor(top:number, left:number, width:number) {
-		this.top = top;
-		this.left = left;
-		this.width = width;
+		this.top = top|0;
+		this.left = left|0;
+		this.width = width|0;
 	}
 }
 
@@ -3492,8 +3542,8 @@ export class HorizontalRange {
 	public width: number;
 
 	constructor(left:number, width:number) {
-		this.left = left;
-		this.width = width;
+		this.left = left|0;
+		this.width = width|0;
 	}
 }
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/editableTextModel.ts
code:
@@ -66,18 +66,10 @@ export class EditableTextModel extends TextModelWithDecorations implements edito
 	}
 
 	public pushStackElement(): void {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.pushStackElement: Model is disposed');
-		}
-
 		this._commandManager.pushStackElement();
 	}
 
 	public pushEditOperations(beforeCursorState:editorCommon.IEditorSelection[], editOperations:editorCommon.IIdentifiedSingleEditOperation[], cursorStateComputer:editorCommon.ICursorStateComputer): editorCommon.IEditorSelection[] {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.pushEditOperations: Model is disposed');
-		}
-
 		return this.deferredEmit(() => {
 			return this._commandManager.pushEditOperation(beforeCursorState, editOperations, cursorStateComputer);
 		});
@@ -532,10 +524,6 @@ export class EditableTextModel extends TextModelWithDecorations implements edito
 	}
 
 	public undo(): editorCommon.IEditorSelection[] {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.undo: Model is disposed');
-		}
-
 		return this._withDeferredEvents(() => {
 			this._isUndoing = true;
 			let r = this._commandManager.undo();
@@ -552,10 +540,6 @@ export class EditableTextModel extends TextModelWithDecorations implements edito
 	}
 
 	public redo(): editorCommon.IEditorSelection[] {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.redo: Model is disposed');
-		}
-
 		return this._withDeferredEvents(() => {
 			this._isRedoing = true;
 			let r = this._commandManager.redo();
@@ -572,10 +556,6 @@ export class EditableTextModel extends TextModelWithDecorations implements edito
 	}
 
 	public setEditableRange(range:editorCommon.IRange): void {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.setEditableRange: Model is disposed');
-		}
-
 		this._commandManager.clear();
 		if (this._hasEditableRange) {
 			this.removeTrackedRange(this._editableRangeId);
@@ -590,18 +570,10 @@ export class EditableTextModel extends TextModelWithDecorations implements edito
 	}
 
 	public hasEditableRange(): boolean {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.hasEditableRange: Model is disposed');
-		}
-
 		return this._hasEditableRange;
 	}
 
 	public getEditableRange(): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('EditableTextModel.getEditableRange: Model is disposed');
-		}
-
 		if (this._hasEditableRange) {
 			return this.getTrackedRange(this._editableRangeId);
 		} else {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/mirrorModel.ts
code:
@@ -13,7 +13,7 @@ import {TextModel} from 'vs/editor/common/model/textModel';
 import {TextModelWithTokens} from 'vs/editor/common/model/textModelWithTokens';
 import {IMode} from 'vs/editor/common/modes';
 import {IResourceService} from 'vs/editor/common/services/resourceService';
-import {IPrefixSumIndexOfResult, PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
+import {PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
 
 export interface IMirrorModelEvents {
 	contentChanged: editorCommon.IModelContentChangedEvent[];
@@ -32,10 +32,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getModeId(): string {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getModeId: Model is disposed');
-		}
-
 		return this.getMode().getId();
 	}
 
@@ -63,10 +59,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getAssociatedResource(): URI {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getAssociatedResource: Model is disposed');
-		}
-
 		return this._associatedResource;
 	}
 
@@ -82,10 +74,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getRangeFromOffsetAndLength(offset:number, length:number):editorCommon.IRange {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getRangeFromOffsetAndLength: Model is disposed');
-		}
-
 		var startPosition = this.getPositionFromOffset(offset),
 			endPosition = this.getPositionFromOffset(offset + length);
 		return {
@@ -97,10 +85,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getOffsetAndLengthFromRange(range:editorCommon.IRange):{offset:number; length:number;} {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getOffsetAndLengthFromRange: Model is disposed');
-		}
-
 		var startOffset = this.getOffsetFromPosition({ lineNumber: range.startLineNumber, column: range.startColumn }),
 			endOffset = this.getOffsetFromPosition({ lineNumber: range.endLineNumber, column: range.endColumn });
 		return {
@@ -110,45 +94,27 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getPositionFromOffset(offset:number):editorCommon.IPosition {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getPositionFromOffset: Model is disposed');
-		}
-
 		this._ensurePrefixSum();
-		var r:IPrefixSumIndexOfResult = {
-			index: 0,
-			remainder: 0
-		};
-		this._lineStarts.getIndexOf(offset, r);
+
+		let r = this._lineStarts.getIndexOf(offset);
 		return {
 			lineNumber: r.index + 1,
 			column: this.getEOL().length + r.remainder
 		};
 	}
 
 	public getOffsetFromPosition(position:editorCommon.IPosition): number {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getOffsetFromPosition: Model is disposed');
-		}
-
 		return this.getLineStart(position.lineNumber) + position.column - 1 /* column isn't zero-index based */;
 	}
 
 	public getLineStart(lineNumber:number): number {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getLineStart: Model is disposed');
-		}
-
 		this._ensurePrefixSum();
 
 		var lineIndex = Math.min(lineNumber, this._lines.length) - 1;
 		return this._lineStarts.getAccumulatedValue(lineIndex - 1);
 	}
 
 	public getAllWordsWithRange(): editorCommon.IRangeWithText[] {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getAllWordsWithRange: Model is disposed');
-		}
 		if (this._lines.length > 10000) {
 			// This is a very heavy method, unavailable for very heavy models
 			return [];
@@ -172,10 +138,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getAllWords(): string[] {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getAllWords: Model is disposed');
-		}
-
 		var result:string[] = [];
 		this._lines.forEach((line) => {
 			this.wordenize(line.text).forEach((info) => {
@@ -186,10 +148,6 @@ export class AbstractMirrorModel extends TextModelWithTokens implements editorCo
 	}
 
 	public getAllUniqueWords(skipWordOnce?:string) : string[] {
-		if (this._isDisposed) {
-			throw new Error('AbstractMirrorModel.getAllUniqueWords: Model is disposed');
-		}
-
 		var foundSkipWord = false;
 		var uniqueWords = {};
 		return this.getAllWords().filter((word) => {
@@ -311,10 +269,6 @@ export class MirrorModel extends AbstractMirrorModel implements editorCommon.IMi
 	}
 
 	public getEmbeddedAtPosition(position:editorCommon.IPosition):editorCommon.IMirrorModel {
-		if (this._isDisposed) {
-			throw new Error('MirrorModel.getEmbeddedAtPosition: Model is disposed');
-		}
-
 		var modeAtPosition = this.getModeAtPosition(position.lineNumber, position.column);
 		if (this._embeddedModels.hasOwnProperty(modeAtPosition.getId())) {
 			return this._embeddedModels[modeAtPosition.getId()];
@@ -323,10 +277,6 @@ export class MirrorModel extends AbstractMirrorModel implements editorCommon.IMi
 	}
 
 	public getAllEmbedded():editorCommon.IMirrorModel[] {
-		if (this._isDisposed) {
-			throw new Error('MirrorModel.getAllEmbedded: Model is disposed');
-		}
-
 		return Object.keys(this._embeddedModels).map((embeddedModeId) => this._embeddedModels[embeddedModeId]);
 	}
 
@@ -437,10 +387,6 @@ export class MirrorModel extends AbstractMirrorModel implements editorCommon.IMi
 	}
 
 	public onEvents(events:IMirrorModelEvents) : boolean {
-		if (this._isDisposed) {
-			throw new Error('MirrorModel.onEvents: Model is disposed');
-		}
-
 		let changed = false;
 		for (let i = 0, len = events.contentChanged.length; i < len; i++) {
 			let contentChangedEvent = events.contentChanged[i];

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/model.ts
code:
@@ -95,21 +95,13 @@ export class Model extends EditableTextModel implements IModel {
 	}
 
 	public onBeforeAttached(): void {
-		if (this._isDisposed) {
-			throw new Error('Model.onBeforeAttached: Model is disposed');
-		}
-
 		this._attachedEditorCount++;
 
 		// Warm up tokens for the editor
 		this._warmUpTokens();
 	}
 
 	public onBeforeDetached(): void {
-		if (this._isDisposed) {
-			throw new Error('Model.onBeforeDetached: Model is disposed');
-		}
-
 		this._attachedEditorCount--;
 
 		// Intentional empty (for now)
@@ -120,10 +112,6 @@ export class Model extends EditableTextModel implements IModel {
 	}
 
 	public getAssociatedResource(): URI {
-		if (this._isDisposed) {
-			throw new Error('Model.getAssociatedResource: Model is disposed');
-		}
-
 		return this._associatedResource;
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/modelLine.ts
code:
@@ -5,8 +5,10 @@
 'use strict';
 
 import * as strings from 'vs/base/common/strings';
-import {ILineTokens, IReadOnlyLineMarker, ITokensInflatorMap, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {ILineTokens, IReadOnlyLineMarker, ITokensInflatorMap} from 'vs/editor/common/editorCommon';
 import {IMode, IModeTransition, IState, IToken} from 'vs/editor/common/modes';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 export interface ILineEdit {
 	startColumn: number;
@@ -30,10 +32,6 @@ export interface IChangedMarkers {
 	[markerId:string]: boolean;
 }
 
-export interface IModeTransitions {
-	toArray(topLevelMode: IMode): IModeTransition[];
-}
-
 export interface ITextWithMarkers {
 	text: string;
 	markers: ILineMarker[];
@@ -67,19 +65,29 @@ enum MarkerMoveSemantics {
 }
 
 export class ModelLine {
-	public lineNumber:number;
-	public text:string;
-	public isInvalid:boolean;
+	private _lineNumber:number;
+	public get lineNumber():number { return this._lineNumber; }
+
+	private _text:string;
+	public get text():string { return this._text; }
+
+	private _isInvalid:boolean;
+	public get isInvalid():boolean { return this._isInvalid; }
+	public set isInvalid(value:boolean) { this._isInvalid = value; }
 
 	private _state:IState;
-	private _modeTransitions:IModeTransitions;
+	private _modeTransitions:ModeTransition[];
 	private _lineTokens:ILineTokens;
 	private _markers:ILineMarker[];
 
 	constructor(lineNumber:number, text:string) {
-		this.lineNumber = lineNumber;
-		this.text = text;
-		this.isInvalid = false;
+		this._lineNumber = lineNumber|0;
+		this._text = text;
+		this._isInvalid = false;
+		this._state = null;
+		this._modeTransitions = null;
+		this._lineTokens = null;
+		this._markers = null;
 	}
 
 	// --- BEGIN STATE
@@ -99,45 +107,37 @@ export class ModelLine {
 	private _setModeTransitions(topLevelMode:IMode, modeTransitions:IModeTransition[]): void {
 		let desired = toModeTransitions(topLevelMode, modeTransitions);
 
-		if (desired === null) {
-			// saving memory
-			if (typeof this._modeTransitions === 'undefined') {
-				return;
-			}
-			this._modeTransitions = null;
-			return;
-		}
 
 		this._modeTransitions = desired;
 	}
 
-	public getModeTransitions(): IModeTransitions {
+	public getModeTransitions(topLevelMode:IMode): ModeTransition[] {
 		if (this._modeTransitions) {
 			return this._modeTransitions;
+		} else {
+			return [new ModeTransition(0, topLevelMode)];
 		}
-		return DefaultModeTransitions.INSTANCE;
 	}
 
 	// --- END MODE TRANSITIONS
 
 	// --- BEGIN TOKENS
 
 	public setTokens(map: ITokensInflatorMap, tokens: IToken[], topLevelMode:IMode, modeTransitions:IModeTransition[]): void {
-		this._setLineTokens(map, tokens);
+		this._setLineTokensFromInflated(map, tokens);
 		this._setModeTransitions(topLevelMode, modeTransitions);
 	}
 
-	private _setLineTokens(map:ITokensInflatorMap, tokens:IToken[]|number[]): void {
-		let desired = toLineTokens(map, tokens, this.text.length);
+	private _setLineTokensFromInflated(map:ITokensInflatorMap, tokens:IToken[]): void {
+		let desired = toLineTokensFromInflated(map, tokens, this._text.length);
+
+
+		this._lineTokens = desired;
+	}
+
+	private _setLineTokensFromDeflated(map:ITokensInflatorMap, tokens:number[]): void {
+		let desired = toLineTokensFromDeflated(map, tokens, this._text.length);
 
-		if (desired === null) {
-			// saving memory
-			if (typeof this._lineTokens === 'undefined') {
-				return;
-			}
-			this._lineTokens = null;
-			return;
-		}
 
 		this._lineTokens = desired;
 	}
@@ -146,7 +146,7 @@ export class ModelLine {
 		if (this._lineTokens) {
 			return this._lineTokens;
 		}
-		if (this.text.length === 0) {
+		if (this._text.length === 0) {
 			return EmptyLineTokens.INSTANCE;
 		}
 		return DefaultLineTokens.INSTANCE;
@@ -162,7 +162,7 @@ export class ModelLine {
 
 		var lineTokens = this._lineTokens;
 
-		let BIN = LineTokensBinaryEncoding;
+		let BIN = TokensBinaryEncoding;
 		let tokens = lineTokens.getBinaryEncodedTokens();
 		let tokensLength = tokens.length;
 		let tokensIndex = 0;
@@ -219,13 +219,13 @@ export class ModelLine {
 	}
 
 	private _setText(text:string): void {
-		this.text = text;
+		this._text = text;
 
 		if (this._lineTokens) {
-			let BIN = LineTokensBinaryEncoding,
+			let BIN = TokensBinaryEncoding,
 				map = this._lineTokens.getBinaryEncodedTokensMap(),
 				tokens = this._lineTokens.getBinaryEncodedTokens(),
-				lineTextLength = this.text.length;
+				lineTextLength = this._text.length;
 
 			// Remove overflowing tokens
 			while (tokens.length > 0) {
@@ -238,7 +238,7 @@ export class ModelLine {
 				tokens.pop();
 			}
 
-			this._setLineTokens(map, tokens);
+			this._setLineTokensFromDeflated(map, tokens);
 		}
 	}
 
@@ -304,7 +304,7 @@ export class ModelLine {
 					let newColumn = Math.max(minimumAllowedColumn, marker.column + delta);
 					if (marker.column !== newColumn) {
 						changedMarkers[marker.id] = true;
-						marker.oldLineNumber = marker.oldLineNumber || this.lineNumber;
+						marker.oldLineNumber = marker.oldLineNumber || this._lineNumber;
 						marker.oldColumn = marker.oldColumn || marker.column;
 						marker.column = newColumn;
 					}
@@ -327,7 +327,7 @@ export class ModelLine {
 			while (markersIndex < markersLength && adjustMarkerBeforeColumn(toColumn, moveSemantics)) {
 				if (marker.column !== newColumn) {
 					changedMarkers[marker.id] = true;
-					marker.oldLineNumber = marker.oldLineNumber || this.lineNumber;
+					marker.oldLineNumber = marker.oldLineNumber || this._lineNumber;
 					marker.oldColumn = marker.oldColumn || marker.column;
 					marker.column = newColumn;
 				}
@@ -356,7 +356,7 @@ export class ModelLine {
 
 	public applyEdits(changedMarkers: IChangedMarkers, edits:ILineEdit[]): number {
 		let deltaColumn = 0;
-		let resultText = this.text;
+		let resultText = this._text;
 
 		let tokensAdjuster = this._createTokensAdjuster();
 		let markersAdjuster = this._createMarkersAdjuster(changedMarkers);
@@ -412,8 +412,8 @@ export class ModelLine {
 
 	public split(changedMarkers: IChangedMarkers, splitColumn:number, forceMoveMarkers:boolean): ModelLine {
 		// console.log('--> split @ ' + splitColumn + '::: ' + this._printMarkers());
-		var myText = this.text.substring(0, splitColumn - 1);
-		var otherText = this.text.substring(splitColumn - 1);
+		var myText = this._text.substring(0, splitColumn - 1);
+		var otherText = this._text.substring(splitColumn - 1);
 
 		var otherMarkers: ILineMarker[] = null;
 
@@ -444,7 +444,7 @@ export class ModelLine {
 					let marker = otherMarkers[i];
 
 					changedMarkers[marker.id] = true;
-					marker.oldLineNumber = marker.oldLineNumber || this.lineNumber;
+					marker.oldLineNumber = marker.oldLineNumber || this._lineNumber;
 					marker.oldColumn = marker.oldColumn || marker.column;
 					marker.column -= splitColumn - 1;
 				}
@@ -453,7 +453,7 @@ export class ModelLine {
 
 		this._setText(myText);
 
-		var otherLine = new ModelLine(this.lineNumber + 1, otherText);
+		var otherLine = new ModelLine(this._lineNumber + 1, otherText);
 		if (otherMarkers) {
 			otherLine.addMarkers(otherMarkers);
 		}
@@ -463,8 +463,8 @@ export class ModelLine {
 	public append(changedMarkers: IChangedMarkers, other:ModelLine): void {
 		// console.log('--> append: THIS :: ' + this._printMarkers());
 		// console.log('--> append: OTHER :: ' + this._printMarkers());
-		var thisTextLength = this.text.length;
-		this._setText(this.text + other.text);
+		var thisTextLength = this._text.length;
+		this._setText(this._text + other._text);
 
 		let otherLineTokens = other._lineTokens;
 		if (otherLineTokens) {
@@ -473,7 +473,7 @@ export class ModelLine {
 
 			// Adjust other tokens
 			if (thisTextLength > 0) {
-				let BIN = LineTokensBinaryEncoding;
+				let BIN = TokensBinaryEncoding;
 
 				for (let i = 0, len = otherTokens.length; i < len; i++) {
 					let token = otherTokens[i];
@@ -491,10 +491,10 @@ export class ModelLine {
 			let myLineTokens = this._lineTokens;
 			if (myLineTokens) {
 				// I have real tokens
-				this._setLineTokens(myLineTokens.getBinaryEncodedTokensMap(), myLineTokens.getBinaryEncodedTokens().concat(otherTokens));
+				this._setLineTokensFromDeflated(myLineTokens.getBinaryEncodedTokensMap(), myLineTokens.getBinaryEncodedTokens().concat(otherTokens));
 			} else {
 				// I don't have real tokens
-				this._setLineTokens(otherLineTokens.getBinaryEncodedTokensMap(), otherTokens);
+				this._setLineTokensFromDeflated(otherLineTokens.getBinaryEncodedTokensMap(), otherTokens);
 			}
 		}
 
@@ -593,11 +593,11 @@ export class ModelLine {
 				marker = markers[i];
 
 				changedMarkers[marker.id] = true;
-				marker.oldLineNumber = marker.oldLineNumber || this.lineNumber;
+				marker.oldLineNumber = marker.oldLineNumber || this._lineNumber;
 			}
 		}
 
-		this.lineNumber = newLineNumber;
+		this._lineNumber = newLineNumber;
 	}
 
 	public deleteLine(changedMarkers: IChangedMarkers, setMarkersColumn:number, setMarkersOldLineNumber:number): ILineMarker[] {
@@ -641,51 +641,54 @@ export class ModelLine {
 	}
 }
 
-function areDeflatedTokens(tokens:IToken[]|number[]): tokens is number[] {
-	return (typeof tokens[0] === 'number');
+function toLineTokensFromInflated(map:ITokensInflatorMap, tokens:IToken[], textLength:number): ILineTokens {
+	if (textLength === 0) {
+		return null;
+	}
+	if (!tokens || tokens.length === 0) {
+		return null;
+	}
+	if (tokens.length === 1) {
+		if (tokens[0].startIndex === 0 && tokens[0].type === '') {
+			return null;
+		}
+	}
+
+	let deflated = TokensBinaryEncoding.deflateArr(map, tokens);
+	return new LineTokens(map, deflated);
 }
 
-function toLineTokens(map:ITokensInflatorMap, tokens:IToken[]|number[], textLength:number): ILineTokens {
+function toLineTokensFromDeflated(map:ITokensInflatorMap, tokens:number[], textLength:number): ILineTokens {
 	if (textLength === 0) {
 		return null;
 	}
 	if (!tokens || tokens.length === 0) {
 		return null;
 	}
 	if (tokens.length === 1) {
-		if (areDeflatedTokens(tokens)) {
-			if (tokens[0] === 0) {
-				return null;
-			}
-		} else {
-			if (tokens[0].startIndex === 0 && tokens[0].type === '') {
-				return null;
-			}
+		if (tokens[0] === 0) {
+			return null;
 		}
 	}
 	return new LineTokens(map, tokens);
 }
 
-var getStartIndex = LineTokensBinaryEncoding.getStartIndex;
-var getType = LineTokensBinaryEncoding.getType;
-var findIndexOfOffset = LineTokensBinaryEncoding.findIndexOfOffset;
+var getStartIndex = TokensBinaryEncoding.getStartIndex;
+var getType = TokensBinaryEncoding.getType;
+var findIndexOfOffset = TokensBinaryEncoding.findIndexOfOffset;
 
 export class LineTokens implements ILineTokens {
 
 	private map:ITokensInflatorMap;
 	private _tokens:number[];
 
-	constructor(map:ITokensInflatorMap, tokens:IToken[]|number[]) {
+	constructor(map:ITokensInflatorMap, tokens:/*IToken[]|*/number[]) {
 		this.map = map;
-		if (areDeflatedTokens(tokens)) {
-			this._tokens = tokens;
-		} else {
-			this._tokens = LineTokensBinaryEncoding.deflateArr(map, tokens);
-		}
+		this._tokens = tokens;
 	}
 
 	public toString(): string {
-		return LineTokensBinaryEncoding.inflateArr(this.map, this._tokens).toString();
+		return TokensBinaryEncoding.inflateArr(this.map, this._tokens).toString();
 	}
 
 	public getBinaryEncodedTokensMap(): ITokensInflatorMap {
@@ -801,57 +804,13 @@ export class DefaultLineTokens implements ILineTokens {
 
 }
 
-function toModeTransitions(topLevelMode:IMode, modeTransitions:IModeTransition[]): IModeTransitions {
+function toModeTransitions(topLevelMode:IMode, modeTransitions:IModeTransition[]): ModeTransition[] {
 
 	if (!modeTransitions || modeTransitions.length === 0) {
 		return null;
-	} else if (modeTransitions.length === 1 && modeTransitions[0].startIndex === 0) {
-		if (modeTransitions[0].mode === topLevelMode) {
-			return null;
-		} else {
-			return new SingleModeTransition(modeTransitions[0].mode);
-		}
-	}
-
-	return new ModeTransitions(modeTransitions);
-}
-
-class DefaultModeTransitions implements IModeTransitions {
-	public static INSTANCE = new DefaultModeTransitions();
-
-	public toArray(topLevelMode:IMode): IModeTransition[] {
-		return [{
-			startIndex: 0,
-			mode: topLevelMode
-		}];
-	}
-}
-
-class SingleModeTransition implements IModeTransitions {
-
-	private _mode: IMode;
-
-	constructor(mode:IMode) {
-		this._mode = mode;
+	} else if (modeTransitions.length === 1 && modeTransitions[0].startIndex === 0 && modeTransitions[0].mode === topLevelMode) {
+		return null;
 	}
 
-	public toArray(topLevelMode:IMode): IModeTransition[] {
-		return [{
-			startIndex: 0,
-			mode: this._mode
-		}];
-	}
+	return ModeTransition.create(modeTransitions);
 }
-
-class ModeTransitions implements IModeTransitions {
-
-	private _modeTransitions: IModeTransition[];
-
-	constructor(modeTransitions:IModeTransition[]) {
-		this._modeTransitions = modeTransitions;
-	}
-
-	public toArray(topLevelMode:IMode): IModeTransition[] {
-		return this._modeTransitions.slice(0);
-	}
-}
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModel.ts
code:
@@ -49,10 +49,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getOptions(): editorCommon.ITextModelResolvedOptions {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getOptions: Model is disposed');
-		}
-
 		return this._options;
 	}
 
@@ -145,18 +141,10 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getVersionId(): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getVersionId: Model is disposed');
-		}
-
 		return this._versionId;
 	}
 
 	public getAlternativeVersionId(): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getAlternativeVersionId: Model is disposed');
-		}
-
 		return this._alternativeVersionId;
 	}
 
@@ -178,10 +166,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public dispose(): void {
-		if (this._isDisposed) {
-			throw new Error('TextModel.dispose: Model is disposed');
-		}
-
 		this._isDisposed = true;
 		// Null out members, such that any use of a disposed model will throw exceptions sooner rather than later
 		this._lines = null;
@@ -255,9 +239,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public setValue(value:string): void {
-		if (this._isDisposed) {
-			throw new Error('TextModel.setValue: Model is disposed');
-		}
 		let rawText: editorCommon.IRawText = null;
 		if (value !== null) {
 			rawText = TextModel.toRawText(value, {
@@ -271,10 +252,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public setValueFromRawText(newValue:editorCommon.IRawText): void {
-		if (this._isDisposed) {
-			throw new Error('TextModel.setValueFromRawText: Model is disposed');
-		}
-
 		if (newValue === null) {
 			// There's nothing to do
 			return;
@@ -291,10 +268,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getValue(eol?:editorCommon.EndOfLinePreference, preserveBOM:boolean=false): string {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getValue: Model is disposed');
-		}
-
 		var fullModelRange = this.getFullModelRange();
 		var fullModelValue = this.getValueInRange(fullModelRange, eol);
 
@@ -306,10 +279,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getValueLength(eol?: editorCommon.EndOfLinePreference, preserveBOM: boolean = false): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getValueLength: Model is disposed');
-		}
-
 		var fullModelRange = this.getFullModelRange();
 		var fullModelValue = this.getValueLengthInRange(fullModelRange, eol);
 
@@ -321,10 +290,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getEmptiedValueInRange(rawRange:editorCommon.IRange, fillCharacter: string = '', eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): string {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getEmptiedValueInRange: Model is disposed');
-		}
-
 		var range = this.validateRange(rawRange);
 
 		if (range.isEmpty()) {
@@ -358,10 +323,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getValueInRange(rawRange:editorCommon.IRange, eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): string {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getValueInRange: Model is disposed');
-		}
-
 		var range = this.validateRange(rawRange);
 
 		if (range.isEmpty()) {
@@ -387,10 +348,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getValueLengthInRange(rawRange:editorCommon.IRange, eol:editorCommon.EndOfLinePreference=editorCommon.EndOfLinePreference.TextDefined): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getValueInRange: Model is disposed');
-		}
-
 		var range = this.validateRange(rawRange);
 
 		if (range.isEmpty()) {
@@ -416,10 +373,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public isDominatedByLongLines(longLineBoundary:number): boolean {
-		if (this._isDisposed) {
-			throw new Error('TextModel.isDominatedByLongLines: Model is disposed');
-		}
-
 		var smallLineCharCount = 0,
 			longLineCharCount = 0,
 			i: number,
@@ -440,17 +393,10 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getLineCount(): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineCount: Model is disposed');
-		}
-
 		return this._lines.length;
 	}
 
 	public getLineContent(lineNumber:number): string {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineContent: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -459,10 +405,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getLinesContent(): string[] {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineContent: Model is disposed');
-		}
-
 		var r: string[] = [];
 		for (var i = 0, len = this._lines.length; i < len; i++) {
 			r[i] = this._lines[i].text;
@@ -471,10 +413,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getEOL(): string {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getEOL: Model is disposed');
-		}
-
 		return this._EOL;
 	}
 
@@ -506,9 +444,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getLineMaxColumn(lineNumber:number): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineMaxColumn: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -517,9 +452,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getLineFirstNonWhitespaceColumn(lineNumber: number): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineFirstNonWhitespaceColumn: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -532,9 +464,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getLineLastNonWhitespaceColumn(lineNumber: number): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getLineLastNonWhitespaceColumn: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -547,10 +476,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public validateLineNumber(lineNumber:number): number {
-		if (this._isDisposed) {
-			throw new Error('TextModel.validateLineNumber: Model is disposed');
-		}
-
 		if (lineNumber < 1) {
 			lineNumber = 1;
 		}
@@ -561,10 +486,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public validatePosition(position:editorCommon.IPosition): editorCommon.IEditorPosition {
-		if (this._isDisposed) {
-			throw new Error('TextModel.validatePosition: Model is disposed');
-		}
-
 		var lineNumber = position.lineNumber ? position.lineNumber : 1;
 		var column = position.column ? position.column : 1;
 
@@ -587,20 +508,12 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public validateRange(range:editorCommon.IRange): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('TextModel.validateRange: Model is disposed');
-		}
-
 		var start = this.validatePosition(new Position(range.startLineNumber, range.startColumn));
 		var end = this.validatePosition(new Position(range.endLineNumber, range.endColumn));
 		return new Range(start.lineNumber, start.column, end.lineNumber, end.column);
 	}
 
 	public modifyPosition(rawPosition: editorCommon.IPosition, offset: number) : editorCommon.IEditorPosition {
-		if (this._isDisposed) {
-			throw new Error('TextModel.modifyPosition: Model is disposed');
-		}
-
 		var position = this.validatePosition(rawPosition);
 
 		// Handle positive offsets, one line at a time
@@ -664,10 +577,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public getFullModelRange(): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('TextModel.getFullModelRange: Model is disposed');
-		}
-
 		var lineCount = this.getLineCount();
 		return new Range(1, 1, lineCount, this.getLineMaxColumn(lineCount));
 	}
@@ -761,10 +670,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public findMatches(searchString:string, rawSearchScope:any, isRegex:boolean, matchCase:boolean, wholeWord:boolean, limitResultCount:number = LIMIT_FIND_COUNT): editorCommon.IEditorRange[] {
-		if (this._isDisposed) {
-			throw new Error('Model.findMatches: Model is disposed');
-		}
-
 		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return [];
@@ -781,10 +686,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public findNextMatch(searchString:string, rawSearchStart:editorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('Model.findNextMatch: Model is disposed');
-		}
-
 		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return null;
@@ -816,10 +717,6 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 	}
 
 	public findPreviousMatch(searchString:string, rawSearchStart:editorCommon.IPosition, isRegex:boolean, matchCase:boolean, wholeWord:boolean): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('Model.findPreviousMatch: Model is disposed');
-		}
-
 		var regex = strings.createSafeRegExp(searchString, isRegex, matchCase, wholeWord);
 		if (!regex) {
 			return null;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModelWithDecorations.ts
code:
@@ -122,10 +122,6 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	public changeDecorations(callback: (changeAccessor:editorCommon.IModelDecorationsChangeAccessor)=>any, ownerId:number=0): any {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.changeDecorations: Model is disposed');
-		}
-
 		return this._withDeferredEvents((deferredEventsBuilder:DeferredEventsBuilder) => {
 			var changeAccessor:editorCommon.IModelDecorationsChangeAccessor = {
 				addDecoration: (range:editorCommon.IRange, options:editorCommon.IModelDecorationOptions): string => {
@@ -160,10 +156,6 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	public deltaDecorations(oldDecorations:string[], newDecorations:editorCommon.IModelDeltaDecoration[], ownerId:number=0): string[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.deltaDecorations: Model is disposed');
-		}
-
 		if (!oldDecorations) {
 			oldDecorations = [];
 		}
@@ -173,43 +165,29 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	public removeAllDecorationsWithOwnerId(ownerId:number): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.removeAllDecorationsWithOwnerId: Model is disposed');
-		}
-
-		var decorationId:string;
-		var decoration:IInternalDecoration;
-		var toRemove:string[] = [];
+		let toRemove:string[] = [];
 
-		for (decorationId in this.decorations) {
-			if (this.decorations.hasOwnProperty(decorationId)) {
-				decoration = this.decorations[decorationId];
+		let keys = Object.keys(this.decorations);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let decorationId = keys[i];
+			let decoration = this.decorations[decorationId];
 
-				if (decoration.ownerId === ownerId) {
-					toRemove.push(decoration.id);
-				}
+			if (decoration.ownerId === ownerId) {
+				toRemove.push(decoration.id);
 			}
 		}
 
 		this._removeDecorationsImpl(null, toRemove);
 	}
 
 	public getDecorationOptions(decorationId:string): editorCommon.IModelDecorationOptions {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getDecorationOptions: Model is disposed');
-		}
-
 		if (this.decorations.hasOwnProperty(decorationId)) {
 			return this.decorations[decorationId].options;
 		}
 		return null;
 	}
 
 	public getDecorationRange(decorationId:string): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getDecorationRange: Model is disposed');
-		}
-
 		if (this.decorations.hasOwnProperty(decorationId)) {
 			var decoration = this.decorations[decorationId];
 			return this.getTrackedRange(decoration.rangeId);
@@ -218,9 +196,6 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	public getLineDecorations(lineNumber:number, ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getLineDecorations: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			return [];
 		}
@@ -274,56 +249,43 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	public getLinesDecorations(startLineNumber: number, endLineNumber: number, ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getLinesDecorations: Model is disposed');
-		}
-
 		var lineCount = this.getLineCount();
 		startLineNumber = Math.min(lineCount, Math.max(1, startLineNumber));
 		endLineNumber = Math.min(lineCount, Math.max(1, endLineNumber));
 		return this._getDecorationsInRange(startLineNumber, 1, endLineNumber, Number.MAX_VALUE, ownerId, filterOutValidation);
 	}
 
 	public getDecorationsInRange(range: editorCommon.IRange, ownerId?: number, filterOutValidation?: boolean): editorCommon.IModelDecoration[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getDecorationsInRange: Model is disposed');
-		}
-
 		var validatedRange = this.validateRange(range);
 		return this._getDecorationsInRange(validatedRange.startLineNumber, validatedRange.startColumn, validatedRange.endLineNumber, validatedRange.endColumn, ownerId, filterOutValidation);
 	}
 
 	public getAllDecorations(ownerId:number=0, filterOutValidation:boolean=false): editorCommon.IModelDecoration[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithDecorations.getAllDecorations: Model is disposed');
-		}
+		let result:editorCommon.IModelDecoration[] = [];
 
-		var result:editorCommon.IModelDecoration[] = [];
-		var decorationId:string;
-		var decoration:IInternalDecoration;
+		let keys = Object.keys(this.decorations);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let decorationId = keys[i];
+			let decoration = this.decorations[decorationId];
 
-		for (decorationId in this.decorations) {
-			if (this.decorations.hasOwnProperty(decorationId)) {
-				decoration = this.decorations[decorationId];
+			if (ownerId && decoration.ownerId && decoration.ownerId !== ownerId) {
+				continue;
+			}
 
-				if (ownerId && decoration.ownerId && decoration.ownerId !== ownerId) {
+			if (filterOutValidation) {
+				if (decoration.options.className === editorCommon.ClassName.EditorErrorDecoration || decoration.options.className === editorCommon.ClassName.EditorWarningDecoration) {
 					continue;
 				}
-
-				if (filterOutValidation) {
-					if (decoration.options.className === editorCommon.ClassName.EditorErrorDecoration || decoration.options.className === editorCommon.ClassName.EditorWarningDecoration) {
-						continue;
-					}
-				}
-
-				result.push({
-					id: decoration.id,
-					ownerId: decoration.ownerId,
-					range: this.getTrackedRange(decoration.rangeId),
-					options: decoration.options
-				});
 			}
+
+			result.push({
+				id: decoration.id,
+				ownerId: decoration.ownerId,
+				range: this.getTrackedRange(decoration.rangeId),
+				options: decoration.options
+			});
 		}
+
 		return result;
 	}
 
@@ -370,47 +332,46 @@ export class TextModelWithDecorations extends TextModelWithTrackedRanges impleme
 	}
 
 	private _onChangedRanges(eventBuilder:DeferredEventsBuilder, changedRanges:editorCommon.IChangedTrackedRanges): void {
-		var rangeId:string;
-		var decorationId:string;
-
-		for (rangeId in changedRanges) {
-			if (changedRanges.hasOwnProperty(rangeId) && this.rangeIdToDecorationId.hasOwnProperty(rangeId)) {
-				decorationId = this.rangeIdToDecorationId[rangeId];
+		let keys = Object.keys(changedRanges);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let rangeId = keys[i];
+			if (this.rangeIdToDecorationId.hasOwnProperty(rangeId)) {
+				let decorationId = this.rangeIdToDecorationId[rangeId];
 
 				eventBuilder.addMovedDecoration(decorationId, changedRanges[rangeId]);
 			}
 		}
 	}
 
 	private _handleCollectedDecorationsEvents(b:DeferredEventsBuilder): void {
-		var decorationId:string,
-			addedOrChangedDecorations:editorCommon.IModelDecorationsChangedEventDecorationData[] = [],
+		var addedOrChangedDecorations:editorCommon.IModelDecorationsChangedEventDecorationData[] = [],
 			removedDecorations:string[] = [],
 			decorationIds:string[] = [],
 			decorationData:editorCommon.IModelDecorationsChangedEventDecorationData,
 			oldRange:editorCommon.IRange;
 
-		for (decorationId in b.newOrChangedDecorations) {
-			if (b.newOrChangedDecorations.hasOwnProperty(decorationId)) {
-				decorationIds.push(decorationId);
-				decorationData = this._getDecorationData(decorationId);
-				decorationData.isForValidation = (decorationData.options.className === editorCommon.ClassName.EditorErrorDecoration || decorationData.options.className === editorCommon.ClassName.EditorWarningDecoration);
-				addedOrChangedDecorations.push(decorationData);
-				if (b.oldDecorationRange.hasOwnProperty(decorationId)) {
-					oldRange = b.oldDecorationRange[decorationId];
-					oldRange.startLineNumber = oldRange.startLineNumber || decorationData.range.startLineNumber;
-					oldRange.startColumn = oldRange.startColumn || decorationData.range.startColumn;
-					oldRange.endLineNumber = oldRange.endLineNumber || decorationData.range.endLineNumber;
-					oldRange.endColumn = oldRange.endColumn || decorationData.range.endColumn;
-				}
+		let keys = Object.keys(b.newOrChangedDecorations);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let decorationId = keys[i];
+
+			decorationIds.push(decorationId);
+			decorationData = this._getDecorationData(decorationId);
+			decorationData.isForValidation = (decorationData.options.className === editorCommon.ClassName.EditorErrorDecoration || decorationData.options.className === editorCommon.ClassName.EditorWarningDecoration);
+			addedOrChangedDecorations.push(decorationData);
+			if (b.oldDecorationRange.hasOwnProperty(decorationId)) {
+				oldRange = b.oldDecorationRange[decorationId];
+				oldRange.startLineNumber = oldRange.startLineNumber || decorationData.range.startLineNumber;
+				oldRange.startColumn = oldRange.startColumn || decorationData.range.startColumn;
+				oldRange.endLineNumber = oldRange.endLineNumber || decorationData.range.endLineNumber;
+				oldRange.endColumn = oldRange.endColumn || decorationData.range.endColumn;
 			}
 		}
 
-		for (decorationId in b.removedDecorations) {
-			if (b.removedDecorations.hasOwnProperty(decorationId)) {
-				decorationIds.push(decorationId);
-				removedDecorations.push(decorationId);
-			}
+		keys = Object.keys(b.removedDecorations);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let decorationId = keys[i];
+			decorationIds.push(decorationId);
+			removedDecorations.push(decorationId);
 		}
 
 		if (decorationIds.length > 0) {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModelWithMarkers.ts
code:
@@ -70,10 +70,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_addMarker(lineNumber:number, column:number, stickToPreviousCharacter:boolean): string {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._addMarker: Model is disposed');
-		}
-
 		var pos = this.validatePosition(new Position(lineNumber, column));
 
 		var marker = new LineMarker(this._markerIdGenerator.generate(), pos.column, stickToPreviousCharacter);
@@ -114,10 +110,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_changeMarker(id:string, lineNumber:number, column:number): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._changeMarker: Model is disposed');
-		}
-
 		if (this._markerIdToMarker.hasOwnProperty(id)) {
 			var marker = this._markerIdToMarker[id];
 			var newPos = this.validatePosition(new Position(lineNumber, column));
@@ -134,10 +126,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_changeMarkerStickiness(id:string, newStickToPreviousCharacter:boolean): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._changeMarkerStickiness: Model is disposed');
-		}
-
 		if (this._markerIdToMarker.hasOwnProperty(id)) {
 			var marker = this._markerIdToMarker[id];
 
@@ -148,10 +136,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_getMarker(id:string): IEditorPosition {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._getMarker: Model is disposed');
-		}
-
 		if (this._markerIdToMarker.hasOwnProperty(id)) {
 			var marker = this._markerIdToMarker[id];
 			return new Position(marker.line.lineNumber, marker.column);
@@ -164,9 +148,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_getLineMarkers(lineNumber: number): IReadOnlyLineMarker[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._getLineMarkers: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -175,10 +156,6 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_removeMarker(id:string): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._removeMarker: Model is disposed');
-		}
-
 		if (this._markerIdToMarker.hasOwnProperty(id)) {
 			var marker = this._markerIdToMarker[id];
 			marker.line.removeMarker(marker);
@@ -219,15 +196,11 @@ export class TextModelWithMarkers extends TextModelWithTokens implements ITextMo
 	}
 
 	_getMarkersInMap(markersMap:{[markerId:string]:boolean;}): ILineMarker[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithMarkers._getMarkersInMap: Model is disposed');
-		}
-
-		var result: ILineMarker[] = [],
-			markerId: string;
-
-		for (markerId in markersMap)	{
-			if (markersMap.hasOwnProperty(markerId) && this._markerIdToMarker.hasOwnProperty(markerId)) {
+		let result: ILineMarker[] = [];
+		let keys = Object.keys(markersMap);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let markerId = keys[i];
+			if (this._markerIdToMarker.hasOwnProperty(markerId)) {
 				result.push(this._markerIdToMarker[markerId]);
 			}
 		}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModelWithTokens.ts
code:
@@ -12,17 +12,18 @@ import {StopWatch} from 'vs/base/common/stopwatch';
 import * as timer from 'vs/base/common/timer';
 import {TPromise} from 'vs/base/common/winjs.base';
 import {DefaultConfig} from 'vs/editor/common/config/defaultConfig';
-import {Arrays} from 'vs/editor/common/core/arrays';
 import {Range} from 'vs/editor/common/core/range';
 import * as editorCommon from 'vs/editor/common/editorCommon';
 import {ModelLine} from 'vs/editor/common/model/modelLine';
 import {TextModel} from 'vs/editor/common/model/textModel';
 import {WordHelper} from 'vs/editor/common/model/textModelWithTokensHelpers';
 import {TokenIterator} from 'vs/editor/common/model/tokenIterator';
-import {ILineContext, ILineTokens, IMode, IModeTransition, IState} from 'vs/editor/common/modes';
+import {ILineContext, ILineTokens, IMode, IState} from 'vs/editor/common/modes';
 import {NullMode, NullState, nullTokenize} from 'vs/editor/common/modes/nullMode';
 import {ignoreBracketsInToken} from 'vs/editor/common/modes/supports';
 import {BracketsUtils} from 'vs/editor/common/modes/supports/richEditBrackets';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 export class TokensInflatorMap implements editorCommon.ITokensInflatorMap {
 
@@ -138,12 +139,12 @@ export class FullModelRetokenizer implements IRetokenizeRequest {
 
 class LineContext implements ILineContext {
 
-	public modeTransitions:IModeTransition[];
+	public modeTransitions:ModeTransition[];
 	private _text:string;
 	private _lineTokens:editorCommon.ILineTokens;
 
 	constructor (topLevelMode:IMode, line:ModelLine) {
-		this.modeTransitions = line.getModeTransitions().toArray(topLevelMode);
+		this.modeTransitions = line.getModeTransitions(topLevelMode);
 		this._text = line.text;
 		this._lineTokens = line.getTokens();
 	}
@@ -199,9 +200,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	private _scheduleRetokenizeNow: RunOnceScheduler;
 	private _retokenizers:IRetokenizeRequest[];
 
-	private _tokenizationElapsedTime: number;
-	private _tokenizationTotalCharacters: number;
-
 	private _shouldSimplifyMode: boolean;
 	private _shouldDenyMode: boolean;
 
@@ -212,11 +210,22 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 		super(allowedEventTypes, rawText);
 
 		this._shouldAutoTokenize = shouldAutoTokenize;
+		this._mode = null;
+		this._modeListener = null;
+		this._modeToModelBinder = null;
+		this._tokensInflatorMap = null;
+		this._stopLineTokenizationAfter = DefaultConfig.editor.stopLineTokenizationAfter;
+
+		this._invalidLineStartIndex = 0;
+		this._lastState = null;
+
+		this._revalidateTokensTimeout = -1;
+		this._scheduleRetokenizeNow = null;
+		this._retokenizers = null;
+
 		this._shouldSimplifyMode = (rawText.length > TextModelWithTokens.MODEL_SYNC_LIMIT);
 		this._shouldDenyMode = (rawText.length > TextModelWithTokens.MODEL_TOKENIZATION_LIMIT);
 
-		this._stopLineTokenizationAfter = DefaultConfig.editor.stopLineTokenizationAfter;
-
 		if (!modeOrPromise) {
 			this._mode = new NullMode();
 		} else if (TPromise.is(modeOrPromise)) {
@@ -376,8 +385,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 			this._lines[i].setState(null);
 		}
 		this._initializeTokenizationState();
-		this._tokenizationElapsedTime = 0;
-		this._tokenizationTotalCharacters = 1;
 	}
 
 	private _clearTimers(): void {
@@ -411,17 +418,10 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public setStopLineTokenizationAfter(stopLineTokenizationAfter:number): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.setStopLineTokenizationAfter: Model is disposed');
-		}
-
 		this._stopLineTokenizationAfter = stopLineTokenizationAfter;
 	}
 
 	public getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean = false): editorCommon.ILineTokens {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getLineTokens: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -433,9 +433,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public getLineContext(lineNumber:number): ILineContext {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getLineContext: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -453,9 +450,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	public setValue(value:string, newMode?:IMode): void;
 	public setValue(value:string, newModePromise?:TPromise<IMode>): void;
 	public setValue(value:string, newModeOrPromise:any=null): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.setValue: Model is disposed');
-		}
 		let rawText: editorCommon.IRawText = null;
 		if (value !== null) {
 			rawText = TextModel.toRawText(value, {
@@ -471,10 +465,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	public setValueFromRawText(value:editorCommon.IRawText, newMode?:IMode): void;
 	public setValueFromRawText(value:editorCommon.IRawText, newModePromise?:TPromise<IMode>): void;
 	public setValueFromRawText(value:editorCommon.IRawText, newModeOrPromise:any=null): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.setValueFromRawText: Model is disposed');
-		}
-
 		if (value !== null) {
 			super.setValueFromRawText(value);
 		}
@@ -501,20 +491,12 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public getMode(): IMode {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getMode: Model is disposed');
-		}
-
 		return this._mode;
 	}
 
 	public setMode(newMode:IMode): void;
 	public setMode(newModePromise:TPromise<IMode>): void;
 	public setMode(newModeOrPromise:any): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.setMode: Model is disposed');
-		}
-
 		if (!newModeOrPromise) {
 			// There's nothing to do
 			return;
@@ -523,10 +505,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public getModeAtPosition(_lineNumber:number, _column:number): IMode {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getModeAtPosition: Model is disposed');
-		}
-
 		var validPosition = this.validatePosition({
 			lineNumber: _lineNumber,
 			column: _column
@@ -541,7 +519,7 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 			return this.getStateAfterLine(lineNumber).getMode();
 		} else {
 			var modeTransitions = this._getLineModeTransitions(lineNumber);
-			var modeTransitionIndex = Arrays.findIndexInSegmentsArray(modeTransitions, column - 1);
+			var modeTransitionIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, column - 1);
 			return modeTransitions[modeTransitionIndex].mode;
 		}
 	}
@@ -571,10 +549,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	_warmUpTokens(): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens._warmUpTokens: Model is disposed');
-		}
-
 		// Warm up first 100 lines (if it takes less than 50ms)
 		var maxLineNumber = Math.min(100, this.getLineCount());
 		var toLineNumber = maxLineNumber;
@@ -636,11 +610,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 		}
 
 		elapsedTime = sw.elapsed();
-//		console.log('TOKENIZED LOCAL (' + this._mode.getId() + ') ' + tokenizedChars + '\t in \t' + elapsedTime + '\t speed \t' + tokenizedChars/elapsedTime);
-//		console.log('TOKENIZED GLOBAL(' + this._mode.getId() + ') ' + this._tokenizationTotalCharacters + '\t in*\t' + this._tokenizationElapsedTime + '\t speed*\t' + this._tokenizationTotalCharacters/this._tokenizationElapsedTime);
-
-		var t2 = timer.start(timer.Topic.EDITOR, '**speed: ' + this._tokenizationTotalCharacters / this._tokenizationElapsedTime);
-		t2.stop();
 
 		if (fromLineNumber <= toLineNumber) {
 			this.emitModelTokensChangedEvent(fromLineNumber, toLineNumber);
@@ -663,15 +632,12 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 		return lineNumber < this._lines.length ? this._lines[lineNumber].getState() : this._lastState;
 	}
 
-	_getLineModeTransitions(lineNumber:number): IModeTransition[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens._getLineModeTransitions: Model is disposed');
-		}
+	_getLineModeTransitions(lineNumber:number): ModeTransition[] {
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
 		this._updateTokensUntilLine(lineNumber, true);
-		return this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+		return this._lines[lineNumber - 1].getModeTransitions(this._mode);
 	}
 
 	private _updateTokensUntilLine(lineNumber:number, emitEvents:boolean): void {
@@ -682,9 +648,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 			stopLineTokenizationAfter = 1000000000; // 1 billion, if a line is so long, you have other trouble :).
 		}
 
-		var sw = StopWatch.create(false);
-		var tokenizedCharacters = 0;
-
 		var fromLineNumber = this._invalidLineStartIndex + 1, toLineNumber = lineNumber;
 
 		// Validate all states up to and including endLineIndex
@@ -697,7 +660,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 				try {
 					// Tokenize only the first X characters
 					r = this._mode.tokenizationSupport.tokenize(this._lines[lineIndex].text, this._lines[lineIndex].getState(), 0, stopLineTokenizationAfter);
-					tokenizedCharacters = r ? r.actualStopOffset : this._lines[lineIndex].text.length;
 				} catch (e) {
 					e.friendlyMessage = TextModelWithTokens.MODE_TOKENIZATION_FAILED_MSG;
 					onUnexpectedError(e);
@@ -773,9 +735,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 		}
 		this._invalidLineStartIndex = Math.max(this._invalidLineStartIndex, endLineIndex + 1);
 
-		this._tokenizationElapsedTime += sw.elapsed();
-		this._tokenizationTotalCharacters += tokenizedCharacters;
-
 		if (emitEvents && fromLineNumber <= toLineNumber) {
 			this.emitModelTokensChangedEvent(fromLineNumber, toLineNumber);
 		}
@@ -814,18 +773,10 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public getWordAtPosition(position:editorCommon.IPosition): editorCommon.IWordAtPosition {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getWordAtPosition: Model is disposed');
-		}
-
 		return WordHelper.getWordAtPosition(this, this.validatePosition(position));
 	}
 
 	public getWordUntilPosition(position: editorCommon.IPosition): editorCommon.IWordAtPosition {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getWordUntilPosition: Model is disposed');
-		}
-
 		var wordAtPosition = this.getWordAtPosition(position);
 		if (!wordAtPosition) {
 			return {
@@ -842,9 +793,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public getWords(lineNumber:number): editorCommon.IWordRange[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.getWords: Model is disposed');
-		}
 		if (lineNumber < 1 || lineNumber > this.getLineCount()) {
 			throw new Error('Illegal value ' + lineNumber + ' for `lineNumber`');
 		}
@@ -853,24 +801,16 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public tokenIterator(position:editorCommon.IPosition, callback:(it:TokenIterator)=>any): any {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.tokenIterator: Model is disposed');
-		}
-
 		var iter = new TokenIterator(this, this.validatePosition(position));
 		var result = callback(iter);
 		iter._invalidate();
 		return result;
 	}
 
 	public findMatchingBracketUp(bracket:string, _position:editorCommon.IPosition): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.findMatchingBracketUp: Model is disposed');
-		}
-
 		let position = this.validatePosition(_position);
-		let modeTransitions = this._lines[position.lineNumber - 1].getModeTransitions().toArray(this._mode);
-		let currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+		let modeTransitions = this._lines[position.lineNumber - 1].getModeTransitions(this._mode);
+		let currentModeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, position.column - 1);
 		let currentMode = modeTransitions[currentModeIndex];
 		let currentModeBrackets = currentMode.mode.richEditSupport ? currentMode.mode.richEditSupport.brackets : null;
 
@@ -888,10 +828,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public matchBracket(position:editorCommon.IPosition, inaccurateResultAcceptable:boolean = false): editorCommon.IMatchBracketResult {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.matchBracket: Model is disposed');
-		}
-
 		return this._matchBracket(this.validatePosition(position));
 	}
 
@@ -905,8 +841,8 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 		let currentTokenIndex = lineTokens.findIndexOfOffset(position.column - 1);
 		let currentTokenStart = getStartIndex(tokens[currentTokenIndex]);
 
-		let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
-		let currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+		let modeTransitions = this._lines[lineNumber - 1].getModeTransitions(this._mode);
+		let currentModeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, position.column - 1);
 		let currentMode = modeTransitions[currentModeIndex];
 		let currentModeBrackets = currentMode.mode.richEditSupport ? currentMode.mode.richEditSupport.brackets : null;
 
@@ -1022,7 +958,7 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 			let lineTokens = this._lines[lineNumber - 1].getTokens();
 			let lineText = this._lines[lineNumber - 1].text;
 			let tokens = lineTokens.getBinaryEncodedTokens();
-			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions(this._mode);
 			let currentModeIndex = modeTransitions.length - 1;
 			let currentModeStart = modeTransitions[currentModeIndex].startIndex;
 			let currentModeId = modeTransitions[currentModeIndex].mode.getId();
@@ -1033,7 +969,7 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 				tokensLength = lineTokens.findIndexOfOffset(position.column - 1);
 				currentTokenEnd = position.column - 1;
 
-				currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+				currentModeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, position.column - 1);
 				currentModeStart = modeTransitions[currentModeIndex].startIndex;
 				currentModeId = modeTransitions[currentModeIndex].mode.getId();
 			}
@@ -1092,7 +1028,7 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 			let lineTokens = this._lines[lineNumber - 1].getTokens();
 			let lineText = this._lines[lineNumber - 1].text;
 			let tokens = lineTokens.getBinaryEncodedTokens();
-			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions().toArray(this._mode);
+			let modeTransitions = this._lines[lineNumber - 1].getModeTransitions(this._mode);
 			let currentModeIndex = 0;
 			let nextModeStart = (currentModeIndex + 1 < modeTransitions.length ? modeTransitions[currentModeIndex + 1].startIndex : lineText.length + 1);
 			let currentModeId = modeTransitions[currentModeIndex].mode.getId();
@@ -1103,7 +1039,7 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 				startTokenIndex = lineTokens.findIndexOfOffset(position.column - 1);
 				currentTokenStart = Math.max(currentTokenStart, position.column - 1);
 
-				currentModeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, position.column - 1);
+				currentModeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, position.column - 1);
 				nextModeStart = (currentModeIndex + 1 < modeTransitions.length ? modeTransitions[currentModeIndex + 1].startIndex : lineText.length + 1);
 				currentModeId = modeTransitions[currentModeIndex].mode.getId();
 			}
@@ -1150,9 +1086,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public findPrevBracket(_position:editorCommon.IPosition): editorCommon.IFoundBracket {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.findPrevBracket: Model is disposed');
-		}
 		let position = this.validatePosition(_position);
 
 		let tokensMap = this._tokensInflatorMap;
@@ -1190,9 +1123,6 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 
 	public findNextBracket(_position:editorCommon.IPosition): editorCommon.IFoundBracket {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTokens.findNextBracket: Model is disposed');
-		}
 		let position = this.validatePosition(_position);
 
 		let tokensMap = this._tokensInflatorMap;
@@ -1249,5 +1179,5 @@ export class TextModelWithTokens extends TextModel implements editorCommon.IToke
 	}
 }
 
-var getType = editorCommon.LineTokensBinaryEncoding.getType;
-var getStartIndex = editorCommon.LineTokensBinaryEncoding.getStartIndex;
+var getType = TokensBinaryEncoding.getType;
+var getStartIndex = TokensBinaryEncoding.getStartIndex;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModelWithTokensHelpers.ts
code:
@@ -4,10 +4,10 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {Arrays} from 'vs/editor/common/core/arrays';
 import {ILineTokens, IPosition, IWordAtPosition, IWordRange} from 'vs/editor/common/editorCommon';
 import {IMode, IModeTransition} from 'vs/editor/common/modes';
 import {NullMode} from 'vs/editor/common/modes/nullMode';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 export interface ITextSource {
 
@@ -21,7 +21,7 @@ export interface ITextSource {
 
 	getModeAtPosition(lineNumber:number, column:number): IMode;
 
-	_getLineModeTransitions(lineNumber:number): IModeTransition[];
+	_getLineModeTransitions(lineNumber:number): ModeTransition[];
 
 	getLineTokens(lineNumber:number, inaccurateTokensAcceptable:boolean): ILineTokens;
 }
@@ -168,7 +168,7 @@ export class WordHelper {
 		var txt = textSource.getLineContent(position.lineNumber),
 			modeTransitions = textSource._getLineModeTransitions(position.lineNumber),
 			columnIndex = position.column - 1,
-			modeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, columnIndex);
+			modeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, columnIndex);
 
 		result = WordHelper._getWordAtColumn(txt, position.column, modeIndex, modeTransitions);
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/textModelWithTrackedRanges.ts
code:
@@ -132,10 +132,6 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	}
 
 	public addTrackedRange(textRange:editorCommon.IRange, stickiness:editorCommon.TrackedRangeStickiness): string {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.addTrackedRange: Model is disposed');
-		}
-
 		textRange = this.validateRange(textRange);
 
 		var startMarkerSticksToPreviousCharacter = this._shouldStartMarkerSticksToPreviousCharacter(stickiness);
@@ -194,10 +190,6 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	}
 
 	public changeTrackedRange(rangeId:string, newTextRange:editorCommon.IRange): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.changeTrackedRange: Model is disposed');
-		}
-
 		if (this._ranges.hasOwnProperty(rangeId)) {
 			newTextRange = this.validateRange(newTextRange);
 
@@ -210,10 +202,6 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	}
 
 	public changeTrackedRangeStickiness(rangeId:string, newStickiness:editorCommon.TrackedRangeStickiness): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.changeTrackedRangeStickiness: Model is disposed');
-		}
-
 		if (this._ranges.hasOwnProperty(rangeId)) {
 			var range = this._ranges[rangeId];
 			this._changeMarkerStickiness(range.startMarkerId, this._shouldStartMarkerSticksToPreviousCharacter(newStickiness));
@@ -229,10 +217,6 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	}
 
 	public removeTrackedRange(rangeId:string): void {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.removeTrackedRange: Model is disposed');
-		}
-
 		if (this._ranges.hasOwnProperty(rangeId)) {
 			var range = this._ranges[rangeId];
 
@@ -284,10 +268,6 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	}
 
 	public getTrackedRange(rangeId:string): editorCommon.IEditorRange {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.getTrackedRange: Model is disposed');
-		}
-
 		var range = this._ranges[rangeId];
 		var startMarker = this._getMarker(range.startMarkerId);
 		var endMarker = this._getMarker(range.endMarkerId);
@@ -299,41 +279,33 @@ export class TextModelWithTrackedRanges extends TextModelWithMarkers implements
 	 * Fetch only multi-line ranges that intersect with the given line number range
 	 */
 	private _getMultiLineTrackedRanges(filterStartLineNumber: number, filterEndLineNumber: number): editorCommon.IModelTrackedRange[] {
-		var result: editorCommon.IModelTrackedRange[] = [],
-			rangeId: string,
-			range: ITrackedRange,
-			startMarker: editorCommon.IEditorPosition,
-			endMarker: editorCommon.IEditorPosition;
+		let result: editorCommon.IModelTrackedRange[] = [];
 
-		for (rangeId in this._multiLineTrackedRanges) {
-			if (this._multiLineTrackedRanges.hasOwnProperty(rangeId)) {
-				range = this._ranges[rangeId];
-
-				startMarker = this._getMarker(range.startMarkerId);
-				if (startMarker.lineNumber > filterEndLineNumber) {
-					continue;
-				}
+		let keys = Object.keys(this._multiLineTrackedRanges);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let rangeId = keys[i];
+			let range = this._ranges[rangeId];
 
-				endMarker = this._getMarker(range.endMarkerId);
-				if (endMarker.lineNumber < filterStartLineNumber) {
-					continue;
-				}
+			let startMarker = this._getMarker(range.startMarkerId);
+			if (startMarker.lineNumber > filterEndLineNumber) {
+				continue;
+			}
 
-				result.push({
-					id: range.id,
-					range: this._newEditorRange(startMarker, endMarker)
-				});
+			let endMarker = this._getMarker(range.endMarkerId);
+			if (endMarker.lineNumber < filterStartLineNumber) {
+				continue;
 			}
+
+			result.push({
+				id: range.id,
+				range: this._newEditorRange(startMarker, endMarker)
+			});
 		}
 
 		return result;
 	}
 
 	public getLinesTrackedRanges(startLineNumber:number, endLineNumber:number): editorCommon.IModelTrackedRange[] {
-		if (this._isDisposed) {
-			throw new Error('TextModelWithTrackedRanges.getLinesTrackedRanges: Model is disposed');
-		}
-
 		var result = this._getMultiLineTrackedRanges(startLineNumber, endLineNumber),
 			resultMap: { [rangeId:string]: boolean; } = {},
 			lineMarkers: editorCommon.IReadOnlyLineMarker[],

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/tokenIterator.ts
code:
@@ -5,9 +5,10 @@
 'use strict';
 
 import * as editorCommon from 'vs/editor/common/editorCommon';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
-var getStartIndex = editorCommon.LineTokensBinaryEncoding.getStartIndex;
-var inflate = editorCommon.LineTokensBinaryEncoding.inflate;
+var getStartIndex = TokensBinaryEncoding.getStartIndex;
+var inflate = TokensBinaryEncoding.inflate;
 
 export class TokenIterator implements editorCommon.ITokenIterator {
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/model/tokensBinaryEncoding.ts
code:
@@ -6,36 +6,19 @@
 
 import {onUnexpectedError} from 'vs/base/common/errors';
 import * as strings from 'vs/base/common/strings';
-import {ITokensInflatorMap} from 'vs/editor/common/editorCommon';
+import {ITokensInflatorMap, LineToken} from 'vs/editor/common/editorCommon';
 import {IToken} from 'vs/editor/common/modes';
 
-class InflatedToken implements IToken {
-	startIndex:number;
-	type:string;
-
-	constructor(startIndex:number, type:string) {
-		this.startIndex = startIndex;
-		this.type = type;
-	}
-
-	public toString(): string {
-		return '{ ' + this.startIndex + ', \'' + this.type + '\'}';
-	}
-}
-
 export var START_INDEX_MASK = 0xffffffff;
 export var TYPE_MASK = 0xffff;
 export var START_INDEX_OFFSET = 1;
 export var TYPE_OFFSET = Math.pow(2, 32);
 
-var DEFAULT_TOKEN = {
-	startIndex: 0,
-	type: ''
-};
-var INFLATED_TOKENS_EMPTY_TEXT = <IToken[]>[];
-var DEFLATED_TOKENS_EMPTY_TEXT = <number[]>[];
-var INFLATED_TOKENS_NON_EMPTY_TEXT = <IToken[]>[DEFAULT_TOKEN];
-var DEFLATED_TOKENS_NON_EMPTY_TEXT = <number[]>[0];
+var DEFAULT_TOKEN = new LineToken(0, '');
+var INFLATED_TOKENS_EMPTY_TEXT:LineToken[] = [];
+var DEFLATED_TOKENS_EMPTY_TEXT:number[] = [];
+var INFLATED_TOKENS_NON_EMPTY_TEXT:LineToken[] = [DEFAULT_TOKEN];
+var DEFLATED_TOKENS_NON_EMPTY_TEXT:number[] = [0];
 
 export function deflateArr(map:ITokensInflatorMap, tokens:IToken[]): number[] {
 	if (tokens.length === 0) {
@@ -105,7 +88,7 @@ export function inflate(map:ITokensInflatorMap, binaryEncodedToken:number): ITok
 	var startIndex = (binaryEncodedToken / START_INDEX_OFFSET) & START_INDEX_MASK;
 	var deflatedType = (binaryEncodedToken / TYPE_OFFSET) & TYPE_MASK;
 
-	return new InflatedToken(startIndex, map._inflate[deflatedType]);
+	return new LineToken(startIndex, map._inflate[deflatedType]);
 }
 
 export function getStartIndex(binaryEncodedToken:number): number {
@@ -120,15 +103,15 @@ export function getType(map:ITokensInflatorMap, binaryEncodedToken:number): stri
 	return map._inflate[deflatedType];
 }
 
-export function inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): IToken[] {
+export function inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[]): LineToken[] {
 	if (binaryEncodedTokens.length === 0) {
 		return INFLATED_TOKENS_EMPTY_TEXT;
 	}
 	if (binaryEncodedTokens.length === 1 && binaryEncodedTokens[0] === 0) {
 		return INFLATED_TOKENS_NON_EMPTY_TEXT;
 	}
 
-	var result: IToken[] = new Array(binaryEncodedTokens.length),
+	var result: LineToken[] = new Array(binaryEncodedTokens.length),
 		i:number,
 		len:number,
 		deflated:number,
@@ -142,7 +125,7 @@ export function inflateArr(map:ITokensInflatorMap, binaryEncodedTokens:number[])
 		startIndex = (deflated / START_INDEX_OFFSET) & START_INDEX_MASK;
 		deflatedType = (deflated / TYPE_OFFSET) & TYPE_MASK;
 
-		result[i] = new InflatedToken(startIndex, inflateMap[deflatedType]);
+		result[i] = new LineToken(startIndex, inflateMap[deflatedType]);
 	}
 
 	return result;
@@ -152,7 +135,7 @@ export function findIndexOfOffset(binaryEncodedTokens:number[], offset:number):
 	return findIndexInSegmentsArray(binaryEncodedTokens, offset);
 }
 
-export function sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): IToken[] {
+export function sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:number[], startOffset:number, endOffset:number, deltaStartIndex:number): LineToken[] {
 	if (binaryEncodedTokens.length === 0) {
 		return INFLATED_TOKENS_EMPTY_TEXT;
 	}
@@ -167,13 +150,13 @@ export function sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:numb
 		originalStartIndex:number,
 		newStartIndex:number,
 		deflatedType:number,
-		result: IToken[] = [],
+		result: LineToken[] = [],
 		inflateMap = map._inflate;
 
 	originalToken = binaryEncodedTokens[startIndex];
 	deflatedType = (originalToken / TYPE_OFFSET) & TYPE_MASK;
 	newStartIndex = 0;
-	result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType]));
+	result.push(new LineToken(newStartIndex, inflateMap[deflatedType]));
 
 	for (i = startIndex + 1, len = binaryEncodedTokens.length; i < len; i++) {
 		originalToken = binaryEncodedTokens[i];
@@ -185,7 +168,7 @@ export function sliceAndInflate(map:ITokensInflatorMap, binaryEncodedTokens:numb
 
 		deflatedType = (originalToken / TYPE_OFFSET) & TYPE_MASK;
 		newStartIndex = originalStartIndex - startOffset + deltaStartIndex;
-		result.push(new InflatedToken(newStartIndex, inflateMap[deflatedType]));
+		result.push(new LineToken(newStartIndex, inflateMap[deflatedType]));
 	}
 
 	return result;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/modes.ts
code:
@@ -11,6 +11,7 @@ import URI from 'vs/base/common/uri';
 import {TPromise} from 'vs/base/common/winjs.base';
 import {IMarker} from 'vs/platform/markers/common/markers';
 import * as editorCommon from 'vs/editor/common/editorCommon';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 export interface ITokenizationResult {
 	type?:string;
@@ -153,7 +154,7 @@ export interface IModeDescriptor {
 export interface ILineContext {
 	getLineContent(): string;
 
-	modeTransitions: IModeTransition[];
+	modeTransitions: ModeTransition[];
 
 	getTokenCount(): number;
 	getTokenStartIndex(tokenIndex:number): number;
@@ -325,10 +326,30 @@ export interface IExtraInfoSupport {
 	computeInfo(resource:URI, position:editorCommon.IPosition):TPromise<IComputeExtraInfoResult>;
 }
 
+export type SuggestionType = 'method'
+	| 'function'
+	| 'constructor'
+	| 'field'
+	| 'variable'
+	| 'class'
+	| 'interface'
+	| 'module'
+	| 'property'
+	| 'unit'
+	| 'value'
+	| 'enum'
+	| 'keyword'
+	| 'snippet'
+	| 'text'
+	| 'color'
+	| 'file'
+	| 'reference'
+	| 'customcolor';
+
 export interface ISuggestion {
 	label: string;
 	codeSnippet: string;
-	type: 'Text' | 'Method' | 'Function' | 'Constructor' | 'Field' | 'Variable' | 'Class' | 'Interface' | 'Module' | 'Property' | 'Unit' | 'Value' | 'Enum' | 'Keyword' | 'Snippet' | 'Color' | 'File' | 'Reference' | string;
+	type: SuggestionType;
 	typeLabel?: string;
 	documentationLabel?: string;
 	filterText?: string;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/modes/TMState.ts
code:
@@ -33,12 +33,21 @@ export class TMState implements IState {
 	constructor(mode: IMode, parentEmbedderState: IState, ruleStack: StackElement[]) {
 		this._mode = mode;
 		this._parentEmbedderState = parentEmbedderState;
-		this._ruleStack = ruleStack;
+		this._ruleStack = ruleStack || null;
 	}
 
 	public clone():TMState {
 		let parentEmbedderStateClone = AbstractState.safeClone(this._parentEmbedderState);
-		let ruleStackClone = this._ruleStack ? this._ruleStack.map(el => el.clone()) : null;
+
+		let ruleStackClone: StackElement[] = null;
+		if (this._ruleStack) {
+			ruleStackClone = [];
+			for (let i = 0, len = this._ruleStack.length; i < len; i++) {
+				let rule = this._ruleStack[i];
+				ruleStackClone.push(rule.clone());
+			}
+		}
+
 		return new TMState(this._mode, parentEmbedderStateClone, ruleStackClone);
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/modes/supports.ts
code:
@@ -5,9 +5,9 @@
 'use strict';
 
 import * as strings from 'vs/base/common/strings';
-import {Arrays} from 'vs/editor/common/core/arrays';
 import {IModel, IPosition} from 'vs/editor/common/editorCommon';
 import * as modes from 'vs/editor/common/modes';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 export class Token implements modes.IToken {
 	public startIndex:number;
@@ -29,7 +29,7 @@ export function handleEvent<T>(context:modes.ILineContext, offset:number, runner
 		return runner(modeTransitions[0].mode, context, offset);
 	}
 
-	var modeIndex = Arrays.findIndexInSegmentsArray(modeTransitions, offset);
+	var modeIndex = ModeTransition.findIndexInSegmentsArray(modeTransitions, offset);
 	var nestedMode = modeTransitions[modeIndex].mode;
 	var modeStartIndex = modeTransitions[modeIndex].startIndex;
 
@@ -87,7 +87,7 @@ export function isLineToken(context:modes.ILineContext, offset:number, types:str
 
 export class FilteredLineContext implements modes.ILineContext {
 
-	public modeTransitions: modes.IModeTransition[];
+	public modeTransitions: ModeTransition[];
 
 	private _actual:modes.ILineContext;
 	private _firstTokenInModeIndex:number;
@@ -99,10 +99,7 @@ export class FilteredLineContext implements modes.ILineContext {
 			firstTokenInModeIndex:number, nextTokenAfterMode:number,
 			firstTokenCharacterOffset:number, nextCharacterAfterModeIndex:number) {
 
-		this.modeTransitions = [{
-			startIndex: 0,
-			mode: mode
-		}];
+		this.modeTransitions = [new ModeTransition(0, mode)];
 		this._actual = actual;
 		this._firstTokenInModeIndex = firstTokenInModeIndex;
 		this._nextTokenAfterMode = nextTokenAfterMode;
@@ -140,8 +137,9 @@ export class FilteredLineContext implements modes.ILineContext {
 	}
 }
 
+const IGNORE_IN_TOKENS = /\b(comment|string|regex)\b/;
 export function ignoreBracketsInToken(tokenType:string): boolean {
-	return /\b(comment|string|regex)\b/.test(tokenType);
+	return IGNORE_IN_TOKENS.test(tokenType);
 }
 
 // TODO@Martin: find a better home for this code:

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/services/languagesRegistry.ts
code:
@@ -200,12 +200,12 @@ export class LanguagesRegistry {
 	}
 
 	public getMimeForMode(theModeId: string): string {
-		for (var _mime in this.mime2LanguageId) {
-			if (this.mime2LanguageId.hasOwnProperty(_mime)) {
-				var modeId = this.mime2LanguageId[_mime];
-				if (modeId === theModeId) {
-					return _mime;
-				}
+		let keys = Object.keys(this.mime2LanguageId);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let _mime = keys[i];
+			let modeId = this.mime2LanguageId[_mime];
+			if (modeId === theModeId) {
+				return _mime;
 			}
 		}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/services/modelServiceImpl.ts
code:
@@ -309,18 +309,18 @@ export class ModelServiceImpl implements IModelService {
 		this._modelCreationOptions = newOpts;
 
 		// Update options on all models
-		for (let modelId in this._models) {
-			if (this._models.hasOwnProperty(modelId)) {
-				let modelData = this._models[modelId];
+		let keys = Object.keys(this._models);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let modelId = keys[i];
+			let modelData = this._models[modelId];
 
-				if (this._modelCreationOptions.detectIndentation) {
-					modelData.model.detectIndentation(this._modelCreationOptions.insertSpaces, this._modelCreationOptions.tabSize);
-				} else {
-					modelData.model.updateOptions({
-						insertSpaces: this._modelCreationOptions.insertSpaces,
-						tabSize:  this._modelCreationOptions.tabSize
-					});
-				}
+			if (this._modelCreationOptions.detectIndentation) {
+				modelData.model.detectIndentation(this._modelCreationOptions.insertSpaces, this._modelCreationOptions.tabSize);
+			} else {
+				modelData.model.updateOptions({
+					insertSpaces: this._modelCreationOptions.insertSpaces,
+					tabSize:  this._modelCreationOptions.tabSize
+				});
 			}
 		}
 	}
@@ -398,11 +398,13 @@ export class ModelServiceImpl implements IModelService {
 
 	public getModels(): editorCommon.IModel[] {
 		let ret: editorCommon.IModel[] = [];
-		for (let modelId in this._models) {
-			if (this._models.hasOwnProperty(modelId)) {
-				ret.push(this._models[modelId].model);
-			}
+
+		let keys = Object.keys(this._models);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let modelId = keys[i];
+			ret.push(this._models[modelId].model);
 		}
+
 		return ret;
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/editorScrollable.ts
code:
@@ -6,7 +6,7 @@
 
 import {EventEmitter} from 'vs/base/common/eventEmitter';
 import {IDisposable} from 'vs/base/common/lifecycle';
-import {IScrollable} from 'vs/base/common/scrollable';
+import {IScrollable, ScrollEvent} from 'vs/base/common/scrollable';
 import {IScrollEvent} from 'vs/editor/common/editorCommon';
 
 export class EditorScrollable extends EventEmitter implements IScrollable {
@@ -20,8 +20,7 @@ export class EditorScrollable extends EventEmitter implements IScrollable {
 
 	constructor() {
 		super([
-			EditorScrollable._SCROLL_EVENT,
-			EditorScrollable._INTERNAL_SIZE_CHANGED_EVENT
+			EditorScrollable._SCROLL_EVENT
 		]);
 
 		this.scrollTop = 0;
@@ -75,7 +74,7 @@ export class EditorScrollable extends EventEmitter implements IScrollable {
 			// Revalidate
 			this.setScrollLeft(this.scrollLeft);
 
-			this._emitInternalSizeEvent();
+			this._emitScrollEvent(false, false);
 		}
 	}
 
@@ -140,7 +139,7 @@ export class EditorScrollable extends EventEmitter implements IScrollable {
 			// Revalidate
 			this.setScrollTop(this.scrollTop);
 
-			this._emitInternalSizeEvent();
+			this._emitScrollEvent(false, false);
 		}
 	}
 
@@ -170,24 +169,17 @@ export class EditorScrollable extends EventEmitter implements IScrollable {
 
 	static _SCROLL_EVENT = 'scroll';
 	private _emitScrollEvent(vertical:boolean, horizontal:boolean): void {
-		var e:IScrollEvent = {
-			vertical: vertical,
-			horizontal: horizontal,
-			scrollTop: this.scrollTop,
-			scrollLeft: this.scrollLeft
-		};
+		var e:IScrollEvent = new ScrollEvent(
+			this.getScrollTop(),
+			this.getScrollLeft(),
+			this.getScrollWidth(),
+			this.getScrollHeight(),
+			vertical,
+			horizontal
+		);
 		this.emit(EditorScrollable._SCROLL_EVENT, e);
 	}
-	public addScrollListener(listener: (e:IScrollEvent) => void): IDisposable {
+	public addScrollListener(listener: (e:ScrollEvent) => void): IDisposable {
 		return this.addListener2(EditorScrollable._SCROLL_EVENT, listener);
 	}
-
-
-	static _INTERNAL_SIZE_CHANGED_EVENT = 'internalSizeChanged';
-	private _emitInternalSizeEvent(): void {
-		this.emit(EditorScrollable._INTERNAL_SIZE_CHANGED_EVENT);
-	}
-	public addInternalSizeChangeListener(listener:()=>void): IDisposable {
-		return this.addListener2(EditorScrollable._INTERNAL_SIZE_CHANGED_EVENT, listener);
-	}
-}
\ No newline at end of file
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/linesLayout.ts
code:
@@ -6,6 +6,7 @@
 
 import * as editorCommon from 'vs/editor/common/editorCommon';
 import {VerticalObjects} from 'vs/editor/common/viewLayout/verticalObjects';
+import {Range} from 'vs/editor/common/core/range';
 
 /**
  * Layouting of objects that take vertical space (by having a height) and push down other objects.
@@ -20,13 +21,28 @@ export class LinesLayout {
 	private model: editorCommon.IViewModel;
 	private verticalObjects:VerticalObjects;
 
+	private _lineHeight: number;
+	private _scrollBeyondLastLine: boolean;
+
 	constructor(configuration: editorCommon.IConfiguration, model:editorCommon.IViewModel) {
 		this.configuration = configuration;
+		this._lineHeight = this.configuration.editor.lineHeight;
+		this._scrollBeyondLastLine = this.configuration.editor.scrollBeyondLastLine;
+
 		this.model = model;
 		this.verticalObjects = new VerticalObjects();
 		this.verticalObjects.replaceLines(model.getLineCount());
 	}
 
+	public onConfigurationChanged(e:editorCommon.IConfigurationChangedEvent): void {
+		if (e.lineHeight) {
+			this._lineHeight = this.configuration.editor.lineHeight;
+		}
+		if (e.scrollBeyondLastLine) {
+			this._scrollBeyondLastLine = this.configuration.editor.scrollBeyondLastLine;
+		}
+	}
+
 	/**
 	 * Insert a new whitespace of a certain height after a line number.
 	 * The whitespace has a "sticky" characteristic.
@@ -82,11 +98,11 @@ export class LinesLayout {
 	 * @return The sum of heights for all objects above `lineNumber`.
 	 */
 	public getVerticalOffsetForLineNumber(lineNumber:number): number {
-		return this.verticalObjects.getVerticalOffsetForLineNumber(lineNumber, this.configuration.editor.lineHeight);
+		return this.verticalObjects.getVerticalOffsetForLineNumber(lineNumber, this._lineHeight);
 	}
 
 	public getLinesTotalHeight(): number {
-		return this.verticalObjects.getTotalHeight(this.configuration.editor.lineHeight);
+		return this.verticalObjects.getTotalHeight(this._lineHeight);
 	}
 
 	/**
@@ -98,15 +114,15 @@ export class LinesLayout {
 	 * @param reserveHorizontalScrollbarHeight The height of the horizontal scrollbar.
 	 * @return Basically, the `scrollHeight` for the editor content.
 	 */
-	public getTotalHeight(viewport:editorCommon.IViewport, reserveHorizontalScrollbarHeight:number): number {
+	public getTotalHeight(viewport:editorCommon.Viewport, reserveHorizontalScrollbarHeight:number): number {
 		var totalLinesHeight = this.getLinesTotalHeight();
 
 //		if (this.context.configuration.editor.autoSize) {
 //			return linesHeight;
 //		}
 
-		if (this.configuration.editor.scrollBeyondLastLine) {
-			totalLinesHeight += viewport.height - this.configuration.editor.lineHeight;
+		if (this._scrollBeyondLastLine) {
+			totalLinesHeight += viewport.height - this._lineHeight;
 		} else {
 			totalLinesHeight += reserveHorizontalScrollbarHeight;
 		}
@@ -115,7 +131,7 @@ export class LinesLayout {
 	}
 
 	public isAfterLines(verticalOffset:number): boolean {
-		return this.verticalObjects.isAfterLines(verticalOffset, this.configuration.editor.lineHeight);
+		return this.verticalObjects.isAfterLines(verticalOffset, this._lineHeight);
 	}
 
 	/**
@@ -127,7 +143,7 @@ export class LinesLayout {
 	 * @return The line number at or after vertical offset `verticalOffset`.
 	 */
 	public getLineNumberAtOrAfterVerticalOffset(verticalOffset:number): number {
-		return this.verticalObjects.getLineNumberAtOrAfterVerticalOffset(verticalOffset, this.configuration.editor.lineHeight);
+		return this.verticalObjects.getLineNumberAtOrAfterVerticalOffset(verticalOffset, this._lineHeight);
 	}
 
 	/**
@@ -137,7 +153,7 @@ export class LinesLayout {
 	 * @return The height, in pixels, for line `lineNumber`.
 	 */
 	public getHeightForLineNumber(lineNumber:number): number {
-		return this.configuration.editor.lineHeight;
+		return this._lineHeight;
 	}
 
 	/**
@@ -146,12 +162,12 @@ export class LinesLayout {
 	 * @param viewport The viewport.
 	 * @return An array with all the whitespaces in the viewport. If no whitespace is in viewport, the array is empty.
 	 */
-	public getWhitespaceViewportData(visibleBox:editorCommon.IViewport): editorCommon.IViewWhitespaceViewportData[] {
-		return this.verticalObjects.getWhitespaceViewportData(visibleBox.top, visibleBox.top + visibleBox.height, this.configuration.editor.lineHeight);
+	public getWhitespaceViewportData(visibleBox:editorCommon.Viewport): editorCommon.IViewWhitespaceViewportData[] {
+		return this.verticalObjects.getWhitespaceViewportData(visibleBox.top, visibleBox.top + visibleBox.height, this._lineHeight);
 	}
 
 	public getWhitespaces(): editorCommon.IEditorWhitespace[] {
-		return this.verticalObjects.getWhitespaces(this.configuration.editor.lineHeight);
+		return this.verticalObjects.getWhitespaces(this._lineHeight);
 	}
 
 	/**
@@ -161,7 +177,7 @@ export class LinesLayout {
 	 * @return Precisely the whitespace that is layouted at `verticaloffset` or null.
 	 */
 	public getWhitespaceAtVerticalOffset(verticalOffset:number): editorCommon.IViewWhitespaceViewportData {
-		return this.verticalObjects.getWhitespaceAtVerticalOffset(verticalOffset, this.configuration.editor.lineHeight);
+		return this.verticalObjects.getWhitespaceAtVerticalOffset(verticalOffset, this._lineHeight);
 	}
 
 	/**
@@ -170,15 +186,17 @@ export class LinesLayout {
 	 * @param viewport The viewport.
 	 * @return A structure describing the lines positioned between `verticalOffset1` and `verticalOffset2`.
 	 */
-	public getLinesViewportData(visibleBox:editorCommon.IViewport): editorCommon.IViewLinesViewportData {
-
-		var viewportData = this.verticalObjects.getLinesViewportData(visibleBox.top, visibleBox.top + visibleBox.height, this.configuration.editor.lineHeight);
-
-		var decorationsResolver = this.model.getDecorationsResolver(viewportData.startLineNumber, viewportData.endLineNumber);
-		viewportData.getDecorationsInViewport = () => decorationsResolver.getDecorations();
-		viewportData.getInlineDecorationsForLineInViewport = (lineNumber:number) => decorationsResolver.getInlineDecorations(lineNumber);
+	public getLinesViewportData(visibleBox:editorCommon.Viewport): editorCommon.ViewLinesViewportData {
+		let partialData = this.verticalObjects.getLinesViewportData(visibleBox.top, visibleBox.top + visibleBox.height, this._lineHeight);
+		let decorationsData = this.model.getDecorationsViewportData(partialData.startLineNumber, partialData.endLineNumber);
+		let visibleRange = new Range(
+			partialData.startLineNumber,
+			1,
+			partialData.endLineNumber,
+			this.model.getLineMaxColumn(partialData.endLineNumber)
+		);
 
-		return viewportData;
+		return new editorCommon.ViewLinesViewportData(partialData, visibleRange, decorationsData);
 	}
 
 	/**
@@ -187,8 +205,8 @@ export class LinesLayout {
 	 * @param viewport The viewport.
 	 * @return The line number that is closest to the center of `viewport`.
 	 */
-	public getCenteredLineInViewport(visibleBox:editorCommon.IViewport): number {
-		return this.verticalObjects.getCenteredLineInViewport(visibleBox.top, visibleBox.top + visibleBox.height, this.configuration.editor.lineHeight);
+	public getCenteredLineInViewport(visibleBox:editorCommon.Viewport): number {
+		return this.verticalObjects.getCenteredLineInViewport(visibleBox.top, visibleBox.top + visibleBox.height, this._lineHeight);
 	}
 
 	/**

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/verticalObjects.ts
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {IEditorWhitespace, IViewLinesViewportData, IViewWhitespaceViewportData} from 'vs/editor/common/editorCommon';
+import {IEditorWhitespace, IPartialViewLinesViewportData, IViewWhitespaceViewportData} from 'vs/editor/common/editorCommon';
 import {WhitespaceComputer} from 'vs/editor/common/viewLayout/whitespaceComputer';
 
 /**
@@ -28,6 +28,7 @@ export class VerticalObjects {
 	private whitespaces:WhitespaceComputer;
 
 	constructor() {
+		this.linesCount = 0;
 		this.whitespaces = new WhitespaceComputer();
 	}
 
@@ -96,8 +97,10 @@ export class VerticalObjects {
 	 * @return The sum of heights for all objects.
 	 */
 	public getTotalHeight(deviceLineHeight:number): number {
-		var linesHeight = deviceLineHeight * this.linesCount;
-		var whitespacesHeight = this.whitespaces.getTotalHeight();
+		deviceLineHeight = deviceLineHeight|0;
+
+		let linesHeight = deviceLineHeight * this.linesCount;
+		let whitespacesHeight = this.whitespaces.getTotalHeight();
 		return linesHeight + whitespacesHeight;
 	}
 
@@ -109,15 +112,17 @@ export class VerticalObjects {
 	 * @return The sum of heights for all objects above `lineNumber`.
 	 */
 	public getVerticalOffsetForLineNumber(lineNumber:number, deviceLineHeight:number): number {
+		lineNumber = lineNumber|0;
+		deviceLineHeight = deviceLineHeight|0;
 
-		var previousLinesHeight:number;
+		let previousLinesHeight:number;
 		if (lineNumber > 1) {
 			previousLinesHeight = deviceLineHeight * (lineNumber - 1);
 		} else {
 			previousLinesHeight = 0;
 		}
 
-		var previousWhitespacesHeight = this.whitespaces.getAccumulatedHeightBeforeLineNumber(lineNumber);
+		let previousWhitespacesHeight = this.whitespaces.getAccumulatedHeightBeforeLineNumber(lineNumber);
 
 		return previousLinesHeight + previousWhitespacesHeight;
 	}
@@ -139,7 +144,7 @@ export class VerticalObjects {
 	}
 
 	public isAfterLines(verticalOffset:number, deviceLineHeight:number): boolean {
-		var totalHeight = this.getTotalHeight(deviceLineHeight);
+		let totalHeight = this.getTotalHeight(deviceLineHeight);
 		return verticalOffset > totalHeight;
 	}
 
@@ -153,24 +158,23 @@ export class VerticalObjects {
 	 * @return The line number at or after vertical offset `verticalOffset`.
 	 */
 	public getLineNumberAtOrAfterVerticalOffset(verticalOffset:number, deviceLineHeight:number): number {
+		verticalOffset = verticalOffset|0;
+		deviceLineHeight = deviceLineHeight|0;
 
 		if (verticalOffset < 0) {
 			return 1;
 		}
 
-		var minLineNumber = 1,
-			maxLineNumber = this.linesCount,
-			midLineNumber:number,
-			midLineNumberVerticalOffset:number,
-			midLineNumberHeight:number;
+		let minLineNumber = 1;
+		let linesCount = this.linesCount|0;
+		let maxLineNumber = linesCount;
 
 		while (minLineNumber < maxLineNumber) {
-			midLineNumber = Math.floor((minLineNumber + maxLineNumber) / 2);
+			let midLineNumber = ((minLineNumber + maxLineNumber) / 2)|0;
 
-			midLineNumberVerticalOffset = this.getVerticalOffsetForLineNumber(midLineNumber, deviceLineHeight);
-			midLineNumberHeight = deviceLineHeight;
+			let midLineNumberVerticalOffset = this.getVerticalOffsetForLineNumber(midLineNumber, deviceLineHeight)|0;
 
-			if (verticalOffset >= midLineNumberVerticalOffset + midLineNumberHeight) {
+			if (verticalOffset >= midLineNumberVerticalOffset + deviceLineHeight) {
 				// vertical offset is after mid line number
 				minLineNumber = midLineNumber + 1;
 			} else if (verticalOffset >= midLineNumberVerticalOffset) {
@@ -182,8 +186,8 @@ export class VerticalObjects {
 			}
 		}
 
-		if (minLineNumber > this.linesCount) {
-			return this.linesCount;
+		if (minLineNumber > linesCount) {
+			return linesCount;
 		}
 
 		return minLineNumber;
@@ -198,13 +202,17 @@ export class VerticalObjects {
 	 * @return The line number that is closest to the center between `verticalOffset1` and `verticalOffset2`.
 	 */
 	public getCenteredLineInViewport(verticalOffset1:number, verticalOffset2:number, deviceLineHeight:number): number {
-		var viewportData = this.getLinesViewportData(verticalOffset1, verticalOffset2, deviceLineHeight);
+		verticalOffset1 = verticalOffset1|0;
+		verticalOffset2 = verticalOffset2|0;
+		deviceLineHeight = deviceLineHeight|0;
+
+		let viewportData = this.getLinesViewportData(verticalOffset1, verticalOffset2, deviceLineHeight);
 
-		var verticalCenter = (verticalOffset2 - verticalOffset1) / 2;
-		var currentLineActualTop: number,
+		let verticalCenter = (verticalOffset2 - verticalOffset1) / 2;
+		let currentLineActualTop: number,
 			currentLineActualBottom: number;
 
-		for (var lineNumber = viewportData.startLineNumber; lineNumber <= viewportData.endLineNumber; lineNumber++) {
+		for (let lineNumber = viewportData.startLineNumber; lineNumber <= viewportData.endLineNumber; lineNumber++) {
 
 			currentLineActualTop = viewportData.visibleRangesDeltaTop + viewportData.relativeVerticalOffset[lineNumber - viewportData.startLineNumber];
 			currentLineActualBottom = currentLineActualTop + deviceLineHeight;
@@ -225,34 +233,39 @@ export class VerticalObjects {
 	 * @param deviceLineHeight The height, in pixels, for one rendered line.
 	 * @return A structure describing the lines positioned between `verticalOffset1` and `verticalOffset2`.
 	 */
-	public getLinesViewportData(verticalOffset1:number, verticalOffset2:number, deviceLineHeight:number): IViewLinesViewportData {
+	public getLinesViewportData(verticalOffset1:number, verticalOffset2:number, deviceLineHeight:number): IPartialViewLinesViewportData {
+		verticalOffset1 = verticalOffset1|0;
+		verticalOffset2 = verticalOffset2|0;
+		deviceLineHeight = deviceLineHeight|0;
+
 		// Find first line number
 		// We don't live in a perfect world, so the line number might start before or after verticalOffset1
-		var startLineNumber = this.getLineNumberAtOrAfterVerticalOffset(verticalOffset1, deviceLineHeight);
+		let startLineNumber = this.getLineNumberAtOrAfterVerticalOffset(verticalOffset1, deviceLineHeight)|0;
 
-		var endLineNumber = this.linesCount,
-			startLineNumberVerticalOffset = this.getVerticalOffsetForLineNumber(startLineNumber, deviceLineHeight);
+		let endLineNumber = this.linesCount|0;
+		let startLineNumberVerticalOffset = this.getVerticalOffsetForLineNumber(startLineNumber, deviceLineHeight)|0;
 
 		// Also keep track of what whitespace we've got
-		var whitespaceIndex = this.whitespaces.getFirstWhitespaceIndexAfterLineNumber(startLineNumber),
-			whitespaceCount = this.whitespaces.getCount(),
-			currentWhitespaceHeight: number,
-			currentWhitespaceAfterLineNumber: number;
+		let whitespaceIndex = this.whitespaces.getFirstWhitespaceIndexAfterLineNumber(startLineNumber)|0;
+		let whitespaceCount = this.whitespaces.getCount()|0;
+		let currentWhitespaceHeight: number;
+		let currentWhitespaceAfterLineNumber: number;
 
 		if (whitespaceIndex === -1) {
 			whitespaceIndex = whitespaceCount;
 			currentWhitespaceAfterLineNumber = endLineNumber + 1;
+			currentWhitespaceHeight = 0;
 		} else {
-			currentWhitespaceAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex);
-			currentWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(whitespaceIndex);
+			currentWhitespaceAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex)|0;
+			currentWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(whitespaceIndex)|0;
 		}
 
-		var currentVerticalOffset = startLineNumberVerticalOffset;
-		var currentLineRelativeOffset = currentVerticalOffset;
+		let currentVerticalOffset = startLineNumberVerticalOffset;
+		let currentLineRelativeOffset = currentVerticalOffset;
 
 		// IE (all versions) cannot handle units above about 1,533,908 px, so every 500k pixels bring numbers down
-		var STEP_SIZE = 500000;
-		var bigNumbersDelta = 0;
+		const STEP_SIZE = 500000;
+		let bigNumbersDelta = 0;
 		if (startLineNumberVerticalOffset >= STEP_SIZE) {
 			// Compute a delta that guarantees that lines are positioned at `lineHeight` increments
 			bigNumbersDelta = Math.floor(startLineNumberVerticalOffset / STEP_SIZE) * STEP_SIZE;
@@ -261,10 +274,10 @@ export class VerticalObjects {
 			currentLineRelativeOffset -= bigNumbersDelta;
 		}
 
-		var linesOffsets:number[] = [];
+		let linesOffsets:number[] = [];
 
 		// Figure out how far the lines go
-		for (var lineNumber = startLineNumber; lineNumber <= endLineNumber; lineNumber++) {
+		for (let lineNumber = startLineNumber; lineNumber <= endLineNumber; lineNumber++) {
 
 			// Count current line height in the vertical offsets
 			currentVerticalOffset += deviceLineHeight;
@@ -283,8 +296,8 @@ export class VerticalObjects {
 				if (whitespaceIndex >= whitespaceCount) {
 					currentWhitespaceAfterLineNumber = endLineNumber + 1;
 				} else {
-					currentWhitespaceAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex);
-					currentWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(whitespaceIndex);
+					currentWhitespaceAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex)|0;
+					currentWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(whitespaceIndex)|0;
 				}
 			}
 
@@ -302,25 +315,24 @@ export class VerticalObjects {
 			startLineNumber: startLineNumber,
 			endLineNumber: endLineNumber,
 			visibleRangesDeltaTop: -(verticalOffset1 - bigNumbersDelta),
-			relativeVerticalOffset: linesOffsets,
-			visibleRange: null, // This will be filled in by someone else :) (hint: viewLines)
-			getInlineDecorationsForLineInViewport: null, // This will be filled in by linesLayout
-			getDecorationsInViewport: null // This will be filled in by linesLayout
+			relativeVerticalOffset: linesOffsets
 		};
 	}
 
 	public getVerticalOffsetForWhitespaceIndex(whitespaceIndex:number, deviceLineHeight:number): number {
+		whitespaceIndex = whitespaceIndex|0;
+		deviceLineHeight = deviceLineHeight|0;
 
-		var afterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex);
+		let afterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(whitespaceIndex);
 
-		var previousLinesHeight:number;
+		let previousLinesHeight:number;
 		if (afterLineNumber >= 1) {
 			previousLinesHeight = deviceLineHeight * afterLineNumber;
 		} else {
 			previousLinesHeight = 0;
 		}
 
-		var previousWhitespacesHeight:number;
+		let previousWhitespacesHeight:number;
 		if (whitespaceIndex > 0) {
 			previousWhitespacesHeight = this.whitespaces.getAccumulatedHeight(whitespaceIndex - 1);
 		} else {
@@ -330,8 +342,10 @@ export class VerticalObjects {
 	}
 
 	public getWhitespaceIndexAtOrAfterVerticallOffset(verticalOffset:number, deviceLineHeight:number): number {
+		verticalOffset = verticalOffset|0;
+		deviceLineHeight = deviceLineHeight|0;
 
-		var midWhitespaceIndex:number,
+		let midWhitespaceIndex:number,
 			minWhitespaceIndex = 0,
 			maxWhitespaceIndex = this.whitespaces.getCount() - 1,
 			midWhitespaceVerticalOffset:number,
@@ -342,8 +356,8 @@ export class VerticalObjects {
 		}
 
 		// Special case: nothing to be found
-		var maxWhitespaceVerticalOffset = this.getVerticalOffsetForWhitespaceIndex(maxWhitespaceIndex, deviceLineHeight);
-		var maxWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(maxWhitespaceIndex);
+		let maxWhitespaceVerticalOffset = this.getVerticalOffsetForWhitespaceIndex(maxWhitespaceIndex, deviceLineHeight);
+		let maxWhitespaceHeight = this.whitespaces.getHeightForWhitespaceIndex(maxWhitespaceIndex);
 		if (verticalOffset >= maxWhitespaceVerticalOffset + maxWhitespaceHeight) {
 			return -1;
 		}
@@ -376,8 +390,10 @@ export class VerticalObjects {
 	 * @return Precisely the whitespace that is layouted at `verticaloffset` or null.
 	 */
 	public getWhitespaceAtVerticalOffset(verticalOffset:number, deviceLineHeight:number): IViewWhitespaceViewportData {
+		verticalOffset = verticalOffset|0;
+		deviceLineHeight = deviceLineHeight|0;
 
-		var candidateIndex = this.getWhitespaceIndexAtOrAfterVerticallOffset(verticalOffset, deviceLineHeight);
+		let candidateIndex = this.getWhitespaceIndexAtOrAfterVerticallOffset(verticalOffset, deviceLineHeight);
 
 		if (candidateIndex < 0) {
 			return null;
@@ -387,15 +403,15 @@ export class VerticalObjects {
 			return null;
 		}
 
-		var candidateTop = this.getVerticalOffsetForWhitespaceIndex(candidateIndex, deviceLineHeight);
+		let candidateTop = this.getVerticalOffsetForWhitespaceIndex(candidateIndex, deviceLineHeight);
 
 		if (candidateTop > verticalOffset) {
 			return null;
 		}
 
-		var candidateHeight = this.whitespaces.getHeightForWhitespaceIndex(candidateIndex);
-		var candidateId = this.whitespaces.getIdForWhitespaceIndex(candidateIndex);
-		var candidateAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(candidateIndex);
+		let candidateHeight = this.whitespaces.getHeightForWhitespaceIndex(candidateIndex);
+		let candidateId = this.whitespaces.getIdForWhitespaceIndex(candidateIndex);
+		let candidateAfterLineNumber = this.whitespaces.getAfterLineNumberForWhitespaceIndex(candidateIndex);
 
 		return {
 			id: candidateId,
@@ -414,15 +430,18 @@ export class VerticalObjects {
 	 * @return An array with all the whitespaces in the viewport. If no whitespace is in viewport, the array is empty.
 	 */
 	public getWhitespaceViewportData(verticalOffset1:number, verticalOffset2:number, deviceLineHeight:number): IViewWhitespaceViewportData[] {
+		verticalOffset1 = verticalOffset1|0;
+		verticalOffset2 = verticalOffset2|0;
+		deviceLineHeight = deviceLineHeight|0;
 
-		var startIndex = this.getWhitespaceIndexAtOrAfterVerticallOffset(verticalOffset1, deviceLineHeight);
-		var endIndex = this.whitespaces.getCount() - 1;
+		let startIndex = this.getWhitespaceIndexAtOrAfterVerticallOffset(verticalOffset1, deviceLineHeight);
+		let endIndex = this.whitespaces.getCount() - 1;
 
 		if (startIndex < 0) {
 			return [];
 		}
 
-		var result: IViewWhitespaceViewportData[] = [],
+		let result: IViewWhitespaceViewportData[] = [],
 			i:number,
 			top:number,
 			height:number;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/viewLineParts.ts
code:
@@ -6,12 +6,12 @@
 
 import * as strings from 'vs/base/common/strings';
 import {Arrays} from 'vs/editor/common/core/arrays';
-import {ILineToken, IRange, IViewLineTokens} from 'vs/editor/common/editorCommon';
+import {LineToken, IEditorRange, IViewLineTokens} from 'vs/editor/common/editorCommon';
 import {Range} from 'vs/editor/common/core/range';
 
 export interface ILineParts {
 
-	getParts(): ILineToken[];
+	getParts(): LineToken[];
 
 	equals(other:ILineParts): boolean;
 
@@ -22,10 +22,10 @@ function cmpLineDecorations(a:ILineDecoration, b:ILineDecoration): number {
 	return Range.compareRangesUsingStarts(a.range, b.range);
 }
 
-export function createLineParts(lineNumber:number, minLineColumn:number, lineContent:string, lineTokens:IViewLineTokens, rawLineDecorations:ILineDecoration[], renderWhitespace:boolean): ILineParts {
+export function createLineParts(lineNumber:number, minLineColumn:number, lineContent:string, tabSize:number, lineTokens:IViewLineTokens, rawLineDecorations:ILineDecoration[], renderWhitespace:boolean): ILineParts {
 	if (renderWhitespace) {
 		let oldLength = rawLineDecorations.length;
-		rawLineDecorations = insertWhitespace(lineNumber, lineContent, lineTokens.getFauxIndentLength(), rawLineDecorations);
+		rawLineDecorations = insertWhitespace(lineNumber, lineContent, tabSize, lineTokens.getFauxIndentLength(), rawLineDecorations);
 		if (rawLineDecorations.length !== oldLength) {
 			rawLineDecorations.sort(cmpLineDecorations);
 		}
@@ -38,7 +38,7 @@ export function createLineParts(lineNumber:number, minLineColumn:number, lineCon
 	}
 }
 
-function trimEmptyTrailingPart(parts: LinePart[], lineContent: string): LinePart[] {
+function trimEmptyTrailingPart(parts: LineToken[], lineContent: string): LineToken[] {
 	if (parts.length <= 1) {
 		return parts;
 	}
@@ -51,97 +51,97 @@ function trimEmptyTrailingPart(parts: LinePart[], lineContent: string): LinePart
 	return parts.slice(0, parts.length - 1);
 }
 
-function insertWhitespace(lineNumber:number, lineContent: string, fauxIndentLength: number, rawLineDecorations: ILineDecoration[]): ILineDecoration[] {
-	if (lineContent.length === 0) {
+const _tab = '\t'.charCodeAt(0);
+const _space = ' '.charCodeAt(0);
+
+function insertOneWhitespace(dest:ILineDecoration[], lineNumber:number, startColumn:number, endColumn:number, className:string): void {
+	dest.push({
+		range: new Range(lineNumber, startColumn, lineNumber, endColumn),
+		options: {
+			inlineClassName: className
+		}
+	});
+}
+
+function insertWhitespace(lineNumber:number, lineContent: string, tabSize:number, fauxIndentLength: number, rawLineDecorations: ILineDecoration[]): ILineDecoration[] {
+	let lineLength = lineContent.length;
+	if (lineLength === fauxIndentLength) {
 		return rawLineDecorations;
 	}
 
-	var prepend: IRange = null,
-		append: IRange = null,
-		computeTrailing = true;
-
-	var firstNonWhitespaceIndex = strings.firstNonWhitespaceIndex(lineContent);
-
-	if (firstNonWhitespaceIndex !== 0) {
-		// There is leading whitespace
-		if (firstNonWhitespaceIndex === -1) {
-			// The entire string is whitespace
-			computeTrailing = false;
-			prepend = {
-				startLineNumber: lineNumber,
-				endLineNumber: lineNumber,
-				startColumn: 1,
-				endColumn: lineContent.length + 1
-			};
-		} else {
-			prepend = {
-				startLineNumber: lineNumber,
-				endLineNumber: lineNumber,
-				startColumn: 1,
-				endColumn: firstNonWhitespaceIndex + 1
-			};
-		}
+	let firstChar = lineContent.charCodeAt(fauxIndentLength);
+	let lastChar = lineContent.charCodeAt(lineLength - 1);
+
+	if (firstChar !== _tab && firstChar !== _space && lastChar !== _tab && lastChar !== _space) {
+		// This line contains no leading nor trailing whitespace => fast path
+		return rawLineDecorations;
+	}
+
+	let firstNonWhitespaceIndex = strings.firstNonWhitespaceIndex(lineContent);
+	let lastNonWhitespaceIndex: number;
+	if (firstNonWhitespaceIndex === -1) {
+		// The entire line is whitespace
+		firstNonWhitespaceIndex = lineLength;
+		lastNonWhitespaceIndex = lineLength;
+	} else {
+		lastNonWhitespaceIndex = strings.lastNonWhitespaceIndex(lineContent);
 	}
 
-	// Adjust prepend to `fauxIndentLength`
-	if (prepend) {
-		if (fauxIndentLength + 1 >= prepend.endColumn) {
-			prepend = null;
+	let result = rawLineDecorations.slice(0);
+	let tmpIndent = 0;
+	let whitespaceStartColumn = fauxIndentLength + 1;
+	for (let i = fauxIndentLength; i < lineLength; i++) {
+		let chCode = lineContent.charCodeAt(i);
+
+		if (chCode === _tab) {
+			tmpIndent = tabSize;
 		} else {
-			prepend.startColumn = fauxIndentLength + 1;
+			tmpIndent++;
 		}
-	}
 
-	if (computeTrailing) {
-		var lastNonWhitespaceIndex = strings.lastNonWhitespaceIndex(lineContent);
-		if (lastNonWhitespaceIndex !== lineContent.length - 1) {
-			// There is trailing whitespace
-			// No need to handle the case that the entire string is empty, since it is handled above
-			append = {
-				startLineNumber: lineNumber,
-				endLineNumber: lineNumber,
-				startColumn: lastNonWhitespaceIndex + 2,
-				endColumn: lineContent.length + 1
-			};
+		if (i < firstNonWhitespaceIndex) {
+			// in leading whitespace
+			// push for every indent or when the end of the leading whitespace is reached
+			if (tmpIndent >= tabSize || i === firstNonWhitespaceIndex - 1) {
+				insertOneWhitespace(result, lineNumber, whitespaceStartColumn, i + 2, 'leading whitespace');
+				whitespaceStartColumn = i + 2;
+				tmpIndent = 0;
+			}
+			continue;
 		}
-	}
 
-	if (prepend || append) {
-		var result = rawLineDecorations.slice(0);
-		if (prepend) {
-			result.unshift({
-				options: {
-					inlineClassName: 'leading whitespace'
-				},
-				range: prepend
-			});
+		if (i > lastNonWhitespaceIndex) {
+			// in trailing whitespace
+			// push for every indent or when the end of the string is reached
+			if (tmpIndent >= tabSize || i === lineLength - 1) {
+				insertOneWhitespace(result, lineNumber, whitespaceStartColumn, i + 2, 'trailing whitespace');
+				whitespaceStartColumn = i + 2;
+				tmpIndent = 0;
+			}
+			continue;
 		}
-		if (append) {
-			result.push({
-				options: {
-					inlineClassName: 'trailing whitespace'
-				},
-				range: append
-			});
+
+		if (i === lastNonWhitespaceIndex) {
+			whitespaceStartColumn = i + 2;
+			tmpIndent = tmpIndent % tabSize;
 		}
-		return result;
 	}
 
-	return rawLineDecorations;
+	return result;
 }
 
 export class FastViewLineParts implements ILineParts {
 
 	private lineTokens: IViewLineTokens;
-	private parts: LinePart[];
+	private parts: LineToken[];
 
 	constructor(lineTokens:IViewLineTokens, lineContent:string) {
 		this.lineTokens = lineTokens;
 		this.parts = lineTokens.getTokens();
 		this.parts = trimEmptyTrailingPart(this.parts, lineContent);
 	}
 
-	public getParts(): ILineToken[]{
+	public getParts(): LineToken[]{
 		return this.parts;
 	}
 
@@ -161,7 +161,7 @@ export class FastViewLineParts implements ILineParts {
 
 export class ViewLineParts implements ILineParts {
 
-	private parts:LinePart[];
+	private parts:LineToken[];
 	private lastPartIndex:number;
 	private lastEndOffset:number;
 
@@ -177,7 +177,7 @@ export class ViewLineParts implements ILineParts {
 			currentTokenEndOffset:number,
 			currentTokenClassName:string;
 
-		var parts:LinePart[] = [];
+		var parts:LineToken[] = [];
 
 		for (var i = 0, len = actualLineTokens.length; i < len; i++) {
 			nextStartOffset = actualLineTokens[i].startIndex;
@@ -187,11 +187,11 @@ export class ViewLineParts implements ILineParts {
 			while (lineDecorationsIndex < lineDecorationsLength && lineDecorations[lineDecorationsIndex].startOffset < currentTokenEndOffset) {
 				if (lineDecorations[lineDecorationsIndex].startOffset > nextStartOffset) {
 					// the first decorations starts after the token
-					parts.push(new LinePart(nextStartOffset, currentTokenClassName));
+					parts.push(new LineToken(nextStartOffset, currentTokenClassName));
 					nextStartOffset = lineDecorations[lineDecorationsIndex].startOffset;
 				}
 
-				parts.push(new LinePart(nextStartOffset, currentTokenClassName + ' ' + lineDecorations[lineDecorationsIndex].className));
+				parts.push(new LineToken(nextStartOffset, currentTokenClassName + ' ' + lineDecorations[lineDecorationsIndex].className));
 
 				if (lineDecorations[lineDecorationsIndex].endOffset >= currentTokenEndOffset) {
 					// this decoration goes on to the next token
@@ -205,7 +205,7 @@ export class ViewLineParts implements ILineParts {
 			}
 
 			if (nextStartOffset < currentTokenEndOffset) {
-				parts.push(new LinePart(nextStartOffset, currentTokenClassName));
+				parts.push(new LineToken(nextStartOffset, currentTokenClassName));
 			}
 		}
 
@@ -214,7 +214,7 @@ export class ViewLineParts implements ILineParts {
 		this.lastEndOffset = currentTokenEndOffset;
 	}
 
-	public getParts(): ILineToken[] {
+	public getParts(): LineToken[] {
 		return this.parts;
 	}
 
@@ -245,16 +245,6 @@ export class ViewLineParts implements ILineParts {
 	}
 }
 
-class LinePart implements ILineToken {
-	startIndex:number;
-	type:string;
-
-	constructor(startIndex:number, type:string) {
-		this.startIndex = startIndex;
-		this.type = type;
-	}
-}
-
 export class DecorationSegment {
 	startOffset:number;
 	endOffset:number;
@@ -327,7 +317,7 @@ class Stack {
 }
 
 export interface ILineDecoration {
-	range: IRange;
+	range: IEditorRange;
 	options: {
 		inlineClassName?: string;
 	};

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/viewLineRenderer.ts
code:
@@ -4,20 +4,39 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-import {ILineToken} from 'vs/editor/common/editorCommon';
+import {LineToken} from 'vs/editor/common/editorCommon';
+
+export class RenderLineInput {
+	public _renderLineInputTrait: void;
 
-export interface IRenderLineInput {
 	lineContent: string;
 	tabSize: number;
+	spaceWidth: number;
 	stopRenderingLineAfter: number;
 	renderWhitespace: boolean;
-	parts: ILineToken[];
+	parts: LineToken[];
+
+	constructor(
+		lineContent: string,
+		tabSize: number,
+		spaceWidth: number,
+		stopRenderingLineAfter: number,
+		renderWhitespace: boolean,
+		parts: LineToken[]
+	) {
+		this.lineContent = lineContent;
+		this.tabSize = tabSize;
+		this.spaceWidth = spaceWidth;
+		this.stopRenderingLineAfter = stopRenderingLineAfter;
+		this.renderWhitespace = renderWhitespace;
+		this.parts = parts;
+	}
 }
 
 export interface IRenderLineOutput {
 	charOffsetInPart: number[];
 	lastRenderedPartIndex: number;
-	output: string[];
+	output: string;
 }
 
 const _space = ' '.charCodeAt(0);
@@ -29,10 +48,11 @@ const _carriageReturn = '\r'.charCodeAt(0);
 const _lineSeparator = '\u2028'.charCodeAt(0); //http://www.fileformat.info/info/unicode/char/2028/index.htm
 const _bom = 65279;
 
-export function renderLine(input:IRenderLineInput): IRenderLineOutput {
+export function renderLine(input:RenderLineInput): IRenderLineOutput {
 	const lineText = input.lineContent;
 	const lineTextLength = lineText.length;
 	const tabSize = input.tabSize;
+	const spaceWidth = input.spaceWidth;
 	const actualLineParts = input.parts;
 	const renderWhitespace = input.renderWhitespace;
 	const charBreakIndex = (input.stopRenderingLineAfter === -1 ? lineTextLength : input.stopRenderingLineAfter - 1);
@@ -42,108 +62,170 @@ export function renderLine(input:IRenderLineInput): IRenderLineOutput {
 			charOffsetInPart: [],
 			lastRenderedPartIndex: 0,
 			// This is basically for IE's hit test to work
-			output: ['<span><span>&nbsp;</span></span>']
+			output: '<span><span>&nbsp;</span></span>'
 		};
 	}
 
 	if (actualLineParts.length === 0) {
 		throw new Error('Cannot render non empty line without line parts!');
 	}
 
+	return renderLineActual(lineText, lineTextLength, tabSize, spaceWidth, actualLineParts.slice(0), renderWhitespace, charBreakIndex);
+}
+
+const WHITESPACE_TOKEN_TEST = /\bwhitespace\b/;
+function isWhitespace(type:string): boolean {
+	return WHITESPACE_TOKEN_TEST.test(type);
+}
+
+function renderLineActual(lineText:string, lineTextLength:number, tabSize:number, spaceWidth:number, actualLineParts:LineToken[], renderWhitespace:boolean, charBreakIndex:number): IRenderLineOutput {
+	lineTextLength = +lineTextLength;
+	tabSize = +tabSize;
+	charBreakIndex = +charBreakIndex;
+
 	let charIndex = 0;
-	let out: string[] = [];
+	let out = '';
 	let charOffsetInPartArr: number[] = [];
 	let charOffsetInPart = 0;
 	let tabsCharDelta = 0;
 
-	out.push('<span>');
+	out += '<span>';
 	for (let partIndex = 0, partIndexLen = actualLineParts.length; partIndex < partIndexLen; partIndex++) {
 		let part = actualLineParts[partIndex];
 
-		out.push('<span class="');
-		out.push('token ');
-		out.push(part.type.replace(/[^a-z0-9\-]/gi, ' '));
-		out.push('">');
-
 		let partRendersWhitespace = false;
 		if (renderWhitespace) {
-			partRendersWhitespace = (/\bwhitespace\b/.test(part.type));
+			partRendersWhitespace = isWhitespace(part.type);
 		}
 
 		let toCharIndex = lineTextLength;
 		if (partIndex + 1 < partIndexLen) {
-			toCharIndex = Math.min(lineTextLength, actualLineParts[partIndex + 1].startIndex);
+			let nextPart = actualLineParts[partIndex + 1];
+			toCharIndex = Math.min(lineTextLength, nextPart.startIndex);
 		}
 
 		charOffsetInPart = 0;
-		for (; charIndex < toCharIndex; charIndex++) {
-			charOffsetInPartArr[charIndex] = charOffsetInPart;
-			let charCode = lineText.charCodeAt(charIndex);
+		if (partRendersWhitespace) {
+
+			let partContentCnt = 0;
+			let partContent = '';
+			for (; charIndex < toCharIndex; charIndex++) {
+				charOffsetInPartArr[charIndex] = charOffsetInPart;
+				let charCode = lineText.charCodeAt(charIndex);
 
-			switch (charCode) {
-				case _tab:
+				if (charCode === _tab) {
 					let insertSpacesCount = tabSize - (charIndex + tabsCharDelta) % tabSize;
 					tabsCharDelta += insertSpacesCount - 1;
 					charOffsetInPart += insertSpacesCount - 1;
 					if (insertSpacesCount > 0) {
-						out.push(partRendersWhitespace ? '&rarr;' : '&nbsp;');
+						partContent += '&rarr;';
+						partContentCnt++;
 						insertSpacesCount--;
 					}
 					while (insertSpacesCount > 0) {
-						out.push('&nbsp;');
+						partContent += '&nbsp;';
+						partContentCnt++;
 						insertSpacesCount--;
 					}
-					break;
-
-				case _space:
-					out.push(partRendersWhitespace ? '&middot;' : '&nbsp;');
-					break;
-
-				case _lowerThan:
-					out.push('&lt;');
-					break;
-
-				case _greaterThan:
-					out.push('&gt;');
-					break;
-
-				case _ampersand:
-					out.push('&amp;');
-					break;
-
-				case 0:
-					out.push('&#00;');
-					break;
-
-				case _bom:
-				case _lineSeparator:
-					out.push('\ufffd');
-					break;
-
-				case _carriageReturn:
-					// zero width space, because carriage return would introduce a line break
-					out.push('&#8203');
-					break;
-
-				default:
-					out.push(lineText.charAt(charIndex));
+				} else {
+					// must be _space
+					partContent += '&middot;';
+					partContentCnt++;
+				}
+
+				charOffsetInPart ++;
+
+				if (charIndex >= charBreakIndex) {
+					out += '<span class="token '+part.type+'" style="width:'+(spaceWidth * partContentCnt)+'px">';
+					out += partContent;
+					out += '&hellip;</span></span>';
+					charOffsetInPartArr[charIndex] = charOffsetInPart;
+					return {
+						charOffsetInPart: charOffsetInPartArr,
+						lastRenderedPartIndex: partIndex,
+						output: out
+					};
+				}
 			}
-
-			charOffsetInPart ++;
-
-			if (charIndex >= charBreakIndex) {
-				out.push('&hellip;</span></span>');
-				charOffsetInPartArr[charOffsetInPartArr.length - 1]++;
-				return {
-					charOffsetInPart: charOffsetInPartArr,
-					lastRenderedPartIndex: partIndex,
-					output: out
-				};
+			out += '<span class="token '+part.type+'" style="width:'+(spaceWidth * partContentCnt)+'px">';
+			out += partContent;
+			out += '</span>';
+		} else {
+			out += '<span class="token ';
+			out += part.type;
+			out += '">';
+
+			for (; charIndex < toCharIndex; charIndex++) {
+				charOffsetInPartArr[charIndex] = charOffsetInPart;
+				let charCode = lineText.charCodeAt(charIndex);
+
+				switch (charCode) {
+					case _tab:
+						let insertSpacesCount = tabSize - (charIndex + tabsCharDelta) % tabSize;
+						tabsCharDelta += insertSpacesCount - 1;
+						charOffsetInPart += insertSpacesCount - 1;
+						if (insertSpacesCount > 0) {
+							out += '&nbsp;';
+							insertSpacesCount--;
+						}
+						while (insertSpacesCount > 0) {
+							out += '&nbsp;';
+							insertSpacesCount--;
+						}
+						break;
+
+					case _space:
+						out += '&nbsp;';
+						break;
+
+					case _lowerThan:
+						out += '&lt;';
+						break;
+
+					case _greaterThan:
+						out += '&gt;';
+						break;
+
+					case _ampersand:
+						out += '&amp;';
+						break;
+
+					case 0:
+						out += '&#00;';
+						break;
+
+					case _bom:
+					case _lineSeparator:
+						out += '\ufffd';
+						break;
+
+					case _carriageReturn:
+						// zero width space, because carriage return would introduce a line break
+						out += '&#8203';
+						break;
+
+					default:
+						out += lineText.charAt(charIndex);
+				}
+
+				charOffsetInPart ++;
+
+				if (charIndex >= charBreakIndex) {
+					out += '&hellip;</span></span>';
+					charOffsetInPartArr[charIndex] = charOffsetInPart;
+					return {
+						charOffsetInPart: charOffsetInPartArr,
+						lastRenderedPartIndex: partIndex,
+						output: out
+					};
+				}
 			}
+
+			out += '</span>';
 		}
-		out.push('</span>');
+
 	}
-	out.push('</span>');
+	out += '</span>';
 
 	// When getting client rects for the last character, we will position the
 	// text range at the end of the span, insteaf of at the beginning of next span

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewLayout/whitespaceComputer.ts
code:
@@ -103,29 +103,35 @@ export class WhitespaceComputer {
 	 * @return An id that can be used later to mutate or delete the whitespace
 	 */
 	public insertWhitespace(afterLineNumber:number, ordinal:number, heightInPx:number): number {
+		afterLineNumber = afterLineNumber|0;
+		ordinal = ordinal|0;
+		heightInPx = heightInPx|0;
+
 		var id = (++this.lastWhitespaceId);
 		var insertionIndex = WhitespaceComputer.findInsertionIndex(this.afterLineNumbers, afterLineNumber, this.ordinals, ordinal);
 		this.insertWhitespaceAtIndex(id, insertionIndex, afterLineNumber, ordinal, heightInPx);
 		return id;
 	}
 
 	private insertWhitespaceAtIndex(id:number, insertIndex:number, afterLineNumber:number, ordinal:number, heightInPx:number): void {
+		id = id|0;
+		insertIndex = insertIndex|0;
+		afterLineNumber = afterLineNumber|0;
+		ordinal = ordinal|0;
+		heightInPx = heightInPx|0;
 
 		this.heights.splice(insertIndex, 0, heightInPx);
 		this.ids.splice(insertIndex, 0, id);
 		this.afterLineNumbers.splice(insertIndex, 0, afterLineNumber);
 		this.ordinals.splice(insertIndex, 0, ordinal);
 		this.prefixSum.splice(insertIndex, 0, 0);
 
-		var sid:string,
-			oldIndex:number;
-
-		for (sid in this.whitespaceId2Index) {
-			if (this.whitespaceId2Index.hasOwnProperty(sid)) {
-				oldIndex = this.whitespaceId2Index[sid];
-				if (oldIndex >= insertIndex) {
-					this.whitespaceId2Index[sid] = oldIndex + 1;
-				}
+		let keys = Object.keys(this.whitespaceId2Index);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let sid = keys[i];
+			let oldIndex = this.whitespaceId2Index[sid];
+			if (oldIndex >= insertIndex) {
+				this.whitespaceId2Index[sid] = oldIndex + 1;
 			}
 		}
 
@@ -134,6 +140,10 @@ export class WhitespaceComputer {
 	}
 
 	public changeWhitespace(id:number, newAfterLineNumber:number, newHeight:number): boolean {
+		id = id|0;
+		newAfterLineNumber = newAfterLineNumber|0;
+		newHeight = newHeight|0;
+
 		let hasChanges = false;
 		hasChanges = this.changeWhitespaceHeight(id, newHeight) || hasChanges;
 		hasChanges = this.changeWhitespaceAfterLineNumber(id, newAfterLineNumber) || hasChanges;
@@ -148,6 +158,9 @@ export class WhitespaceComputer {
 	 * @return Returns true if the whitespace is found and if the new height is different than the old height
 	 */
 	public changeWhitespaceHeight(id:number, newHeightInPx:number): boolean {
+		id = id|0;
+		newHeightInPx = newHeightInPx|0;
+
 		var sid = id.toString();
 		if (this.whitespaceId2Index.hasOwnProperty(sid)) {
 			var index = this.whitespaceId2Index[sid];
@@ -168,6 +181,9 @@ export class WhitespaceComputer {
 	 * @return Returns true if the whitespace is found and if the new line number is different than the old line number
 	 */
 	public changeWhitespaceAfterLineNumber(id:number, newAfterLineNumber:number): boolean {
+		id = id|0;
+		newAfterLineNumber = newAfterLineNumber|0;
+
 		var sid = id.toString();
 		if (this.whitespaceId2Index.hasOwnProperty(sid)) {
 			var index = this.whitespaceId2Index[sid];
@@ -200,6 +216,8 @@ export class WhitespaceComputer {
 	 * @return Returns true if the whitespace is found and it is removed.
 	 */
 	public removeWhitespace(id:number): boolean {
+		id = id|0;
+
 		var sid = id.toString();
 
 		if (this.whitespaceId2Index.hasOwnProperty(sid)) {
@@ -213,22 +231,21 @@ export class WhitespaceComputer {
 	}
 
 	private removeWhitespaceAtIndex(removeIndex:number): void {
+		removeIndex = removeIndex|0;
+
 		this.heights.splice(removeIndex, 1);
 		this.ids.splice(removeIndex, 1);
 		this.afterLineNumbers.splice(removeIndex, 1);
 		this.ordinals.splice(removeIndex, 1);
 		this.prefixSum.splice(removeIndex, 1);
 		this.prefixSumValidIndex = Math.min(this.prefixSumValidIndex, removeIndex - 1);
 
-		var sid:string,
-			oldIndex:number;
-
-		for (sid in this.whitespaceId2Index) {
-			if (this.whitespaceId2Index.hasOwnProperty(sid)) {
-				oldIndex = this.whitespaceId2Index[sid];
-				if (oldIndex >= removeIndex) {
-					this.whitespaceId2Index[sid] = oldIndex - 1;
-				}
+		let keys = Object.keys(this.whitespaceId2Index);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let sid = keys[i];
+			let oldIndex = this.whitespaceId2Index[sid];
+			if (oldIndex >= removeIndex) {
+				this.whitespaceId2Index[sid] = oldIndex - 1;
 			}
 		}
 	}
@@ -241,6 +258,9 @@ export class WhitespaceComputer {
 	 * @param toLineNumber The line number at which the deletion ended, inclusive
 	 */
 	public onModelLinesDeleted(fromLineNumber:number, toLineNumber:number): void {
+		fromLineNumber = fromLineNumber|0;
+		toLineNumber = toLineNumber|0;
+
 		var afterLineNumber:number,
 			i:number,
 			len:number;
@@ -268,6 +288,9 @@ export class WhitespaceComputer {
 	 * @param toLineNumber The line number at which the insertion ended, inclusive.
 	 */
 	public onModelLinesInserted(fromLineNumber:number, toLineNumber:number): void {
+		fromLineNumber = fromLineNumber|0;
+		toLineNumber = toLineNumber|0;
+
 		var afterLineNumber:number,
 			i:number,
 			len:number;
@@ -299,6 +322,8 @@ export class WhitespaceComputer {
 	 * @return The sum of the heights of all whitespaces before the one at `index`, including the one at `index`.
 	 */
 	public getAccumulatedHeight(index:number): number {
+		index = index|0;
+
 		var startIndex = Math.max(0, this.prefixSumValidIndex + 1);
 		if (startIndex === 0) {
 			this.prefixSum[0] = this.heights[0];
@@ -319,6 +344,8 @@ export class WhitespaceComputer {
 	 * @return The sum of the heights of the whitespaces before `lineNumber`.
 	 */
 	public getAccumulatedHeightBeforeLineNumber(lineNumber:number): number {
+		lineNumber = lineNumber|0;
+
 		var lastWhitespaceBeforeLineNumber = this.findLastWhitespaceBeforeLineNumber(lineNumber);
 
 		if (lastWhitespaceBeforeLineNumber === -1) {
@@ -329,30 +356,35 @@ export class WhitespaceComputer {
 	}
 
 	private findLastWhitespaceBeforeLineNumber(lineNumber:number): number {
+		lineNumber = lineNumber|0;
+
 		// Find the whitespace before line number
-		var afterLineNumbers = this.afterLineNumbers,
-			low = 0,
-			high = afterLineNumbers.length - 1,
-			mid:number;
+		let afterLineNumbers = this.afterLineNumbers;
+		let low = 0;
+		let high = afterLineNumbers.length - 1;
 
-		while(low <= high) {
-			mid = Math.floor( (low + high) / 2 );
+		while (low <= high) {
+			let delta = (high - low)|0;
+			let halfDelta = (delta / 2)|0;
+			let mid = (low + halfDelta)|0;
 
 			if (afterLineNumbers[mid] < lineNumber) {
 				if (mid + 1 >= afterLineNumbers.length || afterLineNumbers[mid + 1] >= lineNumber) {
 					return mid;
 				} else {
-					low = mid + 1;
+					low = (mid + 1)|0;
 				}
 			} else {
-				high = mid - 1;
+				high = (mid - 1)|0;
 			}
 		}
 
 		return -1;
 	}
 
 	private findFirstWhitespaceAfterLineNumber(lineNumber:number): number {
+		lineNumber = lineNumber|0;
+
 		var lastWhitespaceBeforeLineNumber = this.findLastWhitespaceBeforeLineNumber(lineNumber);
 		var firstWhitespaceAfterLineNumber = lastWhitespaceBeforeLineNumber + 1;
 
@@ -368,6 +400,8 @@ export class WhitespaceComputer {
 	 * @return The index of the first whitespace with `afterLineNumber` >= `lineNumber` or -1 if no whitespace is found.
 	 */
 	public getFirstWhitespaceIndexAfterLineNumber(lineNumber:number): number {
+		lineNumber = lineNumber|0;
+
 		return this.findFirstWhitespaceAfterLineNumber(lineNumber);
 	}
 
@@ -385,6 +419,8 @@ export class WhitespaceComputer {
 	 * @return `afterLineNumber` of whitespace at `index`.
 	 */
 	public getAfterLineNumberForWhitespaceIndex(index:number): number {
+		index = index|0;
+
 		return this.afterLineNumbers[index];
 	}
 
@@ -395,6 +431,8 @@ export class WhitespaceComputer {
 	 * @return `id` of whitespace at `index`.
 	 */
 	public getIdForWhitespaceIndex(index:number): number {
+		index = index|0;
+
 		return this.ids[index];
 	}
 
@@ -405,10 +443,14 @@ export class WhitespaceComputer {
 	 * @return `height` of whitespace at `index`.
 	 */
 	public getHeightForWhitespaceIndex(index:number): number {
+		index = index|0;
+
 		return this.heights[index];
 	}
 
 	public getWhitespaces(deviceLineHeight:number): IEditorWhitespace[] {
+		deviceLineHeight = deviceLineHeight|0;
+
 		var result: IEditorWhitespace[] = [];
 		for (var i = 0; i < this.heights.length; i++) {
 			result.push({

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/characterHardWrappingLineMapper.ts
code:
@@ -7,12 +7,7 @@
 import * as strings from 'vs/base/common/strings';
 import {WrappingIndent} from 'vs/editor/common/editorCommon';
 import {PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
-import {ILineMapperFactory, ILineMapping, IOutputPosition} from 'vs/editor/common/viewModel/splitLinesCollection';
-
-var throwawayIndexOfResult = {
-	index: -1,
-	remainder: -1
-};
+import {ILineMapperFactory, ILineMapping, OutputPosition} from 'vs/editor/common/viewModel/splitLinesCollection';
 
 var BREAK_BEFORE_CLASS = 1;
 var BREAK_AFTER_CLASS = 2;
@@ -72,6 +67,10 @@ export class CharacterHardWrappingLineMapperFactory implements ILineMapperFactor
 
 	// TODO@Alex -> duplicated in lineCommentCommand
 	private static nextVisibleColumn(currentVisibleColumn:number, tabSize:number, isTab:boolean, columnSize:number): number {
+		currentVisibleColumn = +currentVisibleColumn; //@perf
+		tabSize = +tabSize; //@perf
+		columnSize = +columnSize; //@perf
+
 		if (isTab) {
 			return currentVisibleColumn + (tabSize - (currentVisibleColumn % tabSize));
 		}
@@ -83,6 +82,11 @@ export class CharacterHardWrappingLineMapperFactory implements ILineMapperFactor
 			return null;
 		}
 
+		tabSize = +tabSize; //@perf
+		breakingColumn = +breakingColumn; //@perf
+		columnsForFullWidthChar = +columnsForFullWidthChar; //@perf
+		hardWrappingIndent = +hardWrappingIndent; //@perf
+
 		var wrappedTextIndentVisibleColumn = 0,
 			wrappedTextIndent = '',
 			TAB_CHAR_CODE = '\t'.charCodeAt(0);
@@ -274,9 +278,8 @@ export class CharacterHardWrappingLineMapping implements ILineMapping {
 		}
 	}
 
-	public getOutputPositionOfInputOffset(inputOffset:number, result:IOutputPosition): void {
-		this._prefixSums.getIndexOf(inputOffset, throwawayIndexOfResult);
-		result.outputLineIndex = throwawayIndexOfResult.index;
-		result.outputOffset = throwawayIndexOfResult.remainder;
+	public getOutputPositionOfInputOffset(inputOffset:number): OutputPosition {
+		let r = this._prefixSums.getIndexOf(inputOffset);
+		return new OutputPosition(r.index, r.remainder);
 	}
 }

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/filteredLineTokens.ts
code:
@@ -5,11 +5,12 @@
 'use strict';
 
 import {Arrays} from 'vs/editor/common/core/arrays';
-import {ILineToken, ILineTokens, IViewLineTokens, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {LineToken, ILineTokens, IViewLineTokens} from 'vs/editor/common/editorCommon';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
 export class FilteredLineTokens implements IViewLineTokens {
 
-	private inflatedTokens: ILineToken[];
+	private inflatedTokens: LineToken[];
 
 	private _original:ILineTokens;
 	private _startOffset:number;
@@ -25,10 +26,10 @@ export class FilteredLineTokens implements IViewLineTokens {
 		this._endOffset = endOffset;
 		this._deltaStartIndex = deltaStartIndex;
 
-		this.inflatedTokens = LineTokensBinaryEncoding.sliceAndInflate(original.getBinaryEncodedTokensMap(), original.getBinaryEncodedTokens(), startOffset, endOffset, deltaStartIndex);
+		this.inflatedTokens = TokensBinaryEncoding.sliceAndInflate(original.getBinaryEncodedTokensMap(), original.getBinaryEncodedTokens(), startOffset, endOffset, deltaStartIndex);
 	}
 
-	public getTokens(): ILineToken[]{
+	public getTokens(): LineToken[]{
 		return this.inflatedTokens;
 	}
 
@@ -72,8 +73,8 @@ export class IdentityFilteredLineTokens implements IViewLineTokens {
 		this._textLength = textLength;
 	}
 
-	public getTokens(): ILineToken[] {
-		return LineTokensBinaryEncoding.inflateArr(this._original.getBinaryEncodedTokensMap(), this._original.getBinaryEncodedTokens());
+	public getTokens(): LineToken[] {
+		return TokensBinaryEncoding.inflateArr(this._original.getBinaryEncodedTokensMap(), this._original.getBinaryEncodedTokens());
 	}
 
 	public getFauxIndentLength(): number {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/prefixSumComputer.ts
code:
@@ -4,9 +4,16 @@
  *--------------------------------------------------------------------------------------------*/
 'use strict';
 
-export interface IPrefixSumIndexOfResult {
+export class PrefixSumIndexOfResult {
+	prefixSumIndexOfResultTrait: void;
+
 	index: number;
 	remainder: number;
+
+	constructor(index:number, remainder:number) {
+		this.index = index;
+		this.remainder = remainder;
+	}
 }
 
 export class PrefixSumComputer {
@@ -29,7 +36,7 @@ export class PrefixSumComputer {
 	constructor(values:number[]) {
 		this.values = values;
 		this.prefixSum = [];
-		for (var i = 0, len = this.values.length; i < len; i++) {
+		for (let i = 0, len = this.values.length; i < len; i++) {
 			this.prefixSum[i] = 0;
 		}
 		this.prefixSumValidIndex = -1;
@@ -40,6 +47,9 @@ export class PrefixSumComputer {
 	}
 
 	public insertValue(insertIndex:number, value:number): void {
+		insertIndex = Math.floor(insertIndex); //@perf
+		value = Math.floor(value); //@perf
+
 		this.values.splice(insertIndex, 0, value);
 		this.prefixSum.splice(insertIndex, 0, 0);
 		if (insertIndex - 1 < this.prefixSumValidIndex) {
@@ -48,6 +58,8 @@ export class PrefixSumComputer {
 	}
 
 	public insertValues(insertIndex: number, values: number[]): void {
+		insertIndex = Math.floor(insertIndex); //@perf
+
 		if (values.length === 0) {
 			return;
 		}
@@ -61,14 +73,19 @@ export class PrefixSumComputer {
 	}
 
 	private static _zeroArray(count: number): number[] {
-		var r: number[] = new Array<number>(count);
-		for (var i = 0; i < count; i++) {
+		count = Math.floor(count); //@perf
+
+		let r: number[] = [];
+		for (let i = 0; i < count; i++) {
 			r[i] = 0;
 		}
 		return r;
 	}
 
 	public changeValue(index:number, value:number): void {
+		index = Math.floor(index); //@perf
+		value = Math.floor(value); //@perf
+
 		if (this.values[index] === value) {
 			return;
 		}
@@ -79,6 +96,9 @@ export class PrefixSumComputer {
 	}
 
 	public removeValues(startIndex:number, cnt:number): void {
+		startIndex = Math.floor(startIndex); //@perf
+		cnt = Math.floor(cnt); //@perf
+
 		this.values.splice(startIndex, cnt);
 		this.prefixSum.splice(startIndex, cnt);
 		if (startIndex - 1 < this.prefixSumValidIndex) {
@@ -94,14 +114,16 @@ export class PrefixSumComputer {
 	}
 
 	public getAccumulatedValue(index:number): number {
+		index = Math.floor(index); //@perf
+
 		if (index < 0) {
 			return 0;
 		}
 		if (index <= this.prefixSumValidIndex) {
 			return this.prefixSum[index];
 		}
 
-		var startIndex = this.prefixSumValidIndex + 1;
+		let startIndex = this.prefixSumValidIndex + 1;
 		if (startIndex === 0) {
 			this.prefixSum[0] = this.values[0];
 			startIndex++;
@@ -111,19 +133,21 @@ export class PrefixSumComputer {
 			index = this.values.length - 1;
 		}
 
-		for (var i = startIndex; i <= index; i++) {
+		for (let i = startIndex; i <= index; i++) {
 			this.prefixSum[i] = this.prefixSum[i - 1] + this.values[i];
 		}
 		this.prefixSumValidIndex = Math.max(this.prefixSumValidIndex, index);
 		return this.prefixSum[index];
 	}
 
-	public getIndexOf(accumulatedValue:number, result:IPrefixSumIndexOfResult): void {
-		var low = 0,
-			high = this.values.length - 1,
-			mid:number,
-			midStart:number,
-			midStop:number;
+	public getIndexOf(accumulatedValue:number): PrefixSumIndexOfResult {
+		accumulatedValue = Math.floor(accumulatedValue); //@perf
+
+		let low = 0;
+		let high = this.values.length - 1;
+		let mid:number;
+		let midStop:number;
+		let midStart:number;
 
 		while (low <= high) {
 			mid = low + ( (high-low)/2 ) | 0;
@@ -140,7 +164,6 @@ export class PrefixSumComputer {
 			}
 		}
 
-		result.index = mid;
-		result.remainder = accumulatedValue - midStart;
+		return new PrefixSumIndexOfResult(mid, accumulatedValue - midStart);
 	}
-}
\ No newline at end of file
+}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/splitLinesCollection.ts
code:
@@ -8,32 +8,31 @@ import {Position} from 'vs/editor/common/core/position';
 import {Range} from 'vs/editor/common/core/range';
 import * as editorCommon from 'vs/editor/common/editorCommon';
 import {FilteredLineTokens, IdentityFilteredLineTokens} from 'vs/editor/common/viewModel/filteredLineTokens';
-import {IPrefixSumIndexOfResult, PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
+import {PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
 import {ILinesCollection} from 'vs/editor/common/viewModel/viewModel';
 
-export interface IOutputPosition {
+export class OutputPosition {
+	_outputPositionTrait: void;
 	outputLineIndex: number;
 	outputOffset: number;
+
+	constructor(outputLineIndex: number, outputOffset: number) {
+		this.outputLineIndex = outputLineIndex;
+		this.outputOffset = outputOffset;
+	}
 }
 
 export interface ILineMapping {
 	getOutputLineCount(): number;
 	getWrappedLinesIndent(): string;
 	getInputOffsetOfOutputPosition(outputLineIndex:number, outputOffset:number): number;
-	getOutputPositionOfInputOffset(inputOffset:number, result:IOutputPosition): void;
+	getOutputPositionOfInputOffset(inputOffset:number): OutputPosition;
 }
 
 export interface ILineMapperFactory {
 	createLineMapping(lineText: string, tabSize: number, wrappingColumn: number, columnsForFullWidthChar:number, wrappingIndent:editorCommon.WrappingIndent): ILineMapping;
 }
 
-
-
-var tmpOutputPosition:IOutputPosition = {
-	outputLineIndex: 0,
-	outputOffset: 0
-};
-
 export interface IModel {
 	getLineTokens(lineNumber:number, inaccurateTokensAcceptable?:boolean): editorCommon.ILineTokens;
 	getLineContent(lineNumber:number): string;
@@ -166,9 +165,9 @@ export class SplitLine implements ISplitLine {
 		if (!this._isVisible) {
 			throw new Error('Not supported');
 		}
-		var startOffset = this.getInputStartOffsetOfOutputLineIndex(outputLineIndex);
-		var endOffset = this.getInputEndOffsetOfOutputLineIndex(model, myLineNumber, outputLineIndex);
-		var r = model.getLineContent(myLineNumber).substring(startOffset, endOffset);
+		let startOffset = this.getInputStartOffsetOfOutputLineIndex(outputLineIndex);
+		let endOffset = this.getInputEndOffsetOfOutputLineIndex(model, myLineNumber, outputLineIndex);
+		let r = model.getLineContent(myLineNumber).substring(startOffset, endOffset);
 
 		if (outputLineIndex > 0) {
 			r = this.wrappedIndent + r;
@@ -199,9 +198,9 @@ export class SplitLine implements ISplitLine {
 		if (!this._isVisible) {
 			throw new Error('Not supported');
 		}
-		var startOffset = this.getInputStartOffsetOfOutputLineIndex(outputLineIndex);
-		var endOffset = this.getInputEndOffsetOfOutputLineIndex(model, myLineNumber, outputLineIndex);
-		var deltaStartIndex = 0;
+		let startOffset = this.getInputStartOffsetOfOutputLineIndex(outputLineIndex);
+		let endOffset = this.getInputEndOffsetOfOutputLineIndex(model, myLineNumber, outputLineIndex);
+		let deltaStartIndex = 0;
 		if (outputLineIndex > 0) {
 			deltaStartIndex = this.wrappedIndentLength;
 		}
@@ -212,7 +211,7 @@ export class SplitLine implements ISplitLine {
 		if (!this._isVisible) {
 			throw new Error('Not supported');
 		}
-		var adjustedColumn = outputColumn - 1;
+		let adjustedColumn = outputColumn - 1;
 		if (outputLineIndex > 0) {
 			if (adjustedColumn < this.wrappedIndentLength) {
 				adjustedColumn = 0;
@@ -227,9 +226,9 @@ export class SplitLine implements ISplitLine {
 		if (!this._isVisible) {
 			throw new Error('Not supported');
 		}
-		this.positionMapper.getOutputPositionOfInputOffset(inputColumn - 1, tmpOutputPosition);
-		var outputLineIndex = tmpOutputPosition.outputLineIndex;
-		var outputColumn = tmpOutputPosition.outputOffset + 1;
+		let r = this.positionMapper.getOutputPositionOfInputOffset(inputColumn - 1);
+		let outputLineIndex = r.outputLineIndex;
+		let outputColumn = r.outputOffset + 1;
 
 		if (outputLineIndex > 0) {
 			outputColumn += this.wrappedIndentLength;
@@ -241,7 +240,7 @@ export class SplitLine implements ISplitLine {
 }
 
 function createSplitLine(linePositionMapperFactory:ILineMapperFactory, text:string, tabSize:number, wrappingColumn:number, columnsForFullWidthChar:number, wrappingIndent:editorCommon.WrappingIndent, isVisible: boolean): ISplitLine {
-	var positionMapper = linePositionMapperFactory.createLineMapping(text, tabSize, wrappingColumn, columnsForFullWidthChar, wrappingIndent);
+	let positionMapper = linePositionMapperFactory.createLineMapping(text, tabSize, wrappingColumn, columnsForFullWidthChar, wrappingIndent);
 	if (positionMapper === null) {
 		// No mapping needed
 		return new IdentitySplitLine(isVisible);
@@ -263,7 +262,6 @@ export class SplitLinesCollection implements ILinesCollection {
 	private prefixSumComputer:PrefixSumComputer;
 	private linePositionMapperFactory:ILineMapperFactory;
 
-	private tmpIndexOfResult: IPrefixSumIndexOfResult;
 	private hiddenAreasIds:string[];
 
 	constructor(model:editorCommon.IModel, linePositionMapperFactory:ILineMapperFactory, tabSize:number, wrappingColumn:number, columnsForFullWidthChar:number, wrappingIndent:editorCommon.WrappingIndent) {
@@ -276,19 +274,14 @@ export class SplitLinesCollection implements ILinesCollection {
 		this.linePositionMapperFactory = linePositionMapperFactory;
 
 		this._constructLines(true);
-
-		this.tmpIndexOfResult = {
-			index: 0,
-			remainder: 0
-		};
 	}
 
 	public dispose(): void {
 		this.hiddenAreasIds = this.model.deltaDecorations(this.hiddenAreasIds, []);
 	}
 
 	private _ensureValidState(): void {
-		var modelVersion = this.model.getVersionId();
+		let modelVersion = this.model.getVersionId();
 		if (modelVersion !== this._validModelVersionId) {
 			throw new Error('SplitLinesCollection: attempt to access a \'newer\' model');
 		}
@@ -488,13 +481,13 @@ export class SplitLinesCollection implements ILinesCollection {
 		}
 		this._validModelVersionId = versionId;
 
-		var outputFromLineNumber = (fromLineNumber === 1 ? 1 : this.prefixSumComputer.getAccumulatedValue(fromLineNumber - 2) + 1);
-		var outputToLineNumber = this.prefixSumComputer.getAccumulatedValue(toLineNumber - 1);
+		let outputFromLineNumber = (fromLineNumber === 1 ? 1 : this.prefixSumComputer.getAccumulatedValue(fromLineNumber - 2) + 1);
+		let outputToLineNumber = this.prefixSumComputer.getAccumulatedValue(toLineNumber - 1);
 
 		this.lines.splice(fromLineNumber - 1, toLineNumber - fromLineNumber + 1);
 		this.prefixSumComputer.removeValues(fromLineNumber - 1, toLineNumber - fromLineNumber + 1);
 
-		var e:editorCommon.IViewLinesDeletedEvent = {
+		let e:editorCommon.IViewLinesDeletedEvent = {
 			fromLineNumber: outputFromLineNumber,
 			toLineNumber: outputToLineNumber
 		};
@@ -507,30 +500,27 @@ export class SplitLinesCollection implements ILinesCollection {
 		}
 		this._validModelVersionId = versionId;
 
-		var hiddenAreas = this.getHiddenAreas();
-		var isInHiddenArea = false;
-		var testPosition = new Position(fromLineNumber, 1);
-		for (var i = 0; i < hiddenAreas.length; i++) {
+		let hiddenAreas = this.getHiddenAreas();
+		let isInHiddenArea = false;
+		let testPosition = new Position(fromLineNumber, 1);
+		for (let i = 0; i < hiddenAreas.length; i++) {
 			if (hiddenAreas[i].containsPosition(testPosition)) {
 				isInHiddenArea = true;
 				break;
 			}
 		}
 
-		var outputFromLineNumber = (fromLineNumber === 1 ? 1 : this.prefixSumComputer.getAccumulatedValue(fromLineNumber - 2) + 1);
-
-		var line: ISplitLine,
-			outputLineCount: number,
-			totalOutputLineCount = 0;
+		let outputFromLineNumber = (fromLineNumber === 1 ? 1 : this.prefixSumComputer.getAccumulatedValue(fromLineNumber - 2) + 1);
 
-		var insertLines: ISplitLine[] = [],
-			insertPrefixSumValues: number[] = [];
+		let totalOutputLineCount = 0;
+		let insertLines: ISplitLine[] = [];
+		let insertPrefixSumValues: number[] = [];
 
-		for (var i = 0, len = text.length; i < len; i++) {
-			var line = createSplitLine(this.linePositionMapperFactory, text[i], this.tabSize, this.wrappingColumn, this.columnsForFullWidthChar, this.wrappingIndent, !isInHiddenArea);
+		for (let i = 0, len = text.length; i < len; i++) {
+			let line = createSplitLine(this.linePositionMapperFactory, text[i], this.tabSize, this.wrappingColumn, this.columnsForFullWidthChar, this.wrappingIndent, !isInHiddenArea);
 			insertLines.push(line);
 
-			outputLineCount = line.getOutputLineCount();
+			let outputLineCount = line.getOutputLineCount();
 			totalOutputLineCount += outputLineCount;
 			insertPrefixSumValues.push(outputLineCount);
 		}
@@ -539,7 +529,7 @@ export class SplitLinesCollection implements ILinesCollection {
 
 		this.prefixSumComputer.insertValues(fromLineNumber - 1, insertPrefixSumValues);
 
-		var e:editorCommon.IViewLinesInsertedEvent = {
+		let e:editorCommon.IViewLinesInsertedEvent = {
 			fromLineNumber: outputFromLineNumber,
 			toLineNumber: outputFromLineNumber + totalOutputLineCount - 1
 		};
@@ -551,21 +541,21 @@ export class SplitLinesCollection implements ILinesCollection {
 			return;
 		}
 		this._validModelVersionId = versionId;
-		var lineIndex = lineNumber - 1;
+		let lineIndex = lineNumber - 1;
 
-		var oldOutputLineCount = this.lines[lineIndex].getOutputLineCount();
-		var isVisible = this.lines[lineIndex].isVisible();
-		var line = createSplitLine(this.linePositionMapperFactory, newText, this.tabSize, this.wrappingColumn, this.columnsForFullWidthChar, this.wrappingIndent, isVisible);
+		let oldOutputLineCount = this.lines[lineIndex].getOutputLineCount();
+		let isVisible = this.lines[lineIndex].isVisible();
+		let line = createSplitLine(this.linePositionMapperFactory, newText, this.tabSize, this.wrappingColumn, this.columnsForFullWidthChar, this.wrappingIndent, isVisible);
 		this.lines[lineIndex] = line;
-		var newOutputLineCount = this.lines[lineIndex].getOutputLineCount();
+		let newOutputLineCount = this.lines[lineIndex].getOutputLineCount();
 
-		var lineMappingChanged = false,
-			changeFrom = 0,
-			changeTo = -1,
-			insertFrom = 0,
-			insertTo = -1,
-			deleteFrom = 0,
-			deleteTo = -1;
+		let lineMappingChanged = false;
+		let changeFrom = 0;
+		let changeTo = -1;
+		let insertFrom = 0;
+		let insertTo = -1;
+		let deleteFrom = 0;
+		let deleteTo = -1;
 
 		if (oldOutputLineCount > newOutputLineCount) {
 			changeFrom = (lineNumber === 1 ? 1 : this.prefixSumComputer.getAccumulatedValue(lineNumber - 2) + 1);
@@ -586,13 +576,12 @@ export class SplitLinesCollection implements ILinesCollection {
 
 		this.prefixSumComputer.changeValue(lineIndex, newOutputLineCount);
 
-		var i:number,
-			e1:editorCommon.IViewLineChangedEvent,
-			e2:editorCommon.IViewLinesInsertedEvent,
-			e3:editorCommon.IViewLinesDeletedEvent;
+		let e1:editorCommon.IViewLineChangedEvent;
+		let e2:editorCommon.IViewLinesInsertedEvent;
+		let e3:editorCommon.IViewLinesDeletedEvent;
 
 		if (changeFrom <= changeTo) {
-			for (var i = changeFrom; i <= changeTo; i++) {
+			for (let i = changeFrom; i <= changeTo; i++) {
 				e1 = {
 					lineNumber: i
 				};
@@ -636,39 +625,39 @@ export class SplitLinesCollection implements ILinesCollection {
 	public getOutputLineContent(outputLineNumber: number): string {
 		this._ensureValidState();
 		outputLineNumber = this._toValidOutputLineNumber(outputLineNumber);
-		this.prefixSumComputer.getIndexOf(outputLineNumber - 1, this.tmpIndexOfResult);
-		var lineIndex = this.tmpIndexOfResult.index;
-		var remainder = this.tmpIndexOfResult.remainder;
+		let r = this.prefixSumComputer.getIndexOf(outputLineNumber - 1);
+		let lineIndex = r.index;
+		let remainder = r.remainder;
 
 		return this.lines[lineIndex].getOutputLineContent(this.model, lineIndex + 1, remainder);
 	}
 
 	public getOutputLineMinColumn(outputLineNumber:number): number {
 		this._ensureValidState();
 		outputLineNumber = this._toValidOutputLineNumber(outputLineNumber);
-		this.prefixSumComputer.getIndexOf(outputLineNumber - 1, this.tmpIndexOfResult);
-		var lineIndex = this.tmpIndexOfResult.index;
-		var remainder = this.tmpIndexOfResult.remainder;
+		let r = this.prefixSumComputer.getIndexOf(outputLineNumber - 1);
+		let lineIndex = r.index;
+		let remainder = r.remainder;
 
 		return this.lines[lineIndex].getOutputLineMinColumn(this.model, lineIndex + 1, remainder);
 	}
 
 	public getOutputLineMaxColumn(outputLineNumber: number): number {
 		this._ensureValidState();
 		outputLineNumber = this._toValidOutputLineNumber(outputLineNumber);
-		this.prefixSumComputer.getIndexOf(outputLineNumber - 1, this.tmpIndexOfResult);
-		var lineIndex = this.tmpIndexOfResult.index;
-		var remainder = this.tmpIndexOfResult.remainder;
+		let r = this.prefixSumComputer.getIndexOf(outputLineNumber - 1);
+		let lineIndex = r.index;
+		let remainder = r.remainder;
 
 		return this.lines[lineIndex].getOutputLineMaxColumn(this.model, lineIndex + 1, remainder);
 	}
 
 	public getOutputLineTokens(outputLineNumber: number, inaccurateTokensAcceptable: boolean): editorCommon.IViewLineTokens {
 		this._ensureValidState();
 		outputLineNumber = this._toValidOutputLineNumber(outputLineNumber);
-		this.prefixSumComputer.getIndexOf(outputLineNumber - 1, this.tmpIndexOfResult);
-		var lineIndex = this.tmpIndexOfResult.index;
-		var remainder = this.tmpIndexOfResult.remainder;
+		let r = this.prefixSumComputer.getIndexOf(outputLineNumber - 1);
+		let lineIndex = r.index;
+		let remainder = r.remainder;
 
 		return this.lines[lineIndex].getOutputLineTokens(this.model, lineIndex + 1, remainder, inaccurateTokensAcceptable);
 	}
@@ -677,11 +666,11 @@ export class SplitLinesCollection implements ILinesCollection {
 		this._ensureValidState();
 		viewLineNumber = this._toValidOutputLineNumber(viewLineNumber);
 
-		this.prefixSumComputer.getIndexOf(viewLineNumber - 1, this.tmpIndexOfResult);
-		var lineIndex = this.tmpIndexOfResult.index;
-		var remainder = this.tmpIndexOfResult.remainder;
+		let r = this.prefixSumComputer.getIndexOf(viewLineNumber - 1);
+		let lineIndex = r.index;
+		let remainder = r.remainder;
 
-		var inputColumn = this.lines[lineIndex].getInputColumnOfOutputPosition(remainder, viewColumn);
+		let inputColumn = this.lines[lineIndex].getInputColumnOfOutputPosition(remainder, viewColumn);
 		// console.log('out -> in ' + viewLineNumber + ',' + viewColumn + ' ===> ' + (lineIndex+1) + ',' + inputColumn);
 		return this.model.validatePosition(new Position(lineIndex+1, inputColumn));
 	}
@@ -703,9 +692,9 @@ export class SplitLinesCollection implements ILinesCollection {
 			// console.log('in -> out ' + inputLineNumber + ',' + inputColumn + ' ===> ' + 1 + ',' + 1);
 			return new Position(1, 1);
 		}
-		var deltaLineNumber = 1 + (lineIndex === 0 ? 0 : this.prefixSumComputer.getAccumulatedValue(lineIndex - 1));
+		let deltaLineNumber = 1 + (lineIndex === 0 ? 0 : this.prefixSumComputer.getAccumulatedValue(lineIndex - 1));
 
-		var r:editorCommon.IEditorPosition;
+		let r:editorCommon.IEditorPosition;
 		if (lineIndexChanged) {
 			r =  this.lines[lineIndex].getOutputPositionOfInputPosition(deltaLineNumber, this.model.getLineMaxColumn(lineIndex + 1));
 		} else {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/viewEventHandler.ts
code:
@@ -9,10 +9,22 @@ import * as editorCommon from 'vs/editor/common/editorCommon';
 
 export class ViewEventHandler {
 
-	public shouldRender:boolean;
+	private _shouldRender:boolean;
 
 	constructor() {
-		this.shouldRender = true;
+		this._shouldRender = true;
+	}
+
+	public shouldRender(): boolean {
+		return this._shouldRender;
+	}
+
+	protected setShouldRender(): void {
+		this._shouldRender = true;
+	}
+
+	public onDidRender(): void {
+		this._shouldRender = false;
 	}
 
 	// --- begin event handlers
@@ -75,93 +87,131 @@ export class ViewEventHandler {
 	// --- end event handlers
 
 	public handleEvents(events:IEmitterEvent[]): void {
-		var i:number,
-			len:number,
-			e:IEmitterEvent,
-			data:any;
 
-		for (i = 0, len = events.length; i < len; i++) {
-			e = events[i];
-			data = e.getData();
+		let shouldRender = false;
+
+		for (let i = 0, len = events.length; i < len; i++) {
+			let e = events[i];
+			let data = e.getData();
 
 			switch (e.getType()) {
 
 				case editorCommon.ViewEventNames.LineMappingChangedEvent:
-					this.shouldRender = this.onLineMappingChanged() || this.shouldRender;
+					if (this.onLineMappingChanged()) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.ModelFlushedEvent:
-					this.shouldRender = this.onModelFlushed() || this.shouldRender;
+					if (this.onModelFlushed()) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.LinesDeletedEvent:
-					this.shouldRender = this.onModelLinesDeleted(<editorCommon.IViewLinesDeletedEvent>data) || this.shouldRender;
+					if (this.onModelLinesDeleted(<editorCommon.IViewLinesDeletedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.LinesInsertedEvent:
-					this.shouldRender = this.onModelLinesInserted(<editorCommon.IViewLinesInsertedEvent>data) || this.shouldRender;
+					if (this.onModelLinesInserted(<editorCommon.IViewLinesInsertedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.LineChangedEvent:
-					this.shouldRender = this.onModelLineChanged(<editorCommon.IViewLineChangedEvent>data) || this.shouldRender;
+					if (this.onModelLineChanged(<editorCommon.IViewLineChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.TokensChangedEvent:
-					this.shouldRender = this.onModelTokensChanged(<editorCommon.IViewTokensChangedEvent>data) || this.shouldRender;
+					if (this.onModelTokensChanged(<editorCommon.IViewTokensChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.DecorationsChangedEvent:
-					this.shouldRender = this.onModelDecorationsChanged(<editorCommon.IViewDecorationsChangedEvent>data) || this.shouldRender;
+					if (this.onModelDecorationsChanged(<editorCommon.IViewDecorationsChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.CursorPositionChangedEvent:
-					this.shouldRender = this.onCursorPositionChanged(<editorCommon.IViewCursorPositionChangedEvent>data) || this.shouldRender;
+					if (this.onCursorPositionChanged(<editorCommon.IViewCursorPositionChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.CursorSelectionChangedEvent:
-					this.shouldRender = this.onCursorSelectionChanged(<editorCommon.IViewCursorSelectionChangedEvent>data) || this.shouldRender;
+					if (this.onCursorSelectionChanged(<editorCommon.IViewCursorSelectionChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.RevealRangeEvent:
-					this.shouldRender = this.onCursorRevealRange(<editorCommon.IViewRevealRangeEvent>data) || this.shouldRender;
+					if (this.onCursorRevealRange(<editorCommon.IViewRevealRangeEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.ViewEventNames.ScrollRequestEvent:
-					this.shouldRender = this.onCursorScrollRequest(<editorCommon.IViewScrollRequestEvent>data) || this.shouldRender;
+					if (this.onCursorScrollRequest(<editorCommon.IViewScrollRequestEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ConfigurationChanged:
-					this.shouldRender = this.onConfigurationChanged(<editorCommon.IConfigurationChangedEvent>data) || this.shouldRender;
+					if (this.onConfigurationChanged(<editorCommon.IConfigurationChangedEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewLayoutChanged:
-					this.shouldRender = this.onLayoutChanged(<editorCommon.IEditorLayoutInfo>data) || this.shouldRender;
+					if (this.onLayoutChanged(<editorCommon.IEditorLayoutInfo>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewScrollChanged:
-					this.shouldRender = this.onScrollChanged(<editorCommon.IScrollEvent>data) || this.shouldRender;
+					if (this.onScrollChanged(<editorCommon.IScrollEvent>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewZonesChanged:
-					this.shouldRender = this.onZonesChanged() || this.shouldRender;
+					if (this.onZonesChanged()) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewScrollWidthChanged:
-					this.shouldRender = this.onScrollWidthChanged(<number>data) || this.shouldRender;
+					if (this.onScrollWidthChanged(<number>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewScrollHeightChanged:
-					this.shouldRender = this.onScrollHeightChanged(<number>data) || this.shouldRender;
+					if (this.onScrollHeightChanged(<number>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				case editorCommon.EventType.ViewFocusChanged:
-					this.shouldRender = this.onViewFocusChanged(<boolean>data) || this.shouldRender;
+					if (this.onViewFocusChanged(<boolean>data)) {
+						shouldRender = true;
+					}
 					break;
 
 				default:
 					console.info('View received unknown event: ');
 					console.info(e);
 			}
 		}
+
+		if (shouldRender) {
+			this._shouldRender = true;
+		}
 	}
 }
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/viewModel.ts
code:
@@ -46,7 +46,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 	private lines:ILinesCollection;
 	private decorations:ViewModelDecorations;
 	private cursors:ViewModelCursors;
-	private shouldForceTokenization:boolean;
 
 	private getCurrentCenteredModelRange:()=>editorCommon.IEditorRange;
 
@@ -71,7 +70,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 		this.decorations.reset(this.model);
 
 		this.cursors = new ViewModelCursors(this.configuration, this);
-		this._updateShouldForceTokenization();
 
 		this.listenersToRemove = [];
 		this._toDispose = [];
@@ -88,7 +86,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 				this.emit(editorCommon.ViewEventNames.LineMappingChangedEvent);
 				this.decorations.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
 				this.cursors.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
-				this._updateShouldForceTokenization();
 			}
 		});
 	}
@@ -111,17 +108,12 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 		this.model = null;
 	}
 
-	private _updateShouldForceTokenization(): void {
-		this.shouldForceTokenization = (this.lines.getOutputLineCount() <= this.configuration.editor.forcedTokenizationBoundary);
-	}
-
 	private _onTabSizeChange(newTabSize:number): boolean {
 		var lineMappingChanged = this.lines.setTabSize(newTabSize, (eventType:string, payload:any) => this.emit(eventType, payload));
 		if (lineMappingChanged) {
 			this.emit(editorCommon.ViewEventNames.LineMappingChangedEvent);
 			this.decorations.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
 			this.cursors.onLineMappingChanged((eventType: string, payload: any) => this.emit(eventType, payload));
-			this._updateShouldForceTokenization();
 		}
 		return lineMappingChanged;
 	}
@@ -132,7 +124,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 			this.emit(editorCommon.ViewEventNames.LineMappingChangedEvent);
 			this.decorations.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
 			this.cursors.onLineMappingChanged((eventType: string, payload: any) => this.emit(eventType, payload));
-			this._updateShouldForceTokenization();
 		}
 		return lineMappingChanged;
 	}
@@ -156,7 +147,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 			this.emit(editorCommon.ViewEventNames.LineMappingChangedEvent);
 			this.decorations.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
 			this.cursors.onLineMappingChanged((eventType: string, payload: any) => this.emit(eventType, payload));
-			this._updateShouldForceTokenization();
 		}
 		return lineMappingChanged;
 	}
@@ -179,7 +169,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 				len:number,
 				e: IEmitterEvent,
 				data:any,
-				shouldUpdateForceTokenization = false,
 				modelContentChangedEvent:editorCommon.IModelContentChangedEvent,
 				hadOtherModelChange = false,
 				hadModelLineChangeThatChangedLineMapping = false,
@@ -218,7 +207,6 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 								console.info('ViewModel received unknown event: ');
 								console.info(e);
 						}
-						shouldUpdateForceTokenization = true;
 						break;
 
 					case editorCommon.EventType.ModelTokensChanged:
@@ -292,15 +280,10 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 				}
 			}
 
-			if (shouldUpdateForceTokenization) {
-				this._updateShouldForceTokenization();
-			}
-
 			if (!hadOtherModelChange && hadModelLineChangeThatChangedLineMapping) {
 				this.emit(editorCommon.ViewEventNames.LineMappingChangedEvent);
 				this.decorations.onLineMappingChanged((eventType:string, payload:any) => this.emit(eventType, payload));
 				this.cursors.onLineMappingChanged((eventType: string, payload: any) => this.emit(eventType, payload));
-				this._updateShouldForceTokenization();
 			}
 
 			if (revealPreviousCenteredModelRange && previousCenteredModelRange) {
@@ -428,7 +411,7 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 	}
 
 	public getLineTokens(lineNumber:number): editorCommon.IViewLineTokens {
-		return this.lines.getOutputLineTokens(lineNumber, !this.shouldForceTokenization);
+		return this.lines.getOutputLineTokens(lineNumber, true);
 	}
 
 	public getLineRenderLineNumber(viewLineNumber:number): string {
@@ -445,8 +428,8 @@ export class ViewModel extends EventEmitter implements editorCommon.IViewModel {
 		return modelLineNumber.toString();
 	}
 
-	public getDecorationsResolver(startLineNumber:number, endLineNumber:number): editorCommon.IViewModelDecorationsResolver {
-		return this.decorations.getDecorationsResolver(startLineNumber, endLineNumber);
+	public getDecorationsViewportData(startLineNumber:number, endLineNumber:number): editorCommon.IDecorationsViewportData {
+		return this.decorations.getDecorationsViewportData(startLineNumber, endLineNumber);
 	}
 
 	public getAllDecorations(): editorCommon.IModelDecoration[] {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/common/viewModel/viewModelDecorations.ts
code:
@@ -26,11 +26,11 @@ interface IViewModelDecorationSource {
 class ViewModelDecoration implements IViewModelDecoration {
 	id: string;
 	ownerId: number;
-	range: editorCommon.IRange;
+	range: editorCommon.IEditorRange;
 	options: editorCommon.IModelDecorationOptions;
 	modelRange: editorCommon.IRange;
 
-	constructor(source:IViewModelDecorationSource, range:editorCommon.IRange) {
+	constructor(source:IViewModelDecorationSource, range:editorCommon.IEditorRange) {
 		this.id = source.id;
 		this.options = source.options;
 		this.ownerId = source.ownerId;
@@ -46,7 +46,7 @@ export class ViewModelDecorations implements IDisposable {
 	private converter:IModelRangeToViewRangeConverter;
 	private decorations:IViewModelDecoration[];
 
-	private _cachedModelDecorationsResolver:editorCommon.IViewModelDecorationsResolver;
+	private _cachedModelDecorationsResolver:editorCommon.IDecorationsViewportData;
 	private _cachedModelDecorationsResolverStartLineNumber:number;
 	private _cachedModelDecorationsResolverEndLineNumber:number;
 
@@ -156,9 +156,10 @@ export class ViewModelDecorations implements IDisposable {
 		}
 
 		// Interpret new decorations
-		var id:string;
-		for (id in addedOrChangedMap) {
-			if (!usedMap.hasOwnProperty(id) && addedOrChangedMap.hasOwnProperty(id)) {
+		let keys = Object.keys(addedOrChangedMap);
+		for (let i = 0, len = keys.length; i < len; i++) {
+			let id = keys[i];
+			if (!usedMap.hasOwnProperty(id)) {
 				theirDecoration = addedOrChangedMap[id];
 
 				myDecoration = new ViewModelDecoration(theirDecoration, this.converter.convertModelRangeToViewRange(theirDecoration.range, theirDecoration.options.isWholeLine));
@@ -216,20 +217,20 @@ export class ViewModelDecorations implements IDisposable {
 		return this.decorations;
 	}
 
-	public getDecorationsResolver(startLineNumber: number, endLineNumber: number): editorCommon.IViewModelDecorationsResolver {
+	public getDecorationsViewportData(startLineNumber: number, endLineNumber: number): editorCommon.IDecorationsViewportData {
 		var cacheIsValid = true;
 		cacheIsValid = cacheIsValid && (this._cachedModelDecorationsResolver !== null);
 		cacheIsValid = cacheIsValid && (this._cachedModelDecorationsResolverStartLineNumber === startLineNumber);
 		cacheIsValid = cacheIsValid && (this._cachedModelDecorationsResolverEndLineNumber === endLineNumber);
 		if (!cacheIsValid) {
-			this._cachedModelDecorationsResolver = this._createDecorationsResolver(startLineNumber, endLineNumber);
+			this._cachedModelDecorationsResolver = this._getDecorationsViewportData(startLineNumber, endLineNumber);
 			this._cachedModelDecorationsResolverStartLineNumber = startLineNumber;
 			this._cachedModelDecorationsResolverEndLineNumber = endLineNumber;
 		}
 		return this._cachedModelDecorationsResolver;
 	}
 
-	private _createDecorationsResolver(startLineNumber: number, endLineNumber: number): editorCommon.IViewModelDecorationsResolver {
+	private _getDecorationsViewportData(startLineNumber: number, endLineNumber: number): editorCommon.IDecorationsViewportData {
 		var decorationsInViewport: editorCommon.IModelDecoration[] = [],
 			inlineDecorations: editorCommon.IModelDecoration[][] = [],
 			j: number,
@@ -268,15 +269,8 @@ export class ViewModelDecorations implements IDisposable {
 		}
 
 		return {
-			getDecorations: () => {
-				return decorationsInViewport;
-			},
-			getInlineDecorations: (lineNumber:number) => {
-				if (lineNumber < startLineNumber || lineNumber > endLineNumber) {
-					throw new Error('Unexpected line outside the ViewModelDecorationsResolver preconfigured range');
-				}
-				return inlineDecorations[lineNumber - startLineNumber];
-			}
+			decorations: decorationsInViewport,
+			inlineDecorations: inlineDecorations
 		};
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/contrib/codelens/browser/codelens.ts
code:
@@ -518,7 +518,7 @@ export class CodeLensContribution implements editorCommon.IEditorContribution {
 		if (!symbols) {
 			symbols = [];
 		} else {
-			symbols = symbols.sort((a, b) => Range.compareRangesUsingStarts(a.symbol.range, b.symbol.range));
+			symbols = symbols.sort((a, b) => Range.compareRangesUsingStarts(Range.lift(a.symbol.range), Range.lift(b.symbol.range)));
 		}
 
 		let maxLineNumber = this._editor.getModel().getLineCount();

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/contrib/links/browser/links.ts
code:
@@ -76,6 +76,18 @@ class LinkOccurence {
 	}
 }
 
+class Link {
+	range: editorCommon.IEditorRange;
+	url: string;
+	extraInlineClassName: string;
+
+	constructor(source:ILink) {
+		this.range = new Range(source.range.startLineNumber, source.range.startColumn, source.range.endLineNumber, source.range.endColumn);
+		this.url = source.url;
+		this.extraInlineClassName = source.extraInlineClassName || null;
+	}
+}
+
 class LinkDetector {
 	static RECOMPUTE_TIME = 1000; // ms
 	static TRIGGER_KEY_VALUE = platform.isMacintosh ? KeyCode.Meta : KeyCode.Ctrl;
@@ -174,7 +186,7 @@ class LinkDetector {
 			if (!b || b.length === 0) {
 				return a || [];
 			}
-			return LinkDetector._linksUnion(a, b);
+			return LinkDetector._linksUnion(a.map(el => new Link(el)), b.map(el => new Link(el)));
 		});
 
 		this.computePromise.then((links:ILink[]) => {
@@ -183,15 +195,15 @@ class LinkDetector {
 		});
 	}
 
-	private static _linksUnion(oldLinks: ILink[], newLinks: ILink[]): ILink[] {
+	private static _linksUnion(oldLinks: Link[], newLinks: Link[]): Link[] {
 		// reunite oldLinks with newLinks and remove duplicates
-		var result: ILink[] = [],
+		var result: Link[] = [],
 			oldIndex: number,
 			oldLen: number,
 			newIndex: number,
 			newLen: number,
-			oldLink: ILink,
-			newLink: ILink,
+			oldLink: Link,
+			newLink: Link,
 			comparisonResult: number;
 
 		for (oldIndex = 0, newIndex = 0, oldLen = oldLinks.length, newLen = newLinks.length; oldIndex < oldLen && newIndex < newLen;) {
@@ -230,11 +242,11 @@ class LinkDetector {
 	private updateDecorations(links:ILink[]):void {
 		this.editor.changeDecorations((changeAccessor:editorCommon.IModelDecorationsChangeAccessor) => {
 			var oldDecorations:string[] = [];
-			for (var decorationId in this.currentOccurences) {
-				if (this.currentOccurences.hasOwnProperty(decorationId)) {
-					var occurance = this.currentOccurences[decorationId];
-					oldDecorations.push(occurance.decorationId);
-				}
+			let keys = Object.keys(this.currentOccurences);
+			for (let i = 0, len = keys.length; i < len; i++) {
+				let decorationId = keys[i];
+				let occurance = this.currentOccurences[decorationId];
+				oldDecorations.push(occurance.decorationId);
 			}
 
 			var newDecorations:editorCommon.IModelDeltaDecoration[] = [];

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/contrib/quickOpen/common/quickOpen.ts
code:
@@ -36,10 +36,10 @@ export function getOutlineEntries(model: IModel): TPromise<IOutline> {
 	let promises = OutlineRegistry.all(model).map(support => {
 
 		if (support.outlineGroupLabel) {
-			for (var key in support.outlineGroupLabel) {
-				if (Object.prototype.hasOwnProperty.call(support.outlineGroupLabel, key)) {
-					groupLabels[key] = support.outlineGroupLabel[key];
-				}
+			let keys = Object.keys(support.outlineGroupLabel);
+			for (let i = 0, len = keys.length; i < len; i++) {
+				let key = keys[i];
+				groupLabels[key] = support.outlineGroupLabel[key];
 			}
 		}
 
@@ -65,7 +65,7 @@ export function getOutlineEntries(model: IModel): TPromise<IOutline> {
 }
 
 function compareEntriesUsingStart(a: IOutlineEntry, b: IOutlineEntry): number{
-	return Range.compareRangesUsingStarts(a.range, b.range);
+	return Range.compareRangesUsingStarts(Range.lift(a.range), Range.lift(b.range));
 }
 
 function flatten(bucket: IOutlineEntry[], entries: IOutlineEntry[], overrideContainerLabel: string): void {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/contrib/suggest/browser/suggestWidget.ts
code:
@@ -27,6 +27,7 @@ import {CONTEXT_SUGGESTION_SUPPORTS_ACCEPT_ON_KEY, SuggestRegistry} from '../com
 import {CompletionItem, CompletionModel} from './completionModel';
 import {ICancelEvent, ISuggestEvent, ITriggerEvent, SuggestModel} from './suggestModel';
 import {alert} from 'vs/base/browser/ui/aria/aria';
+import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 
 interface ISuggestionTemplateData {
 	root: HTMLElement;
@@ -83,9 +84,9 @@ class Renderer implements IRenderer<CompletionItem, ISuggestionTemplateData> {
 			data.root.setAttribute('aria-label', nls.localize('suggestionAriaLabel', "{0}, suggestion", suggestion.label));
 		}
 
-		if (suggestion.type && suggestion.type.charAt(0) === '#') {
+		if (suggestion.type === 'customcolor') {
 			data.icon.className = 'icon customcolor';
-			data.colorspan.style.backgroundColor = suggestion.type.substring(1);
+			data.colorspan.style.backgroundColor = suggestion.label;
 		} else {
 			data.icon.className = 'icon ' + suggestion.type;
 			data.colorspan.style.backgroundColor = '';
@@ -180,7 +181,8 @@ class SuggestionDetails {
 	private el: HTMLElement;
 	private title: HTMLElement;
 	private back: HTMLElement;
-	private scrollable: ScrollableElement;
+	private scrollable: DomNodeScrollable;
+	private scrollbar: ScrollableElement;
 	private body: HTMLElement;
 	private type: HTMLElement;
 	private docs: HTMLElement;
@@ -193,8 +195,9 @@ class SuggestionDetails {
 		this.back = append(header, $('span.go-back.octicon.octicon-mail-reply'));
 		this.back.title = nls.localize('goback', "Go back");
 		this.body = $('.body');
-		this.scrollable = new ScrollableElement(this.body, {});
-		append(this.el, this.scrollable.getDomNode());
+		this.scrollable = new DomNodeScrollable(this.body);
+		this.scrollbar = new ScrollableElement(this.body, this.scrollable, {});
+		append(this.el, this.scrollbar.getDomNode());
 		this.type = append(this.body, $('p.type'));
 		this.docs = append(this.body, $('p.docs'));
 
@@ -227,8 +230,8 @@ class SuggestionDetails {
 			this.widget.toggleDetails();
 		};
 
-		this.scrollable.onElementDimensions();
-		this.scrollable.onElementInternalDimensions();
+		this.scrollbar.onElementDimensions();
+		this.scrollable.onContentsDimensions();
 
 		this.ariaLabel = strings.format('{0}\n{1}\n{2}', item.suggestion.label || '', item.suggestion.typeLabel || '', item.suggestion.documentationLabel || '');
 	}
@@ -254,6 +257,9 @@ class SuggestionDetails {
 	}
 
 	dispose(): void {
+		this.scrollbar.dispose();
+		this.scrollable.dispose();
+
 		this.el.parentElement.removeChild(this.el);
 		this.el = null;
 	}
@@ -548,7 +554,10 @@ export class SuggestWidget implements IContentWidget, IDisposable {
 	}
 
 	private onDidSuggest(e: ISuggestEvent): void {
-		clearTimeout(this.loadingTimeout);
+		if (this.loadingTimeout) {
+			clearTimeout(this.loadingTimeout);
+			this.loadingTimeout = null;
+		}
 
 		this.completionModel = e.completionModel;
 
@@ -609,7 +618,10 @@ export class SuggestWidget implements IContentWidget, IDisposable {
 	}
 
 	private onDidCancel(e: ICancelEvent) {
-		clearTimeout(this.loadingTimeout);
+		if (this.loadingTimeout) {
+			clearTimeout(this.loadingTimeout);
+			this.loadingTimeout = null;
+		}
 
 		if (!e.retrigger) {
 			this.setState(State.Hidden);
@@ -821,8 +833,10 @@ export class SuggestWidget implements IContentWidget, IDisposable {
 		this.toDispose = dispose(this.toDispose);
 		this._onDidVisibilityChange.dispose();
 		this._onDidVisibilityChange = null;
-		clearTimeout(this.loadingTimeout);
-		this.loadingTimeout = null;
+		if (this.loadingTimeout) {
+			clearTimeout(this.loadingTimeout);
+			this.loadingTimeout = null;
+		}
 
 		if (this.editorBlurTimeout) {
 			this.editorBlurTimeout.cancel();

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/mocks/mockConfiguration.ts
code:
@@ -30,6 +30,7 @@ export class MockConfiguration extends CommonEditorConfiguration {
 		return {
 			typicalHalfwidthCharacterWidth: 10,
 			typicalFullwidthCharacterWidth: 20,
+			spaceWidth: 10,
 			maxDigitWidth: 10,
 			lineHeight: 20,
 			font: 'mockFont',

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/model/model.line.test.ts
code:
@@ -5,14 +5,15 @@
 'use strict';
 
 import * as assert from 'assert';
-import {ILineTokens, LineTokensBinaryEncoding} from 'vs/editor/common/editorCommon';
+import {ILineTokens} from 'vs/editor/common/editorCommon';
 import * as modelLine from 'vs/editor/common/model/modelLine';
 import {LineMarker} from 'vs/editor/common/model/textModelWithMarkers';
 import {TokensInflatorMap} from 'vs/editor/common/model/textModelWithTokens';
 import {IToken} from 'vs/editor/common/modes';
+import * as TokensBinaryEncoding from 'vs/editor/common/model/tokensBinaryEncoding';
 
 function assertLineTokens(actual:ILineTokens, expected:IToken[]): void {
-	var inflatedActual = LineTokensBinaryEncoding.inflateArr(actual.getBinaryEncodedTokensMap(), actual.getBinaryEncodedTokens());
+	var inflatedActual = TokensBinaryEncoding.inflateArr(actual.getBinaryEncodedTokensMap(), actual.getBinaryEncodedTokens());
 	assert.deepEqual(inflatedActual, expected, 'Line tokens are equal');
 }
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/modesTestUtils.ts
code:
@@ -8,6 +8,7 @@ import {Arrays} from 'vs/editor/common/core/arrays';
 import * as modes from 'vs/editor/common/modes';
 import {RichEditSupport} from 'vs/editor/common/modes/supports/richEditSupport';
 import {MockMode} from 'vs/editor/test/common/mocks/mockMode';
+import {ModeTransition} from 'vs/editor/common/core/modeTransition';
 
 class ModeWithRichEditSupport extends MockMode {
 
@@ -45,16 +46,16 @@ export function createLineContextFromTokenText(tokens: TokenText[]): modes.ILine
 }
 
 export function createMockLineContext(line:string, tokens:modes.ILineTokens): modes.ILineContext {
-	return new TestLineContext(line, tokens.tokens, tokens.modeTransitions);
+	return new TestLineContext(line, tokens.tokens, ModeTransition.create(tokens.modeTransitions));
 }
 
 class TestLineContext implements modes.ILineContext {
 
-	public modeTransitions: modes.IModeTransition[];
+	public modeTransitions: ModeTransition[];
 	private _line:string;
 	private _tokens: modes.IToken[];
 
-	constructor(line:string, tokens: modes.IToken[], modeTransitions:modes.IModeTransition[]) {
+	constructor(line:string, tokens: modes.IToken[], modeTransitions:ModeTransition[]) {
 		this.modeTransitions = modeTransitions;
 		this._line = line;
 		this._tokens = tokens;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/viewLayout/viewLineParts.test.ts
code:
@@ -6,17 +6,13 @@
 
 import * as assert from 'assert';
 import {DecorationSegment, ILineDecoration, LineDecorationsNormalizer} from 'vs/editor/common/viewLayout/viewLineParts';
+import {Range} from 'vs/editor/common/core/range';
 
 suite('Editor ViewLayout - ViewLineParts', () => {
 
 	function newDecoration(startLineNumber:number, startColumn:number, endLineNumber:number, endColumn:number, inlineClassName:string): ILineDecoration {
 		return {
-			range: {
-				startLineNumber: startLineNumber,
-				startColumn: startColumn,
-				endLineNumber: endLineNumber,
-				endColumn: endColumn
-			},
+			range: new Range(startLineNumber, startColumn, endLineNumber, endColumn),
 			options: {
 				inlineClassName: inlineClassName
 			}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/viewLayout/viewLineRenderer.test.ts
code:
@@ -5,28 +5,26 @@
 'use strict';
 
 import * as assert from 'assert';
-import {ILineToken} from 'vs/editor/common/editorCommon';
-import {renderLine} from 'vs/editor/common/viewLayout/viewLineRenderer';
+import {LineToken} from 'vs/editor/common/editorCommon';
+import {renderLine, RenderLineInput} from 'vs/editor/common/viewLayout/viewLineRenderer';
 
 suite('viewLineRenderer.renderLine', () => {
 
-	function createPart(startIndex: number, type:string): ILineToken {
-		return {
-			startIndex: startIndex,
-			type: type
-		};
+	function createPart(startIndex: number, type:string): LineToken {
+		return new LineToken(startIndex, type);
 	}
 
 	function assertCharacterReplacement(lineContent:string, tabSize:number, expected:string, expectedCharOffsetInPart: number[]): void {
-		let _actual = renderLine({
-			lineContent: lineContent,
-			tabSize: tabSize,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			parts: [createPart(0, '')]
-		});
+		let _actual = renderLine(new RenderLineInput(
+			lineContent,
+			tabSize,
+			0,
+			-1,
+			false,
+			[createPart(0, '')]
+		));
 
-		assert.equal(_actual.output.join(''), '<span><span class="token ">' + expected + '</span></span>');
+		assert.equal(_actual.output, '<span><span class="token ">' + expected + '</span></span>');
 		assert.deepEqual(_actual.charOffsetInPart, expectedCharOffsetInPart);
 	}
 
@@ -57,16 +55,17 @@ suite('viewLineRenderer.renderLine', () => {
 		assertCharacterReplacement('xxxx\t', 4, 'xxxx&nbsp;&nbsp;&nbsp;&nbsp;', [0, 1, 2, 3, 4, 8]);
 	});
 
-	function assertParts(lineContent:string, tabSize:number, parts: ILineToken[], expected:string, expectedCharOffsetInPart:number[]): void {
-		let _actual = renderLine({
-			lineContent: lineContent,
-			tabSize: tabSize,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			parts: parts
-		});
+	function assertParts(lineContent:string, tabSize:number, parts: LineToken[], expected:string, expectedCharOffsetInPart:number[]): void {
+		let _actual = renderLine(new RenderLineInput(
+			lineContent,
+			tabSize,
+			0,
+			-1,
+			false,
+			parts
+		));
 
-		assert.equal(_actual.output.join(''), '<span>' + expected + '</span>');
+		assert.equal(_actual.output, '<span>' + expected + '</span>');
 		assert.deepEqual(_actual.charOffsetInPart, expectedCharOffsetInPart);
 	}
 
@@ -87,9 +86,13 @@ suite('viewLineRenderer.renderLine', () => {
 	});
 
 	test('overflow', () => {
-		let _actual = renderLine({
-			lineContent: 'Hello world!',
-			parts: [
+		let _actual = renderLine(new RenderLineInput(
+			'Hello world!',
+			4,
+			10,
+			6,
+			true,
+			[
 				createPart( 0,  '0'),
 				createPart( 1,  '1'),
 				createPart( 2,  '2'),
@@ -102,11 +105,8 @@ suite('viewLineRenderer.renderLine', () => {
 				createPart( 9,  '9'),
 				createPart(10, '10'),
 				createPart(11, '11'),
-			],
-			tabSize: 4,
-			stopRenderingLineAfter: 6,
-			renderWhitespace: true,
-		});
+			]
+		));
 
 		let expectedOutput = [
 			'<span class="token 0">H</span>',
@@ -117,7 +117,7 @@ suite('viewLineRenderer.renderLine', () => {
 			'<span class="token 5">&nbsp;&hellip;</span>'
 		].join('');
 
-		assert.equal(_actual.output.join(''), '<span>' + expectedOutput + '</span>');
+		assert.equal(_actual.output, '<span>' + expectedOutput + '</span>');
 		assert.deepEqual(_actual.charOffsetInPart, [
 			0,
 			0,
@@ -145,7 +145,7 @@ suite('viewLineRenderer.renderLine', () => {
 			createPart(43, 'block body comment declaration line meta object ts trailing whitespace'),
 		];
 		let expectedOutput = [
-			'<span class="token block meta ts leading whitespace">&rarr;&nbsp;&nbsp;&nbsp;&middot;&middot;&middot;&middot;</span>',
+			'<span class="token block meta ts leading whitespace" style="width:80px">&rarr;&nbsp;&nbsp;&nbsp;&middot;&middot;&middot;&middot;</span>',
 			'<span class="token block declaration meta modifier object storage ts">export</span>',
 			'<span class="token block declaration meta object ts">&nbsp;</span>',
 			'<span class="token block declaration meta object storage type ts">class</span>',
@@ -156,7 +156,7 @@ suite('viewLineRenderer.renderLine', () => {
 			'<span class="token block body declaration meta object ts">&nbsp;</span>',
 			'<span class="token block body comment declaration line meta object ts">//&nbsp;</span>',
 			'<span class="token block body comment declaration line meta object ts detected-link">http://test.com</span>',
-			'<span class="token block body comment declaration line meta object ts trailing whitespace">&middot;&middot;&middot;&middot;&middot;</span>'
+			'<span class="token block body comment declaration line meta object ts trailing whitespace" style="width:50px">&middot;&middot;&middot;&middot;&middot;</span>'
 		].join('');
 		let expectedOffsetsArr = [
 			[0, 4, 5, 6, 7],
@@ -174,15 +174,16 @@ suite('viewLineRenderer.renderLine', () => {
 		];
 		let expectedOffsets = expectedOffsetsArr.reduce((prev, curr) => prev.concat(curr), []);
 
-		let _actual = renderLine({
-			lineContent: lineText,
-			tabSize: 4,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: true,
-			parts: lineParts
-		});
+		let _actual = renderLine(new RenderLineInput(
+			lineText,
+			4,
+			10,
+			-1,
+			true,
+			lineParts
+		));
 
-		assert.equal(_actual.output.join(''), '<span>' + expectedOutput + '</span>');
+		assert.equal(_actual.output, '<span>' + expectedOutput + '</span>');
 		assert.deepEqual(_actual.charOffsetInPart, expectedOffsets);
 	});
 
@@ -227,15 +228,16 @@ suite('viewLineRenderer.renderLine', () => {
 		];
 		let expectedOffsets = expectedOffsetsArr.reduce((prev, curr) => prev.concat(curr), []);
 
-		let _actual = renderLine({
-			lineContent: lineText,
-			tabSize: 4,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			parts: lineParts
-		});
+		let _actual = renderLine(new RenderLineInput(
+			lineText,
+			4,
+			10,
+			-1,
+			false,
+			lineParts
+		));
 
-		assert.equal(_actual.output.join(''), '<span>' + expectedOutput + '</span>');
+		assert.equal(_actual.output, '<span>' + expectedOutput + '</span>');
 		assert.deepEqual(_actual.charOffsetInPart, expectedOffsets);
 	});
 
@@ -280,15 +282,16 @@ suite('viewLineRenderer.renderLine', () => {
 		];
 		let expectedOffsets = expectedOffsetsArr.reduce((prev, curr) => prev.concat(curr), []);
 
-		let _actual = renderLine({
-			lineContent: lineText,
-			tabSize: 4,
-			stopRenderingLineAfter: -1,
-			renderWhitespace: false,
-			parts: lineParts
-		});
+		let _actual = renderLine(new RenderLineInput(
+			lineText,
+			4,
+			10,
+			-1,
+			false,
+			lineParts
+		));
 
-		assert.equal(_actual.output.join(''), '<span>' + expectedOutput + '</span>');
+		assert.equal(_actual.output, '<span>' + expectedOutput + '</span>');
 		assert.deepEqual(_actual.charOffsetInPart, expectedOffsets);
 	});
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/viewModel/characterHardWrappingLineMapper.test.ts
code:
@@ -7,7 +7,7 @@
 import * as assert from 'assert';
 import {WrappingIndent} from 'vs/editor/common/editorCommon';
 import {CharacterHardWrappingLineMapperFactory} from 'vs/editor/common/viewModel/characterHardWrappingLineMapper';
-import {ILineMapperFactory, ILineMapping, IOutputPosition} from 'vs/editor/common/viewModel/splitLinesCollection';
+import {ILineMapperFactory, ILineMapping, OutputPosition} from 'vs/editor/common/viewModel/splitLinesCollection';
 
 function safeGetOutputLineCount(mapper:ILineMapping): number {
 	if (!mapper) {
@@ -16,13 +16,11 @@ function safeGetOutputLineCount(mapper:ILineMapping): number {
 	return mapper.getOutputLineCount();
 }
 
-function safeGetOutputPositionOfInputOffset(mapper:ILineMapping, inputOffset:number, result:IOutputPosition): void {
+function safeGetOutputPositionOfInputOffset(mapper:ILineMapping, inputOffset:number): OutputPosition {
 	if (!mapper) {
-		result.outputLineIndex = 0;
-		result.outputOffset = inputOffset;
-		return;
+		return new OutputPosition(0, inputOffset);
 	}
-	mapper.getOutputPositionOfInputOffset(inputOffset, result);
+	return mapper.getOutputPositionOfInputOffset(inputOffset);
 }
 
 function safeGetInputOffsetOfOutputPosition(mapper:ILineMapping, outputLineIndex:number, outputOffset:number): number {
@@ -34,26 +32,21 @@ function safeGetInputOffsetOfOutputPosition(mapper:ILineMapping, outputLineIndex
 
 function assertMappingIdentity(mapper:ILineMapping, offset:number, expectedLineIndex:number) {
 
-	var result = {
-		outputLineIndex: -1,
-		outputOffset: -1
-	};
-
-	safeGetOutputPositionOfInputOffset(mapper, offset, result);
+	let result = safeGetOutputPositionOfInputOffset(mapper, offset);
 	assert.ok(result.outputLineIndex !== -1);
 	assert.ok(result.outputOffset !== -1);
 	assert.equal(result.outputLineIndex, expectedLineIndex);
 
-	var actualOffset = safeGetInputOffsetOfOutputPosition(mapper, result.outputLineIndex, result.outputOffset);
+	let actualOffset = safeGetInputOffsetOfOutputPosition(mapper, result.outputLineIndex, result.outputOffset);
 	assert.equal(actualOffset, offset);
 }
 
 function assertLineMapping(factory:ILineMapperFactory, tabSize:number, breakAfter:number, annotatedText:string) {
 
-	var rawText = '';
-	var currentLineIndex = 0;
-	var lineIndices:number[] = [];
-	for (var i = 0, len = annotatedText.length; i < len; i++) {
+	let rawText = '';
+	let currentLineIndex = 0;
+	let lineIndices:number[] = [];
+	for (let i = 0, len = annotatedText.length; i < len; i++) {
 		if (annotatedText.charAt(i) === '|') {
 			currentLineIndex++;
 		} else {
@@ -65,15 +58,15 @@ function assertLineMapping(factory:ILineMapperFactory, tabSize:number, breakAfte
 	var mapper = factory.createLineMapping(rawText, tabSize, breakAfter, 2, WrappingIndent.None);
 
 	assert.equal(safeGetOutputLineCount(mapper), (lineIndices.length > 0 ? lineIndices[lineIndices.length - 1] + 1 : 1));
-	for (var i = 0, len = rawText.length; i < len; i++) {
+	for (let i = 0, len = rawText.length; i < len; i++) {
 		assertMappingIdentity(mapper, i, lineIndices[i]);
 	}
 }
 
 suite('Editor ViewModel - CharacterHardWrappingLineMapper', () => {
 	test('CharacterHardWrappingLineMapper', () => {
 
-		var factory = new CharacterHardWrappingLineMapperFactory('(', ')', '.');
+		let factory = new CharacterHardWrappingLineMapperFactory('(', ')', '.');
 
 		// Empty string
 		assertLineMapping(factory, 4, 5, '');

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/editor/test/common/viewModel/prefixSumComputer.test.ts
code:
@@ -5,15 +5,12 @@
 'use strict';
 
 import * as assert from 'assert';
-import {IPrefixSumIndexOfResult, PrefixSumComputer} from 'vs/editor/common/viewModel/prefixSumComputer';
+import {PrefixSumComputer, PrefixSumIndexOfResult} from 'vs/editor/common/viewModel/prefixSumComputer';
 
 suite('Editor ViewModel - PrefixSumComputer', () => {
 
 	test('PrefixSumComputer', () => {
-		var indexOfResult:IPrefixSumIndexOfResult = {
-			index: 0,
-			remainder: 0
-		};
+		let indexOfResult:PrefixSumIndexOfResult;
 
 		var psc = new PrefixSumComputer([1, 1, 2, 1, 3]);
 		assert.equal(psc.getTotalValue(), 8);
@@ -23,31 +20,31 @@ suite('Editor ViewModel - PrefixSumComputer', () => {
 		assert.equal(psc.getAccumulatedValue(2), 4);
 		assert.equal(psc.getAccumulatedValue(3), 5);
 		assert.equal(psc.getAccumulatedValue(4), 8);
-		psc.getIndexOf(0, indexOfResult);
+		indexOfResult = psc.getIndexOf(0);
 		assert.equal(indexOfResult.index, 0);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(1, indexOfResult);
+		indexOfResult = psc.getIndexOf(1);
 		assert.equal(indexOfResult.index, 1);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(2, indexOfResult);
+		indexOfResult = psc.getIndexOf(2);
 		assert.equal(indexOfResult.index, 2);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(3, indexOfResult);
+		indexOfResult = psc.getIndexOf(3);
 		assert.equal(indexOfResult.index, 2);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(4, indexOfResult);
+		indexOfResult = psc.getIndexOf(4);
 		assert.equal(indexOfResult.index, 3);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(5, indexOfResult);
+		indexOfResult = psc.getIndexOf(5);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(6, indexOfResult);
+		indexOfResult = psc.getIndexOf(6);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(7, indexOfResult);
+		indexOfResult = psc.getIndexOf(7);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 2);
-		psc.getIndexOf(8, indexOfResult);
+		indexOfResult = psc.getIndexOf(8);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 3);
 
@@ -68,28 +65,28 @@ suite('Editor ViewModel - PrefixSumComputer', () => {
 		assert.equal(psc.getAccumulatedValue(2), 3);
 		assert.equal(psc.getAccumulatedValue(3), 4);
 		assert.equal(psc.getAccumulatedValue(4), 7);
-		psc.getIndexOf(0, indexOfResult);
+		indexOfResult = psc.getIndexOf(0);
 		assert.equal(indexOfResult.index, 0);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(1, indexOfResult);
+		indexOfResult = psc.getIndexOf(1);
 		assert.equal(indexOfResult.index, 2);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(2, indexOfResult);
+		indexOfResult = psc.getIndexOf(2);
 		assert.equal(indexOfResult.index, 2);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(3, indexOfResult);
+		indexOfResult = psc.getIndexOf(3);
 		assert.equal(indexOfResult.index, 3);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(4, indexOfResult);
+		indexOfResult = psc.getIndexOf(4);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(5, indexOfResult);
+		indexOfResult = psc.getIndexOf(5);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(6, indexOfResult);
+		indexOfResult = psc.getIndexOf(6);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 2);
-		psc.getIndexOf(7, indexOfResult);
+		indexOfResult = psc.getIndexOf(7);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 3);
 
@@ -101,22 +98,22 @@ suite('Editor ViewModel - PrefixSumComputer', () => {
 		assert.equal(psc.getAccumulatedValue(2), 1);
 		assert.equal(psc.getAccumulatedValue(3), 2);
 		assert.equal(psc.getAccumulatedValue(4), 5);
-		psc.getIndexOf(0, indexOfResult);
+		indexOfResult = psc.getIndexOf(0);
 		assert.equal(indexOfResult.index, 0);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(1, indexOfResult);
+		indexOfResult = psc.getIndexOf(1);
 		assert.equal(indexOfResult.index, 3);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(2, indexOfResult);
+		indexOfResult = psc.getIndexOf(2);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(3, indexOfResult);
+		indexOfResult = psc.getIndexOf(3);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(4, indexOfResult);
+		indexOfResult = psc.getIndexOf(4);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 2);
-		psc.getIndexOf(5, indexOfResult);
+		indexOfResult = psc.getIndexOf(5);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 3);
 
@@ -128,19 +125,19 @@ suite('Editor ViewModel - PrefixSumComputer', () => {
 		assert.equal(psc.getAccumulatedValue(2), 1);
 		assert.equal(psc.getAccumulatedValue(3), 1);
 		assert.equal(psc.getAccumulatedValue(4), 4);
-		psc.getIndexOf(0, indexOfResult);
+		indexOfResult = psc.getIndexOf(0);
 		assert.equal(indexOfResult.index, 0);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(1, indexOfResult);
+		indexOfResult = psc.getIndexOf(1);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(2, indexOfResult);
+		indexOfResult = psc.getIndexOf(2);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 1);
-		psc.getIndexOf(3, indexOfResult);
+		indexOfResult = psc.getIndexOf(3);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 2);
-		psc.getIndexOf(4, indexOfResult);
+		indexOfResult = psc.getIndexOf(4);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 3);
 
@@ -154,19 +151,19 @@ suite('Editor ViewModel - PrefixSumComputer', () => {
 		assert.equal(psc.getAccumulatedValue(2), 2);
 		assert.equal(psc.getAccumulatedValue(3), 3);
 		assert.equal(psc.getAccumulatedValue(4), 4);
-		psc.getIndexOf(0, indexOfResult);
+		indexOfResult = psc.getIndexOf(0);
 		assert.equal(indexOfResult.index, 0);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(1, indexOfResult);
+		indexOfResult = psc.getIndexOf(1);
 		assert.equal(indexOfResult.index, 1);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(2, indexOfResult);
+		indexOfResult = psc.getIndexOf(2);
 		assert.equal(indexOfResult.index, 3);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(3, indexOfResult);
+		indexOfResult = psc.getIndexOf(3);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 0);
-		psc.getIndexOf(4, indexOfResult);
+		indexOfResult = psc.getIndexOf(4);
 		assert.equal(indexOfResult.index, 4);
 		assert.equal(indexOfResult.remainder, 1);
 	});

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/css/common/services/intelliSense.ts
code:
@@ -160,14 +160,13 @@ export class CSSIntellisense {
 
 	public getValueEnumProposals(entry:languageFacts.IEntry, result:Modes.ISuggestion[]):Modes.ISuggestion[]{
 		if (entry.values) {
-			var type = 'value';
 			entry.values.forEach((value) => {
 				if (languageFacts.isCommonValue(value)) { // only show if supported by more than one browser
 					result.push({
 						label: value.name,
 						documentationLabel: languageFacts.getEntryDescription(value),
 						codeSnippet: value.name,
-						type: type
+						type: 'value'
 					});
 				}
 			});
@@ -237,7 +236,7 @@ export class CSSIntellisense {
 					label: color,
 					documentationLabel: languageFacts.colors[color],
 					codeSnippet: color,
-					type: '#' + languageFacts.colors[color]
+					type: 'customcolor'
 				});
 			}
 			for (var color in languageFacts.colorKeywords) {
@@ -254,7 +253,7 @@ export class CSSIntellisense {
 				result.push({
 					label: color,
 					codeSnippet: color,
-					type: '#' + color
+					type: 'customcolor'
 				});
 			});
 			CSSIntellisense.colorFunctions.forEach((p) => {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/css/test/common/css-worker.test.ts
code:
@@ -253,7 +253,7 @@ suite('Validation - CSS', () => {
 			}),
 			testSuggestionsFor('.foo { background-color: #123456; } .bar { background-color: }', '.bar { background-color:').then(function(completion: Modes.ISuggestResult): void {
 				assert.equal(completion.currentWord, '');
-				assertSuggestion(completion, '#123456', '##123456');
+				assertSuggestion(completion, '#123456', 'customcolor');
 			}),
 			testSuggestionsFor('.foo { unknown: foo; } .bar { unknown: }', '.bar { unknown:').then(function(completion: Modes.ISuggestResult): void {
 				assert.equal(completion.currentWord, '');
@@ -263,7 +263,7 @@ suite('Validation - CSS', () => {
 				assert.equal(completion.currentWord, 'r');
 				assertSuggestion(completion, 'rgb', 'function');
 				assertSuggestion(completion, 'rgba', 'function');
-				assertSuggestion(completion, 'red', '##ff0000');
+				assertSuggestion(completion, 'red', 'customcolor');
 			})
 		]).done(() => testDone(), (errors: any[]) => {
 			testDone(errors.reduce((e1, e2) => e1 || e2));

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/json/common/contributions/bowerJSONContribution.ts
code:
@@ -44,7 +44,7 @@ export class BowerJSONContribution implements JSONWorker.IJSONWorkerContribution
 				'main': '{{pathToMain}}',
 				'dependencies': {}
 			};
-			result.add({ type: 'type', label: nls.localize('json.bower.default', 'Default bower.json'), codeSnippet: JSON.stringify(defaultValue, null, '\t'), documentationLabel: '' });
+			result.add({ type: 'snippet', label: nls.localize('json.bower.default', 'Default bower.json'), codeSnippet: JSON.stringify(defaultValue, null, '\t'), documentationLabel: '' });
 		}
 		return null;
 	}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/json/common/contributions/projectJSONContribution.ts
code:
@@ -38,7 +38,7 @@ export class ProjectJSONContribution implements JSONWorker.IJSONWorkerContributi
 					'dnxcore50': {}
 				}
 			};
-			result.add({ type: 'type', label: nls.localize('json.project.default', 'Default project.json'), codeSnippet: JSON.stringify(defaultValue, null, '\t'), documentationLabel: '' });
+			result.add({ type: 'snippet', label: nls.localize('json.project.default', 'Default project.json'), codeSnippet: JSON.stringify(defaultValue, null, '\t'), documentationLabel: '' });
 		}
 		return null;
 	}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/json/common/jsonIntellisense.ts
code:
@@ -397,7 +397,7 @@ export class JSONIntellisense {
 		return snippet;
 	}
 
-	private getSuggestionType(type: any): string {
+	private getSuggestionType(type: any): Modes.SuggestionType {
 		if (Array.isArray(type)) {
 			var array = <any[]> type;
 			type = array.length > 0 ? array[0] : null;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/languages/typescript/common/languageFeatures.ts
code:
@@ -188,7 +188,7 @@ class SuggestAdapter extends Adapter implements modes.ISuggestSupport {
 				return <modes.ISuggestion>{
 					label: entry.name,
 					codeSnippet: entry.name,
-					type: entry.kind
+					type: SuggestAdapter.asType(entry.kind)
 				};
 			});
 
@@ -213,13 +213,33 @@ class SuggestAdapter extends Adapter implements modes.ISuggestSupport {
 			return <modes.ISuggestion>{
 				label: details.name,
 				codeSnippet: details.name,
-				type: details.kind,
+				type: SuggestAdapter.asType(details.kind),
 				typeLabel: ts.displayPartsToString(details.displayParts),
 				documentationLabel: ts.displayPartsToString(details.documentation)
 			};
 		});
 	}
 
+	static asType(kind: string): modes.SuggestionType{
+		switch (kind) {
+			case 'getter':
+			case 'setting':
+			case 'constructor':
+			case 'method':
+			case 'property':
+				return 'property';
+			case 'function':
+			case 'local function':
+				return 'function';
+			case 'class':
+				return 'class';
+			case 'interface':
+				return 'interface';
+		}
+
+		return 'variable';
+	}
+
 	getFilter(): modes.ISuggestionFilter {
 		return;
 	}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/platform/extensions/common/ipcRemoteCom.ts
code:
@@ -9,47 +9,153 @@ import marshalling = require('vs/base/common/marshalling');
 import remote = require('vs/base/common/remote');
 import errors = require('vs/base/common/errors');
 
-interface IRPCReply {
-	c: winjs.ValueCallback;
-	e: winjs.ErrorCallback;
-	p: winjs.ProgressCallback;
-}
-
 interface IRPCFunc {
 	(rpcId: string, method: string, args: any[]): winjs.TPromise<any>;
 }
 
-const pendingRPCReplies: { [msgId: string]: IRPCReply; } = {};
+const pendingRPCReplies: { [msgId: string]: LazyPromise; } = {};
+
+class MessageFactory {
+	public static cancel(req:string): string {
+		return `{"cancel":"${req}"}`;
+	}
+
+	public static request(req:string, rpcId:string, method:string, args:any[]): string {
+		return `{"req":"${req}","rpcId":"${rpcId}","method":"${method}","args":${marshalling.stringify(args)}}`;
+	}
+
+	public static replyOK(req:string, res:any): string {
+		if (typeof res === 'undefined') {
+			return `{"seq":"${req}"}`;
+		}
+		return `{"seq":"${req}","res":${marshalling.stringify(res)}}`;
+	}
+
+	public static replyErr(req:string, err:any): string {
+		if (typeof err === 'undefined') {
+			return `{"seq":"${req}","err":null}`;
+		}
+		return `{"seq":"${req}","err":${marshalling.stringify(errors.transformErrorForSerialization(err))}}`;
+	}
+}
+
+class LazyPromise {
+
+	private _onCancel: ()=>void;
+
+	private _actual: winjs.TPromise<any>;
+	private _actualOk: winjs.ValueCallback;
+	private _actualErr: winjs.ErrorCallback;
+
+	private _hasValue: boolean;
+	private _value: any;
+
+	private _hasErr: boolean;
+	private _err: any;
+
+	private _isCanceled: boolean;
+
+	constructor(onCancel: ()=>void) {
+		this._onCancel = onCancel;
+		this._actual = null;
+		this._actualOk = null;
+		this._actualErr = null;
+		this._hasValue = false;
+		this._value = null;
+		this._hasErr = false;
+		this._err = null;
+		this._isCanceled = false;
+	}
+
+	private _ensureActual(): winjs.TPromise<any> {
+		if (!this._actual) {
+			this._actual = new winjs.TPromise<any>((c, e) => {
+				this._actualOk = c;
+				this._actualErr = e;
+			}, this._onCancel);
+
+			if (this._hasValue) {
+				this._actualOk(this._value);
+			}
+
+			if (this._hasErr) {
+				this._actualErr(this._err);
+			}
+		}
+		return this._actual;
+	}
+
+	public resolveOk(value:any): void {
+		if (this._isCanceled || this._hasErr) {
+			return;
+		}
+
+		this._hasValue = true;
+		this._value = value;
 
-function createRPC(serializeAndSend: (obj: any) => void): IRPCFunc {
+		if (this._actual) {
+			this._actualOk(value);
+		}
+	}
+
+	public resolveErr(err:any): void {
+		if (this._isCanceled || this._hasValue) {
+			return;
+		}
+
+		this._hasErr = true;
+		this._err = err;
+
+		if (this._actual) {
+			this._actualErr(err);
+		}
+	}
+
+	public then(success:any, error:any): any {
+		if (this._isCanceled) {
+			return;
+		}
+
+		return this._ensureActual().then(success, error);
+	}
+
+	public done(success:any, error:any): void {
+		if (this._isCanceled) {
+			return;
+		}
+
+		this._ensureActual().done(success, error);
+	}
+
+	public cancel(): void {
+		if (this._hasValue || this._hasErr) {
+			return;
+		}
+
+		this._isCanceled = true;
+
+		if (this._actual) {
+			this._actual.cancel();
+		} else {
+			this._onCancel();
+		}
+	}
+}
+
+function createRPC(serializeAndSend: (value: string) => void): IRPCFunc {
 	let lastMessageId = 0;
 
 	return function rpc(rpcId: string, method: string, args: any[]): winjs.TPromise<any> {
 		let req = String(++lastMessageId);
-		let reply: IRPCReply = {
-			c: null,
-			e: null,
-			p: null
-		};
-		let r = new winjs.TPromise<any>((c, e, p) => {
-			reply.c = c;
-			reply.e = e;
-			reply.p = p;
-		}, () => {
-			serializeAndSend({
-				cancel: req
-			});
+		let result = new LazyPromise(() => {
+			serializeAndSend(MessageFactory.cancel(req));
 		});
-		pendingRPCReplies[req] = reply;
 
-		serializeAndSend({
-			req: req,
-			rpcId: rpcId,
-			method: method,
-			args: args
-		});
+		pendingRPCReplies[req] = result;
+
+		serializeAndSend(MessageFactory.request(req, rpcId, method, args));
 
-		return r;
+		return result;
 	};
 }
 
@@ -58,7 +164,7 @@ export interface IMainProcessExtHostIPC extends remote.IRemoteCom {
 }
 
 export function create(send: (obj: string[]) => void): IMainProcessExtHostIPC {
-	let rpc = createRPC(marshallAndSend);
+	let rpc = createRPC(sendDelayed);
 	let bigHandler: remote.IManyHandler = null;
 	let invokedHandlers: { [req: string]: winjs.TPromise<any>; } = Object.create(null);
 	let messagesToSend: string[] = [];
@@ -89,11 +195,11 @@ export function create(send: (obj: string[]) => void): IMainProcessExtHostIPC {
 					err.message = msg.err.message;
 					err.stack = msg.err.stack;
 				}
-				reply.e(err);
+				reply.resolveErr(err);
 				return;
 			}
 
-			reply.c(msg.res);
+			reply.resolveOk(msg.res);
 			return;
 		}
 
@@ -121,16 +227,10 @@ export function create(send: (obj: string[]) => void): IMainProcessExtHostIPC {
 
 		invokedHandlers[req].then((r) => {
 			delete invokedHandlers[req];
-			marshallAndSend({
-				seq: req,
-				res: r
-			});
+			sendDelayed(MessageFactory.replyOK(req, r));
 		}, (err) => {
 			delete invokedHandlers[req];
-			marshallAndSend({
-				seq: req,
-				err: errors.transformErrorForSerialization(err)
-			});
+			sendDelayed(MessageFactory.replyErr(req, err));
 		});
 	};
 
@@ -157,13 +257,10 @@ export function create(send: (obj: string[]) => void): IMainProcessExtHostIPC {
 		send(tmp);
 	}
 
-	function marshallAndSend(msg: any): void {
-		let value = marshalling.stringify(msg);
-
+	function sendDelayed(value: string): void {
 		if (messagesToSend.length === 0) {
 			process.nextTick(sendAccumulated);
 		}
-
 		messagesToSend.push(value);
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/platform/markers/common/problemMatcher.ts
code:
@@ -1101,29 +1101,29 @@ registry.add('gulp-tsc', {
 });
 
 registry.add('jshint', {
-	owner: 'javascript',
+	owner: 'jshint',
 	applyTo: ApplyToKind.allDocuments,
 	fileLocation: FileLocationKind.Absolute,
 	pattern: defaultPattern('jshint')
 });
 
 registry.add('jshint-stylish', {
-	owner: 'javascript',
+	owner: 'jshint',
 	applyTo: ApplyToKind.allDocuments,
 	fileLocation: FileLocationKind.Absolute,
 	pattern: defaultPattern('jshint-stylish')
 });
 
 registry.add('eslint-compact', {
-	owner: 'javascript',
+	owner: 'eslint',
 	applyTo: ApplyToKind.allDocuments,
 	fileLocation: FileLocationKind.Relative,
 	filePrefix: '${cwd}',
 	pattern: defaultPattern('eslint-compact')
 });
 
 registry.add('eslint-stylish', {
-	owner: 'javascript',
+	owner: 'eslint',
 	applyTo: ApplyToKind.allDocuments,
 	fileLocation: FileLocationKind.Absolute,
 	pattern: defaultPattern('eslint-stylish')

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/api/node/extHostDocuments.ts
code:
@@ -8,7 +8,6 @@ import {toErrorMessage, onUnexpectedError} from 'vs/base/common/errors';
 import {IEmitterEvent} from 'vs/base/common/eventEmitter';
 import {IModelService} from 'vs/editor/common/services/modelService';
 import * as EditorCommon from 'vs/editor/common/editorCommon';
-import {IPrefixSumIndexOfResult} from 'vs/editor/common/viewModel/prefixSumComputer';
 import {MirrorModel2} from 'vs/editor/common/model/mirrorModel2';
 import {Remotable, IThreadService} from 'vs/platform/thread/common/thread';
 import Event, {Emitter} from 'vs/base/common/event';
@@ -378,8 +377,7 @@ export class ExtHostDocumentData extends MirrorModel2 {
 		offset = Math.max(0, offset);
 
 		this._ensureLineStarts();
-		let out: IPrefixSumIndexOfResult = { index: 0, remainder: 0 };
-		this._lineStarts.getIndexOf(offset, out);
+		let out = this._lineStarts.getIndexOf(offset);
 
 		let lineLength = this._lines[out.index].length;
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/api/node/extHostTypeConverters.ts
code:
@@ -354,13 +354,47 @@ export function toDocumentHighlight(occurrence: modes.IOccurence): types.Documen
 		types.DocumentHighlightKind[occurrence.kind.charAt(0).toUpperCase() + occurrence.kind.substr(1)]);
 }
 
+export const CompletionItemKind = {
+
+	from(kind: types.CompletionItemKind): modes.SuggestionType {
+		switch (kind) {
+			case types.CompletionItemKind.Function: return 'function';
+			case types.CompletionItemKind.Constructor: return 'constructor';
+			case types.CompletionItemKind.Field: return 'field';
+			case types.CompletionItemKind.Variable: return 'variable';
+			case types.CompletionItemKind.Class: return 'class';
+			case types.CompletionItemKind.Interface: return 'interface';
+			case types.CompletionItemKind.Module: return 'module';
+			case types.CompletionItemKind.Property: return 'property';
+			case types.CompletionItemKind.Unit: return 'unit';
+			case types.CompletionItemKind.Value: return 'value';
+			case types.CompletionItemKind.Enum: return 'enum';
+			case types.CompletionItemKind.Keyword: return 'keyword';
+			case types.CompletionItemKind.Snippet: return 'snippet';
+			case types.CompletionItemKind.Text: return 'text';
+			case types.CompletionItemKind.Color: return 'color';
+			case types.CompletionItemKind.File: return 'file';
+			case types.CompletionItemKind.Reference: return 'reference';
+		}
+		return 'text';
+	},
+
+	to(type: modes.SuggestionType): types.CompletionItemKind {
+		if (!type) {
+			return types.CompletionItemKind.Text;
+		} else {
+			return types.CompletionItemKind[type.charAt(0).toUpperCase() + type.substr(1)];
+		}
+	}
+};
+
 export const Suggest = {
 
 	from(item: vscode.CompletionItem): modes.ISuggestion {
 		const suggestion: modes.ISuggestion = {
 			label: item.label,
 			codeSnippet: item.insertText || item.label,
-			type: types.CompletionItemKind[item.kind || types.CompletionItemKind.Text].toString().toLowerCase(),
+			type: CompletionItemKind.from(item.kind),
 			typeLabel: item.detail,
 			documentationLabel: item.documentation,
 			sortText: item.sortText,
@@ -372,7 +406,7 @@ export const Suggest = {
 	to(container: modes.ISuggestResult, position: types.Position, suggestion: modes.ISuggestion): types.CompletionItem {
 		const result = new types.CompletionItem(suggestion.label);
 		result.insertText = suggestion.codeSnippet;
-		result.kind = types.CompletionItemKind[suggestion.type.charAt(0).toUpperCase() + suggestion.type.substr(1)];
+		result.kind = CompletionItemKind.to(suggestion.type);
 		result.detail = suggestion.typeLabel;
 		result.documentation = suggestion.documentationLabel;
 		result.sortText = suggestion.sortText;

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/browser/parts/editor/binaryDiffEditor.ts
code:
@@ -20,6 +20,7 @@ import {BinaryEditorModel} from 'vs/workbench/common/editor/binaryEditorModel';
 import {DiffEditorModel} from 'vs/workbench/common/editor/diffEditorModel';
 import {IWorkbenchEditorService} from 'vs/workbench/services/editor/common/editorService';
 import {ITelemetryService} from 'vs/platform/telemetry/common/telemetry';
+import {DomNodeScrollable} from 'vs/base/browser/ui/scrollbar/domNodeScrollable';
 
 /**
  * An implementation of editor for diffing binary files like images or videos.
@@ -31,8 +32,10 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 	private static MIN_CONTAINER_WIDTH = 100;
 
 	private leftBinaryContainer: Builder;
+	private leftScrollable: DomNodeScrollable;
 	private leftScrollbar: IScrollableElement;
 	private rightBinaryContainer: Builder;
+	private rightScrollable: DomNodeScrollable;
 	private rightScrollbar: IScrollableElement;
 	private sash: Sash;
 	private dimension: Dimension;
@@ -59,7 +62,8 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 		this.leftBinaryContainer.tabindex(0); // enable focus support from the editor part (do not remove)
 
 		// Left Custom Scrollbars
-		this.leftScrollbar = new ScrollableElement(leftBinaryContainerElement, { horizontal: 'hidden', vertical: 'hidden' });
+		this.leftScrollable = new DomNodeScrollable(leftBinaryContainerElement);
+		this.leftScrollbar = new ScrollableElement(leftBinaryContainerElement, this.leftScrollable, { horizontal: 'hidden', vertical: 'hidden' });
 		parent.getHTMLElement().appendChild(this.leftScrollbar.getDomNode());
 		$(this.leftScrollbar.getDomNode()).addClass('binarydiff-left');
 
@@ -76,7 +80,8 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 		this.rightBinaryContainer.tabindex(0); // enable focus support from the editor part (do not remove)
 
 		// Right Custom Scrollbars
-		this.rightScrollbar = new ScrollableElement(rightBinaryContainerElement, { horizontal: 'hidden', vertical: 'hidden' });
+		this.rightScrollable = new DomNodeScrollable(rightBinaryContainerElement);
+		this.rightScrollbar = new ScrollableElement(rightBinaryContainerElement, this.rightScrollable, { horizontal: 'hidden', vertical: 'hidden' });
 		parent.getHTMLElement().appendChild(this.rightScrollbar.getDomNode());
 		$(this.rightScrollbar.getDomNode()).addClass('binarydiff-right');
 	}
@@ -127,9 +132,9 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 
 		// Pass to ResourceViewer
 		let container = isOriginal ? this.leftBinaryContainer : this.rightBinaryContainer;
-		let scrollbar = isOriginal ? this.leftScrollbar : this.rightScrollbar;
+		let scrollable = isOriginal ? this.leftScrollable : this.rightScrollable;
 
-		ResourceViewer.show(name, resource, container, scrollbar);
+		ResourceViewer.show(name, resource, container, scrollable);
 	}
 
 	public clearInput(): void {
@@ -165,12 +170,12 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 		// Size left container
 		this.leftBinaryContainer.size(this.leftContainerWidth, this.dimension.height);
 		this.leftScrollbar.onElementDimensions();
-		this.leftScrollbar.onElementInternalDimensions();
+		this.leftScrollable.onContentsDimensions();
 
 		// Size right container
 		this.rightBinaryContainer.size(this.dimension.width - this.leftContainerWidth, this.dimension.height);
 		this.rightScrollbar.onElementDimensions();
-		this.rightScrollbar.onElementInternalDimensions();
+		this.rightScrollable.onContentsDimensions();
 	}
 
 	private onSashDragStart(): void {
@@ -217,7 +222,9 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 
 		// Dispose Scrollbar
 		this.leftScrollbar.dispose();
+		this.leftScrollable.dispose();
 		this.rightScrollbar.dispose();
+		this.rightScrollable.dispose();
 
 		// Destroy Container
 		this.leftBinaryContainer.destroy();

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/browser/parts/editor/editorStatus.ts
code:
@@ -8,7 +8,7 @@
 import 'vs/css!./media/editorstatus';
 import nls = require('vs/nls');
 import {TPromise} from 'vs/base/common/winjs.base';
-import { emmet as $, append } from 'vs/base/browser/dom';
+import { emmet as $, append, runAtThisOrScheduleAtNextAnimationFrame } from 'vs/base/browser/dom';
 import strings = require('vs/base/common/strings');
 import paths = require('vs/base/common/paths');
 import types = require('vs/base/common/types');
@@ -83,13 +83,33 @@ interface IEditorSelectionStatus {
 	charactersSelected?: number;
 }
 
-interface IStateChange {
+class StateChange {
+	_stateChangeTrait: void;
+
 	indentation: boolean;
 	selectionStatus: boolean;
 	mode: boolean;
 	encoding: boolean;
 	EOL: boolean;
 	tabFocusMode: boolean;
+
+	constructor() {
+		this.indentation = false;
+		this.selectionStatus = false;
+		this.mode = false;
+		this.encoding = false;
+		this.EOL = false;
+		this.tabFocusMode = false;
+	}
+
+	public combine(other:StateChange) {
+		this.indentation = this.indentation || other.indentation;
+		this.selectionStatus = this.selectionStatus || other.selectionStatus;
+		this.mode = this.mode || other.mode;
+		this.encoding = this.encoding || other.encoding;
+		this.EOL = this.EOL || other.EOL;
+		this.tabFocusMode = this.tabFocusMode || other.tabFocusMode;
+	}
 }
 
 interface StateDelta {
@@ -128,15 +148,8 @@ class State {
 		this._tabFocusMode = false;
 	}
 
-	public update(update: StateDelta): IStateChange {
-		let e = {
-			selectionStatus: false,
-			mode: false,
-			encoding: false,
-			EOL: false,
-			tabFocusMode: false,
-			indentation: false
-		};
+	public update(update: StateDelta): StateChange {
+		let e = new StateChange();
 		let somethingChanged = false;
 
 		if (typeof update.selectionStatus !== 'undefined') {
@@ -215,6 +228,8 @@ export class EditorStatus implements IStatusbarItem {
 	private eolElement: HTMLElement;
 	private modeElement: HTMLElement;
 	private toDispose: IDisposable[];
+	private delayedRender: IDisposable;
+	private toRender: StateChange;
 
 	constructor(
 		@IWorkbenchEditorService private editorService: IWorkbenchEditorService,
@@ -262,7 +277,18 @@ export class EditorStatus implements IStatusbarItem {
 		this.modeElement.onclick = () => this.onModeClick();
 		hide(this.modeElement);
 
+		this.delayedRender = null;
+		this.toRender = null;
+
 		this.toDispose.push(
+			{
+				dispose: () => {
+					if (this.delayedRender) {
+						this.delayedRender.dispose();
+						this.delayedRender = null;
+					}
+				}
+			},
 			this.eventService.addListener2(EventType.EDITOR_INPUT_CHANGED, (e: EditorEvent) => this.onEditorInputChange(e.editor)),
 			this.eventService.addListener2(EventType.RESOURCE_ENCODING_CHANGED, (e: ResourceEvent) => this.onResourceEncodingChange(e.resource)),
 			this.eventService.addListener2(EventType.TEXT_EDITOR_SELECTION_CHANGED, (e: TextEditorSelectionEvent) => this.onSelectionChange(e.editor)),
@@ -282,6 +308,20 @@ export class EditorStatus implements IStatusbarItem {
 			return;
 		}
 
+		if (!this.toRender) {
+			this.toRender = changed;
+			this.delayedRender = runAtThisOrScheduleAtNextAnimationFrame(() => {
+				this.delayedRender = null;
+				let toRender = this.toRender;
+				this.toRender = null;
+				this._renderNow(toRender);
+			});
+		} else {
+			this.toRender.combine(changed);
+		}
+	}
+
+	private _renderNow(changed:StateChange): void {
 		if (changed.tabFocusMode) {
 			if (this.state.tabFocusMode && this.state.tabFocusMode === true) {
 				show(this.tabFocusModeElement);

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/parts/debug/browser/debugViewer.ts
code:
@@ -662,7 +662,9 @@ export class WatchExpressionsRenderer implements tree.IRenderer {
 	}
 
 	public disposeTemplate(tree: tree.ITree, templateId: string, templateData: any): void {
-		// noop
+		if (templateId === WatchExpressionsRenderer.WATCH_EXPRESSION_TEMPLATE_ID) {
+			(<IWatchExpressionTemplateData>templateData).actionBar.dispose();
+		}
 	}
 
 	public dispose(): void {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/parts/debug/browser/debugViewlet.ts
code:
@@ -282,7 +282,7 @@ class CallStackView extends viewlet.CollapsibleViewletView {
 
 		this.toDispose.push(this.debugService.getViewModel().addListener2(debug.ViewModelEvents.FOCUSED_STACK_FRAME_UPDATED, () => {
 			const focussedThread = this.debugService.getModel().getThreads()[this.debugService.getViewModel().getFocusedThreadId()];
-			if (focussedThread && focussedThread.stoppedDetails && focussedThread.stoppedDetails.reason && focussedThread.stoppedDetails.reason !== 'step') {
+			if (focussedThread && focussedThread.stoppedDetails && focussedThread.stoppedDetails.reason) {
 				this.pauseMessageLabel.text(nls.localize('debugStopped', "Paused on {0}", focussedThread.stoppedDetails.reason));
 				if (focussedThread.stoppedDetails.text) {
 					this.pauseMessageLabel.title(focussedThread.stoppedDetails.text);

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/parts/debug/browser/media/debugViewlet.css
code:
@@ -157,6 +157,10 @@
 	margin-left: 0.8em;
 }
 
+.debug-viewlet .debug-call-stack .load-more {
+	font-style: italic;
+}
+
 /* Variables & Expression view */
 
 .debug-viewlet .scope {

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/parts/files/test/browser/fileEditorInput.test.ts
code:
@@ -103,100 +103,100 @@ suite('Files - FileEditorInput', () => {
 		});
 	});
 
-	// test('Input.matches() - FileEditorInput', function() {
-	// 	let fileEditorInput = new FileEditorInput(toResource('/foo/bar/updatefile.js'), 'text/javascript', void 0, void 0, void 0, void 0);
-	// 	let contentEditorInput2 = new FileEditorInput(toResource('/foo/bar/updatefile.js'), 'text/javascript', void 0, void 0, void 0, void 0);
-
-	// 	assert.strictEqual(fileEditorInput.matches(null), false);
-	// 	assert.strictEqual(fileEditorInput.matches(fileEditorInput), true);
-	// 	assert.strictEqual(fileEditorInput.matches(contentEditorInput2), true);
-	// });
-
-	// test('FileTracker - dispose()', function(done) {
-	// 	let editorService = new TestEditorService(function() { });
-	// 	let telemetryService = new MainTelemetryService();
-	// 	let contextService = new TestContextService();
-
-	// 	let eventService = new TestEventService();
-
-	// 	let instantiationService = createInstantiationService({
-	// 		eventService: eventService,
-	// 		contextService: contextService,
-	// 		fileService: TestFileService,
-	// 		storageService: new TestStorageService(),
-	// 		editorService: editorService,
-	// 		partService: new TestPartService(),
-	// 		modeService: createMockModeService(),
-	// 		modelService: createMockModelService(),
-	// 		telemetryService: telemetryService,
-	// 		lifecycleService: new TestLifecycleService(),
-	// 		configurationService: new TestConfigurationService()
-	// 	});
-
-	// 	let textFileServices = instantiationService.createInstance(<any>TextFileService);
-	// 	instantiationService.registerService('textFileService', textFileServices);
-
-	// 	let tracker = instantiationService.createInstance(FileTracker);
-
-	// 	let inputToResolve = instantiationService.createInstance(FileEditorInput, toResource('/fooss5/bar/file2.js'), 'text/javascript', void 0);
-	// 	let sameOtherInput = instantiationService.createInstance(FileEditorInput, toResource('/fooss5/bar/file2.js'), 'text/javascript', void 0);
-	// 	return editorService.resolveEditorModel(inputToResolve).then(function(resolved) {
-	// 		return editorService.resolveEditorModel(sameOtherInput).then(function(resolved) {
-	// 			(<any>tracker).dispose(toResource('/bar'), []);
-	// 			assert(!inputToResolve.isDisposed());
-	// 			assert(!sameOtherInput.isDisposed());
-
-	// 			(<any>tracker).dispose(toResource('/fooss5/bar/file2.js'), []);
-
-	// 			assert(inputToResolve.isDisposed());
-	// 			assert(sameOtherInput.isDisposed());
-
-	// 			done();
-	// 		});
-	// 	});
-	// });
-
-	// test('FileEditorInput - dispose() also works for folders', function(done) {
-	// 	let editorService = new TestEditorService(function() { });
-	// 	let telemetryService = new MainTelemetryService();
-	// 	let contextService = new TestContextService();
-
-	// 	let eventService = new TestEventService();
-
-	// 	let instantiationService = createInstantiationService({
-	// 		eventService: eventService,
-	// 		contextService: contextService,
-	// 		fileService: TestFileService,
-	// 		storageService: new TestStorageService(),
-	// 		editorService: editorService,
-	// 		partService: new TestPartService(),
-	// 		modeService: createMockModeService(),
-	// 		modelService: createMockModelService(),
-	// 		telemetryService: telemetryService,
-	// 		lifecycleService: new TestLifecycleService(),
-	// 		configurationService: new TestConfigurationService()
-	// 	});
-
-	// 	let textFileServices = instantiationService.createInstance(<any>TextFileService);
-	// 	instantiationService.registerService('textFileService', textFileServices);
-
-	// 	let tracker = instantiationService.createInstance(FileTracker);
-
-	// 	let inputToResolve = instantiationService.createInstance(FileEditorInput, toResource('/foo6/bar/file.js'), 'text/javascript', void 0);
-	// 	let sameOtherInput = instantiationService.createInstance(FileEditorInput, toResource('/foo6/bar/file.js'), 'text/javascript', void 0);
-	// 	return editorService.resolveEditorModel(inputToResolve, true).then(function(resolved) {
-	// 		return editorService.resolveEditorModel(sameOtherInput, true).then(function(resolved) {
-	// 			(<any>tracker).dispose(toResource('/bar'), []);
-	// 			assert(!inputToResolve.isDisposed());
-	// 			assert(!sameOtherInput.isDisposed());
-
-	// 			(<any>tracker).dispose(toResource('/foo6'), []);
-
-	// 			assert(inputToResolve.isDisposed());
-	// 			assert(sameOtherInput.isDisposed());
-
-	// 			done();
-	// 		});
-	// 	});
-	// });
+	test('Input.matches() - FileEditorInput', function() {
+		let fileEditorInput = new FileEditorInput(toResource('/foo/bar/updatefile.js'), 'text/javascript', void 0, void 0, void 0, void 0);
+		let contentEditorInput2 = new FileEditorInput(toResource('/foo/bar/updatefile.js'), 'text/javascript', void 0, void 0, void 0, void 0);
+
+		assert.strictEqual(fileEditorInput.matches(null), false);
+		assert.strictEqual(fileEditorInput.matches(fileEditorInput), true);
+		assert.strictEqual(fileEditorInput.matches(contentEditorInput2), true);
+	});
+
+	test('FileTracker - dispose()', function(done) {
+		let editorService = new TestEditorService(function() { });
+		let telemetryService = new MainTelemetryService();
+		let contextService = new TestContextService();
+
+		let eventService = new TestEventService();
+
+		let instantiationService = createInstantiationService({
+			eventService: eventService,
+			contextService: contextService,
+			fileService: TestFileService,
+			storageService: new TestStorageService(),
+			editorService: editorService,
+			partService: new TestPartService(),
+			modeService: createMockModeService(),
+			modelService: createMockModelService(),
+			telemetryService: telemetryService,
+			lifecycleService: new TestLifecycleService(),
+			configurationService: new TestConfigurationService()
+		});
+
+		let textFileServices = instantiationService.createInstance(<any>TextFileService);
+		instantiationService.registerService('textFileService', textFileServices);
+
+		let tracker = instantiationService.createInstance(FileTracker);
+
+		let inputToResolve = instantiationService.createInstance(FileEditorInput, toResource('/fooss5/bar/file2.js'), 'text/javascript', void 0);
+		let sameOtherInput = instantiationService.createInstance(FileEditorInput, toResource('/fooss5/bar/file2.js'), 'text/javascript', void 0);
+		return editorService.resolveEditorModel(inputToResolve).then(function(resolved) {
+			return editorService.resolveEditorModel(sameOtherInput).then(function(resolved) {
+				(<any>tracker).disposeAll(toResource('/bar'), []);
+				assert(!inputToResolve.isDisposed());
+				assert(!sameOtherInput.isDisposed());
+
+				(<any>tracker).disposeAll(toResource('/fooss5/bar/file2.js'), []);
+
+				assert(inputToResolve.isDisposed());
+				assert(sameOtherInput.isDisposed());
+
+				done();
+			});
+		});
+	});
+
+	test('FileEditorInput - dispose() also works for folders', function(done) {
+		let editorService = new TestEditorService(function() { });
+		let telemetryService = new MainTelemetryService();
+		let contextService = new TestContextService();
+
+		let eventService = new TestEventService();
+
+		let instantiationService = createInstantiationService({
+			eventService: eventService,
+			contextService: contextService,
+			fileService: TestFileService,
+			storageService: new TestStorageService(),
+			editorService: editorService,
+			partService: new TestPartService(),
+			modeService: createMockModeService(),
+			modelService: createMockModelService(),
+			telemetryService: telemetryService,
+			lifecycleService: new TestLifecycleService(),
+			configurationService: new TestConfigurationService()
+		});
+
+		let textFileServices = instantiationService.createInstance(<any>TextFileService);
+		instantiationService.registerService('textFileService', textFileServices);
+
+		let tracker = instantiationService.createInstance(FileTracker);
+
+		let inputToResolve = instantiationService.createInstance(FileEditorInput, toResource('/foo6/bar/file.js'), 'text/javascript', void 0);
+		let sameOtherInput = instantiationService.createInstance(FileEditorInput, toResource('/foo6/bar/file.js'), 'text/javascript', void 0);
+		return editorService.resolveEditorModel(inputToResolve, true).then(function(resolved) {
+			return editorService.resolveEditorModel(sameOtherInput, true).then(function(resolved) {
+				(<any>tracker).disposeAll(toResource('/bar'), []);
+				assert(!inputToResolve.isDisposed());
+				assert(!sameOtherInput.isDisposed());
+
+				(<any>tracker).disposeAll(toResource('/foo6'), []);
+
+				assert(inputToResolve.isDisposed());
+				assert(sameOtherInput.isDisposed());
+
+				done();
+			});
+		});
+	});
 });
\ No newline at end of file

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/parts/search/common/searchModel.ts
code:
@@ -11,7 +11,7 @@ import paths = require('vs/base/common/paths');
 import lifecycle = require('vs/base/common/lifecycle');
 import collections = require('vs/base/common/collections');
 import {EventEmitter} from 'vs/base/common/eventEmitter';
-import {IModel, ITextModel, IModelDeltaDecoration, EventType, OverviewRulerLane, TrackedRangeStickiness, IModelDecorationOptions, IRange} from 'vs/editor/common/editorCommon';
+import {IModel, ITextModel, IModelDeltaDecoration, EventType, OverviewRulerLane, TrackedRangeStickiness, IModelDecorationOptions, IEditorRange} from 'vs/editor/common/editorCommon';
 import {Range} from 'vs/editor/common/core/range';
 import {IModelService} from 'vs/editor/common/services/modelService';
 import * as Search from 'vs/platform/search/common/search';
@@ -21,7 +21,7 @@ export class Match {
 	private _parent: FileMatch;
 	private _lineText: string;
 	private _id: string;
-	private _range: IRange;
+	private _range: IEditorRange;
 
 	constructor(parent: FileMatch, text: string, lineNumber: number, offset: number, length: number) {
 		this._parent = parent;
@@ -42,7 +42,7 @@ export class Match {
 		return this._lineText;
 	}
 
-	public range(): IRange {
+	public range(): IEditorRange {
 		return this._range;
 	}
 

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/services/editor/browser/editorService.ts
code:
@@ -136,7 +136,7 @@ export class WorkbenchEditorService implements IWorkbenchEditorService {
 		if (resourceInput.resource instanceof URI) {
 			let schema = resourceInput.resource.scheme;
 			if (schema === network.Schemas.http || schema === network.Schemas.https) {
-				window.open(resourceInput.resource.toString());
+				window.open(resourceInput.resource.toString(false));
 				return TPromise.as<IEditor>(null);
 			}
 		}

author:be5invis
date:2016-03-31T18:10:06Z
title:Merge branch 'master' of git://github.com/Microsoft/vscode into be5invis-patch-kinsoku-shori
filename:src/vs/workbench/services/thread/electron-browser/threadService.ts
code:
@@ -83,6 +83,7 @@ export class MainThreadService extends CommonMainThreadService {
 class ExtensionHostProcessManager {
 	private initializeExtensionHostProcess: TPromise<ChildProcess>;
 	private extensionHostProcessHandle: ChildProcess;
+	private extensionHostProcessReady: boolean;
 	private initializeTimer: number;
 
 	private lastExtensionHostError: string;
@@ -105,7 +106,7 @@ class ExtensionHostProcessManager {
 		this.isExtensionDevelopmentTest = this.isExtensionDevelopmentHost && !!config.env.extensionTestsPath;
 
 		this.unsentMessages = [];
-
+		this.extensionHostProcessReady = false;
 		lifecycleService.addBeforeShutdownParticipant(this);
 	}
 
@@ -174,6 +175,7 @@ class ExtensionHostProcessManager {
 						this.unsentMessages.forEach(m => this.postMessage(m));
 						this.unsentMessages = [];
 
+						this.extensionHostProcessReady = true;
 						c(this.extensionHostProcessHandle);
 					}
 
@@ -300,7 +302,9 @@ class ExtensionHostProcessManager {
 	}
 
 	public postMessage(msg: any): void {
-		if (this.initializeExtensionHostProcess) {
+		if (this.extensionHostProcessReady) {
+			this.extensionHostProcessHandle.send(msg);
+		} else if (this.initializeExtensionHostProcess) {
 			this.initializeExtensionHostProcess.done(p => p.send(msg));
 		} else {
 			this.unsentMessages.push(msg);

author:joaomoreno
date:2016-04-05T10:41:38Z
title:git commands: undo last commit
filename:src/vs/workbench/parts/git/browser/gitActions.contribution.ts
code:
@@ -28,7 +28,7 @@ import {IFileService} from 'vs/platform/files/common/files';
 import {IInstantiationService} from 'vs/platform/instantiation/common/instantiation';
 import wbar = require('vs/workbench/common/actionRegistry');
 import { SyncActionDescriptor } from 'vs/platform/actions/common/actions';
-import { OpenChangeAction, OpenFileAction, SyncAction, PullAction, PushAction, PublishAction, StartGitBranchAction, StartGitCheckoutAction, InputCommitAction } from './gitActions';
+import { OpenChangeAction, OpenFileAction, SyncAction, PullAction, PushAction, PublishAction, StartGitBranchAction, StartGitCheckoutAction, InputCommitAction, UndoLastCommitAction } from './gitActions';
 import paths = require('vs/base/common/paths');
 import URI from 'vs/base/common/uri';
 
@@ -479,3 +479,4 @@ workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(Publish
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(StartGitBranchAction, StartGitBranchAction.ID, StartGitBranchAction.LABEL), category);
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(StartGitCheckoutAction, StartGitCheckoutAction.ID, StartGitCheckoutAction.LABEL), category);
 workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(InputCommitAction, InputCommitAction.ID, InputCommitAction.LABEL), category);
+workbenchActionRegistry.registerWorkbenchAction(new SyncActionDescriptor(UndoLastCommitAction, UndoLastCommitAction.ID, UndoLastCommitAction.LABEL), category);

author:joaomoreno
date:2016-04-05T10:41:38Z
title:git commands: undo last commit
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -1162,9 +1162,14 @@ export class LiveSyncAction extends BaseSyncAction {
 export class UndoLastCommitAction extends GitAction {
 
 	static ID = 'workbench.action.git.undoLastCommit';
+	static LABEL = nls.localize('undoLastCommit', "Undo Last Commit");
 
-	constructor(@IGitService gitService: IGitService) {
-		super(UndoLastCommitAction.ID, nls.localize('undoLastCommit', "Undo Last Commit"), 'git-action undo-last-commit', gitService);
+	constructor(
+		id = UndoLastCommitAction.ID,
+		label = UndoLastCommitAction.LABEL,
+		@IGitService gitService: IGitService
+	) {
+		super(UndoLastCommitAction.ID, UndoLastCommitAction.LABEL, 'git-action undo-last-commit', gitService);
 	}
 
 	public run():Promise {

author:joaomoreno
date:2016-04-05T10:41:38Z
title:git commands: undo last commit
filename:src/vs/workbench/parts/git/browser/views/changes/changesView.ts
code:
@@ -259,7 +259,7 @@ export class ChangesView extends EventEmitter.EventEmitter implements GitView.IV
 				new ActionBar.Separator(),
 				this.instantiationService.createInstance(GitActions.CommitAction, this),
 				this.instantiationService.createInstance(GitActions.StageAndCommitAction, this),
-				this.instantiationService.createInstance(GitActions.UndoLastCommitAction),
+				this.instantiationService.createInstance(GitActions.UndoLastCommitAction, GitActions.UndoLastCommitAction.ID, GitActions.UndoLastCommitAction.LABEL),
 				new ActionBar.Separator(),
 				this.instantiationService.createInstance(GitActions.GlobalUnstageAction),
 				this.instantiationService.createInstance(GitActions.GlobalUndoAction),

author:joaomoreno
date:2016-04-11T09:08:54Z
title:Merge branch 'master' of https://github.com/eklavyamirani/vscode into eklavyamirani-master
filename:src/vs/workbench/parts/feedback/browser/feedback.ts
code:
@@ -21,6 +21,7 @@ export interface IFeedback {
 
 export interface IFeedbackService {
 	submitFeedback(feedback: IFeedback): void;
+	getCharacterLimit(sentiment: number): number;
 }
 
 export interface IFeedbackDropdownOptions {
@@ -35,7 +36,7 @@ enum FormEvent {
 }
 
 export class FeedbackDropdown extends Dropdown {
-	protected static MAX_FEEDBACK_CHARS: number = 140;
+	protected maxFeedbackCharacters: number;
 
 	protected feedback: string;
 	protected sentiment: number;
@@ -50,6 +51,7 @@ export class FeedbackDropdown extends Dropdown {
 	protected smileyInput: Builder;
 	protected frownyInput: Builder;
 	protected sendButton: Builder;
+	protected remainingCharacterCount: Builder;
 
 	protected requestFeatureLink: string;
 	protected reportIssueLink: string;
@@ -75,6 +77,7 @@ export class FeedbackDropdown extends Dropdown {
 
 		this.feedback = '';
 		this.sentiment = 1;
+		this.maxFeedbackCharacters = this.feedbackService.getCharacterLimit(this.sentiment);
 
 		this.feedbackForm = null;
 		this.feedbackDescriptionInput = null;
@@ -147,21 +150,20 @@ export class FeedbackDropdown extends Dropdown {
 		$('div').append($('a').attr('target', '_blank').attr('href', this.requestFeatureLink).text(nls.localize("request a missing feature", "Request a missing feature")).attr('tabindex', '0'))
 			.appendTo($contactUsContainer);
 
-		let $charCounter = $('span.char-counter').text(this.getCharCountText(0));
+		this.remainingCharacterCount = $('span.char-counter').text(this.getCharCountText(0));
 
 		$('h3').text(nls.localize("tell us why?", "Tell us why?"))
-			.append($charCounter)
+			.append(this.remainingCharacterCount)
 			.appendTo($form);
 
 		this.feedbackDescriptionInput = <HTMLTextAreaElement>$('textarea.feedback-description').attr({
 			rows: 3,
-			maxlength: FeedbackDropdown.MAX_FEEDBACK_CHARS,
+			maxlength: this.maxFeedbackCharacters,
 			'aria-label': nls.localize("commentsHeader", "Comments")
 		})
 			.text(this.feedback).attr('required', 'required')
 			.on('keyup', () => {
-				$charCounter.text(this.getCharCountText(this.feedbackDescriptionInput.value.length));
-				this.feedbackDescriptionInput.value ? this.sendButton.removeAttribute('disabled') : this.sendButton.attr('disabled', '');
+				this.updateCharCountText();
 			})
 			.appendTo($form).domFocus().getHTMLElement();
 
@@ -185,14 +187,19 @@ export class FeedbackDropdown extends Dropdown {
 	}
 
 	private getCharCountText(charCount: number): string {
-		let remaining = FeedbackDropdown.MAX_FEEDBACK_CHARS - charCount;
+		let remaining = this.maxFeedbackCharacters - charCount;
 		let text = (remaining === 1)
 			? nls.localize("character left", "character left")
 			: nls.localize("characters left", "characters left");
 
 		return '(' + remaining + ' ' + text + ')';
 	}
 
+	private updateCharCountText(): void {
+		this.remainingCharacterCount.text(this.getCharCountText(this.feedbackDescriptionInput.value.length));
+		this.feedbackDescriptionInput.value ? this.sendButton.removeAttribute('disabled') : this.sendButton.attr('disabled', '');
+	}
+
 	protected setSentiment(smile: boolean): void {
 		if (smile) {
 			this.smileyInput.addClass('checked');
@@ -206,6 +213,8 @@ export class FeedbackDropdown extends Dropdown {
 			this.smileyInput.attr('aria-checked', 'false');
 		}
 		this.sentiment = smile ? 1 : 0;
+		this.maxFeedbackCharacters = this.feedbackService.getCharacterLimit(this.sentiment);
+		this.updateCharCountText();
 	}
 
 	protected invoke(element: Builder, callback: () => void): Builder {
@@ -291,6 +300,7 @@ export class FeedbackDropdown extends Dropdown {
 			this.feedbackDescriptionInput.value = '';
 		}
 		this.sentiment = 1;
+		this.maxFeedbackCharacters = this.feedbackService.getCharacterLimit(this.sentiment);
 		this.aliasEnabled = false;
 	}
 }

author:joaomoreno
date:2016-04-11T09:08:54Z
title:Merge branch 'master' of https://github.com/eklavyamirani/vscode into eklavyamirani-master
filename:src/vs/workbench/parts/feedback/electron-browser/feedbackStatusbarItem.ts
code:
@@ -15,12 +15,33 @@ import {shell} from 'electron';
 class TwitterFeedbackService implements IFeedbackService {
 
 	private static TWITTER_URL: string = 'https://twitter.com/intent/tweet';
+	private static VIA_NAME: string = 'code';
+	private static HASHTAGS: string[]  = ['HappyCoding'];
+
+	private combineHashTagsAsString() : string {
+		return TwitterFeedbackService.HASHTAGS.join(',');
+	}
 
 	public submitFeedback(feedback: IFeedback): void {
-		var queryString = `?${feedback.sentiment === 1 ? 'hashtags=HappyCoding&' : null}ref_src=twsrc%5Etfw&related=twitterapi%2Ctwitter&text=${feedback.feedback}&tw_p=tweetbutton&via=code`;
+		var queryString = `?${feedback.sentiment === 1 ? `hashtags=${this.combineHashTagsAsString()}&` : null}ref_src=twsrc%5Etfw&related=twitterapi%2Ctwitter&text=${feedback.feedback}&tw_p=tweetbutton&via=${TwitterFeedbackService.VIA_NAME}`;
 		var url = TwitterFeedbackService.TWITTER_URL + queryString;
 		shell.openExternal(url);
 	}
+
+	public getCharacterLimit(sentiment: number): number {
+		let length : number = 0;
+		if (sentiment === 1)
+		{
+			TwitterFeedbackService.HASHTAGS.forEach(element => {
+				length += element.length + 2;
+			});
+		}
+
+		if (TwitterFeedbackService.VIA_NAME) {
+			length += ` via @${TwitterFeedbackService.VIA_NAME}`.length;
+		}
+		return 140 - length;
+	}
 }
 
 export class FeedbackStatusbarItem implements IStatusbarItem {

author:aeschli
date:2016-04-11T14:03:36Z
title:[git] colorizer tests
filename:extensions/git/test/colorize-fixtures/COMMIT_EDITMSG
code:
@@ -0,0 +1,13 @@
+This is the summary line. It can't be too long.
+After I can write a much more detailed description without quite the same restrictions on length.
+
+# Please enter the commit message for your changes. Lines starting
+# with '#' will be ignored, and an empty message aborts the commit.
+# On branch master
+# Your branch is up-to-date with 'origin/master'.
+#
+# Changes to be committed:
+#	deleted:    README.md
+#	modified:   index.less
+#	new file:   spec/COMMIT_EDITMSG
+#
\ No newline at end of file

author:aeschli
date:2016-04-11T14:03:36Z
title:[git] colorizer tests
filename:extensions/git/test/colorize-fixtures/git-rebase-todo
code:
@@ -0,0 +1,15 @@
+pick    1fc6c95  Patch A
+squash  fa39187  Something to add to patch A
+pick    7b36971  Something to move before patch B
+pick    6b2481b  Patch B
+fixup   c619268  A fix for Patch B
+edit    dd1475d  Something I want to split
+reword  4ca2acc  i cant' typ goods
+
+# Commands:
+#  p, pick = use commit
+#  r, reword = use commit, but edit the commit message
+#  e, edit = use commit, but stop for amending
+#  s, squash = use commit, but meld into previous commit
+#  f, fixup = like "squash", but discard this commit's log message
+#  x, exec = run command (the rest of the line) using shell
\ No newline at end of file

author:aeschli
date:2016-04-11T14:03:36Z
title:[git] colorizer tests
filename:extensions/git/test/colorize-results/COMMIT_EDITMSG.json
code:
@@ -0,0 +1,255 @@
+[
+	{
+		"c": "This is the summary line. It can't be too long.",
+		"t": "meta.scope.message.git-commit.subject",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "After I can write a much more detailed description without quite the same restrictions on length.",
+		"t": "meta.scope.message.git-commit",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " Please enter the commit message for your changes. Lines starting",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " with '#' will be ignored, and an empty message aborts the commit.",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " On branch master",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " Your branch is up-to-date with 'origin/master'.",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " Changes to be committed:",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "\t",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "deleted:    README.md",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.markup.deleted",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.markup.deleted",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.markup.deleted",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.markup.deleted",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.markup.deleted",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.markup.deleted"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "\t",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "modified:   index.less",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.markup.changed",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.markup.changed",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.markup.changed",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.markup.changed",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.markup.changed",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.markup.changed"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "\t",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "new file:   spec/COMMIT_EDITMSG",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.markup.inserted",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.markup.inserted",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.markup.inserted",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.markup.inserted",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.markup.inserted",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.markup.inserted"
+		}
+	},
+	{
+		"c": "#",
+		"t": "meta.scope.git-commit.metadata.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	}
+]
\ No newline at end of file

author:aeschli
date:2016-04-11T14:03:36Z
title:[git] colorizer tests
filename:extensions/git/test/colorize-results/git-rebase-todo.json
code:
@@ -0,0 +1,541 @@
+[
+	{
+		"c": "pick",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "    ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "1fc6c95",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "Patch A",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "squash",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "fa39187",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "Something to add to patch A",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "pick",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "    ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "7b36971",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "Something to move before patch B",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "pick",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "    ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "6b2481b",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "Patch B",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "fixup",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "   ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "c619268",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "A fix for Patch B",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "edit",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "    ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "dd1475d",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "Something I want to split",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "reword",
+		"t": "meta.commit-command.git-rebase.support.function",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.support.function.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.support.function.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.support.function.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.support.function.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.support.function.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "4ca2acc",
+		"t": "meta.commit-command.git-rebase.constant.sha",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.constant.sha.git-rebase",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.constant.sha.git-rebase",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.constant.sha.git-rebase",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.constant.sha.git-rebase",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.constant.sha.git-rebase"
+		}
+	},
+	{
+		"c": "  ",
+		"t": "meta.commit-command.git-rebase",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "i cant' typ goods",
+		"t": "meta.commit-command.git-rebase.commit-message",
+		"r": {
+			"dark_plus": ".vs-dark .token",
+			"light_plus": ".vs .token",
+			"dark_vs": ".vs-dark .token",
+			"light_vs": ".vs .token",
+			"hc_black": ".hc-black .token"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": " Commands:",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  p, pick = use commit",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  r, reword = use commit, but edit the commit message",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  e, edit = use commit, but stop for amending",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  s, squash = use commit, but meld into previous commit",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  f, fixup = like \"squash\", but discard this commit's log message",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "#",
+		"t": "git-rebase.comment.line.number-sign.punctuation.definition",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	},
+	{
+		"c": "  x, exec = run command (the rest of the line) using shell",
+		"t": "git-rebase.comment.line.number-sign",
+		"r": {
+			"dark_plus": ".vs-dark.vscode-theme-defaults-themes-dark_plus-json .token.comment",
+			"light_plus": ".vs.vscode-theme-defaults-themes-light_plus-json .token.comment",
+			"dark_vs": ".vs-dark.vscode-theme-defaults-themes-dark_vs-json .token.comment",
+			"light_vs": ".vs.vscode-theme-defaults-themes-light_vs-json .token.comment",
+			"hc_black": ".hc-black.vscode-theme-defaults-themes-hc_black-json .token.comment"
+		}
+	}
+]
\ No newline at end of file

author:bpasero
date:2016-04-11T13:48:13Z
title:[loc][Query][VSCode] Please clarify whether this should be locked "{0}, git branch" (fixes #5159)
filename:src/vs/workbench/parts/git/browser/gitQuickOpen.ts
code:
@@ -95,7 +95,7 @@ class BranchEntry extends model.QuickOpenEntry {
 
 	public getIcon(): string { return 'git'; }
 	public getLabel(): string { return this.name; }
-	public getAriaLabel(): string { return nls.localize('branchAriaLabel', "{0}, git branch", this.getLabel()); }
+	public getAriaLabel(): string { return nls.localize({ key: 'branchAriaLabel', comment: ['the branch name'] }, "{0}, git branch", this.getLabel()); }
 	public getDescription(): string { return nls.localize('createBranch', "Create branch {0}", this.name); }
 
 	public run(mode: quickopen.Mode, context: model.IContext):boolean {

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/base/browser/dom.ts
code:
@@ -637,46 +637,34 @@ export function getTotalHeight(element: HTMLElement): number {
 	return element.offsetHeight + margin;
 }
 
-// Adapted from WinJS
 // Gets the left coordinate of the specified element relative to the specified parent.
 export function getRelativeLeft(element: HTMLElement, parent: HTMLElement): number {
 	if (element === null) {
 		return 0;
 	}
 
-	let left = element.offsetLeft;
-	let e = <HTMLElement>element.parentNode;
-	while (e !== null) {
-		left -= e.offsetLeft;
-
-		if (e === parent) {
-			break;
-		}
-		e = <HTMLElement>e.parentNode;
-	}
-
-	return left;
+	let elementPosition = getTopLeftOffset(element);
+	let parentPosition = getTopLeftOffset(parent);
+	return elementPosition.left - parentPosition.left;
 }
 
-// Adapted from WinJS
 // Gets the top coordinate of the element relative to the specified parent.
 export function getRelativeTop(element: HTMLElement, parent: HTMLElement): number {
 	if (element === null) {
 		return 0;
 	}
 
-	let top = element.offsetTop;
-	let e = <HTMLElement>element.parentNode;
-	while (e !== null) {
-		top -= e.offsetTop;
-
-		if (e === parent) {
-			break;
-		}
-		e = <HTMLElement>e.parentNode;
-	}
+	let elementPosition = getTopLeftOffset(element);
+	let parentPosition = getTopLeftOffset(parent);
+	return parentPosition.top - elementPosition.top;
+}
 
-	return top;
+export function getLargestChildWidth(parent: HTMLElement, children: HTMLElement[]): number {
+	let childWidths = children.map((child) => {
+		return getTotalWidth(child) + getRelativeLeft(child, parent) || 0;
+	});
+	let maxWidth = Math.max(...childWidths);
+	return maxWidth;
 }
 
 // ----------------------------------------------------------------------------------------

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/base/browser/ui/sash/sash.css
code:
@@ -23,4 +23,12 @@
 
 .monaco-sash.disabled {
 	cursor: default;
+}
+
+.vertical-cursor-container * {
+	cursor: ew-resize !important;
+}
+
+.horizontal-cursor-container * {
+	cursor: ns-resize !important;
 }
\ No newline at end of file

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/base/browser/ui/sash/sash.ts
code:
@@ -63,11 +63,12 @@ export class Sash extends EventEmitter {
 
 		this.gesture = new Gesture(this.$e.getHTMLElement());
 
-		this.$e.on('mousedown', (e: MouseEvent) => { this.onMouseDown(e); });
+		this.$e.on(DOM.EventType.MOUSE_DOWN, (e: MouseEvent) => { this.onMouseDown(e); });
+		this.$e.on(DOM.EventType.DBLCLICK, (e: MouseEvent) => { this.emit('reset', e); });
 		this.$e.on(EventType.Start, (e: GestureEvent) => { this.onTouchStart(e); });
 
 		this.orientation = options.orientation || Orientation.VERTICAL;
-		this.$e.addClass(this.orientation === Orientation.HORIZONTAL ? 'horizontal' : 'vertical');
+		this.$e.addClass(this.getOrientation());
 
 		this.size = options.baseSize || 5;
 
@@ -91,6 +92,10 @@ export class Sash extends EventEmitter {
 		return this.$e.getHTMLElement();
 	}
 
+	private getOrientation(): 'horizontal' | 'vertical' {
+		return this.orientation === Orientation.HORIZONTAL ? 'horizontal' : 'vertical';
+	}
+
 	private onMouseDown(e: MouseEvent): void {
 		DOM.EventHelper.stop(e, false);
 
@@ -112,17 +117,8 @@ export class Sash extends EventEmitter {
 		this.$e.addClass('active');
 		this.emit('start', startEvent);
 
-		let overlayDiv = $('div').style({
-			position: 'absolute',
-			top: 0,
-			left: 0,
-			width: '100%',
-			height: '100%',
-			zIndex: 1000000,
-			cursor: this.orientation === Orientation.VERTICAL ? 'ew-resize' : 'ns-resize'
-		});
-
 		let $window = $(window);
+		let containerCssClass = `${this.getOrientation()}-cursor-container`;
 
 		let lastCurrentX = startX;
 		let lastCurrentY = startY;
@@ -148,10 +144,10 @@ export class Sash extends EventEmitter {
 			this.emit('end');
 
 			$window.off('mousemove');
-			overlayDiv.destroy();
+			document.body.classList.remove(containerCssClass);
 		});
 
-		overlayDiv.appendTo(document.body);
+		document.body.classList.add(containerCssClass);
 	}
 
 	private onTouchStart(event: GestureEvent): void {

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/editor/browser/widget/diffEditorWidget.ts
code:
@@ -1327,9 +1327,10 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 			this._sash.disable();
 		}
 
-		this._sash.on('start', () => this._onSashDragStart());
-		this._sash.on('change', (e: ISashEvent) => this._onSashDrag(e));
-		this._sash.on('end', () => this._onSashDragEnd());
+		this._sash.on('start', () => this.onSashDragStart());
+		this._sash.on('change', (e: ISashEvent) => this.onSashDrag(e));
+		this._sash.on('end', () => this.onSashDragEnd());
+		this._sash.on('reset', () => this.onSashReset());
 	}
 
 	public dispose(): void {
@@ -1378,11 +1379,11 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		return this._sashPosition;
 	}
 
-	private _onSashDragStart(): void {
+	private onSashDragStart(): void {
 		this._startSashPosition = this._sashPosition;
 	}
 
-	private _onSashDrag(e:ISashEvent): void {
+	private onSashDrag(e:ISashEvent): void {
 		var w = this._dataSource.getWidth();
 		var contentWidth = w - DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH;
 		var sashPosition = this.layout((this._startSashPosition + (e.currentX - e.startX)) / contentWidth);
@@ -1392,7 +1393,13 @@ class DiffEdtorWidgetSideBySide extends DiffEditorWidgetStyle implements IDiffEd
 		this._dataSource.relayoutEditors();
 	}
 
-	private _onSashDragEnd(): void {
+	private onSashDragEnd(): void {
+		this._sash.layout();
+	}
+
+	private onSashReset(): void {
+		this._sashRatio = 0.5;
+		this._dataSource.relayoutEditors();
 		this._sash.layout();
 	}
 

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/browser/layout.ts
code:
@@ -12,6 +12,7 @@ import {Sash, ISashEvent, IVerticalSashLayoutProvider, IHorizontalSashLayoutProv
 import {IWorkbenchEditorService} from 'vs/workbench/services/editor/common/editorService';
 import {IPartService, Position} from 'vs/workbench/services/part/common/partService';
 import {IWorkspaceContextService} from 'vs/workbench/services/workspace/common/contextService';
+import {IViewletService} from 'vs/workbench/services/viewlet/common/viewletService';
 import {IStorageService, StorageScope} from 'vs/platform/storage/common/storage';
 import {IContextViewService} from 'vs/platform/contextview/browser/contextView';
 import {IEventService} from 'vs/platform/event/common/event';
@@ -94,6 +95,7 @@ export class WorkbenchLayout implements IVerticalSashLayoutProvider, IHorizontal
 		@IWorkbenchEditorService private editorService: IWorkbenchEditorService,
 		@IWorkspaceContextService private contextService: IWorkspaceContextService,
 		@IPartService private partService: IPartService,
+		@IViewletService private viewletService: IViewletService,
 		@IThemeService themeService: IThemeService
 	) {
 		this.parent = parent;
@@ -190,7 +192,7 @@ export class WorkbenchLayout implements IVerticalSashLayoutProvider, IHorizontal
 					let dragCompensation = DEFAULT_MIN_PANEL_PART_HEIGHT - HIDE_PANEL_HEIGHT_THRESHOLD;
 					this.partService.setPanelHidden(true);
 					startY = Math.min(this.sidebarHeight - this.computedStyles.statusbar.height, e.currentY + dragCompensation);
-					this.panelHeight = this.startPanelHeight; // when restoring panel, restore to the panel width we started from
+					this.panelHeight = this.startPanelHeight; // when restoring panel, restore to the panel height we started from
 				}
 
 				// Otherwise size the panel accordingly
@@ -217,9 +219,26 @@ export class WorkbenchLayout implements IVerticalSashLayoutProvider, IHorizontal
 		this.sashX.addListener('end', () => {
 			this.storageService.store(WorkbenchLayout.sashXWidthSettingsKey, this.sidebarWidth, StorageScope.GLOBAL);
 		});
+
 		this.sashY.addListener('end', () => {
 			this.storageService.store(WorkbenchLayout.sashYHeightSettingsKey, this.panelHeight, StorageScope.GLOBAL);
 		});
+
+		this.sashY.addListener('reset', () => {
+			this.panelHeight = DEFAULT_MIN_PANEL_PART_HEIGHT;
+			this.storageService.store(WorkbenchLayout.sashYHeightSettingsKey, this.panelHeight, StorageScope.GLOBAL);
+			this.partService.setPanelHidden(false);
+			this.layout();
+		});
+
+		this.sashX.addListener('reset', () => {
+			let activeViewlet = this.viewletService.getActiveViewlet();
+			let optimalWidth = activeViewlet && activeViewlet.getOptimalWidth();
+			this.sidebarWidth = Math.max(DEFAULT_MIN_PART_WIDTH, optimalWidth || 0);
+			this.storageService.store(WorkbenchLayout.sashXWidthSettingsKey, this.sidebarWidth, StorageScope.GLOBAL);
+			this.partService.setSideBarHidden(false);
+			this.layout();
+		});
 	}
 
 	private onEditorInputChanging(e: EditorEvent): void {

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/browser/parts/editor/binaryDiffEditor.ts
code:
@@ -72,6 +72,7 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 		this.sash.addListener('start', () => this.onSashDragStart());
 		this.sash.addListener('change', (e: ISashEvent) => this.onSashDrag(e));
 		this.sash.addListener('end', () => this.onSashDragEnd());
+		this.sash.addListener('reset', () => this.onSashReset());
 
 		// Right Container for Binary
 		let rightBinaryContainerElement = document.createElement('div');
@@ -199,6 +200,12 @@ export class BinaryResourceDiffEditor extends BaseEditor implements IVerticalSas
 		this.sash.layout();
 	}
 
+	private onSashReset(): void {
+		this.leftContainerWidth = this.dimension.width / 2;
+		this.layoutContainers();
+		this.sash.layout();
+	}
+
 	public getVerticalSashTop(sash: Sash): number {
 		return 0;
 	}

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/browser/parts/editor/sideBySideEditorControl.ts
code:
@@ -728,6 +728,7 @@ export class SideBySideEditorControl extends EventEmitter implements IVerticalSa
 		this.leftSash.addListener('start', () => this.onLeftSashDragStart());
 		this.leftSash.addListener('change', (e: ISashEvent) => this.onLeftSashDrag(e));
 		this.leftSash.addListener('end', () => this.onLeftSashDragEnd());
+		this.leftSash.addListener('reset', () => this.onLeftSashReset());
 		this.leftSash.hide();
 
 		// Center Container
@@ -738,6 +739,7 @@ export class SideBySideEditorControl extends EventEmitter implements IVerticalSa
 		this.rightSash.addListener('start', () => this.onRightSashDragStart());
 		this.rightSash.addListener('change', (e: ISashEvent) => this.onRightSashDrag(e));
 		this.rightSash.addListener('end', () => this.onRightSashDragEnd());
+		this.rightSash.addListener('reset', () => this.onRightSashReset());
 		this.rightSash.hide();
 
 		// Right Container
@@ -1212,6 +1214,14 @@ export class SideBySideEditorControl extends EventEmitter implements IVerticalSa
 		this.editorActionsToolbar[position].setActions([], [])();
 	}
 
+	private centerSash(a: Position, b: Position): void {
+		let sumWidth = this.containerWidth[a] + this.containerWidth[b];
+		let meanWidth = sumWidth / 2;
+		this.containerWidth[a] = meanWidth;
+		this.containerWidth[b] = sumWidth - meanWidth;
+		this.layoutContainers();
+	}
+
 	private onLeftSashDragStart(): void {
 		this.startLeftContainerWidth = this.containerWidth[Position.LEFT];
 	}
@@ -1301,6 +1311,11 @@ export class SideBySideEditorControl extends EventEmitter implements IVerticalSa
 		this.focusNextNonMinimized();
 	}
 
+	private onLeftSashReset(): void {
+		this.centerSash(Position.LEFT, Position.CENTER);
+		this.leftSash.layout();
+	}
+
 	private onRightSashDragStart(): void {
 		this.startRightContainerWidth = this.containerWidth[Position.RIGHT];
 	}
@@ -1358,6 +1373,11 @@ export class SideBySideEditorControl extends EventEmitter implements IVerticalSa
 		this.focusNextNonMinimized();
 	}
 
+	private onRightSashReset(): void {
+		this.centerSash(Position.CENTER, Position.RIGHT);
+		this.rightSash.layout();
+	}
+
 	public getVerticalSashTop(sash: Sash): number {
 		return 0;
 	}

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/browser/parts/sidebar/sidebarPart.ts
code:
@@ -78,7 +78,7 @@ export class SidebarPart extends CompositePart<Viewlet> implements IViewletServi
 	}
 
 	public getActiveViewlet(): IViewlet {
-		return this.getActiveComposite();
+		return <IViewlet>this.getActiveComposite();
 	}
 
 	public getLastActiveViewletId(): string {

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/browser/viewlet.ts
code:
@@ -25,7 +25,11 @@ import {IContextMenuService} from 'vs/platform/contextview/browser/contextView';
 import {IMessageService} from 'vs/platform/message/common/message';
 import {StructuredSelection} from 'vs/platform/selection/common/selection';
 
-export abstract class Viewlet extends Composite implements IViewlet { }
+export abstract class Viewlet extends Composite implements IViewlet {
+	public getOptimalWidth(): number {
+		return null;
+	}
+}
 
 /**
  * Helper subtype of viewlet for those that use a tree inside.

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/common/viewlet.ts
code:
@@ -5,4 +5,9 @@
 
 import {IComposite} from 'vs/workbench/common/composite';
 
-export interface IViewlet extends IComposite { }
+export interface IViewlet extends IComposite {
+	/**
+	 * Returns the minimal width needed to avoid any content horizontal truncation
+	 */
+	getOptimalWidth(): number;
+}

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/parts/files/browser/explorerViewlet.ts
code:
@@ -175,6 +175,15 @@ export class ExplorerViewlet extends Viewlet {
 		return this.actionRunner;
 	}
 
+	public getOptimalWidth(): number {
+		let additionalMargin = 16;
+		let workingFilesViewWidth = this.getWorkingFilesView().getOptimalWidth();
+		let explorerView = this.getExplorerView();
+		let explorerViewWidth = explorerView ? explorerView.getOptimalWidth() : 0;
+		let optimalWidth = Math.max(workingFilesViewWidth, explorerViewWidth);
+		return optimalWidth + additionalMargin;
+	}
+
 	public shutdown(): void {
 		this.views.forEach((view) => view.shutdown());
 

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/parts/files/browser/views/explorerView.ts
code:
@@ -24,7 +24,7 @@ import {FileEditorInput} from 'vs/workbench/parts/files/browser/editors/fileEdit
 import {FileDragAndDrop, FileFilter, FileSorter, FileController, FileRenderer, FileDataSource, FileViewletState, FileAccessibilityProvider} from 'vs/workbench/parts/files/browser/views/explorerViewer';
 import lifecycle = require('vs/base/common/lifecycle');
 import {IEditor} from 'vs/platform/editor/common/editor';
-import DOM = require('vs/base/browser/dom');
+import * as DOM from 'vs/base/browser/dom';
 import {CollapseAction, CollapsibleViewletView} from 'vs/workbench/browser/viewlet';
 import {FileStat} from 'vs/workbench/parts/files/common/explorerViewModel';
 import {IWorkbenchEditorService} from 'vs/workbench/services/editor/common/editorService';
@@ -348,6 +348,12 @@ export class ExplorerView extends CollapsibleViewletView {
 		return this.explorerViewer;
 	}
 
+	public getOptimalWidth(): number {
+		let parentNode = this.explorerViewer.getHTMLElement();
+		let childNodes = [].slice.call(parentNode.querySelectorAll('.explorer-item-label > a'));
+		return DOM.getLargestChildWidth(parentNode, childNodes);
+	}
+
 	private onLocalFileChange(e: LocalFileChangeEvent): void {
 		let modelElement: FileStat;
 		let parent: FileStat;

author:mquandalle
date:2016-04-15T09:30:52Z
title:Sash double clicks (#4702)

* Support double click on sashes

We had to implement a slight change in the sash drag "hack", by removing the
full cover transparent overlay (that was preventing clicks events from being
fired) and replacing it by a CSS `cursor` rule on the document.body.

The ideal solution for a clean dragging events implementation would be to use
the `Element.setCapture` API that is unfortunately not available in Chrome.

* Center the split editor frontier by double-clicking on it

* Reset the bottom panel size by double-clicking on it

* Implement sash reset on diff editors

* Fix a bug with DOM measurement

The calculus was plain wrong as showed in https://github.com/winjs/winjs/issues/1621
This was probably unotified since this utility function wasn't used in the code base.

* Implement sidebar sash optimal resizing

Fixes #4660

* Abstract `getLargestChildWidth` into a DOM method

This commit also moves the `getOptimalWidth` method from the `Composite` to the
`Viewlet` component. This partially addresses
https://github.com/Microsoft/vscode/pull/4702#issuecomment-207813241

* Calculate the sidebar optimal width correctly in case no folder is open
filename:src/vs/workbench/parts/files/browser/views/workingFilesView.ts
code:
@@ -13,7 +13,7 @@ import {IAction, IActionRunner} from 'vs/base/common/actions';
 import workbenchEditorCommon = require('vs/workbench/common/editor');
 import {CollapsibleState} from 'vs/base/browser/ui/splitview/splitview';
 import {IWorkingFileEntry, IWorkingFilesModel, IWorkingFileModelChangeEvent, LocalFileChangeEvent, EventType as FileEventType, IFilesConfiguration, ITextFileService, AutoSaveMode} from 'vs/workbench/parts/files/common/files';
-import dom = require('vs/base/browser/dom');
+import * as DOM from 'vs/base/browser/dom';
 import {IDisposable} from 'vs/base/common/lifecycle';
 import errors = require('vs/base/common/errors');
 import {EventType as WorkbenchEventType, UntitledEditorEvent, EditorEvent} from 'vs/workbench/common/events';
@@ -82,7 +82,7 @@ export class WorkingFilesView extends AdaptiveCollapsibleViewletView {
 
 	public renderBody(container: HTMLElement): void {
 		this.treeContainer = super.renderViewTree(container);
-		dom.addClass(this.treeContainer, 'explorer-working-files');
+		DOM.addClass(this.treeContainer, 'explorer-working-files');
 
 		this.createViewer($(this.treeContainer));
 	}
@@ -303,6 +303,12 @@ export class WorkingFilesView extends AdaptiveCollapsibleViewletView {
 		return this.tree;
 	}
 
+	public getOptimalWidth():number {
+		let parentNode = this.tree.getHTMLElement();
+		let childNodes = [].slice.call(parentNode.querySelectorAll('.monaco-file-label > .file-name'));
+		return DOM.getLargestChildWidth(parentNode, childNodes);
+	}
+
 	public shutdown(): void {
 		this.settings[WorkingFilesView.MEMENTO_COLLAPSED] = (this.state === CollapsibleState.COLLAPSED);
 

author:joaomoreno
date:2016-04-19T15:33:48Z
title:Merge branch 'DeleteOutdatedExtension' of https://github.com/rebornix/vscode into rebornix-DeleteOutdatedExtension
filename:src/vs/workbench/parts/extensions/electron-browser/extensionsActions.ts
code:
@@ -180,10 +180,14 @@ export class UninstallAction extends Action {
 
 		this.enabled = false;
 
-		return this.extensionsService.uninstall(extension)
-			.then(() => this.onSuccess(extension), err => this.onError(err, extension))
-			.then(() => this.enabled = true)
-			.then(() => null);
+		return this.extensionsService.getInstalled().then(localExtensions => {
+			const [local] = localExtensions.filter(local => extensionEquals(local, extension));
+
+			return this.extensionsService.uninstall(local)
+				.then(() => this.onSuccess(local), err => this.onError(err, local))
+				.then(() => this.enabled = true)
+				.then(() => null);
+		});
 	}
 
 	private onSuccess(extension: IExtension) {
@@ -204,7 +208,7 @@ export class UninstallAction extends Action {
 
 	private reportTelemetry(extension: IExtension, success: boolean) {
 		const data = assign(getTelemetryData(extension), { success });
-		
+
 		this.telemetryService.publicLog('extensionGallery:uninstall', data);
 	}
 }

author:joaomoreno
date:2016-04-20T12:56:39Z
title:wip: adopt ipc channels in git world
filename:src/vs/workbench/parts/git/common/gitIpc.ts
code:
@@ -0,0 +1,34 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+'use strict';
+
+import { TPromise } from 'vs/base/common/winjs.base';
+import { IChannel } from 'vs/base/parts/ipc/common/ipc';
+import { RawServiceState, IRawStatus, IPushOptions } from './git';
+
+export interface IGitChannel extends IChannel {
+	call(command: 'getVersion'): TPromise<string>;
+	call(command: 'serviceState'): TPromise<RawServiceState>;
+	call(command: 'status'): TPromise<IRawStatus>;
+	call(command: 'init'): TPromise<IRawStatus>;
+	call(command: 'add', filesPaths?: string[]): TPromise<IRawStatus>;
+	call(command: 'stage', filePath: string, content: string): TPromise<IRawStatus>;
+	call(command: 'branch', name: string, checkout?: boolean): TPromise<IRawStatus>;
+	call(command: 'checkout', treeish?: string, filePaths?: string[]): TPromise<IRawStatus>;
+	call(command: 'clean', filePaths: string[]): TPromise<IRawStatus>;
+	call(command: 'undo'): TPromise<IRawStatus>;
+	call(command: 'reset', treeish:string, hard?: boolean): TPromise<IRawStatus>;
+	call(command: 'revertFiles', treeish:string, filePaths?: string[]): TPromise<IRawStatus>;
+	call(command: 'fetch'): TPromise<IRawStatus>;
+	call(command: 'pull', rebase?: boolean): TPromise<IRawStatus>;
+	call(command: 'push', remote?: string, name?: string, options?: IPushOptions): TPromise<IRawStatus>;
+	call(command: 'sync'): TPromise<IRawStatus>;
+	call(command: 'commit', message:string, amend?: boolean, stage?: boolean): TPromise<IRawStatus>;
+	call(command: 'detectMimetypes', path: string, treeish?: string): TPromise<string[]>;
+	call(command: 'show', path: string, treeish?: string): TPromise<string>;
+	call(command: 'onOutput'): TPromise<void>;
+	call(command: string, ...args: any[]): TPromise<any>;
+}

author:joaomoreno
date:2016-04-20T12:56:39Z
title:wip: adopt ipc channels in git world
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -139,7 +139,7 @@ function createNativeRawGitService(workspaceRoot: string, path: string, defaultE
 			}
 		);
 
-		return client.getChannel('GitService', RawGitService);
+		return client.getChannel('git');
 	}, () => new UnavailableRawGitService());
 }
 

author:joaomoreno
date:2016-04-20T12:56:39Z
title:wip: adopt ipc channels in git world
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -10,6 +10,7 @@ import mime = require('vs/base/node/mime');
 import pfs = require('vs/base/node/pfs');
 import { Repository, GitError } from 'vs/workbench/parts/git/node/git.lib';
 import { IRawGitService, RawServiceState, IRawStatus, IHead, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
+import { IGitChannel } from 'vs/workbench/parts/git/common/gitIpc';
 
 export class RawGitService implements IRawGitService {
 
@@ -262,4 +263,35 @@ export class DelayedRawGitService implements IRawGitService {
 	public onOutput(): Promise {
 		return this.raw.then(raw => raw.onOutput());
 	}
+}
+
+export class GitChannel implements IGitChannel {
+
+	constructor(private rawGitService: IRawGitService) { }
+
+	call(command: string, ...args: any[]): TPromise<any> {
+		switch (command) {
+			case 'getVersion': return this.rawGitService.getVersion();
+			case 'serviceState': return this.rawGitService.serviceState();
+			case 'status': return this.rawGitService.status();
+			case 'status': return this.rawGitService.status();
+			case 'init': return this.rawGitService.init();
+			case 'add': return this.rawGitService.add(args[0]);
+			case 'stage': return this.rawGitService.stage(args[0], args[1]);
+			case 'branch': return this.rawGitService.branch(args[0], args[1]);
+			case 'checkout': return this.rawGitService.checkout(args[0], args[1]);
+			case 'clean': return this.rawGitService.clean(args[0]);
+			case 'undo': return this.rawGitService.undo();
+			case 'reset': return this.rawGitService.reset(args[0], args[1]);
+			case 'revertFiles': return this.rawGitService.revertFiles(args[0], args[1]);
+			case 'fetch': return this.rawGitService.fetch();
+			case 'pull': return this.rawGitService.pull(args[0]);
+			case 'push': return this.rawGitService.push(args[0], args[1], args[2]);
+			case 'sync': return this.rawGitService.sync();
+			case 'commit': return this.rawGitService.commit(args[0], args[1], args[2]);
+			case 'detectMimetypes': return this.rawGitService.detectMimetypes(args[0], args[1]);
+			case 'show': return this.rawGitService.show(args[0], args[1]);
+			case 'onOutput': return this.rawGitService.onOutput();
+		}
+	}
 }
\ No newline at end of file

author:joaomoreno
date:2016-04-21T07:42:13Z
title:ipc: git askpass service
filename:src/vs/workbench/electron-main/main.ts
code:
@@ -20,6 +20,7 @@ import {Instance as UpdateManager} from 'vs/workbench/electron-main/update-manag
 import {Server, serve, connect} from 'vs/base/parts/ipc/node/ipc.net';
 import {getUserEnvironment} from 'vs/base/node/env';
 import {TPromise} from 'vs/base/common/winjs.base';
+import {AskpassChannel} from 'vs/workbench/parts/git/common/gitIpc';
 import {GitAskpassService} from 'vs/workbench/parts/git/electron-main/askpassService';
 import {spawnSharedProcess} from 'vs/workbench/electron-main/sharedProcess';
 import {Mutex} from 'windows-mutex';
@@ -119,7 +120,10 @@ function main(ipcServer: Server, userEnv: env.IProcessEnvironment): void {
 
 	// Register IPC services
 	ipcServer.registerService('LaunchService', new LaunchService());
-	ipcServer.registerService('GitAskpassService', new GitAskpassService());
+
+	const askpassService = new GitAskpassService();
+	const askpassChannel = new AskpassChannel(askpassService);
+	ipcServer.registerChannel('askpass', askpassChannel);
 
 	// Used by sub processes to communicate back to the main instance
 	process.env['VSCODE_PID'] = '' + process.pid;

author:joaomoreno
date:2016-04-21T07:42:13Z
title:ipc: git askpass service
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -243,10 +243,9 @@ export interface IGitCredentialScope {
 	path: string;
 }
 
-export interface IGitCredentials {
+export interface ICredentials {
 	username: string;
 	password: string;
-	store: boolean;
 }
 
 export interface IGitServiceError extends Error {
@@ -316,6 +315,10 @@ export interface IGitService extends EventEmitter.IEventEmitter {
 	onOutput(): WinJS.Promise;
 }
 
+export interface IAskpassService {
+	askpass(id: string, host: string, command: string): WinJS.TPromise<ICredentials>;
+}
+
 // Utils
 
 export function isValidBranchName(value: string): boolean {

author:joaomoreno
date:2016-04-21T07:42:13Z
title:ipc: git askpass service
filename:src/vs/workbench/parts/git/common/gitIpc.ts
code:
@@ -7,7 +7,7 @@
 
 import { TPromise } from 'vs/base/common/winjs.base';
 import { IChannel } from 'vs/base/parts/ipc/common/ipc';
-import { IRawGitService, RawServiceState, IRawStatus, IPushOptions } from './git';
+import { IRawGitService, RawServiceState, IRawStatus, IPushOptions, IAskpassService, ICredentials } from './git';
 
 export interface IGitChannel extends IChannel {
 	call(command: 'getVersion'): TPromise<string>;
@@ -157,4 +157,29 @@ export class GitChannelClient implements IRawGitService {
 	onOutput(): TPromise<void> {
 		return this.channel.call('onOutput');
 	}
+}
+
+export interface IAskpassChannel extends IChannel {
+	call(command: 'askpass', id: string, host: string, gitCommand: string): TPromise<ICredentials>;
+	call(command: string, ...args: any[]): TPromise<any>;
+}
+
+export class AskpassChannel implements IAskpassChannel {
+
+	constructor(private service: IAskpassService) { }
+
+	call(command: string, ...args: any[]): TPromise<any> {
+		switch (command) {
+			case 'askpass': return this.service.askpass(args[0], args[1], args[2]);
+		}
+	}
+}
+
+export class AskpassChannelClient implements IAskpassService {
+
+	constructor(private channel: IAskpassChannel) { }
+
+	askpass(id: string, host: string, command: string): TPromise<ICredentials> {
+		return this.channel.call('askpass', id, host, command);
+	}
 }
\ No newline at end of file

author:joaomoreno
date:2016-04-21T07:42:13Z
title:ipc: git askpass service
filename:src/vs/workbench/parts/git/electron-main/askpassService.ts
code:
@@ -7,6 +7,7 @@ import * as nls from 'vs/nls';
 import { ipcMain as ipc, BrowserWindow} from 'electron';
 import platform = require('vs/base/common/platform');
 import { TPromise } from 'vs/base/common/winjs.base';
+import { IAskpassService } from 'vs/workbench/parts/git/common/git';
 
 export interface ICredentials {
 	username: string;
@@ -23,7 +24,7 @@ interface IContext {
 	window: Electron.BrowserWindow;
 }
 
-export class GitAskpassService {
+export class GitAskpassService implements IAskpassService {
 
 	private askpassCache: { [id: string]: IContext } = Object.create(null);
 

author:joaomoreno
date:2016-04-21T07:42:13Z
title:ipc: git askpass service
filename:src/vs/workbench/parts/git/node/askpass.ts
code:
@@ -6,20 +6,9 @@
 'use strict';
 
 import { connect } from 'vs/base/parts/ipc/node/ipc.net';
-import { TPromise } from 'vs/base/common/winjs.base';
+import { IAskpassChannel, AskpassChannelClient } from 'vs/workbench/parts/git/common/gitIpc';
 import * as fs from 'fs';
 
-export interface ICredentials {
-	username: string;
-	password: string;
-}
-
-export class GitAskpassServiceStub {
-	public askpass(id: string, host: string, command: string): TPromise<ICredentials> {
-		throw new Error('not implemented');
-	}
-}
-
 function fatal(err: any): void {
 	console.error(err);
 	process.exit(1);
@@ -49,7 +38,8 @@ function main(argv: string[]): void {
 
 	connect(process.env['VSCODE_IPC_HOOK'])
 		.then(client => {
-			const service = client.getChannel<GitAskpassServiceStub>('GitAskpassService', GitAskpassServiceStub);
+			const channel = client.getChannel<IAskpassChannel>('askpass');
+			const service = new AskpassChannelClient(channel);
 
 			return service.askpass(id, host, process.env['MONACO_GIT_COMMAND']).then(result => {
 				if (result) {

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/base/parts/ipc/common/ipc.ts
code:
@@ -276,17 +276,8 @@ export class Client implements IClient {
 	}
 }
 
-export function getDelayedChannel<T extends IChannel>(clientPromise: TPromise<IClient>, channelName: string): T {
-	let _channelPromise: TPromise<T>;
-
-	const channelPromise = () => {
-		if (!_channelPromise) {
-			_channelPromise = clientPromise.then(client => client.getChannel(channelName));
-		}
-		return _channelPromise;
-	};
-
-	const call = (command, args) => channelPromise().then(c => c.call(command, ...args));
+export function getDelayedChannel<T extends IChannel>(promise: TPromise<IChannel>): T {
+	const call = (command, args) => promise.then(c => c.call(command, ...args));
 	return { call } as T;
 }
 

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/workbench/buildfile.js
code:
@@ -27,8 +27,8 @@ exports.collectModules= function(excludes) {
 		createModuleDescription('vs/workbench/parts/search/browser/openAnythingHandler', excludes),
 
 		createModuleDescription('vs/workbench/parts/git/browser/gitViewlet', excludes),
-		createModuleDescription('vs/workbench/parts/git/electron-browser/gitApp', []),
-		createModuleDescription('vs/workbench/parts/git/electron-main/askpass', []),
+		createModuleDescription('vs/workbench/parts/git/node/gitApp', []),
+		createModuleDescription('vs/workbench/parts/git/node/askpass', []),
 
 		createModuleDescription('vs/workbench/parts/output/common/outputMode', languageMainExcludes),
 		createModuleDescription('vs/workbench/parts/output/common/outputWorker', languageWorkerExcludes),

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -277,7 +277,7 @@ export interface IRawGitService {
 	commit(message:string, amend?: boolean, stage?: boolean): WinJS.TPromise<IRawStatus>;
 	detectMimetypes(path: string, treeish?: string): WinJS.TPromise<string[]>;
 	show(path: string, treeish?: string): WinJS.TPromise<string>;
-	onOutput(): WinJS.Promise;
+	onOutput(): WinJS.Promise; // TODO: make this an event
 }
 
 export var GIT_SERVICE_ID = 'gitService';

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/workbench/parts/git/common/gitIpc.ts
code:
@@ -7,7 +7,7 @@
 
 import { TPromise } from 'vs/base/common/winjs.base';
 import { IChannel } from 'vs/base/parts/ipc/common/ipc';
-import { RawServiceState, IRawStatus, IPushOptions } from './git';
+import { IRawGitService, RawServiceState, IRawStatus, IPushOptions } from './git';
 
 export interface IGitChannel extends IChannel {
 	call(command: 'getVersion'): TPromise<string>;
@@ -32,3 +32,129 @@ export interface IGitChannel extends IChannel {
 	call(command: 'onOutput'): TPromise<void>;
 	call(command: string, ...args: any[]): TPromise<any>;
 }
+
+export class GitChannel implements IGitChannel {
+
+	constructor(private service: TPromise<IRawGitService>) { }
+
+	call(command: string, ...args: any[]): TPromise<any> {
+		switch (command) {
+			case 'getVersion': return this.service.then(s => s.getVersion());
+			case 'serviceState': return this.service.then(s => s.serviceState());
+			case 'status': return this.service.then(s => s.status());
+			case 'status': return this.service.then(s => s.status());
+			case 'init': return this.service.then(s => s.init());
+			case 'add': return this.service.then(s => s.add(args[0]));
+			case 'stage': return this.service.then(s => s.stage(args[0], args[1]));
+			case 'branch': return this.service.then(s => s.branch(args[0], args[1]));
+			case 'checkout': return this.service.then(s => s.checkout(args[0], args[1]));
+			case 'clean': return this.service.then(s => s.clean(args[0]));
+			case 'undo': return this.service.then(s => s.undo());
+			case 'reset': return this.service.then(s => s.reset(args[0], args[1]));
+			case 'revertFiles': return this.service.then(s => s.revertFiles(args[0], args[1]));
+			case 'fetch': return this.service.then(s => s.fetch());
+			case 'pull': return this.service.then(s => s.pull(args[0]));
+			case 'push': return this.service.then(s => s.push(args[0], args[1], args[2]));
+			case 'sync': return this.service.then(s => s.sync());
+			case 'commit': return this.service.then(s => s.commit(args[0], args[1], args[2]));
+			case 'detectMimetypes': return this.service.then(s => s.detectMimetypes(args[0], args[1]));
+			case 'show': return this.service.then(s => s.show(args[0], args[1]));
+			case 'onOutput': return this.service.then(s => s.onOutput());
+		}
+	}
+}
+
+export class UnavailableGitChannel implements IGitChannel {
+
+	call(command: string): TPromise<any> {
+		switch (command) {
+			case 'serviceState': return TPromise.as(RawServiceState.GitNotFound);
+			default: return TPromise.as(null);
+		}
+	}
+}
+
+export class GitChannelClient implements IRawGitService {
+
+	constructor(private channel: IGitChannel) { }
+
+	getVersion(): TPromise<string> {
+		return this.channel.call('getVersion');
+	}
+
+	serviceState(): TPromise<RawServiceState> {
+		return this.channel.call('serviceState');
+	}
+
+	status(): TPromise<IRawStatus> {
+		return this.channel.call('status');
+	}
+
+	init(): TPromise<IRawStatus> {
+		return this.channel.call('init');
+	}
+
+	add(filesPaths?: string[]): TPromise<IRawStatus> {
+		return this.channel.call('add', filesPaths);
+	}
+
+	stage(filePath: string, content: string): TPromise<IRawStatus> {
+		return this.channel.call('stage', filePath, content);
+	}
+
+	branch(name: string, checkout?: boolean): TPromise<IRawStatus> {
+		return this.channel.call('branch', name, checkout);
+	}
+
+	checkout(treeish?: string, filePaths?: string[]): TPromise<IRawStatus> {
+		return this.channel.call('checkout', treeish, filePaths);
+	}
+
+	clean(filePaths: string[]): TPromise<IRawStatus> {
+		return this.channel.call('clean', filePaths);
+	}
+
+	undo(): TPromise<IRawStatus> {
+		return this.channel.call('undo');
+	}
+
+	reset(treeish:string, hard?: boolean): TPromise<IRawStatus> {
+		return this.channel.call('reset', treeish, hard);
+	}
+
+	revertFiles(treeish:string, filePaths?: string[]): TPromise<IRawStatus> {
+		return this.channel.call('revertFiles', treeish, filePaths);
+	}
+
+	fetch(): TPromise<IRawStatus> {
+		return this.channel.call('fetch');
+	}
+
+	pull(rebase?: boolean): TPromise<IRawStatus> {
+		return this.channel.call('pull', rebase);
+	}
+
+	push(remote?: string, name?: string, options?:IPushOptions): TPromise<IRawStatus> {
+		return this.channel.call('push', remote, name, options);
+	}
+
+	sync(): TPromise<IRawStatus> {
+		return this.channel.call('sync');
+	}
+
+	commit(message:string, amend?: boolean, stage?: boolean): TPromise<IRawStatus> {
+		return this.channel.call('commit', message, amend, stage);
+	}
+
+	detectMimetypes(path: string, treeish?: string): TPromise<string[]> {
+		return this.channel.call('detectMimetypes', path, treeish);
+	}
+
+	show(path: string, treeish?: string): TPromise<string> {
+		return this.channel.call('show', path, treeish);
+	}
+
+	onOutput(): TPromise<void> {
+		return this.channel.call('onOutput');
+	}
+}
\ No newline at end of file

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 
 import { TPromise } from 'vs/base/common/winjs.base';
-import { RawServiceState } from 'vs/workbench/parts/git/common/git';
+import { IRawGitService, RawServiceState } from 'vs/workbench/parts/git/common/git';
 import { NoOpGitService } from 'vs/workbench/parts/git/common/noopGitService';
 import { GitService } from 'vs/workbench/parts/git/browser/gitServices';
 import { ILifecycleService } from 'vs/platform/lifecycle/common/lifecycle';
@@ -15,8 +15,10 @@ import { IEventService } from 'vs/platform/event/common/event';
 import { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';
 import { IMessageService } from 'vs/platform/message/common/message';
 import { IWorkspaceContextService } from 'vs/platform/workspace/common/workspace';
+import { getDelayedChannel } from 'vs/base/parts/ipc/common/ipc';
 import { Client } from 'vs/base/parts/ipc/node/ipc.cp';
-import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
+import { GitChannelClient, UnavailableGitChannel } from 'vs/workbench/parts/git/common/gitIpc';
+import { RawGitService } from 'vs/workbench/parts/git/node/rawGitService';
 import URI from 'vs/base/common/uri';
 import { spawn, exec } from 'child_process';
 import { join } from 'path';
@@ -112,51 +114,19 @@ class UnavailableRawGitService extends RawGitService {
 	constructor() {
 		super(null);
 	}
+
+	serviceState(): TPromise<RawServiceState> {
+		return TPromise.as(RawServiceState.GitNotFound);
+	}
 }
 
 class DisabledRawGitService extends RawGitService {
 	constructor() {
 		super(null);
 	}
 
-	public serviceState(): TPromise<RawServiceState> {
-		return TPromise.as<RawServiceState>(RawServiceState.Disabled);
-	}
-}
-
-function createNativeRawGitService(workspaceRoot: string, path: string, defaultEncoding: string): TPromise<RawGitService> {
-	return findGit(path).then(({ path, version }) => {
-		const client = new Client(
-			URI.parse(require.toUrl('bootstrap')).fsPath,
-			{
-				serverName: 'Git',
-				timeout: 1000 * 60,
-				args: [path, workspaceRoot, defaultEncoding, remote.process.execPath, version],
-				env: {
-					ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
-					AMD_ENTRYPOINT: 'vs/workbench/parts/git/electron-browser/gitApp'
-				}
-			}
-		);
-
-		return client.getChannel('git');
-	}, () => new UnavailableRawGitService());
-}
-
-class ElectronRawGitService extends DelayedRawGitService {
-	constructor(workspaceRoot: string, @IConfigurationService configurationService: IConfigurationService) {
-		super(TPromise.as(configurationService.getConfiguration<any>()).then(conf => {
-			var enabled = conf.git ? conf.git.enabled : true;
-
-			if (!enabled) {
-				return TPromise.as(new DisabledRawGitService());
-			}
-
-			var gitPath = (conf.git && conf.git.path) || null;
-			var encoding = (conf.files && conf.files.encoding) || 'utf8';
-
-			return createNativeRawGitService(workspaceRoot, gitPath, encoding);
-		}));
+	serviceState(): TPromise<RawServiceState> {
+		return TPromise.as(RawServiceState.Disabled);
 	}
 }
 
@@ -169,12 +139,46 @@ export class ElectronGitService extends GitService {
 		@IOutputService outputService: IOutputService,
 		@IWorkspaceContextService contextService: IWorkspaceContextService,
 		@ILifecycleService lifecycleService: ILifecycleService,
-		@IStorageService storageService: IStorageService
+		@IStorageService storageService: IStorageService,
+		@IConfigurationService configurationService: IConfigurationService
 	) {
-		let workspace = contextService.getWorkspace();
-		let raw = !workspace
-			? new NoOpGitService()
-			: instantiationService.createInstance(ElectronRawGitService, workspace.resource.fsPath);
+		const conf = configurationService.getConfiguration<any>();
+		const enabled = conf.git ? conf.git.enabled : true;
+		const workspace = contextService.getWorkspace();
+
+		let raw: IRawGitService;
+
+		if (!enabled) {
+			raw = new DisabledRawGitService();
+		} else if (!workspace) {
+			raw = new NoOpGitService();
+		} else {
+			const gitPath = (conf.git && conf.git.path) || null;
+			const encoding = (conf.files && conf.files.encoding) || 'utf8';
+			const workspaceRoot = workspace.resource.fsPath;
+
+			const promise = findGit(gitPath)
+				.then(({ path, version }) => {
+					const client = new Client(
+						URI.parse(require.toUrl('bootstrap')).fsPath,
+						{
+							serverName: 'Git',
+							timeout: 1000 * 60,
+							args: [path, workspaceRoot, encoding, remote.process.execPath, version],
+							env: {
+								ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
+								AMD_ENTRYPOINT: 'vs/workbench/parts/git/node/gitApp'
+							}
+						}
+					);
+
+					return client.getChannel('git');
+				})
+				.then(null, () => new UnavailableGitChannel());
+
+			const channel = getDelayedChannel(promise);
+			raw = new GitChannelClient(channel);
+		}
 
 		super(raw, instantiationService, eventService, messageService, editorService, outputService, contextService, lifecycleService, storageService);
 	}

author:joaomoreno
date:2016-04-21T07:31:32Z
title:adopt new ipc in git service
filename:src/vs/workbench/parts/git/electron-browser/gitApp.ts
code:
@@ -1,61 +0,0 @@
-/*---------------------------------------------------------------------------------------------
- *  Copyright (c) Microsoft Corporation. All rights reserved.
- *  Licensed under the MIT License. See License.txt in the project root for license information.
- *--------------------------------------------------------------------------------------------*/
-'use strict';
-
-import { TPromise } from 'vs/base/common/winjs.base';
-import { Server } from 'vs/base/parts/ipc/node/ipc.cp';
-import objects = require('vs/base/common/objects');
-import uri from 'vs/base/common/uri';
-import { GitErrorCodes } from 'vs/workbench/parts/git/common/git';
-import gitlib = require('vs/workbench/parts/git/node/git.lib');
-import { RawGitService, DelayedRawGitService } from 'vs/workbench/parts/git/node/rawGitService';
-import { join, normalize } from 'path';
-import { tmpdir } from 'os';
-import { realpath } from 'vs/base/node/pfs';
-
-class IPCRawGitService extends DelayedRawGitService {
-
-	constructor(gitPath: string, workspaceRoot: string, defaultEncoding: string, exePath: string, version: string) {
-		if (!gitPath) {
-			super(TPromise.as(new RawGitService(null)));
-		} else {
-			const gitRootPath = uri.parse(require.toUrl('vs/workbench/parts/git/electron-main')).fsPath;
-			const bootstrapPath = `${ uri.parse(require.toUrl('bootstrap')).fsPath }.js`;
-			workspaceRoot = normalize(workspaceRoot);
-
-			const env = objects.assign({}, process.env, {
-				GIT_ASKPASS: join(gitRootPath, 'askpass.sh'),
-				VSCODE_GIT_ASKPASS_BOOTSTRAP: bootstrapPath,
-				VSCODE_GIT_ASKPASS_NODE: exePath,
-				VSCODE_GIT_ASKPASS_MODULE_ID: 'vs/workbench/parts/git/electron-main/askpass'
-			});
-
-			const git = new gitlib.Git({
-				gitPath, version,
-				tmpPath: tmpdir(),
-				defaultEncoding: defaultEncoding,
-				env: env
-			});
-
-			const repo = git.open(workspaceRoot);
-			const promise = repo.getRoot()
-				.then<string>(null, (err: gitlib.GitError) => {
-					if (err instanceof gitlib.GitError && err.gitErrorCode === GitErrorCodes.NotAGitRepository) {
-						return workspaceRoot;
-					}
-
-					return TPromise.wrapError(err);
-				})
-				.then(root => realpath(root))
-				.then(root => git.open(root))
-				.then(repo => new RawGitService(repo));
-
-			super(promise);
-		}
-	}
-}
-
-const server = new Server();
-server.registerChannel('GitService', new IPCRawGitService(process.argv[2], process.argv[3], process.argv[4], process.argv[5], process.argv[6]));
\ No newline at end of file

author:joaomoreno
date:2016-04-21T14:01:18Z
title:Merge branch 'postinstall' of https://github.com/f111fei/vscode into f111fei-postinstall
filename:build/npm/postinstall.js
code:
@@ -0,0 +1,12 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+
+var cp = require('child_process');
+
+var extensions = ['vscode-api-tests', 'vscode-colorize-tests', 'json', 'typescript', 'php', 'javascript'];
+
+extensions.forEach(function (extension) {
+	cp.execSync('npm --prefix extensions/' + extension + '/ install extensions/' + extension + '/');
+});
\ No newline at end of file

author:joaomoreno
date:2016-04-21T14:01:18Z
title:Merge branch 'postinstall' of https://github.com/f111fei/vscode into f111fei-postinstall
filename:package.json
code:
@@ -13,7 +13,7 @@
   "scripts": {
     "test": "mocha",
     "preinstall": "node build/npm/preinstall.js",
-    "postinstall": "npm --prefix extensions/vscode-api-tests/ install extensions/vscode-api-tests/ && npm --prefix extensions/vscode-colorize-tests/ install extensions/vscode-colorize-tests/ && npm --prefix extensions/json/ install extensions/json/ && npm --prefix extensions/typescript/ install extensions/typescript/ && npm --prefix extensions/php/ install extensions/php/ && npm --prefix extensions/javascript/ install extensions/javascript/",
+    "postinstall": "node build/npm/postinstall.js",
     "watch": "gulp watch"
   },
   "dependencies": {

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/browser/gitOutput.ts
code:
@@ -2,58 +2,41 @@
  *  Copyright (c) Microsoft Corporation. All rights reserved.
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
+
 'use strict';
 
-import winjs = require('vs/base/common/winjs.base');
-import {IGitService, ServiceEvents} from 'vs/workbench/parts/git/common/git';
-import ext = require('vs/workbench/common/contributions');
-import {IOutputService} from 'vs/workbench/parts/output/common/output';
+import { IDisposable, dispose } from 'vs/base/common/lifecycle';
+import { IGitService, ServiceEvents } from 'vs/workbench/parts/git/common/git';
+import { IWorkbenchContribution } from 'vs/workbench/common/contributions';
+import { IOutputService } from 'vs/workbench/parts/output/common/output';
 
-export class GitOutput implements ext.IWorkbenchContribution {
+export class GitOutput implements IWorkbenchContribution {
 
 	static ID = 'Monaco.IDE.UI.Viewlets.GitViewlet.Workbench.GitOutput';
 
-	private promise: winjs.Promise;
+	private outputListener: IDisposable;
 	private gitService: IGitService;
 	private outputService: IOutputService;
 
 	constructor(@IGitService gitService: IGitService, @IOutputService outputService: IOutputService) {
 		this.gitService = gitService;
 		this.outputService = outputService;
 
-		// we must make sure onOutput is the first thing the git service is asked,
-		// so before any service operation, we call onOutput first
-		gitService.addListener2(ServiceEvents.OPERATION_START, () => this.setup());
+		const listener = gitService.addListener2(ServiceEvents.OPERATION_START, () => {
+			this.outputListener = this.gitService.onOutput(output => this.onOutput(output));
+			listener.dispose();
+		});
 	}
 
-	public getId(): string {
+	getId(): string {
 		return GitOutput.ID;
 	}
 
-	private setup(): void {
-		if (this.promise) {
-			return;
-		}
-
-		this.promise = this.gitService.onOutput().then(() => {
-			this.promise = null;
-		}, (e: any) => {
-			if (e && e.name === 'Canceled') {
-				this.promise = null;
-			} else {
-				console.error(e);
-			}
-		}, (o: string) => this.onOutput(o));
-	}
-
 	private onOutput(output: string): void {
 		this.outputService.getChannel('Git').append(output);
 	}
 
-	public dispose(): void {
-		if (this.promise) {
-			this.promise.cancel();
-			this.promise = null;
-		}
+	dispose(): void {
+		this.outputListener = dispose(this.outputListener);
 	}
 }
\ No newline at end of file

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/browser/gitServices.ts
code:
@@ -36,6 +36,7 @@ import URI from 'vs/base/common/uri';
 import * as semver from 'semver';
 import { shell } from 'electron';
 import {IStorageService, StorageScope} from 'vs/platform/storage/common/storage';
+import Event from 'vs/base/common/event';
 
 function toReadablePath(path: string): string {
 	if (!platform.isWindows) {
@@ -397,6 +398,8 @@ export class GitService extends ee.EventEmitter
 	private refreshDelayer: async.ThrottledDelayer<void>;
 	private autoFetcher: AutoFetcher;
 
+	get onOutput(): Event<string> { return this.raw.onOutput; }
+
 	constructor(
 		raw: git.IRawGitService,
 		@IInstantiationService instantiationService: IInstantiationService,
@@ -771,10 +774,6 @@ export class GitService extends ee.EventEmitter
 		return this.operations;
 	}
 
-	public onOutput(): winjs.Promise {
-		return this.raw.onOutput();
-	}
-
 	public getAutoFetcher(): git.IAutoFetcher {
 		return this.autoFetcher;
 	}

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -8,6 +8,7 @@ import WinJS = require('vs/base/common/winjs.base');
 import WorkbenchEditorCommon = require('vs/workbench/common/editor');
 import EventEmitter = require('vs/base/common/eventEmitter');
 import Lifecycle = require('vs/base/common/lifecycle');
+import Event from 'vs/base/common/event';
 import {createDecorator, ServiceIdentifier} from 'vs/platform/instantiation/common/instantiation';
 
 // Model raw interfaces
@@ -257,6 +258,7 @@ export interface IPushOptions {
 }
 
 export interface IRawGitService {
+	onOutput: Event<string>;
 	getVersion(): WinJS.TPromise<string>;
 	serviceState(): WinJS.TPromise<RawServiceState>;
 	status(): WinJS.TPromise<IRawStatus>;
@@ -276,7 +278,6 @@ export interface IRawGitService {
 	commit(message:string, amend?: boolean, stage?: boolean): WinJS.TPromise<IRawStatus>;
 	detectMimetypes(path: string, treeish?: string): WinJS.TPromise<string[]>;
 	show(path: string, treeish?: string): WinJS.TPromise<string>;
-	onOutput(): WinJS.Promise; // TODO: make this an event
 }
 
 export var GIT_SERVICE_ID = 'gitService';
@@ -285,6 +286,7 @@ export var IGitService = createDecorator<IGitService>(GIT_SERVICE_ID);
 
 export interface IGitService extends EventEmitter.IEventEmitter {
 	serviceId: ServiceIdentifier<any>;
+	onOutput: Event<string>;
 	status(): WinJS.TPromise<IModel>;
 	init(): WinJS.TPromise<IModel>;
 	add(files?: IFileStatus[]): WinJS.TPromise<IModel>;
@@ -311,8 +313,6 @@ export interface IGitService extends EventEmitter.IEventEmitter {
 	isIdle(): boolean;
 	getRunningOperations(): IGitOperation[];
 	getAutoFetcher(): IAutoFetcher;
-
-	onOutput(): WinJS.Promise;
 }
 
 export interface IAskpassService {

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/common/gitIpc.ts
code:
@@ -6,7 +6,8 @@
 'use strict';
 
 import { TPromise } from 'vs/base/common/winjs.base';
-import { IChannel } from 'vs/base/parts/ipc/common/ipc';
+import { IChannel, eventToCall, eventFromCall } from 'vs/base/parts/ipc/common/ipc';
+import Event from 'vs/base/common/event';
 import { IRawGitService, RawServiceState, IRawStatus, IPushOptions, IAskpassService, ICredentials } from './git';
 
 export interface IGitChannel extends IChannel {
@@ -59,7 +60,7 @@ export class GitChannel implements IGitChannel {
 			case 'commit': return this.service.then(s => s.commit(args[0], args[1], args[2]));
 			case 'detectMimetypes': return this.service.then(s => s.detectMimetypes(args[0], args[1]));
 			case 'show': return this.service.then(s => s.show(args[0], args[1]));
-			case 'onOutput': return this.service.then(s => s.onOutput());
+			case 'onOutput': return this.service.then(s => eventToCall(s.onOutput));
 		}
 	}
 }
@@ -78,6 +79,9 @@ export class GitChannelClient implements IRawGitService {
 
 	constructor(private channel: IGitChannel) { }
 
+	private _onOutput = eventFromCall(this.channel, 'onOutput');
+	get onOutput(): Event<string> { return this._onOutput; }
+
 	getVersion(): TPromise<string> {
 		return this.channel.call('getVersion');
 	}
@@ -153,10 +157,6 @@ export class GitChannelClient implements IRawGitService {
 	show(path: string, treeish?: string): TPromise<string> {
 		return this.channel.call('show', [path, treeish]);
 	}
-
-	onOutput(): TPromise<void> {
-		return this.channel.call('onOutput');
-	}
 }
 
 export interface IAskpassChannel extends IChannel {

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -5,9 +5,15 @@
 'use strict';
 
 import git = require('vs/workbench/parts/git/common/git');
-import { Promise, TPromise } from 'vs/base/common/winjs.base';
+import { TPromise } from 'vs/base/common/winjs.base';
+import Event, { Emitter } from 'vs/base/common/event';
 
+// TODO: remove
 export class NoOpGitService implements git.IRawGitService {
+
+	private _onOutput = new Emitter<string>();
+	get onOutput(): Event<string> { return this._onOutput.event; }
+
 	private static STATUS:git.IRawStatus = {
 		repositoryRoot: null,
 		state: git.ServiceState.NotAWorkspace,
@@ -93,8 +99,4 @@ export class NoOpGitService implements git.IRawGitService {
 	public show(path: string, treeish?: string): TPromise<string> {
 		return TPromise.as(null);
 	}
-
-	public onOutput(): Promise {
-		return TPromise.as(() => null);
-	}
 }
\ No newline at end of file

author:joaomoreno
date:2016-04-21T13:29:43Z
title:use events for git output
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -10,14 +10,29 @@ import mime = require('vs/base/node/mime');
 import pfs = require('vs/base/node/pfs');
 import { Repository, GitError } from 'vs/workbench/parts/git/node/git.lib';
 import { IRawGitService, RawServiceState, IRawStatus, IHead, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
+import Event, { Emitter } from 'vs/base/common/event';
 
 export class RawGitService implements IRawGitService {
 
 	private repo: Repository;
 	private _repositoryRoot: TPromise<string>;
+	private _onOutput: Emitter<string>;
+	get onOutput(): Event<string> { return this._onOutput.event; }
 
 	constructor(repo: Repository) {
 		this.repo = repo;
+
+		let listener: () => void;
+
+		this._onOutput = new Emitter<string>({
+			onFirstListenerAdd: () => {
+				listener = this.repo.onOutput(output => this._onOutput.fire(output));
+			},
+			onLastListenerRemove: () => {
+				listener();
+				listener = null;
+			}
+		});
 	}
 
 	getVersion(): TPromise<string> {
@@ -169,12 +184,4 @@ export class RawGitService implements IRawGitService {
 			return TPromise.wrapError<string>(e);
 		});
 	}
-
-	onOutput(): Promise {
-		let cancel: () => void;
-
-		return new Promise((c, e, p) => {
-			cancel = this.repo.onOutput(p);
-		}, () => cancel());
-	}
 }

author:joaomoreno
date:2016-04-21T09:35:04Z
title:use pipe_logging in git
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -167,6 +167,7 @@ export class ElectronGitService extends GitService {
 							args: [path, workspaceRoot, encoding, remote.process.execPath, version],
 							env: {
 								ATOM_SHELL_INTERNAL_RUN_AS_NODE: 1,
+								PIPE_LOGGING: 'true',
 								AMD_ENTRYPOINT: 'vs/workbench/parts/git/node/gitApp'
 							}
 						}

author:joaomoreno
date:2016-04-21T09:19:16Z
title:fix raw git service .show
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -160,7 +160,7 @@ export class RawGitService implements IRawGitService {
 
 	// careful, this buffers the whole object into memory
 	show(filePath: string, treeish?: string): TPromise<string> {
-		treeish = treeish === '~' ? '' : treeish;
+		treeish = (!treeish || treeish === '~') ? '' : treeish;
 		return this.repo.buffer(treeish + ':' + filePath).then(null, e => {
 			if (e instanceof GitError) {
 				return ''; // mostly untracked files end up in a git error

author:aioutecism
date:2016-04-23T22:55:03Z
title:Fix validatePosition related bug
(https://github.com/Microsoft/vscode/issues/5704).
filename:src/vs/editor/common/model/textModel.ts
code:
@@ -491,17 +491,20 @@ export class TextModel extends OrderGuaranteeEventEmitter implements editorCommo
 
 		if (lineNumber < 1) {
 			lineNumber = 1;
+			column = 1;
 		}
-		if (lineNumber > this._lines.length) {
+		else if (lineNumber > this._lines.length) {
 			lineNumber = this._lines.length;
+			column = this.getLineMaxColumn(lineNumber);
 		}
-
-		if (column < 1) {
-			column = 1;
-		}
-		var maxColumn = this.getLineMaxColumn(lineNumber);
-		if (column > maxColumn) {
-			column = maxColumn;
+		else {
+			var maxColumn = this.getLineMaxColumn(lineNumber);
+			if (column < 1) {
+				column = 1;
+			}
+			else if (column > maxColumn) {
+				column = maxColumn;
+			}
 		}
 
 		return new Position(lineNumber, column);
@@ -837,4 +840,4 @@ export class RawText {
 		});
 	}
 
-}
\ No newline at end of file
+}

author:aioutecism
date:2016-04-23T22:55:03Z
title:Fix validatePosition related bug
(https://github.com/Microsoft/vscode/issues/5704).
filename:src/vs/workbench/api/node/extHostDocuments.ts
code:
@@ -393,23 +393,24 @@ export class ExtHostDocumentData extends MirrorModel2 {
 
 		if (line < 0) {
 			line = 0;
+			character = 0;
 			hasChanged = true;
 		}
-
-		if (line >= this._lines.length) {
+		else if (line >= this._lines.length) {
 			line = this._lines.length - 1;
+			character = this._lines[line].length;
 			hasChanged = true;
 		}
-
-		if (character < 0) {
-			character = 0;
-			hasChanged = true;
-		}
-
-		let maxCharacter = this._lines[line].length;
-		if (character > maxCharacter) {
-			character = maxCharacter;
-			hasChanged = true;
+		else {
+			let maxCharacter = this._lines[line].length;
+			if (character < 0) {
+				character = 0;
+				hasChanged = true;
+			}
+			else if (character > maxCharacter) {
+				character = maxCharacter;
+				hasChanged = true;
+			}
 		}
 
 		if (!hasChanged) {
@@ -673,4 +674,4 @@ export class MainThreadDocuments {
 			}
 		}, onUnexpectedError);
 	}
-}
\ No newline at end of file
+}

author:alexdima
date:2016-04-26T13:55:19Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:extensions/node-debug/node-debug.azure.json
code:
@@ -1,6 +1,6 @@
 {
 	"account": "monacobuild",
 	"container": "debuggers",
-	"zip": "67fe9de/node-debug.zip",
+	"zip": "c2c41f3/node-debug.zip",
 	"output": ""
 }

author:alexdima
date:2016-04-26T13:55:19Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/browser/parts/editor/editorStatus.ts
code:
@@ -781,8 +781,8 @@ class ChangeIndentationAction extends Action {
 		].map((a: EditorAction) => {
 			return {
 				id: a.id,
-				label: (language === LANGUAGE_DEFAULT) ? a.label : a.getAlias(),
-				detail: (language === LANGUAGE_DEFAULT) ? null : a.label,
+				label: a.label,
+				detail: (language === LANGUAGE_DEFAULT) ? null : a.getAlias(),
 				run: () => a.run()
 			};
 		});
@@ -876,8 +876,8 @@ export class ChangeEncodingAction extends Action {
 			saveWithEncodingPick = { label: nls.localize('saveWithEncoding', "Save with Encoding") };
 			reopenWithEncodingPick = { label: nls.localize('reopenWithEncoding', "Reopen with Encoding") };
 		} else {
-			saveWithEncodingPick = { label: 'Save with Encoding', detail: nls.localize('saveWithEncoding', "Save with Encoding"), };
-			reopenWithEncodingPick = { label: 'Reopen with Encoding', detail: nls.localize('reopenWithEncoding', "Reopen with Encoding") };
+			saveWithEncodingPick = { label: nls.localize('saveWithEncoding', "Save with Encoding"), detail: 'Save with Encoding', };
+			reopenWithEncodingPick = { label: nls.localize('reopenWithEncoding', "Reopen with Encoding"), detail: 'Reopen with Encoding' };
 		}
 
 		if (encodingSupport instanceof UntitledEditorInput) {

author:alexdima
date:2016-04-26T13:55:19Z
title:Merge branch 'master' of https://github.com/Microsoft/vscode
filename:src/vs/workbench/parts/quickopen/browser/commandsHandler.ts
code:
@@ -287,10 +287,6 @@ export class CommandsHandler extends QuickOpenHandler {
 
 				// Alias for non default languages
 				let alias = (language !== LANGUAGE_DEFAULT) ? registry.getAlias(actionDescriptor.id) : null;
-				if (alias) {
-					[label, alias] = [alias, label]; // swap alias and label so that english alias is #1
-				}
-
 				let labelHighlights = wordFilter(searchValue, label);
 				let aliasHighlights = alias ? wordFilter(searchValue, alias) : null;
 				if (labelHighlights || aliasHighlights) {
@@ -322,10 +318,6 @@ export class CommandsHandler extends QuickOpenHandler {
 
 				// Alias for non default languages
 				let alias = (language !== LANGUAGE_DEFAULT) ? action.getAlias() : null;
-				if (alias) {
-					[label, alias] = [alias, label]; // swap alias and label so that english alias is #1
-				}
-
 				let labelHighlights = wordFilter(searchValue, label);
 				let aliasHighlights = alias ? wordFilter(searchValue, alias) : null;
 				if (labelHighlights || aliasHighlights) {

author:jrieken
date:2016-05-11T14:26:32Z
title:startup perf, take finding git off the critical path
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -157,7 +157,8 @@ export class ElectronGitService extends GitService {
 			const encoding = (conf.files && conf.files.encoding) || 'utf8';
 			const workspaceRoot = workspace.resource.fsPath;
 
-			const promise = findGit(gitPath)
+			const promise = TPromise.timeout(0) // free event loop cos finding git costs
+				.then(() => findGit(gitPath))
 				.then(({ path, version }) => {
 					const client = new Client(
 						URI.parse(require.toUrl('bootstrap')).fsPath,

author:joaomoreno
date:2016-05-26T07:13:59Z
title:add title to git changes

fixes #6271
filename:src/vs/workbench/parts/git/browser/views/changes/changesViewer.ts
code:
@@ -364,6 +364,7 @@ export class Renderer implements tree.IRenderer {
 		}
 
 		data.name.textContent = rename || name;
+		data.name.title = renamePath || path;
 		data.folder.textContent = toReadablePath(renameFolder || folder);
 	}
 

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/browser/gitQuickOpen.ts
code:
@@ -8,37 +8,35 @@ import nls = require('vs/nls');
 import filters = require('vs/base/common/filters');
 import winjs = require('vs/base/common/winjs.base');
 import severity from 'vs/base/common/severity';
-import git = require('vs/workbench/parts/git/common/git');
+import { IGitService, RefType, IRef, isValidBranchName } from 'vs/workbench/parts/git/common/git';
 import quickopenwb = require('vs/workbench/browser/quickopen');
 import quickopen = require('vs/base/parts/quickopen/common/quickOpen');
 import model = require('vs/base/parts/quickopen/browser/quickOpenModel');
 import {IQuickOpenService} from 'vs/workbench/services/quickopen/common/quickOpenService';
 import {IMessageService} from 'vs/platform/message/common/message';
 
-import IGitService = git.IGitService;
-
 // Entries
 
 class AbstractRefEntry extends model.QuickOpenEntry {
 
-	protected gitService: git.IGitService;
+	protected gitService: IGitService;
 	protected messageService: IMessageService;
-	protected head: git.IBranch;
+	protected ref: IRef;
 
-	constructor(gitService: git.IGitService, messageService: IMessageService, head: git.IBranch, highlights:model.IHighlight[]) {
+	constructor(gitService: IGitService, messageService: IMessageService, ref: IRef, highlights:model.IHighlight[]) {
 		super(highlights);
 
 		this.gitService = gitService;
 		this.messageService = messageService;
-		this.head = head;
+		this.ref = ref;
 	}
 
-	public getIcon(): string { return 'git'; }
-	public getLabel(): string { return this.head.name; }
-	public getDescription(): string { return ''; }
-	public getAriaLabel(): string { return nls.localize('refAriaLabel', "{0}, git", this.getLabel()); }
+	getIcon(): string { return 'git'; }
+	getLabel(): string { return this.ref.name; }
+	getDescription(): string { return ''; }
+	getAriaLabel(): string { return nls.localize('refAriaLabel', "{0}, git", this.getLabel()); }
 
-	public run(mode: quickopen.Mode, context: model.IContext):boolean {
+	run(mode: quickopen.Mode, context: model.IContext):boolean {
 		if (mode === quickopen.Mode.PREVIEW) {
 			return false;
 		}
@@ -49,56 +47,73 @@ class AbstractRefEntry extends model.QuickOpenEntry {
 
 class CheckoutHeadEntry extends AbstractRefEntry {
 
-	public getDescription(): string { return nls.localize('checkoutBranch', "Branch at {0}", this.head.commit.substr(0, 8)); }
+	getDescription(): string { return nls.localize('checkoutBranch', "Branch at {0}", this.ref.commit.substr(0, 8)); }
+
+	run(mode: quickopen.Mode, context: model.IContext): boolean {
+		if (mode === quickopen.Mode.PREVIEW) {
+			return false;
+		}
+
+		this.gitService.checkout(this.ref.name).done(null, e => this.messageService.show(severity.Error, e));
+		return true;
+	}
+}
 
-	public run(mode: quickopen.Mode, context: model.IContext): boolean {
+class CheckoutRemoteHeadEntry extends AbstractRefEntry {
+
+	getDescription(): string { return nls.localize('checkoutRemoteBranch', "Remote branch at {0}", this.ref.commit.substr(0, 8)); }
+
+	run(mode: quickopen.Mode, context: model.IContext): boolean {
 		if (mode === quickopen.Mode.PREVIEW) {
 			return false;
 		}
 
-		this.gitService.checkout(this.head.name).done(null, e => this.messageService.show(severity.Error, e));
+		const match = /^[^/]+\/(.*)$/.exec(this.ref.name);
+		const name = match ? match[1] : this.ref.name;
+
+		this.gitService.checkout(name).done(null, e => this.messageService.show(severity.Error, e));
 		return true;
 	}
 }
 
 class CheckoutTagEntry extends AbstractRefEntry {
 
-	public getDescription(): string { return nls.localize('checkoutTag', "Tag at {0}", this.head.commit.substr(0, 8)); }
+	getDescription(): string { return nls.localize('checkoutTag', "Tag at {0}", this.ref.commit.substr(0, 8)); }
 
-	public run(mode: quickopen.Mode, context: model.IContext): boolean {
+	run(mode: quickopen.Mode, context: model.IContext): boolean {
 		if (mode === quickopen.Mode.PREVIEW) {
 			return false;
 		}
 
-		this.gitService.checkout(this.head.name).done(null, e => this.messageService.show(severity.Error, e));
+		this.gitService.checkout(this.ref.name).done(null, e => this.messageService.show(severity.Error, e));
 		return true;
 	}
 }
 
 class CurrentHeadEntry extends AbstractRefEntry {
-	public getDescription(): string { return nls.localize('alreadyCheckedOut', "Branch {0} is already the current branch", this.head.name); }
+	getDescription(): string { return nls.localize('alreadyCheckedOut', "Branch {0} is already the current branch", this.ref.name); }
 }
 
 class BranchEntry extends model.QuickOpenEntry {
 
-	private gitService: git.IGitService;
+	private gitService: IGitService;
 	private messageService: IMessageService;
 	private name: string;
 
-	constructor(gitService: git.IGitService, messageService: IMessageService, name: string) {
+	constructor(gitService: IGitService, messageService: IMessageService, name: string) {
 		super([{ start: 0, end: name.length }]);
 
 		this.gitService = gitService;
 		this.messageService = messageService;
 		this.name = name;
 	}
 
-	public getIcon(): string { return 'git'; }
-	public getLabel(): string { return this.name; }
-	public getAriaLabel(): string { return nls.localize({ key: 'branchAriaLabel', comment: ['the branch name'] }, "{0}, git branch", this.getLabel()); }
-	public getDescription(): string { return nls.localize('createBranch', "Create branch {0}", this.name); }
+	getIcon(): string { return 'git'; }
+	getLabel(): string { return this.name; }
+	getAriaLabel(): string { return nls.localize({ key: 'branchAriaLabel', comment: ['the branch name'] }, "{0}, git branch", this.getLabel()); }
+	getDescription(): string { return nls.localize('createBranch', "Create branch {0}", this.name); }
 
-	public run(mode: quickopen.Mode, context: model.IContext):boolean {
+	run(mode: quickopen.Mode, context: model.IContext):boolean {
 		if (mode === quickopen.Mode.PREVIEW) {
 			return false;
 		}
@@ -112,99 +127,121 @@ class BranchEntry extends model.QuickOpenEntry {
 
 class CheckoutCommand implements quickopenwb.ICommand {
 
-	public aliases = ['checkout', 'co'];
-	public icon = 'git';
+	aliases = ['checkout', 'co'];
+	icon = 'git';
 
-	constructor(private gitService: git.IGitService, private messageService: IMessageService) {
+	constructor(private gitService: IGitService, private messageService: IMessageService) {
 		// noop
 	}
 
-	public getResults(input: string): winjs.TPromise<model.QuickOpenEntry[]> {
+	getResults(input: string): winjs.TPromise<model.QuickOpenEntry[]> {
 		input = input.trim();
 
-		var gitModel = this.gitService.getModel();
-		var currentHead = gitModel.getHEAD();
+		const gitModel = this.gitService.getModel();
+		const currentHead = gitModel.getHEAD();
+		const refs = gitModel.getRefs();
+		const heads = refs.filter(ref => ref.type === RefType.Head);
+		const tags = refs.filter(ref => ref.type === RefType.Tag);
+		const remoteHeads = refs.filter(ref => ref.type === RefType.RemoteHead);
 
-		var headMatches = gitModel.getHeads()
+		const headMatches = heads
 			.map(head => ({ head, highlights: filters.matchesContiguousSubString(input, head.name) }))
 			.filter(({ highlights }) => !!highlights);
 
-		var headEntries: model.QuickOpenEntry[] = headMatches
+		const headEntries: model.QuickOpenEntry[] = headMatches
 			.filter(({ head }) => head.name !== currentHead.name)
 			.map(({ head, highlights }) => new CheckoutHeadEntry(this.gitService, this.messageService, head, highlights));
 
-		var tagMatches = gitModel.getTags()
-			.map(tag => ({ tag, highlights: filters.matchesContiguousSubString(input, tag.name) }))
+		const tagMatches = tags
+			.map(head => ({ head, highlights: filters.matchesContiguousSubString(input, head.name) }))
 			.filter(({ highlights }) => !!highlights);
 
-		var tagEntries: model.QuickOpenEntry[] = tagMatches
-			.filter(({ tag }) => tag.name !== currentHead.name)
-			.map(({ tag, highlights }) => new CheckoutTagEntry(this.gitService, this.messageService, tag, highlights));
+		const tagEntries = tagMatches
+			.filter(({ head }) => head.name !== currentHead.name)
+			.map(({ head, highlights }) => new CheckoutTagEntry(this.gitService, this.messageService, head, highlights));
 
-		var entries = headEntries
+		const checkoutEntries = headEntries
 			.concat(tagEntries)
 			.sort((a, b) => a.getLabel().localeCompare(b.getLabel()));
 
-		if (entries.length > 0) {
-			entries[0] = new model.QuickOpenEntryGroup(entries[0], 'checkout', false);
+		const remoteHeadMatches = remoteHeads
+			.map(head => ({ head, highlights: filters.matchesContiguousSubString(input, head.name) }))
+			.filter(({ highlights }) => !!highlights);
+
+		const remoteHeadEntries: model.QuickOpenEntry[] = remoteHeadMatches
+			.filter(({ head }) => head.name !== currentHead.name)
+			.map(({ head, highlights }) => new CheckoutRemoteHeadEntry(this.gitService, this.messageService, head, highlights))
+			.sort((a, b) => a.getLabel().localeCompare(b.getLabel()));
+
+		if (checkoutEntries.length > 0) {
+			checkoutEntries[0] = new model.QuickOpenEntryGroup(checkoutEntries[0], 'checkout', false);
 		}
 
-		var exactMatches = headMatches.filter(({ head }) => head.name === input);
-		var currentHeadMatches = exactMatches.filter(({ head }) => head.name === currentHead.name);
+		if (remoteHeadEntries.length > 0) {
+			remoteHeadEntries[0] = new model.QuickOpenEntryGroup(remoteHeadEntries[0], 'checkout remote', checkoutEntries.length > 0);
+		}
+
+		const entries = checkoutEntries
+			.sort((a, b) => a.getLabel().localeCompare(b.getLabel()))
+			.concat(remoteHeadEntries);
+
+		const allMatches = headMatches.concat(tagMatches).concat(remoteHeadMatches);
+		const exactMatches = allMatches.filter(({ head }) => head.name === input);
+		const currentHeadMatches = exactMatches.filter(({ head }) => head.name === currentHead.name);
 
 		if (currentHeadMatches.length > 0) {
 			entries.unshift(new CurrentHeadEntry(this.gitService, this.messageService, currentHeadMatches[0].head, currentHeadMatches[0].highlights));
 
-		} else if (exactMatches.length === 0 && git.isValidBranchName(input)) {
-			var branchEntry = new BranchEntry(this.gitService, this.messageService, input);
-			entries.push(new model.QuickOpenEntryGroup(branchEntry, 'branch', false));
+		} else if (exactMatches.length === 0 && isValidBranchName(input)) {
+			const branchEntry = new BranchEntry(this.gitService, this.messageService, input);
+			entries.push(new model.QuickOpenEntryGroup(branchEntry, 'branch', checkoutEntries.length > 0 || remoteHeadEntries.length > 0));
 		}
 
 		return winjs.TPromise.as<model.QuickOpenEntry[]>(entries);
 	}
 
-	public getEmptyLabel(input: string): string {
+	getEmptyLabel(input: string): string {
 		return nls.localize('noBranches', "No other branches");
 	}
 }
 
 class BranchCommand implements quickopenwb.ICommand {
 
-	public aliases = ['branch'];
-	public icon = 'git';
+	aliases = ['branch'];
+	icon = 'git';
 
-	constructor(private gitService: git.IGitService, private messageService: IMessageService) {
+	constructor(private gitService: IGitService, private messageService: IMessageService) {
 		// noop
 	}
 
-	public getResults(input: string): winjs.TPromise<model.QuickOpenEntry[]> {
+	getResults(input: string): winjs.TPromise<model.QuickOpenEntry[]> {
 		input = input.trim();
 
-		if (!git.isValidBranchName(input)) {
+		if (!isValidBranchName(input)) {
 			return winjs.TPromise.as([]);
 		}
 
-		var gitModel = this.gitService.getModel();
-		var currentHead = gitModel.getHEAD();
+		const gitModel = this.gitService.getModel();
+		const currentHead = gitModel.getHEAD();
 
-		var matches = gitModel.getHeads()
+		const matches = gitModel.getRefs()
 			.map(head => ({ head, highlights: filters.matchesContiguousSubString(input, head.name) }))
 			.filter(({ highlights }) => !!highlights);
 
-		var exactMatches = matches.filter(({ head }) => head.name === input);
-		var headMatches = exactMatches.filter(({ head }) => head.name === currentHead.name);
+		const exactMatches = matches.filter(({ head }) => head.name === input);
+		const headMatches = exactMatches.filter(({ head }) => head.name === currentHead.name);
 
 		if (headMatches.length > 0) {
 			return winjs.TPromise.as([new CurrentHeadEntry(this.gitService, this.messageService, headMatches[0].head, headMatches[0].highlights)]);
 		} else if (exactMatches.length > 0) {
 			return winjs.TPromise.as([new CheckoutHeadEntry(this.gitService, this.messageService, exactMatches[0].head, exactMatches[0].highlights)]);
 		}
 
-		var branchEntry = new BranchEntry(this.gitService, this.messageService, input);
+		const branchEntry = new BranchEntry(this.gitService, this.messageService, input);
 		return winjs.TPromise.as([new model.QuickOpenEntryGroup(branchEntry, 'branch', false)]);
 	}
 
-	public getEmptyLabel(input: string): string {
+	getEmptyLabel(input: string): string {
 		return nls.localize('notValidBranchName', "Please provide a valid branch name");
 	}
 }

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/common/git.ts
code:
@@ -26,29 +26,31 @@ export interface IRemote {
 	url: string;
 }
 
-export interface IHead {
-	name?: string;
-	commit?: string;
+export enum RefType {
+	Head,
+	RemoteHead,
+	Tag
 }
 
-export interface IBranch extends IHead {
+export interface IRef {
+	name: string;
+	commit: string;
+	type: RefType;
+	remote?: string;
+}
+
+export interface IBranch extends IRef {
 	upstream?: string;
 	ahead?: number;
 	behind?: number;
 }
 
-export interface ITag {
-	name: string;
-	commit: string;
-}
-
 export interface IRawStatus {
 	repositoryRoot: string;
 	state?: ServiceState;
 	status: IRawFileStatus[];
 	HEAD: IBranch;
-	heads: IBranch[];
-	tags: ITag[];
+	refs: IRef[];
 	remotes: IRemote[];
 }
 
@@ -87,8 +89,7 @@ export var ModelEvents = {
 	MODEL_UPDATED: 'ModelUpdated',
 	STATUS_MODEL_UPDATED: 'StatusModelUpdated',
 	HEAD_UPDATED: 'HEADUpdated',
-	HEADS_UPDATED: 'HEADSUpdated',
-	TAGS_UPDATED: 'TagsUpdated',
+	REFS_UPDATED: 'RefsUpdated',
 	REMOTES_UPDATED: 'RemotesUpdated'
 };
 
@@ -133,8 +134,7 @@ export interface IModel extends EventEmitter.IEventEmitter {
 	getRepositoryRoot(): string;
 	getStatus(): IStatusModel;
 	getHEAD(): IBranch;
-	getHeads(): IBranch[];
-	getTags(): ITag[];
+	getRefs(): IRef[];
 	getRemotes(): IRemote[];
 	update(status: IRawStatus): void;
 	getPS1(): string;

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/common/gitModel.ts
code:
@@ -310,8 +310,7 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 	private repositoryRoot: string;
 	private status: Git.IStatusModel;
 	private HEAD: Git.IBranch;
-	private heads: Git.IBranch[];
-	private tags: Git.ITag[];
+	private refs: Git.IRef[];
 	private remotes: Git.IRemote[];
 	private toDispose: Lifecycle.IDisposable[];
 
@@ -325,8 +324,7 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 		this.toDispose.push(this.addEmitter2(this.status));
 
 		this.HEAD = null;
-		this.heads = [];
-		this.tags = [];
+		this.refs = [];
 		this.remotes = [];
 	}
 
@@ -342,12 +340,8 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 		return this.HEAD;
 	}
 
-	public getHeads(): Git.IBranch[] {
-		return this.heads;
-	}
-
-	public getTags(): Git.ITag[] {
-		return this.tags;
+	public getRefs(): Git.IRef[] {
+		return this.refs;
 	}
 
 	public getRemotes(): Git.IRemote[] {
@@ -360,8 +354,7 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 				repositoryRoot: null,
 				status: [],
 				HEAD: null,
-				heads: [],
-				tags: [],
+				refs: [],
 				remotes: []
 			};
 		}
@@ -372,11 +365,8 @@ export class Model extends EventEmitter.EventEmitter implements Git.IModel {
 		this.HEAD = status.HEAD;
 		this.emit(Git.ModelEvents.HEAD_UPDATED);
 
-		this.heads = status.heads;
-		this.emit(Git.ModelEvents.HEADS_UPDATED);
-
-		this.tags = status.tags;
-		this.emit(Git.ModelEvents.TAGS_UPDATED);
+		this.refs = status.refs;
+		this.emit(Git.ModelEvents.REFS_UPDATED);
 
 		this.remotes = status.remotes;
 		this.emit(Git.ModelEvents.REMOTES_UPDATED);

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/common/noopGitService.ts
code:
@@ -18,8 +18,7 @@ export class NoOpGitService implements git.IRawGitService {
 		state: git.ServiceState.NotAWorkspace,
 		status: [],
 		HEAD: null,
-		heads: [],
-		tags: [],
+		refs: [],
 		remotes: []
 	};
 

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/node/git.lib.ts
code:
@@ -12,7 +12,7 @@ import uuid = require('vs/base/common/uuid');
 import nls = require('vs/nls');
 import strings = require('vs/base/common/strings');
 import { uniqueFilter } from 'vs/base/common/arrays';
-import { IRawFileStatus, IHead, ITag, IBranch, IRemote, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
+import { IRawFileStatus, RefType, IRef, IBranch, IRemote, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
 import { detectMimesFromStream } from 'vs/base/node/mime';
 import files = require('vs/platform/files/common/files');
 import { spawn, ChildProcess } from 'child_process';
@@ -601,39 +601,42 @@ export class Repository {
 		});
 	}
 
-	public getHEAD(): TPromise<IHead> {
+	public getHEAD(): TPromise<IRef> {
 		return this.run(['symbolic-ref', '--short', 'HEAD'], { log: false }).then((result) => {
 			if (!result.stdout) {
-				return TPromise.wrapError<IHead>(new Error('Not in a branch'));
+				return TPromise.wrapError<IRef>(new Error('Not in a branch'));
 			}
 
-			return TPromise.as<IHead>({ name: result.stdout.trim() });
+			return TPromise.as<IRef>({ name: result.stdout.trim(), commit: void 0, type: RefType.Head });
 		}, (err) => {
 			return this.run(['rev-parse', 'HEAD'], { log: false }).then((result) => {
 				if (!result.stdout) {
-					return TPromise.wrapError<IHead>(new Error('Error parsing HEAD'));
+					return TPromise.wrapError<IRef>(new Error('Error parsing HEAD'));
 				}
 
-				return TPromise.as<IHead>({ commit: result.stdout.trim() });
+				return TPromise.as<IRef>({ name: void 0, commit: result.stdout.trim(), type: RefType.Head });
 			});
 		});
 	}
 
-	public getHeads(): TPromise<ITag[]> {
-		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/heads/'], { log: false }).then((result) => {
+	public getRefs(): TPromise<IRef[]> {
+		return this.run(['for-each-ref', '--format', '%(refname) %(objectname)'], { log: false }).then(result => {
 			return result.stdout.trim().split('\n')
-				.filter(b => !!b)
-				.map(b => b.trim().split(' '))
-				.map(a => ({ name: a[0], commit: a[1] }));
-		});
-	}
+				.filter(line => !!line)
+				.map(line => {
+					let match: RegExpExecArray;
+
+					if (match = /^refs\/heads\/([^ ]+) ([0-9a-f]{40})$/.exec(line)) {
+						return { name: match[1], commit: match[2], type: RefType.Head };
+					} else if (match = /^refs\/remotes\/([^/]+)\/([^ ]+) ([0-9a-f]{40})$/.exec(line)) {
+						return { name: `${ match[1] }/${ match[2] }`, commit: match[3], type: RefType.RemoteHead, remote: match[1] };
+					} else if (match = /^refs\/tags\/([^ ]+) ([0-9a-f]{40})$/.exec(line)) {
+						return { name: match[1], commit: match[2], type: RefType.Tag };
+					}
 
-	public getTags(): TPromise<IHead[]> {
-		return this.run(['for-each-ref', '--format', '%(refname:short) %(objectname)', 'refs/tags/'], { log: false }).then((result) => {
-			return result.stdout.trim().split('\n')
-				.filter(b => !!b)
-				.map(b => b.trim().split(' '))
-				.map(a => ({ name: a[0], commit: a[1] }));
+					return null;
+				})
+				.filter(ref => !!ref);
 		});
 	}
 

author:joaomoreno
date:2016-05-30T15:12:55Z
title:show remotes in git checkout list

fixes #3385
filename:src/vs/workbench/parts/git/node/rawGitService.ts
code:
@@ -9,7 +9,7 @@ import { TPromise, Promise } from 'vs/base/common/winjs.base';
 import mime = require('vs/base/node/mime');
 import pfs = require('vs/base/node/pfs');
 import { Repository, GitError } from 'vs/workbench/parts/git/node/git.lib';
-import { IRawGitService, RawServiceState, IRawStatus, IHead, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
+import { IRawGitService, RawServiceState, IRawStatus, IRef, GitErrorCodes, IPushOptions } from 'vs/workbench/parts/git/common/git';
 import Event, { Emitter } from 'vs/base/common/event';
 
 export class RawGitService implements IRawGitService {
@@ -59,15 +59,14 @@ export class RawGitService implements IRawGitService {
 					} else {
 						return HEAD;
 					}
-				}, (): IHead => null)
-				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getHeads(), this.repo.getTags(), this.repo.getRemotes()]).then(r => {
+				}, (): IRef => null)
+				.then(HEAD => Promise.join([this.getRepositoryRoot(), this.repo.getRefs(), this.repo.getRemotes()]).then(r => {
 					return {
 						repositoryRoot: r[0],
 						status: status,
 						HEAD: HEAD,
-						heads: r[1],
-						tags: r[2],
-						remotes: r[3]
+						refs: r[1],
+						remotes: r[2]
 					};
 				})))
 			.then(null, (err) => {

author:joaomoreno
date:2016-06-01T08:33:29Z
title:unlocalized git specific actions

fixes #6388
filename:src/vs/workbench/parts/git/browser/gitActions.ts
code:
@@ -674,7 +674,7 @@ export class BranchAction extends GitAction {
 	private checkout:boolean;
 
 	constructor(checkout: boolean, @IGitService gitService: IGitService) {
-		super(BranchAction.ID, nls.localize('branch', "Branch"), 'git-action checkout', gitService);
+		super(BranchAction.ID, 'Branch', 'git-action checkout', gitService);
 		this.checkout = checkout;
 	}
 
@@ -867,7 +867,7 @@ export class SmartCommitAction extends BaseCommitAction {
 export class PullAction extends GitAction {
 
 	static ID = 'workbench.action.git.pull';
-	static LABEL = nls.localize('pull', "Pull");
+	static LABEL = 'Pull';
 
 	constructor(
 		id = PullAction.ID,
@@ -916,7 +916,7 @@ export class PullAction extends GitAction {
 export class PullWithRebaseAction extends PullAction {
 
 	static ID = 'workbench.action.git.pull.rebase';
-	static LABEL = nls.localize('pullWithRebase', "Pull (Rebase)");
+	static LABEL = 'Pull (Rebase)';
 
 	constructor(@IGitService gitService: IGitService) {
 		super(PullWithRebaseAction.ID, PullWithRebaseAction.LABEL, gitService);
@@ -930,7 +930,7 @@ export class PullWithRebaseAction extends PullAction {
 export class PushAction extends GitAction {
 
 	static ID = 'workbench.action.git.push';
-	static LABEL = nls.localize('push', "Push");
+	static LABEL = 'Push';
 
 	constructor(
 		id: string = PushAction.ID,
@@ -1095,7 +1095,7 @@ export abstract class BaseSyncAction extends GitAction {
 export class SyncAction extends BaseSyncAction {
 
 	static ID = 'workbench.action.git.sync';
-	static LABEL = nls.localize('sync', "Sync");
+	static LABEL = 'Sync';
 
 	constructor(id: string, label: string, @IGitService gitService: IGitService) {
 		super(id, label, 'git-action sync', gitService);
@@ -1109,7 +1109,7 @@ export class LiveSyncAction extends BaseSyncAction {
 	static CLASS_NAME_LOADING = 'git-action live-sync loading';
 
 	constructor(@IGitService gitService: IGitService) {
-		super(LiveSyncAction.ID, nls.localize('sync', "Sync"), LiveSyncAction.CLASS_NAME, gitService);
+		super(LiveSyncAction.ID, 'sync', LiveSyncAction.CLASS_NAME, gitService);
 	}
 
 	protected onGitServiceChange(): void {
@@ -1186,7 +1186,7 @@ export class UndoLastCommitAction extends GitAction {
 export class StartGitCheckoutAction extends Action {
 
 	public static ID = 'workbench.action.git.startGitCheckout';
-	public static LABEL = nls.localize('checkout', "Checkout");
+	public static LABEL = 'Checkout';
 	private quickOpenService: IQuickOpenService;
 
 	constructor(id: string, label: string, @IQuickOpenService quickOpenService: IQuickOpenService) {
@@ -1203,7 +1203,7 @@ export class StartGitCheckoutAction extends Action {
 export class StartGitBranchAction extends Action {
 
 	public static ID = 'workbench.action.git.startGitBranch';
-	public static LABEL = nls.localize('branch2', "Branch");
+	public static LABEL = 'Branch';
 	private quickOpenService: IQuickOpenService;
 
 	constructor(id: string, label: string, @IQuickOpenService quickOpenService: IQuickOpenService) {

author:joaomoreno
date:2016-06-01T14:32:08Z
title:detect gh4w git installation

fixes #3663
filename:src/vs/workbench/parts/git/electron-browser/electronGitService.ts
code:
@@ -24,6 +24,7 @@ import { spawn, exec } from 'child_process';
 import { join } from 'path';
 import { remote } from 'electron';
 import { IStorageService } from 'vs/platform/storage/common/storage';
+import { readdir } from 'vs/base/node/pfs';
 
 interface IGit {
 	path: string;
@@ -91,11 +92,26 @@ function findSystemGitWin32(base: string): TPromise<IGit> {
 	return findSpecificGit(join(base, 'Git', 'cmd', 'git.exe'));
 }
 
+function findGitHubGitWin32(): TPromise<IGit> {
+	const github = join(process.env['LOCALAPPDATA'], 'GitHub');
+
+	return readdir(github).then(children => {
+		const git = children.filter(child => /^PortableGit/.test(child))[0];
+
+		if (!git) {
+			return TPromise.wrapError('Not found');
+		}
+
+		return findSpecificGit(join(github, git, 'cmd', 'git.exe'));
+	});
+}
+
 function findGitWin32(): TPromise<IGit> {
 	return findSystemGitWin32(process.env['ProgramW6432'])
 		.then(null, () => findSystemGitWin32(process.env['ProgramFiles(x86)']))
 		.then(null, () => findSystemGitWin32(process.env['ProgramFiles']))
-		.then(null, () => findSpecificGit('git'));
+		.then(null, () => findSpecificGit('git'))
+		.then(null, () => findGitHubGitWin32());
 }
 
 function findGit(hint: string): TPromise<IGit> {

author:Tyriar
date:2016-06-03T01:35:16Z
title:Remove git dependency from Linux packages

It's only a soft dependency so don't block an install on it.

Fixes #6692
filename:resources/linux/debian/control.template
code:
@@ -1,6 +1,5 @@
 Package: @@NAME@@
 Version: @@VERSION@@
-Depends: git
 Section: devel
 Priority: optional
 Architecture: @@ARCHITECTURE@@

author:Tyriar
date:2016-06-03T01:35:16Z
title:Remove git dependency from Linux packages

It's only a soft dependency so don't block an install on it.

Fixes #6692
filename:resources/linux/rpm/code.spec.template
code:
@@ -8,7 +8,7 @@ Packager: Visual Studio Code Team <vscode-linux@microsoft.com>
 License:  MIT
 URL:      https://code.visualstudio.com/
 Icon:     @@NAME@@.xpm
-Requires: git, glibc >= 2.15
+Requires: glibc >= 2.15
 AutoReq:  0
 
 %description

